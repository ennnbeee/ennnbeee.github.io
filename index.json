[{"categories":["windows"],"content":"Configuring BitLocker encryption settings to allow for recovery key rotation initiated from Intune console.","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/"},{"categories":["windows"],"content":"BitLocker settings in Intune have gone through a transformation in recent years, with these encryption settings existing across multiple profile types, with different wording, settings, and options with Microsoft allow for configuration of BitLocker through three main policy types: Endpoint Security policies Endpoint Protection policies Settings Catalog policies Despite all these policies being backed up by the BitLocker CSP, they all present their information in different ways. This hasn‚Äôt made the translation of settings between policies particularly easy, especially if you‚Äôve been keeping up with the Kardashians Joneses, and moving all your profiles to Settings Catalog backed policies like a good little Intune engineer. ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:0:0","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#"},{"categories":["windows"],"content":" 1 Key Rotation IssuesWhat do we actually need though to allow for successful BitLocker key rotation in each of these policy types, and what settings do we need to avoid Event ID 858 errors in the BitLocker-API event log like the below when attempting to rotate the key? Screenshot of Event ID 858 error in the BitLocker-API event log. What is this ‚ÄúBitLocker recovery password rotation cannot be performed because backup policy for BitLocker recovery information is not set to required for the OS drive‚Äù error, and what do we need to fix it? ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:1:0","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#key-rotation-issues"},{"categories":["windows"],"content":" 2 Key Rotation SettingsLet‚Äôs make sure that our BitLocker policies are configured to support the escrow (that‚Äôs a fancy word for, ‚Äúkeep hold of‚Äù) of the recovery key to Entra ID, as without this any rotation of the key is going to give us a headache. We‚Äôll assume that your policy in whatever flavour allows for silent enablement of BitLocker, as who can be bothered with secure devices additional pre-boot authentication üôÉ? What exactly do we need to enable key rotation? Well it‚Äôs the following settings1: Quote Devices must run Windows 10 version 1909 or later, or Windows 11 Microsoft Entra joined and Microsoft Entra hybrid joined devices must have support for key rotation enabled via BitLocker policy configuration: Client-driven recovery password rotation to Enable rotation on Microsoft Entra joined devices or Enable rotation on Microsoft Entra ID and Microsoft Entra joined hybrid joined devices Save BitLocker recovery information to Microsoft Entra ID to Enabled Store recovery information in Microsoft Entra ID before enabling BitLocker to Required Assuming you‚Äôre not still stuck on old versions of Windows 10 üò∂, what do the other pre-requisites look like across the three policy types, allowing us to avoid recovery key rotation errors? ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:2:0","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#key-rotation-settings"},{"categories":["windows"],"content":" 2.1 Endpoint Security PolicyBelow are the Endpoint Security policy settings, and as I cba with hybrid joined devices any more are designed for Entra join only devices. Info These settings will still work on your precious hybrid joined devices, just change the rotation setting to Refresh on for both Azure AD-joined and hybrid-joined devices or similar in your policies. First off is the requirement for key rotation: Category Setting Value BitLocker Configure Recovery Password Rotation Refresh on for Azure AD-joined devices With the corresponding setting in Intune: Screenshot of Intune BitLocker Endpoint Security policy for BitLocker. Tip It would be nice if the wording was updated here, it‚Äôs Entra ID you know Microsoft üòÖ. Moving to Operating System drive recovery options: Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Do not enable BitLocker until recovery information is stored to AD DS for operating system drives True Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Save BitLocker recovery information to AD DS for operating system drives True With Intune settings configured with the above values: Screenshot of Intune BitLocker Endpoint Security policy for Operating System Drives. Lastly for Endpoint Security policies is the Fixed Data drive settings: Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Fixed Data Drives Do not enable BitLocker until recovery information is stored to AD DS for fixed data drives True Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Fixed Data Drives Save BitLocker recovery information to AD DS for fixed data drives True Configured in Intune: Screenshot of Intune BitLocker Endpoint Security policy for Fixed Data Drives. Info There is no mention in this policy type, or with it‚Äôs missing tooltips on some of the settings, that these settings are required to allow for key rotation to happen. ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:2:1","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#endpoint-security-policy"},{"categories":["windows"],"content":" 2.2 Endpoint Protection PolicyBelow are the Endpoint Protection policy settings, and if you need a refresh these are available in Configuration \u003e Windows 10 and later \u003e Templates \u003e Endpoint protection. The Operating System Drive settings are configured with the below: Category Setting Value Windows Encryption \u003e BitLocker OS drive settings Save BitLocker recovery information to Microsoft Entra ID Enable Windows Encryption \u003e BitLocker OS drive settings Client-driven recovery password rotation Key rotation enabled for Microsoft Entra joined devices Windows Encryption \u003e BitLocker OS drive settings Store recovery information in Microsoft Entra ID before enabling BitLocker Require Looking like the below in Intune: Screenshot of Intune BitLocker Endpoint Protection policy for OS Drives. Tip Microsoft managed to update the wording to Entra in a legacy policy, go figure üòÖ. With the Fixed Data drive settings configured with the below values: Category Setting Value Windows Encryption \u003e BitLocker fixed data-drive settings Save BitLocker recovery information to Microsoft Entra ID Enable Windows Encryption \u003e BitLocker fixed data-drive settings Store recovery information in Microsoft Entra ID before enabling BitLocker Require Intune looking sharp: Screenshot of Intune BitLocker Endpoint Protection policy for Fixed Data Drives. ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:2:2","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#endpoint-protection-policy"},{"categories":["windows"],"content":" 2.3 Settings Catalog PolicyIf you‚Äôre like me and punting everything into these policies, this one is for you, and the settings themselves are the same as the Endpoint security policy (as this uses Settings catalog), they‚Äôre just presented differently, for some unknown reason. The required key rotation settings: Category Setting Value BitLocker Configure Recovery Password Rotation Refresh on for Azure AD-joined devices With the corresponding setting in Intune: Screenshot of Intune BitLocker Settings Catalog policy for BitLocker. Operating System drive recovery options: Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Do not enable BitLocker until recovery information is stored to AD DS for operating system drives True Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Save BitLocker recovery information to AD DS for operating system drives True Intune settings configured with the above: Screenshot of Intune BitLocker Settings Catalog policy for Operating System Drives. Finally is the Fixed Data drive settings: Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Fixed Data Drives Do not enable BitLocker until recovery information is stored to AD DS for fixed data drives True Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Fixed Data Drives Save BitLocker recovery information to AD DS for fixed data drives True Configured in Intune: Screenshot of Intune BitLocker Settings Catalog policy for Fixed Data Drives. ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:2:3","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#settings-catalog-policy"},{"categories":["windows"],"content":" 3 Key Rotation in ActionWith one of the above policies applying to your devices, you can initiate a rotation of the BitLocker recovery key from Intune, go find a device, select the ellipsis (‚Ä¶) and select BitLocker key rotation: Screenshot of Intune BitLocker Recovery Key rotation dialogue menu. Read the warning and obviously proceed, you wouldn‚Äôt be clicking this option unless you know what it does right? üòõ Screenshot of Intune BitLocker Recovery Key rotation warning message. Once you‚Äôve selected Yassss Yes, on the device in question, go check the event logs, located in: Event Viewer Applications and Services Logs \u003e Microsoft \u003e Windows \u003e BitLocker-API \u003e Management Intune will have hopefully asked the device nicely to rotate it‚Äôs keys, with the event log showing the following entries: With a newly escrowed (there‚Äôs that new word we learned) into the Intune portal: Screenshot of Intune BitLocker Recovery Key after being rotated. ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:3:0","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#key-rotation-in-action"},{"categories":["windows"],"content":" 4 SummaryLuckily for us, Microsoft have made it easy to configure both BitLocker and the Key Rotation options in Intune, in whatever policy type you fancy, whether Endpoint Security, Endpoint Protection, or just a plain old Settings Catalog one. What they should do, is unify the wording of these settings not just in the policies themselves, but with the tooltips, to allow for a solid understanding of what the setting is doing, and what it enables to happen with BitLocker keys, to save me writing posts about something that should just be easy to understand from the Intune portal üòÖ. Rotate BitLocker recovery keys prerequisites¬†‚Ü©Ô∏é ","date":"21 January 2025","objectID":"/posts/bitlocker-key-rotation-requirements/:4:0","series":null,"tags":["intune","bitlocker","settings catalog","security","endpoint security"],"title":"BitLocker Recovery Key Rotation Requirements in Intune","uri":"/posts/bitlocker-key-rotation-requirements/#summary"},{"categories":["android"],"content":"Using Intune and OEMConfig for Samsung Knox Android Enterprise devices to improve the onboarding of devices to Defender for Endpoint.","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/"},{"categories":["android"],"content":"Onboarding corporate mobile devices managed by Intune into Defender for Endpoint shouldn‚Äôt require your end users to do anything, and with supervised iOS/iPadOS devices this is exactly the case with Microsoft providing great documentation on the process and corresponding configuration profiles to support silent onboarding. The same however can‚Äôt be said for Android Enterprise devices, even with the feature for low-touch onboarding currently in preview now Generally Available. Although low-touch onboarding reduces the amount of hoops a user has to jump through, it doesn‚Äôt remove them all. Can we help with that? ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:0:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#"},{"categories":["android"],"content":" 1 Defender AppFirst off, before we go configuring devices with their Microsoft Defender for Endpoint onboarding settings, we actually need our devices to have the app itself. So go and add the app following along with Microsoft nicely. Managed Google Play Store app for Microsoft Defender. Once added to your Intune tenant, you‚Äôre going to need to deploy it, with a Required assignment target. Good, your devices have the app, but what about the configuration. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:1:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#defender-app"},{"categories":["android"],"content":" 2 Low-Touch OnboardingTo configure low-touch onboarding, we need to configure two main things on the Android Enterprise devices: The Defender App to give the app permissions and configuration settings A loopback VPN profile to allow for enabling Web Protection We‚Äôll expand a bit more on some of the other permission and configurations you can apply, but for now we‚Äôll just deal with onboarding the Microsoft way. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#low-touch-onboarding"},{"categories":["android"],"content":" 2.1 App Configuration PolicyIf you skipped ahead when following the Microsoft article about deploying the Android Enterprise App, you may have noticed the section from Step 9 about App Configuration policies. App Configuration policy for Defender. We‚Äôll need one of these to turn on or off Defender App settings, or at least be definite with our choices instead of relying on the defaults. To make sure that the Defender App is actually doing something, go ahead and configure a new policy with the below Configuration Settings. Configuration Key Value Type Configuration Value Anti-phishing integer 1 - Enable Microsoft Defender integer 1 - Enable VPN integer 1 - Enable With these basic settings we can at least ensure that the Defender App on the Android Enterprise device will be ready for onboarding. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:1","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#app-configuration-policy"},{"categories":["android"],"content":" 2.2 Always-on VPN ProfileAs we‚Äôve configured the Defender app with the VPN setting, we need to deploy one to our Android Enterprise devices. This VPN isn‚Äôt really giving your devices access to anything, but is required to support the Web Protection functionality. Defender for Endpoint on Android would use a VPN in order to provide the Web Protection feature. This VPN is not a regular VPN. Instead, it‚Äôs a local/self-looping VPN that does not take traffic outside the device. We can easily create a new Device Restriction configuration profile (please can Settings Catalog come to Android Enterprise üôè) based on the information in the Learn article, but save you clicking away, here are the settings required: Category Setting Value Connectivity Always-on VPN (work profile-level) Enabled Connectivity VPN client Custom Connectivity Package ID com.microsoft.scmx Connectivity Lockdown mode Not configured The Package ID of com.microsoft.scmx is the Defender for Endpoint Android app, we‚Äôll need this later on. Android Enterprise Device Restriction profile for the Defender VPN. With the VPN in place, we can now look at the specific Low-Touch onboarding settings. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:2","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#always-on-vpn-profile"},{"categories":["android"],"content":" 2.3 Low-Touch Onboarding SettingsIf we just configure the above, a user will still need to approve the permissions the Defender App is requesting. We‚Äôve dealt with the VPN, but it‚Äôs still going to ask for the following permissions: File Access Location Access Permanent Protection Accessibility Display over other apps Defender app on Android Enterprise requesting permissions. Now for all Android Enterprise device types we can only make this onboarding a little easier with Intune, by updating our App Configuration policy for Defender to include the below permissions and settings. 2.3.1 App SettingsThese settings allow for the configuration of the low-touch onboarding approach: Configuration Key Value Type Configuration Value Low touch onboarding integer 1 - Enable User UPN variable User Principal Name Info The User Principal Name variable will just change itself to a string value type, and a configuration value of {{userprincipalname}}, so don‚Äôt be alarmed when you see this. 2.3.2 App PermissionsTo make the onboarding process a little smoother, we can give the Defender app some of the permissions it‚Äôs asking for, so again update your App Configuration policy and add in the below permissions. Permission Permission State Permission Name Permissions Group Post notifications Auto grant POST_NOTIFICATIONS NOTIFICATIONS Location access (fine) Auto grant ACCESS_FINE_LOCATION LOCATION Location access (background) Auto grant ACCESS_BACKGROUND_LOCATION LOCATION Info The Location access (background) permission isn‚Äôt mentioned in the documentation, but it is required by the Defender app. Defender app on Android Enterprise permissions in an App Configuration policy. This now means that users now won‚Äôt be prompted for three of the six permissions the greedy Defender app is requesting. Can we sort out the remaining permissions though? ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:3","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#low-touch-onboarding-settings"},{"categories":["android"],"content":" 2.3 Low-Touch Onboarding SettingsIf we just configure the above, a user will still need to approve the permissions the Defender App is requesting. We‚Äôve dealt with the VPN, but it‚Äôs still going to ask for the following permissions: File Access Location Access Permanent Protection Accessibility Display over other apps Defender app on Android Enterprise requesting permissions. Now for all Android Enterprise device types we can only make this onboarding a little easier with Intune, by updating our App Configuration policy for Defender to include the below permissions and settings. 2.3.1 App SettingsThese settings allow for the configuration of the low-touch onboarding approach: Configuration Key Value Type Configuration Value Low touch onboarding integer 1 - Enable User UPN variable User Principal Name Info The User Principal Name variable will just change itself to a string value type, and a configuration value of {{userprincipalname}}, so don‚Äôt be alarmed when you see this. 2.3.2 App PermissionsTo make the onboarding process a little smoother, we can give the Defender app some of the permissions it‚Äôs asking for, so again update your App Configuration policy and add in the below permissions. Permission Permission State Permission Name Permissions Group Post notifications Auto grant POST_NOTIFICATIONS NOTIFICATIONS Location access (fine) Auto grant ACCESS_FINE_LOCATION LOCATION Location access (background) Auto grant ACCESS_BACKGROUND_LOCATION LOCATION Info The Location access (background) permission isn‚Äôt mentioned in the documentation, but it is required by the Defender app. Defender app on Android Enterprise permissions in an App Configuration policy. This now means that users now won‚Äôt be prompted for three of the six permissions the greedy Defender app is requesting. Can we sort out the remaining permissions though? ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:3","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#app-settings"},{"categories":["android"],"content":" 2.3 Low-Touch Onboarding SettingsIf we just configure the above, a user will still need to approve the permissions the Defender App is requesting. We‚Äôve dealt with the VPN, but it‚Äôs still going to ask for the following permissions: File Access Location Access Permanent Protection Accessibility Display over other apps Defender app on Android Enterprise requesting permissions. Now for all Android Enterprise device types we can only make this onboarding a little easier with Intune, by updating our App Configuration policy for Defender to include the below permissions and settings. 2.3.1 App SettingsThese settings allow for the configuration of the low-touch onboarding approach: Configuration Key Value Type Configuration Value Low touch onboarding integer 1 - Enable User UPN variable User Principal Name Info The User Principal Name variable will just change itself to a string value type, and a configuration value of {{userprincipalname}}, so don‚Äôt be alarmed when you see this. 2.3.2 App PermissionsTo make the onboarding process a little smoother, we can give the Defender app some of the permissions it‚Äôs asking for, so again update your App Configuration policy and add in the below permissions. Permission Permission State Permission Name Permissions Group Post notifications Auto grant POST_NOTIFICATIONS NOTIFICATIONS Location access (fine) Auto grant ACCESS_FINE_LOCATION LOCATION Location access (background) Auto grant ACCESS_BACKGROUND_LOCATION LOCATION Info The Location access (background) permission isn‚Äôt mentioned in the documentation, but it is required by the Defender app. Defender app on Android Enterprise permissions in an App Configuration policy. This now means that users now won‚Äôt be prompted for three of the six permissions the greedy Defender app is requesting. Can we sort out the remaining permissions though? ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:2:3","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#app-permissions"},{"categories":["android"],"content":" 3 Lower-Touch OnboardingThe answer is maybe, and only if you have Samsung Android Enterprise devices running at least Android 13. If a special permission is granted through the policy, the device doesn‚Äôt request the permission from the device user. What started me on this journey was a post about the changes to the Shared Device mode for Android Enterprise on Samsung devices detailing how to use the Knox Service Plugin and an OEMConfig profile in Intune to give Microsoft Launcher overlay, or display over other app permissions on-behalf of a user. Surely we can do the same for Defender on our supported Samsung devices? ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:3:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#lower-touch-onboarding"},{"categories":["android"],"content":" 3.1 Knox Service PluginBefore we dive into attempting to configure these additional permissions for our users, we need an OEMConfig App available in Intune. So go an approve the Knox Service Plugin from the Managed Google Play Store. Knox Service Plugin app in the Managed Google Play Store. Once available in Intune, I strongly suggest deploying this to all your Samsung Android Enterprise devices as the app is required before the configuration will apply. Use a Device Filter with a rule looking like the below for your assignment: PowerShell (device.deviceOwnership -eq \"Corporate\") and (device.manufacturer -eq \"samsung\") Once the app has installed, we can now move onto configuring a profile. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:3:1","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#knox-service-plugin"},{"categories":["android"],"content":" 3.2 OEMConfigFrom my experience with OEMConfig profiles there can be only one assigned per Samsung device (Zebra devices are different), so if you‚Äôre already applying a Knox Service Plugin based profile, you‚Äôre going to have to amend that one instead of creating a new one. Either way, to setup the Android Enterprise profile, if you need to create a new one, and to configure the required Defender for Endpoint settings: Navigate to the Microsoft Intune admin center and select Configuration under Manage devices, create a new policy for the Android Enterprise platform of type OEMConfig. Give the profile a suitable name and a description if you‚Äôd like e.g., MVE-AND-AE-D-CO-KSP-Defender Select Knox Service Plugin as the OEMConfig app Select Next to continue to the configuration page Under Knox Service Plugin enter in a name for the Knox profile i.e., DefenderforEndpoint(1.0) Under Knox Service Plugin select Configure for Device-wide policies (Selectively applicable to Fully Manage Device (DO) or Work Profile-on company owned devices (WP-C mode as noted) Under Device-wide policies set Enable device policy controls to true to enable it. Select Configure for Application management policies Under Application management policies set Enable application management controls to true to enable it. In Battery optimization allowlist enter in com.microsoft.scmx Under Application management policies set Enable permission controls to true to enable it. Under Knox Service Plugin select Configure for Permission Controls Select the ellipsis (‚Ä¶) that‚Äôs next to Permission Controls and select Add Setting Under Permission Configuration select the Permission Policy dropdown Select Appear on top and All files access For Package or Component Name, add the Defender app package name com.microsoft.scmx This process should look something like the below: The settings look like the this when all together in a nice table: Category Setting Value Knox Service Plugin Profile name(version) DefenderforEndpoint(1.0) Knox Service Plugin Debug Mode true Device-wide policies Enable device policy controls true Application management policies Enable application management controls true Application management policies Battery optimization allowlist com.microsoft.scmx Application management policies Enable permission controls true Permission Controls \u003e Permission Configuration Permission Policy All files access Appear on top Permission Controls \u003e Permission Configuration Package or Component Name com.microsoft.scmx We‚Äôre setting Debug Mode to true for now, as we want to see the outcome of the application of the profile in the Knox Service Plugin app on the device, once happy that it‚Äôs working we change this to false. Info For reference to how to configure these additional special permissions, the Knox documentation covers it in more detail. What we have here is a new profile that should help our users on their way to onboarding their devices to Defender, without having to faff about setting up the additional requested permissions that Defender needs. So when a user now opens the Defender app, they are only presented with one permission for Accessibility to configure: Defender app on Android Enterprise requesting permissions. I haven‚Äôt worked out a way to implement this using Intune or the Knox Service Plugin, so you‚Äôre end users will still have to do something to finish the onboarding process, sorry ü´†. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:3:2","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#oemconfig"},{"categories":["android"],"content":" 4 Defender FeaturesNow that you‚Äôve got your Android Enterprise, and/or Samsung devices onboarded to Defender for Endpoint, it‚Äôs worth covering off some additional settings and features to ensure that the app is not either misused, or to just be definite with some default settings. So back to your App Configuration policy we go, to add in some or all of the below settings: Configuration Key Value Type Configuration Value Description Enable Network Protection in Microsoft Defender integer 1 - Enable Turns on Network protection Enable Users to Trust Networks and Certificates integer 0 - Disable Stops users from accessing untrusted network or sites Automatic Remediation of Network Protection Alerts integer 1 - Enable Turns on the praising of users for doing some sensible security things Disable sign out integer 1 - Enable Stops a user from signing out of the Defender App Global Secure Access integer 0 - Disable Disables the Global Secure Access settings Obviously these can be amended based on your needs after reading through the associated documentation, and if you‚Äôve got the bankroll to use Global Secure Access then can I borrow some money? ü§ë. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:4:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#defender-features"},{"categories":["android"],"content":" 5 SummaryEven with the additional configuration implemented for supported Samsung devices, it‚Äôs still not as seamless as the zero-touch onboarding available for iOS devices. Whether this is down to Android being fussy more particular with permissions and privacy settings than iOS or otherwise, users should not have to actively onboard their devices to a security service. At least we‚Äôve made the whole process a little easier for the Android users, and fixed some gaps with the Microsoft documentation. ","date":"10 December 2024","objectID":"/posts/android-enterprise-defender-onboarding/:5:0","series":null,"tags":["intune","defender","security","oemconfig"],"title":"Lower-Touch Defender for Endpoint Onboarding for Android Devices","uri":"/posts/android-enterprise-defender-onboarding/#summary"},{"categories":["windows"],"content":"Deploying Windows 11 24H2 feature updates using Microsoft Intune with Entra ID Dynamic User Groups and Feature Update Readiness reports to tag users based on risk.","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/"},{"categories":["windows"],"content":"Why are we here again, looking at the deployment of Windows 11 to your Microsoft Intune managed devices? Well, there‚Äôs still not long to go until Windows 10 gets killed off and you‚Äôre going to have to move to Windows 11, and four five six nine things: We should probably be using Entra App Registrations for authentication. Alberto Baratta on LinkedIn kindly pointed out that there was a way to improve the collection of the Readiness Report data. I‚Äôve improved the processing of the Readiness report data after learning about hashtables. I encountered a situation where existing Windows Update for Business rings were deployed to groups of users üòÖ. If I‚Äôm saying you should be re-running the script on a regular basis, I should probably allow for a non-interactive version of the script. I‚Äôd better include the option to use Scope tags in the report capture. Device attributes should only be updated if they‚Äôve changed. Running the script in whatif mode Something about Windows 11 24H2 being released. So how does that impact this series of posts and the updated Windows 11 Accelerator script? ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:0:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#"},{"categories":["windows"],"content":" 1 Graph AuthenticationHonestly I just straight up robbed the authentication function that Andrew Taylor created. Is it really stealing if it‚Äôs community content? üòò So to allow for the updated script to authenticate to Graph. we now need to create an Entra App registration, associated Client Secret, and give the app permissions to Microsoft Graph. Info The permissions we need for this script are the following: Group.ReadWrite.All, Device.ReadWrite.All, DeviceManagementManagedDevices.ReadWrite.All DeviceManagementConfiguration.ReadWrite.All, User.ReadWrite.All, and DeviceManagementRBAC.Read.All App Registration for authentication in Entra ID. Once created, we can now pass through the Application Id and the value of the Client Secret to the script along with the already required tenant Id: PowerShell $tenantId = '36019fe7-a342-4d98-9126-1b6f94904ac7' $appId = '297b3303-da1a-4e58-bdd2-b8d681d1bd71' $appSecret = 'g5m8Q~CSedPeRoee4Ld9Uvg2FhR_0Hy7kUpRIbo' .\\Invoke-Windows11AcceleratorUpdate.ps1 -tenantId $tenantId -appId $appId -appSecret $appSecret -target device -featureUpdateBuild 24H2 -extensionAttribute 11 Now giving us an easier way to authenticate to Graph, and will allow you to run the script without the need to authenticate with a Global Admin account every time. Nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:1:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#graph-authentication"},{"categories":["windows"],"content":" 2 Reporting Data CaptureFor the improvement to the script performance, well this is where thinking about enterprises with 10,000‚Äôs of Windows devices sometimes falls in a gap, when I‚Äôve only got small dev environments to play with üò∂. Previously in the script and detailed in the below post‚Ä¶ Risk Based Windows 11 Feature Update Deployment - Reporting With Windows 10 support coming to an end sooner than you'd expect, in the first part of this series we look at ways to capture Feature Update Readiness Report data using PowerShell and Graph to help with the rollout of the new Windows 11 operating system. Read more... ‚Ä¶we were calling the report 50 devices at a time, and looping through Graph API calls to the deviceManagement/reports/cachedReportConfigurations endpoint to get the Feature Update Readiness report data until there were no more devices left. Which if you‚Äôve got 80,000 Windows devices, is going to take quite a bit of time, hours in fact. So the solution Alberto Baratta came up with, was to just use the export report functionality that already exists in Intune, to capture the compressed download of the csv file, containing all the reporting information, using that as the source for the data. Brilliant. So now instead of looping through a million Graph calls, and probably hitting a throttle limit, we‚Äôre just processing the exported file. Comparing the previous version of the script taking three minutes to run (the video has been sped up x5) for 1100 devices: To the new version taking about three seconds: We see a marked improvement on the time taken to gather the details of the Windows feature update compatibility risks report, meaning that even with environments with 10,000‚Äôs of devices, the process will only take seconds not minutes. Speed nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:2:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#reporting-data-capture"},{"categories":["windows"],"content":" 3 Hash Tables in PowerShellEven with the improvement for capturing the readiness report details, when processing the data I was essentially foreach looping using Where-Object to get the deviceObjectID from the Entra data, which in large environments is not big, not clever, and importantly not quick. So I found out about hashtables, and implemented them to vastly improve the processing of the report data. Speedier nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:3:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#hash-tables-in-powershell"},{"categories":["windows"],"content":" 4 Tagging User ObjectsI wasn‚Äôt sure about the assignment of updates to users either, but the entire device estate only contained Single User Affinity Windows devices, i.e., one device to each user, and from an awareness and communication perspective, it‚Äôs easy to tell your users when they‚Äôre going to get updates for Feature Updates than it is working out which devices are. So a quick amendment to the script, now allows us to get details of the users from Entra, and where the primary user of the device matches one of these Entra users, it allows us to tag the user account with the risk of updating their device to Windows 11. Running the script with a new parameter, allows us to choose whether we want to assign the risk score to user or device: PowerShell .\\Invoke-Windows11AcceleratorUpdate.ps1 -target user -tenantId $tenantId -appId $appId -appSecret $appSecret -featureUpdateBuild 24H2 -extensionAttribute 11 With the script giving use the Dynamic Security Groups to create, as well as tagging primary users of the device: Nice? Info Do not use this unless you are happy that the Windows Update for Business, and Feature Update policies will follow the user around across devices they sign in to. So if you‚Äôre using Shared Devices, stay away from this one as you can‚Äôt use Device Filters with Feature Update profiles. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:4:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#tagging-user-objects"},{"categories":["windows"],"content":" 5 Non-Interactive ScriptSo after you‚Äôve run the script for the first time, you should be pretty happy that you‚Äôve started tagging your devices or users, what about the subsequent runs of the script? We should have already created our dynamic device or user groups and confirmed that the extension attributes are not in use for anything but the readiness risk state. So I‚Äôve now included a firstRun boolean parameter, which if set to $true (and is by default), will prompt for interaction, otherwise if set to $false will just breeze through the script and update devices with their associated update readiness risk. PowerShell .\\Invoke-Windows11AcceleratorUpdate.ps1 -firstRun $false -tenantId $tenantId -target device -featureUpdateBuild 24H2 -extensionAttribute 11 Silent nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:5:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#non-interactive-script"},{"categories":["windows"],"content":" 6 Intune Scope TagsI‚Äôd forgotten about these if I‚Äôm honest, so now I‚Äôve included the option to select a Scope Tag, so with the change to the authentication method also included a new Graph permission of DeviceManagementRBAC.Read.All, to allow us to read the existing Scope Tags and make sure the one selected exists. PowerShell .\\Invoke-Windows11AcceleratorUpdate.ps1 -scopeTag MVE -tenantId $tenantId -target device -featureUpdateBuild 24H2 -extensionAttribute 11 Don‚Äôt say I didn‚Äôt think about the more advanced users of Intune. Info If you don‚Äôt specify a scopeTag, then default is used for the Readiness report. RBAC nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:6:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#intune-scope-tags"},{"categories":["windows"],"content":" 7 Attribute UpdatesI was a little lazy with the first iteration of the script, as I just leant on the fact that the call to Graph to add Device Attributes just overwrote them each time. For more time based improvements, I‚Äôve added in logic to only update the attributes that have changed. Device Attributes only being updated if they have changed. Info To be honest this was only possible after the implementation of hashtables for speed. Sensible nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:7:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#attribute-updates"},{"categories":["windows"],"content":" 8 Demo ModeJust a quick one really, and for those who are more cautious than me, you can now run the script in demo mode, where it will do everything except tag users or devices. PowerShell .\\Invoke-Windows11AcceleratorUpdate.ps1 -demo -tenantId $tenantId -target device -featureUpdateBuild 24H2 -extensionAttribute 11 So this will just give you an indication of the current state of your Windows 11 Feature Update readiness, and make sure you‚Äôre not butchering your environment with tags that don‚Äôt mean anything. Windows 11 Accelerator script in Demo Mode. The script will still let you know what it is going to do, just not make changes to the extension attributes on devices or users. Whatif nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:8:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#demo-mode"},{"categories":["windows"],"content":" 9 Windows 11 24H2As the Windows 11 24H2 report data is now available, we should be able to query the data in Intune. So a quick update to the calls to Graph to use GE24H2 for the correct Feature Update version (compared with NI23H2 for Windows 11 23H2), and we can get the report data and tag things with their risk state: PowerShell .\\Invoke-Windows11AcceleratorUpdate.ps1 -featureUpdateBuild 24H2 -tenantId $tenantId -target device -extensionAttribute 11 Windows 11 Accelerator script for Windows 11 24H2 Best nice. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:9:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#windows-11-24h2"},{"categories":["windows"],"content":" 10 SummaryYes I know I should have probably looked at these when I first released the series of blog posts, but I didn‚Äôt. Be thankful I‚Äôve revisited this series and not just thrown myself into Autopilot v2 or Windows 365 Link posts üòÖ. Either way, you should now have no excuse to avoid moving to Windows 11 24H2 or otherwise, so crack on, start using the Windows 11 Accelerator script, time is ticking. ","date":"3 December 2024","objectID":"/posts/windows-11-risk-based-deployment-part5/:10:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Improvements","uri":"/posts/windows-11-risk-based-deployment-part5/#summary"},{"categories":["windows"],"content":"Using Remediation PowerShell scripts in Intune to force compatibility checks for Windows 11 24H2 feature updates.","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/"},{"categories":["windows"],"content":"I‚Äôve spent far too much time digging into the Windows Feature Update Readiness reports available in Intune, having used them extensively in a previous series of posts: Risk Based Windows 11 Feature Update Deployment - Reporting Risk Based Windows 11 Feature Update Deployment - Device Attributes Risk Based Windows 11 Feature Update Deployment - Feature Updates Risk Based Windows 11 Feature Update Deployment - Automation Risk Based Windows 11 Feature Update Deployment - Improvements Using the data within the report to tag devices with their update risk score, hopefully making that move to Windows 11 a little smoother and without incident. What happens to your devices that haven‚Äôt sent their precious readiness data to Microsoft for snooping processing, or those devices with results that have changed from say High to Low risk, or the devices that are marked as Unknown by the report because the data hasn‚Äôt been sent yet? Windows 11 Feature Update Readiness report. Can we help the devices with missing or stale data especially now that the Windows 11 24H2 report is now available? Sure we can. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:0:0","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#"},{"categories":["windows"],"content":" 1 Microsoft Compatibility AppraiserBefore we start fiddling (ahem) with settings on devices to get them to send their data to Microsoft, we need an understanding of where the Feature Update Readiness data is stored on the device‚Ä¶ App Compatibility Registry settings. ‚Ä¶yeah it‚Äôs the registry, where else would it be? Thanks to Johan Arwidmark for his post on the data stored in the registry and what it means, and the linked post from Adam Gross about the Compatibility Appraiser itself, we now have some way of identifying whether a device has been assessed for the feature updates available to it based on the data in the registry. Simply put, we can use a detection script in Intune to check if the appraisal has run, when it has run, and then a remediation script to force the tool to run if we need to. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:1:0","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#microsoft-compatibility-appraiser"},{"categories":["windows"],"content":" 2 Remediation ScriptsBoth PowerShell scripts are available in my GitHub repo, but to give you a little background to them, and how to use them, keep reading. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:2:0","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#remediation-scripts"},{"categories":["windows"],"content":" 2.1 DetectionAs I‚Äôm only interested in the latest and greatest Windows 11 Feature Update compatibility data, we only really need to check on the keys located in: text HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\CompatMarkers\\ Specifically these ones: Registry Key Feature Update Version GE24H2 Windows 11 24H2 NI23H2 Windows 11 23H2 We can populate the $featureUpdate variable in the detection script with the corresponding Registry Key to check to see if data exists, and if it doesn‚Äôt we‚Äôll exit in a way that Intune will start a remediation. So for Windows 11 24H2 it‚Äôs $featureUpdate = 'GE24H2', and for Windows 11 23H2 it would be $featureUpdate = 'NI23H2'. PowerShell $featureUpdate = 'GE24H2' # Windows 11 24H2 #$featureUpdate = 'NI23H2' # Windows 11 23H2 $registry = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\CompatMarkers\\$featureUpdate\" If the registry key does exist, we can then query the value of the string TimestampEpochString which is populated by the App Compatibility tool when it was last run successfully, and compare it to the date and time when the script runs, minus a set number of hours (in Epoch format), configured using the $schedule variable. PowerShell $featureUpdate = 'GE24H2' # Windows 11 24H2 #$featureUpdate = 'NI23H2' # Windows 11 23H2 $registry = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\CompatMarkers\\$featureUpdate\" $lastRun = Get-ItemPropertyValue -Path $registry -Name TimestampEpochString -ErrorAction SilentlyContinue $schedule = 24 # update based on the remediation schedule $nowLessHours = Get-Date $((Get-Date).AddHours(-$schedule)) -UFormat +%s if ($lastRun -lt $nowLessHours) { Write-Warning \"App Compat not run in last $schedule hours\" Exit 1 } Info Depending on your Remediation script schedule will depend on the value of this variable, you don‚Äôt want remediations running indefinitely. If you‚Äôre running this every seven days for example, you want to set $schedule = 168, so the remediation will only run if the App Compatibility tool hasn‚Äôt run in the last seven days (7 x 24 = 168), more quick maths. App Compatibility Remediation Script schedule in Intune. So with a bit of error capture, we now have a complete detection script that can be tailored based on the Feature Update we want the data for, and the schedule that the remediation in Intune will be run. Check-FeatureUpdateAppraisal-Detection.ps1 $schedule = 24 # update based on the remediation schedule $featureUpdate = 'GE24H2' # Windows 11 24H2 #$featureUpdate = 'NI23H2' # Windows 11 23H2 Try { $registry = \"HKLM:\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\CompatMarkers\\$featureUpdate\" # Checks if the key exists and the last run of the App Compat Try { $lastRun = Get-ItemPropertyValue -Path $registry -Name TimestampEpochString -ErrorAction SilentlyContinue } Catch { Write-Warning \"App Compat not run for Windows 11 $featureUpdate\" Exit 1 } # if the key and dword exist checks the last run time $nowLessHours = Get-Date $((Get-Date).AddHours(-$schedule)) -UFormat +%s if ($lastRun -lt $nowLessHours) { Write-Warning \"App Compat not run in last $schedule hours\" Exit 1 } else { Write-Output \"App Compat run in last $schedule hours\" Exit 0 } } Catch { Write-Error $_.Exception Exit 2000 } ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:2:1","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#detection"},{"categories":["windows"],"content":" 2.2 RemediationThe detection now sorted, we should test a concept of a remediation. Go and delete the following key in the registry from a test device, or your own if you feel like it: txt Computer\\HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\CompatMarkers\\GE24H2 We‚Äôll bring the data in that key back, I promise, truss mi daddi. We do need a way to kick off the App Compatibility tool using a remediation script, so we can start the application itself CompatTelRunner.exe located $env:windir\\system32, with the associated arguments: PowerShell $filePath = \"$env:windir\\system32\\CompatTelRunner.exe\" $argumentList = \"-m:appraiser.dll -f:DoScheduledTelemetryRun\" Start-Process -WindowStyle Hidden -FilePath $filePath -ArgumentList $argumentList -Wait To bring back the registry data we deleted, just run the above from an elevated PowerShell prompt‚Ä¶ And all being well, the App Compatibility tool will have run successfully, and the registry will be populated with the report information we so desperately need: App Compatibility Registry settings. So throwing those three lines into something that should handle errors, we get a remediation script. Check-FeatureUpdateAppraisal-Remediation.ps1 Try { $filePath = \"$env:windir\\system32\\CompatTelRunner.exe\" $argumentList = \"-m:appraiser.dll -f:DoScheduledTelemetryRun\" if (Test-Path -Path $filePath){ Start-Process -WindowStyle Hidden -FilePath $filePath -ArgumentList $argumentList -Wait Write-Output \"App Compat Assessment started\" Exit 0 } else { Write-Output \"Unable to start App Compat Assessment\" Exit 1 } } Catch { Write-Error $_.Exception Exit 2000 } So if the detection identifies either that the key doesn‚Äôt exist, or if the last time the App Compatibility tool was run is outside of your schedule, it will kick off the tool to run and evaluate the Feature Updates it has available. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:2:2","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#remediation"},{"categories":["windows"],"content":" 3 DeploymentYou should be using remediation scripts in Intune already, so go and create one using the two provided scripts after updating the variables in the detection script, with it looking something like this: Feature Update remediation script settings in Intune. With whatever schedule you‚Äôve decided and updated the $schedule variable in the detection script to, in this example it‚Äôs once daily i.e., 24 hours. If you‚Äôre lucky your devices will then start checking to see the last time the tool was run, and kick off a new run if needed. Feature Update remediation report status. Now just to wait a quick 52 hours for the report data to update üòÖ. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:3:0","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#deployment"},{"categories":["windows"],"content":" 4 SummaryYou should be aiming to get your devices to Windows 11 sharpish if you haven‚Äôt done so already, and Intune provides you with the tooling to at least understand the impact of what that update process looks like with the readiness report. The readiness report needs your devices to send them data, and if the data doesn‚Äôt exist, then they‚Äôll have nothing to send, hence the raft of devices classified as ‚ÄòUnknown‚Äô when it comes to their update risk state. All we‚Äôre doing is helping those devices along, and ensuring that they have their compatibility data ready to send to Microsoft, so you can make informed choices when it comes to distributing Windows 11 feature updates. Off you trot now, you‚Äôve got Windows 10 devices to update. ","date":"19 November 2024","objectID":"/posts/windows-feature-updates-assessment/:4:0","series":null,"tags":["intune","updates","feature updates","remediation","powershell","security"],"title":"Forcing Windows 11 Feature Update Readiness Assessments","uri":"/posts/windows-feature-updates-assessment/#summary"},{"categories":["windows"],"content":"Using exported AppLocker XML policies to create our AppLocker deployment in Microsoft Intune using PowerShell and Graph API","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/"},{"categories":["windows"],"content":"There are many posts about how to configure AppLocker in Intune, most of which I‚Äôve used and looked at some point in my time, so why are we here (writing a post about it I mean, not an existential crisis thing) looking at it? Well I had the pleasure of using AaronLocker in anger, with a customer who had five distinct device use cases, and consequently five distinct AppLocker policy groupings, and I honestly cba manually creating the policies in Intune. So I didn‚Äôt. ","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:0:0","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#"},{"categories":["windows"],"content":" 1 AppLocker PoliciesThere isn‚Äôt a nice GUI friendly way to create AppLocker policies using Intune, and everything suggests using secpol.msc to create your AppLocker policies first, or just exporting your existing AppLocker policies from Group Policy to XML, or if you‚Äôre fancy, using the AaronLocker scripts to create the policies for you. They also say you need strip out bits from the exported XML file for each of the rule collections for Exe, Msi, Scripts, Dll, and Appx policies. Each of these rule collections then needs to be applied using a Custom Profile using the corresponding OMA-URI somewhat detailed in the AppLocker CSP. Rule Type OMA-URI Value Exe ./Vendor/MSFT/AppLocker/ApplicationLaunchRestrictions/{Grouping}/EXE/Policy String Msi ./Vendor/MSFT/AppLocker/ApplicationLaunchRestrictions/{Grouping}/MSI/Policy String Scripts ./Vendor/MSFT/AppLocker/ApplicationLaunchRestrictions/{Grouping}/Script/Policy String Dll ./Vendor/MSFT/AppLocker/ApplicationLaunchRestrictions/{Grouping}/DLL/Policy String Appx ./Vendor/MSFT/AppLocker/ApplicationLaunchRestrictions/{Grouping}/StoreApps/Policy String Then Intune smushes these rules together based on the {Grouping} label to apply the AppLocker policy to the device. All of this sounds painfully manual, so let‚Äôs write us some PowerShell to do this for us. ","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:1:0","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#applocker-policies"},{"categories":["windows"],"content":" 1.1 Exported PolicyWe‚Äôll start off with our exported AppLocker policy, which has either come from AaronLocker, or by just exporting your policy from secpol.msc Exporting an AppLocker Policy in Security Policy MMC. Which after you‚Äôve saved the file, gives you an XML file looking something like the below. AppLockerRules-Audit.xml Ôªø\u003cAppLockerPolicy Version=\"1\"\u003e \u003cRuleCollection Type=\"Exe\" EnforcementMode=\"AuditOnly\"\u003e \u003cFilePathRule Id=\"fd686d83-a829-4351-8ff4-27c7de5755d2\" Name=\"(Default Rule) All files\" Description=\"Allows members of the local Administrators group to run all applications.\" UserOrGroupSid=\"S-1-5-32-544\" Action=\"Allow\"\u003e \u003cConditions\u003e \u003cFilePathCondition Path=\"*\" /\u003e \u003c/Conditions\u003e \u003c/FilePathRule\u003e \u003cFilePathRule Id=\"cdfd5d1c-828f-4bd6-9542-1395c6088f82\" Name=\"All files located in the Program Files folder\" Description=\"Allows members of the Everyone group to run applications that are located in the Program Files folder.\" UserOrGroupSid=\"S-1-1-0\" Action=\"Allow\"\u003e \u003cConditions\u003e \u003cFilePathCondition Path=\"%PROGRAMFILES%\\*\" /\u003e \u003c/Conditions\u003e \u003cExceptions\u003e \u003cFilePathCondition Path=\"%PROGRAMFILES%\\microsoft\\edge\\application\\setupmetrics\\*\" /\u003e \u003cFilePathCondition Path=\"%PROGRAMFILES%\\microsoft\\edgewebview\\application\\setupmetrics\\*\" /\u003e \u003cFilePathCondition Path=\"%PROGRAMFILES%\\google\\chrome\\application\\setupmetrics\\*\" /\u003e \u003c/Exceptions\u003e \u003c/FilePathRule\u003e \u003cFilePathRule Id=\"38080c1b-54bc-4f7e-804d-fafb70bf781b\" Name=\"All files located in the Windows folder\" Description=\"Allows members of the Everyone group to run applications that are located in the Windows folder.\" UserOrGroupSid=\"S-1-1-0\" Action=\"Allow\"\u003e \u003cConditions\u003e \u003cFilePathCondition Path=\"%WINDIR%\\*\" /\u003e \u003c/Conditions\u003e \u003cExceptions\u003e \u003cFilePathCondition Path=\"%WINDIR%\\debug\\wia\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\debug\\wia:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\registration\\crmlog\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\serviceprofiles\\localservice\\appdata\\local\\intel\\ipfsrv\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\serviceprofiles\\localservice\\appdata\\local\\intel\\ipfsrv:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\serviceprofiles\\localservice\\appdata\\local\\microsoft\\dlna\\deviceicons\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\serviceprofiles\\localservice\\appdata\\local\\microsoft\\dlna\\deviceicons:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\detectionverificationdrv\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\detectionverificationdrv\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\helloface\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\helloface\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\hidtelephony\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\hidtelephony\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\ipf_umdf2\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\ipf_umdf2\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\ipfumdf\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\ipfumdf\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\sensorscx0102\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\sensorscx0102\\data:*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\sensorshidclassdriver\\data\\*\" /\u003e \u003cFilePathCondition Path=\"%WINDIR%\\servicestate\\sensorshidclassdriver\\data:*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\com\\dmp\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\config\\systemprofile\\appdata\\local\\packages\\lpacsenseimdscollector\\ac\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\config\\systemprofile\\appdata\\local\\packages\\lpacsensendr\\ac\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\drivers\\driverdata\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\drivers\\driverdata:*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\logfiles\\firewall\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\logfiles\\firewall:*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\microsoft\\crypto\\rsa\\machinekeys\\*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\microsoft\\crypto\\rsa\\machinekeys:*\" /\u003e \u003cFilePathCondition Path=\"%SYSTEM32%\\spool\\drivers\\color\\*\" /","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:1:1","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#exported-policy"},{"categories":["windows"],"content":" 2 PowerShellSo I put together the following PowerShell script to do the hard work for me, and reduce human error obviously, not just because I‚Äôm lazy. To give you an understanding of what it‚Äôs doing before you blindly run it: Captures each of the RuleCollections in the exported XML file Can change the Enforcement mode of the policies to Audit (safety first) or Enforce (you hate your users) Creates a new Custom Profile in Intune with the AppLocker Policy Convert-AppLockertoIntune.ps1 \u003c# .SYNOPSIS .DESCRIPTION Takes an exported AppLocker policy from XML and creates an Intune custom profile with the corresponding settings. .PARAMETER tenantId Provide the Id of the tenant to connecto to. .PARAMETER xmlPath Path to the XML exported AppLocker policy. .PARAMETER displayName Name of the policy to be created in Intune. .PARAMETER grouping Name grouping setting for the AppLocker policies. .PARAMETER enforcement Configures the AppLocker policy to be in audit or enforce. Valid set is 'Enforce', 'Audit' .INPUTS None. You can't pipe objects to Convert-AppLockertoIntune.ps1. .OUTPUTS Convert-AppLockertoIntune.ps1 creates a mobileconfig and plist files in the same folder as the script. .EXAMPLE Create an Intune profile called WIN_COPE_AppLocker_Test for AppLocker settings set to Audit, with a grouping of 'Baseline' PS\u003e .\\Convert-AppLockertoIntune.ps1 -tenantId '36019fe7-a342-4d98-9126-1b6f94904ac7' -xmlPath 'C:\\Source\\github\\mve-scripts\\Intune\\EndpointSecurity\\AppLockerConversion\\AppLockerRules-Audit.xml' -displayName 'WIN_COPE_AppLocker_Test' -grouping 'Baseline' -enforcement Audit .EXAMPLE Create an Intune profile called WIN_COPE_AppLocker_Test for AppLocker settings set to Enforce, with a grouping of 'Development' PS\u003e .\\Convert-AppLockertoIntune.ps1 -tenantId '36019fe7-a342-4d98-9126-1b6f94904ac7' -xmlPath 'C:\\Source\\github\\mve-scripts\\Intune\\EndpointSecurity\\AppLockerConversion\\AppLockerRules-Audit.xml' -displayName 'WIN_COPE_AppLocker_Test' -grouping 'Development' -enforcement Enforce #\u003e [CmdletBinding()] param( [Parameter(Mandatory = $true)] [String]$tenantId, [Parameter(Mandatory = $true)] [String]$xmlPath, [Parameter(Mandatory = $true)] [string]$displayName, [Parameter(Mandatory = $true)] [string]$grouping, [Parameter(Mandatory = $true)] [ValidateSet('Enforce', 'Audit')] [string]$enforcement ) $tenantId = '437e8ffb-3030-469a-99da-e5b527908010' $xmlPath = 'C:\\Source\\github\\oddsandendpoints-scripts\\Intune\\EndpointSecurity\\AppLockerConversion\\broken.xml' $xmlPath = 'C:\\Source\\github\\oddsandendpoints-scripts\\Intune\\EndpointSecurity\\AppLockerConversion\\AppLockerRules-Audit.xml' $displayName = 'Demo' $grouping = 'Demo' $enforcement = 'Audit' #region variables [String[]]$scopes = 'DeviceManagementConfiguration.ReadWrite.All' $grouping = $grouping.Trim() -replace '\\s', '' #endregion variables #region functions Function Test-JSON() { param ( $JSON ) try { $TestJSON = ConvertFrom-Json $JSON -ErrorAction Stop $TestJSON | Out-Null $validJson = $true } catch { $validJson = $false $_.Exception } if (!$validJson) { Write-Host \"Provided JSON isn't in valid JSON format\" -f Red break } } Function Connect-ToGraph { \u003c# .SYNOPSIS Authenticates to the Graph API via the Microsoft.Graph.Authentication module. .DESCRIPTION The Connect-ToGraph cmdlet is a wrapper cmdlet that helps authenticate to the Intune Graph API using the Microsoft.Graph.Authentication module. It leverages an Azure AD app ID and app secret for authentication or user-based auth. .PARAMETER Tenant Specifies the tenant (e.g. contoso.onmicrosoft.com) to which to authenticate. .PARAMETER AppId Specifies the Azure AD app ID (GUID) for the application that will be used to authenticate. .PARAMETER AppSecret Specifies the Azure AD app secret corresponding to the app ID that will be used to authenticate. .PARAMETER Scopes Specifies the user scopes for interactive authentication. .EXAMPLE Connect-ToGraph -tenantId $tenantId -appId $app -appSecret $secret -#\u003e [cmdletbinding()] param ( [Parameter(Man","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:2:0","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#powershell"},{"categories":["windows"],"content":" 2.1 Running the ScriptTo allow these things to happen, you need to pass in some parameters: $tenantId - Your Entra ID tenant, you must have this memorised by now surely üòÖ $xmlPath - The path to the exported or created AppLocker XML file $displayName - The name of the Custom Profile to be created in Intune $grouping - The {Grouping} in the OMA-URI which is used to group (surprisingly) each of the RuleCollections into one AppLocker policy $enforcement - Whether you want the Intune AppLocker policy to be in Audit (Audit) or Enforcement (Enforce) mode So to run the script and create your AppLocker policy in Intune, you ping the following into a PowerShell prompt: PowerShell .\\Convert-AppLockertoIntune.ps1 -tenantId '36019fe7-a342-4d98-9126-1b6f94904ac7' -xmlPath 'C:\\Source\\github\\mve-scripts\\Intune\\EndpointSecurity\\AppLockerConversion\\AppLockerRules-Audit.xml' -displayName 'WIN_COPE_AppLocker_Test' -grouping 'Testing' -enforcement Enforce You get the following, authenticating obviously: ","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:2:1","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#running-the-script"},{"categories":["windows"],"content":" 2.2 ValidationChecking in Intune for much need validation from Microsoft Daddy, we now have a new Custom Profile AppLocker policy, with a date and time stamp just for fun: Imported AppLocker Policy in Microsoft Intune. Digging into the profile itself, we can see each of the required OMA-URI settings for each Rule collection, with the specified grouping of Testing: Imported AppLocker Policy OMA-URI setting in Microsoft Intune. As we specified that we‚Äôd like to piss off secure our users on their devices, by enforcing the AppLocker policy, the content of each OMA-URI setting has updated the enforcement mode to Enabled from the setting in the original XML, which was AuditOnly: Imported AppLocker Policy RuleCollection setting in Microsoft Intune. Applying this to devices, should result in some happy reports in Intune: Imported AppLocker Policy assignment report in Microsoft Intune. But maybe some unhappy users üòÖ. ","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:2:2","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#validation"},{"categories":["windows"],"content":" 3 SummaryAs much as people think AppLocker is dead, and I guess it is from a development perspective, it isn‚Äôt actually dead. Although AppLocker will continue to receive security fixes, it will not undergo new feature improvements. - Microsoft Learn Although App Control for Business (formerly WDAC) is the cutting edge of application protection now, AppLocker still has it‚Äôs place in the modern device management world. It‚Äôs a little easier pill to swallow to take an established on-premises AppLocker policy, and move it to Intune to support your move to Entra joined Windows 11 devices, than it is to start a brand new journey with App Control, something about technical debt. Either way, you can now easily move these AppLocker policies to Intune. Just don‚Äôt ask me about troubleshooting AppLocker, App Control, or WDAC, take those questions to the Security people. ","date":"22 October 2024","objectID":"/posts/windows-applocker-intune/:3:0","series":null,"tags":["intune","applocker","security","powershell","custom profiles","graph","Endpoint Security"],"title":"Converting AppLocker Policies to Intune Profiles","uri":"/posts/windows-applocker-intune/#summary"},{"categories":["macos"],"content":"Using PowerShell to create Defender for Endpoint antivirus scan setting custom profiles for Microsoft Intune and third-party MDM enrolled macOS devices.","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/"},{"categories":["macos"],"content":"Assuming that you‚Äôve decided to not only dip a toe into Microsoft products for managing your macOS device estate, but you‚Äôve gone balls deep two-footed instead, you‚Äôre probably onboarding your macOS devices into Defender for Endpoint, and deploying the Defender app, to take full advantage of that M365 licensing that smiling sales person told you to get for your users. Have you configured scheduled Defender antivirus scans? Have you thought about that? (Inb4, ‚Äúbut macOS devices don‚Äôt get viruses‚Äù) Well yeah probably, and you‚Äôve probably seen the Microsoft Learn article explaining how to deploy a scheduled scan configuration using Custom Settings, surely there must be an easier way to create the associated config file, without doing maths? ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:0:0","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#"},{"categories":["macos"],"content":" 1 Scheduling ScansAs I get to work with an array of customers, each with their own special requirements, and I cba repeating effort, I thought I‚Äôd just use PowerShell to create the required config files to be used in Microsoft Intune, or even Jamf to configure the Defender scan settings. Before we get to the good bit, we need to talk about the settings we actually can configure in a profile. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:1:0","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#scheduling-scans"},{"categories":["macos"],"content":" 1.1 Defender Scan OptionsA straight copy/paste from the Microsoft Learn article, we can see the below options that can be configured: Parameter Accepted values Information scheduledScan enabled or disabled We‚Äôre going to set this as enabled by default, otherwise what‚Äôs the point? scanType quick or full Again we‚Äôre going to want at least one full scan. ignoreExclusions true or false Probably don‚Äôt want to ignore the exclusions, they‚Äôre exclusions for a reason. lowPriorityScheduledScan true or false Yeah maybe we make this true by default, it‚Äôs not like people complain about Defender being resource hungry üòÖ. dayOfWeek Integer range between 0 and 8 0 is everyday, 8 is never, the rest start Sunday through to Saturday. timeOfDay The number of minutes after midnight Here‚Äôs that maths I was talking about, we‚Äôll sort this. interval Integer range between 0 and 24 0 is no interval, the other represents hours, with 24 being once a day. randomizeScanStartTime Integer range between 0 and 23 How many hours between the scheduled start time and this many hours after a scan will randomly start between. And some sneaky additional options from the Defender macOS Schema documentation that we can also play around with: Parameter Accepted values Information checkForDefinitionsUpdate true or false Check for new updates before running a scheduled scan. Yes please. runScanWhenIdle true or false Will delay a scheduled weekly full scan until the device is doing nothing. Now with the Defender antivirus settings we can actually configure, we can look to leverage these as parameters in a script to build the required configuration files. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:1:1","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#defender-scan-options"},{"categories":["macos"],"content":" 1.2 Example ProfilesBefore we start pissing about playing with unnecessary PowerShell scripts to create something we can manually create in minutes, we should look at the format of the config profiles used, and Microsoft kindly gives us an example to work from. Configuring the scheduled scans with the settings below: an hourly quick scan a daily quick scan configuration is set to run at 14:45 (885 minutes after midnight) a weekly full scan will run on Wednesdays at 14:40 (880 minutes after midnight) XML \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eC4E6A782-0C8D-44AB-A025-EB893987A295\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMicrosoft\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003eC4E6A782-0C8D-44AB-A025-EB893987A295\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e99DBC2BC-3B3A-46A2-A413-C8F9BB9A7295\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.microsoft.wdav\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMicrosoft\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e99DBC2BC-3B3A-46A2-A413-C8F9BB9A7295\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring/\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e885\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e1\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e4\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e880\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e Saving this as com.microsoft.wdav.mobileconfig will allow us to add it to Intune as a Custom profile. Bug This one, unlike the Microsoft provided first example in the article actually works in Intune ü´†. Microsoft also provide a corresponding Jamf or Third-Party MDM profile as well, with the same scan settings as above. XML \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e885\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e1\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e4\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e880\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/plist\u003e This example instead saved as com.microsoft.wdav.plist for use in the Third-Party MDM tools, and I‚Äôd test them if my Jamf trial hadn‚Äôt expired. Info Note the different format of the examples and the file type Microsoft suggest you save this as depending on whether it‚Äôs for Intune or other MDM solutions. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:1:2","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-profiles"},{"categories":["macos"],"content":" 2 Using PowerShellSo we now have some understanding of the format required across both profile types, as well as the options we can configure in the profile to allow for macOS devices to not go without a Defender scan now that they have the functionality, and of course the Defender app. I‚Äôm not going to bore you with how I built the PowerShell script, as those types of blog posts get no traction üòÇ, and you all just want the quick win and end result. So we‚Äôll go to the highlights of the script: Allows for the selection of plist or mobileconfig as an output of the script for use in Third-Party MDM solutions ü§¢, or our beloved ü•∞ Microsoft Intune Allows for configuration of a weekly full or quick Defender Scan, the day and time of the scan Allows for configuration of a daily quick Defender Scan, and the time of the scan Allows for configuration of regular quick scans Works out the maths for time of day scans Allows for configuration of additional scan scheduling options, as well as setting recommended defaults Formats the XML Creates the config file in the required format in the same folder as the PowerShell script So with that done, now to look at our options for running the script. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:0","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#using-powershell"},{"categories":["macos"],"content":" 2.1 Example 1To create the config file to configure Defender with the following settings: Weekly full scan running on a Wednesday at 11:30 Daily quick scan running at 14:15 No regular daily scan Check for updates before scan is enabled 2.1.1 Example 1 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.mobileconfig example1.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eFA238AD1-E80F-4B4F-AA1B-FFC10C030E0A\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003eFA238AD1-E80F-4B4F-AA1B-FFC10C030E0A\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eA46CF290-7D20-49A6-A432-75013384FA69\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.microsoft.wdav\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003eA46CF290-7D20-49A6-A432-75013384FA69\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring /\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e855\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e0\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e4\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e690\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e 2.1.2 Example 1 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.plist example1.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e855\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e0\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e4\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e690\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:1","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-1"},{"categories":["macos"],"content":" 2.1 Example 1To create the config file to configure Defender with the following settings: Weekly full scan running on a Wednesday at 11:30 Daily quick scan running at 14:15 No regular daily scan Check for updates before scan is enabled 2.1.1 Example 1 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.mobileconfig example1.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID FA238AD1-E80F-4B4F-AA1B-FFC10C030E0A PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier FA238AD1-E80F-4B4F-AA1B-FFC10C030E0A PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID A46CF290-7D20-49A6-A432-75013384FA69 PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier A46CF290-7D20-49A6-A432-75013384FA69 PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 855 interval 0 weeklyConfiguration dayOfWeek 4 timeOfDay 690 scanType full 2.1.2 Example 1 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.plist example1.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 855 interval 0 weeklyConfiguration dayOfWeek 4 timeOfDay 690 scanType full ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:1","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-1---intune"},{"categories":["macos"],"content":" 2.1 Example 1To create the config file to configure Defender with the following settings: Weekly full scan running on a Wednesday at 11:30 Daily quick scan running at 14:15 No regular daily scan Check for updates before scan is enabled 2.1.1 Example 1 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.mobileconfig example1.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID FA238AD1-E80F-4B4F-AA1B-FFC10C030E0A PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier FA238AD1-E80F-4B4F-AA1B-FFC10C030E0A PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID A46CF290-7D20-49A6-A432-75013384FA69 PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier A46CF290-7D20-49A6-A432-75013384FA69 PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 855 interval 0 weeklyConfiguration dayOfWeek 4 timeOfDay 690 scanType full 2.1.2 Example 1 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType full -weeklyScanDay wed -weeklyScanHour 11 -weeklyScanMinute 30 -dailyScan $true -dailyScanHour 14 -dailyScanMinute 15 -regularScanInterval 0 -checkForDefinitionsUpdate $true example1.com.microsoft.wdav.plist example1.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 855 interval 0 weeklyConfiguration dayOfWeek 4 timeOfDay 690 scanType full ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:1","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-1---third-party-mdm"},{"categories":["macos"],"content":" 2.2 Example 2To create the config file to configure Defender with the following settings: No weekly full scan Daily quick scan running at 11:20 Regular scan every 12 hours Check for updates before scan is enabled Low priority scheduled scan is enabled Allow scan start time to be randomised within a 2 hour window 2.2.1 Example 2 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.mobileconfig example2.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e4961A7A7-E314-4B0B-95A9-01CA4E928E3F\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.microsoft.wdav\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e4961A7A7-E314-4B0B-95A9-01CA4E928E3F\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring /\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e2\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e680\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e12\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e8\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e 2.2.2 Example 2 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.plist example2.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e2\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e680\u003c/integer\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e12\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e8\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003efull\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:2","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-2"},{"categories":["macos"],"content":" 2.2 Example 2To create the config file to configure Defender with the following settings: No weekly full scan Daily quick scan running at 11:20 Regular scan every 12 hours Check for updates before scan is enabled Low priority scheduled scan is enabled Allow scan start time to be randomised within a 2 hour window 2.2.1 Example 2 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.mobileconfig example2.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID 02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3 PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier 02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3 PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID 4961A7A7-E314-4B0B-95A9-01CA4E928E3F PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier 4961A7A7-E314-4B0B-95A9-01CA4E928E3F PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 2 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 680 interval 12 weeklyConfiguration dayOfWeek 8 scanType full 2.2.2 Example 2 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.plist example2.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 2 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 680 interval 12 weeklyConfiguration dayOfWeek 8 scanType full ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:2","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-2---intune"},{"categories":["macos"],"content":" 2.2 Example 2To create the config file to configure Defender with the following settings: No weekly full scan Daily quick scan running at 11:20 Regular scan every 12 hours Check for updates before scan is enabled Low priority scheduled scan is enabled Allow scan start time to be randomised within a 2 hour window 2.2.1 Example 2 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.mobileconfig example2.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID 02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3 PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier 02F3F9A6-A694-4D6B-AA6E-E1DBD0748CE3 PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID 4961A7A7-E314-4B0B-95A9-01CA4E928E3F PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier 4961A7A7-E314-4B0B-95A9-01CA4E928E3F PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 2 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 680 interval 12 weeklyConfiguration dayOfWeek 8 scanType full 2.2.2 Example 2 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $false -dailyScan $true -dailyScanHour 11 -dailyScanMinute 20 -regularScanInterval 12 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $true -randomizeScanStartTime 2 example2.com.microsoft.wdav.plist example2.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 2 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration timeOfDay 680 interval 12 weeklyConfiguration dayOfWeek 8 scanType full ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:2","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-2---third-party-mdm"},{"categories":["macos"],"content":" 2.3 Example 3To create the config file to configure Defender with the following settings: Weekly quick scan running every day at 09:15 No daily quick scan No regular scan Check for updates before scan is enabled Low priority scheduled scan is disabled Wait for device to be idle before scanning Ignore any configured exclusions 2.3.1 Example 3 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.mobileconfig example3.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e1D7740E0-10EB-4087-A93C-0B7DBC014455\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e1D7740E0-10EB-4087-A93C-0B7DBC014455\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e5001432F-72C6-4B48-9329-F999CE572352\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.microsoft.wdav\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e5001432F-72C6-4B48-9329-F999CE572352\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eMicrosoft Defender for Endpoint configuration settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring /\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e0\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e555\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003equick\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e 2.3.2 Example 3 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.plist example3.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003efeatures\u003c/key\u003e \u003cdict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cstring\u003eenabled\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003escheduledScan\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eignoreExclusions\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003elowPriorityScheduledScan\u003c/key\u003e \u003cfalse /\u003e \u003ckey\u003erandomizeScanStartTime\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003echeckForDefinitionsUpdate\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003erunScanWhenIdle\u003c/key\u003e \u003ctrue /\u003e \u003ckey\u003edailyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003einterval\u003c/key\u003e \u003cstring\u003e0\u003c/string\u003e \u003c/dict\u003e \u003ckey\u003eweeklyConfiguration\u003c/key\u003e \u003cdict\u003e \u003ckey\u003edayOfWeek\u003c/key\u003e \u003cinteger\u003e0\u003c/integer\u003e \u003ckey\u003etimeOfDay\u003c/key\u003e \u003cinteger\u003e555\u003c/integer\u003e \u003ckey\u003escanType\u003c/key\u003e \u003cstring\u003equick\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/plist\u003e Hopefully by this poi","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:3","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-3"},{"categories":["macos"],"content":" 2.3 Example 3To create the config file to configure Defender with the following settings: Weekly quick scan running every day at 09:15 No daily quick scan No regular scan Check for updates before scan is enabled Low priority scheduled scan is disabled Wait for device to be idle before scanning Ignore any configured exclusions 2.3.1 Example 3 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.mobileconfig example3.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID 1D7740E0-10EB-4087-A93C-0B7DBC014455 PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier 1D7740E0-10EB-4087-A93C-0B7DBC014455 PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID 5001432F-72C6-4B48-9329-F999CE572352 PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier 5001432F-72C6-4B48-9329-F999CE572352 PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration interval 0 weeklyConfiguration dayOfWeek 0 timeOfDay 555 scanType quick 2.3.2 Example 3 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.plist example3.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration interval 0 weeklyConfiguration dayOfWeek 0 timeOfDay 555 scanType quick Hopefully by this poi","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:3","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-3---intune"},{"categories":["macos"],"content":" 2.3 Example 3To create the config file to configure Defender with the following settings: Weekly quick scan running every day at 09:15 No daily quick scan No regular scan Check for updates before scan is enabled Low priority scheduled scan is disabled Wait for device to be idle before scanning Ignore any configured exclusions 2.3.1 Example 3 - Intune PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm Intune -organisation 'MEM v ENNBEE' -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.mobileconfig example3.com.microsoft.wdav.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e PayloadUUID 1D7740E0-10EB-4087-A93C-0B7DBC014455 PayloadType Configuration PayloadOrganization MEM v ENNBEE PayloadIdentifier 1D7740E0-10EB-4087-A93C-0B7DBC014455 PayloadDisplayName Microsoft Defender for Endpoint settings PayloadDescription Microsoft Defender for Endpoint configuration settings PayloadVersion 1 PayloadEnabled PayloadRemovalDisallowed PayloadScope System PayloadContent PayloadUUID 5001432F-72C6-4B48-9329-F999CE572352 PayloadType com.microsoft.wdav PayloadOrganization MEM v ENNBEE PayloadIdentifier 5001432F-72C6-4B48-9329-F999CE572352 PayloadDisplayName Microsoft Defender for Endpoint configuration settings PayloadDescription PayloadVersion 1 PayloadEnabled features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration interval 0 weeklyConfiguration dayOfWeek 0 timeOfDay 555 scanType quick 2.3.2 Example 3 - Third-Party MDM PowerShell .\\New-macOSDefenderScanProfile.ps1 -mdm ThirdParty -weeklyScan $true -weeklyScanType quick -weeklyScanDay all -weeklyScanHour 9 -weeklyScanMinute 15 -dailyScan $false -regularScanInterval 0 -checkForDefinitionsUpdate $true -lowPriorityScheduledScan $false -runScanWhenIdle $true -ignoreExclusions $true example3.com.microsoft.wdav.plist example3.com.microsoft.wdav.plist \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e features scheduledScan enabled scheduledScan ignoreExclusions lowPriorityScheduledScan randomizeScanStartTime 0 checkForDefinitionsUpdate runScanWhenIdle dailyConfiguration interval 0 weeklyConfiguration dayOfWeek 0 timeOfDay 555 scanType quick Hopefully by this poi","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:2:3","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#example-3---third-party-mdm"},{"categories":["macos"],"content":" 3 Microsoft Intune SettingsSo now we can create a new Custom profile in Microsoft Intune, add the generated mobileconfig file, and deploy the profile containing the Defender scheduled scan settings to your macOS devices. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:3:0","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#microsoft-intune-settings"},{"categories":["macos"],"content":" 3.1 Custom ProfileWe‚Äôll use the mobileconfig file we created in Example 1 for Intune, which will configure the scheduled scan settings to the below: Weekly full scan running on a Wednesday at 11:30 Daily quick scan running at 14:15 No regular daily scan Check for updates before scan is enabled So go create a new Custom Profile in Microsoft Intune, and upload the mobileconfig file we created: Microsoft Intune macOS custom profile for Defender Scheduled scan settings. Make sure you‚Äôre selecting Device channel, then go assign this to your macOS devices, and wait some length of time for Intune to report a deployment success. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:3:1","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#custom-profile"},{"categories":["macos"],"content":" 3.2 ValidationOnce your devices have checked in to Intune, there should be a new profile on the device with the Defender scan schedule settings: macOS profile for Defender Scheduled scan settings. To double down and be super-serious about ensuring that the settings match the configured parameters, they can be checked against the profile using the below command in a Terminal on a macOS device, to see if those scan settings have applied: shell mdatp health --details scheduled_scan Which should give us something like this: macOS profile for Defender Scheduled scan settings. Doing a bit of quick maths and comparing to the parameters: Configuration Setting Value Weekly full scan running on a Wednesday weekly_scan_configuration \u003e day_of_week 4 Weekly full scan running on a Wednesday at 11:30 weekly_scan_configuration \u003e time_of_day 690 Daily quick scan running at 14:15 daily_scan_configuration \u003e time_of_day 855 No regular daily scan daily_scan_configuration \u003e interval 0 Check for updates before scan is enabled check_for_definitions_update true The other settings such as low_priority, run_scan_when_idle, ignore_exclusions, and randomize_scan_start_time in the profile were set with default values within the PowerShell script; these can be adjusted based on your needs by configuring the parameters when running the script. Info To give you break down of the maths I was talking about, our weekly full scan running on a Wednesday at 11:30 equates to (11 x 60) + 30 = 690, and the daily scan running at 14:15 (14 x 60) + 15 = 855, giving us the number of minutes after midnight (local client time) a scheduled scan is set to run. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:3:2","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#validation"},{"categories":["macos"],"content":" 4 SummaryHonestly I‚Äôm hoping that these settings just appear in Settings Catalog sometime soon, instead of having to use a script which probably didn‚Äôt need creating in the first place, but here we are. At least we now have a way to generate the scheduled scan profile, and ensure that it will apply correctly, without the need for either a macOS device to create one on, or one to test to even see if the profile is valid. ","date":"8 October 2024","objectID":"/posts/macos-defender-scan-settings/:4:0","series":null,"tags":["intune","configuration","custom profiles","powershell","security","jamf","Endpoint Security","defender"],"title":"Scheduling Defender for macOS Antivirus Scans in Intune","uri":"/posts/macos-defender-scan-settings/#summary"},{"categories":["windows","macos","ios","android"],"content":"Using Device Categories in Microsoft Intune to allow end users to select their own day for delivery of operating system updates.","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/"},{"categories":["windows","macos","ios","android"],"content":"We‚Äôve looked at phasing the deployment of Windows Updates in a smart way with Dynamic Security Groups, we‚Äôve looked at allowing VIP users to opt out of phased Windows update installation, we‚Äôve even looked at how we deliver macOS operating system and software updates just like we do with Windows, what else is there to do now? Allowing an end user to choose what day they get their updates? Am I OK? Probably not, but if you‚Äôre wanting to empower your users to select when they get their updates, this might be an interesting read, especially when I explain how we‚Äôre going to achieve this. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:0:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#"},{"categories":["windows","macos","ios","android"],"content":" 1 Why Self-Service Updates?I mean, why not? As much as updates are there to ensure devices are secure, or as secure as they can be when it comes to operating system vulnerabilities, it is the user that is actually impacted by the installation of updates and enforced device restarts. So why not give them some control over when updates are installing. So how are we going to give the users a choice‚Ä¶ Microsoft Company Portal Device Category prompt. Yeah, Device Categories. In for a penny in for a pound when it comes to bad choices eh? ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:1:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#why-self-service-updates"},{"categories":["windows","macos","ios","android"],"content":" 2 Device Categories?Yes I know what you‚Äôre thinking, relying on end users to select the correct device category in the Company Portal, and then using that attribute to group devices to apply update settings sounds like a bad idea, but hear me out, please. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:2:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#device-categories"},{"categories":["windows","macos","ios","android"],"content":" 2.1 The Word of the Day is ‚ÄúInaccurate‚ÄùFirst before I convince you that this isn‚Äôt the worst thing in the world, we should see what the some of the issues are with Device Categories in their general use: A user will just select whatever device category they want - this leads to inaccurate assignment of device categories. A Windows user might not ever open the Company Portal - this means a category is never selected and grouping or filtering based on categories becomes inaccurate. An Intune administrator user can rename a category - if dynamic security groups or device filters rely on this category name, then these grouping become inaccurate. Now I‚Äôm not going to be able to solve all the issues here, especially as there isn‚Äôt an RBAC setting specifically for Device Categories, but we should be able to deal with a couple of them at least. Info If you are using Device Categories, I‚Äôm not coming for you here, but I would be very careful when using them for anything important. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:2:1","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#the-word-of-the-day-is-inaccurate"},{"categories":["windows","macos","ios","android"],"content":" 2.2 Configuring Device CategoriesBefore you excitedly go and create your new Device Categories, do me a solid and check that your users are actually able to select them from the Company Portal. Go check Tenant Customisation settings in Microsoft Intune, and turn on, if like me you‚Äôd in anger previously turned off the below option: Microsoft Intune Tenant Customisation. Now that you know how to just turn on or turn off Device Categories, if you‚Äôre not convinced, turn them off and go find another post to read, otherwise keep reading. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:2:2","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#configuring-device-categories"},{"categories":["windows","macos","ios","android"],"content":" 2.3 Days of the WeekIf you‚Äôre still here, and want to see how to let your users choose when they get their updates, we can look at creating the following Device Categories based on the the day of the week: Day of Update Device Category Sunday Update my device on a Sunday Monday Update my device on a Monday Tuesday Update my device on a Tuesday Wednesday Update my device on a Wednesday Thursday Update my device on a Thursday Friday Update my device on a Friday Saturday Update my device on a Saturday You can of course name these Device Categories something more suitable to your environment, and limit the days of the week if you‚Äôd like, just remember that this is an end user selecting a category, so some fancy naming convention won‚Äôt necessarily make as much sense to them as it does to you. With the Device Categories now in place, we can take on the advice of Microsoft for a change: Create device categories to help organize devices and build dynamic device groups. And go and create some Dynamic Security Groups in Entra using them. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:2:3","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#days-of-the-week"},{"categories":["windows","macos","ios","android"],"content":" 3 Dynamic Device GroupsTo support the ability for end users to get updates on the day they expect, we‚Äôre going to go and create some new Dynamic Device Groups in Entra. We can not only use these groups for include assignments for our update policies, but also exclude assignments, ensuring that even if an end user doesn‚Äôt bother opening the Company Portal, that they‚Äôll still get some level of update, just maybe not when they want it. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:3:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#dynamic-device-groups"},{"categories":["windows","macos","ios","android"],"content":" 3.1 Device Category GroupsThese are the obvious ones, as we‚Äôve created our Device Categories now, we need corresponding groups in Entra that we can use to capture the devices based on the category selected. Obviously my group rule matches my category names, yours might be different. Day of Update Group Name Rule Sunday SG_MDM_Devices_Updates_Sunday (device.deviceCategory -eq \"Update my device on a Sunday\") Monday SG_MDM_Devices_Updates_Monday (device.deviceCategory -eq \"Update my device on a Monday\") Tuesday SG_MDM_Devices_Updates_Tuesday (device.deviceCategory -eq \"Update my device on a Tuesday\") Wednesday SG_MDM_Devices_Updates_Wednesday (device.deviceCategory -eq \"Update my device on a Wednesday\") Thursday SG_MDM_Devices_Updates_Thursday (device.deviceCategory -eq \"Update my device on a Thursday\") Friday SG_MDM_Devices_Updates_Friday (device.deviceCategory -eq \"Update my device on a Friday\") Saturday SG_MDM_Devices_Updates_Saturday (device.deviceCategory -eq \"Update my device on a Saturday\") Info You may have noticed that I‚Äôm not using any other attributes in these groups, as we‚Äôre going to use them across all operating system types, and where we can we‚Äôll use Device Filters to apply to more granular devices, based on something like device ownership. If you want to be more specific here, and create a set of groups per operating system or per ownership type, go for it, it‚Äôs your environment after all, just remember that these Device Categories do not care about ownership, operating system, or otherwise. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:3:1","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#device-category-groups"},{"categories":["windows","macos","ios","android"],"content":" 3.2 Spreading the Update LoadSo what if we still want some phasing across supported update policies (it‚Äôs Windows, only Windows), and you don‚Äôt want all the users who selected the Update my device on a Thursday Device Category to get the update on the same Thursday? Well with a couple of additional Dynamic Security Groups, we can have two update policies for the same day but a week apart, splitting devices roughly in half. Scope Group Name Rule Initial Production SG_MDM_Devices_Updates_A (device.deviceManagementAppId -ne null) and ((device.deviceId -startsWith \"1\") or (device.deviceId -startsWith \"3\") or (device.deviceId -startsWith \"5\") or (device.deviceId -startsWith \"7\") or (device.deviceId -startsWith \"9\") or (device.deviceId -startsWith \"a\") or (device.deviceId -startsWith \"c\") or (device.deviceId -startsWith \"e\")) Final Production SG_MDM_Devices_Updates_B (device.deviceManagementAppId -ne null) and ((device.deviceId -startsWith \"0\") or (device.deviceId -startsWith \"2\") or (device.deviceId -startsWith \"4\") or (device.deviceId -startsWith \"6\") or (device.deviceId -startsWith \"8\") or (device.deviceId -startsWith \"b\") or (device.deviceId -startsWith \"d\") or (device.deviceId -startsWith \"f\")) We‚Äôve seen these types of groups before so they shouldn‚Äôt be too much of a surprise to you, but in short, we‚Äôre splitting all the devices into ~50% groups using the UUID associated with each deviceId object in Entra. We can then use these groups when creating our Windows Update rings for our weekday specific updates. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:3:2","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#spreading-the-update-load"},{"categories":["windows","macos","ios","android"],"content":" 4 Software Update ProfilesIn the case where we get users who do not select a Device Category for whatever reason, we can build out update profiles in our usual way, whether this be a phased approach or otherwise, but we need to ensure that these policies only apply to devices without a selected update day. To achieve this, we can just exclude our created Device Category dynamic security groups from our existing update policies. macOS Update Policy Exclusions. So for any existing update profiles, make sure you are excluding, in this instance, the seven created groups, allowing devices to get updates regardless of whether a user has bothered to open the Company Portal or not. Now on to the weekday specific policies. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:4:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#software-update-profiles"},{"categories":["windows","macos","ios","android"],"content":" 4.1 Windows Update RingsThis one requires a little more brain power than the other update policies, all to cope with the idea that you want to split devices across differing weeks, but on the same days. As maths isn‚Äôt my strong point, we‚Äôre going to leverage the option to install updates at a scheduled time; this has it‚Äôs downsides relating to whether a device is actually active during that time of day, but is easier to work out than using deferral and deadline settings that I‚Äôve covered previously. With the idea we need to create two update rings for each day to help spread the load, we can create one for Thursday on the first week of the month: Windows Update Ring for updates on a Thursday. Assigning this to the Thursday based Dynamic Security Group, but excluding one of our Production groups we created to split devices across update rings. Creating a second Update Ring for Thursday, but amending the week of the month and the assignment using the second week: Windows Update Ring for updates on a Thursday. Keeping the same include assignment, but amending the exclude assignment to the other Production group. Now you‚Äôve got your head around that, go create 14 update rings üòÖ with the below settings: Quality update deferral period (days) - 0 days Automatic update behaviour - Auto install and restart at a scheduled time Deadline for quality updates - 0 days Automatic behaviour frequency: Day of Update Week Assignment Sunday Second week of the month Include: SG_MDM_Devices_Updates_Sunday Exclude: SG_MDM_Devices_Updates_B Sunday Third week of the month Include: SG_MDM_Devices_Updates_Sunday Exclude: SG_MDM_Devices_Updates_A Monday Second week of the month Include: SG_MDM_Devices_Updates_Monday Exclude: SG_MDM_Devices_Updates_B Monday Third week of the month Include: SG_MDM_Devices_Updates_Monday Exclude: SG_MDM_Devices_Updates_A Tuesday Second week of the month Include: SG_MDM_Devices_Updates_Tuesday Exclude: SG_MDM_Devices_Updates_B Tuesday Third week of the month Include: SG_MDM_Devices_Updates_Tuesday Exclude: SG_MDM_Devices_Updates_A Wednesday Second week of the month Include: SG_MDM_Devices_Updates_Wednesday Exclude: SG_MDM_Devices_Updates_B Wednesday Third week of the month Include: SG_MDM_Devices_Updates_Wednesday Exclude: SG_MDM_Devices_Updates_A Thursday Second week of the month Include: SG_MDM_Devices_Updates_Thursday Exclude: SG_MDM_Devices_Updates_B Thursday Third week of the month Include: SG_MDM_Devices_Updates_Thursday Exclude: SG_MDM_Devices_Updates_A Friday Second week of the month Include: SG_MDM_Devices_Updates_Friday Exclude: SG_MDM_Devices_Updates_B Friday Third week of the month Include: SG_MDM_Devices_Updates_Friday Exclude: SG_MDM_Devices_Updates_A Saturday Second week of the month Include: SG_MDM_Devices_Updates_Saturday Exclude: SG_MDM_Devices_Updates_B Saturday Third week of the month Include: SG_MDM_Devices_Updates_Saturday Exclude: SG_MDM_Devices_Updates_A Your mileage may vary with which week of the month you‚Äôre choosing (remembering that the days in the second week might not be after Patch Tuesday), and if you really want to spread things out across the whole month, you can create smaller Production groups and four update rings per day. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:4:1","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#windows-update-rings"},{"categories":["windows","macos","ios","android"],"content":" 4.2 iOS/iPadOS Update PoliciesOn to the easier ones, and for whatever reason, ones that we don‚Äôt consider to warrant any kind of phasing. So go and create some iOS/iPadOS Update Policies and configure each update policy with the below default settings, making changes only to the Time Window configuration for each day of the week: Update to install - Install iOS/iPadOS Latest update Schedule type - Update during scheduled time Time zone - UTC¬±00 (select your own time zone) Time window: Day of Update Time Window Assignment Sunday Sunday 12AM - Monday 12AM SG_MDM_Devices_Updates_Sunday Monday Monday 12AM - Tuesday 12AM SG_MDM_Devices_Updates_Monday Tuesday Tuesday 12AM - Wednesday 12AM SG_MDM_Devices_Updates_Tuesday Wednesday Wednesday 12AM - Thursday 12AM SG_MDM_Devices_Updates_Wednesday Thursday Thursday 12AM - Friday 12AM SG_MDM_Devices_Updates_Thursday Friday Friday 12AM - Saturday 12AM SG_MDM_Devices_Updates_Friday Saturday Saturday 12AM - Sunday 12AM SG_MDM_Devices_Updates_Saturday You can see an example of how this has been configured below for delivering updates on a Monday: iOS Update Policy for updates on a Monday. You could, and I mean could, use the same logic behind the Windows update phasing, and split each day into twelve-hour sections, or more if you really hate yourself, and use the Production groups to split the delivery of updates in the morning and afternoon on the same day. But you know, iOS updates don‚Äôt break devices ü§®. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:4:2","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#iosipados-update-policies"},{"categories":["windows","macos","ios","android"],"content":" 4.3 macOS Update PoliciesWe‚Äôre almost there, so time for the macOS Update Policies, we‚Äôre sticking with this profile for now as gives us the behaviour we want, not one of the other options for software updates , configuring each with the default settings below: Critical updates - Install immediately Firmware updates - Install immediately Configuration file updates - Install immediately All other updates (OS, built-in apps) - Install immediately Schedule type - Update during scheduled time Time zone - UTC¬±00 (select your own time zone) Time window: Day of Update Time Window Assignment Sunday Sunday 12AM - Monday 12AM SG_MDM_Devices_Updates_Sunday Monday Monday 12AM - Tuesday 12AM SG_MDM_Devices_Updates_Monday Tuesday Tuesday 12AM - Wednesday 12AM SG_MDM_Devices_Updates_Tuesday Wednesday Wednesday 12AM - Thursday 12AM SG_MDM_Devices_Updates_Wednesday Thursday Thursday 12AM - Friday 12AM SG_MDM_Devices_Updates_Thursday Friday Friday 12AM - Saturday 12AM SG_MDM_Devices_Updates_Friday Saturday Saturday 12AM - Sunday 12AM SG_MDM_Devices_Updates_Saturday macOS Update Policy for updates on a Wednesday. Again, you can split these down to more granular times, but why bother, macOS updates definitely don‚Äôt break macOS devices ü§ê. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:4:3","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#macos-update-policies"},{"categories":["windows","macos","ios","android"],"content":" 4.4 Android Update PoliciesYeah, sorry, not an option for Android Enterprise devices, as there isn‚Äôt support for specific update install days. Let‚Äôs just let the user think they have some control over their updates here, a little placebo never hurt anyone. Android Device Restriction Profile. Just create a new Device Restriction profile and set System update under General to be Automatic, no need to even use the Dynamic Security Groups, just go ahead and assign this to all applicable devices. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:4:4","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#android-update-policies"},{"categories":["windows","macos","ios","android"],"content":" 5 User ExperienceNow that you‚Äôve got all your Dynamic Security Groups sorted, each Software Update policy created and assigned, across each of the supported operating systems, all is left to do is wait for users to select a Device Category. Device Categories in the Company Portal on macOS. Really your users can‚Äôt miss them, and with Android, iOS/iPadOS, and macOS enrolment pretty much forcing you to open the Company Portal, you should get some uptake. Info If you fancy, you could create a new Device Category for ‚ÄúI don‚Äôt care about updates‚Äù, and leverage that in either existing Dynamic Security Groups to leave the device in your standard Software Update deployment approaches. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:5:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#user-experience"},{"categories":["windows","macos","ios","android"],"content":" 6 SummaryIf you‚Äôve followed along, (and I assume most people switched off when I suggested using Device Categories), you could have some over arching catch-all update policies that will apply updates when you want them to, across as many phases or stages as you see fit and user selected update policies, allowing the user some control, or the semblance of control in some instances, as to when their device is updated and/or restarted all from the selection of a Device Category. Empowering. I‚Äôm not going to say this is the best approach for update delivery, nor am I suggesting you drop your current software update deployment approach in favour of something entirely user-driven, but I am at least showing you what is possible, with functionality in Microsoft Intune that often gets overlooked, or misused for whatever reason. ","date":"24 September 2024","objectID":"/posts/updates-self-service-deployment/:6:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Self-Service Software Update Deployments","uri":"/posts/updates-self-service-deployment/#summary"},{"categories":["ConfigMgr"],"content":"Using Microsoft Intune to deploy the Configuration Manager (SCCM) client using Win32 Apps to hybrid joined devices on the internet where they have lost communication, to allow connection to a Cloud Management Gateway (CMG).","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/"},{"categories":["ConfigMgr"],"content":"You‚Äôve just implemented a Cloud Management Gateway to help your hybrid joined Windows devices communicate to Configuration Manager over the internet, but what if they‚Äôre orphaned and unable to communicate to Configuration Manager to get the new Client Settings? This one might be little niche if I‚Äôm honest, but there is a scenario where you‚Äôve implemented a Cloud Management Gateway (CMG) as part of your Configuration Manager topology, your hybrid joined Windows devices are co-managed, but they no longer communicate back to the on-premises Configuration Manager Management Point for some reason, and you need to tell these remote devices that they can now use the Cloud Management Gateway. The reason could be that you have a user initiated VPN that no-one actually uses, you‚Äôre lacking a device tunnel for communication back to on-premises services, or you just have no VPN whatsoever, and these devices have just aged out of Configuration Manager never to be seen again. How on earth are we going to sort these rogue orphaned devices out, and get them back speaking with Configuration Manager and a Cloud Management Gateway? ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:0:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#"},{"categories":["ConfigMgr"],"content":" 1 Client CommunicationUsually after implementing a Cloud Management Gateway, you just wait for your devices to check back in to the Management Point during a location request, and when they‚Äôre classified as Currently Internet they‚Äôll happily communicate with the CMG, as long as they meet the client authentication requirements obviously. This won‚Äôt work for devices that don‚Äôt currently talk to Configuration Manager, nor if they‚Äôve disappeared from the console and discovery. So how do we deal with this? ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:1:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-communication"},{"categories":["ConfigMgr"],"content":" 1.1 Just Install the ClientStrangely, Microsoft actually recommended just re-installing the ConfigMgr Client on these devices, which isn‚Äôt a bad shout, so that‚Äôs at least the start of the process; with the devices hybrid joined and co-managed for at least the Client Apps workload, we can just package up the latest ConfigMgr client from the Primary Site server and punt it to the device estate. ‚ÄúOh, but what about using native tooling, isn‚Äôt there a way to get Microsoft Intune to do this for you?‚Äù, I hear you cry. Well yes, but also no. Microsoft Entra hybrid joined devices - If the device is targeted with co-management settings policy, in Microsoft Entra hybrid join scenario, the autopilot provisioning times out during ESP phase. and‚Ä¶ Clients that authenticate with PKI certificates. You can‚Äôt provision the certificate on the device before the Configuration Manager client installs and needs to authenticate to the CMG. Microsoft Entra ID is recommended for client authentication. For more information, see Plan for CMG client authentication: Microsoft Entra ID. The co-management authority setting in Microsoft Intune is great, for your Entra only Autopilot devices, and as covered previously, but just doesn‚Äôt work for the hybrid joined world, so a Win32 app it is, but what else do we need to consider? ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:1:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#just-install-the-client"},{"categories":["ConfigMgr"],"content":" 2 Client AuthenticationBefore we even look at packaging up the Configuration Manager client, we need to think about how these now essentially Internet-based devices are going to authenticate and communicate to the Cloud Management Gateway. As these aren‚Äôt fresh out the box devices, we shouldn‚Äôt need to treat them as such, so we can discard the need of using a site token as part of the installation, as these devices will already be hybrid joined, or have a device certificate to allow existing authentication. With this we can just look at how we make sure the devices are meeting the client authentication pre-requisites for the following two client authentication methods. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:2:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-authentication"},{"categories":["ConfigMgr"],"content":" 2.1 PKI AuthenticationI‚Äôm going to take a stab in the dark and suggest that these orphaned devices, if using PKI authentication, already have a certificate and the full chain of trust required to allow for PKI authentication, but we should be sure of this and not just assume. So as part of our soon to be packaged Win32 app, we need to utilise a PowerShell script to check that a certificate from your Internal Certification Authority exists with the correct extensions, and it‚Äôs valid using App Requirements in Microsoft Intune. Throwing together a quick script and updating the $certCA with the distinguished name of your Issuing Certification Authority, we can loop through all certificates issued to the device, making sure that the certificate has come from your internal CA, then check if the date is valid. Requirement-ConfigMgrClientPKI.ps1 $ready = 0 $certCA = 'CN=ennbee-LAB-CA, DC=ennbee, DC=local' #Certificate Authority Name $date = Get-Date #Used for checking valid certificate $certPath = 'cert:\\LocalMachine\\My' $certs = Get-ChildItem -Path $certPath foreach ($cert in $certs) { $certThumbPath = $certPath + \"\\$($cert.Thumbprint)\" if ($cert.Issuer -eq $certCA -and $cert.Extensions.EnhancedKeyUsages.FriendlyName -contains 'Client Authentication') { $certValid = Get-ChildItem -Path $certThumbPath | Select-Object NotAfter, NotBefore if ($date -gt $certValid.NotBefore -and $date -lt $certValid.NotAfter) { $ready++ } } } if ($ready -gt 0) { Write-Output Ready } If the script finds at least one certificate, as really the Configuration Manager client isn‚Äôt that fussy about which certificate it uses, just that there is one, the script will return a Ready output back to Microsoft Intune, which we can then use as a positive identifier that the app installation can start. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:2:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#pki-authentication"},{"categories":["ConfigMgr"],"content":" 2.2 Entra AuthenticationIf you decided that you couldn‚Äôt be bothered with PKI authentication (I mean who can really?), then the other option would have been to leverage the Microsoft Entra ID join state of the device, and here we‚Äôre making more broad assumptions that you‚Äôre meeting all other pre-requisites for this authentication method. The one we care about is the join state, as really this is the only one we can query from the client itself, so more PowerShell and using the ever trusty dsregcmd to get the join state of the device. Requirement-ConfigMgrClientEntra.ps1 $ready = 0 $dsRegCmd = dsregcmd /status $dsRegOutput = New-Object -TypeName PSObject $dsRegCmd | Select-String -Pattern ' *[A-z]+ : [A-z]+ *' | ForEach-Object { Add-Member -InputObject $dsRegOutput -MemberType NoteProperty -Name (([String]$_).Trim() -split ' : ')[0] -Value (([String]$_).Trim() -split ' : ')[1] } if ($dsRegOutput.AzureAdJoined -eq 'YES') { $ready++ } if ($ready -gt 0) { Write-Output Ready } With a bit of a hack, we can take the output of dsregcmd /status and throw it into a new PSObject, which gives us an sample output of the below: PowerShell AzureAdJoined : YES EnterpriseJoined : NO DomainJoined : YES Virtual Desktop : NOT SET Device Name : XXXXXX Thumbprint : XXXXXX DeviceCertificateValidity : [ 2023-10-31 13:36:52.000 UTC -- 2033-10-31 14:06:52.000 UTC ] KeyProvider : Microsoft Platform Crypto Provider TpmProtected : YES DeviceAuthStatus : SUCCESS TenantName : MEM v ENNBEE With the area we care about being the AzureAdJoined state, which can be referenced with $dsRegOutput.AzureAdJoined in the PowerShell script. Sticking with the Ready output here as well, we now have something we can confirm as part of the requirements for the application installation. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:2:2","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#entra-authentication"},{"categories":["ConfigMgr"],"content":" 3 Client Installation SettingsAs we‚Äôre using Microsoft Intune to push out a packaged version of the client, we can‚Äôt rely on a standard detection rule such as file , msi, or registry, as there is no guarantee that the version of the client already installed, isn‚Äôt the same as the one we‚Äôre trying to deploy. To get around this little hurdle, along with a couple of others along the way including the installation parameter for the ConfigMgr client, we need to create a PowerShell script to carry out the installation for us, taking into consideration the two main authentications methods of PKI and Entra authentication, as well as the requirements for the command line installation. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:3:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-installation-settings"},{"categories":["ConfigMgr"],"content":" 3.1 Command Line InstallationFor both authentication types, we need the following command line options and switches: CCMHOSTNAME - The You‚Äôll find the Cloud Management Gateway hostname in the ConfigMgr console under the Cloud Services settings. SMSSITECODE - Is pretty obviously your ConfigMgr site code. SMSMP - Required to specify the internal management point when the client is set to intranet connectivity. /mp - The management point address for the Cloud Management Gateway, it‚Äôs the one with the ‚Äòhttps://‚Äô prefix. /forceinstall will uninstall the existing client first, and is useful if the installed version of the client is the same as the version being deployed. With the PKI authentication we need some additional switches: /NoCRLCheck - Useful if the internal PKI environment hasn‚Äôt a public certificate revocation list (CRL), no needed if you‚Äôre using a public certificate on the Cloud Management Gateway. /UsePKICert - Tells the installation to use a PKI certificate for authentication to the Cloud Management Gateway. Finally for Entra authentication we need some details from the Enterprise App used for this authentication method when setting up Azure Services in ConfigMgr: AADTENANTID - Can be found in your Entra ID tenant. AADCLIENTAPPID - Is the Client ID of the Enterprise App and can be found in Entra ID. AADRESOURCEURI - Is the internal URL used for the service sometimes it‚Äôs in the format ‚Äòhttps://localhost‚Äô can be found in Enterprise App in Entra ID. So with all these switches now available, time to put them to good use and create a PowerShell script, that can be used for both authentication methods. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:3:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#command-line-installation"},{"categories":["ConfigMgr"],"content":" 3.2 Installation ScriptAs I don‚Äôt like to repeat myself, we can create one PowerShell script for both authentication types, using a switch parameter to control which of the command line settings are used for the installation, and passing though the details of the below mandatory parameters for both installation types: ccmSiteCode - ConfigMgr Site Code, so something like \"ENB\". ccmMP - The URL of the internal ConfigMgr Management Point such as \"https://configmgrmp.ennbee.local\". cmgAddress - The address of the Cloud Management Gateway (without the ‚Äòhttps://‚Äô bit, as we‚Äôre building that for the required parameter), so \"CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\" For the parameters required for the PKI authentication: PKI - A switch parameter that used to create the command line arguments for PKI authentication over Entra authentication. For the Entra authentication method we need to pass through the non-mandatory parameters: tenantId - This is the UUID for your tenant, so something similar to \"daf4a1c2-3a0c-401b-966f-0b855d3abd1a\" clientAppId - The client App object ID from Entra, so for me it‚Äôs \"7506ee10-f7ec-415a-b415-cd3d58790d97\" clientAppURL - The client App URI configured in the Enterprise App, like \"https://localhost\" I‚Äôve left these as non-mandatory and without any flight checks, as you‚Äôre not going to, a) see the output of the script, and b) I trust you to just use the script correctly. So we now have an installation script in all its glory, ready to be packaged along with the ConfigMgr client installation files so we can punt it into Microsoft Intune. Install-ConfigMgrClientCMG.ps1 [CmdletBinding()] param( [Parameter(Mandatory = $false)] [switch]$PKI, [Parameter(Mandatory = $true)] [String]$ccmSiteCode, [Parameter(Mandatory = $true)] [String]$ccmMP, [Parameter(Mandatory = $true)] [String]$cmgAddress, [Parameter(Mandatory = $false)] [String]$tenantId, [Parameter(Mandatory = $false)] [String]$clientAppId, [Parameter(Mandatory = $false)] [String]$clientAppURL ) try { if ($PKI) { $arguments = \"/forceinstall /NoCRLCheck /UsePKICert /mp:$('https://' + $cmgAddress) CCMHOSTNAME=$($cmgAddress) SMSSITECODE=$($ccmSiteCode) SMSMP=$($ccmMP)\" } else { $arguments = \"/forceinstall /mp:$('https://' + $cmgAddress) CCMHOSTNAME=$($cmgAddress) SMSSITECODE=$($ccmSiteCode) SMSMP=$($ccmMP) AADTENANTID=$($tenantId) AADCLIENTAPPID=$($clientAppId) AADRESOURCEURI=$($clientAppURL)\" } Start-Process -FilePath \"$PSScriptRoot\\ccmsetup.exe\" -PassThru -Wait -ArgumentList $arguments # Create a tag file just so Intune knows this was run $tagPath = \"$($env:ProgramData)\\Microsoft\\CCMCMGInstall\" If (-not (Test-Path $tagPath)) { mkdir $tagPath -Force } $scriptName = $MyInvocation.MyCommand.Name Set-Content -Path \"$tagPath\\$scriptName.tag\" -Value \"Installed\" } catch { $error[0] } Info To allow us to detect whether the installation of the app has happened, and to avoid using native detection methods, I‚Äôve included the creation of a .tag file in the script, which we can look for as part of the detection. To give you an example of the what the commands look like for PKI authentication it should look something like the below: PowerShell .\\Install-ConfigMgrClientCMG.ps1 -PKI -ccmSiteCode \"ENB\" -ccmMP \"https://configmgrmp.ennbee.local\" -cmgAddress \"CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\" And for Entra authentication it‚Äôll look like this, making sure to pass through the additional parameters for $tenantId, $clientAppId , and $clientAppURL: PowerShell .\\Install-ConfigMgrClientCMG.ps1 -ccmSiteCode \"ENB\" -ccmMP \"https://configmgrmp.ennbee.local\" -cmgAddress \"CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\" -tenantId \"daf4a1c2-3a0c-401b-966f-0b855d3abd1a\" -clientAppId \"7506ee10-f7ec-415a-b415-cd3d58790d97\" -clientAppURL \"https://localhost\" Script done, time to package it up and punt it out to clients. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:3:2","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#installation-script"},{"categories":["ConfigMgr"],"content":" 4 Application PackagingPackaging up the Configuration Manager client for deployment from Microsoft Intune has been documented countless times, so just do a quick Bing Google search, but I‚Äôll cover the high level steps so you don‚Äôt have to flit about the internet: Grab a copy of the latest client installation files from your Configuration Manager Primary Site server and plonk them somewhere on your Windows device: They‚Äôll be in \\\\localhost\\SMS_[SITECODE]\\cd.latest\\SMSSETUP\\CLIENT where [SITECODE] is your site code. Go and get the latest version of the Microsoft-Win32-Content-Prep-Tool Extract this somewhere sensible on your computer. Download the Client installation script from my GitHub repo. Place this in the same location as the Configuration Manager client files, where ccmsetup.exe exists in fact. You should now have a folder with the client install content and PowerShell script looking like this: Configuration Manager client installation files. Time to package the files. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:4:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#application-packaging"},{"categories":["ConfigMgr"],"content":" 4.1 Using the IntuneWinAppUtilNow we have all the required files, navigate in an elevated Terminal window to where you extracted the Microsoft-Win32-Content-Prep-Tool, running a command similar to the below, specifying the source folder (-c) as where you copied the Configuration Manager client installation files, the setup file (-s) as the PowerShell script, and the output (-o) where you want the new intunewin file to be created: PowerShell .\\IntuneWinAppUtil.exe -c \"C:\\Source\\Installers\\CCMClient\" -s Install-ConfigMgrClientCMG.ps1 -o \"C:\\Source\\Installers\" -q This will hopefully give us an output similar to the below: Output of the Microsoft-Win32-Content-Prep-Tool command. And a new file Install-ConfigMgrClientCMG.intunewin in C:\\Source\\Installers ready to be uploaded to Microsoft Intune. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:4:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#using-the-intunewinapputil"},{"categories":["ConfigMgr"],"content":" 5 Client DeploymentThe rest of the deployment process happens over in Microsoft Intune so throw yourself over to Windows Apps blade, as we‚Äôll need to create two new Win32 apps for each of our authentication methods, uploading the same .intunewin file for both apps. Both applications will have similar App Information, so feel free to amend the wording in this section. App Info section in Microsoft Intune for the Win32app. Info I haven‚Äôt bothered configuring an app logo, as Microsoft don‚Äôt üëÄ. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:5:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-deployment"},{"categories":["ConfigMgr"],"content":" 5.1 PKI Authentication ApplicationWhen configuring the PKI authentication application, our installation command and requirements need to reflect this authentication type, so for our install command we need something like the below: PowerShell \"%systemroot%\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoProfile -ExecutionPolicy Bypass -File Install-ConfigMgrClientCMG.ps1 -PKI -ccmSiteCode \"ENB\" -ccmMP \"https://configmgrmp.ennbee.local\" -cmgAddress \"CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\" The uninstall command is just removing the .tag file we create during the installation script: cmd cmd.exe /c del %ProgramData%\\Microsoft\\CCMCMGInstall\\Install-ConfigMgrClientCMG.ps1.tag Program section in Microsoft Intune for the Win32app for PKI authentication. Info Make sure you update the installation time and the installation context otherwise you‚Äôll be in for a bad time. As we‚Äôve taken the time to write a custom requirement rule, we need to add this to the standard requirements section, uploading the script for PKI authentication we created and modified previously, and updating the output data type to String and expected value of Ready accordingly. Requirements section in Microsoft Intune for the Win32app for PKI authentication. Moving on to the next page in the process, we need to create our Detection rule using the .tag file that gets created during the installation. So go and add a new detection rule using the File option, with the path to the file being %ProgramData%\\Microsoft\\CCMCMGInstall and checking if the Install-ConfigMgrClientCMG.ps1.tag file exists: Detection Rule section in Microsoft Intune for the Win32app for PKI authentication. We can skip to the end of the process, as we have no further settings to configure, and I‚Äôd suggest assigning this on a small Proof-of-Concept group as part of testing, prior to just launching it to your entire device estate. PKI authentication done, what about the Entra authentication? ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:5:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#pki-authentication-application"},{"categories":["ConfigMgr"],"content":" 5.2 Entra Authentication ApplicationThis process is going to look very familiar, but there some key differences, but the start is the same so go create a new Windows app (Win32) in Microsoft Intune, complete the App information page with the information needed after uploading the .intunewin file again. For the Program page, we need to amend our install command to the below passing in the required parameters we covered earlier: PowerShell \"%systemroot%\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe\" -NoProfile -ExecutionPolicy Bypass -File Install-ConfigMgrClientCMG.ps1 -ccmSiteCode \"ENB\" -ccmMP \"https://configmgrmp.ennbee.local\" -cmgAddress \"CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\" -tenantId \"daf4a1c2-3a0c-401b-966f-0b855d3abd1a\" -clientAppId \"7506ee10-f7ec-415a-b415-cd3d58790d97\" -clientAppURL \"https://localhost\" The uninstall command remains the same however: cmd cmd.exe /c del %ProgramData%\\Microsoft\\CCMCMGInstall\\Install-ConfigMgrClientCMG.ps1.tag Program section in Microsoft Intune for the Win32app for Entra authentication. As with the PKI authentication configuration we need to add our Entra requirement script, updating the output data type to String and value of Ready. Requirements section in Microsoft Intune for the Win32app for Entra authentication. Same as with PKI authentication we need to create our Detection rule using the very same .tag file. Detection Rule section in Microsoft Intune for the Win32app for Entra authentication. Click Click Next OK-ing our way to the end, we now have both applications ready to be deployed to our orphaned Configuration Manager client devices. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:5:2","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#entra-authentication-application"},{"categories":["ConfigMgr"],"content":" 6 Client InstallationIf you really want to double-down on getting this issue resolved, you can deploy both apps with the differing installation commands and requirements to the same Entra ID group, then regardless of whether they‚Äôve got a valid certificate or they‚Äôre Entra joined, they‚Äôll give the Configuration Manager client installation a good go. As the detection method is the same for both apps, you‚Äôre not going to impact devices that have already run one or the other app. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:6:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-installation"},{"categories":["ConfigMgr"],"content":" 6.1 Microsoft Intune ReportingGiving Microsoft Intune a little while to catch up with the deployments, we should start seeing devices report back their installation status, and show any devices that are not meeting the requirements: A device failing the PKI requirements check in Microsoft Intune. Info With the same assignment group being used across both apps, we need to keep an eye out for devices that are failing both requirements checks. As well as devices that are actually reporting as installing the application: App installation overview in Microsoft Intune. This isn‚Äôt the end of the story though, as Microsoft Intune is just telling us whether the client setup files are now on the targeted devices after meeting either the Entra Join or Client Certificate requirements. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:6:1","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#microsoft-intune-reporting"},{"categories":["ConfigMgr"],"content":" 6.2 Client Installation LogsNow we‚Äôve assigned our new app to a group of devices that are no longer communicating with Configuration Manager, we can go and jump on a device targeted by the app, and keep an eye on the ccmsetup.log in C:\\Windows\\ccmsetup. What we‚Äôre looking for here, is the start of the installation passing through the parameters we configured in the PowerShell script we created: The ccmsetup.log log file running the Configuration Manager client installation. You can now trail this log to make sure that the device is authenticating to the Cloud Management Gateway, and await for a final exit code of either 0, successful install or 7, pending restart, with both denote that the client has successfully installed, and communicated to Configuration Manager. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:6:2","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#client-installation-logs"},{"categories":["ConfigMgr"],"content":" 7 SummaryThis one might not have been the most conventional approach to Configuration Manager client installation, but the situation, as strange as it is, forced our hand to think of a non-standard way to push out the Configuration Manager client to these orphaned Windows devices to allow them to successfully phone home to the Configuration Manager Management Points using the Cloud Management Gateway without physically getting our hands on them. At least with this method, and not just blindly pushing out the client without the requirements and installation arguments, means that devices are only going to start chatting to the Cloud Management Gateway when they can actually authenticate to it, regardless of which authentication method you‚Äôre using in your environment. The status of your clients can be monitored in Configuration Manager Cloud management dashboard, as the app we pushed will start the ccmsetup process, authenticate to the Cloud Management Gateway, allowing them to check back in with Configuration Manager. ","date":"2 September 2024","objectID":"/posts/configmgr-client-install-cmg/:7:0","series":null,"tags":["intune","windows","powershell","apps","co-management"],"title":"Installing the Configuration Manager Client on Orphaned Internet Devices","uri":"/posts/configmgr-client-install-cmg/#summary"},{"categories":["windows"],"content":"Updating the Center for Internet Security (CIS) benchmark build kit for Windows 11 in Microsoft Intune for Level 2 settings.","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/"},{"categories":["windows"],"content":"This is the final part in this series, covering the final boss CIS Level 2 settings; I‚Äôve brought back Jonathan to share the pain again. After the weeks reviewing and working on the benchmark, we can both happily say that we‚Äôre very glad to not have to look at CIS benchmarks for a while‚Ä¶until they release a new one for you know iOS 18 or something (foreshadowing). The settings in the CIS Level 2 benchmark are for the hardcore security fans out there, high security environments, or for when you just plain hate your end-users and just want to stop them from using their Windows 11 devices in normal ways. Let‚Äôs start on a positive note though, and look into some of the settings in the CIS build kit that just weren‚Äôt put together with logical though processes. Note As Custom Profile settings are on their way out (see Message Centre MC822716 and this post by Daniel Bradley) this post has been updated, along with the exported profiles, to use Settings Catalog profiles. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:0:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#"},{"categories":["windows"],"content":" 1 CIS Level 2 IssuesRemember that the CIS Level 2 settings on their own aren‚Äôt particularly useful without their BitLocker and Level 1 counterparts, issues or otherwise üòÑ. All CIS profiles in Microsoft Intune. So make sure you have a good understanding of the impact of these levels by looking at all posts in this series. For now though, let‚Äôs continue into CIS Level 2 build kit profiles and work out where the issues sit. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:1:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#cis-level-2-issues"},{"categories":["windows"],"content":" 1.1 Windows Enterprise EditionBefore we even look at the problems enabling the DisableStoreOriginatedApps setting will cause, it‚Äôs worth mentioning that this setting is a Windows Enterprise/Education edition only configuration: PolicyCSP Edition settings for DisableStoreOriginatedApps So exactly like the previous post, a quick PowerShell script would allow us to configure the registry equivalent setting. Windows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\WindowsStore. Sadly though, this is a true Windows Enterprise/Education setting and will do absolutely nothing on any other Windows edition, so there‚Äôs no point in building a PowerShell script to apply the registry setting to our Windows Professional or otherwise devices. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:1:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#windows-enterprise-edition"},{"categories":["windows"],"content":" 1.2 User SettingsWe‚Äôve seen this previously so for the sake of completeness we should also break out the user specific settings into their own profiles, and assign these to users and not devices. User Only settings not applying to the device context in Microsoft Intune. CIS (L2) Administrative Templates (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e Windows Media Player \u003e Playback Prevent Codec Download (User) Enabled Administrative Templates \u003e System \u003e Internet Communication Management \u003e Internet Communication settings Turn off Help Experience Improvement Program (User) Enabled More user only settings. CIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Windows Spotlight (User) Block Info The amended profiles and the new user based profiles, CIS (L2) Administrative Templates (User) - Windows 11 Intune 3.0.1 and CIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 are available for you to import into Microsoft Intune. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:1:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#user-settings"},{"categories":["windows"],"content":" 1.3 Miscellaneous SettingsAs with CIS Level 1, there are were some settings they couldn‚Äôt shoehorn into a Settings Catalog policy, leaving us to create a new Custom Profile picking up the pieces allowing us now to create a Settings Catalog policies with the previously miscellaneous Custom profiles settings. CIS (L2) Level 2 Misc - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Allow Shared User App Data Block Notifications Disallow Cloud Notification Allow System Allow Location Force Location Off. System Disable Enterprise Auth Proxy Enable Info You can now import the CIS (L2) Level 2 Misc - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of having to use a Custom profile. For reference the custom profiles contained the below settings: Name OMA-URI Data Type Value AllowSharedUserAppData ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/AllowSharedUserAppData Integer 0 DisableEnterpriseAuthProxy ./Device/Vendor/MSFT/Policy/Config/System/DisableEnterpriseAuthProxy Integer 1 AllowLocation ./Device/Vendor/MSFT/Policy/Config/System/AllowLocation Integer 0 DisallowCloudNotification ./Device/Vendor/MSFT/Policy/Config/Notifications/DisallowCloudNotification Integer 1 We‚Äôll deal with the impact of these settings later on, for now just be happy we can create them in Microsoft Intune. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:1:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#miscellaneous-settings"},{"categories":["windows"],"content":" 2 CIS Level 2 SettingsNow we‚Äôve covered the missing or at least misconfigured CIS Level 2 settings, let‚Äôs dig into their impact on Windows 11 cloud native devices. CIS Level 2 settings in Microsoft Intune. Starting in no particular order (we lied, it‚Äôs the worst one first). ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#cis-level-2-settings"},{"categories":["windows"],"content":" 2.1 Blocking Store AppsWell this one is a a bit of a kicker, we could deal with some end user experience changes as part of the CIS benchmark, what we can‚Äôt deal with are Microsoft Store apps being disabled entirely. Application Blocked message in Windows 11. CIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Disable Store Originated Apps Enabled This kind of takes the piss mick really, it‚Äôs not just the built-in apps such as Paint, Calculator and the like, but any UWP app that has come from the store originally, including the Company Portal, and any UWP based Microsoft Store app (new) apps you‚Äôve deployed from Microsoft Intune like Mozilla Firefox. Microsoft Intune deployed Store Win32 Apps, such as Adobe Reader, are safe though, which does align with the CIS benchmark documents reasoning: The Store service is a retail outlet built into Windows, primarily for consumer use. In an enterprise managed environment, the IT department should be managing the installation of all applications to reduce the risk of the installation of vulnerable software. Did someone not tell CIS that we are managing the installation of apps, they just happen to be store apps now? Info UWP Store (new) Apps from Microsoft Intune will still get installed on your devices, they just won‚Äôt actually run üò¨. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#blocking-store-apps"},{"categories":["windows"],"content":" 2.2 Blocking App UpdatesIt‚Äôs not enough that the Store originated apps are gone, but also the ability to allow them to update. Disable turns off the launch of all apps from the Microsoft Store that came pre-installed or were downloaded. Apps will not be updated. Your Store will also be disabled. So that leave‚Äôs us with outdated unpatched applications, which doesn‚Äôt make any sense from a security stand point. Even if you can‚Äôt actually use the applications, you‚Äôre stopping them from being updated? Surely this is a bad move CIS? Either way, you can force them to update using a Remediation script, as has been covered before: Keeping Windows Store Apps Updated with Microsoft Intune Now we all love the new Windows Store, especially for deploying applications from Microsoft Intune, but we should find a way to keep these UWP applications up to date without additional license cost. Read more... ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#blocking-app-updates"},{"categories":["windows"],"content":" 2.3 OneDrive SettingsLet‚Äôs say goodbye to OneDrive whilst we‚Äôre at it; the CIS Level 2 settings actively stop OneDrive from being available across all of Windows 11. CIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value System Disable One Drive File Sync Sync disabled. This doesn‚Äôt just block the ability synchronise files locally from OneDrive or SharePoint Online, but removes OneDrive from File Explorer, and any integration into applications as well. Enabling this setting prevents users from accidentally (or intentionally) uploading confidential or sensitive corporate information to the OneDrive cloud service using the Next Generation Sync Client. Where on earth are users meant to upload corporate information if not to OneDrive ffs üßê. No working around this one, leaving your end-users only able to access files in OneDrive from the web, and pretty much breaking any option to utilise known folder move across Windows devices. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#onedrive-settings"},{"categories":["windows"],"content":" 2.4 Cloud SearchMore feature breaking settings inbound, with the below settings stopping users having the ability to search either OneDrive or SharePoint Online content from within the Windows 11 search bar. CIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value Search Allow Cloud Search Not allowed. Do CIS hate Microsoft integrations? Or do they love the Microsoft Edge homepage integration with OneDrive and SharePoint, and are just forcing uses to access this to find their recently worked on documents, or collaborations? Due to privacy concerns, data should never be sent to any third-party since this data could contain sensitive information. Do they realise that these Windows 11 devices are already sharing quite a lot of information with Microsoft, what‚Äôs a few extra documents going to hurt? ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:4","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#cloud-search"},{"categories":["windows"],"content":" 2.5 Remote DesktopIt just keeps getting better. No remote desktop access, even for those users explicitly given permission to remote desktop. CIS (L2) Administrative Templates - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e Remote Desktop Services \u003e Remote Desktop Session Host \u003e Connections Allow users to connect remotely by using Remote Desktop Services Disabled Surely there must be a bit of wriggle room with this one based upon the rationale in the CIS Benchmark document? Any account with the Allow log on through Remote Desktop Services user right can log on to the remote console of the computer. If you do not restrict access to legitimate users who need to log on to the console of the computer, unauthorized users could download and execute malicious code to elevate their privileges. It looks like you might be able to get away with not disabling this, if you‚Äôre controlling the Allow log on through Remote Desktop Services, which we actually are, in the Level 1 profile CIS (L1) User Rights Global - Windows 11 Intune 3.0.1. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:5","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#remote-desktop"},{"categories":["windows"],"content":" 2.6 Locating DevicesYou might not have any interest in using the locate device functionality within Microsoft Intune, to legitimately find lost or stolen Windows devices (and not to be nosey and abuse privileges), but some people do. Locate device failing in Microsoft Intune. Those people should not try and align themselves to CIS Level 2, as one of the key requirements for locating a device, is allowing location services, which after we configured the miscellaneous settings earlier is now disabled. CIS (L2) Level 2 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value AllowLocation ./Device/Vendor/MSFT/Policy/Config/System/AllowLocation Integer 0 Turns out though, if you have a legitimate reason, you might be able to change this setting, and maybe some others‚Ä¶ This setting affects the location feature (e.g. GPS or other location tracking). From a security perspective, it‚Äôs not a good idea to reveal your location to software in most cases, but there are legitimate uses, such as mapping software. However, they should not be used in high security environments. ‚Ä¶and allow location services to find out if your dad really went to get milk your lost and stolen devices. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:6","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#locating-devices"},{"categories":["windows"],"content":" 2.7 Organisational MessagesWhoever is using these in Microsoft Intune, please let us know üòÇ. Either way to use Organisational Messages there are a handful of pre-requisites, specifically Windows Spotlight, which we are now blocking. CIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Windows Spotlight (User) Block So another bit of Microsoft Intune functionality is gone. Next. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:7","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#organisational-messages"},{"categories":["windows"],"content":" 2.8 Windows System ServicesWe‚Äôve seen something like this somewhere before, this time it‚Äôs another whole set of system services up for the chop, with the impact of disabling these services detailed below. CIS (L2) System Services - Windows 11 Intune 3.0.1 Service Name Service Description Impact BTAGService Bluetooth Audio Gateway Service No more Bluetooth headsets or speakers. bthserv Bluetooth Support Service No more Bluetooth devices. MapsBroker Downloaded Maps Manager Makes no difference as Maps is blocked anyways lfsvc Geolocation Service There goes Location services again. lltdsvc Link-Layer Topology Discovery Mapper No network device discovery maps. MSiSCSI Microsoft iSCSI Initiator Service No iSCSI attached devices. PNRPsvc Peer Name Resolution Protocol No chatting to internet devices about their names. p2psvc Peer Networking Grouping Definitely no chatting to internet devices about their names. p2pimsvc Peer Networking Identity Manager Seriously no chatting to internet devices about their names. PNRPAutoReg PNRP Machine Name Publication Service We get it, no chatting to internet devices about their names. Spooler Print Spooler No printing, not even to PDF but you know PrintNightmare was a thing. wercplsupport Problem Reports and Solutions Control Panel Support No reporting issues, shhhhhh your mouth. RasAuto Remote Access Auto Connection Manager No Always On VPN device tunnel connections. SessionEnv Remote Desktop Configuration Just no Remote Desktop access. TermService Remote Desktop LocalServices Still no Remote Desktop access. UmRdpService Remote Desktop LocalServices UserMode Port Redirector More no Remote Desktop Access. RemoteRegistry Remote Registry No Remote Registry access. LanmanServer Server No File or Print sharing. SNMP SNMP Service No SNMP communication. WerSvc Windows Error Reporting Service CIS hates errors. Wecsvc Windows Event Collector Also events. Bet it hates Birthdays as well. WpnService Windows Push Notifications System Service We can assume that Organisation Messages are dead, as the network endpoints are specifically called out. PushToInstall Windows PushToInstall Service Does this kill the deployment of Store Apps from Microsoft Intune? It does not, phew. WinRM Windows Remote Management No remote PowerShell sessions. If after understanding the entire impact of disabling these services, you still want to have to disable them, you can deploy the provided PowerShell script using Microsoft Intune with deployment settings: CIS Level 2 services PowerShell Script in Microsoft Intune. Info The PowerShell Script CIS (L2) System Services - Windows 11 Intune 3.0.1 is available to download and add as a new Platform Script to Microsoft Intune. And following on from the previous improvement, you can deploy a Remediation detection script to devices in scope of CIS Level 2. CIS (L2) System Services - Windows 11 Intune 3.0.1_Detection.ps1 CIS (L2) System Services - Windows 11 Intune 3.0.1_Detection.ps1 $cisServices = @( 'BTAGService', # Bluetooth Audio Gateway Service 'bthserv', # Bluetooth Support Service 'MapsBroker', # Downloaded Maps Manager 'lfsvc', # Geolocation Service 'lltdsvc', # Link-Layer Topology Discovery Mapper 'MSiSCSI', # Microsoft iSCSI Initiator Service 'PNRPsvc', # Peer Name Resolution Protocol 'p2psvc', # Peer Networking Grouping 'p2pimsvc', # Peer Networking Identity Manager 'PNRPAutoReg', # PNRP Machine Name Publication Service 'Spooler', # Print Spooler 'wercplsupport', # Problem Reports and Solutions Control Panel Support 'RasAuto', # Remote Access Auto Connection Manager 'SessionEnv', # Remote Desktop Configuration 'TermService', # Remote Desktop LocalServices 'UmRdpService', # Remote Desktop LocalServices UserMode Port Redirector 'RemoteRegistry', # Remote Registry 'LanmanServer', # Server 'SNMP', # SNMP Service 'WerSvc', # Windows Error Reporting Service 'Wecsvc', # Windows Event Collector 'WpnService', # Windows Push Notifications System Service 'PushToInstall', # Windows PushToIns","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:2:8","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#windows-system-services"},{"categories":["windows"],"content":" 3 SummaryThat‚Äôs it. We are done. What we have realised over the course of this series, is that unless you are required to align to CIS Level 2 settings, don‚Äôt do it. No seriously, unless you really want to limit what features and functionality your end users, and support teams have access to, to allow them to carry out their normal day to day workloads, there is limited value to implement the CIS Level 2 settings just for nish and giggles. Overall though, these CIS benchmarks do provide a baseline for device security on Windows 11, but it isn‚Äôt the complete story, they‚Äôre not a cheat sheet to full device security, they‚Äôre just a component part. Have a go yourself implementing the profiles, and see for yourself exactly where the gaps are, what the actual impact is to your own devices, and try and make sense of all 1040 pages of the CIS Windows 11 Benchmark document üòÖ. ","date":"12 August 2024","objectID":"/posts/windows-cis-patching-gaps-part4/:3:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","settings catalog","remediation","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","uri":"/posts/windows-cis-patching-gaps-part4/#summary"},{"categories":["power automate"],"content":"Configuring Power Automate to monitor your Exchange Online calendar and set an out of office message automatically.","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/"},{"categories":["power automate"],"content":"When I started in my current role, I was asked to ensure that I set a specific Out of Office message in Outlook, letting anyone either internally or externally know that I was working on a Customer engagement and to leave me alone contact someone else if they needed assistance. Now I‚Äôm not one for handling repetitive tasks, or any task tbh, manually, so I opened up the trusty free friend that is Microsoft Flow Power Automate in my work/school account, and set about configuring a power automate flow, to set this automatic reply, automatically. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:0:0","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#"},{"categories":["power automate"],"content":" 1 Creating the FlowWe‚Äôll cut to the chase here, as this isn‚Äôt Microsoft Intune, and although follows a similar Click Click Next OK setup, doesn‚Äôt require as much thought. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:0","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#creating-the-flow"},{"categories":["power automate"],"content":" 1.1 Setting a Calendar Event TriggerTo create a flow and associated trigger go sign in to Power Automate, select Create, then select Automated cloud flow: Creating a new automated cloud flow. Give it a name, and enter in When an upcoming event is starting soon (V3) in the search field for the trigger for the flow to start, and select Create: Adding a trigger to an automated cloud flow. Once created, select the trigger, and if required allow the connection to your Exchange Online calendar, the select the Calendar Id, you can then update the settings for how often to check for events: Updating the trigger settings in the flow. Now we have a trigger that will monitor your Exchange Online calendar for events starting soon. We need to give the Flow some conditions to work with. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:1","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#setting-a-calendar-event-trigger"},{"categories":["power automate"],"content":" 1.2 Setting an Out of Office ConditionAs we only care about calendar events marked as Out of Office, we should add in a Condition. Select the little + sign under the trigger, and select Add add an action (we‚Äôll be doing this a few times, so get familiar with it): Adding an action to the flow trigger. Search for Condition and oddly enough, select Condition in the search results: Adding a Condition action to the flow trigger. Within the value field select the Harry Potter looking lightning bolt , to use data from the trigger above, and search for Show as selecting it, and updating the condition to look like the below: Adding logic into the Condition action for Out of Office events. Which now means that when the trigger looks at events in the calendar, it has a decision to make when an event is marked as Out of Office. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:2","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#setting-an-out-of-office-condition"},{"categories":["power automate"],"content":" 1.3 Setting a Private Status ConditionAs I also like to take time off from work, I thought best we leverage the flow to not only set up an automatic reply when I‚Äôm working with a customer, but also when I am genuinely Out of the Office. To make life easier for myself, I mark actual holidays in my calendar as Private, so we can use this additional flag on the calendar event and add another condition to the flow under the True section of the Condition we created previously. Same as before, select the little + sign under the True option, and select Add add an action searching again for Condition, this time after selecting Harry Potter, search for Sensitivity: Adding logic into the Condition action for Private events. Configure the logic to say that Sensitivity is equal to private, meaning that if the event discovered is both Out of Office and Private do something. Now onto the something. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:3","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#setting-a-private-status-condition"},{"categories":["power automate"],"content":" 1.4 Setting the Out of Office for HolidaysFor our holiday automatic reply, we‚Äôre working under the True section of the condition, select Add an action again, this time search for Set up automatic replies (V2): Adding an automatic reply under the True condition. You will now be presented with a raft of options, select Show all to bring up all the setting we need to configure to set your Out of Office message, and using the Harry Potter option for each, add in the settings in the table: Item Value Status Scheduled External Audience All Start Time DateTime Start time Start Time TimeZone Time zone End Time DateTime End time End Time TimeZone Time zone With the above settings looking like the below: Configuring automatic reply settings under the True condition. This will configure the Automatic Reply to start based on the start time of the event, and end when the event ends. We‚Äôre not done quite yet, as we need to add in a message to send to people inside the organisation, and outside. Luckily the message supports HTML, so you make it look pretty, or you can just plonk in some basic information: Item Value Internal Reply Message I am currently sunning myself and have turned off my work emails, good luck have fun. External Reply Message I am currently out of the office and will not be able to respond to your email until my return. Looking like the below in the flow: Configuring automatic reply messages under the True condition. That‚Äôs our holiday message sorted, how about we finish this off and get the other message sorted for when we‚Äôre actually doing some work but cba answering emails are unavailable. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:4","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#setting-the-out-of-office-for-holidays"},{"categories":["power automate"],"content":" 1.5 Setting the Out of Office for EngagementsWith our customer engagement automatic reply, we‚Äôre working under the False section of the same condition, but still adding a new action by selecting Add an action again, searching for Set up automatic replies (V2). Fill in the same settings as we did for the holiday message, but this time we should have a different reply message, as you know, we‚Äôre still able to respond to emails, just not quickly: Configuring automatic reply settings under the True condition. Adding in a suitable but more professional message to both internal and external recipients: Configuring automatic reply messages under the False condition. That‚Äôs it, you‚Äôre done. The whole flow should look something like the below, and obviously you can rename things to make like easier. Overview of the entire Flow. Don‚Äôt forget to Save your flow, and now it will happily work in the background setting Out of Office messages on your behalf. ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:1:5","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#setting-the-out-of-office-for-engagements"},{"categories":["power automate"],"content":" 2 SummaryNot sure what to say here, this is well off topic from my usual content, but I was asked many times by people how I‚Äôve set this up, so here it is. Go play around in Power Automate, but don‚Äôt come back to me if you‚Äôre having issues, unless it‚Äôs with something in Microsoft Intune ","date":"26 July 2024","objectID":"/posts/powerautomate-out-of-office/:2:0","series":null,"tags":["automation"],"title":"Automatically Setting an Out of Office Message with Power Automate","uri":"/posts/powerautomate-out-of-office/#summary"},{"categories":["Intune"],"content":"Microsoft Intune mdm firewall rule policies in Endpoint Security automatically converting to the new Settings Catalog profiles using the Firewall Migration Tool.","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/"},{"categories":["Intune"],"content":"What do you do when someone reaches out on GitHub about one of your scripts no longer working as expected? Well it‚Äôs obvious that you just assume that they‚Äôre doing something wrong‚Ä¶ ‚Ä¶what if they‚Äôre not wrong though? What if the script you created to convert the old style of Firewall Rule policies created using the now defunct migration tool doesn‚Äôt work because the rules it created are now Settings Catalog policies, ruining not just a good PowerShell script, but a blog post whilst it‚Äôs at it? Modernising Microsoft Intune Firewall Rule Policies If you've ever experienced the joys of migrating Group Policy and in particular Windows Defender Firewall rules away from Group Policy to Microsoft Intune, you've probably encountered the Rule Migration Tool, and for now this tool has worked well. So what's the catch? Read more... Well you write a blog post about it‚Ä¶duh. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:0:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#"},{"categories":["Intune"],"content":" 1 The ToolFirst off, let‚Äôs look at the Migration Tool which I‚Äôm pretty sure we‚Äôve all used in our time allowing the automatic creation of Firewall Rule policies, taking existing Group Policy applied rules from a target device and punting them straight into Microsoft Intune. Oh it‚Äôs gone. Well Microsoft you are correct, the old version of the tool did create the old mdm Endpoint Security Profiles, and it did use the old authentication method, but it also did work. If you‚Äôre sensible nice enough to follow me on LinkedIn you might have spotted that as a favour to a stranger (not the first time mind you), I updated the migration tool to support the new authentication method, and a couple of other bits as well. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:1:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#the-tool"},{"categories":["Intune"],"content":" 2 The ScriptI‚Äôm not using this post to break down exactly how I fixed updated the PowerShell script in the short term, but in summary I‚Ä¶ Removed the reliance on the Microsoft GitHub repo to download content. Changed authentication to use the Microsoft.Graph PowerShell module. Changed the web requests to use Invoke-MgGraphRequest for calls to Graph. Forced the PowerShell script to create Endpoint Security templates for firewall rule policies instead of Configuration Profiles. Changed the Authentication to Graph to use device authentication as I‚Äôm a dirty macOS user. Disabled sending any telemetry data on success and failure of rule creation to Microsoft, as they have too much data on me already. Fixed an issue when checking for profile name matching when there are no existing firewall rule policies in Microsoft Intune. To use the script itself, you: Download the FirewallRuleMigration.zip file and extract on your Windows device. Open PowerShell as Administrator. Navigate to the extracted folder, your PowerShell prompt should be in the FirewallRuleMigration folder. Run Set-ExecutionPolicy Bypass accepting all prompts like a good little child. Run ./Export-FirewallRules.ps1 with the corresponding switches (includeDisabledRules, includeLocalRules) if required. Authenticate to Graph using a Global Admin account, twice*. Enter a new profile name for the Firewall rules policy when prompted. Wait for rules to be uploaded to Microsoft Intune. *The script will disconnect all existing Graph sessions, and connect twice; once to allow for consent to be provided, the following to allow the script to run following the consent request. So with this new script in hand, you can still migrate your Group Policy applied Firewall rules to Microsoft Intune, nice eh? ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:2:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#the-script"},{"categories":["Intune"],"content":" 3 Firewall Rules 2: The ConversioningWhat I did not expect when running the PowerShell script, and after it created the Firewall Rule policies in Microsoft Intune, were them to just change. What I expected, is that I‚Äôd have to use my old script to actually convert them from the old versions‚Ä¶ Firewall Rule Policies created using the Migration Tool. ‚Ä¶and not just wait ten minutes for them to transition to new rules. Firewall Rule Policies converted using Microsoft secret sauce. So wtf is happening? No clue. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:3:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#firewall-rules-2-the-conversioning"},{"categories":["Intune"],"content":" 4 Are Microsoft Magicians?Yes. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:4:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#are-microsoft-magicians"},{"categories":["Intune"],"content":" 5 The TrutheningThe original Firewall Rule policies created by my wonderful PowerShell script are still using the legacy templates in Microsoft Intune: Firewall Rule Policies the old worse way of dealing with them. And to prove I didn‚Äôt spend my evening somehow manually creating 150 firewall rules in a way you can no longer create them, you can see the audit log showing that the policies were created at the timestamp: Definitely real and not made up Microsoft Intune audit log. But oh what have we found here with our super secret snooping skills? Clicking on one of the items that were created by the PowerShell script, we get a bit more detail: Still a real and not made up Microsoft Intune audit log but with more detail. But what‚Äôs this at the bottom of the entry: OMG it's migrating. Zoom and enhance. Yeah this means nothing. The audit log is showing that a new legacy Firewall Rule policy is being created, how do we know? Well it‚Äôs still using the old Endpoint Security templateId value of 4356d05c-a4ab-4a07-9ece-739f7c792910. Another screenshot of some audit stuff. Running a quick Graph Explorer GET request to: txt https://graph.microsoft.com/beta/deviceManagement/templates?`$filter=(isof(%27microsoft.graph.securityBaselineTemplate%27)) and you‚Äôll see all the Endpoint Security Templates, and specifically this one: JSON { \"@odata.type\": \"#microsoft.graph.securityBaselineTemplate\", \"id\": \"4356d05c-a4ab-4a07-9ece-739f7c792910\", \"displayName\": \"Windows Firewall rules\", \"description\": \"Windows Firewall allows administrators to define granular Firewall rules. Define firewall rules with specific ports, protocols, applications and networks, to allow or block network traffic.\", \"versionInfo\": \"2006\", \"isDeprecated\": false, \"intentCount\": 2, \"templateType\": \"securityTemplate\", \"platformType\": \"windows10AndLater\", \"templateSubtype\": \"firewall\", \"publishedDateTime\": \"2020-03-11T00:00:00Z\" } Either way Microsoft is doing some wizardry behind the scenes not available to see with the naked eye. So go check your own Firewall Rule policies, I bet they‚Äôll be the new Settings Catalog ones. I‚Äôll wait (hint, I won‚Äôt). Or if you like, use the PowerShell script to create some new old ones, then just wait a little bit and see them evolve into Settings Catalog policies. Who‚Äôs that Pok√©mon Firewall Rule policy? It‚Äôs a Settings Catalog policy for Firewall Rules! Firewall Rule Policies the new much better way of dealing with them. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:5:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#the-truthening"},{"categories":["Intune"],"content":" 6 SummaryHonestly, not sure what you want from me here; there might have been a communication about this in the What‚Äôs new in Intune, maybe a blog post, maybe not. Either way you‚Äôve got a new version of the Migration Tool script, a bit of background on how it works, and a dive into the world of things that just happen without us knowing in Microsoft Intune land. Off you jog now. ","date":"22 July 2024","objectID":"/posts/firewall-rule-policy-conversion/:6:0","series":null,"tags":["windows","settings catalog","security","firewall","endpoint security","powershell"],"title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","uri":"/posts/firewall-rule-policy-conversion/#summary"},{"categories":["windows"],"content":"Updating the Center for Internet Security (CIS) benchmark build kit for Windows 11 in Microsoft Intune for level 1 security settings.","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/"},{"categories":["windows"],"content":"With the investigation into the impact of the CIS benchmark on BitLocker and Windows Autopilot now a fond and distant memory, it‚Äôs time for me to stand Jonathan down (it was his Birthday after all, and he has his own content to create), pull up my sleeves, and get to testing the CIS Level 1 settings across the full Windows 11 operating system itself. This decision to go it alone, had absolutely nothing to do with me already knowing that there were more missing settings in the benchmark build kit than settings that actually break Windows 11, I promise ü§´. So what is the CIS Level 1 benchmark missing? Note As Custom Profile settings are on their way out (see Message Centre MC822716 and this post by Daniel Bradley) this post has been updated, along with the exported profiles, to use Settings Catalog profiles. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:0:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#"},{"categories":["windows"],"content":" 1 CIS Level 1 IssuesWell probably a few things, but let‚Äôs sadly look at the settings in the CIS Level 1 benchmark that are going to cause some headaches across Windows 11. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:1:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#cis-level-1-issues"},{"categories":["windows"],"content":" 1.1 User Rights AssignmentIt looks like when configuring User Rights in the Microsoft Intune benchmark, CIS ‚Äúdid a Microsoft‚Äù, and forgot that languages other than English are used across the vanilla Windows 11 operating system, just like the initial release of the Security Baseline for Windows 11 23H2 identified by James Robinson: Trying to apply the new 23H2 #Intune Baseline and using a non-English OS? You'll probably break the ability to log into devices because the group names are localised.@IntuneSuppTeam These need changing to the equivalent well-known SID or a lot of devices are gonna go pop. pic.twitter.com/zY7yWfR3yl ‚Äî James Robinson | MVP (@SkipToEndpoint) April 6, 2024 In short, the CIS policy uses english language names, instead of the well-known SIDs across all of the User Rights settings, meaning operating systems in a non-english language will hit some issues, mainly with users actually being able to logon to the device. Microsoft fixed this slight oversight pretty sharpish, however the same can‚Äôt be said for CIS üëÄ. To give you a sample of the User Rights assignment policy, have a look at the below, covering some of the settings and associated account names in english: CIS (L1) User Rights - Windows 11 Intune 3.0.1 Category Setting Value User Rights Access From Network Administrators, Remote Desktop Users User Rights Allow Local Log On Administrators, Users User Rights Create Global Objects Administrators, LOCAL SERVICE, NETWORK SERVICE, SERVICE User Rights Deny Access From Network Guests, Local account User Rights Increase Scheduling Priority Administrators, Window Manager\\Window Manager Group Compared with the below extract of the updated policy, which has been amended to support the use of the SIDs: CIS (L1) User Rights Global - Windows 11 Intune 3.0.1 Category Setting Value User Rights Access From Network *S-1-5-32-544, *S-1-5-32-555 User Rights Allow Local Log On *S-1-5-32-544, *S-1-5-32-545 User Rights Create Global Objects *S-1-5-32-544, *S-1-5-19, *S-1-5-20, *S-1-5-6 User Rights Deny Access From Network *S-1-5-32-546, *S-1-5-113 User Rights Increase Scheduling Priority *S-1-5-32-544, *S-1-5-90-0 If we just applied and trusted CIS here, then it is quite likely that for non-English operating systems, users would not have been able to sign-in to their Windows device. Info You can import the updated version of the CIS (L1) User Rights Global - Windows 11 Intune 3.0.1 profile into your Microsoft Intune tenant instead of manually updating the profile, like we had to üôÉ. Edited‚Ä¶ Note Thanks to Jimmy Winberg in the comments, the areas in the CIS profile that reference a null identifier, have now been updated to use the NULL SID S-1-0-0 to stop errors in the event logs. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:1:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#user-rights-assignment"},{"categories":["windows"],"content":" 1.2 Miscellaneous SettingsThese settings that exist in the benchmark document, can only, as of today, be added into Microsoft Intune using a Custom Profile which should be pretty easy (foreshadowing). Note This setting now exists within Settings Catalog, so we no longer need a Custom Profile. CIS Level 1 Miscellaneous settings document. So we should create a new profile to capture the three CIS Level 1 settings detailed in the document with the below Settings Catalog settings. CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Windows Consumer Features Block Microsoft App Store Block Non Admin User Install Allow Wi-Fi Settings Allow Auto Connect To Wi Fi Sense Hotspots Block Info You can now import the CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of having to use a Custom profile. For reference, the below are the legacy custom profiles settings. Name OMA-URI Data Type Value BlockNonAdminUserInstall ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/BlockNonAdminUserInstall Integer 1 AllowWindowsConsumerFeatures ./Device/Vendor/MSFT/Policy/Config/Experience/AllowWindowsConsumerFeatures Integer 0 AllowAutoConnectToWiFiSenseHotspots ./Device/Vendor/MSFT/Policy/Config/Wifi/AllowAutoConnectToWiFiSenseHotspots Integer 0 Anyone spot a problem? I‚Äôll give you a minute. Now we can‚Äôt blame CIS for the issues their recommended settings cause, as this one fully goes to Microsoft. Devices getting the setting BlockNonAdminUserInstall set to enabled, causes issues with the Photos app on the device for devices running the April 2024 patch. CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value BlockNonAdminUserInstall ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/BlockNonAdminUserInstall Integer 1 We also can‚Äôt blame CIS for both AllowWindowsConsumerFeatures and BlockNonAdminUserInstall failing to apply to devices either, as due to the June 2024 patch devices which should be activated to Windows 11 Enterprise as part of subscription activation, don‚Äôt, leaving devices at their original Windows edition, in this case Windows Pro. CIS Level 1 Miscellaneous setting custom profile assignment error. Meaning that neither AllowWindowsConsumerFeatures and BlockNonAdminUserInstall will apply to non-Enterprise editions of Windows: PolicyCSP Edition settings for BlockNonAdminUserInstall Are there any other settings in the benchmark require specific Windows editions? ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:1:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#miscellaneous-settings"},{"categories":["windows"],"content":" 1.3 Windows Edition RequirementsThe Windows subscription activation issues, and subsequent edition downgrade, highlighted something I hadn‚Äôt considered, just how many settings in the CIS 3.0.1 benchmark for Level 1 actually require an Enterprise or Education editions of Windows, or at least just don‚Äôt work on Pro editions? Well I‚Äôm not going to count them for you (I actually did, it‚Äôs seven). Setting Profile AllowWindowsConsumerFeatures CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 BlockNonAdminUserInstall CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Allow Spotlight Collection (User) CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 Disable Consumer Account State Content CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Require Private Store Only CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Credential Guard CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 Require Platform Security Features CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 If you‚Äôve only got devices running Windows Professional, you can say goodbye to blocking the Windows Consumer Features, or by requiring the Windows Private Store, blocking access to the store itself, or worse, device security settings in Credential Guard and Secure Boot not applying. Settings that require Windows Enterprise editions to apply to a device. So this leaves a bit of a gap in the Level 1 benchmark for these Windows Professional cloud native devices, or does it? Well no, we just can‚Äôt use Microsoft Intune native settings to configure them. What we can do is use our favourite tooling Group Policy, PowerShell, to go and set some corresponding registry settings to ensure we‚Äôre in-line with the benchmark. We can create a PowerShell script to create the six, (yes I said six), registry settings. These exist in the HKLM registry hive, so we can happily update them using a PowerShell and a Platform Script in Microsoft Intune. CIS (L1) Windows Pro Settings - Windows 11 Intune 3.0.1.ps1 CIS (L1) Windows Pro Settings - Windows 11 Intune 3.0.1.ps1 # Windows Pro Device Settings $regSettings = @() $regSettings += [pscustomobject]@{path = 'HKLM:\\Software\\Policies\\Microsoft\\Windows\\CloudContent'; name = 'DisableWindowsConsumerFeatures'; value = '1'; type = 'DWord' } $regSettings += [pscustomobject]@{path = 'HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\CloudContent'; name = 'DisableConsumerAccountStateContent'; value = '1'; type = 'DWord' } $regSettings += [pscustomobject]@{path = 'HKLM:\\Software\\Policies\\Microsoft\\Windows\\Appx'; name = 'BlockNonAdminUserInstall'; value = '1'; type = 'DWord' } $regSettings += [pscustomobject]@{path = 'HKLM:\\Software\\Policies\\Microsoft\\WindowsStore'; name = 'RequirePrivateStoreOnly'; value = '1'; type = 'DWord' } $regSettings += [pscustomobject]@{path = 'HKLM:\\Software\\Policies\\Microsoft\\Windows\\DeviceGuard'; name = 'LsaCfgFlags'; value = '1'; type = 'DWord' } $regSettings += [pscustomobject]@{path = 'HKLM:\\Software\\Policies\\Microsoft\\Windows\\DeviceGuard'; name = 'RequirePlatformSecurityFeatures'; value = '1'; type = 'DWord' } Try { foreach ($regSetting in $regSettings) { if (!(Test-Path $($regSetting.path))){ New-Item -Path $($regSetting.path) -Force } New-ItemProperty -Path $($regSetting.path) -Name $($regSetting.name) -Value $($regSetting.value) -PropertyType $($regSetting.type) -Force } Exit 0 } Catch { Write-Error $_.ErrorDetails Exit 1 } Sadly, the Allow Spotlight Collection setting, only exists in the HKCU part of the registry, and sits under the HKCU:\\Software\\Policies key which standard users don‚Äôt have access to write to. So we don‚Äôt have a way to create this new item using PowerShell and Platform Scripts natively. Note Jonathan has informed me that you could apply the Allow Spotlight Collection setting in HKCU using the PSAppDeployToolkit, specifically the Invoke-HKCURegistrySettingsForAllUsers functionality, so off you trot and do that. The rest of registry entries in CIS (L1) Windows Pro Settings - Win","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:1:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#windows-edition-requirements"},{"categories":["windows"],"content":" 1.4 User SettingsAny other assignment issues you want to throw our way and not document CIS? No? Are you sure? Having reviewed the device assignment states after by default assigning the imported build kit settings to groups of devices in Microsoft Intune, I was left pondering as to why CIS wouldn‚Äôt mention that there are User only settings in each of the profiles. User Only settings not applying to the device context in Microsoft Intune. This isn‚Äôt such a bad thing, as you‚Äôre just going to get a Not Applicable state when assigned to the SYSTEM context of the device, the user on the device will be fine though. However, for good practice assignment, we should split out the user settings from the profiles, and create new ones, allowing a consistent assignment of settings. CIS (L1) Admin Templates - Windows Components (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e Network Sharing Prevent users from sharing files within their profile. (User) Enabled Administrative Templates \u003e Windows Components \u003e Attachment Manager Do not preserve zone information in file attachments (User) Disabled Administrative Templates \u003e Windows Components \u003e Attachment Manager Notify antivirus programs when opening attachments (User) Enabled CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Spotlight Collection (User) 0 Microsoft App Store MSI Always Install With Elevated Privileges (User) Disabled Administrative Templates \u003e Windows Components \u003e Attachment Manager Notify antivirus programs when opening attachments (User) Enabled CIS (L1) Section 1 - 3.9.1.1 (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Start Menu and Taskbar \u003e Notifications Turn off toast notifications on the lock screen (User) Enabled Administrative Templates \u003e Control Panel \u003e Personalization Enable screen saver (User) Enabled Info The amended profiles and the new user based profiles, CIS (L1) Admin Templates - Windows Components (User) - Windows 11 Intune 3.0.1, CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 and CIS (L1) Section 1 - 3.9.1.1 (User) - Windows 11 Intune 3.0.1 are available for you to import, don‚Äôt say I‚Äôm not kind to you all. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:1:4","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#user-settings"},{"categories":["windows"],"content":" 2 CIS Level 1 SettingsNow hopefully we‚Äôre done with settings in the Level 1 benchmark that just don‚Äôt work properly, we can look at settings that are missing, or settings that are just going to annoy your end-users or support teams ü´†. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#cis-level-1-settings"},{"categories":["windows"],"content":" 2.1 Local Administrator Password SolutionOn to recommendations that exist in the Benchmark document but not in the build kit, we can start with Windows LAPS. The Windows LAPS settings don‚Äôt exist in the build kit as it‚Äôs configured under Account Protection in the Endpoint Security section of Microsoft Intune, so I assume CIS just didn‚Äôt include it as there is no native import functionality. Taking the information provided in the benchmark document, we need to cover off everything under section 85 Windows LAPS, as they‚Äôre all CIS Level 1 settings. An excerpt from the CIS 3.0.1 benchmark for Windows LAPS. We can easily create a new Account Protection policy in Microsoft Intune to meet these requirements, with the settings below: CIS (L1) Windows LAPS - Windows 11 Intune 3.0.1 Category Setting Value LAPS Backup Directory Backup the password to Azure AD only LAPS Password Age Days 30 or fewer* LAPS Administrator Account Name Admin LAPS Password Complexity Large letters + small letters + numbers + special characters (improved readability) LAPS Password Length 15 or more* LAPS Post Authentication Actions Reset the password and logoff the managed account (or higher)* LAPS Post Authentication Reset Delay 8 (or fewer hours, but not 0)* *These are the minimum settings to adhere to the CIS benchmark, so amend as you see fit. Info Don‚Äôt forget if you are going to use Windows LAPS, that you enable the feature in Entra ID, and review the requirements to allow you to actually use it on your Windows 11 devices. The CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 CIS policy sets the built-in administrator account name to Admin, so make sure either you update the setting below in the imported policy to match any changes to the LAPS setting, or be happy with what it‚Äôs called: CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Accounts Rename Administrator Account Admin Info We can‚Äôt export a Endpoint Security profile, even if they‚Äôre technically Settings Catalog profiles, so we‚Äôre using the Intune Management tool, allowing you to import the CIS (L1) Windows LAPS - Windows 11 Intune 3.0.1 profile instead of having to create it. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#local-administrator-password-solution"},{"categories":["windows"],"content":" 2.2 Windows Updates and Delivery OptimisationIs it all good in the world of Windows Update for Business settings in the CIS benchmark? Well kind of, if you want all of your devices to install updates every day, with no phasing, and just blindly update to the latest Feature Update after 180 days. CIS (L1) Windows Update - Windows 11 Intune 3.0.1 Category Setting Value Windows Update For Business Defer Feature Updates Period In Days 180 Windows Update For Business Defer Quality Updates Period (Days) 0 Windows Update For Business Scheduled Install Day Every day It‚Äôs not like there‚Äôs even much room for manoeuvre; the Feature Update deferral is a minimum of 180 days, so you could phase the delivery of Feature Updates at least, but the Quality Update deferral can only be zero days, so out goes the window for any kind of phasing. Maybe CIS has more faith in Windows Updates not breaking devices than others ü´¢. At least there‚Äôs a setting in the build kit for Delivery Optimisation, so all our devices installing Quality and Feature updates at the same time don‚Äôt smash the WAN connection to bits‚Ä¶ CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Delivery Optimization DO Download Mode HTTP only, no peering Oh. It‚Äôs OK, we can have any of the settings available to us in Microsoft Intune, just not HTTP blended with Internet peering. Section 22.1 (L1) Ensure 'DO Download Mode' is NOT set to 'HTTP blended with Internet Peering'. Just goes to show that you do really need to read the associated CIS Benchmark document along with using the build kit, or just take the word of someone on the internet that things work üò¨. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#windows-updates-and-delivery-optimisation"},{"categories":["windows"],"content":" 2.3 Microsoft StoreAs mentioned previously, having a Microsoft Intune setting to Require Private Store Only is only a Windows Enterprise edition feature, however we sorted that with the PowerShell script, so now that the setting is applying to all devices correctly, it blocks the store. CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Require Private Store Only Only Private store is enabled. As there isn‚Äôt such as thing as a Private Store now the the Microsoft Store for Business has been retired (has it?), then the outcome of the setting above just blocks access to the store. The Microsoft Store blocked by the Require Private Store setting in Microsoft Intune. In the same profile though at least the store apps are being kept up to date: CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Allow apps from the Microsoft app store to auto update Allowed. But with no way easy way to check that apps are actually being updated, you‚Äôd better look at another option to ensure the built-in apps are kept up to date üòâ. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#microsoft-store"},{"categories":["windows"],"content":" 2.4 Windows DefenderYou‚Äôd think there‚Äôd be nothing majorly wrong with the Windows Defender settings in the build kit, or the benchmark document itself, and on first glance all looks well apart from the lack of any kind remediations to quarantine or delete detected threats. You might not be using Windows Defender as your primary antivirus solution, so CIS not assuming you are is a good thing. But based on this, CIS wouldn‚Äôt include anything in the imported profiles that does require Windows Defender to be acting a as primary solution and/or in active mode though? CIS (L1) Defender - Windows 11 Intune 3.0.1 Category Setting Value Defender Block executable content from email client and webmail Block Defender Block Office applications from injecting code into other processes Block Defender Block Office applications from creating executable content Block Defender Block abuse of exploited vulnerable signed drivers (Device) Block Defender Block persistence through WMI event subscription Block Defender Block untrusted and unsigned processes that run from USB Block Defender Block JavaScript or VBScript from launching downloaded executable content Block Defender Block credential stealing from the Windows local security authority subsystem Block Defender Block Adobe Reader from creating child processes Block Defender Block all Office applications from creating child processes Block Defender Block Office communication application from creating child processes Block Defender Block Win32 API calls from Office macros Block Defender Block execution of potentially obfuscated scripts Block Ah, 13 Attack Surface Reduction Rules, and all in block mode , not an audit setting in sight. Brilliant. So even if you do meet the dependencies below for the ASR rules to actually apply, they‚Äôre all going to straight up block everything they find that matches the rules. Microsoft Defender Antivirus must be enabled and configured as primary anti-virus solution, and must be in the following mode: Primary antivirus/antimalware solution State: Active mode Which is another good reason to actually check to see what these build kit profiles are configuring, without blindly applying them to you device estate and being all surprised when stuff stops working. ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:4","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#windows-defender"},{"categories":["windows"],"content":" 2.5 Windows System ServicesCIS provide a PowerShell script as part of the Level 1 benchmark to disable some scary looking Windows System Services, specifically the below (even if the Xbox ones are already disabled by CIS (L1) System Services - Windows 11 Intune 3.0.1). The table below details the apparent effect of disabling these services. Service Name Service Description Impact Browser Computer Browser No more discovery of network devices. IISADMIN IIS Admin Service No SMTP or FTP configuration in IIS. irmon Infrared monitor service No transfer of data using Infrared. SharedAccess Internet Connection Sharing No sharing of network connections, bye bye Hyper-V bridging. LxssManager LxssManager Bye bye Windows Subsystem for Linux. FTPSVC Microsoft FTP Service Clearly no more FTP servers. sshd OpenSSH SSH Server Same as above but SSH servers. RpcLocator Remote Procedure Call (RPC) Locator Nowt, legacy service. RemoteAccess Routing and Remote Access As on the tin, used for RRAS servers. simptcp Simple TCP/IP LocalServices$LocalServices Apparently has little use in modern environments, and is an optional Windows feature. sacsvr Special Administration Console Helper Remote command prompt used as part of Windows Emergency Management Services and Serial Console. SSDPSRV SSDP Discovery UPnP device discovery is now dead. upnphost UPnP Device Host UPnP device discovery is still dead. WMSvc Web Management Service No more management of local web servers. WMPNetworkSvc Windows Media Player Network Sharing Service No media sharing from Windows Media Player. icssvc Windows Mobile Hotspot Service No creation of Mobile hotspots. W3SVC World Wide Web Publishing Service No more local web servers. XboxGipSvc Xbox Accessory Management Service No playing games. XblAuthManager Xbox Live Auth Manager No logging into games. XblGameSave Xbox Live Game Save No saving games. XboxNetApiSvc Xbox Live Networking Service No games. So happy with all the functionality that is being prevented, we can deploy the provided script using Microsoft Intune Platform Scripts with deployment settings looking something like this: CIS Level 1 services PowerShell Script in Microsoft Intune. Info The PowerShell Script CIS (L1) System Services - Windows 11 Intune 3.0.1 is available to download and add as a new Platform Script to Microsoft Intune. Now this is all well and good for disabling the services, once, but what happens if someone manages to enable them after the script has run, now what? Well Remediations that‚Äôs what. A quick modification to the existing script, to use some logic round how many of the services are not currently disabled, passing this back to Microsoft Intune as part of a detection script: CIS (L1) System Services - Windows 11 Intune 3.0.1_Detection.ps1 CIS (L1) System Services - Windows 11 Intune 3.0.1_Detection.ps1 $cisServices = @( 'Browser', # Computer Browser 'IISADMIN', # IIS Admin Service 'irmon', # Infrared monitor service 'SharedAccess', # Internet Connection Sharing 'LxssManager', # LxssManager 'FTPSVC', # Microsoft FTP Service 'sshd', # OpenSSH SSH Server 'RpcLocator', # Remote Procedure Call (RPC) Locator 'RemoteAccess', # Routing and Remote Access 'simptcp', # Simple TCP/IP LocalServices$LocalServices 'sacsvr', # Special Administration Console Helper 'SSDPSRV', # SSDP Discovery 'upnphost', # UPnP Device Host 'WMSvc', # Web Management Service 'WMPNetworkSvc', # Windows Media Player Network Sharing Service 'icssvc', # Windows Mobile Hotspot Service 'W3SVC', # World Wide Web Publishing Service 'XboxGipSvc', # Xbox Accessory Management Service 'XblAuthManager', # Xbox Live Auth Manager 'XblGameSave', # Xbox Live Game Save 'XboxNetApiSvc' # Xbox Live Networking Service ) # Get current state on the services in the array above. $localServices = Get-Service -Name $cisServices -ErrorAction SilentlyContinue $notDisabled = 0 foreach ($cisService in $cisServices) { # Make sure service name in the list matches with local system services. # Added becaus","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:2:5","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#windows-system-services"},{"categories":["windows"],"content":" 3 SummaryWhat I‚Äôve learnt looking over the CIS Level 1 settings, is that there are some pretty large gaps in the build kit; settings that just don‚Äôt exist such as with Windows LAPS, settings that only apply to users and not devices, settings that only apply to specific editions of Windows, minimum settings that will cause unexpected behaviour, and some normal good practice settings for security solutions such as Windows Defender that are just plain missing. This does mean though, that applying a CIS benchmark is only part of the story when it comes to securing your Windows 11 cloud native devices, and it‚Äôs worth looking into other Security Baselines (cough Microsoft cough) to help harden not only the operating system, but applications that reside on top. Next up is the final part in the series, the dreaded CIS Level 2 settings, surely it can‚Äôt get any worse? ","date":"15 July 2024","objectID":"/posts/windows-cis-patching-gaps-part3/:3:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","endpoint security","remediation","powershell","settings catalog","custom profiles"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","uri":"/posts/windows-cis-patching-gaps-part3/#summary"},{"categories":["windows"],"content":"Using Microsoft Intune to rename Autopilot Device Preparation devices, or Autopilot v2 devices in three different ways.","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/"},{"categories":["windows"],"content":"We‚Äôre no stranger to renaming Windows Autopilot devices having looked at this with Hybrid joined devices not once, but twice, to allow people to be happier with the names of their corporate owned devices, and not the random nature Windows Autopilot Hybrid Join deployments gives them. So what gives, why am I looking at this again? Yeah, it‚Äôs Windows Autopilot v2, (honestly I hope that name doesn‚Äôt stick), and after looking at the post Gannon Novak put together around the subject, I thought to myself, ‚ÄúI wonder if there are other ways to achieve this?‚Äù. Guess what? There are. ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:0:0","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#"},{"categories":["windows"],"content":" 1 Renaming DevicesI‚Äôll be frank, this method is misaligned to good practice (which is nice way of saying, ‚Äújanky‚Äù), but until there is a way to do this in Microsoft Intune within the device preparation policy itself, and you still care about naming your devices and not just leaving users to decide their device names on Windows Pro devices at least‚Ä¶ Windows Autopilot Device Name prompt. ‚Ä¶this is all you‚Äôve got. ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:1:0","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#renaming-devices"},{"categories":["windows"],"content":" 1.1 Custom ProfilesAh shh, here we go again, digging around in the Policy CSP to try and find something to allow for a device rename. There are a couple of settings detailed in the Policy CSP that support device naming, or device renaming, both DNSComputerName and ComputerName. As we‚Äôre only dealing with Windows 11 devices due to the requirements for Windows Autopilot Device Preparation, we‚Äôll stick with DNSComputerName due to the note with ComputerName: For desktop PCs on Windows 10, version 2004 or later, use the Ext/Microsoft/DNSComputerName node in DevDetail CSP. Taking stock of the provided DNSComputerName documentation, when configuring a device name, we should utilise one of the suggested variables: We recommend using %SERIAL% or %RAND:x% with a high character limit to reduce the chance of name collision when generating a random name. This feature doesn‚Äôt check if a particular name is already present in the environment. So when configuring our device name, we can utilise a prefix and a variable such as ENB-%SERIAL% to hope there are no device name clashes: Setting the device name using DNSComputerName in Microsoft Intune. We can create a new Custom Profile in Microsoft Intune with the below setting, allowing for the device to have a more suitable name: Windows Autopilot v2 - Device Rename Name OMA-URI Data Type Value DNSComputerName ./DevDetail/Ext/Microsoft/DNSComputerName String ENB-%SERIAL% Device named, how do we make it stick, and by this, I mean how do we force a restart? ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:1:1","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#custom-profiles"},{"categories":["windows"],"content":" 1.2 Forcing the RestartWell we can cheat, well we use the fact that there are some known issues with specific Security settings and their impact to Windows Autopilot causing device restarts, which we have looked at before. Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot With the CIS BitLocker and associated DMA settings reviewed and updated, now is time to delve into the Windows 11 specific settings that exist in the CIS Level 1 benchmark. What issues do they bring to Windows Autopilot, what solutions can we find? Honestly, who knows. Read more... So picking at least one of the settings from the Policy CSP for Device Guard, (which you should be applying to your Windows 11 devices anyway), we can look to force a restart as part of the application of the Custom Profile containing our device name settings: Windows Autopilot v2 - Device Rename Name OMA-URI Data Type Value DNSComputerName ./DevDetail/Ext/Microsoft/DNSComputerName String ENB-%SERIAL% EnableVirtualizationBasedSecurity ./Device/Vendor/MSFT/Policy/Config/DeviceGuard/EnableVirtualizationBasedSecurity Integer 1 Info I picked EnableVirtualizationBasedSecurity but you can select any in the document, they all cause some type of restart during OOBE. Making sure to assign this new profile to the same group of devices used in your APDP (is this really any better than APv2?) policy: Windows Autopilot Device Preparation Policy device group assignment. If you like screenshots of Microsoft Intune, here‚Äôs another one for you, this time of the Custom Profile: Windows Autopilot Device Preparation rename policy assignment. ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:1:2","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#forcing-the-restart"},{"categories":["windows"],"content":" 1.3 Renaming in ActionYou can see this rename process in action, and the device restart, following all the other OOBE gumph which I‚Äôve kindly sped up: Although the device itself is now happily renamed, Microsoft Intune is being a little whinge about the assignment of the profile: Profile assignment errors in Microsoft Intune for DNSComputerName. Yeah, errors, and not ones we can do anything about either, but at least the device got renamed right? Nowt to complain about here. Jog on. ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:1:3","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#renaming-in-action"},{"categories":["windows"],"content":" 2 SummaryThere you have it, another way to rename shiny new APDP devices (stop trying to make ‚ÄúAPDP‚Äù happen), but honestly, I‚Äôm almost done caring about device names at this point. The whole Autopilot Deployment Device Preparation process is user centric, what exactly are you using device names for? Applying settings to specific dynamic security groups based on device name? I mean this is a bad idea right, firstly APDP (I‚Äôm still trying, leave me alone.) hands you a group of devices which you can use, secondly, if you‚Äôre applying settings to devices based on something trivial like the device name, what‚Äôs stopping an Administrative user changing the device name and circumventing your policies? Literally nothing. So instead of complaining that there are missing features with APDP (last time I promise), like renaming devices, or lack of other deployment methods, or that it takes longer than normal, or there‚Äôs more user interaction, can we just all move on and find other better ways of grouping devices, you know like with Device Filters and User assignments. ","date":"2 July 2024","objectID":"/posts/windows-autopilot-v2-renaming/:2:0","series":null,"tags":["windows autopilot","windows autopilot v2","custom profiles"],"title":"Renaming Windows Autopilot v2 Devices","uri":"/posts/windows-autopilot-v2-renaming/#summary"},{"categories":["windows"],"content":"Updating the Center for Internet Security (CIS) benchmark build kit for Windows 11 Autopilot in Microsoft Intune for level 1 security settings.","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/"},{"categories":["windows"],"content":"We started with the BitLocker and DMA (Direct Memory Access) settings in the first post in this Windows 11 CIS benchmark based series, now is the time we dig deeper into the broader Level 1 settings, this time looking at the impact to Windows Autopilot cloud native deployments. Jonathan has more than enough experience with testing these policies and the impact to Windows Autopilot, as I made asked him to help me review the impact of them following his initial run in with the community version of the CIS Microsoft Intune templates. So please send him your thanks, as without his turmoil of dealing with the CIS policies breaking his devices, and the constant nagging from me as to when he‚Äôs done with testing and finding solutions, there wouldn‚Äôt be the content for this post or in fact the series. Right, onto the fruits of my our labour. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:0:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#"},{"categories":["windows"],"content":" 1 CIS Level 1 SettingsWe already have a grasp of the settings that cause problems with Windows Autopilot, so we can start to try and find solutions to the discovered issues, all without reducing the overall security of the Windows 11 operating system too much ü§ê. CIS Level 1 settings in Microsoft Intune. There might be a surprising amount of wiggle room with some of the CIS Level 1 benchmark settings, that maybe aren‚Äôt entirely obvious at first, starting with the documented problems‚Ä¶ ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#cis-level-1-settings"},{"categories":["windows"],"content":" 1.1 Disable Automatic Admin LogonYou‚Äôre correct CIS, of course you should disable the use of automatic logons for administrator accounts, and it should be implemented without hesitation. No one should be automatically logging on to a Windows device as a administrator, unless you‚Äôre maybe defaultuser0 as part of the Windows Autopilot process right? CIS (L1) Section 1 - 3.9.1.1 - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e MSS (Legacy) MSS: (AutoAdminLogon) Enable Automatic Logon (not recommended) Disabled The above configuration, will bin out the Enrolment Status Page, reboot, and leave you with a Windows Autopilot device at a logon screen with the defaultuser0 being your only option for sign in, and pretty much nothing from Microsoft Intune applied to it: Windows logon screen with the defaultuser0 logon prompt. We did already know about the AutoAdminLogon setting causing the issue with Windows Autopilot, as it is documented, but who has time to read all of these articles üòÇ. But how do we stop this from breaking Autopilot exactly? Note As pointed out in the comments, the Policy CSP documentation is a little vague around supported operating system versions, so we‚Äôve found an alternative way to meet this requirement without breaking Windows Autopilot deployments. Instead of attempting to using Microsoft Intune native configuration, we can lean on the registry setting to configure this CIS level 1 requirement: AutoAdminLogon registry setting reference. To ensure it doesn‚Äôt break anything, we can deploy a remediation script to set the registry value, assigning the script to users, meaning that it won‚Äôt apply until after the Autopilot process has completed. The detection script will look for the AutoAdminLogon string value, and if it does not exist, or it is not set to 0 will report an error: CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Detection.ps1 CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Detection.ps1 Try { $registry = 'HKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' $setting = 'AutoAdminLogon' # Checks if the key and if the string value AutoAdminLogon exists Try { $value = Get-ItemPropertyValue -Path $registry -Name $setting } Catch { Write-Warning \"$setting not configured.\" Exit 1 } # if the key and dword exist checks the value. if ($value -ne '0') { Write-Warning \"$setting enabled.\" Exit 1 } else { Write-Output \"$setting disabled.\" Exit 0 } } Catch { Write-Error $_.Exception Exit 2000 } With the remediation configured to create the AutoAdminLogon if required, and set it to 0, to disable this option: CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Remediation.ps1 CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Remediation.ps1 Try { $registry = 'HKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon' $setting = 'AutoAdminLogon' $path = Test-Path $registry # checks if the key exists, if not creates the key and AutoAdminLogon string. if ($path -eq $false) { New-Item -Path $registry -Force | Out-Null New-ItemProperty -Path $registry -Name $setting -Value 0 -PropertyType String -Force | Out-Null Write-Output \"$setting disabled.\" Exit 0 } else { # checks if the AutoAdminLogon string exists, if not creates it. Try { # if the AutoAdminLogon dword exists updates it. Get-ItemPropertyValue -Path $registry -Name $setting Set-ItemProperty -Path $registry -Name $setting -Value 0 Write-Output \"$setting disabled.\" Exit 0 } Catch { New-ItemProperty -Path $registry -Name $setting -Value 0 -PropertyType string -Force | Out-Null Write-Output \"$setting disabled.\" Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } Deploying this to a group of users in Microsoft Intune, with settings similar to the below, with a suitable evaluation schedule: CIS Level 1 AutoAdminLogon remediation in Microsoft Intune. Info The CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1 detection and remediation scripts are available for your to add into your Microsoft Intune tenant. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#disable-automatic-admin-logon"},{"categories":["windows"],"content":" 1.2 Interactive Logon MessagesMore breaking of Windows Autopilot, this time with pre-provisioned deployments, with another known and documented feature problem. Thanks CIS üò¨. CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Interactive Logon Message Text For Users Attempting To Log On Configured Local Policies Security Options Interactive Logon Message Title For Users Attempting To Log On Configured I know a logon message is important, and is included in other security baselines and not just for Windows devices either, but come on now, do we really need this? Well yes if you want to stick with the CIS benchmark. So once more to stripping out this setting into a separate profile, this time keeping the same configuration settings, but assigning this to all your corporate-owned devices, but excluding a group of Windows Autopilot devices configured for pre-provisioned deployments using rules based on the enrollmentProfileName associated with the device. CIS (L1) Section 45.10-45.11 - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Interactive Logon Message Text For Users Attempting To Log On Configured Local Policies Security Options Interactive Logon Message Title For Users Attempting To Log On Configured Don‚Äôt forget to actually configure these settings, unlike in the CIS profiles where they‚Äôre just set to Test test test üòÇ: Windows logon message setting in Microsoft Intune. Info You can import CIS (L1) Section 45.10-45.11 - Windows 11 Intune 3.0.1 and the amended CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 profiles into your Microsoft Intune tenant. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#interactive-logon-messages"},{"categories":["windows"],"content":" 1.3 Virtualization Based SecurityWe‚Äôd encountered a rogue device restart during Windows Autopilot when configuring a BitLocker PIN, which did actually work to our advantage, but what caused them? CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 Category Setting Value Device Guard Configure System Guard Launch Unmanaged Enables Secure Launch if supported by hardware Device Guard Credential Guard Configured Device Guard Enable Virtualization Based Security enable virtualization based security. Device Guard Require Platform Security Features Turns on VBS with Secure Boot. Yeah it‚Äôs those ones, that are specifically called out to cause device restarts. These policies require a reboot‚Ä¶ to work around this issue, the policies can be targeted to users instead of devices so that they apply later in the process. Luckily for us we‚Äôve been given a workaround, just assign the CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 profile to a group of users instead of devices. Strangely enough this isn‚Äôt mentioned in the CIS documentation anywhere, so thanks to Microsoft for looking out for us. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#virtualization-based-security"},{"categories":["windows"],"content":" 1.4 Disable Network Selection UIWe‚Äôd come across this issue one a while ago, with the below setting stopping users from connecting to a new wireless network at the logon screen. You‚Äôd think this wouldn‚Äôt be too much of an issue, even during User-Driven Windows Autopilot, but where it does become a problem though, is with pre-provisioning. CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e System \u003e Logon Do not display network selection UI Enabled With a user deploying their own device, they‚Äôre asked to connect to a wireless network (who has network cables in their own house? Jonathan apparently üòÖ) before starting Windows Autopilot, so this network will now be available at logon, and no need to select a new one. With pre-provisioned deployments, only the network that was connected to during deployment, and/or wireless or wired networks deployed to the device from Microsoft Intune are available to connect to from the logon screen. Meaning if you build devices on-premises, and then give them to end-users to take home, with the setting above, they won‚Äôt be able to connect to a new network from the logon screen. Windows logon screen with the no network logon prompt. Saving changing this across all devices, as it only impacts Windows Autopilot devices, you can remove this setting from the benchmark profiles, and create a new policy with the below settings: CIS (L1) Section 3.10.25.2 - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e System \u003e Logon Do not display network selection UI Disabled Then assign it to your corporate devices, excluding Dynamic Security Groups containing Windows Autopilot Devices where their profile allows the use of pre-provisioning as in the Interactive Logon Messages section. This will enable these devices, and these only, to select a new network not previously connected to, before logging onto their device, which if they‚Äôve been deployed somewhere other than the current location, means they can actually sign in üòÜ. Info Despite this only being one setting to create, we‚Äôve been nice and made the CIS (L1) Section 3.10.25.2 - Windows 11 Intune 3.0.1 profile available for you to import, along with the amended original profile CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:4","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#disable-network-selection-ui"},{"categories":["windows"],"content":" 1.5 Windows Hello for BusinessNow Windows Hello for Business isn‚Äôt strictly a Windows Autopilot thing, but if you‚Äôre deploying a Windows Hello for Business policy to either your users or devices, then they‚Äôre going to get prompted to configure Windows Hello when they sign in. So we were happy to see the use of Windows Hello for Business as an authentication method, to add multi-factor authentication to Windows 11 accounts, recommend by CIS üéâ. CIS (L1) Device Lock \u0026 WHFB - Windows 11 Intune 3.0.1 Category Setting Value Windows Hello For Business Minimum PIN Length 6 Windows Hello For Business Require Security Device true Windows Hello For Business Facial Features Use Enhanced Anti Spoofing true You haven‚Äôt configured additional settings somewhere else that will impact the use of Windows Hello have you CIS? Account options in Windows 11 unable to configure Windows Hello PIN. What‚Äôs that? You have? You‚Äôre advising that Windows Hello for Business should be used to protect accounts, but you‚Äôre stopping the use of convenience PINs, that are required to setup Windows Hello. CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e System \u003e Logon Turn on convenience PIN sign-in Disabled As pointed out in the comments, this isn‚Äôt strictly true; although Windows Hello and Windows Hello for Business share the same ‚ÄúWindows Hello‚Äù family name, they aren‚Äôt actually related, sort of like a step-brother üëÄ setup. So although the above setting will stop a user from setting up a PIN in the more traditional sense, it will not stop the Windows Hello for Business configuration from applying. Be aware though, there are settings in the CIS (L1) Device Lock \u0026 WHFB - Windows 11 Intune 3.0.1 profile, that will impact the configuration of Windows Hello if you don‚Äôt have a policy in place to require PIN complexity settings. CIS Benchmark Device Lock Warning. Yeah, it‚Äôs these ones they‚Äôre talking about. CIS (L1) Device Lock \u0026 WHFB - Windows 11 Intune 3.0.1 Category Setting Value Device Lock Device Password Enabled Enabled Device Lock Alphanumeric Device Password Required Password, Numeric PIN, or Alphanumeric PIN required. Device Lock Device Password Expiration 365 Device Lock Device Password History 24 Device Lock Min Device Password Length 14 Device Lock Minimum Password Age 1 Note These Device Lock settings are known to cause problems with Windows Autopilot, to get around that, it is recommended to assign the below profile to Users and not devices where applicable. So make sure you‚Äôve got a Windows Hello for Business policy already created and deployed to your users, with at least the below setting configured to enable Windows Hello for Business. CIS (L1) Windows Hello for Business (User) - Windows 11 Intune 3.0.1 Category Setting Value Windows Hello For Business Use Passport For Work (User) true Info The amended profile CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 and Windows Hello profile are available for import CIS (L1) Windows Hello for Business - Windows 11 Intune 3.0.1. With the above configuration, your users will get the post logon Windows Hello experience following a successful Windows Autopilot deployment. Info If you don‚Äôt want to force the setup of Windows Hello for Business, you can disable the post logon setup using a Custom Profile, though there are consequences. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:1:5","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#windows-hello-for-business"},{"categories":["windows"],"content":" 2 SummaryWe did say that the impact of the CIS Level 1 settings on Windows Autopilot was going to be a little difficult to deal with, but we got there, with some creative assignments, mild exclusions, and a little bit of common sense. Security and end-user experience don‚Äôt tend to wander off hand in hand into the distance to live happily ever after, but there is now a way to deal with these issues using Microsoft Intune native tooling, and a good understanding of the application of the CIS benchmark. The next chapter in this investigation of the CIS benchmark for Windows 11 covers the impact on the wider Windows 11 operating system, and happily there aren‚Äôt as many things that break functionality. There are however, some interesting choices. ","date":"23 June 2024","objectID":"/posts/windows-cis-patching-gaps-part2/:2:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","windows autopilot","windows hello","settings catalog","powershell"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","uri":"/posts/windows-cis-patching-gaps-part2/#summary"},{"categories":["windows"],"content":"Updating the Center for Internet Security (CIS) benchmark build kit for Windows 11 in Microsoft Intune for BitLocker encryption and DMA protection.","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/"},{"categories":["windows"],"content":"With the release of the CIS (Center for Internet Security) Windows 11 Benchmark 3.0.1, the corresponding release of the Microsoft Intune build kit, and my colleague Jonathan Fallis covering the CIS community version of the benchmark (and the limitations) on his website, we both thought it would be best to share our combined experience when working with the newly available CIS build kit; focussing on BitLocker security settings in the initial part of this series. Over the course of three four posts, we‚Äôll be aiming to find and fix any issues the build kit profiles create for Windows 11 cloud native devices, improve functionality using Microsoft Intune where we can, and add any missing configurations between the downloadable benchmark documents and the build kit. Let‚Äôs start with the obvious place. Note As Custom Profile settings are on their way out (see Message Centre MC822716 and this post by Daniel Bradley) this post has been updated, along with the exported profiles, to use Settings Catalog profiles. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:0:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#"},{"categories":["windows"],"content":" 1 CIS Build KitsIf you have access to the CIS Workbench as part of an organisational account, you can download the Windows 11 build kit for Microsoft Intune, which when extracted will give you exported Settings Catalog profiles in JSON format, ready to import into Microsoft Intune: Note It turns out the we have more access in the CIS Workbench than we realised, you can still register but this will only get you access to the benchmark documents, not the build kits. Imported CIS profiles in Microsoft Intune. Each of these profiles is aligned with the CIS benchmark whether Level 1, Level 2, or BitLocker settings, and instead of blindly applying these to your device estate, you really should have a look at the following sections on BitLocker profiles, as we build upon our existing understanding of their impact, and fix some issues along the way. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:1:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#cis-build-kits"},{"categories":["windows"],"content":" 2 CIS BitLocker SettingsWith only the single BitLocker related policy in the build kit, you‚Äôd think encrypting a device with these benchmark settings would be easy. Imported CIS BitLocker profiles in Microsoft Intune. Usually you just configure the use of TPM as the pre-boot authentication, allow Standard Users to encrypt the device, encryption method and cipher strength, encryption method, and boom there you have it, automatically and silently encrypted protected devices. Well not according to CIS, and for good reason. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#cis-bitlocker-settings"},{"categories":["windows"],"content":" 2.1 Encryption SettingsBefore we look at the rationale behind the recommended CIS settings for BitLocker, one thing that stood out to us when reviewing the provided policy, and the corresponding benchmark document, is a lack of actual encryption settings. Specifically, the ones that allow for silent encryption to happen‚Ä¶so we need to create a supplemental Settings Catalog policy, to allow for encryption to actually start without pestering a user. CIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e BitLocker Require Device Encryption Enabled Administrative Templates \u003e BitLocker Allow Warning For Other Disk Encryption False Administrative Templates \u003e BitLocker Allow Standard User Encryption Enabled Along with our preferred encryption ciphers for encryption. CIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption Choose drive encryption method and cipher strength (Windows 10 [Version 1511] and later) Enabled Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption Select the encryption method for operating system drives: XTS-AES 256-bit Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption Select the encryption method for fixed data drives: XTS-AES 256-bit Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption Select the encryption method for removable data drives: XTS-AES 256-bit Finally, our encryption method selecting either Full encryption or Used Space Only encryption. CIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Enforce drive encryption type on operating system drives Enabled Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Select the encryption type: (Device) Used Space Only encryption With the gaps in the CIS benchmark policy now plugged, we can look into some of the other settings and see if our silent encryption settings are going to work. Info You can import the CIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of manually creating the profile. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:1","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#encryption-settings"},{"categories":["windows"],"content":" 2.2 TPM with PIN AuthenticationWell here‚Äôs a problem, the CIS provided BitLocker profile doesn‚Äôt allow for TPM only authentication, so out the window goes our ability to silently encrypt the device then. Compatible TPM startup - Configure this as Allow TPM or Require TPM Compatible TPM startup PIN - Configure this as Do not allow startup PIN with TPM Compatible TPM startup key - Configure this as Do not allow startup Key with TPM Compatible TPM startup key and PIN - Configure this as Do not allow startup Key and PIN with TPM Why are CIS requiring both TPM and PIN for BitLocker authentication and stopping us having fun with device encryption? BitLocker with TPM-only authentication allows for a computer to enter the power-on state without any pre-boot authentication. Therefore, an attacker may be able to perform DMA (Direct Memory Access) attacks. Ah yeah, a security reason, makes sense. The settings from the profile below show the pre-boot authentication options, requiring startup PIN with TPM, and blocking everything else. CIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup key and PIN Do not allow startup key and PIN with TPM Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup Do not allow TPM Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup PIN Require startup PIN with TPM Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup key Do not allow startup key with TPM What we could do to alleviate the requirement for a user to configure a PIN to start BitLocker encryption, is slightly amend the policy (and hope that we don‚Äôt get audited), changing the below settings to allow the use of TPM and TPM with PIN protectors. CIS (BL) BitLocker Silent Encryption - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup Allow TPM Administrative Templates \u003e Windows Components \u003e BitLocker Drive Encryption \u003e Operating System Drives Configure TPM startup PIN Allow startup PIN with TPM With the settings in Microsoft Intune looking something like this: Amended BitLocker benchmark policy in Microsoft Intune. This will enable silent encryption, protecting the data on the device, but also allowing a PIN to be configured afterwards. Info You can import the CIS (BL) BitLocker Silent Encryption - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of updating the existing profile. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:2","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#tpm-with-pin-authentication"},{"categories":["windows"],"content":" 2.3 BitLocker PINSo how about setting this BitLocker PIN then? Well to remove a user from the equation, we can deploy a PowerShell script to set the BitLocker PIN based on the serial number of the device. CIS (BL) BitLocker TPMandPIN - Windows 11 Intune 3.0.1.ps1 CIS (BL) BitLocker TPMandPIN - Windows 11 Intune 3.0.1.ps1 Try { $osVolume = Get-BitLockerVolume | Where-Object { $_.VolumeType -eq 'OperatingSystem' } # Detects and removes existing TpmPin key protectors as there can only be one if ($osVolume.KeyProtector.KeyProtectorType -contains 'TpmPin') { $osVolume.KeyProtector | Where-Object { $_.KeyProtectorType -eq 'TpmPin' } | ForEach-Object { Remove-BitLockerKeyProtector -MountPoint $osVolume.MountPoint -KeyProtectorId $_.KeyProtectorId } } # Detects and removes existing Tpm key protectors to ensure the PIN is required if ($osVolume.KeyProtector.KeyProtectorType -contains 'Tpm') { $osVolume.KeyProtector | Where-Object { $_.KeyProtectorType -eq 'Tpm' } | ForEach-Object { Remove-BitLockerKeyProtector -MountPoint $osVolume.MountPoint -KeyProtectorId $_.KeyProtectorId } } # Sets a recovery password key protector if one doesn't exist, needed for TpmPin key protector if ($osVolume.KeyProtector.KeyProtectorType -notcontains 'RecoveryPassword') { Enable-BitLocker -MountPoint $osVolume.MountPoint -RecoveryPasswordProtector } # Configures the PIN and Enables BitLocker using the TpmPin key protector $deviceSerial = (((Get-WmiObject -Class win32_bios).Serialnumber).ToUpper() -replace '[^a-zA-Z0-9]', '') If ($deviceSerial.length -gt 14) { $deviceSerial = $deviceSerial.Substring(0, 14) # Reduce to 14 characters if longer } $devicePIN = ConvertTo-SecureString $deviceSerial -AsPlainText -Force Enable-BitLocker -MountPoint $osVolume.MountPoint -Pin $devicePIN -TpmAndPinProtector -ErrorAction SilentlyContinue | Out-Null # Gets the recovery key and escrows to Entra (Get-BitLockerVolume).KeyProtector | Where-Object { $_.KeyProtectorType -eq 'RecoveryPassword' } | ForEach-Object { BackupToAAD-BitLockerKeyProtector -MountPoint $osVolume.MountPoint -KeyProtectorId $_.KeyProtectorId } Exit 0 } Catch { $ErrorMessage = $_.Exception.Message Write-Warning $ErrorMessage Exit 1 } The script, in short will carry out the following: Removes any existing TpmPin key protectors, as there can only be one #highlander. Removes any existing Tpm key protectors, to allow for only TpmPin key protectors. If a Recovery Key key protector doesn‚Äôt exist, it will create one. Get the serial number of the device, converting it to uppercase, and shortening it to the first 14-characters if it‚Äôs longer than that. Creates a new TpmPin key protector with the PIN set to the converted serial number. Backups the recovery key to Entra. Note The script has been updated due to setting both Configure TPM startup and Configure TPM startup PIN to Allow sometimes resulted in BitLocker prompting for a password every boot which could then be bypassed by pressing Esc, as it would fall back to the regular Tpm unlock. It can then be deployed to your Windows Autopilot devices using a Platform Script in Microsoft Intune in conjunction with the supplemental policy we created, with the below settings: BitLocker Platform script settings in Microsoft Intune. Using a Platform script over a remediation script allows this to be run (maybe) during Windows Autopilot, or if you‚Äôre fancy and using the new Windows Autopilot device preparation method, actually guarantee that it runs during the deployment. For our test Windows Autopilot device with the inventive serial number qwertyuiopasdfghjklzxcvbnm, set using Advanced Settings Editor for Hyper-V Virtual Machines and by running a hand across a keyboard‚Ä¶ Windows Autopilot device serial number. We can see that after restarting during Windows Autopilot (forced by another CIS setting, but more on that another time), the device is now asking for a BitLocker PIN, and low and behold it‚Äôs the first 14-characters of the device serial number in uppercase: After dep","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:3","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#bitlocker-pin"},{"categories":["windows"],"content":" 2.4 Thunderbolt DMA ProtectionWe‚Äôve looked at DMA (Direct Memory Access) settings previously, but looking at exceptions to security hardening not the implementation of them, but we‚Äôre familiar with what they are at least. The settings in the CIS profile basically reduce two threat types to BitLocker; what it actually does from an end user experience perspective, is stop peripherals connected to a dock using a Thunderbolt port connection to a Windows device from being used prior to logon. CIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Prevent installation of devices that match any of these device IDs Enabled Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Also apply to matching devices that are already installed. True Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Prevented device IDs PCI\\CC_0C0A Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Prevent installation of devices using drivers that match these device setup classes Enabled Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Also apply to matching devices that are already installed. True Administrative Templates \u003e System \u003e Device Installation \u003e Device Installation Restrictions Prevented Classes {d48179be-ec20-11d1-b6b8-00c04fa372a7}, {7ebefbc0-3200-11d2-b4c2-00a0C9697d07}, {c06ff265-ae09-48f0-812c-16753d7cba83}, {6bdd1fc1-810f-11d0-bec7-08002be2092f} To further secure BitLocker and protect from attacks, additional controls exist in the same CIS policy to disable standby power states: CIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u003e System \u003e Power Management \u003e Sleep Setting Allow standby states (S1-S3) when sleeping (on battery) Disabled Administrative Templates \u003e System \u003e Power Management \u003e Sleep Setting Allow standby states (S1-S3) when sleeping (plugged in) Disabled Leaving us only with one potential exposure of the three in the linked article: Systems that are left turned on. Systems that are left in the Standby power state. Systems that use the TPM-only BitLocker protector. We can‚Äôt do much about devices that are left turned on sadly, short of powering down systems programmatically, which isn‚Äôt going to please anyone, so these DMA settings are going to have to stay exactly as they are. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:4","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#thunderbolt-dma-protection"},{"categories":["windows"],"content":" 2.5 Miscellaneous SettingsSo this won‚Äôt be the first example of where it‚Äôs important to review the benchmark documentation and not just use the build kit, as there are additional BitLocker settings under section 86.1.4 (BL) Ensure ‚ÄòEnumeration policy for external devices incompatible with Kernel DMA Protection‚Äô is set to ‚ÄòEnabled: Block All‚Äô surrounding device enumeration policies and more DMA protection: Extract of the CIS 3.0.1 benchmark for BitLocker section 86.1.4 Note This setting now exists within Settings Catalog, so we no longer need a Custom Profile, as pointed out in the CIS Intune community (which we have finally joined üòÖ) To meet these additional requirements, we did need to configure a new Custom Profile, in Microsoft Intune to align to the DeviceEnumerationPolicy recommendation in the benchmark, but now we can just use a Settings Catalog profile instead. CIS (BL) BitLocker Misc - Windows 11 Intune 3.0.1 Category Setting Value Dma Guard Device Enumeration Policy Block all (Most restrictive) Which was created based on the details in the Policy CSP article. This is another device impact setting, adding to the Thunderbolt DMA protection settings, and stopping DMA capable devices that cannot be sandboxed, remapped, or isolated in memory. Be cautious though, as this policy setting does require a restart, but doesn‚Äôt force one. Info You can now import the CIS (BL) BitLocker Misc - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of having to use a Custom profile. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:2:5","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#miscellaneous-settings"},{"categories":["windows"],"content":" 3 SummarySo that‚Äôs all there is to the CIS benchmark for Windows 11 BitLocker security in Microsoft Intune, pretty simple really üòÖ. We hope you now have a good grasp on exactly what the benchmark and policy settings are doing regarding BitLocker and the security around it, why the policies are applying these settings, and importantly how to improve and work with the restrictions to make not only the implementation in Microsoft Intune more straight forward, but also the end-user experience. This saves you just implementing the benchmark build kit settings in Microsoft Intune and being all when your devices don‚Äôt just encrypt themselves, or your keyboards connected to docks don‚Äôt work at the sign-in screen. Next up for us in the series are the CIS Level 1 settings, and if you thought the BitLocker settings were painful, you‚Äôre in for a shock üòÜ. ","date":"15 June 2024","objectID":"/posts/windows-cis-patching-gaps-part1/:3:0","series":["Patching Gaps in the CIS Windows 11 Benchmark"],"tags":["intune","security","cis","custom profiles","bitlocker","dma","settings catalog","endpoint security"],"title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","uri":"/posts/windows-cis-patching-gaps-part1/#summary"},{"categories":["macos"],"content":"Using UTM on macOS to build, configure and deploy a Windows 11 Autopilot Virtual Machine using Microsoft Intune.","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/"},{"categories":["macos"],"content":"I don‚Äôt usually write ‚Äúhow-to‚Äù guides, let alone write topics that aren‚Äôt deeply embedded with Microsoft Intune or PowerShell, but I recently hit an issue when trying to setup a Windows Autopilot ARM based virtual machine using UTM on my Apple Silicon (humble brag) based macOS device. With the recent announcement of the next generation of Windows Autopilot and Windows Autopilot device preparation now being official, I imagine there are now more and more people that are using macOS devices but need to test Windows Autopilot in a Virtual Machine, and thought, here‚Äôs an easy on trend blog post, that I should share the solution to the issue I encountered. As always though, before you go and jump to how I fixed the problem, you should probably read the entire post to get a full picture of the scenario. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:0:0","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#"},{"categories":["macos"],"content":" 1 Windows VirtualisationAs I spent all my pocket money on a MacBook Air M1, I‚Äôve got none left to pay for virtualisation apps, so I use UTM; I mean, it‚Äôs also a lot better to use than others out there, and supports virtualising many operating systems natively without emulation, including Windows 11 ARM versions. So if you‚Äôre not using UTM, go and download it from the website, or install it using Homebrew if you‚Äôre that way inclined: shell brew install utm Before we go and setup a new Virtual Machine, we need to get the Windows 11 installation media, otherwise we‚Äôre not going to make any progress. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:1:0","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#windows-virtualisation"},{"categories":["macos"],"content":" 1.1 Windows Installation ImagesTo make life a lot easier when downloading the supported iso files for Windows 11 ARM, I‚Äôd suggest installing CrystalFetch. This gives a user interface to downloading the Windows installation image, without having to build them yourself. You can download CrystalFetch either from the App Store, or again install it with Homebrew: shell brew install crystalfetch Once you‚Äôve installed CrystalFetch, launch it and kick off the download of the version of Windows 11 you want: CrystalFetch preparing to download Windows 11 ARM en-gb. Info I had success with the en-gb variant of the Windows 11 ARM iso, the en-us just didn‚Äôt want to complete the download and build. Now that we have our installation media downloaded, we can go setup a new Virtual Machine in UTM. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:1:1","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#windows-installation-images"},{"categories":["macos"],"content":" 1.2 Virtual Machine SetupOpening UTM, you‚Äôll need to select Create a New Virtual Machine, then following along with the video below to configure it: Now that we have our Virtual Machine configured, time to power it on and install Windows. Tip Check me out recording videos instead of screen-shotting everything a thousand times‚Ä¶for those interested I use Kap. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:1:2","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#virtual-machine-setup"},{"categories":["macos"],"content":" 1.3 Windows 11 InstallationAfter starting the machine, smush the keyboard when prompted to boot from the iso that we attached during the setup, we should have all at least installed Windows 11 once before, but watch the video if you need a refresh. We‚Äôre not bothering with a product key, as a) I cba typing one out, and b) we can just use Microsoft Intune or Subscription Activation to sort out keys and the license later on. Warning Make sure that you do actually have a way to apply a license otherwise big bad Microsoft will be knocking at your door asking you to pony up some cash. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:1:3","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#windows-11-installation"},{"categories":["macos"],"content":" 2 Windows Autopilot PreparationWith our newly built Windows 11 ARM Virtual Machine now available and booted, for the original Autopilot deployment configuration we still need to capture the hardware hash from the device and upload this to Microsoft Intune. I‚Äôm a great fan of the work Michael Niehaus has done to improve the Windows Autopilot process overall, so we‚Äôre using a PowerShell script based on his initial version to get the hardware hash. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:2:0","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#windows-autopilot-preparation"},{"categories":["macos"],"content":" 2.1 Hardware Hash IDWe can start this capture process by running the below commands after launching a CMD prompt using Shift+F10 on the keyboard: Run powershell from the CMD prompt, then run the below commands to install and launch the required script, accepting all prompts PowerShell Set-ExecutionPolicy Bypass Install-Script Get-WindowsAutopilotInfoCommunity Get-WindowsAutopilotInfoCommunity.ps1 -Online The last line will capture the hardware hash, allow you to authenticate to Microsoft Entra, and upload the hardware hash to Microsoft Intune. Info If you want a break down of the script, check out this post. You can see the overall process in the video below: Now after we‚Äôve authenticated to Microsoft Entra, there appears to be an issue‚Ä¶PowerShell you‚Äôve got red on you. Failing to get the hardware hash from the device. We don‚Äôt need to be a genius here to see that the error given relates to a lack of serialNumber on the virtual machine itself, which is required to build the hardware hash value that we need to add the device to Microsoft Intune as an Autopilot device. So what gives? ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:2:1","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#hardware-hash-id"},{"categories":["macos"],"content":" 2.2 Adding a Serial NumberWell sadly our Virtual Machine is missing a serial number, it can‚Äôt pull a rogue one through from the macOS host like it would using Hyper-V on a Windows host, and UTM isn‚Äôt giving it one. So I guess we need to sort this out ourselves. As UTM is built upon QEMU we have the ability to pass through QEMU parameters to the Virtual Machine, one of which gives us the option to configure a serial number. Wonderful. Go ahead and gracefully shutdown your Windows Virtual Machine, and right click and select edit in UTM: UTM Virtual Machine edit menu. Then navigate to QEMU \u003e Arguments: UTM Virtual Machine QEMU parameters. Selecting New we can add in the following line: txt -smbios Followed by selecting New again, to add in the below where XXXXXXXX is the value of a serial number: txt type=1,serial=XXXXXXXX Tip I use this site to generate a random one. So for example: txt type=1,serial=DNuesTLjtKit Which should look like the below in the parameters: Serial number parameters in the QEMU parameter settings in the Virtual Machine. Select Save, which on the screenshot is the button next to Cancel but for whatever reason in dark mode you can‚Äôt see the text. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:2:2","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#adding-a-serial-number"},{"categories":["macos"],"content":" 3 Windows Autopilot DeploymentNow we‚Äôve added in the required serial number, go ahead and power on the Virtual Machine and we‚Äôll try the capture again. As we‚Äôve already installed the required modules and set the PowerShell execution policy, we just need to launch the CMD prompt again using Shift+F10, running the below commands: Run powershell from the CMD prompt. Run Get-WindowsAutopilotInfoCommunity.ps1 -Online Info There are other parameters you can use with this script, but we‚Äôll keep it simple for now. If you‚Äôve done all this in good time, your original authentication token will still be valid, if not you will be prompted to authenticate to Entra again, either way the script should happily run and capture the hardware hash: Info I didn‚Äôt record audio with the video so just hum some royalty free music to yourself. We can see now that as the device has a serial number, the PowerShell script can successfully capture the hardware hash and upload this to Microsoft Intune: Completed synchronisation of a new Windows Autopilot device. We can check the progress of the upload in Microsoft Intune, so navigate to Devices \u003e Enrollment and under the Windows Autopilot heading select Devices, and we should now see our newly uploaded device: Windows Autopilot Devices in Microsoft Intune. We could have assigned a Group Tag as part of the PowerShell script using: PowerShell Get-WindowsAutopilotInfoCommunity.ps1 -Online -GroupTag Entra But I didn‚Äôt, so assigning that Group Tag now will allow for a Deployment Profile to be assigned: Windows Autopilot devices with Group Tag and profile assigned in Microsoft Intune. We can now restart our Windows 11 device, and low and behold it‚Äôs ready to start the Windows Autopilot deployment process: Virtual Machine starting the Windows Autopilot Deployment. Or if you really want to watch the more of the process: Right, that‚Äôs it, a new Windows 11 ARM Autopilot device enrolled in your Microsoft Intune tenant and ready for you to do whatever you want with it. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:3:0","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#windows-autopilot-deployment"},{"categories":["macos"],"content":" 4 SummaryThis might have seemed like a long winded post for something as simple as adding in two parameters to the Virtual Machine in UTM, and you‚Äôre right, it was. But now that you know how to add a serial number to a Windows 11 Virtual Machine on macOS, you can always utilise this with some of the optional steps for Windows Autopilot device preparation, using Corporate Device Identifiers allowing for uploading of Windows device identifiers (serial number, manufacturer, model) ensuring that only trusted devices go through Windows Autopilot device preparation, (once it‚Äôs no longer a known issue üòû). At least now you can test your Windows settings on an new Window 11 Autopilot device from the comfort of your precious macOS device, just like I do üòÖ. Info If you want an overview Windows Autopilot device preparation and the corporate device identifier process, I recommend this article from Joost Gelijsteen. ","date":"3 June 2024","objectID":"/posts/macos-windows-autopilot-utm/:4:0","series":null,"tags":["intune","windows autopilot","windows autopilot v2","device enrolment"],"title":"Creating Windows Autopilot Virtual Machines on macOS","uri":"/posts/macos-windows-autopilot-utm/#summary"},{"categories":["windows"],"content":"Deploying Windows 11 23H2 feature updates using Microsoft Intune with Entra ID Dynamic Device Groups and Feature Update Readiness reports to tag devices based on risk.","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/"},{"categories":["windows"],"content":"Finally we‚Äôre at the end of the series, where be bring all the components together from the previous three posts into one sub par suitable looking PowerShell script, allowing us to not only kick off the Feature Update Readiness report, but capture the risk state for each device, tag each device using Extension Attributes, and then automatically group these devices with Dynamic Security Groups in order to deploy our Windows 11 23H2 Feature Update to low risk devices whilst we give our selves breathing space to fix the others. Let‚Äôs get down, let‚Äôs get down to business. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:0:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#"},{"categories":["windows"],"content":" 1 Script OverviewBefore I let you loose with the script, and suggest that you go off and run this against your environment, let me talk you through what it actually does: Connects to Microsoft Graph - taking the tenantId and scopes from the script parameters, connects using Connect-MgGraph using the ‚ÄòMicrosoft.Graph‚Äô PowerShell module. Tells you what the script will do - gives you an overview of what the script will actually do, I know, how kind of me. Gives you the rules for the Dynamic Security Groups - this is based on the extensionAttribute and featureUpdateBuild parameters selected when initially running the script, I could have automated this, but everyone has their own naming conventions so I cba. Gives you the option to stop the script - yeah, even I have panic moments when running these types of scripts, so it at least gives you the option to Alt+F4 out of it. Checks that the extensionAttribute selected isn‚Äôt already populated with something else - this one is key, I don‚Äôt want you blaming me when the script goes and overwrites an extensionAttribute you‚Äôre using for something else. If it finds any device with data in the selected extensionAttribute other than something the script has set, it‚Äôll bin out the script. Gets all Windows devices from Entra ID - will enumerate all your Windows devices in Entra ID, as we need their objectID to allow us to add extension attributes to. Kicks off and waits for a Windows Feature Update Readiness report - using the featureUpdateBuild parameter, will start a report, wait for it to complete, then capture all the risk data. Prompts if you want to assign extension attributes - this is your final call for running away, nothing so far has been modified or updated, so use this as your option to escape if you need to. Assigns the risk based extension attributes - this is the bulk of the work, and with a little patience, depending on how many devices you actually have, will go and tag devices with their Feature Update risk rating on the extensionAttribute you chose. That‚Äôs all there is to it. Info Importantly this script can be run many many times, as we want to ensure that your devices are getting tagged with the correct risk, or if their risk has changed that it get‚Äôs updated, or if they haven‚Äôt reported back to Microsoft Intune with their readiness state, or if Microsoft have taken 52 hours to process the data and it‚Äôs only just appeared. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:1:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#script-overview"},{"categories":["windows"],"content":" 2 Running the ScriptSo now you have an overview of what the script üòá actually does, let‚Äôs see how we start it and what the output looks like. If we want to start our journey to Windows 11 23H2, and by now you should really be looking at starting this migration, as it‚Äôs not that long until the support for Windows 10 ends, we can run the PowerShell script using the below, passing in your Entra ID Tenant ID to tenantId, the selected featureUpdateBuild, in this case 23H2, and your extensionAttribute of choice: PowerShell .\\Invoke-Windows11Accelerator.ps1 -tenantId '36019fe7-a342-4d98-9126-1b6f94904ac7' -featureUpdateBuild '23H2' -extensionAttribute '15' -target 'device' -deploy Note The script has been updated to support different targets, either user or device, along with an option to run this in demo mode without the deploy switch. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:2:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#running-the-script"},{"categories":["windows"],"content":" 2.1 Deployment PreparationFollowing the authentication to Microsoft Graph PowerShell with Connect-MgGraph, with the scopes configured in the script as Group.ReadWrite.All, Device.ReadWrite.All, DeviceManagementManagedDevices.ReadWrite.All, DeviceManagementConfiguration.ReadWrite.All, we‚Äôre presented with the first stage in the process: The start of the Get Ready for Windows 11 PowerShell script. Providing us with the information I promised it would, including the generated Dynamic Security Group rules allowing your to create them in Entra ID to support the Windows 11 23H2 Feature Update deployment: Group Rule Low Risk (device.extensionAttribute15 -eq LowRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Medium Risk (device.extensionAttribute15 -eq MediumRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) High Risk (device.extensionAttribute15 -eq HighRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Not Ready (device.extensionAttribute15 -eq NotReady-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Unknown (device.extensionAttribute15 -eq Unknown-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:2:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#deployment-preparation"},{"categories":["windows"],"content":" 2.2 Getting Device InformationBlindly continuing the script, as so far the script has actually done nothing, it will happily go and get all your Windows devices from Entra ID, and check if there is any existing data we don‚Äôt want, in the selected extensionAttribute15, for us this time, we‚Äôre all clear, so it continues and starts the Feature Update Readiness report for Windows 11 23H2, and processes all the associated data: The confirmation section of the Get Ready for Windows 11 PowerShell script. Info If there was data in extensionAttribute15 for any device in Entra ID, then the script would break at this point telling you to go do your homework on extensionAttributes. Now that we have details of all the devices, from both Entra ID and the Feature Update Readiness report, we‚Äôre ready to start tagging devices. This is your last chance to bail out. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:2:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#getting-device-information"},{"categories":["windows"],"content":" 2.3 Risk Tagging DevicesNow that you‚Äôve not bottled it continued with the script, congratulations you‚Äôre on your way to delivering Windows 11 23H2 to your device estate, with the script happily churning away through the data and devices, assigning each and every one in scope of the Feature Update Readiness report. Each device will now be tagged on your selected extensionAttribute with their associated update risk status from: Low risk - There are no known compatibility risks associated with the device. Medium risk - There are only minor, or non-blocking, compatibility risks associated with this device, such as applications that are automatically removed during upgrade. High risk - There are multiple or blocking compatibility risks associated with this device, such as applications that block an upgrade. Not ready - The device isn‚Äôt capable of upgrading to the target OS version. Unknown - A readiness status couldn‚Äôt be determined. Ensure that the device is properly configured to send Windows diagnostic data. In the format of [RiskState]-W11-[FeatureUpdate] i.e., LowRisk-W11-23H2, NotReady-W11-23H2. The assignment section of the Get Ready for Windows 11 PowerShell script. I thought I‚Äôd colour code the output of this section, though it serves no purpose other than to look nice. What it does show though, are devices being assigned to their respective risk rating where appropriate, and when a device has been updated to Windows 11 23H2, it will clear the extensionAttribute. If you‚Äôve created the Dynamic Security Groups based on the rules provided by the script, they should now start slowly populating with devices. Leaping back to part three in the series, you‚Äôre now in a position to create your Feature Update profiles, allowing you to safely deploy the Windows 11 23H2 Feature Update to your devices categorised as low risk, whilst you assign someone else in your team to investigate the issues with the medium and high risk devices üòÇ. Info Remember, this script is designed to run multiple times, so after your first run, you should probably set a reminder to run it again and again until either your number of ‚Äòunknown‚Äô devices is zero, or close enough that you‚Äôre comfortable to move forward with the deployment of the Feature Update. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:2:3","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#risk-tagging-devices"},{"categories":["windows"],"content":" 3 SummaryYes I know the script could have done more, it could have created the Dynamic Security Groups and the Feature Update profiles, and assigned them whilst it was there, but two things here, firstly no-one should just blindly run a script that punts a brand new operating system out to devices, and secondly, I wouldn‚Äôt have been able to create a series of blog posts explaining each step of the way if I‚Äôd done all the work for you in PowerShell. The script, and the content of this series gives you a better understanding on how to leverage the existing information in Microsoft Intune to assist you with deploying Windows 11 23H2, well in time for the end of support date of Windows 10. It also allows you to start the deployment of the Feature Update to known low risk devices, giving you more time to investigate those with applications or drivers that are going to get removed during the update, or will block the Feature Update entirely. All in all, this is a great place to start with deploying Windows 11 23H2, but it isn‚Äôt the end of your process. It is however the end of this series. ","date":"18 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part4/:3:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Automation","uri":"/posts/windows-11-risk-based-deployment-part4/#summary"},{"categories":["macos"],"content":"Configuring Google Chrome in Microsoft Intune using Custom Profiles and mobileconfig to support Platform Single Sign-on (SSO) and Conditional Access Policies.","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/"},{"categories":["macos"],"content":"So it‚Äôs finally here, after all the coming soon announcements, and the promise that we can use Entra ID authentication methods on macOS devices, we now have Platform SSO at our disposal in Microsoft Intune, well at least in Public Preview. I‚Äôm not going to deep dive into configuring Platform SSO as I‚Äôll assume you‚Äôve either already had a go yourself, or found someone else who has, as honestly it‚Äôs now a massive selling point of moving macOS devices into Microsoft Intune away from other MDM solutions. Now we can use Entra ID account for SSO on the macOS device itself, what about our good friend the web browser, and in particular Google Chrome? ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:0:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#"},{"categories":["macos"],"content":" 1 Browser SupportIf like me you‚Äôve been patiently waiting for Platform SSO to appear, you‚Äôve probably already looked at the pre-requisites for configuration, so let‚Äôs just assume you‚Äôve done these already, or you‚Äôre a least aware of them, and if you haven‚Äôt sorted them, crack on and sort yourself out. The bit we‚Äôre interested in is the supported browsers, and shock, both Microsoft Edge and Safari are supported out the box already (ish). Google Chrome however needs a little more convincing, as it does on Windows, to work with Single Sign On configurations. Platform SSO requires you install and enable the Windows Accounts extension. You can add the app to Intune, and assign it to the devices that use Google Chrome. That last line is interesting though Microsoft, as deploying Google Chrome extensions isn‚Äôt as easy as click click next OK. Luckily though, Microsoft have provided links to setting up Google Chrome on macOS and how to configure the forced installation of extensions which we‚Äôll be utilising to make Google Chrome and Platform SSO play nicely. Configuring this extension will not only improve the users sign-in experience, but allow for the use of Conditional Access Policies when using Google Chrome: macOS devices using the Enterprise SSO plugin require the Microsoft Single Sign On extension to support SSO and device-based Conditional Access in Google Chrome. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:1:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#browser-support"},{"categories":["macos"],"content":" 2 Platform SSO ConfigurationYes, I did say I wasn‚Äôt going to dig into the Platform SSO configuration, but without actually configuring it we‚Äôre not going to be able to utilise the authentication method into Google Chrome, so if you cba following the Microsoft Learn article have a look at the below, and the exported JSON which you can import into your own Microsoft Intune tenant if you‚Äôre lazy productive with your time. Category Setting Value Authentication Authentication Method (Deprecated) UserSecureEnclaveKey Authentication Screen Locked Behavior Do Not Handle Authentication Registration Token {{DEVICEREGISTRATION}} Authentication Team Identifier UBF8T346G9 Authentication Extension Identifier com.microsoft.CompanyPortalMac.ssoextension Authentication Type Redirect Authentication URLs https://login.microsoftonline.com https://login.microsoft.com https://sts.windows.net https://login-us.microsoftonline.com https://login.microsoftonline.us Authentication \u003e Platform SSO Account Display Name MEM v ENNBEE Account Authentication \u003e Platform SSO Authentication Method UserSecureEnclaveKey Authentication \u003e Platform SSO Enable Authorization Enabled Authentication \u003e Platform SSO Enable Create User At Login Enabled Authentication \u003e Platform SSO Login Frequency 64800 Authentication \u003e Platform SSO New User Authorization Mode Standard Authentication \u003e Platform SSO Use Shared Device Keys Enabled Authentication \u003e Platform SSO User Authorization Mode Standard This settings catalog profile is configured to use UserSecureEnclaveKey for Passwordless authentication, but feel free to amend any other settings in the Microsoft Learn article as you see fit. Assigning this to a group of test devices, yes I do actually test things, you should get the glorious device registration and sign-in experience with Entra ID credentials we‚Äôve all been after. Info If you encounter issues with the Entra Join and registration, have a look at the troubleshooting guide for Platform SSO, specifically the Entra Join permissions. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:2:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#platform-sso-configuration"},{"categories":["macos"],"content":" 3 Google Chrome DeploymentWith the Platform SSO configuration setup and deployed, we can now focus our attention on how we manage Google Chrome on macOS devices, including delivering the app, as well as configuring it to support the required Microsoft Single Sign On extension. I shouldn‚Äôt be teaching you all to suck eggs, but for completions sake, we should probably go through deploying Google Chrome to your Microsoft Intune enrolled macOS devices, and we‚Äôve got a couple of ways to do this, depending on whether you want to force install this on your end user devices, or allow the app to be installed by the user. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:3:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#google-chrome-deployment"},{"categories":["macos"],"content":" 3.1 Required App DeploymentIf you just want to get the latest version of Google Chrome out there to all assigned devices, then the easiest approach is to use a Shell Script and in particular the one in the shell-intune-samples GitHub repository, which will run on a device, got get the latest Google Chrome version download, and install it. Setting Value Upload Script installGoogleChrome.zsh Run script as signed-in user No Hide script notifications on devices Not configured Script frequency Not configured Max number of times to retry if script fails 3 times Shell Script for deploying Google Chrome to macOS devices in Microsoft Intune.. After your assigned group of test devices check in to Microsoft Intune and the script runs successfully, your devices should download and install Google Chrome. Info If you want to see progress or errors with the script, the script log file is located in /Library/Logs/Microsoft/IntuneScripts/GoogleChrome on the targetted macOS device. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:3:1","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#required-app-deployment"},{"categories":["macos"],"content":" 3.2 Available App DeploymentIf you want to make the app available to your end users via the Company Portal, and who doesn‚Äôt love self-service, then go ahead and download the pkg installer. As we‚Äôre looking to make the app available our only option in Microsoft Intune is to upload the file using the Line-of-business app, as pkg apps although great for pre and post deployment scripts, don‚Äôt give the option for making apps available in the Company Portal. Setting Value Select file GoogleChrome.pkg Name Google Chrome Description Chrome is the official web browser from Google, built to be fast, secure and customisable. Download now and make it yours Publisher Google Minimum operating system Catalina 10.15 Ignore app version Yes Install as managed No Included apps com.google.Chrome 124.0.6367.119 Publisher Google Line-of-business app for deploying Google Chrome to macOS devices in Microsoft Intune. Deploying this app to a group of users, will allow your end users to select the option to install Google Chrome on their macOS device from the Company Portal: Company Portal available apps. Two of many potential methods to install Google Chrome now sorted, onto what we‚Äôre here for in the single sign on configuration. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:3:2","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#available-app-deployment"},{"categories":["macos"],"content":" 4 Google Chrome ConfigurationGoogle being quite a large enterprise, realise that you might want to actually configure Google Chrome on your devices, and give you examples of property list files for configuring the app on macOS devices as part of their Chrome Browser bundle, but we‚Äôre looking for specific settings today, around the requirement to force install a specific of extension to support Platform SSO. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:4:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#google-chrome-configuration"},{"categories":["macos"],"content":" 4.1 Custom Configuration ProfilesUsing the examples provided by Google, we have a basis to create our custom mobileconfig file, which when complete, can be uploaded to Microsoft Intune and deployed to our macOS devices. As we‚Äôre focusing solely on the forced installation of the Microsoft Single Sign On extension, we can strip out everything else from the example, and can update the configuration file to install the extension we want. We need to update the settings under the key installation_mode setting the string value to force_installed, this in conjunction with the ID of the extension we want to force install ppnbnpeolgkicgegkbkbjmhlideopiji (which we can get from the extension URL itself), allows us to configure a custom profile for Google Chrome to ensure that the extension that unlocks all the Platform SSO goodness is deployed to devices with Google Chrome installed. GoogleChromepSSO.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003cdict\u003e \u003ckey\u003ecom.google.Chrome\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eForced\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003emcx_preference_settings\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eExtensionSettings\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eppnbnpeolgkicgegkbkbjmhlideopiji\u003c/key\u003e \u003cdict\u003e \u003ckey\u003einstallation_mode\u003c/key\u003e \u003cstring\u003eforce_installed\u003c/string\u003e \u003ckey\u003eupdate_url\u003c/key\u003e \u003cstring\u003ehttps://clients2.google.com/service/update2/crx\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/dict\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eGoogle Chrome Platform SSO Extension Settings\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003ecom.google.Chrome.extensions.platformsso\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.apple.ManagedClient.preferences\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e0f644bb2-a1e0-4a90-a093-934f32e126de\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/array\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eGoogle Chrome Configuration\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eGoogle Chrome Configuration\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003ecom.google.Chrome\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eMEM v ENNBEE\u003c/string\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003ea01d7a80-6db0-4392-a8a9-989147fb2aa1\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/plist\u003e The other settings in the profile ensure that the profile is installed in the system context and cannot be removed by an end user. Info The PayloadUUID keys should be unique to your environment, so go ahead and generate new ones for your own profile. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:4:1","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#custom-configuration-profiles"},{"categories":["macos"],"content":" 4.2 Custom TemplateNow armed with our saved mobileconfig profile, we can create a new macOS Configuration Profile, using the Template profile type, and selecting Custom, giving the profile a name by smashing your hand on the keyboard aligned to your naming convention, we can then complete the remaining sections of the profile uploading the mobileconfig profile we saved previously: Setting Value Custom configuration profile name Google Chrome Platform SSO Profile Deployment channel Device channel Configuration profile file GoogleChromepSSO.mobileconfig Custom Profile in Microsoft Intune for macOS. Give the configuration profile a suitable name, I‚Äôve gone with Google Chrome Platform SSO Profile, as really you‚Äôre only going to see this on the device itself under the Profile section of System Preferences. Info As the custom profile sets the PayloadScope as System our Deployment channel should be set to Device channel. We should probably assign this profile to our test devices, so go ahead and do that, and after a while we should get some greens: Custom Profile Report in Microsoft Intune for macOS. Checking on the assigned macOS 14 test device itself under System Preferences \u003e Privacy \u0026 Security \u003e Profiles we can see the profile has installed correctly: The profile installed under System Preferences. One last thing to look at, and that‚Äôs the extensions in Google Chrome itself: Google Chrome installed extensions. It is, and the user is unable to disable or remove it, as why would we want them to? So what does SSO look like on Google Chrome with Secure Enclave key authentication? Well it‚Äôs the same process as with Microsoft Edge and Safari: A user opens the browser and accesses a Microsoft Entra authenticated service such as outlook.office.com. If there is a valid token for the user, the user is not prompted to sign-in to the service, otherwise re-authentication with TouchID is required before access. Subsequent login prompts to Microsoft Entra authenticated services like teams.microsoft.com are now automatically passed through using SSO. All that to make browser sign-ins a little easier and to allow for the use of Conditional Access Policies üòÖ. Info If you encounter issues with Google Chrome SSO, please refer to the Microsoft Learn documentation. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:4:2","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#custom-template"},{"categories":["macos"],"content":" 5 SummaryPlatform SSO on macOS in Microsoft Intune is a big thing, it‚Äôs likely the last hurdle or excuse people were using to stay away from using a Microsoft product to manage an Apple device. If you‚Äôre already in bed with Microsoft and associated services, then something as trivial as where your precious Apple devices are managed shouldn‚Äôt be stopping you from jumping two footed straight into enrolling your macOS devices into Microsoft Intune, especially now that you can use Entra ID authentication across them. On top of this, we can now configure the most used browsers on a macOS device to leverage and make use of Platform SSO, to stop users from being bogged down with sign-in prompts that their colleagues on low-spec Windows laptops don‚Äôt have to deal with. It‚Äôs a win win in my books. ","date":"8 May 2024","objectID":"/posts/macos-platformsso-google-chrome/:5:0","series":null,"tags":["intune","configuration","custom profiles","security","conditional access","platform sso"],"title":"Configuring Google Chrome on macOS for Platform Single Sign-On","uri":"/posts/macos-platformsso-google-chrome/#summary"},{"categories":["windows"],"content":"Deploying Windows 11 23H2 feature updates using Microsoft Intune with Entra ID Dynamic Device Groups and Feature Update Readiness reports to tag devices based on risk.","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/"},{"categories":["windows"],"content":"We‚Äôre almost there now; we‚Äôve generated and captured the data from a Feature Update Readiness Report and we‚Äôve tagged and grouped devices based on their readiness state using Dynamic Security Groups. All of this is useful when deploying a Windows 11 Feature Update, in this instance 23H2, to devices, so let‚Äôs look at how we actually deploy the new Feature Update to these groups of devices and get you on your Windows 11 journey. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:0:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#"},{"categories":["windows"],"content":" 1 Using Feature Update ProfilesYes, I am usually against silently paywalled areas of Microsoft Intune, but there isn‚Äôt really any better way of getting devices upgraded to a Feature Update in a controlled manner, you could use Target Release Version but then you‚Äôre risking all devices updating all at once, or using deferral settings for Feature Updates in Windows Update Rings, but that all relies on the data the Feature Update is released, not ideal really. So I‚Äôm sorry, if you‚Äôre not already covered by one of the (at time of writing) license pre-requisites to use Feature Update profiles then I suggest finding some cash down the back of the sofa. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:1:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#using-feature-update-profiles"},{"categories":["windows"],"content":" 1.1 Licensing Pre-requisitesSo let‚Äôs make sure you‚Äôre covered by the requirements for Feature Update first, starting with the licenses, make sure your are covered for the ‚ÄòWindows Update for Business deployment service‚Äô with have one of the below licenses: Windows 10/11 Enterprise E3 or E5 (included in Microsoft 365 F3, E3, or E5) Windows 10/11 Education A3 or A5 (included in Microsoft 365 A3 or A5) Windows Virtual Desktop Access E3 or E5 Microsoft 365 Business Premium In addition to a license for Intune, your organization must have one of the following subscriptions that include a license for Windows Update for Business deployment service. That should be pretty easy to sort out, it‚Äôs only one license isn‚Äôt it Microsoft? Please don‚Äôt audit me. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:1:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#licensing-pre-requisites"},{"categories":["windows"],"content":" 1.2 Telemetry Pre-requisitesReading through the other requirements, one of which we already touched upon in part one, and you should have configured as part of using the Feature Update Readiness Report, is telemetry data. If you‚Äôve gotten to this part of the series and you‚Äôre still wondering why your reports are empty, it‚Äôs probably the fact that when Windows 10 was first released all those years ago, you aggressively disabled telemetry reporting for fear of Microsoft using your data. Well, here we are now, needed this telemetry data, go and configure a Settings Catalog profile with the settings below and assign it to all your devices, do it now. Category Setting Value Description System Allow Telemetry Basic Sends all required telemetry information to Microsoft. System Configure Telemetry Opt In Change Notification Disable telemetry change notifications Stops users panicking about data, what they don‚Äôt know won‚Äôt hurt them. System Configure Telemetry Opt In Settings Ux Disable Telemetry opt-in Settings Stops users from changing telemetry settings This, once Microsoft has processed your data, will allow for the delivery of Feature Updates. We‚Äôre almost done, I promise. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:1:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#telemetry-pre-requisites"},{"categories":["windows"],"content":" 1.3 Service Pre-requisitesWell, who‚Äôs been caught out with the issue where monthly updates happily deploy, but you‚Äôve been scratching your head about why Feature Updates haven‚Äôt been offered to a device yet? Yeah me neither, but we should at least be definite with this requirement that the Microsoft Account Sign-In Assistant (wlidsvc) is not disabled. Category Setting Value Description Accounts Allow Microsoft Account Sign In Assistant Manual start If this is disabled, will block the use of Feature Updates on Windows 10 and later devices. This will set the service is set to Manual (Trigger Start), which allows it to run when needed. You may as well lob the above setting into the same Settings Catalog profile as the telemetry data settings, saves creating multiple granular profiles when you‚Äôre not dealing with specific exclusions, giving us something like the below. Microsoft Intune settings catalog policy. Right, on to setting up the Feature Update profiles. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:1:3","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#service-pre-requisites"},{"categories":["windows"],"content":" 2 Targetting Feature Update ProfilesAs we‚Äôre not using deferral settings within Windows Update Rings, and instead opting for the use of Feature Update profiles to deploy new versions of the Windows operating system, we need to set all Feature Update deferrals in our existing Update Rings to be zero, but to stop the flood of devices attempt to update to a newer version of Windows 10 or 11, before we change this setting, let‚Äôs look at how we keep devices at the required level. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:2:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#targetting-feature-update-profiles"},{"categories":["windows"],"content":" 2.1 Feature Update Dynamic GroupsThat‚Äôs right, more Dynamic Device Security Groups, this time we‚Äôre going to ring-fence devices based on the operating system they are currently running, and assign a corresponding Feature Update of the same version, yes this sounds a little backward when our end goal is to upgrade devices to Windows 11 23H2, but bear with me there‚Äôs logic around this. Based on the current (at time of writing) Feature Update versions available in Microsoft Intune, we need to create at groups for at least each of the below versions. Microsoft Feature Update profile with immediate installation. So go and create some new groups in Entra ID with the below rules to capture your corporate owned Windows devices at each Feature Update version Group Rule Windows 10 21H2 (device.deviceOwnership -eq \"Company\") and (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startswith \"10.0.19044\") Windows 10 22H2 (device.deviceOwnership -eq \"Company\") and (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startswith \"10.0.19045\") Windows 11 21H2 (device.deviceOwnership -eq \"Company\") and (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startswith \"10.0.22000\") Windows 11 22H2 (device.deviceOwnership -eq \"Company\") and (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startswith \"10.0.22621\") Windows 11 23H2 (device.deviceOwnership -eq \"Company\") and (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startswith \"10.0.22631\") Your mileage may vary with this, as it could be you‚Äôve got other devices that aren‚Äôt covered by one of these Feature Update profile versions, if that is the case create dynamic device groups for these other versions too, and we‚Äôll work out what to do with them later. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:2:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#feature-update-dynamic-groups"},{"categories":["windows"],"content":" 2.2 Feature Update VersionWith our grouped devices based on version at hand, we can now create Feature Update Profiles for each of these versions, configuring them to be immediately available, and assigned to the dynamic device groups we/ve just created. Feature Update Version Rollout options Group Windows 10, version 21H2 Make update available as soon as possible Windows 10 21H2 Windows 10, version 22H2 Make update available as soon as possible Windows 10 22H2 Windows 11, version 21H2 Make update available as soon as possible Windows 11 21H2 Windows 11, version 22H2 Make update available as soon as possible Windows 11 22H2 Windows 11, version 23H2 Make update available as soon as possible Windows 11 23H2 For your devices that are running lower versions of Windows 10, then you‚Äôve got a couple of options, either assign the group to one of the above newly created version targeting Feature Update profiles, or, using a Settings Catalog profile with Target Release Version configured to the required version to keep your LTSC or otherwise Windows 10 devices exactly where they need to be. With these now in place, we can happily remove the Feature Update deferral settings in our Windows Update rings, without the fear that devices are just going to jump to a version we don‚Äôt want them to be on, yet. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:2:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#feature-update-version"},{"categories":["windows"],"content":" 3 Deployment Feature Update ProfilesNow you may be thinking, all of this is well and good, but how are we going to distribute Windows 11 23H2 after gathering compatibility data and grouping devices based on their upgrade risk, well, fear not, as there is documented behaviour when a device is in scope of multiple Feature Update profiles, in short, a device will install the most recent Feature Update version, in long‚Ä¶ Each Windows feature update policy supports a single update. When a device is targeted by more than one policy, it might be targeted with multiple update versions. The Windows Update service can only offer a device one feature update at a time, and always offers the latest update version that targets the device. Because Windows 11 updates are considered to be later versions than Windows 10, the service always offers the Windows 11 update to a device targeted by both Windows 10 and Windows 11 updates. This is done because deploying a Windows 11 update to a Windows 10 device is a supported upgrade path. So this behaviour is exactly what we need, a way to keep devices on their current version, until they are in scope of a newer version, in this case, Windows 11 23H2. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:3:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#deployment-feature-update-profiles"},{"categories":["windows"],"content":" 3.1 Deploying Windows 11 Feature UpdatesOnto the fun part, the fruition of my our hard work, being able to roll out Windows 11 23H2 safely. Let‚Äôs go and create a new Feature Update profile for Windows 11 23H2 for our low risk devices, this time instead of an immediate roll out option, we‚Äôre going to utilise the ‚ÄòMake update available gradually‚Äô option, which uses magic ü™Ñ. Microsoft Feature Update profile with phased installation. Well it‚Äôs not necessarily magic, there must be something in the background that allows the splitting of a targeted include assignment group or groups into equal sized smaller manageable virtual groups between the start date and end date, separated by number of days between them. A few things to note before we go and assign this profile: The start of the first group availability must be at least two days in advance of the current date, which allows the magic to happen to split the devices. The final group availability may not occur on the specified date, based on the how many days between groups has been configured, something about maths and whole numbers. Installation deadlines and grace periods in Windows Update rings are adhered to, so ensure that you have this configured to something sensible, and lower than the number of days between groups otherwise you‚Äôll end up with overlapping deployments. We‚Äôre here, the end, we have a profile for deploying Windows 11 23H2 and we can assign this to our ready to go, low risk tagged, group of Windows 10 devices, that‚Äôs exciting. Microsoft Feature Update profile assignment. With these devices telling you that they‚Äôre happy to update to Windows 11, you can safely sit back and watch the reports update with the status of the Feature Update deployment, giving you time to work through the issues reported by the medium and high risk device issues. Or if you‚Äôre like me, just take a chance deploying the Feature Update to the medium risk devices, I mean who cares if a driver get‚Äôs removed, you should be updating them anyway üòÇ. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:3:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#deploying-windows-11-feature-updates"},{"categories":["windows"],"content":" 4 SummaryThis should now give you confidence in deploying a Windows 11 Feature Update to the devices that have told you that they‚Äôre OK to update, based on the Microsoft backed information captured from the Readiness Report, starting your migration to Windows 11 from Windows 10 well before the end of support, pat yourself on the back. Even if all of your Windows 10 and later devices are reporting their compatibility information, this isn‚Äôt the end of the story, what if you‚Äôve resolved some of the medium or high risk issues? What if those devices that were captured by medium or high risk tags are now reporting as low risk? What if there are new Windows 10 devices enrolled into Microsoft Intune? What if devices that had low disk space now have enough free space? These are all valid questions I‚Äôve just come up with, and in the last part of this series, I‚Äôll be taking you through a PowerShell script that combines what we‚Äôve covered into a fool-proof deployment that can be run regularly, ensuring that Windows 10 devices don‚Äôt get left behind. ","date":"5 May 2024","objectID":"/posts/windows-11-risk-based-deployment-part3/:4:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph"],"title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","uri":"/posts/windows-11-risk-based-deployment-part3/#summary"},{"categories":["windows"],"content":"Deploying Windows 11 23H2 feature updates using Microsoft Intune with Entra ID Dynamic Device Groups and Feature Update Readiness reports to tag devices based on risk.","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/"},{"categories":["windows"],"content":"I‚Äôd strongly suggest, if you haven‚Äôt already, skimming over the first part of this series as this will give you a good understanding of where we started, and hopefully where we‚Äôre trying to get to with putting the Feature Update Readiness Reports in Microsoft Intune to good use allowing for a risk based deployment approach of Windows 11 23H2. Microsoft Feature Update readiness report. With our precious data in hand, we can move onto how we group devices based on the risk, and hopefully make the transition to Windows 11 a relatively painless one. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:0:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#"},{"categories":["windows"],"content":" 1 Device AttributesThose with a keen pair of eyes, may have spotted a previous post allowing the tagging of a device using device attributes for exceptions to Conditional Access Policies, and I may have hinted at the time that these attributes may have other uses. Well guess what, they do. We can take the data from the Readiness Report, that we formatted and updated with both a string representation of the risk state, and the Entra ID computer ObjectId of the device, and use this information to tag devices with their risk state for the Windows 11 Feature Update they were assessed against. Clever eh? ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:1:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#device-attributes"},{"categories":["windows"],"content":" 1.1 Getting Existing Device Attribute ValuesWe‚Äôve already got a function to update device attributes on device objects, and I say update, as the call to Graph is using PATCH which means that it will overwrite the existing value for the attribute we want to update. This is both good, as it means we don‚Äôt need to worry about changes to the devices Feature Update risk state, and bad, because we should probably check that our chosen attribute is not already used for something else, like for Conditional Access Policies exclusions. So can we find a way to pull back all devices where our device attribute of choice, this time extensionAttribute15, is not empty? Sure why not. Info Connect to Graph using the latest module and Connect-MgGraph -Scopes 'Device.ReadWrite.All'. PowerShell $extensionAttribute = 'extensionAttribute15' $windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq 'Windows' } foreach ($windowsDevice in $windowsDevices) { $attribute = ($windowsDevice.extensionAttributes | ConvertTo-Json | ConvertFrom-Json).$extensionAttribute if ($attribute){ Write-Host \"$($windowsDevice.displayName) already has a value of '$attribute' configured in extension attribute $extensionAttribute\" -ForegroundColor Red } } This can be run in isolation, to check before assigning the risk based device attributes whether you‚Äôre going to be overwriting anything important, as the PATCH to update the attribute is pretty destructive. For our situation, we know what values to actually expect on the device attribute that are valid (LowRisk-W11-23H2, MediumRisk-W11-23H2, HighRisk-W11-23H2, NotReady-W11-23H2, Unknown-W11-23H2), so we should expand upon the above to add some depth to the logic by creating an array variable of safe extension attribute values in $safeAttributes, which will allow us to run the assignment of attribute values multiple times, which is going to be important. PowerShell $extensionAttribute = 'extensionAttribute15' $windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq 'Windows' } $attributeErrors = 0 $safeAttributes = @(\"LowRisk-W11-23H2\",\"MediumRisk-W11-23H2\",\"HighRisk-W11-23H2\",\"NotReady-W11-23H2\",\"Unknown-W11-23H2\") foreach ($windowsDevice in $windowsDevices) { $attribute = ($windowsDevice.extensionAttributes | ConvertTo-Json | ConvertFrom-Json).$extensionAttribute if ($attribute -notin $safeAttributes){ if ($null -ne $attribute){ Write-Host \"$($windowsDevice.displayName) already has a value of '$attribute' configured in extension attribute $extensionAttribute\" -ForegroundColor Yellow $attributeErrors = $attributeErrors + 1 } } } if ($attributeErrors -gt 0){ Write-Host \"Please review the devices reporting as having existing data in the selected attribute $extensionAttribute, and run the script using a different attribute selection.\" -ForegroundColor Red break } The above will now check to see if our selected extension attribute extensionAttribute15 contains a value not in the safe list, or not null, and increment an error variable $attributeErrors, then throw a wobbly if the value of that variable is greater than zero. Pre-flight checks over for now, onto assigning a value to our attribute. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:1:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#getting-existing-device-attribute-values"},{"categories":["windows"],"content":" 1.2 Updating Device AttributesWe‚Äôve dealt with this function previously, so no need to go into detail on this one, but it is expecting some JSON content and an Id to be able to assign the attribute values. PowerShell Function Add-DeviceAttribute() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON, [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"devices/$Id\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } Using the above and the data we have previously captured in part one in the $reportArray variable: Updated Readiness report data array. We can loop through each and every device in the array, and with the values for both the RiskState and ObjectID we can happily update some attributes. PowerShell Foreach ($object in $reportArray) { $JSON = @\" { \"extensionAttributes\": { \"$extensionAttribute\": \"$($object.RiskState)\" } } \"@ Add-DeviceAttribute -Id $object.ObjectID -JSON $JSON Start-Sleep -Seconds 3 } Now while totally suitable, and will work it‚Äôs way through the devices updating them based on the initial run, we need to be able to update the same extension attribute in subsequent runs, and with the call to Graph using PATCH we‚Äôre covered, but there is no RiskState for devices already upgraded to the Windows 11 Feature Update version, so devices following an upgrade and new readiness report, will still be tagged with their old risk rating. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:1:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#updating-device-attributes"},{"categories":["windows"],"content":" 1.3 Maintaining Device AttributesI‚Äôm not usually this tidy with my scripts, but we should clean up after ourselves, and as the Feature Update Readiness Report relies on a number of moving parts, no less devices themselves sending data, and the 52 hours of waiting for data to process, the aim here is to regularly run the whole script to ensure accurate assessment and tagging of devices. So let‚Äôs add a little something something, and using the values from ReadinessStatus we can assess whether a device is already upgraded to our Windows 11 Feature Update version or not based on the ReadinessStatus equalling 4 and send the correct JSON data to Graph to ensure consistent assignment of the value of the extension attribute. PowerShell Foreach ($object in $reportArray) { if ($object.ReadinessStatus -ne '4') { $JSON = @\" { \"extensionAttributes\": { \"$extensionAttribute\": \"$($object.RiskState)\" } } \"@ } else { $JSON = @\" { \"extensionAttributes\": { \"$extensionAttribute\": \"\" } } \"@ } Add-DeviceAttribute -Id $object.ObjectID -JSON $JSON Start-Sleep -Seconds 3 } There we go, we can tag our devices using extension attributes with their risk state, not just once, but many many times, and keep on top of devices that have been updated to Windows 11 already. A quick straw poll of devices in Entra ID, we can see that the tag has applied successfully: Low Risk Device Medium Risk Device Not Ready Device Unknown Risk Device Screenshot of Low Risk Device in Entra ID. Screenshot of Medium Risk Device in Entra ID. Screenshot of Not Ready Device in Entra ID. Screenshot of Unknown Risk Device in Entra ID. We should do something sensible with these tags on the devices now. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:1:3","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#maintaining-device-attributes"},{"categories":["windows"],"content":" 2 Dynamic Security GroupsAh my love affair between Dynamic Security Groups and Device Filters rears it‚Äôs head again, and despite the recommendations to stop using certain operators, there are still times when Dynamic Groups are going to win out over Device Filters. With Feature Update deployments in Microsoft Intune not supporting the use of Device Filters, and as we‚Äôve tagged the Entra ID object of the device, and not the Microsoft Intune object, we don‚Äôt have any say in the matter, so we have to use groups this time. Feature Update assignment in Microsoft Intune. So what are we doing with the groups? Well we can create dynamic device groups to capture corporate owned Windows devices based on their risk state. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:2:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#dynamic-security-groups"},{"categories":["windows"],"content":" 2.1 Creating Dynamic Device Security GroupsSo off you go, create some groups with the below rules, and if you‚Äôve been following along, you‚Äôll realise that we now have ring-fenced devices based on just how ready they are to update to Windows 11. Cool eh? (rhetorical, it is obviously cool.) Group Rule Low Risk (device.extensionAttribute15 -eq LowRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Medium Risk (device.extensionAttribute15 -eq MediumRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) High Risk (device.extensionAttribute15 -eq HighRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Not Ready (device.extensionAttribute15 -eq NotReady-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Unknown (device.extensionAttribute15 -eq Unknown-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Give the groups a little while to populate, hopefully not 24 hours, but all being well and good, the members should flood in. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:2:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#creating-dynamic-device-security-groups"},{"categories":["windows"],"content":" 2.2 Group Membership CheckOk ok, let‚Äôs not just take my word for it, after all we‚Äôre not best friends colleagues just yet, in fact I bet some of you don‚Äôt even follow me on LinkedIn üòÖ, anyway let‚Äôs look at the output of the report we initially created. Microsoft Feature Update readiness report. Let‚Äôs look at the break down of devices in each risk category: Low Risk - 278 devices Medium Risk - 68 devices High Risk - 0 devices (lucky) Not Ready - 14 devices Unknown - 48 devices Now have a look at the obviously un-doctored screenshots of each of our Dynamic Device Security Groups: Low Risk Group Medium Risk Group High Risk Group Not Ready Group Unknown Risk Group Screenshot of Low Risk Devices Dynamic Group in Entra ID. Screenshot of Medium Risk Devices Dynamic Group in Entra ID. Screenshot of High Risk Devices Dynamic Group in Entra ID. Screenshot of Not Ready Devices Dynamic Group in Entra ID. Screenshot of Unknown Risk Devices Dynamic Group in Entra ID. And there you have it, matchy matchy values for each of the risk types. You‚Äôll notice there isn‚Äôt a group for the three devices already upgraded to Windows 11 23H2, as we don‚Äôt care about these ones for the purpose of a Feature Update to the same version that‚Äôs already installed. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:2:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#group-membership-check"},{"categories":["windows"],"content":" 3 SummaryWe‚Äôre on the home stretch now, having captured all the data we need to truly assess the readiness state of a deployment of a Windows 11 23H2 feature update, successfully tagging the Windows device objects in Entra ID with a suitably named risk state, and gathered all devices of the same risk state using Dynamic Device Security Groups. What else do you want from me? Ah yes, a way to utilise the groups we created as part of deploying the Feature Update, you know the whole point of this series. Tune in next week time for the next exciting post in this series. I bet you‚Äôre thrilled about that. ","date":"19 April 2024","objectID":"/posts/windows-11-risk-based-deployment-part2/:3:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","uri":"/posts/windows-11-risk-based-deployment-part2/#summary"},{"categories":["macos"],"content":"Using Microsoft Intune and Dynamic Security Groups in Entra ID to manage the deployment of security software updates to enrolled macOS Apple devices.","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/"},{"categories":["macos"],"content":"So you‚Äôve pulled the trigger on managing macOS devices in Microsoft Intune, and with this year being the year of macOS for Microsoft (this seems like an oxymoron), you should probably look at how to handle software updates. I‚Äôve been waiting a little while to put this post together, as unlike the monthly release of Windows Updates, macOS updates come few and far between, with the recent release of Sonoma 14.4 on March 7th 2024, giving me an actual update to test any phased update configurations. Though maybe I should have got this post out sooner looking at the reception that the update has gotten since its release. Either way, as Microsoft Intune is now a safe space for macOS device management, instead of the mild headache it used to be, we can now look at how we control the update of software on these devices, so macOS users don‚Äôt escape the same fate placed upon your normal everyday Windows user. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:0:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#"},{"categories":["macos"],"content":" 1 Update Configuration PrecedenceI wish this was as straight forward as Windows Update Rings, but it isn‚Äôt, and with the recent changes to macOS device management in Microsoft Intune, we now have three different ways to control updates on these devices. I‚Äôm not sure we needed all three, but there is a clear documented hierarchy for the settings, along with which versions of macOS support each. In summary though, the precedence of update configuration profiles looks like this: Managed software updates - Settings catalog \u003e Declarative Device Management \u003e Software Update Update policies - Devices \u003e Update policies for macOS Software updates - Settings catalog \u003e System Updates \u003e Software Update I‚Äôm going to avoid numbers 1 and 2, and although this goes against my love of all things latest and greatest, and leans on the user to install updates, it does give us the functionality of phased updates we require, and without reliance on specific versions of the operating system. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:1:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#update-configuration-precedence"},{"categories":["macos"],"content":" 2 Deployment ApproachAs with our previous look at update deployment across Windows devices, we‚Äôre going to split our macOS device estate into key deployment groups, this time we‚Äôre back with four, I‚Äôll explain why later. Sticking with the Pilot, Pre-production, and production deployment approach, we end up with something like the below: Pilot - This should be a stratified sample of either users or devices, ~5% of your device estate. Pre-Production - The early adopters deployment, ~15% of your device estate. Initial Production - The first production deployment, ~30% of your device estate. Final Production - The final production deployment, the remaining ~50% of the device estate. These groups can be used not just for macOS software updates, but also with some additional configuration, Microsoft Updates as well. What a world we live in. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:2:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#deployment-approach"},{"categories":["macos"],"content":" 2.1 Deployment GroupsAs we like to please Microsoft, we‚Äôre going to use what are referred to as efficient groups, stopping the use operators like match, in the hope that they reinstate Microsoft Developer Intune subscriptions for free. Group Type Membership Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"MacMDM\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"0\") or (device.deviceId -startsWith \"1\") or (device.deviceId -startsWith \"a\")) Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"MacMDM\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"2\") or (device.deviceId -startsWith \"3\") or (device.deviceId -startsWith \"4\") or (device.deviceId -startsWith \"b\") or (device.deviceId -startsWith \"c\")) Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"MacMDM\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"5\") or (device.deviceId -startsWith \"6\") or (device.deviceId -startsWith \"7\") or (device.deviceId -startsWith \"8\") or (device.deviceId -startsWith \"9\") or (device.deviceId -startsWith \"d\") or (device.deviceId -startsWith \"e\") or (device.deviceId -startsWith \"f\")) These groups will naturally split your macOS device estate across the three pre-production and production dynamic groups, allowing for suitable phasing of the delivery of updates. With the Pilot group, you should add devices into this group that you want to get updates the earliest, so actual pilot devices here please, not your own or your work besties. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:2:1","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#deployment-groups"},{"categories":["macos"],"content":" 2.2 Deployment AssignmentsTo ensure that we aren‚Äôt getting conflict with policy assignment, we need to ensure a device is receiving more than one update policy, whether this is a Software Update or otherwise üòâ. As we‚Äôve got the Dynamic Groups ring-fencing devices based on device.deviceId, the only conflict we may encounter is with the assigned group. To alleviate that conflict, we need to ensure that all our update ring assignments are excluding this group: Update Ring Included Groups Excluded Groups Pilot Pilot Group - Pre-Production Pre-Production Group Pilot Group Initial Production Initial Production Group Pilot Group Final Production Final Production Group Pilot Group This approach can be used across all update assignment settings covered in the rest of this post. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:2:2","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#deployment-assignments"},{"categories":["macos"],"content":" 3 Software Update ConfigurationBefore we start looking at the option to delay or defer software updates, we need to create a baseline configuration that sets devices update preference settings, to allow for this phased approach of update delivery. So with a quick Settings Catalog profile created with the below settings, and assigned to your devices, we can ensure that the devices will get the updates they need, but when we tell them: Category Setting Value Software Update Config Data Install True Software Update Automatic Check Enabled True Software Update Allow Pre Release Installation False Software Update Critical Update Install True Software Update Restrict Software Update Require Admin To Install False Software Update Automatic Download True Microsoft Intune Settings Catalog for macOS Software Update settings. You‚Äôll notice that for Critical Update Install and Config Data Install we‚Äôre allowing these to just happen, you should, as they‚Äôre important. What we want to control is when devices get OS updates, not leaving gaping security flaws in devices. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:3:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#software-update-configuration"},{"categories":["macos"],"content":" 3.1 Phased Software UpdatesThe phasing of Software update is a little bit of a pain, but it can be achieved using the below settings, creating one Settings Catalog profile for each deployment group. Now you don‚Äôt get the same pause and uninstall functionality as you would with Windows Update Rings, but at least you‚Äôre not pushing out updates all at once to devices. Update Ring Automatically Install App Updates Automatically Install Mac OS Updates Force Delayed App Software Updates Force Delayed Software Updates Enforced Software Update Delay Enforced Software Update Non OS Deferred Install Delay Enforced Software Update Minor OS Deferred Install Delay Pilot True True False False - - - Pre-Production False False True True 5 5 5 Initial Production False False True True 9 9 9 Final Production False False True True 12 12 12 These phased deployment of updates across the groups, will ensure that there is enough time between each phase to identify any issues (cough like with Sonoma 14.4 cough), allowing for some level of testing of updates prior to a full deployment across your whole macOS device estate. Info When assigning these profiles to the created deployment groups, ensure that you are excluding the Pilot group from the pre-production and production profiles. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:3:1","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#phased-software-updates"},{"categories":["macos"],"content":" 3.2 Software Update ResultsSeeing the Settings Catalog profiles in action, with a first look at the configuration being applied: macOS Update Configuration Settings. Looks good, and matches what we‚Äôve configured in our baseline software update profile. Checking on the status of the updates, we‚Äôve actually got Sonoma 14.4 available on this device, regardless of the deployment group it‚Äôs a member of, as 7+12=19 (quick maths) which is less than the date of this post: macOS Update Configuration Settings. Luckily we‚Äôll be ready with our configured deferral settings for the next macOS software update release, and I hope it goes a little better than this release. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:3:2","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#software-update-results"},{"categories":["macos"],"content":" 4 Microsoft AutoUpdate SettingsBringing additional functionality to our update deployments, and to allow for the management of visibility and installation of any update covered under the Microsoft AutoUpdate (MAU) application, we need to to implement some more baseline settings to configure Microsoft AutoUpdate. So go create yourself another Settings Catalog profile, and throw the below settings into it: Category Setting Value Microsoft AutoUpdate (MAU) Disable Office Insider membership True Microsoft AutoUpdate (MAU) Enable AutoUpdate True Microsoft AutoUpdate (MAU) Number of minutes for the final countdown timer 60 Microsoft AutoUpdate (MAU) Register app on launch True Microsoft AutoUpdate (MAU) Update channel Current Channel Microsoft AutoUpdate (MAU) Update check frequency (mins) 240 Microsoft Intune Settings Catalog for macOS Microsoft AutoUpdate settings. Feel free to amened the Number of minutes for the final countdown timer and Update check frequency (mins) if you like your user base more than I do. Note Updated the Enable AutoUpdate settings based on feedback from Somesh Pathak (MVP) ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:4:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#microsoft-autoupdate-settings"},{"categories":["macos"],"content":" 4.1 Phased Microsoft UpdatesTo phase the delivery of Microsoft Application updates across the four deployment groups, you will need to create four separate Settings Catalog profiles with the below settings, with restrictions configured to stop users checking for updates and relying on the deferral and deadline settings where applicable. Update Ring Enable check for updates Deferred updates Days before forced updates Pilot True - - Pre-Production False Defer 3 days 2 Initial Production False Defer 7 days 2 Final Production False Defer 7 days 5 You can now see why I stuck with four deployment groups, as we love working within the National Cyber Security Centre guidelines to ensure that updates are installed in that wonderful 14-day window, and the Microsoft AutoUpdate configuration only allows set values for Deferred updates. Info When assigning these profiles to the created deployment groups, ensure that you are excluding the Pilot group from the pre-production and production profiles. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:4:1","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#phased-microsoft-updates"},{"categories":["macos"],"content":" 4.2 Microsoft Update ResultsChecking in on a device that is set to defer and delay the installation of Microsoft Updates, we can see that the profile has applied correctly: Microsoft AutoUpdate Settings. With no ability for the end user to install the updates on their own, and the correct configuration applied to the device we‚Äôre off to a good start. Let‚Äôs look at the updates themselves: Microsoft AutoUpdate Updates. Perfect, the Microsoft AutoUpdate application has detected that there are actually updates, but will adhere to the deferral and deadline settings, ensuring that the application updates do get installed, but when we want them to, not at the whim of the end user. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:4:2","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#microsoft-update-results"},{"categories":["macos"],"content":" 5 SummaryWith each deployment group now configured to get update deferrals and installation deadlines for Software, Operating System, and Microsoft Applications aligned to the same day, we have the ability to unify the deployment approach of updates to Microsoft Intune managed macOS devices. This may not give us all the functionality we want just yet, still relying on users to carry out installations, but until there is another flexible approach to enforced software updates that doesn‚Äôt rely on check-in or day of the week, or scripts and property lists, or community tools like nudge, this will have to do. We are at least, one step closer to getting some level of feature parity between device management for Windows devices and macOS devices in Microsoft Intune, and with more on the horizon, it‚Äôs a good time to be a hybrid macOS and Windows device consultant. ","date":"6 April 2024","objectID":"/posts/macos-updates-phased-deployment/:5:0","series":null,"tags":["intune","updates","dynamic groups","security","ncsc"],"title":"Software Update Deployment Rings for Managed macOS Devices","uri":"/posts/macos-updates-phased-deployment/#summary"},{"categories":["windows"],"content":"Deploying Windows 11 23H2 feature updates using Microsoft Intune with Entra ID Dynamic Device Groups and Feature Update Readiness reports to tag devices based on risk.","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/"},{"categories":["windows"],"content":"At the time of writing we are only a few hundred days away from the end of support of Windows 10 22H2, and really we should all be recommending the move to Windows 11, not just because it‚Äôs shiny and new, but also it‚Äôs going to actually get security updates. Many organisations are happily running Windows 10 and have been for some time, and have probably dabbled with Windows 11, mainly IT staff who wanted to be on the latest and greatest. This however isn‚Äôt going to get your devices to Windows 11 any time soon, and instead of distributing a Feature Update blindly, we should probably make use of the information in the Feature Update Readiness Reports in Microsoft Intune. This report is useful from a visibility perspective, we can see the risk of updating a device to a specific Feature Update, drill into effected devices, and get a greater understanding of the overall Windows 11 readiness for a device estate. That‚Äôs it though. What if we can extend the reports use? Part one in this series looks at how we can create and capture the Feature Update Readiness Report data with PowerShell and Graph API, so at some point we can use it to make informed, but automated decisions for Windows 11 Feature Update deployment. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:0:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#"},{"categories":["windows"],"content":" 1 Feature Update Readiness ReportWe‚Äôre going to lean onto this report and use it to be able to tag devices with their Feature Update readiness state, from the current supported values: Low risk - There are no known compatibility risks associated with the device. Medium risk - There are only minor, or non-blocking, compatibility risks associated with this device, such as applications that are automatically removed during upgrade. High risk - There are multiple or blocking compatibility risks associated with this device, such as applications that block an upgrade. Replace device - The device isn‚Äôt capable of upgrading to the target OS version. Upgraded - The device is already running a version of Windows equal to or greater than the target OS version. Unknown - A readiness status couldn‚Äôt be determined. Ensure that the device is properly configured to send Windows diagnostic data. Microsoft Feature Update readiness report. These readiness states are all going to be pretty handy, as we hopefully can capture those devices that are at a level of risk, or unknown risk of an update to Windows 11, and allow a targeted and safe deployment of the Feature Update. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:1:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#feature-update-readiness-report"},{"categories":["windows"],"content":" 1.1 Report Pre-requisitesThis one is a bit of a kicker, and I‚Äôd recommend looking at the pre-requisites as soon as possible, in fact, go look at them now and come back when you‚Äôve implemented them‚Ä¶ Right, now they‚Äôre in place, let‚Äôs talk about why I told you to just go ahead and turn some things on, well in order for us to use the report, we need to ensure that devices are able to send data, Microsoft is able to process the data, and the fact you have to wait 52 hours for the data to be processed. So based on this, anything we do using the data needs to be able to run multiple times, as not all devices in the estate are going to send their data at the same time. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:1:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#report-pre-requisites"},{"categories":["windows"],"content":" 2 Graph and Feature Update Readiness ReportsLet‚Äôs see how we can get the report data using the Microsoft Graph PowerShell SDK, as always I‚Äôve investigated the calls to Graph using Developer Tools in my browser of choice (Microsoft Edge, obviously), and from my findings and the fact that reports are individual to the account running them, we need a way to start a report, and then get the report. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:2:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#graph-and-feature-update-readiness-reports"},{"categories":["windows"],"content":" 2.1 Creating Feature Update Readiness ReportsWe‚Äôll start with the call to create a new readiness report, we need to POST to deviceManagement/reports/cachedReportConfigurations with some JSON content in the below format, specifying the version of Feature Update we want to report on, for us, we want Windows 11 23H2, so the value we‚Äôre after is NI23H2. JSON { \"id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"filter\": \"(TargetOS eq 'NI23H2') and (DeviceScopesTag eq '00000')\", \"orderBy\": [], \"select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\" ], \"metadata\": \"TargetOS=\u003efilterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u003efilterPicker=RGVmYXVsdA==\" } This will then start the generation of a report in the background, which isn‚Äôt instant, so we‚Äôll need a way to not only capture the report data, but also a way to wait until it‚Äôs available. At least we‚Äôve got a way to kick off a report, so we should create a function to do this, you know, so it‚Äôs easily repeatable. Info Ensure that you‚Äôre connecting to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All', we‚Äôll need some more scopes later, but for now this one will do. PowerShell Function New-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = 'Beta' $Resource = 'deviceManagement/reports/cachedReportConfigurations' try { Test-Json -Json $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can now start a new report using New-ReportFeatureUpdateReadiness -JSON $JSONContent passing through our JSON content for the creation of a report, now we need to detect whether the report is ready, and then when it is ready, to download the data in the report. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:2:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#creating-feature-update-readiness-reports"},{"categories":["windows"],"content":" 2.2 Getting Feature Update Readiness Report StatusMore digging with developer mode in Edge reveals surprisingly both a GET request to deviceManagement/reports/cachedReportConfigurations('$Id') (where $Id is the Id of a generated report), this will be useful as the output of this call gives us a status of the report. Graph Explorer showing Feature Update readiness report. So let‚Äôs create ourselves a function to handle getting the Feature Update Readiness report. PowerShell Function Get-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/reports/cachedReportConfigurations('$Id')\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Get } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" -f Red Write-Host Write-Error \"Request to $Uri failed with HTTP Status $($ex.Message)\" Write-Host break } } With the function above and a little bit of common sense and a while loop, we can sit and happily wait until the report status equals completed after creating a new report. PowerShell $featureUpdateCreateJSON = @\" { \"id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"filter\": \"(TargetOS eq 'NI23H2') and (DeviceScopesTag eq '00000')\", \"orderBy\": [], \"select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\" ], \"metadata\": \"TargetOS=\u003efilterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u003efilterPicker=RGVmYXVsdA==\" } \"@ $startFeatureUpdateReport = New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON While ((Get-ReportFeatureUpdateReadiness -Id $startFeatureUpdateReport.id).status -ne 'completed') { Write-Host 'Waiting for the Feature Update report to finish processing...' -ForegroundColor Cyan Start-Sleep -Seconds 3 } Great, creation of the report and understanding whether the report is complete is now in the bag, now we need to look at how we actually get the data in the report. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:2:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#getting-feature-update-readiness-report-status"},{"categories":["windows"],"content":" 2.3 Getting Feature Update Readiness Report DataMore fun with Edge Developer Mode when browsing around the Feature Update Readiness Reporting in the Microsoft Intune Portal, and a crawl through the Graph API documentation, reveals another call to Graph, but this time it‚Äôs another POST, but to deviceManagement/reports/cachedReportConfigurations, this time with slightly different JSON content. Interesting. JSON { \"Id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"Skip\": 0, \"Top\": 50, \"Search\": \"\", \"OrderBy\": [], \"Select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\", \"DeviceId\", \"AadDeviceId\", \"Ownership\" ], \"filter\": \"\" } I tell you what is going to be fun, the fact that this call works between device 0 in the Skip and device 50 in the Top parameters, so it isn‚Äôt pulling back all data for all devices. Well that‚Äôs great news, who doesn‚Äôt love pagination? Graph Explorer with created readiness report. When I first looked at this call to Graph, the report data was passed back nicely inline, not any more though, it downloads a file, but at least the file is just a plain text file and contains all the data for the first 50 devices. As we have a new use case, we can update the Get-ReportFeatureUpdateReadiness function to handle both the initial call to get the status of a report, but also the data in the report, using logic to determine both the Graph endpoint as well as the request, and bit of a hacky way to deal with the downloaded file. PowerShell Function Get-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $false)] $Id, [parameter(Mandatory = $false)] $JSON ) $graphApiVersion = 'Beta' if ($id) { $Resource = \"deviceManagement/reports/cachedReportConfigurations('$Id')\" } elseif ($JSON) { $Resource = 'deviceManagement/reports/getCachedReport' } try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" if ($id) { Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($JSON) { $tempFile = [System.IO.Path]::GetTempFileName() Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' -OutputFilePath $tempFile Get-Content -Raw $tempFile | ConvertFrom-Json Remove-Item $tempFile } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" -f Red Write-Host Write-Error \"Request to $Uri failed with HTTP Status $($ex.Message)\" Write-Host break } } So now we can capture the data for the first 50 devices in the report, but we need a way to get all the data, and pass it into something we can call later on, because random data flying about in PowerShell is pretty useless. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:2:3","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#getting-feature-update-readiness-report-data"},{"categories":["windows"],"content":" 2.4 Handling Feature Update Readiness Report DataLet‚Äôs start with using our new functions and a call to Graph to create the report using New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON, followed by a check to see if the report data is ready, then we can get the initial report data with Get-ReportFeatureUpdateReadiness -JSON $featureUpdateGetJSON, then we can iterate through the report data if there is more than 50 devices in the initial call to capture all the data, incrementing the $i variable by 50 each time, and continue to get device data until there are no more devices left, passing the data into a new array $featureUpdateReportDetails. Simple right üôÉ PowerShell $featureUpdateCreateJSON = @\" { \"id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"filter\": \"(TargetOS eq 'NI23H2') and (DeviceScopesTag eq '00000')\", \"orderBy\": [], \"select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\" ], \"metadata\": \"TargetOS=\u003efilterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u003efilterPicker=RGVmYXVsdA==\" } \"@ $featureUpdateGetJSON = @' { \"Id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"Skip\": 0, \"Top\": 50, \"Search\": \"\", \"OrderBy\": [], \"Select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\", \"DeviceId\", \"AadDeviceId\", \"Ownership\" ], \"filter\": \"\" } '@ $startFeatureUpdateReport = New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON While ((Get-ReportFeatureUpdateReadiness -Id $startFeatureUpdateReport.id).status -ne 'completed') { Start-Sleep -Seconds 3 } $featureUpdateReport = Get-ReportFeatureUpdateReadiness -JSON $featureUpdateGetJSON $featureUpdateReportDetails = @() $featureUpdateReportDetails += $featureUpdateReport.Values $i = 0 if ($($featureUpdateReport.TotalRowCount) -gt 50) { while ($i -le $($featureUpdateReport.TotalRowCount)) { $i = $i + 50 $getNextJSON = @\" { \"Id\": \"MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\", \"Skip\": $i, \"Top\": 50, \"Search\": \"\", \"OrderBy\": [], \"Select\": [ \"DeviceName\", \"DeviceManufacturer\", \"DeviceModel\", \"OSVersion\", \"ReadinessStatus\", \"SystemRequirements\", \"AppIssuesCount\", \"DriverIssuesCount\", \"AppOtherIssuesCount\", \"DeviceId\", \"AadDeviceId\", \"Ownership\" ], \"filter\": \"\" } \"@ # Sleep to stop throttling issues Start-Sleep -Seconds 3 $featureUpdateReportNext = Get-ReportFeatureUpdateReadiness -JSON $getNextJSON $featureUpdateReportDetails += $featureUpdateReportNext.Values } } With all of this in hand, we now have an array $featureUpdateReportDetails variable with their readiness data, good, bad, and indifferent for all devices that have actually reported back. Now we need to format it into something useful. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:2:4","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#handling-feature-update-readiness-report-data"},{"categories":["windows"],"content":" 3 Processing Feature Update Report DataWe should take the data gathered from the Readiness Report in the $featureUpdateReportDetails variable, which looks ugly as sin, and create a new report using a PSCustomObject array variable $reportArray, but with some sense around the data that exists. Looping through each object in the initial array, we can create the new array using the below. PowerShell $reportArray = @() foreach ($device in $featureUpdateReportDetails) { $reportArray += [PSCustomObject]@{ 'AadDeviceId' = $device[0] 'AppIssuesCount' = $device[1] 'AppOtherIssuesCount' = $device[2] 'DeviceId' = $device[3] 'DeviceManufacturer' = $device[4] 'DeviceModel' = $device[5] 'DeviceName' = $device[6] 'DriverIssuesCount' = $device[7] 'OSVersion' = $device[8] 'Ownership' = $device[9] 'ReadinessStatus' = $device[10] 'SystemRequirements' = $device[11] } } Giving us something a little easier to reference later down the line. Readiness report data array. You might not know what‚Äôs coming in part two of this series, but luckily I do, so, there are two bits of information we are going to add into the new report array that will be very useful. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:3:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#processing-feature-update-report-data"},{"categories":["windows"],"content":" 3.1 Readiness Status ValueFirstly is a translation of the risk state number to something useful, looking at the documentation we can establish that the values captured translate to the below. Readiness status value Report value 0 Low risk 1 Medium risk 2 High risk 3 Replace device 4 Upgraded 5 Unknown With this, we should have some foresight that whatever value we‚Äôre assigning to each status value must be repeatable, so let‚Äôs use a switch on the value in the foreach loop, and assign a string based on the risk state, and Feature Update version associated with that risk state. This $riskState variable can then be added into the $reportArray array. PowerShell $reportArray = @() foreach ($device in $featureUpdateReportDetails) { $riskState = switch ($device[10]) { '0' { \"LowRisk-W11-23H2\" } '1' { \"MediumRisk-W11-23H2\" } '2' { \"HighRisk-W11-23H2\" } '3' { \"NotReady-W11-23H2\" } '5' { \"Unknown-W11-23H2\" } } $reportArray += [PSCustomObject]@{ 'AadDeviceId' = $device[0] 'AppIssuesCount' = $device[1] 'AppOtherIssuesCount' = $device[2] 'DeviceId' = $device[3] 'DeviceManufacturer' = $device[4] 'DeviceModel' = $device[5] 'DeviceName' = $device[6] 'DriverIssuesCount' = $device[7] 'OSVersion' = $device[8] 'Ownership' = $device[9] 'ReadinessStatus' = $device[10] 'SystemRequirements' = $device[11] 'RiskState' = $riskState } } I‚Äôve not bothered with dealing with 4, as these are devices already upgraded to this version of Windows, so we don‚Äôt care about them. So that deals with the risk state of a device, what else is up my sleeve. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:3:1","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#readiness-status-value"},{"categories":["windows"],"content":" 3.2 Entra ID Device ObjectsSome of the avid readers of the blog, may have worked out why this next part is important, for those slower off the mark, hang tight, I‚Äôll do my best to talk you through it. If the end goal here is to tag a device with it‚Äôs Feature Update risk status, making use of the information in the Feature Update Readiness Report, we need an object to tag. To get these objects, we‚Äôre going to have to query Entra ID for all device objects, and get their information, allowing us to compare the AadDeviceId from the report data, to the associated objectId in Entra ID. Sadly the built-in functionality within the Graph PowerShell module is going to limit us to 999 devices, so we‚Äôre leaning on an existing function to get more devices than the set device limit. PowerShell Function Get-EntraIDDevice() { $graphApiVersion = 'beta' $Resource = 'devices' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource\" $GraphResults = Invoke-MgGraphRequest -Uri $uri -Method Get $Results = @() $Results += $GraphResults.value $Pages = $GraphResults.'@odata.nextLink' while ($null -ne $Pages) { $Additional = Invoke-MgGraphRequest -Uri $Pages -Method Get if ($Pages) { $Pages = $Additional.'@odata.nextLink' } $Results += $Additional.value } $Results } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" -f Red Write-Host Write-Error \"Request to $Uri failed with HTTP Status $($ex.Message)\" Write-Host break } } We can now get all Windows devices, as we don‚Äôt care about any other types this time around, and then compare the AadDeviceId with the $windowsDevices variable containing all Entra ID device objects, adding a new ObjectID into the mix. PowerShell $windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq 'Windows' } $reportArray = @() foreach ($device in $featureUpdateReportDetails) { $riskState = switch ($device[10]) { '0' { \"LowRisk-W11-23H2\" } '1' { \"MediumRisk-W11-23H2\" } '2' { \"HighRisk-W11-23H2\" } '3' { \"NotReady-W11-23H2\" } '5' { \"Unknown-W11-23H2\" } } $reportArray += [PSCustomObject]@{ 'AadDeviceId' = $device[0] 'AppIssuesCount' = $device[1] 'AppOtherIssuesCount' = $device[2] 'DeviceId' = $device[3] 'DeviceManufacturer' = $device[4] 'DeviceModel' = $device[5] 'DeviceName' = $device[6] 'DriverIssuesCount' = $device[7] 'OSVersion' = $device[8] 'Ownership' = $device[9] 'ReadinessStatus' = $device[10] 'SystemRequirements' = $device[11] 'RiskState' = $riskState 'ObjectID' = $(($windowsDevices | Where-Object { $_.deviceid -eq $device[0] }).id) } } A quick glimpse at the data in the array now, not only shows the assigned risk state for the Feature Update version we‚Äôre looking to deploy, but also the Entra ID ObjectId for each device. Updated Readiness report data array. The array now has all the data we need for part two, we have the device details, including the Entra ID computer object Id, the risk state, and everything else we could possibly ask for to make our lives easier when deploying Windows 11 Feature Updates. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:3:2","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#entra-id-device-objects"},{"categories":["windows"],"content":" 4 SummaryI‚Äôve learnt from watching both Neighbours and Doctors as a student, that each episode should end on a cliffhanger and the viewer wanting more, so that‚Äôs what‚Äôs happened here, I hope. At least for now, we‚Äôve got a clear way to start, wait, capture, and process data from a Feature Update Readiness Reports in Microsoft Intune, and add some additional data to the report that will hopefully allow us to deploy our favourite flavour of Windows 11 using a phased, controlled, and risk based approach. ","date":"25 March 2024","objectID":"/posts/windows-11-risk-based-deployment-part1/:4:0","series":["Risk Based Windows 11 Feature Update Deployment"],"tags":["intune","updates","feature updates","dynamic groups","powershell","graph","automation"],"title":"Risk Based Windows 11 Feature Update Deployment - Reporting","uri":"/posts/windows-11-risk-based-deployment-part1/#summary"},{"categories":["windows"],"content":"Using Microsoft Intune platform powershell scripts to allow for DMA exceptions for specific hardware manufacturers to enable automatic BitLocker disk encryption.","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/"},{"categories":["windows"],"content":"Configuring silent encryption for Windows 10 and later devices in Microsoft Intune isn‚Äôt anything new, removing reliance on Administrator permissions to encrypt a device, setting the encryption algorithm used, and ensuring that the data on the device is protected. But what happens when your devices configured for silent encryption, don‚Äôt even automatically encrypt, with devices complaining about the detection of Un-allowed DMA capable bus/device(s) in the event log, preventing automatic encryption from starting. With the Microsoft recommendation to create registry items to allow for these exceptions on the devices failing to automatically encrypt, we should see if a bit of PowerShell and Microsoft Intune can do to fix this issue. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:0:0","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#"},{"categories":["windows"],"content":" 1 Direct Memory Access ExceptionsIf you are subject to this DMA-based issue, and if you‚Äôve got either Dell, HP or Lenovo devices you probably are, with the BitLocker-API Management event log complaining about these Un-allowed DMA exceptions in Event ID 4112, with text similar to the below: txt The following DMA (Direct Memory Access) capable devices are not declared as protected from external access, which can block security features such as BitLocker automatic device encryption: LPC Controller: PCI\\VEN_8086\u0026DEV_519D (Intel(R) LPC Controller - 519D) PCI-to-PCI Bridge: PCI\\VEN_8086\u0026DEV_51B1 (Intel(R) PCI Express Root Port #10 - 51B1) And System Information showing something like this: System Information showing DMA Exceptions. Instead of having to manually create the recommended registry settings, only after changing permissions on the Key to allow for these exceptions detailed in the Microsoft Support Article, we should find a way to do this automatically. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:1:0","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#direct-memory-access-exceptions"},{"categories":["windows"],"content":" 2 Platform ScriptsYou might be wondering why we‚Äôre going for a ‚Äúdumb‚Äù PowerShell script instead of the ‚Äúfancy‚Äù remediation approach that I am fond of? Well the simple answer is that Platform scripts, running under the required SYSTEM context, will run during Windows Autopilot, so we can ensure that devices with the DMA issue are resolved during the deployment process instead of after it, allowing for BitLocker automatic encryption to complete in flight, you know for security and that. So there. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:2:0","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#platform-scripts"},{"categories":["windows"],"content":" 2.1 Registry SettingsWe need a way to easily add the required registry entries to allow for the exceptions, taking into consideration that a single model, or manufacturer, of device could have multiple exceptions. For this, we can just build a new pscustomobject as part of an array variable $dmaDevices, and as the actual name of the registry value doesn‚Äôt matter, our main focus is the value. PowerShell $dmaDevices = @() $dmaDevices += [pscustomobject]@{name = 'Intel(R) LPC Controller - 519D'; value = 'PCI\\VEN_8086\u0026DEV_519D'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #10 - 51B1'; value = 'PCI\\VEN_8086\u0026DEV_51B1'} With the $dmaDevices array variable, we can then loop through each item in the array, and add the required data to the registry key HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses with a New-ItemProperty command: PowerShell $regPath = 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses' foreach ($dmaDevice in $dmaDevices) { New-ItemProperty -Path $regPath -Name $dmaDevice.name -Value $dmaDevice.value -PropertyType String -Force } Great, we have to a way to add in these exceptions, but as they are exceptions, we should be more sniper and less shotgun. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:2:1","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#registry-settings"},{"categories":["windows"],"content":" 2.2 Device Model QueriesInstead of this blanket set of new registry items assigned to all devices, which from a security stance isn‚Äôt the best look, we should make sure that make and model specific settings are applying. Instead of having the create many many Dynamic Device Groups in Entra for each make and model, we can achieve this granularity of model specific settings by using a quick (Get-WmiObject -Class:Win32_ComputerSystem).Model to pull back the model of the device, before we start fiddling with its registry. PowerShell $dmaDevices = @() $deviceModel = (Get-WmiObject -Class:Win32_ComputerSystem).Model if ($deviceModel -in 'Latitude 1', 'Latitude 2') { $dmaDevices += [pscustomobject]@{name = 'Intel(R) LPC Controller - 519D'; value = 'PCI\\VEN_8086\u0026DEV_519D'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #10 - 51B1'; value = 'PCI\\VEN_8086\u0026DEV_51B1'} } elseif ($deviceModel -in 'Lenovo 1', 'Lenovo 2') { $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #20 - A343'; value = 'PCI\\VEN_8086\u0026DEV_A343'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #9 - A330'; value = 'PCI\\VEN_8086\u0026DEV_A330'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) Xeon(R) E3 - 1200/1500 v5/6th Gen Intel(R) Core(TM) PCIe Controller (x16) - 1901'; value = 'PCI\\VEN_8086\u0026DEV_1901'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #15 - A336'; value = 'PCI\\VEN_8086\u0026DEV_A336'} } The if and subsequent elseif statements allow us to ensure that only the DMA exceptions per model, or groups of models, are going to be applied, with the statement allowing for a lookup of multiple models using the -in operator. So if you have multiple models with the same PCI\\VEN_8086\u0026DEV_A30D exception for example, these can be grouped together. Nice eh? ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:2:2","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#device-model-queries"},{"categories":["windows"],"content":" 3 PowerShell ExampleCombining both the device model logic, and the creation of new registry items in the correct location, we have the below, which can act as a template or example for the rest of your devices with these issues. Set-BitLockerDMAExceptions.ps1 # Allow for silent and automatic BitLocker Encryption # https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-bitlocker#un-allowed-dma-capable-busdevices-detected $regPath = 'HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses' $dmaDevices = @() $devicesLenovo = @('20UACTO1WW', '20KG0005AU') $devicesDell = @('Latitude 7320','Latitude 5320') $devicesHP = @('HP EliteBook 8540p') Try { $deviceModel = (Get-WmiObject -Class:Win32_ComputerSystem).Model if ($deviceModel -in $devicesDell) { $dmaDevices += [pscustomobject]@{name = 'Intel(R) LPC Controller - 519D'; value = 'PCI\\VEN_8086\u0026DEV_519D'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #10 - 51B1'; value = 'PCI\\VEN_8086\u0026DEV_51B1'} } elseif ($deviceModel -in $devicesLenovo) { $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #20 - A343'; value = 'PCI\\VEN_8086\u0026DEV_A343'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #9 - A330'; value = 'PCI\\VEN_8086\u0026DEV_A330'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) Xeon(R) E3 - 1200/1500 v5/6th Gen Intel(R) Core(TM) PCIe Controller (x16) - 1901'; value = 'PCI\\VEN_8086\u0026DEV_1901'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #15 - A336'; value = 'PCI\\VEN_8086\u0026DEV_A336'} } elseif ($deviceModel -in $devicesHP ){ $dmaDevices += [pscustomobject]@{name = 'PCI Express Upstream Switch Port - 15EF'; value = 'PCI\\VEN_8086\u0026DEV_15EF'} $dmaDevices += [pscustomobject]@{name = 'Intel(R) PCI Express Root Port #17 - A340'; value = 'PCI\\VEN_8086\u0026DEV_A340'} } foreach ($dmaDevice in $dmaDevices) { New-ItemProperty -Path $regPath -Name $dmaDevice.name -Value $dmaDevice.value -PropertyType String -Force } Exit 0 } Catch { Write-Error $_.ErrorDetails Exit 1 } This can be modified based on your own device estate, grouping devices by manufacturer or model, or just by which exceptions need to be made. Info You can update or modify the variables used for each of the manufacturers $devicesLenovo, $devicesDell, and $devicesHP, as the likelihood is that you may need more granularity across the manufacturers. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:3:0","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#powershell-example"},{"categories":["windows"],"content":" 3.1 Script TestingNow as the registry key has restrictive permissions, you can modify these manually for testing as per the article, or you can use PsExec to run PowerShell as SYSTEM using PsExec.exe -s -i powershell.exe. Allowing you to test locally on devices before deploying using Microsoft Intune, and with a bit of luck, you should see something like the below: Registry settings showing DMA Exception values. After successful testing, you‚Äôre now ready to deploy this as a Platform Script in Microsoft Intune, using the below configuration. Item Detail Name BitLocker DMA Exceptions Description https://memv.ennbee.uk/posts/bitlocker-dma-exceptions/ PowerShell script Set-BitLockerDMAExceptions.ps1 Run this script using the logged on credentials No Enforce script signature check No Run script in 64 bit PowerShell Host Yes Included groups Dynamic Autopilot Group Now your devices should happily encrypt with BitLocker automatically, without hitting one of these DMA exceptions. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:3:1","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#script-testing"},{"categories":["windows"],"content":" 4 SummaryOnce you‚Äôve captured the DMA exceptions of devices failing to automatically encrypt with BitLocker, along with the model of device that is effected, you can update the PowerShell script, taking care with the model names, this can then be deployed using Microsoft Intune to a dynamic group of Windows Autopilot devices. As we‚Äôve gone to the effort of being specific with our exceptions, in the event that a device model is not in the list, then nothing will happen, but if a model is in the list of effected devices, the registry will get updated, and BitLocker will stop being a little whinge about not being able to start encryption due to some kind of security issue. ","date":"16 March 2024","objectID":"/posts/bitlocker-dma-exceptions/:4:0","series":null,"tags":["intune","bitlocker","powershell","security","dma"],"title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","uri":"/posts/bitlocker-dma-exceptions/#summary"},{"categories":["intune"],"content":"Creating Microsoft Intune reusable firewall settings groups using PowerShell and Graph with the Microsoft Online web service for network endpoints.","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/"},{"categories":["intune"],"content":"If you‚Äôve been living under a rock, or you don‚Äôt have to deal with firewall and proxy requirements for accessing Microsoft Online services, you probably won‚Äôt be aware that Microsoft publish their URLs and IP addresses for their services using a web service. Sadly I don‚Äôt live under a rock, and when I get the pleasure working with customers who are blocking all inbound and outbound traffic from Windows devices unless there is a matching firewall rule, getting these devices to talk to Microsoft Intune and other Microsoft services, can be a bit of a pain without the web service as a reference. Now because I‚Äôm desperate to write PowerShell scripts there is no way I‚Äôm going to copy paste a million times between an actual queryable web service and Microsoft Intune to create the necessary firewall rules. Let‚Äôs look at how we can leverage the web service to create some much needed firewall settings. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:0:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#"},{"categories":["intune"],"content":" 1 Reusable Settings GroupsSo here we are, back looking at Defender Windows firewall rules in Microsoft Intune again, and after moving legacy firewall rules to the Settings Catalog versions previously, to make use of Reusable Settings Groups, we‚Äôre now heavily leaning into these reusable options, to ensure that all Windows 10 and later devices can communicate successfully to the Microsoft Online endpoints. Before we look at how to deal with the data available in the Microsoft web service, we should look at how we can create these reusable settings groups in Microsoft Intune using Graph, and make use of the option to auto resolve URLs, which should make life a little bit easier for the ever changing internet landscape. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:1:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#reusable-settings-groups"},{"categories":["intune"],"content":" 1.1 JSON FormattingWe at least have experience dealing with building the JSON structure required for Settings Catalog profiles previously, and it wasn‚Äôt particularly straight forward, so after a hesitant dig with Developer Tools we can see that when you create a new reusable setting in Microsoft Intune, we‚Äôre sending a POST call to the deviceManagement/reusablePolicySettings endpoint, with JSON similar to the below. JSON { \"displayName\": \"ReusableTest\", \"description\": \"My very first reusable group.\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\", \"settingInstance\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\", \"groupSettingCollectionValue\": [ { \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"value\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_true\", \"children\": [] } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\", \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"memv.ennbee.uk\" } } ] }, { \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"value\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_false\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingCollectionInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_addresses\", \"simpleSettingCollectionValue\": [ { \"value\": \"8.8.8.8\", \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\" } ] } ] } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\", \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"Google DNS\" } } ] } ] }, \"@odata.type\": \"#microsoft.graph.deviceManagementReusablePolicySetting\" } Comparing this with the created reusable group below, we can see that each children section of the JSON structure is looking after each of created items. Reusable firewall settings in Microsoft Intune. With a single children section for each auto resolve URL, and one section containing each of the IP addresses, and luckily for us, the structure of the JSON is the same whether it‚Äôs the first setting in the list or the last, bar a trailing ,. Let‚Äôs look at how we can use PowerShell to build out our JSON structure for a reusable settings group. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:1:1","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#json-formatting"},{"categories":["intune"],"content":" 1.2 Building the JSON FormatThis one looks a lot less of a headache compared to building Settings Catalog JSON structures, with hopefully minimal logic needed to distinguish the first and subsequent settings, and very few variables to handle and pass in, to allow the creation of our very own reusable settings group containing all the URLs and IP addresses from the Microsoft web service. We can break down the whole JSON structure into $*JSON variable sections that can be updated with subsequent variables when processing the captured data from the web service: $startJSON - Looking at the start of the JSON, this section won‚Äôt change between reusable groups other than for $displayName and $description,which we can pass variables into for each. $urlJSON - For groups that contain either multiple URLs, or URLs and IPs, we‚Äôre going to have to build in some logic to deal with the trailing , for the initial URL, but for now let‚Äôs ignore that and focus on just adding in the $url variable to this section of the JSON. $ipStartJSON - With IP addresses, they are all contained within a single section, similar to each URL, so we need to create the JSON structure for the start of the IP section. $ipJSON - This is where we can add our IP addresses, with one IP per section, being added to the JSON using the $ip variable. Similar to having multiple URLs, we‚Äôll need to loop through all IP addresses and ensure that each IP has the required JSON format. $ipEndJSON - After we captured all the IP addresses, and the relevant JSON structure, we just need to tail off the full set of IP addresses with a closing structure like below. Apparently the IP address group needs an identity, which we can pass in using the variables $ipName. $endJSON - Finally to round off the full JSON structure, we need to complete the format with the required @odata.type value. In a very straightforward way, we can build out a similar JSON structure compared to the one we initially captured using the Developer Tools, but using PowerShell, combing each of the $*JSON variables. PowerShell $displayName = 'Test Reusable Group' $description = ' My very second reusable group' $url = '*.ennbee.uk' $ip = '1.1.1.1' $ipsName = 'OneOneOneOne DNS' $startJSON = @\" { \"displayName\": \"$displayName\", \"description\": \"$description\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\", \"settingInstance\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\", \"groupSettingCollectionValue\": [ \"@ $urlJSON = @\" { \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"value\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_true\", \"children\": [] } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\", \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$url\" } } ] }, \"@ $ipStartJSON = @' { \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"value\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_false\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingCollectionInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_add","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:1:2","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#building-the-json-format"},{"categories":["intune"],"content":" 2 Microsoft Network Endpoint Web ServiceAs we now have a way to create the reusable group settings, albeit basic, we should look at how we get the network endpoints for Microsoft services from the web service. As Microsoft actually gives you example commands to query the web service and pull back the URLs and IP addresses for each service area, we can use this data and pass it into our newfound ability to create the required firewall settings. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:2:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#microsoft-network-endpoint-web-service"},{"categories":["intune"],"content":" 2.1 Capturing Network EndpointsUsing the examples as a start, we can query the web service with an Invoke-MgGraphRequest, and because I‚Äôm nice, we‚Äôre going to allow the modification of the uri in the request based on user selected values from the options available in the documentation, along with a generated UUID for the request. PowerShell ... [ValidateSet('Worldwide', 'China', 'USGovDoD', 'USGovGCCHigh')] [String]$instance = 'Worldwide', [String]$tenantName, [ValidateSet('Common', 'MEM', 'Skype', 'Exchange', 'SharePoint')] [String[]]$serviceAreas = @('Common', 'MEM', 'Skype', 'Exchange', 'SharePoint') foreach (serviceArea in serviceAreas) { $webService = (\"https://endpoints.office.com/endpoints/$instance`?`TenantName=$tenantName`\u0026`ServiceAreas=$serviceArea`\u0026`clientrequestid=\" + ([GUID]::NewGuid()).Guid) $endpointSets = (Invoke-MgGraphRequest -Uri $webService) | Where-Object { $_.serviceArea -eq $serviceArea } } Because I love Microsoft Intune, we‚Äôll have a sneak peak at the output of $endpointSets for the MEM serviceArea, and guess what? We now have all the URLs, IP addresses, and required ports needed for successful communication for all clients. txt id : 163 serviceArea : MEM serviceAreaDisplayName : Microsoft Endpoint Manager urls : {*.manage.microsoft.com, manage.microsoft.com} ips : {13.67.13.176/28, 13.67.15.128/27, 13.69.67.224/28, 13.69.231.128/28‚Ä¶} tcpPorts : 80,443 expressRoute : False category : Allow required : True id : 164 serviceArea : MEM serviceAreaDisplayName : Microsoft Endpoint Manager urls : {*.delivery.mp.microsoft.com, *.prod.do.dsp.mp.microsoft.com, *.update.microsoft.com, *.windowsupdate.com‚Ä¶} tcpPorts : 443 expressRoute : False category : Default required : True Great, all done, time to move on as all your network endpoints obviously exist in this web service right Microsoft? Nope. Some network endpoints were previously published and haven‚Äôt been included in the Microsoft 365 IP Address and URL Web Service. The web service publishes network endpoints that are required for Microsoft 365 connectivity across an enterprise perimeter network. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:2:1","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#capturing-network-endpoints"},{"categories":["intune"],"content":" 2.2 Additional Network EndpointsNot to worry, we can add any custom network endpoints and their associated URLs and IPs, and throw that at an array variable $reusableSettings, so for Microsoft Stream we‚Äôve got something like the below. PowerShell $reusableSettings = @() $urlsStream = @( '*.cloudapp.net', '*.api.microsoftstream.com', '*.notification.api.microsoftstream.com', 'amp.azure.net', 'api.microsoftstream.com' 'az416426.vo.msecnd.net', 's0.assets-yammer.com', 'vortex.data.microsoft.com', 'web.microsoftstream.com' ) $reusableSettings += [pscustomobject]@{displayName = 'Microsoft Stream URLs'; description = 'Network Endpoints for Microsoft Stream on TCP Ports(s) 80,443'; urls = $urlsStream; ips = $null; ipsName = $null } I‚Äôve got you covered for the other network endpoints mentioned in that article that don‚Äôt exist in the web service, such as the Support and Recovery endpoints, the Windows Store, and anything else I could think of for Microsoft Intune, Windows Autopilot, and Office 365 Apps. Moving on swiftly. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:2:2","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#additional-network-endpoints"},{"categories":["intune"],"content":" 3 Processing the Network EndpointsWith our network endpoints in the web service, and those not in the web service captured, we can now process the endpoints into something we can reuse to create the setting in Microsoft Intune. We can group these in a couple of ways. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:3:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#processing-the-network-endpoints"},{"categories":["intune"],"content":" 3.1 Grouping by Service AreaThis one is easy-ish, and we can group the URLs and IP addresses by service area, ignoring any particular port requirement. So if you‚Äôre after a relatively open locked-down Windows Firewall, this one‚Äôs for you, at the end of the day, we should trust Microsoft at least a little bit. Short of handling the data we‚Äôve captured and creating the variables we know we need to create the JSON content, ensuring that we‚Äôre not duplicating either URLs or IPs (Microsoft Intune will complain about duplicates if you try and do this manually, so I assume Graph will throw a wobbly too), and the wonderful kicker that is a single reusable group not having more than 100 items, we can process the data into a the $reusableSettings array variable ready for processing later. PowerShell $reusableSettings = @() $urls = $endpointSets.urls | Sort-Object | Get-Unique $ips = $endpointSets.ips | Sort-Object | Get-Unique $name = $endpointSets.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + ' URLs and IPs' $description = \"All URL and IP Network Endpoints for $name\" $ipsName = \"IP Addresses for $name\" # Plus one as IPs only count as a single setting if (($urls.Count + 1) -le 100) { $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } else { $displayName = $name + ' IPs' $description = \"IP Network Endpoints for $name\" $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $null; ips = $ips; ipsName = $ipsName } $counter = [pscustomobject] @{ Value = 0 } $groupSize = 100 $urlSubSets = $urls | Group-Object -Property { [math]::Floor($counter.Value++ / $groupSize) } foreach ($urlSubSet in $urlSubSets) { $displayName = $name + ' URLs ' + $urlSubSet.Name $description = \"URL Network Endpoints for $name\" $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urlSubSet.Group; ips = $null; ipsName = $null } } } Info I got around the 100 item limit, by punting IP addresses into one pscustomobject, and splitting the URLs into separate ones using a bit of quick maths, if the number of URLs in urls.Count plus the single IP address item is greater than 100. Sticking with my love/hate affair with Microsoft Intune, we can look at the content stored in the $reusableSettings variable for MEM. TXT displayName : Microsoft Endpoint Manager URLs and IPs description : All URL and IP Network Endpoints for Microsoft Endpoint Manager urls : {*.delivery.mp.microsoft.com, *.dl.delivery.mp.microsoft.com, *.do.dsp.mp.microsoft.com, *.emdl.ws.microsoft.com‚Ä¶} ips : {104.46.162.96/27, 13.67.13.176/28, 13.67.15.128/27, 13.69.231.128/28‚Ä¶} ipsName : IP Addresses for Microsoft Endpoint Manager Perfect, we now have all we need to create reusable groups based on service, though if you‚Äôre fond of the more restrictive firewall rule keeping reading. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:3:1","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#grouping-by-service-area"},{"categories":["intune"],"content":" 3.2 Grouping by PortsThis is where it get‚Äôs a little more interesting, as you‚Äôd think there would be some consistency with the format of the string of ports contained in the tcpPorts and udpPorts values coming from the web service, there is not, so we need a way to deal with values essentially being the same, so 80, 443 and 443, 80, which, are, the, same. Please fix this Microsoft. Either way, with a bit of string bashing and a dirty .Foreach loop, we can reformat the tcpPorts and udpPorts values, keeping them in the same $endpointSets variable, so we can unify URLs and IP addresses where the port requirements are exactly the same. PowerShell $reusableSettings = @() $endpointSets.ForEach({ if ($_.tcpPorts) { $_.tcpPorts = $(($_.tcpPorts.Replace(' ', '').Split(',') | Sort-Object) -join ',') } if ($_.udpPorts) { $_.udpPorts = $(($_.udpPorts.Replace(' ', '').Split(',') | Sort-Object) -join ',') } }) $tcpSets = $endpointSets | Group-Object tcpPorts foreach ($tcpSet in $tcpSets) { $urls = $tcpSet.Group.urls | Sort-Object | Get-Unique $ips = $tcpSet.Group.ips | Sort-Object | Get-Unique $tcpPorts = $tcpSet.Name $name = $tcpSet.Group.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + ' URLs and IPs' + ' TCP ' + $tcpPorts $description = \"All URL and IP Network Endpoints for $name on TCP Port(s) $($tcpSet.Name)\" $ipsName = \"IP Addresses for $name\" $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } $udpSets = $endpointSets | Where-Object { $null -ne $_.udpPorts } | Group-Object udpPorts foreach ($udpSet in $udpSets) { $urls = $udpSet.Group.urls | Sort-Object | Get-Unique $ips = $udpSet.Group.ips | Sort-Object | Get-Unique $udpPorts = $udpSet.Name $name = $udpSet.Group.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + ' URLs and IPs' + ' UDP ' + $udpPorts $description = \"All URL and IP Network Endpoints for $name on UDP Port(s) $($udpSet.Name)\" $ipsName = \"IP Addresses for $name\" $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } Info There are some endpoints that have no TCP port or UDP port requirements, so instead of just releasing them into the wild, I‚Äôve kept them in the TCP scope, as I thought they‚Äôd be more useful there. So with that, we now have our URLs and IP addresses grouped by their port requirements into the $reusableSettings array variable, ready for processing; you know, for the more secure manager of Windows Firewalls. TXT displayName : Microsoft Endpoint Manager URLs and IPs TCP 3544,443,7680,80 description : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 3544,443,7680,80 urls : {*.dl.delivery.mp.microsoft.com, *.do.dsp.mp.microsoft.com, *.emdl.ws.microsoft.com, emdl.ws.microsoft.com} ips : ipsName : IP Addresses for Microsoft Endpoint Manager displayName : Microsoft Endpoint Manager URLs and IPs TCP 443 description : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 443 urls : {*.delivery.mp.microsoft.com, *.monitor.azure.com, *.notify.windows.com, *.prod.do.dsp.mp.microsoft.com‚Ä¶} ips : ipsName : IP Addresses for Microsoft Endpoint Manager displayName : Microsoft Endpoint Manager URLs and IPs TCP 443,80 description : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 443,80 urls : {*.manage.microsoft.com, manage.microsoft.com} ips : {104.46.162.96/27, 13.67.13.176/28, 13.67.15.128/27, 13.69.231.128/28‚Ä¶} ipsName : IP Addresses for Microsoft Endpoint Manager displayName : Microsoft Endpoint Manager URLs and IPs UDP 123 description : All URL and IP Network Endpoints for Microsoft Endpoint Manager on UDP Port(s) 123 urls : {time.windows.com, www.msftconnecttest.com, www.msftncsi.com} ips : ipsName : IP Addresses for Microsoft Endpoint Manager Don‚Äôt worry, we‚Äôre near the bit you actually care about, the script","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:3:2","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#grouping-by-ports"},{"categories":["intune"],"content":" 4 Deploying Reusable Groups of Firewall SettingsI won‚Äôt go into the ins and outs of the horrendous logic I used to create the correct JSON structure for multiple URLs, but you can dig through the script yourself if you are that way inclined. I will walk you through running the script, as this is the payoff to all of this. You can run the script using the below as a reference, which will: Authenticate to Graph using the Microsoft.Graph PowerShell module (No more MSAL.PS module for me). Connect to the web service for your selected instance (If you don‚Äôt select an instance it will default to Worldwide) Create reusable groups for Microsoft Online services (All services are selected by default unless you specify items in the serviceAreas parameter). Group the reusable groups by the service area or by ports (groupBy parameter). Pass through the tenantName parameter into any URL that supports it (think the SharePoint and OneDrive URLs). ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:4:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#deploying-reusable-groups-of-firewall-settings"},{"categories":["intune"],"content":" 4.1 Deploying Service Area Based SettingsTo add the reusable settings grouped by the serviceArea for all services in scope, use the below as an example: PowerShell .\\Invoke-MgReusableFirewall.ps1 -tenantId '45019fd4-a342-4d98-9126-1b6f94904ac7' -tenantName 'ennnbeee' -instance Worldwide -groupBy 'service' All being well the script will go do it‚Äôs thing and create the settings in Microsoft Intune for you: Script created reusable firewall settings grouped by service area. It did, well done Microsoft Intune :clapping_hands:. Digging into the Microsoft Endpoint Manager URLS and IPs setting, we can see that the URLs are and IP addresses are now contained within the reusable setting. Script created reusable firewall settings grouped by service area for IP Addresses. Take my word for it, or use the script, to see the other reusable settings. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:4:1","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#deploying-service-area-based-settings"},{"categories":["intune"],"content":" 4.2 Deploying Port Based SettingsTo add the reusable settings grouped by the tcpPorts and udpPorts for all services in scope, use the below as an example: PowerShell .\\Invoke-MgReusableFirewall.ps1 -tenantId '45019fd4-a342-4d98-9126-1b6f94904ac7' -tenantName 'ennnbeee' -instance Worldwide -groupBy 'ports' And after the script works out what to do with all the values, we get the below in Microsoft Intune: Script created reusable firewall settings grouped by network port. Now looking at the Exchange Online URLs and IPs TCP 143,587,993,995 setting, again all required URLs and IP addresses have been added to the group. Script created reusable firewall settings IP addresses grouped by network port. Brilliant, no more copy/paste for me, or in fact, you. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:4:2","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#deploying-port-based-settings"},{"categories":["intune"],"content":" 5 SummaryWith the reusable firewall settings now in place in Microsoft Intune after being deployed using the script, you can use these groups in existing or new firewall rules policies that support reusable settings, allowing you to either configure a blanket allow all for the service areas, or be more specific and allow only the port requirements for each service area based on data provided by Microsoft in their web service. I would look at how to automatically create these firewall rule policies automatically, but I‚Äôm still scared of dealing with the logic behind creating them from last time, but at least you‚Äôre not having to copy and paste URls and IP addresses for Microsoft Online services into Microsoft Intune any more. ","date":"9 March 2024","objectID":"/posts/resusable-firewall-settings-microsoft-online/:5:0","series":null,"tags":["windows","security","powershell","graph","settings catalog","firewall","automation","endpoint security"],"title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","uri":"/posts/resusable-firewall-settings-microsoft-online/#summary"},{"categories":["windows"],"content":"Deploying Windows Updates using dynamic security groups in a phased and controlled approach using Microsoft Intune and Entra ID.","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/"},{"categories":["windows"],"content":"So this isn‚Äôt the first time we‚Äôve looked at improving the management of updates using Microsoft Intune, and probably won‚Äôt be the last time either, especially with declarative device management looming, for Apple and hopefully Windows devices, covering configuration of software updates. But with the introduction of the Windows Autopatch service, and getting hands on with it recently, it prompted me to revisit my previous approach to phased update delivery, so I thought I‚Äôd share my findings, this time across not just Windows Updates. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:0:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#"},{"categories":["windows"],"content":" 1 Deployment ApproachPreviously, we configured a set of four Update Rings, but now we‚Äôll include an early adopters ring as a pre-production release, kind of a fail safe prior to your production deployment of updates; that final catch before you target the entire device estate: Test - This should be devices that are dedicated for testing, ~1% of your device estate. Pilot - This should be a stratified sample of either users or devices, ~5% of your device estate. Pre-Production - The early adopters deployment, ~15% of your device estate. Initial Production - The first production deployment, ~30% of your device estate. Final Production - The final production deployment, the remaining ~50% of the device estate. The aim is tht the above groupings are reusable and can be used across not just Windows Updates, but Office Updates, and Driver updates too. Let‚Äôs look at the membership of these groups. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:1:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#deployment-approach"},{"categories":["windows"],"content":" 2 Deployment GroupsDespite Microsoft recommending to stop using the match operators in favour of startsWith there are times when you might have to ignore them, this could be one of those times when we look at how we split a device estate into the phased breakdowns we‚Äôre looking to achieve. Note After testing this in the real world, with reset Autopilot Hybrid join devices, you end up with a little bit of conflict on group membership due to there being two computer objects in Entra. To avoid this, I‚Äôve added in (device.deviceManagementAppId -ne null) to the group rules, only capturing those devices that are actually enrolled in Microsoft Intune. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:2:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#deployment-groups"},{"categories":["windows"],"content":" 2.1 Inefficient Dynamic GroupsFor the members of Test and Pilot groups, these should be targeted members, not just any old device, so ensure you populate these groups with true test devices, and suitable pilot devices for update testing. You‚Äôll notice that this time we‚Äôre using Dynamic Groups across all the pre-production and production groups, and using a new attribute of deviceId, which is a wonderful UUID associated with all Entra computer objects, and it being a UUID gives us a nice split of devices based on the queries used. Group Type Membership Test Group Assigned TBC Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and (device.deviceId -match \"^[0-1,a]\") Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and (device.deviceId -match \"^[2-4,b-c]\") Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and (device.deviceId -match \"^[5-9,d-f]\") With the start of the deviceId only ever being in the range of 0-9 or a-f we‚Äôve an easy way to split our devices across the three production level groups, and ensure that we are capturing all devices, using the match operator, and the regular expression similar to ^[0-9,a-f] to detect whether the deviceId starts with one of the values in the ranges provided. Info You may want to tweak the rules used here, to alter the size of each of the production groups, by changing the range of the ^[0-9,a-f] query. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:2:1","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#inefficient-dynamic-groups"},{"categories":["windows"],"content":" 2.2 Efficient Dynamic GroupsIf you want to please Microsoft Daddy, then you could use these alternative queries for the groups, Test and Pilot are still assigned, so don‚Äôt forget to populate those members. Group Type Membership Test Group Assigned TBC Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"0\") or (device.deviceId -startsWith \"1\") or (device.deviceId -startsWith \"a\")) Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"2\") or (device.deviceId -startsWith \"3\") or (device.deviceId -startsWith \"4\") or (device.deviceId -startsWith \"b\") or (device.deviceId -startsWith \"c\")) Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -eq \"Company\") and ((device.deviceId -startsWith \"5\") or (device.deviceId -startsWith \"6\") or (device.deviceId -startsWith \"7\") or (device.deviceId -startsWith \"8\") or (device.deviceId -startsWith \"9\") or (device.deviceId -startsWith \"d\") or (device.deviceId -startsWith \"e\") or (device.deviceId -startsWith \"f\")) Much more efficient. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:2:2","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#efficient-dynamic-groups"},{"categories":["windows"],"content":" 2.3 VIP GroupsWhat about those people who complain about when they‚Äôre getting updates, I mean you could tell them to jog on that you can‚Äôt change the behaviour, or you could cater for the more VIP user, and allow for their device to sit in a different update group. So more assigned groups are required for each potential exception or change to production level deployment options. Group Type Membership VIP Pre-Production Group Assigned TBC VIP Initial Production Group Assigned TBC VIP Final Production Group Assigned TBC See, we can please the senior members of the company with IT solutions. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:2:3","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#vip-groups"},{"categories":["windows"],"content":" 3 Windows Update RingsNow with suitable groups at our disposal, we can create our Windows Update Rings in Microsoft Intune for each of the five phases, and after reviewing and experiencing Windows Update Rings personally instead of just recommending them, I‚Äôve decided to set zero-day installation deadlines, in favour of longer grace periods, still working within the National Cyber Security Centre 14-day window. Update Ring Deferral Deadline Grace Period Updates Installed Test 0 days 0 days 1 day After 1 day, Wednesday Pilot 2 days 0 days 1 day After 3 days, Friday Pre-Production 5 days 0 days 2 days After 7 days, Tuesday Initial Production 8 days 0 days 2 days After 10 days, Friday Final Production 11 days 0 days 3 days After 14 days, Tuesday You see something else new? Yes, I‚Äôve avoided device restarts on weekends following a chat with fellow lover of Microsoft Intune, Jonathan Fallis, meaning that for a weekday based ‚Äòworking week‚Äô, updates get installed and devices restarted when the device is actually on, not over a weekend when realistically the device is still in the office and powered off, or being used to watch Netflix in bed. This also allows for our VIP users to pick which day they actually want their device to restart, based on whatever day they‚Äôre not playing golf üèåÔ∏è‚Äç‚ôÄÔ∏è. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:3:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#windows-update-rings"},{"categories":["windows"],"content":" 4 Office Update RingsOooooh this one is new, and straight up robbed from Windows Autopatch, and although doesn‚Äôt exist as a dedicated blade in Microsoft Intune, we can use the glorious Settings Catalog profiles to configure Office Update Channels, deferral, and deadline settings for Microsoft 365 App updates. To start, we need to configure some baseline Office Update settings. So go create yourself a new Settings Catalog profile, and throw the below settings into it. Category Setting Value Microsoft Office 2016 (Machine) \u003e Updates Location for updates: (Device) http://officecdn.microsoft.com/pr/55336b82-a18d-4dd6-b5f6-9e5095c314a6 Microsoft Office 2016 (Machine) \u003e Updates Enable Automatic Updates Enabled Microsoft Office 2016 (Machine) \u003e Updates Hide option to enable or disable updates Enabled Microsoft Office 2016 (Machine) \u003e Updates Hide Update Notifications Disabled Microsoft Office 2016 (Machine) \u003e Updates Update Channel Enabled Microsoft Office 2016 (Machine) \u003e Updates Channel Name (Device) Monthly Enterprise Channel Microsoft Office 2016 (Machine) \u003e Updates Update Path Enabled With the update channel configured to Monthly Enterprise, and a bit of a change to the user experience, let‚Äôs see what else we can borrow from Windows Autopatch. Info Make sure you assign this to all your devices in scope of updates, using either an existing group, or the built in ‚ÄòAll Devices‚Äô group and a suitable Device Filter. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:4:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#office-update-rings"},{"categories":["windows"],"content":" 4.1 Phased Office UpdatesWith a similar approach to the Windows Update Rings, we can create corresponding Settings Catalog profiles for our five deployment phases, aligning as best we can the end result, which is installed updates, to the restart of the updates delivered as part of the Windows Update ring configuration. All settings exist under the same category as before, Microsoft Office 2016 (Machine) \u003e Updates. Update Ring Delay downloading and installing updates for Office Days: (Device) Update Deadline Deadline: (Device) Updates Installed Test Enabled 0 Enabled 1 After 1 day, Wednesday Pilot Enabled 2 Enabled 1 After 3 days, Friday Pre-Production Enabled 5 Enabled 2 After 7 days, Tuesday Initial Production Enabled 8 Enabled 2 After 10 days, Friday Final Production Enabled 11 Enabled 3 After 14 days, Tuesday As Office Updates are released with the same update cadence as our normal updates on a ‚ÄòPatch Tuesday‚Äô, then the installation time falls on the same days, meaning that all updates should be installed and the device restarted on the same day, reducing overall disruption to the users. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:4:1","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#phased-office-updates"},{"categories":["windows"],"content":" 5 Update Ring AssignmentAfter creating the Windows Update Rings, and our faux Office Update Rings using the above settings, we cover how we assign our phased deployment groups to each suitable Update Ring. Info Feel free to alter the deferral, deadline, and grace periods where applicable to your device estate, but please if you want the experience to be as expected, use the below assignment targets. Update Ring Included Groups Excluded Groups Test Test Group - Pilot Pilot Group Test Group Pre-Production Pre-Production Group Test Group, Pilot Group Initial Production Initial Production Group Test Group, Pilot Group Final Production Final Production Group Test Group, Pilot Group I‚Äôm assuming here that you aren‚Äôt putting VIP user devices in Test and Pilot, because you don‚Äôt want to anger them, maybe do it on your last day . Info This is an improvement on our previous version of Update Ring assignment, as we‚Äôre not relying on excludes and dynamic groups to update to ensure there are no conflicts. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:5:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#update-ring-assignment"},{"categories":["windows"],"content":" 5.1 VIP Ring AssignmentTo get the expected behaviour for our VIP groups, we need to consider what happens when we want to ensure a VIP device is in the correct Update Ring, which includes making sure there are no conflicts across the rings. Changing the assignments of our Update Rings to the below, will allow for the manual assignment based on a devices VIP group membership. Update Ring Included Groups Excluded Groups Test Test Group - Pilot Pilot Group Test Group Pre-Production Pre-Production Group, VIP Pre-Production Test Group, Pilot Group, VIP Initial Production, VIP Final Production Initial Production Initial-Production Group, VIP Initial-Production Test Group, Pilot Group, VIP Pre-Production, VIP Final Production Final Production Final Production, VIP Final Production Test Group, Pilot Group, VIP Pre-Production, VIP Initial Production For example if device name VIP-7wa7f4c35, with deviceId ec759183-4492-44f4-a2ec-dbc33470bf48 (which will captured by the ‚ÄòFinal Production‚Äô dynamic group), is added to group VIP Initial Production, it will exclude the device from the ‚ÄòFinal Production‚Äô Update Ring, and assign the Update Ring for ‚ÄòInitial Production‚Äô, with the device restarting after updates on a Friday. Adding in not only new include assignments, but exclude assignments, will ensure that devices in these groups are assigned to the correct Update Ring. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:5:1","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#vip-ring-assignment"},{"categories":["windows"],"content":" 6 SummaryAll of this should give you the option to not only suitably phase Windows, Microsoft, and Office Updates, with each subsequent Update Ring starting only after the next, but also allow the shift of devices around without conflict, whether this is for VIP users or otherwise. It also provides your end users with clear details of the days of when their device will not only get updated, but also restart, without too much of a headache, or interruption to their casual personal use of their corporate owned device. ","date":"19 February 2024","objectID":"/posts/flexible-update-deployments/:6:0","series":null,"tags":["updates","dynamic groups","security","ncsc"],"title":"A Flexible Approach to Microsoft Update Deployments","uri":"/posts/flexible-update-deployments/#summary"},{"categories":["macos"],"content":"Deploying Microsoft Teams backgrounds for macOS using Shell scripts in Microsoft Intune for both the classic and new versions of the application.","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/"},{"categories":["macos"],"content":"This isn‚Äôt the first time we‚Äôve looked at deploying backgrounds for Microsoft Teams on macOS, but it‚Äôs been a while since we answered an internet strangers question, and hopefully my scripting has come on a little way since then (spoiler: it hasn‚Äôt). Now that the ‚ÄòNew‚Äô Microsoft Teams app is the de facto version available to download from Microsoft replacing the ‚ÄòClassic‚Äô one, we should at least look at how it handles uploaded backgrounds and if required update our existing script to support not only the ‚ÄòClassic‚Äô version, but the ‚ÄòNew‚Äô version too. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:0:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#"},{"categories":["macos"],"content":" 1 Application DifferencesBefore we go digging into the existing script to work out what has broken with the new version of app, we should check to see what, if any differences there are across both version for the purpose of our script. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:1:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#application-differences"},{"categories":["macos"],"content":" 1.1 Uploaded Background LocationsDigging around the internet, and on a macOS device with both apps installed, we can see that uploaded backgrounds from the client itself are stored in the below locations: Classic App - $HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads New App - $HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads So this is similar to the change in uploaded background location for the Windows version that Florian Salzmann found in their post about updating backgrounds for the new Windows Teams client. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:1:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#uploaded-background-locations"},{"categories":["macos"],"content":" 1.2 Application NameAnother thing to note, is how we were detecting whether the Teams app was installed, referencing the app name, which has also changed, only slightly though but it is still a change: Classic App - Microsoft Teams classic.app New App - Microsoft Teams (work or school).app Great, so we need to take into account the file path change, and the app name change. Anything else Microsoft? ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:1:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#application-name"},{"categories":["macos"],"content":" 1.3 Background File NamesYes, obviously. When testing the upload of a background in the ‚ÄòNew‚Äô app, I noticed that the background files are renamed to a UUID and created a thumbnail file of the same background, so something similar to the below. 898ffbba-4997-4911-b2ab-b5d8ef4998d2.png and 898ffbba-4997-4911-b2ab-b5d8ef4998d2_thumb.png OK, so we‚Äôll need a way to generate a UUID whilst we‚Äôre at it. The ‚ÄòClassic‚Äô app doesn‚Äôt care what the files are called, which might be useful. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:1:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#background-file-names"},{"categories":["macos"],"content":" 2 Background Deployment ScriptLet‚Äôs start at least with the existing script and amend or update it to take into consideration the following: Detection of whether a Teams app is installed. Detection of which of the ‚ÄòClassic‚Äô or ‚ÄòNew‚Äô apps is installed. Managing which directory is used for the uploaded backgrounds. Managing the use of a UUID for the background files for the ‚ÄòNew‚Äô app. Not a lot to consider, and with our new found exposure to Shell scripts, we should be more than capable üòê. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#background-deployment-script"},{"categories":["macos"],"content":" 2.1 Variables and LogsAs the uploaded backgrounds will reside within the context of the user signed in to the macOS device, we need to ensure that the script, when running from Microsoft Intune is also running under the user context. This means that the log file stored in path set by the logAndMetaDir variable, must be accessible to the user, hence the choice and use of the built-in variable $HOME. You should update the backGroundUrls array variable with the URLs for the backgrounds you want to use in Microsoft Teams, otherwise everything will look like I branded it. Bash backGroundUrls=(\"https://raw.githubusercontent.com/ennnbeee/ennnbeee.github.io/main/bgr.png\" \"https://raw.githubusercontent.com/ennnbeee/ennnbeee.github.io/main/img/featured.png\") scriptName=\"SetNewTeamsBackgrounds\" logAndMetaDir=\"$HOME/Library/Logs/Microsoft/IntuneScripts/$scriptName\" # Running under the user context log=\"$logAndMetaDir/$scriptName.log\" if [ -d $logAndMetaDir ]; then echo \"# $(date) | Log directory already exists - $logAndMetaDir\" else echo \"# $(date) | Creating log directory - $logAndMetaDir\" mkdir -p \"$logAndMetaDir\" fi We‚Äôre covering off the logic to create the log file directory whilst we‚Äôre at it, so we can at least write the output of the script to a file log in this location. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#variables-and-logs"},{"categories":["macos"],"content":" 2.2 Checking versions of the Teams AppHaving spent a lot of time browsing the shell-intune-samples GitHub repo, and testing a number of these scripts, the Dock script caught my eye, as it was updated to detect which version of Teams is installed when attempting to add it to a Dock configuration. So I‚Äôve taken the existing function, and updated it for our purpose, to not only set the teamsApp variable of the app, but also the teamsUpload variable for the path to the uploaded background folders. Bash function checkAndSetInstalledMSTeamsPath () { if [[ -a \"/Applications/Microsoft Teams.app\" ]];then teamsApp=\"/Applications/Microsoft Teams.app\" teamsUpload=\"$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\" elif [[ -a \"/Applications/Microsoft Teams classic.app\" ]];then teamsApp=\"/Applications/Microsoft Teams classic.app\" teamsUpload=\"$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\" elif [[ -a \"/Applications/Microsoft Teams (work or school).app\" ]]; then teamsApp=\"/Applications/Microsoft Teams (work or school).app\" teamsUpload=\"$HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads\" elif [[ -a \"/Applications/Microsoft Teams (work preview).app\" ]]; then teamsApp=\"/Applications/Microsoft Teams (work preview).app\" teamsUpload=\"$HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads\" fi } We can now call this function to populate the two defined variables, and also detect whether the variable is empty to detect whether Teams is actually installed or not. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#checking-versions-of-the-teams-app"},{"categories":["macos"],"content":" 2.3 Detecting if Teams is InstalledWe‚Äôve configured two variables here, ready and teamsMissing, this allows us to continue the running of the script until Teams is actually detected, and in the event that it is installed, will allow the script to continue. Bash ready=0 while [[ $ready -ne 1 ]];do teamsMissing=0 checkAndSetInstalledMSTeamsPath if [[ -z \"$teamsApp\" ]]; then let teamsMissing=$teamsMissing+1 echo \"$(date) | Microsoft Teams application is missing.\" else echo \"$(date) | Microsoft Teams application is installed.\" fi if [[ $teamsMissing -eq 0 ]]; then ready=1 echo \"$(date) | Microsoft Teams App $teamsApp found, lets download the backgrounds.\" else echo \"$(date) | Waiting for 10 seconds before trying again.\" sleep 10 fi done Ensure that you are deploying one of the app versions to your macOS devices using Microsoft Intune, before deploying the script, otherwise it‚Äôs going to sit there and run in the background. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#detecting-if-teams-is-installed"},{"categories":["macos"],"content":" 2.4 Creating the Uploads DirectoryNow that we‚Äôre on the move the download of the files to the correct background upload directory, we should detect whether the directory exists, and if not create it. Bash if [[ -d ${teamsUpload} ]] then echo \"$(date) | Microsoft Teams Background Upload directory [$teamsUpload] already exists\" else echo \"$(date) | Creating directory [$teamsUpload]\" mkdir -p \"$teamsUpload\" fi For the ‚ÄòClassic‚Äô app, unless you have actually uploaded a background through the client yourself, this directory doesn‚Äôt exist. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:4","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#creating-the-uploads-directory"},{"categories":["macos"],"content":" 2.5 Downloading the BackgroundsAs mentioned, the ‚ÄòNew‚Äô app needs the files stored with UUID filenames, and the ‚ÄòClassic‚Äô app doesn‚Äôt care, as this is the case, we can just use a UUID file name for both scenarios. Generating a UUID on macOS we can use uuidgen, and we‚Äôve converted the output of this command to lowercase, assigning two new variables backgroundFile and backgroundThumb to use the uuid variable in their file name. So looping through each backGroundUrl in the backGroundUrls array, we can go and download the file to the relevant directory, saved with the UUID file name. Bash for backGroundUrl in \"${backGroundUrls[@]}\"; do uuid=$(uuidgen | tr \"[:upper:]\" \"[:lower:]\") backgroundFile=$uuid.png backgroundThumb=${uuid}_thumb.png curl -L -o \"$teamsUpload/$backgroundFile\" $backGroundUrl if [[ $teamsUpload = *Containers* ]];then curl -L -o \"$teamsUpload/$backgroundThumb\" $backGroundUrl fi done We‚Äôve added in logic to detect whether the teamsUpload path variable is for the ‚ÄòNew‚Äô app, and if it is, to download the background file but save it with the require _thumb in the filename. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:2:5","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#downloading-the-backgrounds"},{"categories":["macos"],"content":" 3 Deploying the ScriptWith the script to hand, we can now use Microsoft Intune Shell Scripts to deploy the script to our device estate with the below settings, having uploaded the downloaded file. Setting Value Description Run script as signed-in user Yes The background upload directory is a user directory. Hide script notifications on devices Yes Don‚Äôt tell users things are happening. Script frequency Not Configured We don‚Äôt want the script to run multiple times. Max number of times to retry if script fails 3 times If Teams isn‚Äôt installed and the device is restarted, we need a way to re-run the script. Assign this to a test group of macOS devices that has one of the Microsoft Teams apps installed, otherwise you‚Äôll be waiting a long time to see the results. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:3:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#deploying-the-script"},{"categories":["macos"],"content":" 3.1 Shell Script ResultsOnce a device has checked in to Microsoft Intune, and a user is signed in to the device, the script should run, storing the log file in the location defined in the variable. So for this device it‚Äôs Users/ennbee/Library/Logs/Microsoft/IntuneScripts/SetNewTeamsBackgrounds Log directory. We can now check our test devices, one running the ‚ÄòClassic‚Äô app, and one the ‚ÄòNew‚Äô app to see what has actually happened. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:3:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#shell-script-results"},{"categories":["macos"],"content":" 3.2 ‚ÄòClassic‚Äô Teams ResultsOpening the log file, we can see the results of the script running on a device with the ‚ÄòClassic‚Äô app. Log for Classic Teams. With the files downloaded to the Users/ennbee/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads directory. Having a look in the directory location, we can see that two new files exist, both with UUID based filenames. Backgrounds directory for Classic Teams. Opening ‚ÄòClassic‚Äô Teams, we can now see and use these uploaded backgrounds. Classic Teams showing the backgrounds. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:3:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#classic-teams-results"},{"categories":["macos"],"content":" 3.3 ‚ÄòNew‚Äô Teams ResultsIt‚Äôs a similar story with the ‚ÄòNew‚Äô apps, with the log showing successful download of the backgrounds to Users/ennbee/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads. Log for New Teams. This time we also have the creation of the thumbnail files in the same directory. Backgrounds directory for New Teams. When opening the ‚ÄòNew‚Äô Teams app (notice the icon in the top left), we have the uploaded backgrounds available as well. New Teams showing the backgrounds. Info If the Teams app is already open when the script runs to download the new backgrounds, they won‚Äôt be available until the app is closed and re-opened. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:3:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#new-teams-results"},{"categories":["macos"],"content":" 4 SummaryIt‚Äôs been a while since I‚Äôve had to put together a new Shell script for macOS, but with Microsoft investing more functionality for macOS devices in Microsoft Intune, and with recent updates to the shell-intune-samples GitHub repo, now is a great time to look at how to better manage your macOS device estate using the new tooling and capabilities. Being a personal macOS user, but a professional Windows 11 user, it‚Äôs a pretty exciting time that Microsoft Intune is providing more and more support for macOS devices at an enterprise level. However until there is native ability to deploy backgrounds (for free) to your macOS Teams clients, you‚Äôll have to rely on people like me spending their spare time writing hacky looking Shell scripts üòÖ. ","date":"14 February 2024","objectID":"/posts/macos-teams-new-backgrounds/:4:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","uri":"/posts/macos-teams-new-backgrounds/#summary"},{"categories":["windows"],"content":"Using Microsoft Intune to update Windows Store Apps using PowerShell and remediation scripts.","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/"},{"categories":["windows"],"content":"So we‚Äôre all onboard with the New Microsoft Store, and deploying both UWP and Win32 apps from Microsoft Intune is an absolute breeze, and reduces the effort of deploying applications to a click click next OK exercise. What about the UWP apps that are already installed on a Windows Autopilot device, shouldn‚Äôt we give them a bit of love? If you care at all about users and security you should. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:0:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#"},{"categories":["windows"],"content":" 1 Allowing App UpdatesRegardless of how you are blocking or allowing the Microsoft Store, remembering that the store needs to be available to allow for apps from Microsoft Intune to be deployed, we should at least configure devices to allow for updates. A simple Settings Catalog profile will do the job here, with the below settings configured. Category Setting Value Microsoft App Store Allow apps from the Microsoft app store to auto update Allowed Settings Catalog profile for Microsoft Store. Assign this profile to your devices, all of them obviously, no testing needed here. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:1:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#allowing-app-updates"},{"categories":["windows"],"content":" 2 Forcing App UpdatesThere‚Äôs a lot of chatter about how to force store apps to update, but essentially we can kick off an update using the below Get-CimInstance query. PowerShell Get-CimInstance -Namespace \"Root\\cimv2\\mdm\\dmmap\" -ClassName \"MDM_EnterpriseModernAppManagement_AppManagement01\" | Invoke-CimMethod -MethodName UpdateScanMethod Now as we‚Äôre calling areas that require elevation, standard users are bang out of luck from running this, and even running this elevated as Administrator does absolutely nothing for the apps themselves, something about install context. So what are our options? Well for testing it‚Äôs PsExec. Running the above from PowerShell running as system using PsExec.exe -s -i powershell.exe, we can kick off the app update query. PSEXEC running the store app update command. Nothing much to look at here, but if you‚Äôve got the store open, you should now see updates in the Downloads and Updates section, if you‚Äôre lazy run start ms-windows-store://downloadsandupdates as a standard user to open the correct area of the store. The Microsoft Store updating apps. Brilliant, apps are now trying their hardest to update. Now we‚Äôve got a method to update the apps, no one is going to run this manually on a regular basis, and we love a Microsoft Intune Remediation. Tip This method will only update Store Apps installed in the System context if there is no user signed into the device; for Apps installed in the User context, a user must be signed in for the apps to update. Go figure üòÖ. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:2:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#forcing-app-updates"},{"categories":["windows"],"content":" 3 Remediation SettingsSo now we‚Äôve got a way to start the update of the apps, let‚Äôs find a way to work out if we need to kick off an update. Back to the initial query we created, and if we run the below section of the command, we‚Äôll get an output that we might be able to work with. PowerShell Get-CimInstance -Namespace \"Root\\cimv2\\mdm\\dmmap\" -ClassName \"MDM_EnterpriseModernAppManagement_AppManagement01\" The result of the Get-CimInstance query. Guess what, we do, that LastScanError is looking mighty interesting, and it being Microsoft I bet that an exit code of zero means success, but we should have a look at the reference document just in case. Reports the last error code returned by the update scan. This is a required node. OK, so it isn‚Äôt that clear, but we‚Äôve got a way to detect whether the last update of apps was successful, and with the Settings Catalog policy created earlier we should be keeping apps up to date from then on. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:3:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#remediation-settings"},{"categories":["windows"],"content":" 3.1 Detection ScriptWe can use the above, and a little logic to detect whether the result of the LastScanError is a zero or not, and if it‚Äôs not a zero throw an Exit 1 to allow a remediation to run. Update-StoreApps_Detection.ps1 try { $wmiObj = Get-CimInstance -Namespace \"Root\\cimv2\\mdm\\dmmap\" -ClassName \"MDM_EnterpriseModernAppManagement_AppManagement01\" if ($wmiObj.LastScanError -ne '0') { Write-Output \"Windows Store Apps not updated.\" Exit 1 } else { Write-Output \"Windows Store Apps updated.\" Exit 0 } } catch { Write-Output \"Unable to query Store App Update status.\" Exit 2000 } On to the remediation portion. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:3:1","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#detection-script"},{"categories":["windows"],"content":" 3.2 Remediation ScriptWe‚Äôve already done the ground work with the previous queries to test the update of apps, so this one is very straightforward. Update-StoreApps_Remediation.ps1 Try { Get-CimInstance -Namespace \"Root\\cimv2\\mdm\\dmmap\" -ClassName \"MDM_EnterpriseModernAppManagement_AppManagement01\" | Invoke-CimMethod -MethodName UpdateScanMethod Write-Output \"Windows Store Apps updated.\" Exit 0 } Catch { Write-Output \"Windows Store Apps not updated.\" Exit 2000 } Just make sure we‚Äôre exiting with the correct codes, and giving an explanation, as per the detection script, of the result of the remediation. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:3:2","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#remediation-script"},{"categories":["windows"],"content":" 4 Deploying the RemediationWe‚Äôve seen remediations a handful of times now in this blog, so go ahead and create a new Remediation Script in Microsoft Intune mirroring the below settings. Be aware that we definitely do not want to be running this as the user, we need that glorious system context. Microsoft Intune Remediation Script. I‚Äôve assigned this to All Devices with my beloved Device Filters on a daily schedule, but if you‚Äôre more cautious than I am, assign this to a smaller proof-of-concept group. After a while, you should start seeing the results of the Remediation, and hopefully positive ones to boot. Microsoft Intune Remediation Results. If all goes well, your devices will start actually updating the ‚ÄòBuilt In‚Äô apps you haven‚Äôt ripped out with a PowerShell script, and Microsoft Intune UWP store apps you‚Äôve deployed, though your users may start complaining about the apps looking like they‚Äôre loading in the Start Menu üòÇ. ","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:4:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#deploying-the-remediation"},{"categories":["windows"],"content":" 5 SummaryAll in all a quick and dirty solution to a very simple problem with new Windows Autopilot devices and existing Microsoft Intune managed Windows devices, at least this way they‚Äôll do what they should have done in the first place and just keep themselves updated. If only all the issues I encounter during my days could be solved with a simple Remediation script. Info The detection and remediation scripts are available, as always in my Github Repo.","date":"6 February 2024","objectID":"/posts/windows-updating-store-apps/:5:0","series":null,"tags":["intune","updates","remediation","apps","powershell","windows autopilot","security"],"title":"Keeping Windows Store Apps Updated with Microsoft Intune","uri":"/posts/windows-updating-store-apps/#summary"},{"categories":["windows"],"content":"Using Microsoft Intune Remediation PowerShell scripts to increase the Windows Recovery partition size for KB5034441.","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/"},{"categories":["windows"],"content":"If you‚Äôve been under a rock, or like me, don‚Äôt have to manage updates on a Windows device estate any more, chances are you might not have seen the issues with the size of the Windows Recovery Environment or WinRE, partition when applying Windows Updates like KB5034441, luckily Microsoft released a ‚Äòfix‚Äô for this in KB5028997 to resize the partition to allow for updates to install. Now if this were me, I‚Äôd be looking for a way to push out this fix to the impacted devices, and thanks to u/InternetStranger4You, they created a PowerShell script to do just that, so all credit goes their way. So why I am writing this? Well, let‚Äôs find a way to use Microsoft Intune Remediations, to detect and fix devices that are falling short of the partition size requirement. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:0:0","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#"},{"categories":["windows"],"content":" 1 Detection MethodsTo get ourselves in a good position, we should look at a way to detect that the existing Windows Recovery Environment partition is of a suitable size, from this we can either leave it well alone, or hack at it to increase it‚Äôs size, once, and only once. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:1:0","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#detection-methods"},{"categories":["windows"],"content":" 1.1 First We DetectWorking with the remediation format and capture of information, we can quite simply loop through all physical disks with Get-PhysicalDisk, detecting where one of these disks contains partitions with a ‚ÄòC‚Äô drive (Yes I am assuming here that the disk holding the C drive is holding the Recovery Partition, prove me wrong though), using Get-Partition, and then comparing the size of the disk to our variable in bytes, $partitionSize. and then get the amount of free space available in the volume with Get-Volume, comparing this to our variable for required space $freePartitionSpace. Note The detection method has been updated to detect free space in the Recovery Partition, instead of blindly increasing it by 250MB. Set-WinRE_Detection.ps1 #Recovery Partition free size required for KB5028997 $freePartitionSpace = '250000000' #bytes Try { $computerDisks = Get-PhysicalDisk foreach ($computerDisk in $computerDisks) { $diskPartitions = Get-Partition -DiskNumber $computerDisk.DeviceId -ErrorAction Ignore if ($diskPartitions.DriveLetter -contains 'C' -and $null -ne $diskPartitions) { $systemDrive = $computerDisk } } $recPartition = Get-Partition -DiskNumber $systemDrive.DeviceId | Where-Object { $_.Type -eq 'Recovery' } $recVolume = Get-Volume -Partition $recPartition if ($recVolume.SizeRemaining -le $freePartitionSpace) { Write-Output \"Recovery Partition Free Space $($($recVolume.SizeRemaining) / 1000000) MB is smaller than required $($freePartitionSpace / 1000000) MB\" Exit 1 } else { Write-Output \"Recovery Partition Free Space $($($recVolume.SizeRemaining) / 1000000) MB is larger than required $($freePartitionSpace / 1000000) MB\" Exit 0 } } Catch { Write-Output 'Recovery Partition not found.' Exit 2000 } If the result of the comparison is that the size of the partition is smaller than the 750MB configured in $partitionSize free space of the partition is smaller than the 250MB configured in $freePartitionSpace, then we‚Äôll report the status with Write-Output and Exit 1, otherwise, all is OK so we Exit 0 still reporting something. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:1:1","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#first-we-detect"},{"categories":["windows"],"content":" 1.2 Then We ReportSo, we should see how many devices are effected by a small partition size, so for fun, we can push out just the detection script using a Remediation, but with a non-functioning remediation script. Set-WinRE_ReportRemediation Write-Output \"Reporting Only\" Exit 0 This will at least give you some idea of the devices that would be impacted by the true remediation script. Microsoft Intune Remediation Script for reporting. I‚Äôve assigned this to the All Devices group, but with a Device Filter for only corporate owned devices, set to run once, as we‚Äôre just reporting on this issue for now. Microsoft Intune Remediation assignment for reporting. After waiting a little while, or if you‚Äôre impatient use the on-demand feature, we can then review the results; we can see several devices that are now complaining that their WinRE partition is too small. Microsoft Intune Remediation reporting results. Luckily for us, there are at least some devices where they are happy with the size of their partition. Microsoft Intune Remediation reporting detail. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:1:2","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#then-we-report"},{"categories":["windows"],"content":" 2 Remediation MethodsAs we have a good understanding following the implementation of the report only style Remediation, we can now investigate how best to actually fix the issue. For this, we can take the existing script by u/InternetStranger4You and modifying it to support the required exit codes for Microsoft Intune. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:2:0","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#remediation-methods"},{"categories":["windows"],"content":" 2.1 Script BreakdownThe script itself is taking the manual steps detailed by Microsoft in KB5028997, and wrapping them nicely in PowerShell, but I‚Äôll walk through the settings so we‚Äôre all on the same page: Ensures that the script can read the contents of the reagentc.exe command by capture the output of the process using New-Object System.Diagnostics.ProcessStartInfo as the output data is used throughout the script. Checks if there is anything wrong with WinRE with if (($stdout.IndexOf('harddisk') -ne -1) -and ($stdout.IndexOf('partition') -ne -1)), and if so exits. Disables the recovery environment Start-Process 'reagentc.exe' -ArgumentList '/disable' -Wait -NoNewWindow to allow for modification to the partition. Captures information about the Disk the Recovery partition sits on, and the partition itself. Resizes the partition beneath the Recovery partition by 250MB Get-Disk $diskNum | Resize-Partition -PartitionNumber ($recPartNum - 1) -Size ($size - 250MB) Removes the existing Recovery partition aggressively Get-Disk $diskNum | Remove-Partition -PartitionNumber $recPartNum -Confirm:$false Passes the required arguments for DiskPart to a text file ‚ÄòResizeREScript.txt‚Äô located in $env:TEMP that can be called on later that: Creates a new partition on the disk based on whether the partition style is GPO or MBR Applies the correct attributes to the new partition to configure it as a Recovery partition Formats the partition in NTFS format Finally enabling the recovery agent with Start-Process 'reagentc.exe' -ArgumentList '/enable' -Wait -NoNewWindow to allow for the failing update to be installed. All of these settings are exactly as per the Microsoft provided document, but you know, done for you. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:2:1","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#script-breakdown"},{"categories":["windows"],"content":" 2.2 Now We AttackTo allow the script to work within a Remediation, we need to ensure that the data being passed back to Microsoft Intune is suitable, and other that wrapping the bulk of the script in some Try and Catch logic, and handling the output of the commands with Write-Output and corresponding Exit codes, there isn‚Äôt a whole heap for us to do thankfully. Set-WinRE_Remediation.ps1 #Script to fix the recovery partition for KB5028997 by /u/InternetStranger4You, updated by Nick Benton #Mostly Powershell version of Microsoft's support article: https://support.microsoft.com/en-us/topic/kb5028997-instructions-to-manually-resize-your-partition-to-install-the-winre-update-400faa27-9343-461c-ada9-24c8229763bf #Test in your own environment before running. Not responsible for any damages. Try { #Run reagentc.exe /info and save the output $pinfo = New-Object System.Diagnostics.ProcessStartInfo $pinfo.FileName = 'reagentc.exe' $pinfo.RedirectStandardOutput = $true $pinfo.UseShellExecute = $false $pinfo.Arguments = '/info' $p = New-Object System.Diagnostics.Process $p.StartInfo = $pinfo $p.Start() | Out-Null $p.WaitForExit() $stdout = $p.StandardOutput.ReadToEnd() #Verify that disk and partition are listed in reagentc.exe /info. If blank, then something is wrong with WinRE if (($stdout.IndexOf('harddisk') -ne -1) -and ($stdout.IndexOf('partition') -ne -1)) { #Disable Windows recovery environment Start-Process 'reagentc.exe' -ArgumentList '/disable' -Wait -NoNewWindow #Get recovery disk number and partition number $diskNum = $stdout.substring($stdout.IndexOf('harddisk') + 8, 1) $recPartNum = $stdout.substring($stdout.IndexOf('partition') + 9, 1) #Resize partition before the recovery partition $size = Get-Disk $diskNum | Get-Partition -PartitionNumber ($recPartNum - 1) | Select-Object -ExpandProperty Size Get-Disk $diskNum | Resize-Partition -PartitionNumber ($recPartNum - 1) -Size ($size - 250MB) #Remove the recovery partition Get-Disk $diskNum | Remove-Partition -PartitionNumber $recPartNum -Confirm:$false #Create new partion with diskpart script $diskpartScriptPath = $env:TEMP $diskpartScriptName = 'ResizeREScript.txt' $diskpartScript = $diskpartScriptPath + '\\' + $diskpartScriptName \"sel disk $($diskNum)\" | Out-File -FilePath $diskpartScript -Encoding utf8 -Force $PartStyle = Get-Disk $diskNum | Select-Object -ExpandProperty PartitionStyle if ($partStyle -eq 'GPT') { #GPT partition commands 'create partition primary id=de94bba4-06d1-4d40-a16a-bfd50179d6ac' | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force 'gpt attributes =0x8000000000000001' | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force } else { #MBR partition command 'create partition primary id=27' | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force } \"format quick fs=ntfs label=`\"Windows RE tools`\"\" | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force Start-Process 'diskpart.exe' -ArgumentList \"/s $($diskpartScriptName)\" -Wait -NoNewWindow -WorkingDirectory $diskpartScriptPath #Enable the recovery environment Start-Process 'reagentc.exe' -ArgumentList '/enable' -Wait -NoNewWindow Write-Output 'Recovery Partition Extended Successfully.' Exit 0 } else { Write-Output 'Recovery partition not found. Aborting script.' Exit 1 } } Catch { Write-Output 'Unable to update Recovery Partition on the device.' Exit 2000 } With the script now in a more useful format, on to how we deploy this to a select group of test devices. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:2:2","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#now-we-attack"},{"categories":["windows"],"content":" 3 Deploying the RemediationI would strongly advised testing this in small numbers before you go deploying the the All Devices group, and use a new Remediation with the same detection script method as before, but this time with the fully functioning remediation script, so we can actually fix this issue that Microsoft has caused. The Remediation should look something like the below, again with a schedule for once as we don‚Äôt need this running more than once. Microsoft Intune Remediation Script. If we‚Äôve been successful in our deployment we should start seeing device report back the status of the remediation, and advise where there are issues with the size of the WinRE partition. Microsoft Intune Remediation Detection results. Following the successful run of the remediation script, we now have an output of the results with a device that had issues with the partition size, now successfully remediated. Microsoft Intune Remediation Remediation results. All is left to do now, is find some more test devices to add to the assignment group, and monitor their progress. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:3:0","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#deploying-the-remediation"},{"categories":["windows"],"content":" 4 SummaryIn short, this should allow you to get over the hurdle caused by the failing update delivery, and also give the devices with the issue a push in the right direction following the update to their recovery partition size, to allow them to realise they can now install the update. I can‚Äôt take credit for the scripting of the Microsoft published resolution, that goes to u/InternetStranger4You, but with this and moving it to a Remediation in Microsoft Intune, means that it can do the heavy lifting on your behalf. Or you can just wait for Microsoft to release a fix, totally up to you. Thanks to piotrxj in the comments for the updated detection method. Warning I hold no responsibility for the impact to your devices or environments, please, please, please test this on devices you do not care about first before even contemplating pushing this to a wider audience. ","date":"31 January 2024","objectID":"/posts/windows-winre-partition-resize-kb5034441/:4:0","series":null,"tags":["intune","updates","powershell","remediation","bitlocker","endpoint security","security"],"title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","uri":"/posts/windows-winre-partition-resize-kb5034441/#summary"},{"categories":["entra id"],"content":"Using Microsoft Entra ID device attributes to allow for exclusions of Conditional Access Policies.","date":"10 January 2024","objectID":"/posts/device-attributes-cap/","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/"},{"categories":["entra id"],"content":"Imagine you‚Äôve spent time getting your Windows devices enrolled into Intune, they‚Äôre all getting Device Compliance policies, and you‚Äôve finally pulled the trigger on your shiny new Conditional Access Policy that require device compliance for all your users across Windows devices, and low and behold, you‚Äôve broken access to Microsoft 365 authenticated services from your Remote Desktop service environment, or even VDI environments. So what next? Use the trusted location exemption in your policy for the virtual environment? What happens if the public facing address range is the same as your workstation environments or that you‚Äôd rather not blow a massive hole in security by allowing an entire IP address range free access to Microsoft 365 authenticated services? That‚Äôs not very Zero Trust of you is it. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:0:0","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#"},{"categories":["entra id"],"content":" 1 Filtering DevicesLuckily within the the Conditional Access Policy configuration, there is a way to filter devices based on the device object registered with Entra ID, there are some useful native device attributes that can be used as long as your devices have registered in Entra ID (think Hybrid Entra Joined for this VDI environment). What happens when you can‚Äôt find a suitable attribute to use that excludes your virtual environment, but still includes your end user computer workstations? The answer here are the attributes extensionAttribute1-15, which are attributes attached only to the Entra ID device object, and not synchronised, and require specific permissions to set using Graph. These seem like a good way to go. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:0","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#filtering-devices"},{"categories":["entra id"],"content":" 1.1 Getting AttributesFor us to understand how these attributes can be updated or added, we‚Äôd probably best take a look at how we see the attributes in the first place. Let‚Äôs start with a device in Entra ID, we can see from the below where these attributes should be: An Entra ID Windows device. Currently this device has no attributes assigned, shock. We‚Äôll need the Object ID in a second, so may as well grab it now. What about using Graph? We can pull back these attributes by querying the device itself, using a GET to https://graph.microsoft.com/beta/devices/{objectId}/, so for this device the call is https://graph.microsoft.com/beta/devices/492a52d0-ec1a-40ed-8ea5-79f27aa0f8bf/. Graph Explorer showing empty device attributes. Yup still no attributes. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:1","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#getting-attributes"},{"categories":["entra id"],"content":" 1.2 Adding AttributesNow that we can see where these attributes reside on the device object in Entra ID, if we‚Äôre going to be using them as a filtering option in our Conditional Access Policy, we should probably have a look at how we update them. Pretty straight forward, as it‚Äôs the device object we‚Äôre updating, we can create, remove, or replace these attributes using a PATCH to the same Graph endpoint https://graph.microsoft.com/beta/devices/492a52d0-ec1a-40ed-8ea5-79f27aa0f8bf/ using the JSON format in the documentation and like the example below. JSON { \"extensionAttributes\": { \"extensionAttribute1\": \"I'm an Attribute\", \"extensionAttribute2\": \"I'm also an Attribute\" } } Punting the above to the device using Graph Explorer, we get the expected response of {} which is always pleasant, and querying the device object again with a GET, we can now see the attributes updated. Graph Explorer showing a new device attribute. We‚Äôre onto something here. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:2","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#adding-attributes"},{"categories":["entra id"],"content":" 1.3 Updating or Removing AttributesWe need to be careful with our PATCH calls to the device object, as they will update the attributes, this means removal and update of existing attributes, you can see using the below example that we can change extensionAttribute1 and just plain remove extensionAttribute2. JSON { \"extensionAttributes\": { \"extensionAttribute1\": \"CAP-00-Out\", \"extensionAttribute2\": \"\" } } Now the device object is an attribute crisis. Graph Explorer showing updated device attributes. I‚Äôve given the attribute a sensible value of CAP-00-Out as we can utilise the range of operators available in the Conditional Access Policy device filter for the attributes. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:3","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#updating-or-removing-attributes"},{"categories":["entra id"],"content":" 1.4 Filter for DevicesSo now we have a way to essentially tag devices we want to exclude from a Conditional Access Policy, we should look at how we create a device filter, and also explore the fact we can build a naming convention with these ‚Äútags‚Äù and utilise the operators available. You have to be careful with filtering within Conditional Access Policies, as there is some level of logic over not only supported operators, but also the attributes that use the operators, and how they are evaluated. For our scenario, we‚Äôre going to use extensionAttributes which as of today, support the following operators Equals, NotEquals, StartsWith, NotStartsWith, EndsWith, NotEndsWith, Contains, NotContains, In, NotIn So building a quick query in the policy, we can exclude devices where extensionAttribute1 equals CAP-00-Out. Conditional Access Policy filter using the equals operator. Or if we want to be clever and capture devices where where extensionAttribute1 ends in Out regardless of the other content. Conditional Access Policy filter using the ends with operator. So there is value in coming up with good naming conventions across all areas of Entra ID and Microsoft Intune, who knew? ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:4","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#filter-for-devices"},{"categories":["entra id"],"content":" 1.5 Filtering in ActionHaving created a Conditional Access Policy in Report-only mode to Require device to be marked as compliant or Require Microsoft Entra hybrid joined device on Windows device platforms, with the filter to exclude devices matching device.extensionAttribute1 -eq \"CAP-00-Out\", we can see in the sign in logs for the user in scope of the policy, when accessing Microsoft 365 authenticated resources, that they are not subject to the policy. User sign in logs in Entra ID. Which for our situation is exactly the outcome we‚Äôre after. Now time to make this less of a manual process. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:1:5","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#filtering-in-action"},{"categories":["entra id"],"content":" 2 PowerShell and GraphI‚Äôll assume you‚Äôre familiar with authenticating to Graph, and this time instead of the trusty MSAL.PS module I‚Äôm using Microsoft the native commands, ikr, shocking. Now that we‚Äôre connected to Graph with the required scope options using Connect-MgGraph -Scopes 'Device.ReadWrite.All', we need to be able to pull back all the devices we want to assign an attribute to. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:2:0","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#powershell-and-graph"},{"categories":["entra id"],"content":" 2.1 Getting DevicesWho knew that when working in non-development tenants that you‚Äôd have to consider pagination, so yeah, I had to throw something together to pull back all Entra ID device objects using the very same Graph endpoint we used earlier to look at a single device https://graph.microsoft.com/beta/devices/ and the Invoke-MgGraphRequest command. PowerShell Function Get-DeviceAAD() { $graphApiVersion = 'beta' $Resource = 'devices' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource\" $GraphResults = Invoke-MgGraphRequest -Method GET -Uri $uri $Results = @() $Results += $GraphResults.value $Pages = $GraphResults.'@odata.nextLink' while ($null -ne $Pages) { $Additional = Invoke-MgGraphRequest -Method GET -Uri $Pages if ($Pages) { $Pages = $Additional.'@odata.nextLink' } $Results += $Additional.value } $Results } catch { Write-Error $Error[0].ErrorDetails.Message break } } For the pagination, we‚Äôre capturing the results of the web request into an array variable $Results, and looping through the @odata.nextLink data with a subsequent Graph calls, adding each result back into the same array variable until there are no more results. Simple right? Running this will allow us to pull back all Entra ID device objects, and with the below we can present them in a table using Out-GridView. PowerShell $Devices = @(Get-DeviceAAD | Select-Object displayName, operatingSystem, manufacturer, model, id, deviceId | Out-GridView -PassThru -Title 'Select Devices to update extension attributes...') Allowing the selection of the devices that need their extension attributes updating, and importantly the id of the device object used to update the attribute. The PowerShell script grid view for Entra ID devices. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:2:1","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#getting-devices"},{"categories":["entra id"],"content":" 2.2 Extension Attribute JSONThe JSON content we can build from another Out-GridView prompt, with some logic so that you only select a single extension Attribute to update, and we can pass that selection using $Attribute and a simple Read-Host to prompt for the value of the attribute itself, added to the $attributeValue variable into the JSON format needed to update the extension attributes. PowerShell $extensionAttributes = @() for ($i = 1; $i -le 15; $i++) { $extensionAttributes += 'extensionAttribute' + $i } $Attribute = @($extensionAttributes | Out-GridView -PassThru -Title 'Select only one attribute you wish to update...') while ($Attribute.count -gt 1) { Write-Host 'Only select one attribute to update...' -ForegroundColor Yellow $Attribute = @($extensionAttributes | Out-GridView -PassThru -Title 'Select only one attribute you wish to update...') } With the data required now captured, we can build the JSON that can be passed to the device object Graph endpoint to update the required data. PowerShell $JSON = @\" { \"extensionAttributes\": { \"$Attribute\": \"$attributeValue\" } } \"@ Running these PowerShell sections in isolation we get a JSON output similar to the below: JSON { \"extensionAttributes\": { \"extensionAttribute1\": \"CAP-00-Out\" } } Giving us the required data and attribute value to update the device object, now we just need a function to do this. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:2:2","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#extension-attribute-json"},{"categories":["entra id"],"content":" 2.3 Updating Attributes FunctionWith the device or devices now at our disposable, including the Id we used earlier in Graph Explorer, we could do with a function to update the device with the new extension attribute value, handing over the JSON content we created that is required to update the object. PowerShell Function Add-DeviceAttribute() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON, [parameter(Mandatory = $true)] $deviceID ) $graphApiVersion = 'Beta' $Resource = \"devices/$deviceID\" try { Test-Json -Json $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } Now we can run the below passing in the device object id and the JSON content to update the device attributes. PowerShell foreach ($device in $devices){ Add-DeviceAttribute -deviceID $device.id -JSON $JSON } ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:2:3","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#updating-attributes-function"},{"categories":["entra id"],"content":" 3 Bulk Updating Device AttributesNow we have all the component parts, we can build the full script giving us an option with Mode and options Update and Remove to choose whether we want to update attributes, or remove them. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:3:0","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#bulk-updating-device-attributes"},{"categories":["entra id"],"content":" 3.1 Removing AttributesWe should probably run this a couple of times to show what the script can do, we‚Äôll start with removing the data in an attribute using the below. PowerShell ./Invoke-DeviceExtensionAttributes.ps1 -tenantId 'e3bdd962-ac3d-4bd1-9b3c-39eebfee352b' -Mode Remove Taking our existing device PHXNB-695630804 we used and manually added attributes to, we can clear our original data in extensionAttribute1. Selecting the device when prompted. The PowerShell script grid view for Entra ID devices. Selecting the attribute we want to clear. The PowerShell script grid view for extension attributes to be removed. Confirming we want to continue. The PowerShell script prompting whether to continue with the removal of the extension attribute. Now we can check the device in Entra ID and confirm that the attribute has now been cleared. A device in Entra ID with the extension attribute removed. Now that we‚Äôve got a blank canvas, let‚Äôs update some device objects with a new extension attribute value. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:3:1","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#removing-attributes"},{"categories":["entra id"],"content":" 3.2 Updating AttributesWe can now run the script again, but with the Update option, and start tagging multiple devices at once. PowerShell ./Invoke-DeviceExtensionAttributes.ps1 -tenantId 'e3bdd962-ac3d-4bd1-9b3c-39eebfee352b' -Mode Update This time we‚Äôre asked to enter in the value of the attribute, here entering CAP-00-Out The PowerShell script prompting for the attribute value. Selecting a handful of devices when prompted. The PowerShell script grid view for Entra ID devices. Selecting the attribute we want to update. The PowerShell script grid view for extension attributes to be added. This warning section now shows how many devices, the attribute extension to be updated and the new value. The PowerShell script prompting whether to continue with the update of the extension attribute. Confirming we want to continue, the devices have now been updated with the CAP-00-Out in extensionAttribute1. A device in Entra ID with the extension attribute confirmed. Checking a device in Entra ID gives us exactly the result we want. A device in Entra ID with the extension attribute updated. Take my word for it that the other five devices have updated too üòÖ. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:3:2","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#updating-attributes"},{"categories":["entra id"],"content":" 4 SummaryThis may seem like a simple script, and honestly it is, but the application of the script, to allow for tagging of extension attributes by privileged accounts only, on Entra ID device objects, that are not overwritten by directory sync for hybrid joined Windows devices, changes to device operating system version etc. for all device objects, gives us two major bits of functionality: Conditional Access Policy inclusion or exclusion Dynamic Security Groups Our use case was for exclusion of Conditional Access Policies, but with the dynamic security group option, the possibilities for tagging device objects in this way and grouping them becomes almost endless, want to group devices for specific configuration in Microsoft Intune? Yup. Want to group devices for specific application deployments in Microsoft Intune? Also yup. Want to exclude groups of devices from Microsoft Intune profiles for some reason where existing Entra ID attributes or Device Filters don‚Äôt cut it, this one too. What we have created here is at least a method for the assignment of these tags, what you can do is take this and apply it to your own requirements, hopefully making the management of devices a little more straight forward. ","date":"10 January 2024","objectID":"/posts/device-attributes-cap/:4:0","series":null,"tags":["powershell","graph","security","conditional access","automation"],"title":"Using Entra ID Device Attributes for Conditional Access Exceptions","uri":"/posts/device-attributes-cap/#summary"},{"categories":["intune"],"content":"Migrating existing Microsoft Intune Windows firewall rules to settings catalog profiles using PowerShell and Graph API.","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/"},{"categories":["intune"],"content":"If you‚Äôve ever experienced the joys of migrating Group Policy and in particular Windows Defender Firewall rules away from Group Policy to Microsoft Intune, you‚Äôve probably encountered the Rule Migration Tool, and for now this tool has worked well, beavering away grabbing firewall rules from a source Windows 10 or later device and punting them straight in Microsoft Intune. So what‚Äôs the catch? Well with the move to Settings Catalog based policies all over the shop in Microsoft Intune, and the advent of Reusable Settings for Defender Firewall Rules, these ‚Äúlegacy‚Äù Endpoint Security Defender Firewall Rule profiles don‚Äôt support the new world, so how do we fix that? It‚Äôs obviously PowerShell and Graph, you should know this by now. Note The functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:0:0","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#"},{"categories":["intune"],"content":" 1 Getting Firewall Rule ProfilesI haven‚Äôt had time to update my fork of the Rule Migration Tool to support Settings Catalog policies just yet, so instead of focusing on capturing new rules, let‚Äôs look at how we get the rules from existing Endpoint Security profiles. I‚Äôve worked long enough on bodging together my own PowerShell functions that I can pull back existing profiles and the data, so let‚Äôs do that first to see what we‚Äôre working with, as we‚Äôll need to translate these existing rules into the new format. Once we‚Äôve authenticated to Graph using Connect-MgGraph and using the functions below to get the Endpoint Security profiles, Endpoint Security Templates and Endpoint Security Categories and finally each setting within the profile we can put all the existing rules into a variable that we can work with. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:1:0","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#getting-firewall-rule-profiles"},{"categories":["intune"],"content":" 1.1 Endpoint Security ProfileThis function will get all Endpoint Security profiles, or a specific profile by either Id or Name. We‚Äôll need this to get the profiles that contains all the firewall rules we want to migrate. PowerShell Function Get-DeviceEndpointSecProfile() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = 'Beta' $Resource = 'deviceManagement/intents' try { if ($Id) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\" Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($name) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.displayName).contains(\"$name\") } } Else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Method Get -Uri $uri).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:1:1","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#endpoint-security-profile"},{"categories":["intune"],"content":" 1.2 Endpoint Security TemplatesAs Endpoint Security profiles are a little more complicated that other profiles in Microsoft Intune, and rely on underpinning templates, we also have to get the template being used by the profile itself. We can pass the templateId captured from an Endpoint Security Profile using the above function into the Id parameter in the below function. PowerShell Function Get-DeviceEndpointSecTemplate() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/templates?`$filter=(isof(%27microsoft.graph.securityBaselineTemplate%27))\" try { if ($Id) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\" Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($name) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.displayName).contains(\"$name\") } } Else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Method Get -Uri $uri).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:1:2","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#endpoint-security-templates"},{"categories":["intune"],"content":" 1.3 Endpoint Security Template CategoriesLastly, we now need to be able to get all the Endpoint Security categories that are assigned to the template allowing us to extract the actual content of the profile, and using the function above, we can get all the categories for the template by taking the id of the Endpoint Security Template, looping through each category in the template, and finally being able to extract the data we need. All of this makes me glad that Settings Catalog profiles are being used more and more in Microsoft Intune. PowerShell Function Get-DeviceEndpointSecCategorySetting() { \u003c# .SYNOPSIS This function is used to get an Endpoint Security category setting from a specific policy using the Graph API REST interface .DESCRIPTION The function connects to the Graph API Interface and gets a policy category setting .EXAMPLE Get-EndpointSecurityCategorySetting -PolicyId $policyId -categoryId $categoryId Gets an Endpoint Security Categories from a specific template in Endpoint Manager .NOTES NAME: Get-EndpointSecurityCategory #\u003e [cmdletbinding()] param ( [Parameter(Mandatory = $true)] $Id, [Parameter(Mandatory = $true)] $categoryId ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/intents/$Id/categories/$categoryId/settings?`$expand=Microsoft.Graph.DeviceManagementComplexSettingInstance/Value\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Method Get -Uri $uri).value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:1:3","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#endpoint-security-template-categories"},{"categories":["intune"],"content":" 1.4 Capturing Firewall RulesUsing existing legacy Endpoint Security Firewall Rule profiles in a tenant, we just need to know their names so we can pass them into an array variable, so we can use the below profile names as examples. Legacy Firewall Rule policies in Microsoft Intune. Adding them into an array so we can loop through each one of them, and extract the needed data. PowerShell $FirewallPolicies = @('LegacyRules-0', 'LegacyRules-1','LegacyRules-2', 'LegacyRules-3') Using the Endpoint Security functions we can now process each of the profiles and rip out all the rules into a useable format using a new array variable $FWRules. PowerShell $FWRules = @() foreach ($FirewallPolicy in $FirewallPolicies) { $EndpointSecProfile = Get-DeviceEndpointSecProfile -Name $FirewallPolicy $EndpointSecTemplates = Get-DeviceEndpointSecTemplate $EndpointSecTemplate = $EndpointSecTemplates | Where-Object { $_.id -eq $EndpointSecProfile.templateId } $EndpointSecCategories = Get-DeviceEndpointSecTemplateCategory -Id $EndpointSecTemplate.id foreach ($EndpointSecCategory in $EndpointSecCategories) { $EndpointSecSettings = Get-DeviceEndpointSecCategorySetting -Id $EndpointSecProfile.id -categoryId $EndpointSecCategories.id $FWRules += $EndpointSecSettings.valueJson | ConvertFrom-Json } } With these we now have the $FWRules array of Firewall Rules captured from the existing profiles similar to the below. JSON displayName : NVIDIA SHIELD Streaming SSAS UDP Exception description : UDP exceptions for NVIDIA SHIELD Streaming SSAS (mDNS) trafficDirection : in action : allowed profileTypes : {notConfigured} packageFamilyName : filePath : C:\\Program Files\\NVIDIA Corporation\\NvContainer\\nvcontainer.exe serviceName : protocol : 17 localPortRanges : {5353} remotePortRanges : {} interfaceTypes : {notConfigured} localUserAuthorizations : useAnyLocalAddressRange : True actualLocalAddressRanges : {} useAnyRemoteAddressRange : True actualRemoteAddressRanges : {} displayName : BlueStacks Service Hyper-V description : trafficDirection : in action : allowed profileTypes : {notConfigured} packageFamilyName : filePath : serviceName : protocol : 6 localPortRanges : {2860-2892} remotePortRanges : {} interfaceTypes : {notConfigured} localUserAuthorizations : useAnyLocalAddressRange : True actualLocalAddressRanges : {} useAnyRemoteAddressRange : False actualRemoteAddressRanges : {172.31.224.0/255.255.240.0} We now have the data we need to start building firewall rules in the new Setting Catalog format. Surely it get‚Äôs easier, (hint: it doesn‚Äôt). ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:1:4","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#capturing-firewall-rules"},{"categories":["intune"],"content":" 2 Creating Firewall RulesWe now have the information from the existing legacy profiles allowing us to create rules in the Settings Catalog policy format, so we should process each of the rules we‚Äôve captured and pass the data into reusable variables in preparation for building the JSON structure. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:2:0","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#creating-firewall-rules"},{"categories":["intune"],"content":" 2.1 Firewall Rule GroupingOne thing I didn‚Äôt expect is that Settings Catalog policies, for Firewall rules at least, have a maximum number of rules, 100 in fact. Compared with the legacy profiles maximum of 150, we‚Äôre going to have to split out the rules in $FWRules into 100 rule groups to allow us to add them to a single policy. PowerShell $counter = [pscustomobject] @{ Value = 0 } $groupSize = 100 $FWRuleGroups = $FWRules | Group-Object -Property { [math]::Floor($counter.Value++ / $groupSize) } With the above, we can ensure that we are breaking the rules into 100 rule sections that we can then reference using the $FWRuleGroups variable when building the new policies. txt Count Name Group ----- ---- ----- 100 0 {@{displayName=Wi-Fi Direct Spooler Use (Out); description=Outbound rule to use WSD printers on Wi-Fi Direct networks.; trafficDirection=out; 100 1 {@{displayName=Network Discovery (SSDP-In); description=Inbound rule for Network Discovery to allow use of the Simple Service Discovery Protocol. [UDP 100 2 {@{displayName=teams.exe; description=; trafficDirection=in; action=allowed; profileTypes=System.Object[]; packageFamilyName=; 100 3 {@{displayName=Microsoft Sync Center; description=Microsoft Sync Center; trafficDirection=in; action=allowed; profileTypes=System.Object[]; 63 4 {@{displayName=Microsoft Office Outlook; description=; trafficDirection=in; action=allowed; profileTypes=System.Object[]; packageFamilyName=; These groups can now be used to create separate Settings Catalog policies. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:2:1","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#firewall-rule-grouping"},{"categories":["intune"],"content":" 2.2 Duplicate Rule NamesSo for each of these rule groups in the $FWRuleGroups variable, we need to take each rule and extract the data, adding it to a variable that we can reference later, as well as one important different between the legacy and the new profiles‚Ä¶we can‚Äôt have duplicate rule names. Yeah this one bit me in the arse pretty hard during testing, and I can tell you now I have thrown in a very quick fix for this using a counter in the form of the $RuleNameCount variable. PowerShell foreach ($FWRuleGroup in $FWRuleGroups) { $Rules = $FWRuleGroup.Group $RuleNameCount = 0 foreach ($Rule in $Rules) { # Capturing existing rules with duplicate names, as Settings Catalog will not allow duplicates $DuplicateNames = $Rules.displayName | Group-Object | Where-Object { $_.count -gt 1 } $Name = $Rule.displayName if ($DuplicateNames.name -contains $Name) { $Name = $Name + '-' + $RuleNameCount++ } } } This isn‚Äôt the cleanest, but at least it gets us over the line with making sure every rule has a unique name. As you can see from the below, in just one of the groups we have a number of duplicates. txt Count Name Group ----- ---- ----- 2 App Installer {App Installer, App Installer} 7 Captive Portal Flow {Captive Portal Flow, Captive Portal Flow, Captive Portal Flow, Captive Portal Flow‚Ä¶} 2 Company Portal {Company Portal, Company Portal} 2 Dell SupportAssist for H‚Ä¶ {Dell SupportAssist for Home PCs, Dell SupportAssist for Home PCs} 2 Microsoft Edge {Microsoft Edge, Microsoft Edge} 3 Microsoft Edge (mDNS-In) {Microsoft Edge (mDNS-In), Microsoft Edge (mDNS-In), Microsoft Edge (mDNS-In)} 2 Microsoft Sticky Notes {Microsoft Sticky Notes, Microsoft Sticky Notes} 2 Microsoft Store {Microsoft Store, Microsoft Store} 2 Microsoft To Do {Microsoft To Do, Microsoft To Do} 4 VMware Remote MKS {VMware Remote MKS, VMware Remote MKS, VMware Remote MKS, VMware Remote MKS} 23 Windows Feature Experien‚Ä¶ {Windows Feature Experience Pack, Windows Feature Experience Pack, Windows Feature Experience Pack, Windows Feature Experience Pack‚Ä¶} ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:2:2","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#duplicate-rule-names"},{"categories":["intune"],"content":" 2.3 Rule ProcessingOn to how we capture the rest of the rule settings, and you may have noticed that not every rule will have every setting, for good reason, but we need to ensure that for each rule processed we‚Äôre not taking through data from the previous rule, so we can update the code snippet above to capture the data into variables, but clear them out before we do so. PowerShell foreach ($FWRuleGroup in $FWRuleGroups) { $Rules = $FWRuleGroup.Group $RuleNameCount = 0 foreach ($Rule in $Rules) { Clear-Variable -Name ('Name', 'Description', 'Direction', 'Action', 'FWProfiles', 'PackageFamilyName', 'FilePath', 'Service', 'Protocol', 'LocalPorts', 'RemotePorts', 'Interfaces', 'UseAnyLocalAddresses', 'LocalAddresses', 'UseAnyRemoteAddresses', 'RemoteAddresses') -ErrorAction Ignore # Capturing existing rules with duplicate names, as Settings Catalog will not allow duplicates $DuplicateNames = $Rules.displayName | Group-Object | Where-Object { $_.count -gt 1 } $Name = $Rule.displayName if ($DuplicateNames.name -contains $Name) { $Name = $Name + '-' + $RuleNameCount++ } $Description = $Rule.description $Direction = $Rule.trafficDirection $Action = $Rule.action $FWProfiles = $Rule.profileTypes $PackageFamilyName = $Rule.packageFamilyName $FilePath = ($Rule.filePath).Replace('\\', '\\\\') $Service = $Rule.serviceName $Protocol = $Rule.protocol $LocalPorts = $Rule.localPortRanges $RemotePorts = $Rule.remotePortRanges $Interfaces = $Rule.interfaceTypes $AuthUsers = $Rule.localUserAuthorizations $UseAnyLocalAddresses = $Rule.useAnyLocalAddressRange $LocalAddresses = $Rule.actualLocalAddressRanges $UseAnyRemoteAddresses = $Rule.useAnyRemoteAddressRange $RemoteAddresses = $Rule.actualRemoteAddressRanges } } We now have the information from the existing rules to create new ones. Now to the fun part of JSON formatting. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:2:3","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#rule-processing"},{"categories":["intune"],"content":" 3 Creating Settings Catalog PoliciesLuckily we have experience creating Settings Catalog policies, and have a good grasp of the JSON formatting required not just for the policy itself, but also for the settings contained within, with the first setting having differing JSON formatting structure and data compared with all subsequent settings. So I had at least an idea on how to build the JSON data to throw it at Microsoft Intune. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:0","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#creating-settings-catalog-policies"},{"categories":["intune"],"content":" 3.1 Building the PolicyWith the rules in neat little groups, and with all the variables in place, we can loop through each of them to create individual Settings Catalog policies, we need to make sure that each policy has a unique name, so we can just take an existing $PolicyName variable and append the group name to it, as these are sequential numbers, giving us something like COPE_FW_RulesMigrated-0, COPE_FW_RulesMigrated-1, COPE_FW_RulesMigrated-2, COPE_FW_RulesMigrated-3, COPE_FW_RulesMigrated-4 for the five groups we have in our example. Each Settings Catalog Policy starts and ends with the same JSON data structure, so we can top and tail each policy with these new variables $JSONPolicyStart and $JSONPolicyEnd, passing in the $NewPolicyName and $PolicyDescription. PowerShell foreach ($FWRuleGroup in $FWRuleGroups) { $NewPolicyName = $PolicyName + '-' + $FWRuleGroup.Name $PolicyDescription = 'Migrated Firewall Rules Policy' $JSONPolicyStart = @\" { \"description\": \"$PolicyDescription\", \"name\": \"$NewPolicyName\", \"platforms\": \"windows10\", \"technologies@odata.type\": \"#microsoft.graph.deviceManagementConfigurationTechnologies\", \"technologies\": \"mdm,microsoftSense\", \"templateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationPolicyTemplateReference\", \"templateId\": \"19c8aa67-f286-4861-9aa0-f23541d31680_1\", \"templateFamily@odata.type\": \"#microsoft.graph.deviceManagementConfigurationTemplateFamily\", \"templateFamily\": \"endpointSecurityFirewall\", \"templateDisplayName\": \"Microsoft Defender Firewall Rules\", \"templateDisplayVersion\": \"Version 1\" }, \"settings\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSetting\", \"settingInstance\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}\", \"settingInstanceTemplateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\", \"settingInstanceTemplateId\": \"76c7a8be-67d2-44bf-81a5-38c94926b1a1\" }, \"groupSettingCollectionValue@odata.type\": \"#Collection(microsoft.graph.deviceManagementConfigurationGroupSettingValue)\", \"groupSettingCollectionValue\": [ \"@ $JSONPolicyEnd = @' ] } } ] } '@ } This was the easy part of the process, we now need to focus on the rules themselves. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:1","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#building-the-policy"},{"categories":["intune"],"content":" 3.2 Building the RulesAs I‚Äôve mentioned before, the initial rule in each policy has different JSON structure and data than the rest, so we can reuse our previous way of dealing this checking whether the rule is the first in the array. PowerShell if ($Rule -eq $Rules[0]) { ... } else { ... } On top of this we need to build in logic to only add in JSON data when the rule requires it. Now there are a lot of potentials with each rule, but there are some consistencies across them all which we can look at now, the rest, well you can have a gander at the full script. The start of each rule is the same, which is kind of Microsoft. PowerShell $JSONRuleStart = @' { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationGroupSettingValue\", \"settingValueTemplateReference\": null, \"children@odata.type\": \"#Collection(microsoft.graph.deviceManagementConfigurationSettingInstance)\", \"children\": [ '@ But that‚Äôs it for niceties, each of the options for every rule has different formatting, let‚Äôs look at comparing just the JSON data for the name of the rule. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:2","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#building-the-rules"},{"categories":["intune"],"content":" 3.3 JSON DifferencesThe first rule in the policy has additional content, mainly in the settingValueTemplateId sections across each object. PowerShell $JSONRuleName = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\", \"settingInstanceTemplateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\", \"settingInstanceTemplateId\": \"116a696a-3270-493e-9938-c336cf05ea98\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$Name\", \"settingValueTemplateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSettingValueTemplateReference\", \"settingValueTemplateId\": \"12994a33-6185-4c3d-a0e8-69316f6293ea\", \"useTemplateDefault\": false } } }, \"@ Compared with each subsequent Rule name, where the JSON doesn‚Äôt need the settingValueTemplateId and other sections. PowerShell $JSONRuleName = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$Name\" } }, \"@ You get the idea, now imagine spending half a day reviewing and comparing JSON for each of the potential options in the rule, I can‚Äôt say it was an enjoyable time, but here we are. Bringing the above together, we‚Äôll get something like the below. PowerShell if ($Rule -eq $Rules[0]) { $JSONRuleName = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\", \"settingInstanceTemplateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\", \"settingInstanceTemplateId\": \"116a696a-3270-493e-9938-c336cf05ea98\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$Name\", \"settingValueTemplateReference\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSettingValueTemplateReference\", \"settingValueTemplateId\": \"12994a33-6185-4c3d-a0e8-69316f6293ea\", \"useTemplateDefault\": false } } }, \"@ } else { $JSONRuleName = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$Name\" } }, \"@ } ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:3","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#json-differences"},{"categories":["intune"],"content":" 3.4 Completing the PolicyWith the JSON data for all our rule(s) now in place, or at least hopefully, we need to combine all the $JSONRule* variables per rule into a new variable $JSONRule, and the add that rule to a new array variable $JSONAllRules that can be used to build the full Settings Catalog policy. PowerShell $JSONAllRules = @() ... $JSONRule = $JSONRuleStart + $JSONRuleName + $JSONRuleState + $JSONRuleDirection + $JSONRuleProtocol + $JSONRuleLocalAddressRange + $JSONRuleInterface + $JSONRulePackageFamily + $JSONRuleFilePath + $JSONRuleAuthUsers + $JSONRuleRemotePorts + $JSONRuleFWProfile + $JSONRuleService + $JSONRuleLocalPorts + $JSONRuleRemoteAddressRange + $JSONRuleAction + $JSONRuleDescription + $JSONRuleEnd $JSONAllRules += $JSONRule Now we have the start of the policy, the end of the policy, and the middle bit containing all the rules, we can combine them into one mega-JSON variable. PowerShell $JSONPolicy = $JSONPolicyStart + $JSONAllRules + $JSONPolicyEnd And using the function below, we can send this to Graph and create ourselves a new Settings Catalog policy. PowerShell Function New-DeviceSettingsCatalog() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = 'Beta' $Resource = 'deviceManagement/configurationPolicies' try { Test-Json -Json $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } Which looks something like this. PowerShell New-DeviceSettingsCatalog -JSON $JSONPolicy With, if all went well, the response below. txt @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : b9ae4e1f-7f78-4506-8520-aa7919f06a73 name : COPE_FW_RulesMigrated-4 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:33:27 lastModifiedDateTime : 14/09/2023 09:33:27 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} This looks pretty good if I do say so myself. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:4","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#completing-the-policy"},{"categories":["intune"],"content":" 3.5 Running the ScriptThe full script which let‚Äôs be honest, is what you‚Äôre after, can be run using the below command, passing in the required variables for tenantId, policyName, and oldFirewallPolicies PowerShell ./Invoke-MgConvertFirewallRules.ps1 -tenantId \"yourtenantId\" -policyName \"COPE_FW_RulesMigrated\" -oldFirewallPolicies \"LegacyRules-0\", \"LegacyRules-1\", \"LegacyRules-2\", \"LegacyRules-3\" After authenticated to Graph, this will give us the below output having successfully created the new Settings Catalog policies. txt Found Legacy Firewall Rule Profile LegacyRules-0 Found Legacy Firewall Rule Profile LegacyRules-1 Found Legacy Firewall Rule Profile LegacyRules-2 Found Legacy Firewall Rule Profile LegacyRules-3 Captured 463 rules from the provided legacy Endpoint Security Firewall Rules profiles. Creating new Settings Catalog Policy COPE_FW_RulesMigrated-0 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 14c02164-36ce-446f-9101-90c833ee441e name : COPE_FW_RulesMigrated-0 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:30 lastModifiedDateTime : 14/09/2023 09:40:30 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-0 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-1 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 213957bd-2bc1-4103-af59-25e406894213 name : COPE_FW_RulesMigrated-1 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:31 lastModifiedDateTime : 14/09/2023 09:40:31 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-1 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-2 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 8eade932-9563-4cc5-b24e-9b478f98cebe name : COPE_FW_RulesMigrated-2 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:33 lastModifiedDateTime : 14/09/2023 09:40:33 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-2 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-3 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 9723ffd1-198e-4b96-8572-668e16c8dbda name : COPE_FW_RulesMigrated-3 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:34 lastModifiedDateTime : 14/09/2023 09:40:34 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-3 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-4 @odata.context : https://gra","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:5","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#running-the-script"},{"categories":["intune"],"content":" 3.6 Comparing Profiles to PoliciesChecking in Microsoft Intune we should have five new policies that contain the same rules as the legacy profiles. With the new rules having the supplied name prefix, and using the updated policies. Info The clue is the ‚ÄòTarget‚Äô being mdm,microsoftSense not just mdm New Firewall Rule policies in Microsoft Intune. Let‚Äôs have a gander at comparing the rules between the profiles, with the old profile looking like the below with the rule detail. Legacy Firewall Rule policy settings in Microsoft Intune. And the new policy looking pretty damn good. New Firewall Rule policy settings in Microsoft Intune. I think we‚Äôre done. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:3:6","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#comparing-profiles-to-policies"},{"categories":["intune"],"content":" 4 SummaryThis, and the script, as usual all came about from improving a Customers Microsoft Intune environment. The customer being very security focussed was blocking legitimately everything inbound and outbound unless there was a firewall rule; this included all Microsoft 365 endpoints. With their existing rules in legacy profiles, they had to have rules with all the IP addresses for these Microsoft endpoints, and keep these up-to-date across multiple profiles. This obviously wasn‚Äôt ideal, and with the advent of the reusable settings and the auto discovery of addresses and domains for firewall rules in Settings Catalog policies, allowed for more confidence in the rules, a reduced maintenance overhead, and you know, new stuff is cool. There is still a scenario I need to look at, and I mentioned that at the start, looking at the original Microsoft Rule Migration Tool and getting that to create Settings Catalog policies instead of the legacy format, but that is one for a very very rainy day. ","date":"12 September 2023","objectID":"/posts/settings-catalog-firewall-rules/:4:0","series":null,"tags":["windows","powershell","graph","settings catalog","security","firewall","automation","endpoint security"],"title":"Modernising Microsoft Intune Firewall Rule Policies","uri":"/posts/settings-catalog-firewall-rules/#summary"},{"categories":["windows"],"content":"Deploying Windows Updates using dynamic security groups in a phased and controlled approach using Microsoft Intune and Entra ID.","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/"},{"categories":["windows"],"content":"You might have been asked the question, especially from organisations that currently utilise Microsoft Configuration Manager, about how you mimic existing Device Collections used for Software Update deployments in Microsoft Intune. With Configuration Manager having the backing of Microsoft SQL, and a hardware inventory that collects every granular detail about Windows devices, splitting out your device estate into logical phases is very easy to achieve. But what about Microsoft Intune, how do we phase these updates in a similar way to Configuration Manager? ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:0:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#"},{"categories":["windows"],"content":" 1 Windows Update for Business RingsThe first thing we need to understand is how many WUfB (Windows Update for Business) rings we should create, usually based on the size of your Windows device estate, for now we‚Äôll stick with four update rings: Testing Ring: This should be devices that are dedicated for testing, not IT machines. Roughly 5% of your device estate. Pilot Ring: This should be a stratified sample of either users or devices, not friends and family (HR and Finance). Roughly 15% of your device estate. Initial Production Ring: This should be roughly half of the remaining devices, roughly 30% of your device estate. Final Production Ring: This should cover all remaining devices, so 50% of the device estate. These rings can be created in Microsoft Intune with differing deferral periods, installation deadlines, and if you like, grace periods. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:1:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#windows-update-for-business-rings"},{"categories":["windows"],"content":" 1.1 Installation SettingsTaking the Update Rings above, we should ensure that the end result of deferral, deadlines, and grace periods is that that there is no crossover between the timings. What I mean is that you don‚Äôt want to discover an issue with devices in the Pilot Ring after the Initial Production Ring has already started deploying updates, this sounds like a nightmare. So we can use settings similar to those in the below table to ensure that one phase doesn‚Äôt start until the previous has completed. Update Ring Deferral Deadline Grace Period Updates Installed Testing Ring 0 days 1 day 0 days 1 day Pilot Ring 2 days 1 day 1 day 4 days Initial Production Ring 6 days 2 days 1 day 9 days Final Production Ring 10 days 2 days 1 day 13 days Info You may have noticed that we‚Äôre working within a 14-day window here, because we all love NCSC Guidelines. So with the Update Rings configured, we now need to look at how these are assigned to Users and Devices. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:1:1","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#installation-settings"},{"categories":["windows"],"content":" 1.2 Users versus Devices AssignmentNow assignment of Update Rings is no different to any other assignment in Microsoft Intune, and by that I mean that you cannot mix assignment target identities within Include and Exclude targets. We do also need to consider not just the individual Update Ring assignment, but how they all interact together. What we don‚Äôt want is a device meant to be in the Final Production ring, getting a 0-day deferral because the user is in the Testing Ring. So we should stick with assigning these rings to a single identity, but which one? I mean, the answer is Devices, but I‚Äôll explain why. If you‚Äôre using Users, which seems like the easier approach as finding and managing pilot users is pretty straight forward, it means that the Update Ring will follow them regardless of which device they login to. This is not the functionality we want, updates are delivered to devices, not users, so let‚Äôs see how we can group devices together in a sensible way. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:1:2","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#users-versus-devices-assignment"},{"categories":["windows"],"content":" 2 Update Ring GroupsSo now we need to find a way group devices in a sensible way, so let‚Äôs create three (yes three) new Azure AD Microsoft Entra ID Security Groups for each of the Update Rings. Windows Updates Testing Windows Updates Pilot Windows Updates Initial Production With both the Testing and Pilot ring being specifically designated devices, we can use Assigned Groups and add Windows devices to each of those groups, what are we doing with the ‚ÄòWindows Updates Initial Production‚Äô group though? ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:2:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#update-ring-groups"},{"categories":["windows"],"content":" 2.1 Dynamic GroupsNow I know I love Device Filters, and do not fear, we‚Äôll need one of these later, but as covered previously Dynamic Groups are more powerful, and for this use case will perfectly fit our need to split our Windows device estate in half-ish. Device Name is how we‚Äôre going to split our device estate, whether these are you old-school naming conventions on-premises based on asset tag, serial number or otherwise, Autopilot Azure AD Join MEID Join (really?) devices with a prefix and a serial, or god forbid Autopilot Hybrid Joined devices with a prefix and random numbers. Either way, we should be able use Dynamic Device Groups to capture half of the device estate. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:2:1","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#dynamic-groups"},{"categories":["windows"],"content":" 2.2 Start of Device Name MatchingBefore we look at how we capture the devices let‚Äôs look at some device name examples starting with a list of devices with a mixture of device names. txt ENB-BDZX4M3 ENB-3231EQSM PGT-45E8LN1S VIP-ec9d473986d9 ITS-CRJ7C39 CON-f6f64b04a9e7 As we have some kind of naming convention here with a three letter prefix follow by a hyphen and then some random characters, we should be able to capture half of the devices by pulling back only devices that after the hyphen start with odd numbers (1, 3, 5, 7, 9), or alternate letters (a, c, e, etc.). Throwing open you‚Äôre favourite RegEx tester we can plonk in the device names and start playing with queries, and if we want to be exact so we only capture devices that match our three character prefix followed by a hyphen and an odd number, we can use an expression like this. txt ^[a-zA-Z]{3}-d*[13579] For capturing devices that match the three character prefix followed by a hyphen and alternative lowercase characters, we can use the expression below. txt ^[a-zA-Z]{3}-d*[acegikmoqsuwy] For capturing devices that match the three character prefix followed by a hyphen and alternative uppercase characters, we can use the expression below. txt ^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY] To give you an insight into the expression: ^: Start of the string [a-zA-Z]{3}-: First three characters are either uppercase or lowercase letters followed by a hyphen d*[13579]: One odd number d*[acegikmoqsuwy]: One alternative lowercase letter from the supplied range d*[ACEGIKMOQSUWY]: One alternative uppercase letter from the supplied range This should cover our requirements, we just need to create the Dynamic Group query. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:2:2","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#start-of-device-name-matching"},{"categories":["windows"],"content":" 2.3 End of Device Name MatchingWhat happens if you‚Äôre still using asset tag naming conventions, most of these devices will all start with the same letter or number, so we need a way to split these in a different way. Looking at the sample device list below, we can create a new expression that looks at the last number of the device name, but taking into consideration the prefix, hyphen, and only the following six digits. txt LTP-002003 LTP-002042 DTP-001191 DTP-000117 LTP-000008 Once again into RegEx testing we can plonk in the device names and start playing with queries, this time we just want to match devices with any three character prefix followed by a hyphen, but end in an odd number. txt ^[a-zA-Z]{3}-\\d{5}[13579]$ An overview of the expression: ^: Start of the string [a-zA-Z]{3}-: First three characters are either uppercase or lowercase letters followed by a hyphen \\d{5}: Matches five digits after the hyphen [13579]$: The sixth digit is odd This should work for the sample asset tag named devices. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:2:3","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#end-of-device-name-matching"},{"categories":["windows"],"content":" 2.4 Dynamic Group QueryAs well as the using one of the above name matching expressions, we could do with capturing whether the device is actually a Windows Corporate-Owned device. So let‚Äôs build our Dynamic Group Query based on the below requirements. (device.deviceOSType -eq \"Windows\"): Any Windows Device (device.deviceOSVersion -startsWith \"10\"): Any device with an Operating System that starts with 10 (device.deviceOwnership -eq \"Company\"): Any device that is corporate owned ((device.displayName -match \"^[a-zA-Z]{3}-d*[13579]\"): Device name matches our naming convention followed by an odd number (device.displayName -match \"^[a-zA-Z]{3}-d*[acegikmoqsuwy]\"): Device name matches our naming convention followed by a lowercase letter in the set (device.displayName -match \"^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY]\")): Device name matches our naming convention followed by a uppercase letter in the set We need to throw in some and and or into the mix to ensure we‚Äôre only grabbing the correct devices, but the full query can be found below. PowerShell (device.deviceOSType -eq \"Windows\") and (device.deviceOSVersion -startsWith \"10\") and (device.deviceOwnership -eq \"Company\") and ((device.displayName -match \"^[a-zA-Z]{3}-d*[13579]\") or (device.displayName -match \"^[a-zA-Z]{3}-d*[acegikmoqsuwy]\") or (device.displayName -match \"^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY]\")) Using our sample of devices names, the above query would capture the highlighted names below. txt ENB-BDZX4M3 ENB-3231EQSM PGT-45E8LN1S VIP-ec9d473986d9 ITS-CRJ7C39 CON-f6f64b04a9e7 Expanding this over an entire device estate should give us roughly half of all Windows 10 and later corporate owned devices. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:2:4","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#dynamic-group-query"},{"categories":["windows"],"content":" 3 Update Ring AssignmentSo have pretty much all we need to actually start assigning our Update Rings to device groups, but hang fire, we‚Äôve only created three groups and have four Update Rings, what gives? Well for the final ring, we need to cover all remaining Windows corporate owned devices, so we can use the built-in ‚ÄòAll Devices‚Äô group and a Device Filter that only pulls back corporate owned devices, so something like (device.deviceOwnership -eq \"Corporate\"). Now we can start assigning, but we need to make sure that there is no conflict with the profiles, so we‚Äôll make use of both Include and Exclude assignment targets, detailed in the table below. Update Ring Include Group Filter Mode Exclude Groups Testing Ring Windows Updates Testing n/a n/a n/a Pilot Ring Windows Updates Pilot n/a n/a Windows Updates Testing Initial Production Ring Windows Updates Initial Production n/a n/a Windows Updates Testing, Windows Updates Pilot Final Production Ring All Devices Corporate Windows Include Windows Updates Testing, Windows Updates Pilot, Windows Updates Initial Production Once you‚Äôve assigned the Update Rings and confirmed that devices are receiving the correct one, you‚Äôre good to go. Simple really. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:3:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#update-ring-assignment"},{"categories":["windows"],"content":" 4 SummaryThere you have it, a phased and self maintaining deployment of Windows Updates across your device estate, allowing you to truly control when devices are getting updates and an ability to pause update rings in the event of an issue without taking out all of your device estate at once. Obviously you can tailor the number of Update Rings and logic behind splitting devices across them, but it was hard enough for me to work out the RegEx for these two examples to be honest with you. I‚Äôd suggest you start with understanding what devices you need to target, their naming conventions if any, and then play around with RegEx to ensure that you are capturing the correct devices, no one wants unexpected Windows Updates. Once happy with your expressions, you can then create the Dynamic Group and review the membership before going all gung ho and straight up assigning the Update Ring profile to the group, you know, just in case. ","date":"17 July 2023","objectID":"/posts/windows-update-phased-deployment/:4:0","series":null,"tags":["intune","updates","dynamic groups","security"],"title":"Intelligent Phased Windows Update for Business Deployments","uri":"/posts/windows-update-phased-deployment/#summary"},{"categories":["macos"],"content":"Reviewing the National Cyber Security Centre (NCSC) settings in Microsoft Intune for macOS devices using Settings Catalog profiles.","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/"},{"categories":["macos"],"content":"We looked at some of the ways to secure macOS devices in Microsoft Intune, aligned with the NCSC platform guidance in macOS National Cyber Security Centre Security Settings in Intune, but this was when macOS device management in Intune was, at best, in beta. General hardening has been covered previously by Hubert Maslowski in their post that covers device compliance and configuration settings, but we‚Äôre looking at ensuring that the macOS devices meet the National Cyber Security Centre settings, including Cyber Essentials requirements. Now with the additional macOS settings, and new macOS versions, I thought we should look at how we can now secure these enrolled devices aligned to these known good practice settings. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:0:0","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#"},{"categories":["macos"],"content":" 1 NCSC GuidelinesHandily, NCSC provide a list of their recommendations for macOS device security, and unlike our previous attempt at hardening, we don‚Äôt need to rely on mobileconfig custom settings to deliver these hardening requirements. The settings from the platform guidance we‚Äôll cover in this post are as detailed in the sections below. We‚Äôre not going to cover all the restrictions, the implications, and the expected behaviour, as the company I work for charges customers for this and I already provide too much ‚Äòvalue add‚Äô as part of consultancy as it is. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:0","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#ncsc-guidelines"},{"categories":["macos"],"content":" 1.1 Device Password SettingsPassword complexity in the NCSC guidance is a little open ended, however when you dig through their other guidance, we can see that the new requirements for passwords on macOS devices have the restrictions of the below: 12 Characters or more Allow the use of lower case, upper case, numbers Block the use of special characters Block the use of simple passwords that have repeating, ascending, or descending characters Password does not expire Remember previous 24 passwords Minimum activity before a password is required set to five minutes The NCSC guidance does cover screen saver settings, and password sharing settings, so we can include those as well when configuring password settings. Require password after sleep or screen saver begins within five seconds Disable password sharing Disable proximity based password sharing requests With the above, we can easily create a device compliance policy‚Ä¶ Microsoft Intune macOS compliance policy for passwords. Warning When a compliance policy contains password restrictions, this will force the end user to change their password at next logon, and result in any attempt at elevation to fail with existing credentials until the password has been updated. ‚Ä¶and a device restrictions profile to meet these requirements. Microsoft Intune macOS configuration profile for passwords. Info As there isn‚Äôt a five second option for when a password is required, with the minimum being one minute, we‚Äôve set this to be immediately. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:1","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#device-password-settings"},{"categories":["macos"],"content":" 1.2 Login RestrictionsThere are a number of recommendations when it comes to the login window, with most of these impacting the end-user experience, but obviously for good security based reasons. We can group the restrictions into one Settings Catalog profile and one Device Restriction profile, who knows why Microsoft didn‚Äôt just make them all available within Settings Catalogs. Using a Settings Catalog profile we can cover the following restrictions. Disable Guest User Disable console logon Log out users after three minutes of inactivity* Block user setting a lock message Tip *We can‚Äôt do three minutes so five will have to do, Microsoft Intune supports between five minutes and 24 hours. Microsoft Intune macOS configuration profile for login settings. For the Device Restriction Profile we can cover the restriction below. Show only Name and Password Text fields Microsoft Intune macOS configuration profile for login settings. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:2","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#login-restrictions"},{"categories":["macos"],"content":" 1.3 Software UpdatesAh yes, software updates, basically we need to ensure that updates are installed within a 14-day window from the release of the update, that the updates can be installed by the end user, and that only production updates can be installed. Automatically install macOS updates Allow non-admin users to install software updates Do not defer macOS Updates Allow installation of macOS beta releases With these requirements we can create the Settings Catalog profile below to adhere to the restrictions. Microsoft Intune macOS configuration profile for software update settings. Info The Microsoft documentation talks about these settings in the Additional settings section, there appears to be a caveat to that whole document that these update settings will only apply to Supervised macOS devices. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:3","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#software-updates"},{"categories":["macos"],"content":" 1.4 Restrict Items in System PreferencesLimiting access to areas in the System areas used to be accomplished by a custom profile, but now we can use a Settings Catalog profile, oh how Intune has changed. The excerpt from the NCSC guide is as follows. Disable iCloud Profiles Disable Security \u0026 Privacy Disable Startup Disk Disable Sharing (enables remote management) Disable Siri Disable Xsan (If not in use) Disable FibreChannel (if not in use). We can now use a Settings Catalog profile to hide these system preference panes, using the Apple Developer Reference as a reference for each of these system preferences, allowing us to restrict the following areas: System Preference Value iCloud Profiles com.apple.preferences.icloud Security and Privacy com.apple.preference.security Startup Disk com.apple.preference.startupdisk Sharing com.apple.preferences.sharing Siri com.apple.Siri-Settings.extension Xsan com.apple.Xsan FibreChannel com.apple.prefpanel.fibrechannel With this we can create a new profile using the Disabled Preference Panes option. Microsoft Intune macOS configuration profile for system preferences. This will then disable these panes on the device for the end user, stopping them adding iCloud accounts, configuring sharing settings include remote control, along with other NCSC deemed risky areas on the macOS device. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:4","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#restrict-items-in-system-preferences"},{"categories":["macos"],"content":" 1.5 Time Server ConfigurationThis one is nice and easy, and a lot easier to handle now in Intune, without the need to create a new mobileconfig file, we can just throw both the time zone and time servers into the same Settings Catalog profile as per the requirement below. Specify time server by device location Ensure that you are selecting location specific time servers, in this instance we‚Äôre in the UK so using the UK servers from the NTP Pool Project, you may want to configure your own servers, but remember these devices may not always be on your local corporate network. Microsoft Intune macOS configuration profile for time zone settings. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:1:5","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#time-server-configuration"},{"categories":["macos"],"content":" 2 SummaryEven if you‚Äôre not aligning to NCSC or Cyber Essentials guidance for your macOS devices, this post will be useful as a good practice security configuration, as well as the fact that Microsoft is investing into the management of operating systems that aren‚Äôt Windows in Microsoft Intune. There have been many developments with macOS device management with new changes coming for these devices already listed in the In Development page, hopefully one day we‚Äôll get Azure Active Directory Microsoft Entra ID joined macOS devices‚Ä¶we can but hope. ","date":"11 July 2023","objectID":"/posts/macos-ncsc-revisited/:2:0","series":null,"tags":["intune","security","ncsc","configuration","Endpoint Security","custom profiles"],"title":"Revisiting macOS National Cyber Security Centre Security Settings","uri":"/posts/macos-ncsc-revisited/#summary"},{"categories":["intune"],"content":"Automatically managing assignments of Settings Catalog profiles for Windows and macOS devices in Microsoft Intune using PowerShell and Graph API.","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/"},{"categories":["intune"],"content":"Fresh off the back of a trawl of a Modern Endpoint Management LinkedIn group, someone wanted the ability to assign existing Settings Catalog profiles in Microsoft Intune to additional Groups‚Ä¶this sounded like a quick win if you fancy manually doing it, but no one wants that, and as I had experience of dealing with the logic when assigning apps, I thought I‚Äôd give it a go. Note The functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:0:0","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#"},{"categories":["intune"],"content":" 1 Assignment OverviewAssigning Settings Catalog profiles for Windows, macOS, and iOS/iPadOS devices isn‚Äôt anything new, though Settings Catalogs were a bit of a revelation when they first appeared in Microsoft Intune allowing you to build profiles from scratch with a searchable interface, and with the ability to assign them to groups and use Device Filters, I jumped at the chance to use them in place of custom profiles where applicable. What about the assignment though, what does that look like? ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:0","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#assignment-overview"},{"categories":["intune"],"content":" 1.1 Assignment RestrictionsSettings Catalog assignment isn‚Äôt too dissimilar from assigning any other profile type, though as you‚Äôll discover through subsequent posts, each has it‚Äôs own nuance when it comes to how you assign the profiles. So let‚Äôs list what we can do when it comes to assignment, and what we can‚Äôt do, as this will shape how we build out a PowerShell function to allow us to assign profiles in bulk. 1.1.1 Assignment WinsThese assignments, if already familiar with Microsoft Intune, shouldn‚Äôt come as any surprise: Included Groups: Assigning to All Devices, All Users, and Groups of Devices or Users Included Groups: Assigning to All Devices with an Include Device Filter, All Users with an Include Device Filter, and Groups of Devices or Users with an Include Device Filter Included Groups: Assigning to All Devices with an Exclude Device Filter, All Users with an Exclude Device Filter, and Groups of Devices or Users with an Exclude Device Filter Excluded Groups: Assigning to Groups of Devices or Users Info Remember that when excluding groups, you cannot mix user and device groups across include and exclude. So this is pretty useful and should, especially with Device Filters, be all you need for assignment. What about the things we can‚Äôt do? 1.1.2 Assignment No-nosThe list below is the current list of things you cannot do with the assignments for Settings Catalogs, and takes into consideration whether there are existing assignments on the profile: Included Groups: Assigning to All Devices and a Group of Devices or Users Included Groups: Assigning to All Users and a Group of Devices or Users Included Groups: Assigning to a Group that already has an assignment Included Groups: Assigning to All Devices that already has an assignment Included Groups: Assigning to All Users that already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Devices already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Users already has an assignment Excluded Groups: Assigning to Groups of Devices or Users with any Device Filter Excluded Groups: Assigning to All Devices or All Users Excluded Groups: Assigning to a Group that already has an assignment There are many restrictions when it comes to adding additional assignments, the above are the important ones, as we don‚Äôt want to be creating ourselves issues with assignments later on. Though this is going to give me a headache writing PowerShell to deal with this logic. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:1","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#assignment-restrictions"},{"categories":["intune"],"content":" 1.1 Assignment RestrictionsSettings Catalog assignment isn‚Äôt too dissimilar from assigning any other profile type, though as you‚Äôll discover through subsequent posts, each has it‚Äôs own nuance when it comes to how you assign the profiles. So let‚Äôs list what we can do when it comes to assignment, and what we can‚Äôt do, as this will shape how we build out a PowerShell function to allow us to assign profiles in bulk. 1.1.1 Assignment WinsThese assignments, if already familiar with Microsoft Intune, shouldn‚Äôt come as any surprise: Included Groups: Assigning to All Devices, All Users, and Groups of Devices or Users Included Groups: Assigning to All Devices with an Include Device Filter, All Users with an Include Device Filter, and Groups of Devices or Users with an Include Device Filter Included Groups: Assigning to All Devices with an Exclude Device Filter, All Users with an Exclude Device Filter, and Groups of Devices or Users with an Exclude Device Filter Excluded Groups: Assigning to Groups of Devices or Users Info Remember that when excluding groups, you cannot mix user and device groups across include and exclude. So this is pretty useful and should, especially with Device Filters, be all you need for assignment. What about the things we can‚Äôt do? 1.1.2 Assignment No-nosThe list below is the current list of things you cannot do with the assignments for Settings Catalogs, and takes into consideration whether there are existing assignments on the profile: Included Groups: Assigning to All Devices and a Group of Devices or Users Included Groups: Assigning to All Users and a Group of Devices or Users Included Groups: Assigning to a Group that already has an assignment Included Groups: Assigning to All Devices that already has an assignment Included Groups: Assigning to All Users that already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Devices already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Users already has an assignment Excluded Groups: Assigning to Groups of Devices or Users with any Device Filter Excluded Groups: Assigning to All Devices or All Users Excluded Groups: Assigning to a Group that already has an assignment There are many restrictions when it comes to adding additional assignments, the above are the important ones, as we don‚Äôt want to be creating ourselves issues with assignments later on. Though this is going to give me a headache writing PowerShell to deal with this logic. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:1","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#assignment-wins"},{"categories":["intune"],"content":" 1.1 Assignment RestrictionsSettings Catalog assignment isn‚Äôt too dissimilar from assigning any other profile type, though as you‚Äôll discover through subsequent posts, each has it‚Äôs own nuance when it comes to how you assign the profiles. So let‚Äôs list what we can do when it comes to assignment, and what we can‚Äôt do, as this will shape how we build out a PowerShell function to allow us to assign profiles in bulk. 1.1.1 Assignment WinsThese assignments, if already familiar with Microsoft Intune, shouldn‚Äôt come as any surprise: Included Groups: Assigning to All Devices, All Users, and Groups of Devices or Users Included Groups: Assigning to All Devices with an Include Device Filter, All Users with an Include Device Filter, and Groups of Devices or Users with an Include Device Filter Included Groups: Assigning to All Devices with an Exclude Device Filter, All Users with an Exclude Device Filter, and Groups of Devices or Users with an Exclude Device Filter Excluded Groups: Assigning to Groups of Devices or Users Info Remember that when excluding groups, you cannot mix user and device groups across include and exclude. So this is pretty useful and should, especially with Device Filters, be all you need for assignment. What about the things we can‚Äôt do? 1.1.2 Assignment No-nosThe list below is the current list of things you cannot do with the assignments for Settings Catalogs, and takes into consideration whether there are existing assignments on the profile: Included Groups: Assigning to All Devices and a Group of Devices or Users Included Groups: Assigning to All Users and a Group of Devices or Users Included Groups: Assigning to a Group that already has an assignment Included Groups: Assigning to All Devices that already has an assignment Included Groups: Assigning to All Users that already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Devices already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Users already has an assignment Excluded Groups: Assigning to Groups of Devices or Users with any Device Filter Excluded Groups: Assigning to All Devices or All Users Excluded Groups: Assigning to a Group that already has an assignment There are many restrictions when it comes to adding additional assignments, the above are the important ones, as we don‚Äôt want to be creating ourselves issues with assignments later on. Though this is going to give me a headache writing PowerShell to deal with this logic. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:1","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#assignment-no-nos"},{"categories":["intune"],"content":" 1.2 Getting Settings Catalog InformationWe‚Äôve now got a good grip on the methods for assignment, but to start this all off, we need a way to get both the the Settings Catalog profile itself, a method to capture all existing assignments, and importantly, how to add assignments to the profile. 1.2.1 Getting Settings CatalogsI already had the PowerShell function below at my disposal, so after connecting to Graph API using Connect-MgGraph and the Graph PowerShell SDK module, we can use the deviceManagementConfigurationPolicy endpoint in the below function to pull back either all Settings Catalogs, or specific ones using either the Id or Name. PowerShell Function Get-DeviceSettingsCatalog() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $Name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = 'beta' $Resource = \"deviceManagement/configurationPolicies?`$filter=technologies has 'mdm'\" try { if ($Id) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\" Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($Name) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.Name).contains(\"$Name\") } } Else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } Running this function will get us the information we need in the Id of the Setting Catalog profile. txt createdDateTime : 08/03/2023 13:39:14 creationSource : description : lastModifiedDateTime : 10/05/2023 08:40:16 name : Corporate_Configuration_Policy_Conflict platforms : windows10 priorityMetaData : roleScopeTagIds : {0} settingCount : 1 technologies : mdm id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 templateReference : @{templateId=; templateFamily=none; templateDisplayName=; templateDisplayVersion=} With a way to get a Settings Catalog profile, we now need a way to pull back any and all assignments for a profile using the deviceManagementConfigurationPolicyAssignments endpoint in Graph and the above Id of the profile. 1.2.2 Getting Settings Catalog Assignments PowerShell Function Get-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assignments\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } This is the set of assignments on an existing Settings Catalog profile that we can now query. Settings Catalog assignments in Microsoft Intune. Passing through the Id we will get an output that looks like the below for the above assignments, with the target being the important part, as this contains the details of the types of assignments as well as the Ids of the groups the profile is assigned to. txt id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_b2358c32-aff8-4408-bf90-d6c4c4e73a90 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=; deviceAndAppManagementAssignmentFilterType=none; groupId=b2358c32-aff8-4408-bf90-d6c4c4e73a90} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_c4480982-3342-4dc5-9c58-b272a77b7ab1 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=4feb8cf9-1529-41d6-80bb-498922c5e567; deviceAndAppManagementAssignmentFilterType=include; groupId=c4480982-3342-4dc5-9c58-b272a77b7ab1} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_f9c1e630-771d-4c12-b366","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:2","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#getting-settings-catalog-information"},{"categories":["intune"],"content":" 1.2 Getting Settings Catalog InformationWe‚Äôve now got a good grip on the methods for assignment, but to start this all off, we need a way to get both the the Settings Catalog profile itself, a method to capture all existing assignments, and importantly, how to add assignments to the profile. 1.2.1 Getting Settings CatalogsI already had the PowerShell function below at my disposal, so after connecting to Graph API using Connect-MgGraph and the Graph PowerShell SDK module, we can use the deviceManagementConfigurationPolicy endpoint in the below function to pull back either all Settings Catalogs, or specific ones using either the Id or Name. PowerShell Function Get-DeviceSettingsCatalog() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $Name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = 'beta' $Resource = \"deviceManagement/configurationPolicies?`$filter=technologies has 'mdm'\" try { if ($Id) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\" Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($Name) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.Name).contains(\"$Name\") } } Else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } Running this function will get us the information we need in the Id of the Setting Catalog profile. txt createdDateTime : 08/03/2023 13:39:14 creationSource : description : lastModifiedDateTime : 10/05/2023 08:40:16 name : Corporate_Configuration_Policy_Conflict platforms : windows10 priorityMetaData : roleScopeTagIds : {0} settingCount : 1 technologies : mdm id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 templateReference : @{templateId=; templateFamily=none; templateDisplayName=; templateDisplayVersion=} With a way to get a Settings Catalog profile, we now need a way to pull back any and all assignments for a profile using the deviceManagementConfigurationPolicyAssignments endpoint in Graph and the above Id of the profile. 1.2.2 Getting Settings Catalog Assignments PowerShell Function Get-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assignments\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } This is the set of assignments on an existing Settings Catalog profile that we can now query. Settings Catalog assignments in Microsoft Intune. Passing through the Id we will get an output that looks like the below for the above assignments, with the target being the important part, as this contains the details of the types of assignments as well as the Ids of the groups the profile is assigned to. txt id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_b2358c32-aff8-4408-bf90-d6c4c4e73a90 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=; deviceAndAppManagementAssignmentFilterType=none; groupId=b2358c32-aff8-4408-bf90-d6c4c4e73a90} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_c4480982-3342-4dc5-9c58-b272a77b7ab1 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=4feb8cf9-1529-41d6-80bb-498922c5e567; deviceAndAppManagementAssignmentFilterType=include; groupId=c4480982-3342-4dc5-9c58-b272a77b7ab1} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_f9c1e630-771d-4c12-b366","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:2","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#getting-settings-catalogs"},{"categories":["intune"],"content":" 1.2 Getting Settings Catalog InformationWe‚Äôve now got a good grip on the methods for assignment, but to start this all off, we need a way to get both the the Settings Catalog profile itself, a method to capture all existing assignments, and importantly, how to add assignments to the profile. 1.2.1 Getting Settings CatalogsI already had the PowerShell function below at my disposal, so after connecting to Graph API using Connect-MgGraph and the Graph PowerShell SDK module, we can use the deviceManagementConfigurationPolicy endpoint in the below function to pull back either all Settings Catalogs, or specific ones using either the Id or Name. PowerShell Function Get-DeviceSettingsCatalog() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $Name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = 'beta' $Resource = \"deviceManagement/configurationPolicies?`$filter=technologies has 'mdm'\" try { if ($Id) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\" Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($Name) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.Name).contains(\"$Name\") } } Else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } Running this function will get us the information we need in the Id of the Setting Catalog profile. txt createdDateTime : 08/03/2023 13:39:14 creationSource : description : lastModifiedDateTime : 10/05/2023 08:40:16 name : Corporate_Configuration_Policy_Conflict platforms : windows10 priorityMetaData : roleScopeTagIds : {0} settingCount : 1 technologies : mdm id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 templateReference : @{templateId=; templateFamily=none; templateDisplayName=; templateDisplayVersion=} With a way to get a Settings Catalog profile, we now need a way to pull back any and all assignments for a profile using the deviceManagementConfigurationPolicyAssignments endpoint in Graph and the above Id of the profile. 1.2.2 Getting Settings Catalog Assignments PowerShell Function Get-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assignments\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \"Response content:`n$ex\" Write-Host \"Request to $Uri failed with HTTP Status $($ex.Message)\" Break } } This is the set of assignments on an existing Settings Catalog profile that we can now query. Settings Catalog assignments in Microsoft Intune. Passing through the Id we will get an output that looks like the below for the above assignments, with the target being the important part, as this contains the details of the types of assignments as well as the Ids of the groups the profile is assigned to. txt id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_b2358c32-aff8-4408-bf90-d6c4c4e73a90 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=; deviceAndAppManagementAssignmentFilterType=none; groupId=b2358c32-aff8-4408-bf90-d6c4c4e73a90} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_c4480982-3342-4dc5-9c58-b272a77b7ab1 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=4feb8cf9-1529-41d6-80bb-498922c5e567; deviceAndAppManagementAssignmentFilterType=include; groupId=c4480982-3342-4dc5-9c58-b272a77b7ab1} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_f9c1e630-771d-4c12-b366","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:1:2","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#getting-settings-catalog-assignments"},{"categories":["intune"],"content":" 2 Assigning Settings CatalogsFirst thing to note about assignments in Microsoft Intune, is there is no PATCH option with Graph API for the assignment endpoints, what this means is there is no native way to update the assignments of a Settings Catalog profile, the default behaviour is to replace any and all existing assignments. After trying to deal with the restrictions around assignments, I can understand why there is no PATCH option, as it‚Äôs a nightmare dealing with the logic. We however, are not an API, so we can apply our squishy human brains and work something out to give us the ability to add new assignments, without ripping out the existing ones surely? ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:0","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#assigning-settings-catalogs"},{"categories":["intune"],"content":" 2.1 Building New AssignmentsSo where do we start exactly? With the many different ways to assign a profile, or the twelfty different restrictions when adding new assignments to existing ones? Let‚Äôs go with the relatively simple creation of new assignments first, as this seems a little more straightforward. Luckily for us, Microsoft provide documentation for the JSON format of the payload required to create a new assignment, and as we have our own function to get existing assignments, we can quite easily build out the required data in PowerShell based on each of the methods for assignment. The table below details the data used for each assignment method, so this is useful reference for us when building our own assignment function. Target Type Name Value Group Include @odata.type #microsoft.graph.groupAssignmentTarget groupId Id of the Assignment Group Group Exclude @odata.type #microsoft.graph.exclusionGroupAssignmentTarget groupId Id of the Assignment Group All Users Include @odata.type #microsoft.graph.allLicensedUsersAssignmentTarget All Devices Include @odata.type #microsoft.graph.allDevicesAssignmentTarget Device Filter Include deviceAndAppManagementAssignmentFilterType Include deviceAndAppManagementAssignmentFilterId Id of the Device Filter Device Filter Exclude deviceAndAppManagementAssignmentFilterType Exclude deviceAndAppManagementAssignmentFilterId Id of the Device Filter So we can take the above and using the below excerpt from an existing assignment function, build the required JSON data. PowerShell $TargetGroup = New-Object -TypeName psobject if ($GroupId) { if ($AssignmentType -eq 'Exclude') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.exclusionGroupAssignmentTarget' } elseif ($AssignmentType -eq 'Include') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.groupAssignmentTarget' } $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value \"$GroupId\" } else { if ($All -eq 'Users') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.allLicensedUsersAssignmentTarget' } ElseIf ($All -eq 'Devices') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.allDevicesAssignmentTarget' } } if ($FilterType) { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterId' -Value $FilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterType' -Value $FilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name 'target' -Value $TargetGroup This will give us the correct format that can be submitted to Graph API to create a new assignment for example for All Users with a Device Filter. JSON { \"assignments\": [ { \"target\": { \"@odata.type\": \"#microsoft.graph.allLicensedUsersAssignmentTarget\", \"deviceAndAppManagementAssignmentFilterId\": \"4feb8cf9-1529-41d6-80bb-498922c5e567\", \"deviceAndAppManagementAssignmentFilterType\": \"include\" } } ] } Or including a Group with a Device Filter. JSON { \"assignments\": [ { \"target\": { \"@odata.type\": \"#microsoft.graph.groupAssignmentTarget\", \"groupId\": \"f9c1e630-771d-4c12-b366-8a3e4db0509a\", \"deviceAndAppManagementAssignmentFilterId\": \"4feb8cf9-1529-41d6-80bb-498922c5e567\", \"deviceAndAppManagementAssignmentFilterType\": \"include\" } } ] } That was the easy part, and we can take the above methods to create new assignments. So now onto the head scratcher. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:1","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#building-new-assignments"},{"categories":["intune"],"content":" 2.2 Capturing Existing AssignmentsWe have the Get-DeviceSettingsCatalogAssignment function at our disposal now, so we can query a Settings Catalog profile to get any existing assignments, which is going to be important when dealing with the logic of adding new ones, for now we just need to get the existing ones into a useable JSON format so we can punt it back to Graph API. PowerShell #Gets existing Assignments $Assignments = Get-DeviceSettingsCatalogAssignment -Id $Id # Creates an array for the existing assignments $TargetGroups = @() foreach ($Assignment in $Assignments) { $TargetGroup = New-Object -TypeName psobject $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value $Assignment.target.'@odata.type' if ($Assignment.target.'@odata.type' -like '*groupAssignmentTarget*') { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value $Assignment.target.groupId } if ($Assignment.target.deviceAndAppManagementAssignmentFilterType -ne 'none') { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterId' -Value $Assignment.target.deviceAndAppManagementAssignmentFilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterType' -Value $Assignment.target.deviceAndAppManagementAssignmentFilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name 'target' -Value $TargetGroup $TargetGroups += $Target } This captures the existing assignments and adds them to the $TargetGroups array variable, which can then be added to for any new assignments we want to add, then converted to JSON and eventually posted to Graph API. So for our example, the output of the above would look something like the below. JSON { \"assignments\": [ { \"target\": { \"@odata.type\": \"#microsoft.graph.groupAssignmentTarget\", \"groupId\": \"b2358c32-aff8-4408-bf90-d6c4c4e73a90\" } }, { \"target\": { \"@odata.type\": \"#microsoft.graph.groupAssignmentTarget\", \"groupId\": \"c4480982-3342-4dc5-9c58-b272a77b7ab1\", \"deviceAndAppManagementAssignmentFilterId\": \"4feb8cf9-1529-41d6-80bb-498922c5e567\", \"deviceAndAppManagementAssignmentFilterType\": \"include\" } }, { \"target\": { \"@odata.type\": \"#microsoft.graph.exclusionGroupAssignmentTarget\", \"groupId\": \"f9c1e630-771d-4c12-b366-8a3e4db0509a\" } } ] } We‚Äôre onto something here, time to look at the logic around adding new assignments to existing ones, mmmm logic my favourite coffee fuelled exercise. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:2","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#capturing-existing-assignments"},{"categories":["intune"],"content":" 2.3 Handling Existing AssignmentsNow that we can capture existing assignment, we need to deal with the logic when trying to add new assignments to the Settings Catalog profile. This will not be fun. Let‚Äôs go through each of the assignment non-nos we‚Äôve already covered in this post. 2.3.1 Include Assignments Assigning to All Devices and a Group of Devices or Users We just need to check if the function parameter $All which equates to an option to assign to All Device or All Users exists, and whether there are any existing group targetted assignment on the Settings Catalog profile. PowerShell ElseIf (($All -ne '') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.groupAssignmentTarget')) { Write-Warning 'The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups' break } Assigning to All Users and a Group of Devices or Users This one is covered by the above logic, as we wrote the If statement to only look for the $All parameter which takes into consideration both the All Devices and All Users assignment targets. Assigning to a Group that already has an assignment This one is pretty easy really, we just need to compare the GroupId of the new assignment, to any existing assignments targetting to groups, and if the Ids match, to stop the function from running. PowerShell If (($GroupId -ne '') -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning 'The policy is already assigned to the Group' break } Assigning to All Devices that already has an assignment Similar to the above, we‚Äôre checking to see if the new All Devices assignment already existing, and if it does, stopping the progress of the assignment. PowerShell If (($All -eq 'Devices') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Devices group' break } Assigning to All Users that already has an assignment This was pretty much a copy and paste of the above, just swapping the devices parameters for the users one. PowerShell If (($All -eq 'Users') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Users group' break } Assigning to Groups of Devices or Users if All Devices already has an assignment We need to identity whether a group assignment is being created, which is captured with the $GroupId function parameter, and whether either the All Devices or All Users assignment target exists, and if it does break the function from running. PowerShell If (($GroupId -ne '') -and (($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget') -or ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget'))) { Write-Warning 'The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group' break } Assigning to Groups of Devices or Users if All Users already has an assignment This one is captured in the above logic, which is lucky as I was running out of steam by this point. 2.3.2 Exclude Assignments Assigning to Groups of Devices or Users with any Device Filter Using the parameters of the function itself, we can stop this assignment type, with parameters configured for Group assignment in $GroupID and the Assignment Type parameter $AssignmentType, as well as the Filter ID parameter $FilterId. With this combination of parameters being true, we can throw an error and stop the function from running. PowerShell If (($AssignmentType -eq 'Exclude') -and ($GroupId -ne '') -and ($FilterId -ne '')) { Write-Warning 'You cannot assign a group with a filter as an exclude assignment' break } Assigning to All Devices or All Users We can again handle this in the function itself, with parameters for an ‚ÄòAll Devices or Users‚Äô assignment and the ‚ÄòAssignment Type‚Äô, so if you select the $All assignment and the assig","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:3","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#handling-existing-assignments"},{"categories":["intune"],"content":" 2.3 Handling Existing AssignmentsNow that we can capture existing assignment, we need to deal with the logic when trying to add new assignments to the Settings Catalog profile. This will not be fun. Let‚Äôs go through each of the assignment non-nos we‚Äôve already covered in this post. 2.3.1 Include Assignments Assigning to All Devices and a Group of Devices or Users We just need to check if the function parameter $All which equates to an option to assign to All Device or All Users exists, and whether there are any existing group targetted assignment on the Settings Catalog profile. PowerShell ElseIf (($All -ne '') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.groupAssignmentTarget')) { Write-Warning 'The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups' break } Assigning to All Users and a Group of Devices or Users This one is covered by the above logic, as we wrote the If statement to only look for the $All parameter which takes into consideration both the All Devices and All Users assignment targets. Assigning to a Group that already has an assignment This one is pretty easy really, we just need to compare the GroupId of the new assignment, to any existing assignments targetting to groups, and if the Ids match, to stop the function from running. PowerShell If (($GroupId -ne '') -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning 'The policy is already assigned to the Group' break } Assigning to All Devices that already has an assignment Similar to the above, we‚Äôre checking to see if the new All Devices assignment already existing, and if it does, stopping the progress of the assignment. PowerShell If (($All -eq 'Devices') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Devices group' break } Assigning to All Users that already has an assignment This was pretty much a copy and paste of the above, just swapping the devices parameters for the users one. PowerShell If (($All -eq 'Users') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Users group' break } Assigning to Groups of Devices or Users if All Devices already has an assignment We need to identity whether a group assignment is being created, which is captured with the $GroupId function parameter, and whether either the All Devices or All Users assignment target exists, and if it does break the function from running. PowerShell If (($GroupId -ne '') -and (($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget') -or ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget'))) { Write-Warning 'The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group' break } Assigning to Groups of Devices or Users if All Users already has an assignment This one is captured in the above logic, which is lucky as I was running out of steam by this point. 2.3.2 Exclude Assignments Assigning to Groups of Devices or Users with any Device Filter Using the parameters of the function itself, we can stop this assignment type, with parameters configured for Group assignment in $GroupID and the Assignment Type parameter $AssignmentType, as well as the Filter ID parameter $FilterId. With this combination of parameters being true, we can throw an error and stop the function from running. PowerShell If (($AssignmentType -eq 'Exclude') -and ($GroupId -ne '') -and ($FilterId -ne '')) { Write-Warning 'You cannot assign a group with a filter as an exclude assignment' break } Assigning to All Devices or All Users We can again handle this in the function itself, with parameters for an ‚ÄòAll Devices or Users‚Äô assignment and the ‚ÄòAssignment Type‚Äô, so if you select the $All assignment and the assig","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:3","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#include-assignments"},{"categories":["intune"],"content":" 2.3 Handling Existing AssignmentsNow that we can capture existing assignment, we need to deal with the logic when trying to add new assignments to the Settings Catalog profile. This will not be fun. Let‚Äôs go through each of the assignment non-nos we‚Äôve already covered in this post. 2.3.1 Include Assignments Assigning to All Devices and a Group of Devices or Users We just need to check if the function parameter $All which equates to an option to assign to All Device or All Users exists, and whether there are any existing group targetted assignment on the Settings Catalog profile. PowerShell ElseIf (($All -ne '') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.groupAssignmentTarget')) { Write-Warning 'The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups' break } Assigning to All Users and a Group of Devices or Users This one is covered by the above logic, as we wrote the If statement to only look for the $All parameter which takes into consideration both the All Devices and All Users assignment targets. Assigning to a Group that already has an assignment This one is pretty easy really, we just need to compare the GroupId of the new assignment, to any existing assignments targetting to groups, and if the Ids match, to stop the function from running. PowerShell If (($GroupId -ne '') -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning 'The policy is already assigned to the Group' break } Assigning to All Devices that already has an assignment Similar to the above, we‚Äôre checking to see if the new All Devices assignment already existing, and if it does, stopping the progress of the assignment. PowerShell If (($All -eq 'Devices') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Devices group' break } Assigning to All Users that already has an assignment This was pretty much a copy and paste of the above, just swapping the devices parameters for the users one. PowerShell If (($All -eq 'Users') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Users group' break } Assigning to Groups of Devices or Users if All Devices already has an assignment We need to identity whether a group assignment is being created, which is captured with the $GroupId function parameter, and whether either the All Devices or All Users assignment target exists, and if it does break the function from running. PowerShell If (($GroupId -ne '') -and (($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget') -or ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget'))) { Write-Warning 'The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group' break } Assigning to Groups of Devices or Users if All Users already has an assignment This one is captured in the above logic, which is lucky as I was running out of steam by this point. 2.3.2 Exclude Assignments Assigning to Groups of Devices or Users with any Device Filter Using the parameters of the function itself, we can stop this assignment type, with parameters configured for Group assignment in $GroupID and the Assignment Type parameter $AssignmentType, as well as the Filter ID parameter $FilterId. With this combination of parameters being true, we can throw an error and stop the function from running. PowerShell If (($AssignmentType -eq 'Exclude') -and ($GroupId -ne '') -and ($FilterId -ne '')) { Write-Warning 'You cannot assign a group with a filter as an exclude assignment' break } Assigning to All Devices or All Users We can again handle this in the function itself, with parameters for an ‚ÄòAll Devices or Users‚Äô assignment and the ‚ÄòAssignment Type‚Äô, so if you select the $All assignment and the assig","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:3","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#exclude-assignments"},{"categories":["intune"],"content":" 2.4 The Assignment FunctionWe now have all the component parts, all is left to do is to throw them all at Visual Studio Code and pray that we‚Äôve got something that works, configuring all the required logic and the function parameters to allow the assignment of new groups to Settings Catalog profiles. I‚Äôve given the option to not only add to existing assignments, but also to just flatten the existing ones and create new using the $AssignmentAction parameter. PowerShell Function Add-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Id, [parameter(Mandatory = $false)] [string]$GroupId, [parameter(Mandatory = $true)] [ValidateSet('Include', 'Exclude')] [string]$AssignmentType, [parameter(Mandatory = $false)] [string]$FilterId, [parameter(Mandatory = $false)] [ValidateSet('Include', 'Exclude')] [string]$FilterType, [parameter(Mandatory = $false)] [ValidateSet('Users', 'Devices')] [string]$All, [parameter(Mandatory = $true)] [ValidateSet('Replace', 'Add')] $AssignmentAction ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assign\" try { # Stopping assignmnent of All Users or All Devices as an exclude assignment if (($All -ne '') -and ($AssignmentType -eq 'Exclude')) { Write-Warning 'You cannot All Devices or All Users groups as an exclude assignment' break } # Stopping assignment of group and All Devices/Users if (($All -ne '') -and ($GroupId -ne '')) { Write-Warning 'You cannot assign to All Devices or All Users, and groups' break } # Stopping assignment of group with filter as an exclude assignment if (($AssignmentType -eq 'Exclude') -and ($GroupId -ne '') -and ($FilterId -ne '')) { Write-Warning 'You cannot assign a group with a filter as an exclude assignment' break } # If Adding an assignment to existing assignments If ($AssignmentAction -eq 'Add') { # Checking if there are Assignments already configured $Assignments = Get-DeviceSettingsCatalogAssignment -Id $Id if ($Assignments.count -ge 1) { # Checking if the group is already assigned If (($GroupId -ne '') -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning 'The policy is already assigned to the Group' break } # Checking if already assigned to All Devices ElseIf (($All -eq 'Devices') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Devices group' break } # Checking if aleady assigned to All users ElseIf (($All -eq 'Users') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Users group' break } # Checking if already assigned to groups when assigning 'All' assignment ElseIf (($All -ne '') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.groupAssignmentTarget')) { Write-Warning 'The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups' break } # Checking if already assigned to 'All' when assigning groups ElseIf (($GroupId -ne '') -and (($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget') -or ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget'))) { Write-Warning 'The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group' break } # If new assignment viable, captures existing assignments Else { # Creates an array for the existing assignments $TargetGroups = @() foreach ($Assignment in $Assignments) { $TargetGroup = New-Object -TypeName psobject $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value $Assignment.target.'@odata.type' if ($Assignment.target.'@odata.type' -like '*groupAssignmentTarget*') { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value $Assignment.target.groupId } if ($Assignment.target.deviceAndAppManagementAssignmen","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:4","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#the-assignment-function"},{"categories":["intune"],"content":" 2.4 The Assignment FunctionWe now have all the component parts, all is left to do is to throw them all at Visual Studio Code and pray that we‚Äôve got something that works, configuring all the required logic and the function parameters to allow the assignment of new groups to Settings Catalog profiles. I‚Äôve given the option to not only add to existing assignments, but also to just flatten the existing ones and create new using the $AssignmentAction parameter. PowerShell Function Add-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Id, [parameter(Mandatory = $false)] [string]$GroupId, [parameter(Mandatory = $true)] [ValidateSet('Include', 'Exclude')] [string]$AssignmentType, [parameter(Mandatory = $false)] [string]$FilterId, [parameter(Mandatory = $false)] [ValidateSet('Include', 'Exclude')] [string]$FilterType, [parameter(Mandatory = $false)] [ValidateSet('Users', 'Devices')] [string]$All, [parameter(Mandatory = $true)] [ValidateSet('Replace', 'Add')] $AssignmentAction ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assign\" try { # Stopping assignmnent of All Users or All Devices as an exclude assignment if (($All -ne '') -and ($AssignmentType -eq 'Exclude')) { Write-Warning 'You cannot All Devices or All Users groups as an exclude assignment' break } # Stopping assignment of group and All Devices/Users if (($All -ne '') -and ($GroupId -ne '')) { Write-Warning 'You cannot assign to All Devices or All Users, and groups' break } # Stopping assignment of group with filter as an exclude assignment if (($AssignmentType -eq 'Exclude') -and ($GroupId -ne '') -and ($FilterId -ne '')) { Write-Warning 'You cannot assign a group with a filter as an exclude assignment' break } # If Adding an assignment to existing assignments If ($AssignmentAction -eq 'Add') { # Checking if there are Assignments already configured $Assignments = Get-DeviceSettingsCatalogAssignment -Id $Id if ($Assignments.count -ge 1) { # Checking if the group is already assigned If (($GroupId -ne '') -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning 'The policy is already assigned to the Group' break } # Checking if already assigned to All Devices ElseIf (($All -eq 'Devices') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Devices group' break } # Checking if aleady assigned to All users ElseIf (($All -eq 'Users') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Warning 'The policy is already assigned to the All Users group' break } # Checking if already assigned to groups when assigning 'All' assignment ElseIf (($All -ne '') -and ($Assignments.target.'@odata.type' -contains '#microsoft.graph.groupAssignmentTarget')) { Write-Warning 'The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups' break } # Checking if already assigned to 'All' when assigning groups ElseIf (($GroupId -ne '') -and (($Assignments.target.'@odata.type' -contains '#microsoft.graph.allDevicesAssignmentTarget') -or ($Assignments.target.'@odata.type' -contains '#microsoft.graph.allLicensedUsersAssignmentTarget'))) { Write-Warning 'The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group' break } # If new assignment viable, captures existing assignments Else { # Creates an array for the existing assignments $TargetGroups = @() foreach ($Assignment in $Assignments) { $TargetGroup = New-Object -TypeName psobject $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value $Assignment.target.'@odata.type' if ($Assignment.target.'@odata.type' -like '*groupAssignmentTarget*') { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value $Assignment.target.groupId } if ($Assignment.target.deviceAndAppManagementAssignmen","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:2:4","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#using-the-assignment-function"},{"categories":["intune"],"content":" 3 SummaryThis will end up being the first in a series of posts about managing assignments in Microsoft Intune, but luckily for me, Settings Catalog assignment is one of the more complicated ones (he says already knowing the Application assignment is more complicated) so the next one I look at should be a little less logic heavy, as well as the fact I should be able to reuse some of the Settings Catalog profile assignment function across many areas of Microsoft Intune. ","date":"27 June 2023","objectID":"/posts/managing-intune-assignment-settingscatalog/:3:0","series":null,"tags":["settings catalog","assignments","graph","powershell","automation"],"title":"Managing Settings Catalog Profile Assignments in Microsoft Intune","uri":"/posts/managing-intune-assignment-settingscatalog/#summary"},{"categories":["windows"],"content":"Creation of Microsoft Intune device custom compliance policies for third party antivirus and anti spyware solutions.","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/"},{"categories":["windows"],"content":"So what happens when you‚Äôre not using Windows Defender on your Windows 10 and later Microsoft Intune enrolled devices, and you‚Äôre not happy with the basic compliance checks for Third-Party Antivirus products? Microsoft have come to the rescue with their Custom Compliance Settings, so let‚Äôs utilise this detect and check policy, and leverage it to detect and report on Non-Microsoft Antivirus products, their real time protection status, as well as whether the definitions are up to date. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:0:0","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#"},{"categories":["windows"],"content":" 1 Custom Compliance PoliciesAs Custom Compliance isn‚Äôt that new a feature of Microsoft Intune, I‚Äôm not going to deep dive into the process, a number of other people have done that already: Peter van der Woude Call4Cloud Device Advice We‚Äôre going to focus on how to use it to achieve our goal, detecting additional information about third-party Antivirus solutions. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:1:0","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#custom-compliance-policies"},{"categories":["windows"],"content":" 1.1 PowerShell and WMIWe need a way to get information about the expected active Antivirus product, in this instance ‚ÄòSophos Antivirus‚Äô, installed on device; to do this we can use the WMI Class AntiVirusProduct within the root\\SecurityCenter2 namespace using either: PowerShell Get-WmiObject -Namespace \"root\\SecurityCenter2\" -Class AntiVirusProduct Or PowerShell Get-CimInstance -Namespace \"root\\SecurityCenter2\" -Class AntiVirusProduct This will pull back details about the Antivirus software registered by Windows, as you can see from the below, it will pull back all products registered, including Windows Defender. txt __GENUS : 2 __CLASS : AntiVirusProduct __SUPERCLASS : __DYNASTY : AntiVirusProduct __RELPATH : AntiVirusProduct.instanceGuid=\"{8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE}\" __PROPERTY_COUNT : 6 __DERIVATION : {} __SERVER : LT01540 __NAMESPACE : ROOT\\SecurityCenter2 __PATH : \\\\COMPUTERNAME\\ROOT\\SecurityCenter2:AntiVirusProduct.instanceGuid=\"{8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE}\" displayName : Sophos Anti-Virus instanceGuid : {8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE} pathToSignedProductExe : C:\\Program Files (x86)\\Sophos\\Sophos Anti-Virus\\WSCClient.exe pathToSignedReportingExe : C:\\Program Files (x86)\\Sophos\\Sophos Anti-Virus\\WSCClient.exe productState : 331776 timestamp : Tue, 16 Nov 2021 17:29:40 GMT __GENUS : 2 __CLASS : AntiVirusProduct __SUPERCLASS : __DYNASTY : AntiVirusProduct __RELPATH : AntiVirusProduct.instanceGuid=\"{D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\" __PROPERTY_COUNT : 6 __DERIVATION : {} __SERVER : __NAMESPACE : ROOT\\SecurityCenter2 __PATH : \\\\\\ROOT\\SecurityCenter2:AntiVirusProduct.instanceGuid=\"{D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\" displayName : Windows Defender instanceGuid : {D68DDC3A-831F-4fae-9E44-DA132C1ACF46} pathToSignedProductExe : windowsdefender:// pathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe productState : 393472 timestamp : Thu, 16 Dec 2021 10:49:39 GMT So we will need a way to filter only to the expected active Antivirus software installed. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:1:1","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#powershell-and-wmi"},{"categories":["windows"],"content":" 1.2 Antivirus Product StateWith the information available about the Antivirus products, we need to be able to identify whether Real Time Protection is running, as well as whether the Definitions are up to date. I‚Äôd say luckily, but I‚Äôd be lying, we have the productState information to work with. txt productState : 393472 This hex value does translate into something we can use to identify the definition and protection status checks, and thanks to Marc Schneider we can actually understand this number and how to use it as part of a Custom Compliance policy. The six-digit value for ‚ÄòproductState‚Äô can be broken down into three pairs of two-digits, with each actually meaning something once converted to a hex string: 1st Pair: Product Type 2nd Pair: Real Time Protection Status 3rd Pair: Definition Status Info The 2nd and 3rd pair may report differently depending on your Antivirus product, as detailed in this post, so you will have to check this on a device with up-to-date definitions as well as real time protection enabled to be sure. The values for each of these pairs for Sophos Antivirus can be seen below: Item Value Description Real Time Protection Status 00 Off 01 Expired 10 On 11 Snoozed Definition Status 00 Up to Date 10 Out of Date So we now have a way to identify and confirm that both Real Time protection is enabled, and Definitions are in place for the Antivirus product of choosing. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:1:2","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#antivirus-product-state"},{"categories":["windows"],"content":" 1.3 Detection Script CreationWith a couple of variables, some hex conversion, switches, and a little bit of logic, we can get the information we need and throw it into the JSON format required by Microsoft to allow the Custom Compliance script to work as expected. We‚Äôve used the $AVClient variable, which will allow re-use of the script depending on which product is installed across your device estate. We also have to be able to capture and present back when the script doesn‚Äôt detect the specified $AVClient variable, otherwise we‚Äôll get some grim looking compliance errors on those devices. Note These commands and scripts have now been updated to use Get-CimInstance due to Microsoft deprecating WMIC commands. ThirdPartyAV.ps1 $avClient = 'Sophos Anti-Virus' $avProduct = Get-CimInstance -Namespace 'root\\SecurityCenter2' -Class AntiVirusProduct | Where-Object { $_.displayName -eq $avClient } | Select-Object -First 1 #$avProduct = Get-WmiObject -Namespace 'root\\SecurityCenter2' -Class AntiVirusProduct | Where-Object { $_.displayName -eq $avClient } | Select-Object -First 1 $avSummary = New-Object -TypeName PSObject If ($avProduct) { $hexProductState = [Convert]::ToString($avProduct.productState, 16).PadLeft(6, '0') $hexRealTimeProtection = $hexProductState.Substring(2, 2) $hexDefinitionStatus = $hexProductState.Substring(4, 2) $realTimeProtectionStatus = switch ($hexRealTimeProtection) { '00' { 'Off' } '01' { 'Expired' } '10' { 'On' } '11' { 'Snoozed' } default { 'Unknown' } } $definitionStatus = switch ($hexDefinitionStatus) { '00' { 'Up to Date' } '10' { 'Out of Date' } default { 'Unknown' } } $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient\" -Value $avProduct.displayName $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient real time protection enabled\" -Value $realTimeProtectionStatus $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient definitions up-to-date\" -Value $definitionStatus } Else { $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient\" -Value 'Error: No Antivirus product found' $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient real time protection enabled\" -Value 'Error: No Antivirus product found' $avSummary | Add-Member -MemberType NoteProperty -Name \"$avClient definitions up-to-date\" -Value 'Error: No Antivirus product found' } return $avSummary | ConvertTo-Json -Compress Running this script on a machine with the Antivirus product installed would be a good idea to test that the scripts works, and is outputting the correct information in the required format for Intune to translate. The uncompressed output from the script should look a little bit like the below: JSON { \"Sophos Anti-Virus\": \"Sophos Anti-Virus\", \"Sophos Anti-Virus real time protection enabled\": \"On\", \"Sophos Anti-Virus definitions up-to-date\": \"Up to Date\" } With the compressed version looking like this: JSON {\"Sophos Anti-Virus\":\"Sophos Anti-Virus\",\"Sophos Anti-Virus real time protection enabled\":\"On\",\"Sophos Anti-Virus definitions up-to-date\":\"Up to Date\"} ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:1:3","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#detection-script-creation"},{"categories":["windows"],"content":" 1.4 JSON ChecksAs we‚Äôve seen in the JSON check requirements from Microsoft, we now need to build out a JSON file using the template as a starter, making sure that our JSON output from the script can be translated into something the Custom Compliance Policy can use. Below is the updated JSON content we can use for the check, I‚Äôve kept this quite light touch if I‚Äôm honest, and not specific to the Antivirus product, again so this can be re-used without changing a million things. You will need to change the Operand for the first Rule to match the Antivirus product name you have installed, and if you want to, feel free to update the following fields to your taste: MoreInfoUrl Title Description Note Updated to include improved presentation to the end user of the issues as displayed in the Company Portal. ThirdPartyAV.json { \"Rules\": [ { \"SettingName\": \"Sophos Anti-Virus\", \"Operator\": \"IsEquals\", \"DataType\": \"String\", \"Operand\": \"Sophos Anti-Virus\", \"MoreInfoUrl\": \"https://support.home.sophos.com/hc/en-us/categories/115001242663-Installing-Sophos-Home\", \"RemediationStrings\": [ { \"Language\": \"en_US\", \"Title\": \"Sophos Anti-Virus was not detected.\", \"Description\": \"You must have Sophos Antivirus installed on your device to protect it from malware.\" } ] }, { \"SettingName\": \"Sophos Anti-Virus real time protection enabled\", \"Operator\": \"IsEquals\", \"DataType\": \"String\", \"Operand\": \"On\", \"MoreInfoUrl\": \"https://support.home.sophos.com/hc/en-us/articles/115005596186-Configuring-Real-Time-Protection\", \"RemediationStrings\": [ { \"Language\": \"en_US\", \"Title\": \"Sophos Antivirus real time protection is not enabled\", \"Description\": \"Real time protection must be enabled in Sophos to protect your device, please enable this setting.\" } ] }, { \"SettingName\": \"Sophos Anti-Virus definitions up-to-date\", \"Operator\": \"IsEquals\", \"DataType\": \"String\", \"Operand\": \"Up to Date\", \"MoreInfoUrl\": \"https://kb.mit.edu/confluence/pages/viewpage.action?pageId=152584581#:~:text=By%20default%2C%20Sophos%20Anti%2DVirus,as%20detailed%20%E2%80%93%20is%20not%20necessary.\", \"RemediationStrings\": [ { \"Language\": \"en_US\", \"Title\": \"Sophos Antivirus definitions are not up to date.\", \"Description\": \"Please update the Sophos Antivirus definitions to ensure you device is protected from malware.\" } ] } ] } ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:1:4","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#json-checks"},{"categories":["windows"],"content":" 2 Deploying Custom ComplianceWe‚Äôve now got both a PowerShell script and JSON file, so the last steps are to throw these into Microsoft Intune. First off we need to add the PowerShell script in the Compliance Scripts section. Compliance Policy script in Microsoft Intune. Following this, we can now create our Custom Compliance policy for Windows; select the previously created PowerShell script, and we‚Äôll need to upload the JSON file created earlier. Compliance Policy in Microsoft Intune. Once we‚Äôve got this in place, we can now assign the Compliance Policy. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:2:0","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#deploying-custom-compliance"},{"categories":["windows"],"content":" 2.1 Checking Compliance StateWith the Custom Compliance policy deployed, and waiting a little while for devices to start reporting back, we can check on the status of the devices it has been assigned to. We have some good devices: Microsoft Intune Compliance check with good results. Some not so good: Microsoft Intune Compliance check with poor results. Some truly problematic: Microsoft Intune Compliance check with bad results. With this Compliance Policy now in place, we not only get a view of the device estate, but can integrate Compliance into Conditional Access Policies, so it‚Äôs not a bad situation to be in at all. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:2:1","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#checking-compliance-state"},{"categories":["windows"],"content":" 3 SummaryCustom Compliance does seem like a bit of an effort, and it currently has minimal operators for the JSON check, an inability to add more than one PowerShell script to a single policy, an eight hour wait for the Compliance state to update after remediation, and a few other limitations, but for those organisations that aren‚Äôt fully in bed with Microsoft when it comes down to endpoint protection products, it does offer a way to extend compliance to these solutions. ","date":"11 June 2023","objectID":"/posts/custom-compliance-third-party-av/:3:0","series":null,"tags":["intune","compliance","security","antivirus","powershell"],"title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","uri":"/posts/custom-compliance-third-party-av/#summary"},{"categories":["windows"],"content":"Creation of Microsoft Intune Suite license Endpoint Privilege Management rules based on audit of Windows devices using PowerShell and Graph API.","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/"},{"categories":["windows"],"content":"So you‚Äôre interested in Endpoint Privilege Management in Microsoft Intune, you‚Äôve found, begged for, borrowed or stolen the money for shiny new Intune Suite or EPM licenses, and in you‚Äôre excitement you‚Äôve gone and deployed a new policy to audit using the Reporting Scope options, all elevations across your managed Windows 10 and later devices. Now what? Well it‚Äôs policy creation time, but that seems like a labour intensive (well many clicks) task, and as much as the reports give you all the required information you need to review unmanaged elevations and create new policies and elevation rules, there has to be a better way to take the data in the report and create these policies and subsequent rules for you. Note The functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:0:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#"},{"categories":["windows"],"content":" 1 EPM ReportingThe Endpoint elevation report in Microsoft Intune will give us the data we need to create hash based rules, so let‚Äôs find a way to get the report data and export it with some collated information to make reviewing the elevations a little easier, as no one wants to review individual elevations from each user on a case by case basis, unless you‚Äôre in InfoSec. Microsoft Intune Elevation Report. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:1:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#epm-reporting"},{"categories":["windows"],"content":" 1.1 Getting Report DataOnce connected to Graph API using Connect-MgGraph we can use the deviceManagement/privilegeManagementElevations endpoint (of which there is no documentation currently, tut tut Microsoft) to pull back the report data. I‚Äôve given the option to pull back Managed, Unmanaged, and All elevation types with this function so it‚Äôs at least reusable, though for now we only care about the Unmanaged elevations. PowerShell Function Get-DeviceEPMReport() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] [ValidateSet('Managed', 'Unmanaged')] [String]$Elevation, [Parameter(Mandatory = $false)] $Top ) $graphApiVersion = 'beta' $Resource = 'deviceManagement/privilegeManagementElevations' try { if ($Elevation -eq 'Managed') { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)?filter=(elevationType ne 'unmanagedElevation')\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } elseif ($Elevation -eq 'Unmanaged') { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)?filter=(elevationType eq 'unmanagedElevation')\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Running the PowerShell function will give us an output of each Unmanaged elevation, which we can then process, apply some groupings, and eventually export. PowerShell Get-DeviceEPMReport -Elevation Unmanaged Screenshot PowerShell script elevation report output. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:1:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#getting-report-data"},{"categories":["windows"],"content":" 1.2 Exporting Report DataNow that we have the data from the elevation report, I thought it best we group the elevations by hash value, as this is a unique identifier for each application that has been elevated by a user, as well as counting the number of elevations for that application, the users who have elevated, and the devices they have elevated from. The above information, and below details required for rule creation, allows us to review the elevations and whether we want to create rules from them: Count of Elevations for the application: so we can see whether this is a widely used elevated application Elevated application file name: required for rule creation Elevated application internal name Elevated application publisher Elevated application product name Elevated application description Elevated application file path: formatted with \\\\ as is required by the rule creation Elevated application file version Users who have elevated the application: formatted for only unique users so we can assess which users are elevating the application Devices where the application has been elevated: formatted for only unique devices so we can assess from which devices the application is being elevated The below PowerShell captures all the required data in the correct formats to a new $Report array variable, which we can then export to CSV once we‚Äôve cycled through all elevations. PowerShell $Report = @() $Hashes = Get-DeviceEPMReport -Elevation Unmanaged | Group-Object -Property hash foreach ($Hash in $Hashes) { $Elevations = $Hash.Group $Users = @() $Devices = @() foreach ($Elevation in $Elevations) { $FileName = $Elevation.filePath | Split-Path -Leaf $FileInternalName = $Elevation.internalName $FileCompany = $Elevation.companyName $FileProduct = $Elevation.productName $FileDescription = $Elevation.fileDescription $FilePath = ($Elevation.filePath | Split-Path) -replace '\\\\', '\\\\' $FileVersion = $Elevation.fileVersion $Users += $Elevation.upn $Devices += $Elevation.deviceName } $Data = [PSCustomObject]@{ ElevationCount = $Hash.Count Product = $FileProduct Description = $FileDescription Publisher = $FileCompany FileName = $FileName FileInternalName = $FileInternalName FileVersion = $FileVersion FilePath = $FilePath FileHash = $Hash.Name Users = (($Users | Get-Unique) -join ' ' | Out-String).Trim() Devices = (($Devices | Get-Unique) -join ' ' | Out-String).Trim() ElevationType = 'Automatic/UserAuthentication/UserJustification' Group = 'GroupName' } $Report += $Data } Exporting the $Report variable to CSV using the append function for each elevation, we get something like the below. csv \"ElevationCount\",\"Product\",\"Description\",\"Publisher\",\"FileName\",\"FileInternalName\",\"FileVersion\",\"FilePath\",\"FileHash\",\"Users\",\"Devices\",\"ElevationType\",\"Group\" \"6\",\"Microsoft¬Æ Windows¬Æ Operating System\",\"Windows PowerShell\",\"Microsoft Corporation\",\"powershell.exe\",\"POWERSHELL\",\"10.0.19041.2913\",\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\",\"B4E7BC24BF3F5C3DA2EB6E9EC5EC10F90099DEFA91B820F2F3FC70DD9E4785C4\",\"AzureAD\\AlexWilber AzureAD\\ChristieCline\",\"DESKTOP-DL6CCRJ DESKTOP-7KFLL12\",\"Automatic/UserAuthentication/UserJustification\",\"GroupName\" \"4\",\"PaladinVPN\",\"PaladinVPN\",\"Ledger Media Ltd\",\"PaladinVPN.exe\",\"PaladinVPN.exe\",\"2.1.3.102\",\"C:\\\\Program Files (x86)\\\\PaladinVPN\",\"B6EF395DE2F28162DBAFCA79BAABEBB211245A68425CE096402030417FEA1160\",\"AzureAD\\AlexWilber\",\"DESKTOP-DL6CCRJ\",\"Automatic/UserAuthentication/UserJustification\",\"GroupName\" \"12\",\"Microsoft¬Æ Windows¬Æ Operating System\",\"Windows Command Processor\",\"Microsoft Corporation\",\"cmd.exe\",\"cmd\",\"10.0.19041.746\",\"C:\\\\Windows\\\\system32\",\"B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450\",\"AzureAD\\AlexWilber AzureAD\\ChristieCline\",\"DESKTOP-DL6CCRJ DESKTOP-7KFLL12\",\"Automatic/UserAuthentication/UserJustification\",\"GroupName\" Now we have something to review, with two additional fields of ElevationType and Group that we will use for creation of new EPM policies and rules later on, forward pla","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:1:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#exporting-report-data"},{"categories":["windows"],"content":" 2 EPM PoliciesI have no shame when I say that I started from Andrew Taylor‚Äôs script to create EPM rules using PowerShell, allowing the creation of new EPM Policies and associated rules in Microsoft Intune based on a local files on the machine the script is being executed from. For me what this was missing was the ability to create multiple rules per EPM policy, and the to not rely on the file being local to the machine running the script to capture the required rule data. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:2:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#epm-policies"},{"categories":["windows"],"content":" 2.1 Importing Rule DataWith the CSV report exported, we now need to update the file itself, removing entries where we don‚Äôt want to create rules, and updating those we do want to create with both the ElevationType and Group for each rule we want to create. The ElevationType field needs to be populated with one of the below entries based on the approval type to be used: Automatic: elevation happens invisibly to the user. There‚Äôs no prompt, and no indication that the file is running in an elevated context. UserAuthentication: A user confirmed elevation always requires the user to click on a confirmation prompt to run the file requiring users to authenticate using their organization credentials. UserJustification: A user confirmed elevation always requires the user to click on a confirmation prompt to run the file requiring the user to enter a business justification. The group field is there to not only reference which Azure Active Directory or synchronised Active Directory group the rule will apply to, but will allow for grouping of rules into a single policy, as this just makes sense as we‚Äôll be applying the policy to the same group. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:2:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#importing-rule-data"},{"categories":["windows"],"content":" 2.2 Grouping EPM RulesAs we want to create a single policy for each provided group, containing all applicable rules, we need to capture the data based on the assignment group, this can be done pretty easily using the Group-Object command. PowerShell $Policies = Import-Csv -Path $ImportPath | Group-Object -Property Group Now we can check if the supplied group exists, using the below function to search for the group based on it‚Äôs name. PowerShell Function Get-IntuneGroup() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Name ) $graphApiVersion = 'beta' $Resource = 'groups' try { $authToken['ConsistencyLevel'] = 'eventual' $searchterm = 'search=\"displayName:' + $Name + '\"' $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource`?$searchterm\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Info Take note of the change to the $authtoken variable which needs updating to include ‚ÄòConsistencyLevel‚Äô to support advanced queries using Graph API. We can ensure that the group exists prior to deploying the EPM policies to Microsoft Intune, and set the variables for each new rule to be created based on the data in the CSV file. PowerShell foreach ($Policy in $Policies) { $Group = Get-IntuneGroup -Name $Policy.Name if ($null -eq $Group) { Write-Output \"$($Policy.Name) group does not exist, unable to create EPM Policy\" break } else { $Rules = $Policy.Group $JSONRules = @() foreach ($Rule in $Rules) { $FileName = $Rule.FileName $FileInternalName = $Rule.FileInternalName $FilePath = $Rule.FilePath $FileHash = $Rule.FileHash $ElevationType = $Rule.ElevationType $FileProduct = $Rule.Product -replace '[^\\x30-\\x39\\x41-\\x5A\\x61-\\x7A]+', ' ' $FileDescription = $Rule.Description $RuleDescription = $($Rule.Publisher + ' ' + $Rule.Description) -replace '[^\\x30-\\x39\\x41-\\x5A\\x61-\\x7A]+', ' ' Now onto the fun that is EPM policy and rule creation. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:2:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#grouping-epm-rules"},{"categories":["windows"],"content":" 3 Creating Settings Catalog PoliciesThe EPM Policies sit within the Setting Catalog space in Microsoft Intune, and it‚Äôs no secret that creating new Settings Catalog policies in Microsoft Intune is no walk in the park as per this post from Powers Hell. Our issue, in addition to Settings Catalogs creation being a pain in the arse, is that we want to create multiple rules in one EPM policy which comes with it‚Äôs own headache. Using add-epmfilerule.ps1 and exports of EPM policies using Intune PowerShell Samples as a basis for the JSON structure, we can build the policy with multuple rules in stages with separate sections for the policy and rules. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:3:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#creating-settings-catalog-policies"},{"categories":["windows"],"content":" 3.1 Policy Start JSONEasy one to start with as this section will be the same for each policy created, passing in variables from the imported CSV report. PowerShell $JSONPolicyStart = @\" { \"description\": \"EPM Policy for $($Group.displayName)\", \"name\": \"EPM Policy for $($Group.displayName)\", \"platforms\": \"windows10\", \"settings\": [ { \"settingInstance\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"ee3d2e5f-6b3d-4cb1-af9b-37b02d3dbae2\" }, \"groupSettingCollectionValue\": [ \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:3:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#policy-start-json"},{"categories":["windows"],"content":" 3.2 Policy End JSONThis finishes off the JSON file needed to submit to Graph API, again this will be the same for each EPM policy. PowerShell $JSONPolicyEnd = @\" ] } } ], \"technologies\": \"endpointPrivilegeManagement\", \"templateReference\": { \"templateId\": \"cff02aad-51b1-498d-83ad-81161a393f56_1\" } } \"@ That‚Äôs the simple part done, now to get our head around the rules. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:3:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#policy-end-json"},{"categories":["windows"],"content":" 4 Creating the Initial RuleThe first rule in an EPM policy has differing JSON formatting than any subsequent rules, requiring settingValueTemplateId values. We‚Äôll use logic in the PowerShell script to identify whether the each rule is the first in the list by querying the array of rules to check if the rule being processed is the first. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#creating-the-initial-rule"},{"categories":["windows"],"content":" 4.1 Initial Rule Start JSONThe variables we created, and populated by the CSV file, are added to the JSON for the following values: Rule Description Application Product Name Application Internal Name File Hash PowerShell $JSONRuleStart = @\" { \"settingValueTemplateReference\": null, \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_appliesto\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"0cde1c42-c701-44b1-94b7-438dd4536128\" }, \"choiceSettingValue\": { \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_allusers\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"2ec26569-c08f-434c-af3d-a50ac4a1ce26\", \"useTemplateDefault\": false }, \"children\": [] } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_description\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"b3714f3a-ead8-4682-a16f-ffa264c9d58f\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$RuleDescription\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"5e82a1e9-ef4f-43ea-8031-93aace2ad14d\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_productname\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"234631a1-aeb1-436f-9e05-dcd9489caf08\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileProduct\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"e466f96d-0633-40b3-86a4-9e093b696077\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_internalname\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"08511f12-25b5-4218-812c-39a2db444ef1\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileInternalName\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"ec295dd4-6bbc-4fa8-a503-960784c53f41\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filehash\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"e4436e2c-1584-4fba-8e38-78737cbbbfdf\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileHash\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"1adcc6f7-9fa4-4ce3-8941-2ce22cf5e404\", \"useTemplateDefault\": false } } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-start-json"},{"categories":["windows"],"content":" 4.2 Initial Rule Elevation JSONBased on the updated $ElevationType variable in the CSV file, we can define which of the below three elevation type JSON formats are passed into the policy JSON. 4.2.1 Initial Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.2 Initial Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.3 Initial Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-elevation-json"},{"categories":["windows"],"content":" 4.2 Initial Rule Elevation JSONBased on the updated $ElevationType variable in the CSV file, we can define which of the below three elevation type JSON formats are passed into the policy JSON. 4.2.1 Initial Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.2 Initial Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.3 Initial Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-elevation-automatic"},{"categories":["windows"],"content":" 4.2 Initial Rule Elevation JSONBased on the updated $ElevationType variable in the CSV file, we can define which of the below three elevation type JSON formats are passed into the policy JSON. 4.2.1 Initial Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.2 Initial Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.3 Initial Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-elevation-user-authentication"},{"categories":["windows"],"content":" 4.2 Initial Rule Elevation JSONBased on the updated $ElevationType variable in the CSV file, we can define which of the below three elevation type JSON formats are passed into the policy JSON. 4.2.1 Initial Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.2 Initial Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ 4.2.3 Initial Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"choiceSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"choiceSettingCollectionValue\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\", \"children\": [], \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\" } ], \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\" } ], \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\" }, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\" }, \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"bc5a31ac-95b5-4ec6-be1f-50a384bb165f\" } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-elevation-user-business-justification"},{"categories":["windows"],"content":" 4.3 Initial Rule End JSONThe JSON contained below tails the first rule creation, with variables passed through based on the CSV report imported data for the following values: File Description Rule Name File Name File Path PowerShell $JSONRuleEnd = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filedescription\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"5e10c5a9-d3ca-4684-b425-e52238cf3c8b\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileDescription\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"df3081ea-4ea7-4f34-ac87-49b2e84d4c4b\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_name\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"fdabfcf9-afa4-4dbf-a4ef-d5c1549065e1\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileDescription $TypeDescription\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"03f003e5-43ef-4e7e-bf30-57f00781fdcc\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filename\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"0c1ceb2b-bbd4-46d4-9ba5-9ee7abe1f094\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FileName\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"a165327c-f0e5-4c7d-9af1-d856b02191f7\", \"useTemplateDefault\": false } } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filepath\", \"settingInstanceTemplateReference\": { \"settingInstanceTemplateId\": \"c3b7fda4-db6a-421d-bf04-d485e9d0cfb1\" }, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"value\": \"$FilePath\", \"settingValueTemplateReference\": { \"settingValueTemplateId\": \"f011bcfc-03cd-4b28-a1f4-305278d7a030\", \"useTemplateDefault\": false } } } ] \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:4:3","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#initial-rule-end-json"},{"categories":["windows"],"content":" 5 Creating Subsequent RulesThis is where I was on the strugglebus understanding what format the JSON needed to be in when a policy has multiple rules. Eventually I worked out that any additional rule added to the policy has different JSON formatting, with no need for the settingValueTemplateId values, so here we go. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#creating-subsequent-rules"},{"categories":["windows"],"content":" 5.1 Rule Start JSONThe variables we created are added to the JSON in the same was as the initial rule, but with a differing JSON structure. PowerShell $JSONRuleStart = @\" { \"settingValueTemplateReference\": null, \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_appliesto\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_allusers\", \"children\": [] } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_description\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$RuleDescription\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_productname\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileProduct\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_internalname\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileInternalName\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filehash\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileHash\" } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-start-json"},{"categories":["windows"],"content":" 5.2 Rule Elevation JSONBased on the $ElevationType variable, we can define which of the below three elevation type JSON formats are passed into the policy JSON, but this time with different JSON structure. 5.2.1 Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\", \"children\": [] } }, \"@ 5.2.2 Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\", \"children\": [] } ] } ] } }, \"@ 5.2.3 Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\", \"children\": [] } ] } ] } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-elevation-json"},{"categories":["windows"],"content":" 5.2 Rule Elevation JSONBased on the $ElevationType variable, we can define which of the below three elevation type JSON formats are passed into the policy JSON, but this time with different JSON structure. 5.2.1 Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\", \"children\": [] } }, \"@ 5.2.2 Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\", \"children\": [] } ] } ] } }, \"@ 5.2.3 Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\", \"children\": [] } ] } ] } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-elevation-automatic"},{"categories":["windows"],"content":" 5.2 Rule Elevation JSONBased on the $ElevationType variable, we can define which of the below three elevation type JSON formats are passed into the policy JSON, but this time with different JSON structure. 5.2.1 Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\", \"children\": [] } }, \"@ 5.2.2 Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\", \"children\": [] } ] } ] } }, \"@ 5.2.3 Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\", \"children\": [] } ] } ] } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-elevation-user-authentication"},{"categories":["windows"],"content":" 5.2 Rule Elevation JSONBased on the $ElevationType variable, we can define which of the below three elevation type JSON formats are passed into the policy JSON, but this time with different JSON structure. 5.2.1 Rule Elevation Automatic PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\", \"children\": [] } }, \"@ 5.2.2 Rule Elevation User Authentication PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\", \"children\": [] } ] } ] } }, \"@ 5.2.3 Rule Elevation User Business Justification PowerShell $JSONRuleElev = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\", \"settingInstanceTemplateReference\": null, \"choiceSettingValue\": { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\", \"children\": [ { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\", \"settingInstanceTemplateReference\": null, \"choiceSettingCollectionValue\": [ { \"settingValueTemplateReference\": null, \"value\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\", \"children\": [] } ] } ] } }, \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-elevation-user-business-justification"},{"categories":["windows"],"content":" 5.3 Rule End JSONThe JSON below tails rule creation, with variables passed through based on the CSV report imported data, again with different JSON structure. PowerShell $JSONRuleEnd = @\" { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filedescription\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileDescription\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_name\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileDescription $TypeDescription\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filename\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FileName\" } }, { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\", \"settingDefinitionId\": \"device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filepath\", \"settingInstanceTemplateReference\": null, \"simpleSettingValue\": { \"@odata.type\": \"#microsoft.graph.deviceManagementConfigurationStringSettingValue\", \"settingValueTemplateReference\": null, \"value\": \"$FilePath\" } } ] \"@ ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:3","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-end-json"},{"categories":["windows"],"content":" 5.4 Rule Ending JSONBy this point I‚Äôm tired of looking at JSON, but we need to close off the rules before we complete the policy JSON as a whole; we have to identify whether the rule being processed is last rule, as the end of the JSON for rules will need to be different, in this case whether a }, or a }, so we can use a quick query as to whether the rule being processed is the last in the array. PowerShell if ($Rule -eq $Rules[-1]) { $JSONRuleEnding = @' } '@ } else { $JSONRuleEnding = @' }, '@ } ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:5:4","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#rule-ending-json"},{"categories":["windows"],"content":" 6 Submitting EPM PoliciesAt this point we should have the all the JSON content we need, now is time to combine them all to form the master JSON which can be submitted to Graph API, but we need to firstly combine all the JSON variables, and secondly have a way to pass it to the API. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:6:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#submitting-epm-policies"},{"categories":["windows"],"content":" 6.1 Final Policy JSONLuckily we can define an array variable $JSONRules which we can add each combined rule to as we loop through each rule in the set. PowerShell $JSONRule = $JSONRuleStart + $JSONRuleElev + $JSONRuleEnd + $JSONRuleEnding $JSONRules += $JSONRule Adding these combined rules to the $JSONPolicyStart and $JSONPolicyEnd variables will give us the required JSON file we can submit to Graph API. PowerShell $JSONOutput = $JSONPolicyStart + $JSONRules + $JSONPolicyEnd ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:6:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#final-policy-json"},{"categories":["windows"],"content":" 6.2 Pushing to Graph APIJSON file complete, let‚Äôs use a function to push the data to Microsoft Intune via Graph API, as I‚Äôm not hand cranking this for every policy we want to create. PowerShell Function New-DeviceSettingsCatalog() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = 'Beta' $Resource = 'deviceManagement/configurationPolicies' try { Test-Json -Json $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can now pass through the $JSONOutput variable to the above function. PowerShell $EPMPolicy = New-DeviceSettingsCatalog -JSON $JSONOutput With this we now have a method to push new policies, and if required, with multiple rules to Microsoft Intune. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:6:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#pushing-to-graph-api"},{"categories":["windows"],"content":" 6.3 Assigning EPM PoliciesNow we have a way to create new EPM policies and rules, grouping the rules by the assignment group, it would only be right to square this all off by assigning the policy to the same group, outrageous I know. To do this we need another function using the deviceManagement/configurationPolicies/$Id/assign Graph API endpoint to create a new Settings Catalog policy assignment. PowerShell Function Add-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Id, [parameter(Mandatory = $false)] [string]$Name, [parameter(Mandatory = $true)] [string]$TargetGroupId, [parameter(Mandatory = $true)] [ValidateSet('Include', 'Exclude')] [string]$AssignmentType ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/configurationPolicies/$Id/assign\" try { $TargetGroup = New-Object -TypeName psobject if ($AssignmentType -eq 'Exclude') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.exclusionGroupAssignmentTarget' } elseif ($AssignmentType -eq 'Include') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.groupAssignmentTarget' } $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value \"$TargetGroupId\" $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name 'target' -Value $TargetGroup $TargetGroups = $Target # Creating JSON object to pass to Graph $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name 'assignments' -Value @($TargetGroups) $JSON = $Output | ConvertTo-Json -Depth 3 # POST to Graph Service $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' Write-Host \"Successfully assigned policy $Name\" -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can finally assign the policy passing through the required information from the $EPMPolicy variable that contains the details of the newly created EPM policy. PowerShell Add-DeviceSettingsCatalogAssignment -id $EPMPolicy.id -TargetGroupId $Group.id -AssignmentType Include If you‚Äôre still with me, and you probably are as I haven‚Äôt posted the full script yet, congratulations, we‚Äôre almost there. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:6:3","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#assigning-epm-policies"},{"categories":["windows"],"content":" 7 EPM Policy DeploymentWe‚Äôre here, finally, with a complete PowerShell Script ready to be used and abused. Let‚Äôs look at the options we have when running the script. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:7:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#epm-policy-deployment"},{"categories":["windows"],"content":" 7.1 Report ModeRunning the script with the below parameters we can export the existing Unmanaged elevations to a location of our choosing that you will be prompted for after running the script. PowerShell ./Invoke-EPNRules.ps1 -tenantID 'bb690aa6-53c6-4d51-affe-ab80c6d710de' -Deployment Report This CSV file can then updated with the elevation types and groups the rules can be assigned to, as per the example below. CSV \"ElevationCount\",\"Product\",\"Description\",\"Publisher\",\"FileName\",\"FilePath\",\"FileHash\",\"Users\",\"Devices\",\"ElevationType\",\"Group\" \"6\",\"Microsoft¬Æ Windows¬Æ Operating System\",\"Windows PowerShell\",\"Microsoft Corporation\",\"powershell.exe\",\"C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\",\"B4E7BC24BF3F5C3DA2EB6E9EC5EC10F90099DEFA91B820F2F3FC70DD9E4785C4\",\"AzureAD\\AlexWilber AzureAD\\ChristieCline\",\"DESKTOP-DL6CCRJ DESKTOP-7KFLL12\",\"UserJustification\",\"sg-IT\" \"4\",\"PaladinVPN\",\"PaladinVPN\",\"Ledger Media Ltd\",\"PaladinVPN.exe\",\"C:\\\\Program Files (x86)\\\\PaladinVPN\",\"B6EF395DE2F28162DBAFCA79BAABEBB211245A68425CE096402030417FEA1160\",\"AzureAD\\AlexWilber\",\"DESKTOP-DL6CCRJ\",\"Automatic\",\"sg-Operations\" \"12\",\"Microsoft¬Æ Windows¬Æ Operating System\",\"Windows Command Processor\",\"Microsoft Corporation\",\"cmd.exe\",\"C:\\\\Windows\\\\system32\",\"B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450\",\"AzureAD\\AlexWilber AzureAD\\ChristieCline\",\"DESKTOP-DL6CCRJ DESKTOP-7KFLL12\",\"UserAuthentication\",\"sg-IT\" ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:7:1","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#report-mode"},{"categories":["windows"],"content":" 7.2 Create ModeThe CSV file can then be used for the creation of rules using the below command (you will be prompted for the path to the CSV file). PowerShell ./Invoke-EPNRules.ps1 -tenantID 'bb690aa6-53c6-4d51-affe-ab80c6d710de' -Deployment Import Which will result in the EPM policies being created: Microsoft Intune Elevation Policy. Drilling into the EPM policy we can see the rules that were created: Microsoft Intune Elevation Rules. Digging a little further we can see the settings for the rules: PowerShell User Approved with Business Justification Microsoft Intune Elevation Rules Detail for Business Justification. Command Prompt User Approved with Authentication Microsoft Intune Elevation Rules Detail for Authentication. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:7:2","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#create-mode"},{"categories":["windows"],"content":" 7.3 Create and Assign ModeOr if you want to be reckless bold and create and assign the policies, use the below (you will be prompted for the path to the CSV file). PowerShell ./Invoke-EPNRules.ps1 -tenantID 'bb690aa6-53c6-4d51-affe-ab80c6d710de' -Deployment ImportAssign Which will give us the above policies created, but also assigned to the relevant groups: Microsoft Intune Elevation Rules assignment. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:7:3","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#create-and-assign-mode"},{"categories":["windows"],"content":" 8 SummaryThis script doesn‚Äôt take into consideration the members of the groups as part of the assignment, and subsequently any conflict or crossover of rules on a per user or device basis, but then I can‚Äôt script every step of logic as part of an Endpoint Privilege Management implementation, you still have to use your brain somewhere along the way. What it does give you is an ability to readily identify the priority of elevations required by your user base, a way to review the applications actively being elevated, and importantly a way to use this data and information to automatically create Endpoint Privilege Management policies and rules without the risk of human error when creating rules manually. ","date":"1 June 2023","objectID":"/posts/automate-endpoint-privilege-management/:8:0","series":null,"tags":["intune","security","settings catalog","endpoint privilege management","graph","powershell","automation","endpoint security"],"title":"Automating Endpoint Privilege Management Policies with PowerShell","uri":"/posts/automate-endpoint-privilege-management/#summary"},{"categories":["macos"],"content":"Deploying Microsoft Teams backgrounds for macOS using Shell scripts in Microsoft Intune.","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/"},{"categories":["macos"],"content":"What happens when a stranger on the Internet asks you to look at something they‚Äôve got a problem with? Well clearly you jump at the chance and hope that it‚Äôs not a body part this time. So here we are, looking at how to deploy Microsoft Teams Backgrounds to macOS devices using Intune, for organisations without the licensing to allow for corporate branding using Microsoft Teams Premium Experience. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:0:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#"},{"categories":["macos"],"content":" 1 Teams Meeting BackgroundsSo after a quick search, to add new backgrounds for Teams we need to dump files in ~/Library/Application Support/Microsoft/Teams/Backgrounds, this directory will exist under the logged in User context, so we‚Äôre going to need a way to both create an ‚ÄòUploads‚Äô directory and dump the background files in there. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:1:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#teams-meeting-backgrounds"},{"categories":["macos"],"content":" 1.1 Checking for the Teams AppBefore we start throwing files in a directory, we should probably check to see if Teams is actually installed, luckily having spent many evenings peering over the macOS Shell Scripts hosted in Intune Shell Scripts, we can use the Dock Customisation script, as there‚Äôs a section in there that waits for the detection of apps before allowing the script to continue. So we‚Äôll pinch that section and update it so it‚Äôs only checking for the Microsoft Teams.app Bash teamsapp=\"/Applications/Microsoft Teams.app\" while [[ $ready -ne 1 ]]; do missingappcount=0 if [[ -a \"$teamsapp\" ]]; then echo \"$(date) | $teamsapp is installed\" else let missingappcount=$missingappcount+1 fi echo \"$(date) | [$missingappcount] application missing\" if [[ $missingappcount -eq 0 ]]; then ready=1 echo \"$(date) | Teams App found, lets prep the dock\" else echo \"$(date) | Waiting for 10 seconds\" sleep 10 fi done This will sit and wait for Teams to be detected, so make sure you‚Äôve either already deployed Teams to your devices and/or have a ‚ÄòRequired‚Äô install intent for either Microsoft Teams or Microsoft Office, in Intune. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:1:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#checking-for-the-teams-app"},{"categories":["macos"],"content":" 1.2 Getting the Logged in UserLike the Dock Customisation script, we can run the script from Intune as the signed-in user, and as we‚Äôre dealing with data in the User context, this makes the most sense. We can capture the signed-in user using the built-in $HOME variable, and creating a new teamsUpload variable to use later. Bash teamsUpload=\"$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\" ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:1:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#getting-the-logged-in-user"},{"categories":["macos"],"content":" 1.3 Checking the Background DirectoryRight, that was easier than I thought, we should look at how to check if the directory exists, and if not create it. Bash if [[ -d ${teamsUpload} ]] then echo \"$(date) | Teams Background Upload dir [$teamsUpload] already exists\" else echo \"$(date) | Creating [$teamsUpload]\" mkdir -p \"$teamsUpload\" fi Now onto how we get files in the directory, without just copy and pasting. Info You may have noticed by now that I‚Äôm not explaining in much depth how the Shell commands work, well that‚Äôs because I‚Äôm still on a steep learning curve myself. Bear with me here, it ain‚Äôt PowerShell is it. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:1:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#checking-the-background-directory"},{"categories":["macos"],"content":" 2 Deploying Files with Shell ScriptsI already know there‚Äôs a working method to deploy a Desktop Background to a macOS device enrolled in Microsoft Intune. So we‚Äôll do what any right minded Consultant would do, and steal modify the script to our needs. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:2:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#deploying-files-with-shell-scripts"},{"categories":["macos"],"content":" 2.1 Script VariablesThe original script used a single variable wallpaperurl to capture the desktop wallpaper URL, which is nice and all, and obviously fits the Desktop Background purpose, but we‚Äôd like to give our users options of Teams Backgrounds, so we‚Äôll use an array to hold our list of URLs to the background files (see I am learning). Bash backgroundurls=(\"https://memv.ennbee.uk/bgr.png\" \"https://memv.ennbee.uk/wp-lt.png\" \"https://memv.ennbee.uk/wp.png\") For any additional URLs, you can add a new line to the array. Info This lack of a $ when configuring new variables is unsettling me if I‚Äôm honest, but we move. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:2:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#script-variables"},{"categories":["macos"],"content":" 2.2 Downloading with CurlPretty simple really, even I can use curl to download the background files to the directory location -L, passing in the URL and a filename as part of the output -o option. We‚Äôve added the `-s‚Äô so as to not clog the log file with the raw download data. Bash curl -s -L -o $teamsUpload/$backgroundfile $backgroundurl We now need to loop through each of the items in the backgroundurls array, and we also need to give each a filename for backgroundfile that isn‚Äôt duplicated, otherwise we‚Äôll end up downloading and overwriting the same file for each URL in the array. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:2:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#downloading-with-curl"},{"categories":["macos"],"content":" 2.3 Incremental FilenamesWe can quickly create new file names as part of the for loop needed for the items in the array, by incrementing a variable, and appending that variable to the backgroundfile variable. Bash i=0 for backgroundurl in \"${backgroundurls[@]}\"; do ((i=i+1)) backgroundfile=\"TeamsBackground$i.png\" ... done This will make sure that each downloaded background file gets a new filename, this won‚Äôt cater for multiple initiations of the script, but remember, I‚Äôm still new at this. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:2:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#incremental-filenames"},{"categories":["macos"],"content":" 3 Teams Background ScriptThe full script looks pretty much like the below, which is just a squishing together of the bits we‚Äôve already covered in this post. downloadTeamsBackground.sh #!/bin/bash #set -x ############################################################################################ ## ## Script to download Teams Backgrounds ## ########################################### # Define variables # Add new background URLs to the array backgroundurls=(\"https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/Msft_Nostalgia_Landscape.jpg\" \"https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/SupportUkraine_Heart_TeamsBackground.jpg\" \"https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/covermichael.jpg\") scriptname=\"SetTeamsBackground\" teamsapp=\"/Applications/Microsoft Teams.app\" logandmetadir=\"$HOME/Library/Logs/Microsoft/Intune/Scripts/$scriptname\" log=\"$logandmetadir/$scriptname.log\" teamsUpload=\"$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\" ## Check if the log directory has been created if [ -d $logandmetadir ]; then ## Already created echo \"# $(date) | Log directory already exists - $logandmetadir\" else ## Creating Metadirectory echo \"# $(date) | creating log directory - $logandmetadir\" mkdir -p \"$logandmetadir\" fi # start logging exec 1\u003e\u003e\"$log\" 2\u003e\u00261 echo \"\" echo \"##############################################################\" echo \"# $(date) | Starting download of Teams Backgrounds\" echo \"############################################################\" echo \"\" ## ## Checking if Teams is Installed ## while [[ $ready -ne 1 ]]; do missingappcount=0 if [[ -e \"$teamsapp\" ]]; then echo \"$(date) | $teamsapp is installed\" else let missingappcount=$missingappcount+1 fi echo \"$(date) | [$missingappcount] application missing\" if [[ $missingappcount -eq 0 ]]; then ready=1 echo \"$(date) | Teams App found, lets download the backgrounds\" else echo \"$(date) | Waiting for 10 seconds\" sleep 10 fi done ## ## Checking if Teams Backgrounds Upload directory exists and create it if it's missing ## if [[ -d ${teamsUpload} ]]; then echo \"$(date) | Teams Background Upload dir [$teamsUpload] already exists\" else echo \"$(date) | Creating [$teamsUpload]\" mkdir -p \"$teamsUpload\" fi ## ## Attempt to download the files. No point checking if it already exists since we want to overwrite it anyway ## i=0 for backgroundurl in \"${backgroundurls[@]}\"; do ((i = i + 1)) backgroundfile=\"TeamsBackground$i.png\" echo \"$(date) | Downloading Background from [$backgroundurl] to [$teamsUpload/$backgroundfile]\" curl -L -o \"$teamsUpload/$backgroundfile\" $backgroundurl if [ \"$?\" = \"0\" ]; then echo \"$(date) | Teams Background [$backgroundurl] downloaded to [$teamsUpload/$backgroundfile]\" else echo \"$(date) | Failed to download Teams Background image from [$backgroundurl]\" fi done Time to add this into Intune and reap the rewards. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:3:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#teams-background-script"},{"categories":["macos"],"content":" 3.1 Intune Shell ScriptsAs with everything Microsoft, there are some requirements and limitations with using Shell Scripts for macOS so have a read before you blindly start trying to push out scripts to your device estate. After you‚Äôve read these requirements, create a new Shell Script with the below settings. Setting Value Shell script downloadTeamsBackground.sh File contents Uploaded Script Run script as signed-in user Yes Hide script notifications on devices Not Configured Script frequency Not Configured Max number of times to retry if script fails 3 times Looking a little like the below. macOS Shell Script in Microsoft Intune. Now we‚Äôve added the Shell Script, this can be deployed to the ‚ÄòAll Users‚Äô, ‚ÄòAll Devices‚Äô groups (Don‚Äôt do this as we don‚Äôt have Device Filters to use) or Groups of your choosing. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:3:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#intune-shell-scripts"},{"categories":["macos"],"content":" 4 Checking Microsoft TeamsWith the Script deployed from Intune and assigned to a group of devices, we can check on the devices themselves to make sure that the script has run successfully using the log file, checking that the new backgrounds have downloaded to the correct directory, and that these backgrounds appear in Microsoft Teams. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:4:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#checking-microsoft-teams"},{"categories":["macos"],"content":" 4.1 Script LoggingAs per the configured variable in the script, we can find the log $HOME/Library/Logs/Microsoft/Intune/Scripts/SetTeamsBackground/SetTeamsBackground.log, opening it we can check on the status of the downloads. macOS Shell Script logging on a targeted device. Everything looks solid we should check the download directory. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:4:1","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#script-logging"},{"categories":["macos"],"content":" 4.2 Background DirectoryAs we can see three files in the Uploads directory, all named appropriately. Teams background folder and contents on a targeted device. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:4:2","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#background-directory"},{"categories":["macos"],"content":" 4.3 Teams Background EffectsLast check is in a Microsoft Teams meeting. Teams backgrounds within a Teams meeting. All good here as well, we can relax and have a coffee. Info If Microsoft Teams was open when the backgrounds were deployed, it will need a restart to pick up the new backgrounds. I did think about force quitting the app, but didn‚Äôt think users would appreciate that. ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:4:3","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#teams-background-effects"},{"categories":["macos"],"content":" 5 SummaryThis was a pretty straight forward method to deploy backgrounds to Microsoft Teams using Intune Shell Scripts, and not a bad start to my journey into advanced management of macOS devices (despite actually being a macOS user). I‚Äôd recommend familiarising yourself with the Intune Shell Samples, as this is where started when hacking about with Shell scripts for macOS devices. Or you could just pay for Microsoft Teams Premium, but where‚Äôs the fun in that? ","date":"14 March 2023","objectID":"/posts/macos-teams-backgrounds/:5:0","series":null,"tags":["intune","microsoft teams","apps","shell script"],"title":"Deploying Teams Backgrounds to macOS Devices","uri":"/posts/macos-teams-backgrounds/#summary"},{"categories":["windows"],"content":"Reviewing the options for co-managed Windows devices using Configuration Manager (SCCM) and Microsoft Intune.","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/"},{"categories":["windows"],"content":"As both Microsoft Intune and Configuration Manager are a match made in heaven, there are many reasons to still utilise both, either using Co-Management or just plain old Tenant Attach, so imagine my joy when Microsoft released Co-Management Authority in Intune, and I thought the days of packaging the Configuration Manager Client were over. Now imagine my face when I read the requirements and the fact it doesn‚Äôt support Autopilot Hybrid Join scenarios. I get it, installing the client during Autopilot will pretty much break the deployment, but there should be a way to install the client and not have it bend over and only accept Configuration Manager deployed workloads. Packaging the Configuration Manager Client has been covered, many, many, many, many times, almost to death in fact, so I‚Äôm not going to show you how to package the client files, what I am going to show you is a couple of tricks to make the installation easier, and not break Autopilot. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:0:0","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#"},{"categories":["windows"],"content":" 1 App Requirement RulesTo stop the application from running during the Autopilot process, we can add in a Requirement Rule to ensure that we‚Äôre not in the Out of Box Experience (OOBE). We‚Äôve got a couple of options here, whether it‚Äôs detecting if the CloudExperienceHostBroker Service is running, or if the User account context is running under defaultUser0. I‚Äôve gone with the Service approach, as it saves Intune having to run Get-ComputerInfo -Property CsUserName every time it wants to check if the requirement has been met. With this, we can create a Requirement Rule Script using the below to check if the CloudExperienceHostBroker service is running, and if not returning Install: PowerShell $ESPProcess = Get-Process -Name CloudExperienceHostBroker -ErrorAction SilentlyContinue if ($ESPProcess.Count -eq 0) { Return 'Install' } Pretty straight forward for one of my documented scripts, but either way, save the file locally as something you can remember. Create the rule in Intune with the below settings: Item Value Requirement Type Script Script Name Autopilot_Not_Running.ps1 Script content {{Script Content}} Run script as 32-bit process on 64-bit clients No Run this script using the logged on credentials No Enforce script signature check No Select Output data type String Operator Equals Value Install Giving us something like this: Microsoft Intune application requirement rule. This will now stop the installation from even starting during Autopilot phase, and only start the installation once the requirement has been met. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:1:0","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#app-requirement-rules"},{"categories":["windows"],"content":" 2 App Detection MethodsNow that we can control when the Client is installed, we need a way to detect that it has installed, and to be honest, we don‚Äôt actually care if the Client itself has installed correctly, as the Client setup will just sit and try to install itself every ten minutes until it can. If we had a detection rule for either the MSI product code, or a File check for the client itself, we‚Äôd be waiting for an absolute age for Intune to be happy and confirm the installation state. We do not want this. What we do want, is a quick and easy way to ensure that the setup files exist on the device, then we can let the ccmsetup.exe do it‚Äôs magical thing and install the Client and the associated service. So for the detection rule, we‚Äôll just look for the presence of the setup file: Item Value Rule Type File Path %windir%\\ccmsetup File or Folder ccmsetup.exe Detection Method File or Folder Exists Associated with a 32-bit app on 64-bit client No This looks a little bit like the below: Microsoft Intune application detection method. Allowing for a quick and easy detection of the required setup files on the device. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:2:0","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#app-detection-methods"},{"categories":["windows"],"content":" 3 Intune Only ModeIf you‚Äôre wanting Intune to manage all the workloads on the device, and not rely on Co-Managed Workloads at all, there is a solution for this, and one taken straight from Microsoft and their implementation of the Co-Management Authority in Intune. Info Your endpoints enrolled in Intune today have a concept of management authority. That authority tells the device what service owns the management of the workloads on that device. The authority owner can be tracked by a simple registry key and value. This is the value that they‚Äôre on about: txt HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server Info When provisioning a device with Autopilot, the above key gets created right after you enter your username and password on the enrolment screen. This key tells the device who the authority is for workload management* Here‚Äôs the legend for the key: 1 ‚Äì Intune 2 ‚Äì Configuration Manager Right, so if we really wanted to stick with Intune as the management authority here, we can leverage the above information and force the device to stick with Intune for it‚Äôs management needs, and in the case of App deployment, the device will still receive Apps from both Intune and Configuration Manger if the key value is set to Intune. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:3:0","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#intune-only-mode"},{"categories":["windows"],"content":" 3.1 Proactive RemediationAs I‚Äôve mentioned previously if you‚Äôre licensed to use Proactive Remediation Scripts, you should be using them, and in anger. We can throw together a script that looks for the registry key HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\\ConfigInfo, create it if it doesn‚Äôt exist, and set it to 1 telling the device to only deal with Intune. 3.1.1 Detection ScriptAs with all Proactive Remediation scripts, we need a method to detect, which is run initially upon assessment, and subsequently after remediation. A standard check, fix, check situation. For the detection method, we‚Äôre looking for both the Registry Key and the item. Override_Co-Management_Detection.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $False) { Write-Warning 'Co-Management Authority Not Confgured' Exit 1 } else { if ($Authority -ne '1') { Write-Warning 'Co-Management Authority set to Configuration Manager' Exit 1 } else { Write-Output 'Co-Management Authority set to Intune' Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } 3.1.2 Remediation ScriptIf either the Key or the Data are not detected, we have a Remediation script that configures either the Key and the Data, or just the Data. Override_Co-Management_Remediation.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $false) { New-Item -Path $Registry -Force | Out-Null New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } else { if ($Authority -ne '1') { New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } } } Catch { Write-Error $_.Exception Exit 2000 } ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:3:1","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#proactive-remediation"},{"categories":["windows"],"content":" 3.1 Proactive RemediationAs I‚Äôve mentioned previously if you‚Äôre licensed to use Proactive Remediation Scripts, you should be using them, and in anger. We can throw together a script that looks for the registry key HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\\ConfigInfo, create it if it doesn‚Äôt exist, and set it to 1 telling the device to only deal with Intune. 3.1.1 Detection ScriptAs with all Proactive Remediation scripts, we need a method to detect, which is run initially upon assessment, and subsequently after remediation. A standard check, fix, check situation. For the detection method, we‚Äôre looking for both the Registry Key and the item. Override_Co-Management_Detection.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $False) { Write-Warning 'Co-Management Authority Not Confgured' Exit 1 } else { if ($Authority -ne '1') { Write-Warning 'Co-Management Authority set to Configuration Manager' Exit 1 } else { Write-Output 'Co-Management Authority set to Intune' Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } 3.1.2 Remediation ScriptIf either the Key or the Data are not detected, we have a Remediation script that configures either the Key and the Data, or just the Data. Override_Co-Management_Remediation.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $false) { New-Item -Path $Registry -Force | Out-Null New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } else { if ($Authority -ne '1') { New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } } } Catch { Write-Error $_.Exception Exit 2000 } ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:3:1","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#detection-script"},{"categories":["windows"],"content":" 3.1 Proactive RemediationAs I‚Äôve mentioned previously if you‚Äôre licensed to use Proactive Remediation Scripts, you should be using them, and in anger. We can throw together a script that looks for the registry key HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\\ConfigInfo, create it if it doesn‚Äôt exist, and set it to 1 telling the device to only deal with Intune. 3.1.1 Detection ScriptAs with all Proactive Remediation scripts, we need a method to detect, which is run initially upon assessment, and subsequently after remediation. A standard check, fix, check situation. For the detection method, we‚Äôre looking for both the Registry Key and the item. Override_Co-Management_Detection.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $False) { Write-Warning 'Co-Management Authority Not Confgured' Exit 1 } else { if ($Authority -ne '1') { Write-Warning 'Co-Management Authority set to Configuration Manager' Exit 1 } else { Write-Output 'Co-Management Authority set to Intune' Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } 3.1.2 Remediation ScriptIf either the Key or the Data are not detected, we have a Remediation script that configures either the Key and the Data, or just the Data. Override_Co-Management_Remediation.ps1 Try { $Registry = 'HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server' $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $false) { New-Item -Path $Registry -Force | Out-Null New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } else { if ($Authority -ne '1') { New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } } } Catch { Write-Error $_.Exception Exit 2000 } ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:3:1","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#remediation-script"},{"categories":["windows"],"content":" 3.2 Creating a Custom ScriptWith the above PowerShell scripts saved, we can now create our own Proactive Remediation Script and deploy this to the devices we only want to be managed by Intune, in this case, the Hybrid Joined Autopilot devices: Microsoft Intune remediation script. Make sure you‚Äôre using 64-bit PowerShell for this script, as we don‚Äôt want anything screwy going on with the registry settings. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:3:2","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#creating-a-custom-script"},{"categories":["windows"],"content":" 4 SummaryWe‚Äôve managed to delay the installation of the Configuration Manager Client, as well as ensure it‚Äôs detected quickly once installed, and once it does install and the Client starts looking at Configuration Manager for it‚Äôs Co-Management settings, we‚Äôve even got a way to tell Configuration Manager to look the other way and not break Autopilot whilst letting Intune do its thing. All in all, although not a Microsoft supported method for deploying the Client, it is one that works. As you‚Äôve realised by now, I‚Äôm not about documented good practice. ","date":"1 March 2023","objectID":"/posts/configmgr-client-hybrid-autopilot/:4:0","series":null,"tags":["intune","windows autopilot","remediation","powershell","hybrid join","co-management"],"title":"Co-Managing Windows Autopilot Hybrid Join Devices","uri":"/posts/configmgr-client-hybrid-autopilot/#summary"},{"categories":["android","ios"],"content":"Automatically assigning Android Enterprise Google Play apps and iOS iPhone and iPad mobile apps in Microsoft Intune using PowerShell and Graph API.","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/"},{"categories":["android","ios"],"content":"No one, and I mean no one, really wants to manually and individually assign Mobile Apps to Users or Devices in Intune, especially after you‚Äôve happily used a script to Approve Managed Google Play Apps in their 100‚Äôs as part of migrating to Microsoft Intune from other below par Mobile Device Management solutions. We could try and use Policy Sets here, but you know, they‚Äôre in preview, and more importantly they have issues like not supporting Managed Google Play or Apple VPP apps, so that‚Äôs a no go. So here we are again, throwing together functions, logic, and some kind of user interface, to allow us to assign these mobile apps in bulk with minimal headache and increase to any pre-existing repetitive strain injuries. Note The functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:0:0","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#"},{"categories":["android","ios"],"content":" 1 Mobile App AssignmentFirst off, before we even start looking at how we bring this all together, is to understand how we can assign an App using Graph. So as we‚Äôve done before, we could look under the hood and check the Browser Developer Tools to see what is actually going on, or we can just check the Graph documentation. With this we now know that to use the POST /deviceAppManagement/mobileApps/{mobileAppId}/assign call, we‚Äôll need the {mobileAppId}, we‚Äôre in luck, as we‚Äôve already got a function Get-MobileApps to do this for us. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:1:0","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#mobile-app-assignment"},{"categories":["android","ios"],"content":" 1.1 Assignment TypesKnowing the call to Graph is the easy bit, building the JSON data we‚Äôre sending to it using the POST request is a different story, but at least we‚Äôve got a framework to start us off, thanks Microsoft. JSON { \"mobileAppAssignments\": [ { \"@odata.type\": \"#microsoft.graph.mobileAppAssignment\", \"id\": \"591620b7-20b7-5916-b720-1659b7201659\", \"intent\": \"required\", \"target\": { \"@odata.type\": \"microsoft.graph.deviceAndAppManagementAssignmentTarget\" }, \"settings\": { \"@odata.type\": \"microsoft.graph.mobileAppAssignmentSettings\" } } ] } We‚Äôve built JSON data in PowerShell before, so this one isn‚Äôt any different, we do however need to cater for Installation Intents, Assignment Groups, Device Filters, and Device Filter States. These can be broken down as below, with the ones we actually care about in bold. Item Details Installation Intents Required, Available for Enrolled Devices, Available for Un-enrolled Devices, Uninstall Assignment Groups All Users, All Devices, Groups Filters States Include, Exclude We need to allow for the ability to assign Mobile Apps to all permutations of the above, whether this is a Required installation to All Devices, including a Device Filter, or an Available installation to a Group of Users. You get the picture. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:1:1","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#assignment-types"},{"categories":["android","ios"],"content":" 1.2 App Assignment JSONWe can now start to build the JSON data we can POST to Graph, but we do need a bit more information when it comes to the content of the JSON data, in particular what is acceptable in the microsoft.graph.deviceAndAppManagementAssignmentTarget as well as how we pass through a Device Filter as part of the assignment, what headings are needed depending on the Assignment Target as well as the Install Intent. The below structure details the setup for the JSON: mobileAppAssignments odata.type #microsoft.graph.mobileAppAssignment: This will be the same for each request intent required: Requiring the App to be installed available: Making the App available to be installed uninstall: Uninstalling the App target odata.type #microsoft.graph.groupAssignmentTarget: Assigns the App the a Group groupId: If using the group assignment, the Id of the Group #microsoft.graph.allLicensedUsersAssignmentTarget: Assigns the App the inbuilt All Users Group #microsoft.graph.allDevicesAssignmentTarget: Assigns the App the inbuilt All Devices Group deviceAndAppManagementAssignmentFilterId id: Device Filter Id deviceAndAppManagementAssignmentFilterType include: Includes the devices in the filter exclude: Excludes the devices in the filter We need to build separate objects in PowerShell to complete the JSON hierarchy, and we can happily do this using PowerShell using something like the below: Building the PSObject for odata.type and intent, with the App to be an Available Installation Intent: PowerShell $Target = New-Object -TypeName PSObject $Target | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.mobileAppAssignment' $Target | Add-Member -MemberType NoteProperty -Name 'intent' -Value 'available If we‚Äôre going for a Group based assignment including a Device Filter, we can build this and add to the existing $Target object using: PowerShell $TargetGroup = New-Object -TypeName PSObject $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.groupAssignmentTarget' $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value '{Group.Id}' $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterId' -Value '{FilterId}' $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterType' -Value 'include' $Target | Add-Member -MemberType NoteProperty -Name 'target' -Value $TargetGroup Then the final PSObject for mobileAppAssignments, adding everything together, and converting it to JSON: PowerShell $Output = New-Object -TypeName PSObject $Output | Add-Member -MemberType NoteProperty -Name 'mobileAppAssignments' -Value @($Target) $JSON = $Output | ConvertTo-Json -Depth 3 Giving us the below output: JSON { \"mobileAppAssignments\": [ { \"@odata.type\": \"#microsoft.graph.mobileAppAssignment\", \"intent\": \"available\", \"target\": { \"@odata.type\": \"#microsoft.graph.groupAssignmentTarget\", \"groupId\": \"{Group.Id}\", \"deviceAndAppManagementAssignmentFilterId\": \"{FilterId}\", \"deviceAndAppManagementAssignmentFilterType\": \"include\" } } ] } This looks miraculously like the Microsoft example, but you know, same same but different. If it actually had the correct {FilterId} and {GroupId} in place, it would allow us to assign an App when pushed to Graph. We‚Äôre getting there, bear with me, I thought this post would be shorter. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:1:2","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#app-assignment-json"},{"categories":["android","ios"],"content":" 2 Function Building BlocksThere are a few components we need to put together in the form of functions to enable the assignment of Mobile Apps, if we‚Äôre being complete about this, and for once we are (ish), we need to consider the following: Getting Mobile Apps Getting Device Filters Getting Groups Getting existing Assignments Dealing with existing Assignments All of the above will alter the way we deal with the JSON data we are creating, so one for future me to deal with. For now, on to the functions. Remember we‚Äôll need to authenticate to Graph using Connect-MgGraph for all of these. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:0","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#function-building-blocks"},{"categories":["android","ios"],"content":" 2.1 Getting Mobile AppsThis one has come straight from an existing script, but we‚Äôll need to filter the data gathered, otherwise we‚Äôre dragging back every Mobile App, including those referenced in App Protection Policies, and we don‚Äôt want to do anything with those today. PowerShell Function Get-MobileApps() { [cmdletbinding()] $graphApiVersion = 'Beta' $Resource = 'deviceAppManagement/mobileApps' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:1","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#getting-mobile-apps"},{"categories":["android","ios"],"content":" 2.2 Getting Device FiltersTo fix our missing {FilterId} issue, we need to be able to capture this data. This is a quick one, as we just need a call to GET deviceManagement/assignmentFilters resource, once we‚Äôve authenticated to Graph of course. PowerShell Function Get-DeviceFilter() { $graphApiVersion = 'beta' $Resource = 'deviceManagement/assignmentFilters' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } This function will pull back all Device Filters in the Intune tenant, so we might need to filter this down later on. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:2","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#getting-device-filters"},{"categories":["android","ios"],"content":" 2.3 Getting GroupsAh yes, Groups, I‚Äôd almost forgotten about these, but Dynamic Groups still have a place in Intune, and we need the {GroupId} to make this work, so we should find a way to grab these as well. As with the Device Filters, this is a call to Graph, but using the GET groups resource to capture the group id we need. It was supposed to be so easy, however as we need to limit the number of Groups being pulled back, we need a way to search for a Group name. Here comes the Search Query Parameter, and importantly the need for ConsistencyLevel in the headers in the connection Invoke-MgGraphRequest -Headers @{ConsistencyLevel = 'eventual' }. txt Name Value ---- ----- Content-Type application/json ConsistencyLevel eventual ExpiresOn 09/02/2023 11:49:47 +00:00 Authorization Bearer eyJ0eXAiOiJKV1QiLCJub25jZSI6ImFVUTNp... So eventually we have the Get-MDMGroup function, which will require a $GroupName parameter to search for the Groups to retrieve. PowerShell Function Get-MDMGroup() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$GroupName ) $graphApiVersion = 'beta' $Resource = 'groups' try { $authToken['ConsistencyLevel'] = 'eventual' $searchterm = 'search=\"displayName:' + $GroupName + '\"' $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource`?$searchterm\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Honestly, after that I wish I‚Äôd excluded Group based assignments, and we should have used one of the many PowerShell modules to pull back groups, but I like Graph, I like a consistent approach, and I‚Äôm using PowerShell Core 7. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:3","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#getting-groups"},{"categories":["android","ios"],"content":" 2.4 Getting Existing AssignmentsWe could be brutal with this script, and strip out the existing App assignments when assigning new ones, which is the default behaviour with POST, but I‚Äôm pretty sure that would make for some unhappy users. I couldn‚Äôt see a PATCH option for assignments, so we are going to have to write something ourselves to sort this at some point. Here is the function we can use to pull back the existing assignment data, I honestly can‚Äôt remember why I‚Äôve done it this way, I think it was due to the lovely format in which the assignments were displayed, but here we only need an App $Id to make this one work. PowerShell Function Get-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceAppManagement/mobileApps/$Id/?`$expand=categories,assignments\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get) } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:4","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#getting-existing-assignments"},{"categories":["android","ios"],"content":" 2.5 Removing Existing AssignmentsEven if we‚Äôre not accidentally removing existing assignments, we should give ourselves the option to undo any mistakes that we make when assigning Mobile Apps, so a quick tour of Graph gives us the DELETE mobileAppAssignment resource, and with a couple of parameters needed for both the App $Id and the Assignment $AssignmentId, we‚Äôve got ourselves a function to get us out of trouble if we need it. PowerShell Function Remove-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id, [parameter(Mandatory = $true)] $AssignmentId ) $graphApiVersion = 'Beta' $Resource = \"deviceAppManagement/mobileApps/$Id/assignments/$AssignmentId\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Delete) } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:2:5","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#removing-existing-assignments"},{"categories":["android","ios"],"content":" 3 App Assignment FunctionFinally we have all the parts to build the function, using the parameters below we can pass through the information needed to build the JSON data, pass through options as to whether we‚Äôre adding or replacing the assignment, and using some level of logic make sure we‚Äôre not messing this data up along the way. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:0","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#app-assignment-function"},{"categories":["android","ios"],"content":" 3.1 ParametersI‚Äôve niced myself here and given options for the application of the function, covering all our requirements for assignment. A break down of the parameters can be found below: Parameter Description Required Data Id The Id of the Mobile App, obtained via Get-MobileApps True String TargetGroupId The Id of a Group if assigning to a Group obtained via Get-MDMGroup False String InstallIntent Whether the Assignment is set as Available or Required True Available/Required FilterID The ID of a Device Filter if assigning using Device Filters obtained via Get-DeviceFilter False String FilterMode The Filter mode if assigning using Device Filters False Include/Exclude All Used if assigning to the in-built ‚ÄòAll Users‚Äô or ‚ÄòAll Devices‚Äô groups False Devices/Users Action Whether to Add to existing Assignments, or to Replace them True Add/Replace ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:1","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#parameters"},{"categories":["android","ios"],"content":" 3.2 Add Application AssignmentHere is the function in all it‚Äôs janky glory, ready to be used and abused by whatever I call PowerShell and acceptable user interfaces. We‚Äôve got the ability to capture existing assignments, as well as logic on duplicate assignment methods, and of course adding new ones to the Mobile App in question. PowerShell Function Add-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [ValidateNotNullOrEmpty()] $Id, [parameter(Mandatory = $false)] [ValidateNotNullOrEmpty()] $TargetGroupId, [parameter(Mandatory = $true)] [ValidateSet('Available', 'Required')] [ValidateNotNullOrEmpty()] $InstallIntent, $FilterID, [ValidateSet('Include', 'Exclude')] $FilterMode, [parameter(Mandatory = $false)] [ValidateSet('Users', 'Devices')] [ValidateNotNullOrEmpty()] $All, [parameter(Mandatory = $true)] [ValidateSet('Replace', 'Add')] $Action ) $graphApiVersion = 'beta' $Resource = \"deviceAppManagement/mobileApps/$Id/assign\" try { $TargetGroups = @() If ($Action -eq 'Add') { # Checking if there are Assignments already configured $Assignments = (Get-ApplicationAssignment -Id $Id).assignments if (@($Assignments).count -ge 1) { foreach ($Assignment in $Assignments) { If (($null -ne $TargetGroupId) -and ($TargetGroupId -eq $Assignment.target.groupId)) { Write-Host 'The App is already assigned to the Group' -ForegroundColor Yellow } ElseIf (($All -eq 'Devices') -and ($Assignment.target.'@odata.type' -eq '#microsoft.graph.allDevicesAssignmentTarget')) { Write-Host 'The App is already assigned to the All Devices Group' -ForegroundColor Yellow } ElseIf (($All -eq 'Users') -and ($Assignment.target.'@odata.type' -eq '#microsoft.graph.allLicensedUsersAssignmentTarget')) { Write-Host 'The App is already assigned to the All Users Group' -ForegroundColor Yellow } Else { $TargetGroup = New-Object -TypeName psobject if (($Assignment.target).'@odata.type' -eq '#microsoft.graph.groupAssignmentTarget') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.groupAssignmentTarget' $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value $Assignment.target.groupId } elseif (($Assignment.target).'@odata.type' -eq '#microsoft.graph.allLicensedUsersAssignmentTarget') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.allLicensedUsersAssignmentTarget' } elseif (($Assignment.target).'@odata.type' -eq '#microsoft.graph.allDevicesAssignmentTarget') { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.allDevicesAssignmentTarget' } if ($Assignment.target.deviceAndAppManagementAssignmentFilterType -ne 'none') { $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterId' -Value $Assignment.target.deviceAndAppManagementAssignmentFilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name 'deviceAndAppManagementAssignmentFilterType' -Value $Assignment.target.deviceAndAppManagementAssignmentFilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.mobileAppAssignment' $Target | Add-Member -MemberType NoteProperty -Name 'intent' -Value $Assignment.intent $Target | Add-Member -MemberType NoteProperty -Name 'target' -Value $TargetGroup $TargetGroups += $Target } } } } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.mobileAppAssignment' $Target | Add-Member -MemberType NoteProperty -Name 'intent' -Value $InstallIntent $TargetGroup = New-Object -TypeName psobject if ($TargetGroupId) { $TargetGroup | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.groupAssignmentTarget' $TargetGroup | Add-Member -MemberType NoteProperty -Name 'groupId' -Value $TargetGroupId } else { if ($All -eq 'Users') { $TargetGroup | Add-Member -MemberType NoteProperty -","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:2","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#add-application-assignment"},{"categories":["android","ios"],"content":" 3.3 Function ActionsRunning this function allows us to finally assign a Mobile App, I‚Äôm starting to think I could have just manually assigned the Apps at this point, but I‚Äôm confident I‚Äôll have to use this script again and again in the future. Replacing Assignment for an App, with the intent as Required to the ‚ÄòAll Devices‚Äô group, with an include Device Filter : PowerShell Add-ApplicationAssignment -Id {AppId} -InstallIntent Required -All All Devices -FilterMode Include -FilterID {FilterId} -Action Replace Adding an Assignment for an App, with an intent as Available to a Group with no Device Filter would looks something like this: PowerShell Add-ApplicationAssignment -Id {AppId} -InstallIntent Available -TargetGroupId {Group.Id} -Action Add Adding an Assignment for an App, with the intent as Required to a Group with an exclude Device Filter would looks something like this: PowerShell Add-ApplicationAssignment -Id {AppId} -InstallIntent Available -TargetGroupId {Group.Id} -FilterMode Exclude -FilterID {FilterId} -Action Add I think we‚Äôre done here. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:3","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#function-actions"},{"categories":["android","ios"],"content":" 3.4 Running, Assigning and HidingI‚Äôve included a whole lot of logic and user interface when it comes to this script, and as most of my time has been spent battling with existing assignments, new functions and the headache that is building JSON data from the existing assignment content, I‚Äôm not going to go into any detail about this part of the script but you can as always find it in GitHub if you want to have a gander at what consists as good practice in my mind. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:4","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#running-assigning-and-hiding"},{"categories":["android","ios"],"content":" 3.5 The PayoffIt‚Äôs got to the point now where I honestly couldn‚Äôt be bothered to take screenshots of the script in action, plus it would make this already lengthy post even longer, so through the wonder that is screen recording and YouTube you can see the script in action demonstrating the following: Adding new Assignments for multiple Apps, with install intent as Required to the All Devices group with a Device Filter Adding new Assignments for multiple Apps, with install intent as Available to a Group with a Device Filter Replacing Assignments for multiple Apps, with install intent as Available to the All Users group with a Device Filter Removing all Assignments for multiple Apps Adding new Assignments for multiple Apps, with install intent as Required to the All Devices group with a Device Filter Adding Assignments for multiple Apps, with install intent as Available to the All Users group with a Device Filter I haven‚Äôt recorded every possible option, as I have coffee to drink and other awful PowerShell to write, but you get the gist. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:3:5","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#the-payoff"},{"categories":["android","ios"],"content":" 4 SummaryThis felt like a long journey, even with some of the existing foundation functions already at our fingertips, but a worthy one as I‚Äôm never going to have to individually assign loads of Mobile Apps again, and thanks to this effort, nor do you. As much as there is some intelligence to the script you will still have to use your own knowledge of Intune for when is best to use Devices, Users and Groups, but we can‚Äôt solve all our problems with PowerShell, trust me, I‚Äôm trying. The script however does give you an easy way to bulk assign Mobile Apps in Intune, fully strip out assignments, or even just make every Mobile App available to everyone all at once, without too much clicking about. There is definitely room for improvement and expansion, and at some point I‚Äôll extend this to cover the assignment of Windows and macOS Apps; but for now you‚Äôll have to make do with Android and iOS. As always, please test this one before going large and selecting all your Mobile Apps, I‚Äôve included warning break points for a reason. ","date":"13 February 2023","objectID":"/posts/assigning-intune-applications/:4:0","series":null,"tags":["intune","administration","apps","graph","powershell","automation"],"title":"Assigning Intune Mobile Apps Quickly and Consistently","uri":"/posts/assigning-intune-applications/#summary"},{"categories":["ios","macos"],"content":"Automatically updating iPhone and iPad iOS device compliance policies using PowerShell and Graph API.","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/"},{"categories":["ios","macos"],"content":"I‚Äôm not going to go over old ground in too much detail, as I‚Äôve already covered the importance of keeping your Operating System Compliance Policies up to date in line with the release of new updates, as well as a way to update your compliance policies using Graph and PowerShell. What I am going to do is extend this automated Compliance Policy update functionality to Apple Updates as well, it‚Äôs like I‚Äôve been working with a customer that only has iOS/iPadOS devices in Intune or something. I guess when I end up working with a customer with only Android devices, that I‚Äôll finally be able to put all the pieces together and have one script to update them all. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:0:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#"},{"categories":["ios","macos"],"content":" 1 Operating System Build VersionsUnlike the Windows Valid Operating System Builds option in Compliance Policies, Apple policies don‚Äôt give you the option of having a set of versions to work with, limited to only the following settings: Minimum OS version Maximum OS version Minimum OS build version Maximum OS build version With Apple having different build versions per Operating System, whether this is iOS/iPadOS or macOS, we‚Äôre unable to have one Compliance Policy that covers all the supported OS versions, and need to have specific policies per supported Operating System. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:1:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#operating-system-build-versions"},{"categories":["ios","macos"],"content":" 1.1 Device FiltersNow we all know where I stand on Device Filters and they come to the rescue once again, as we need separate Compliance Policies and the ability to target these to the correct devices. We can create filters for each of the current supported (at time of writing) iOS/iPadOS and macOS operating systems: Description OS Filter Rule All Corporate iOS 15 devices iOS (device.deviceOwnership -eq \"Corporate\") and (device.osVersion -startsWith \"15\") All Corporate iOS 16 devices iOS (device.deviceOwnership -eq \"Corporate\") and (device.osVersion -startsWith \"16\") All Corporate Big Sur devices macOS (device.deviceOwnership -eq \"Corporate\") and (device.osVersion -startsWith \"11\") All Corporate Monterey devices macOS (device.deviceOwnership -eq \"Corporate\") and (device.osVersion -startsWith \"12\") All Corporate Ventura devices macOS (device.deviceOwnership -eq \"Corporate\") and (device.osVersion -startsWith \"13\") Using these we can now create a Compliance Policy for each Operating System version, assigning it to the All Devices or All Users groups and include the corresponding Device Filter. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:1:1","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#device-filters"},{"categories":["ios","macos"],"content":" 1.2 Compliance PoliciesYou‚Äôve probably created Compliance Policies before, and if you haven‚Äôt there are only a few clicks needed to configure one in preparation for the Operating System compliance check. As the Apple build versions are unique, we don‚Äôt need to add in the settings Minimum OS version and Maximum OS version, though they are both a useful visual aide, and I could do with referencing them when I come to write a script to update the Compliance Policy. So go ahead and create your Compliance Policies for each supported Operating System version, assigning them to the required group and filter: OS Version Minimum OS version iOS iOS 15 15.0.0 iOS iOS 16 16.0.0 macOS Big Sur 11.0.0 macOS Monterey 12.0.0 macOS Ventura 13.0.0 With both the Compliance Policies and the Device Filters in place, now we can move onto how we update the Build Versions. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:1:2","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#compliance-policies"},{"categories":["ios","macos"],"content":" 2 Updates and RSS FeedsAs with the Windows Updates, Apple make their updates available in an easy to digest RSS feed which should make scraping back the information we need pretty straight forward: xml \u003citem\u003e \u003ctitle\u003eiOS 16.3 (20D47)\u003c/title\u003e \u003clink\u003ehttps://developer.apple.com/news/releases/?id=01232023f\u003c/link\u003e \u003cguid\u003ehttps://developer.apple.com/news/releases/?id=01232023f\u003c/guid\u003e \u003cdescription\u003eView downloadsView release notes\u003c/description\u003e \u003cpubDate\u003eMon, 23 Jan 2023 09:00:00 PST\u003c/pubDate\u003e \u003ccontent:encoded\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=/download class=more\u003eView downloads\u003c/a\u003e\u003c/p\u003e\u003cil\u003e\u003cp\u003e\u003ca href=/go/?id=ios-16.3-rn class=more\u003eView release notes\u003c/a\u003e\u003c/p\u003e\u003c/il\u003e]]\u003e\u003c/content:encoded\u003e \u003c/item\u003e \u003citem\u003e \u003ctitle\u003eiPadOS 16.3 (20D47)\u003c/title\u003e \u003clink\u003ehttps://developer.apple.com/news/releases/?id=01232023e\u003c/link\u003e \u003cguid\u003ehttps://developer.apple.com/news/releases/?id=01232023e\u003c/guid\u003e \u003cdescription\u003eView downloadsView release notes\u003c/description\u003e \u003cpubDate\u003eMon, 23 Jan 2023 09:00:00 PST\u003c/pubDate\u003e \u003ccontent:encoded\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=/download class=more\u003eView downloads\u003c/a\u003e\u003c/p\u003e\u003cil\u003e\u003cp\u003e\u003ca href=/go/?id=iPadOS-16.3-rn class=more\u003eView release notes\u003c/a\u003e\u003c/p\u003e\u003c/il\u003e]]\u003e\u003c/content:encoded\u003e \u003c/item\u003e \u003citem\u003e \u003ctitle\u003emacOS 13.2 (22D49)\u003c/title\u003e \u003clink\u003ehttps://developer.apple.com/news/releases/?id=01232023d\u003c/link\u003e \u003cguid\u003ehttps://developer.apple.com/news/releases/?id=01232023d\u003c/guid\u003e \u003cdescription\u003eView downloadsView release notes\u003c/description\u003e \u003cpubDate\u003eMon, 23 Jan 2023 09:00:00 PST\u003c/pubDate\u003e \u003ccontent:encoded\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=/download class=more\u003eView downloads\u003c/a\u003e\u003c/p\u003e\u003cil\u003e\u003cp\u003e\u003ca href=/go/?id=macos-13.2-rn class=more\u003eView release notes\u003c/a\u003e\u003c/p\u003e\u003c/il\u003e]]\u003e\u003c/content:encoded\u003e \u003c/item\u003e So all the information we need is contained within the title of each item in the feed, in particular we‚Äôll be needing the Build Version in order to use this to update our Compliance Policy. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:2:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#updates-and-rss-feeds"},{"categories":["ios","macos"],"content":" 2.1 Getting the Build VersionWith the $uri set to the RSS feed, we can Invoke-WebRequest to pull through the data into the variable $Updates, making sure we‚Äôre processing it as XML, and removing any unsupported characters. PowerShell $uri = 'https://developer.apple.com/news/releases/rss/releases.rss' [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType 'application/xml').Content -replace '[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]', '' As the feed has multiple update releases for each Operating System, we need to pass them into an array, so we can select the most recent one: PowerShell $BuildVersion = @() Whilst looping through each item in the feed, we can filter each $Update based on both the Operating System $OS, and the version $Version, to ensure that we‚Äôre only pulling back the data we require, returning only the first and newest update. PowerShell foreach ($Update in $Updates.rss.channel.Item) { if (($Update.title -like \"*$OS*\") -and ($Update.title -like \"*$Version*\")) { $BuildVersion += $Update.title } } return $BuildVersion[0] Running this all together, passing through iOS and 16 for the variables, we get an output of: txt iOS 16.3 (20D47) This looks promising. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:2:1","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#getting-the-build-version"},{"categories":["ios","macos"],"content":" 2.2 Creating the FunctionAs the aim is to repeat both the process of updating Compliance Policies, and tailoring for the multiple Operating Systems and versions, we should wrap the above in a Function. PowerShell Function Get-AppleUpdates() { \u003c# .SYNOPSIS This function is used to get the latest Apple Updates from the Apple Developer RSS Feeds .DESCRIPTION The function pulls the RSS feed from the Apple Developer RSS Feeds .EXAMPLE Get-AppleUpdates -OS iOS -Version 15 #\u003e [cmdletbinding()] param ( [Parameter(Mandatory = $true)] [ValidateSet('iOS', 'macOS')] $OS, [Parameter(Mandatory = $true)] $Version ) try { $uri = 'https://developer.apple.com/news/releases/rss/releases.rss' [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType 'application/xml').Content -replace '[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]', '' $BuildVersion = @() foreach ($Update in $Updates.rss.channel.Item) { if (($Update.title -like \"*$OS*\") -and ($Update.title -like \"*$Version*\")) { $BuildVersion += $Update.title } } return $BuildVersion[0] } catch { Write-Error $Error[0].ErrorDetails.Message break } } This can now be called within PowerShell using the below as examples: PowerShell Get-AppleUpdates -OS iOS -Version 16 Get-AppleUpdates -OS macOS -Version 13 ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:2:2","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#creating-the-function"},{"categories":["ios","macos"],"content":" 3 Updating ComplianceWe‚Äôve already got functions from our last expedition into this topic for getting and updating Compliance Policies, checking for valid JSON as well as the usual suspect for authentication using Connect-MgGraph, so thank you to previous me for this. Armed with our new function for getting the latest Apple Build versions, we now need to build out the script to do our job for us. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:3:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#updating-compliance"},{"categories":["ios","macos"],"content":" 3.1 Getting the PoliciesAs we only care about iOS/iPadOS and macOS today, we need to filter the policies we are retrieving using the Get-DeviceCompliancePolicy function, this can be accomplished by using the @odata.type, and also only those policies with a osMinimumVersion configured: PowerShell $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { (($_.'@odata.type').contains('iosCompliancePolicy') -or ($_.'@odata.type').contains('macOSCompliancePolicy')) -and ($_.osMinimumVersion) -ne $null } Now with the policies in the variable, we can loop through each and set our $OS variable based on the @odata.type of the policy, and grab the $Version variable using the first two digits of osMinimumVersion, as we‚Äôll need these for the Get-AppleUpdates parameters. PowerShell foreach ($OSCompliancePolicy in $OSCompliancePolicies) { If ($OSCompliancePolicy.'@odata.type' -like '*ios*') { $OS = 'iOS' } elseif ($OSCompliancePolicy.'@odata.type' -like '*macOS*') { $OS = 'macOS' } $Version = $OSCompliancePolicy.osMinimumVersion.SubString(0, 2) } ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:3:1","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#getting-the-policies"},{"categories":["ios","macos"],"content":" 3.2 Handling Build VersionsNow the output of the function gives us all the information we could ask for, but we actually only need a small part of it, the bit in brackets: iOS 16.3 (20D47) So we can strip out the data between the brackets, using the magic of Regex and add this to a new variable we‚Äôll use later to update the Compliance Policy in question: PowerShell $Build = (Get-AppleUpdates -OS $OS -Version $Version | Select-String '(?\u003c=\\()[^]]+(?=\\))' -AllMatches).Matches.Value ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:3:2","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#handling-build-versions"},{"categories":["ios","macos"],"content":" 3.3 Building the JSON DataTo update our Compliance Policy, we need to send it some JSON data in a particular format as part of the Update-DeviceCompliancePolicy function, we can build this using both the existing information captured from the Get-DeviceCompliancePolicy and the newly acquired build version, then finally calling the function to update the Compliance Policy. PowerShell $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value $OSCompliancePolicy.'@odata.type' $Update | Add-Member -MemberType NoteProperty -Name 'description' -Value $Description $Update | Add-Member -MemberType NoteProperty -Name 'osMinimumBuildVersion' -Value $Build $JSON = $Update | ConvertTo-Json -Depth 3 Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON All being good, this data looks something like this for our iOS 16 Compliance Policy: JSON { \"@odata.type\": \"#microsoft.graph.iosCompliancePolicy\", \"description\": \"Updated Operating System Device Compliance Policy on 26-01-2023 10:39:29\", \"osMinimumBuildVersion\": \"20D47\" } We can now submit this JSON data to Graph, passing through the required Compliance Policy id, allowing us to update the required policy: PowerShell Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON All going well, we now have an updated policy with the correct and most recent build version for the Operating System. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:3:3","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#building-the-json-data"},{"categories":["ios","macos"],"content":" 4 The SolutionWe have all the component parts to bring the full script together, of which you can see below without the functions and Graph Authentication. Key things to note here that we haven‚Äôt covered individually is the check to see if the build version is already up to date, as there‚Äôs no point triggering a Compliance Check on devices if nothing has changed. PowerShell $Date = Get-Date -Format 'dd-MM-yyyy hh:mm:ss' $Description = \"Updated Operating System Device Compliance Policy on $Date\" $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { (($_.'@odata.type').contains('iosCompliancePolicy') -or ($_.'@odata.type').contains('macOSCompliancePolicy')) -and ($_.osMinimumVersion) -ne $null } foreach ($OSCompliancePolicy in $OSCompliancePolicies) { If ($OSCompliancePolicy.'@odata.type' -like '*ios*') { $OS = 'iOS' } elseif ($OSCompliancePolicy.'@odata.type' -like '*macOS*') { $OS = 'macOS' } $Version = $OSCompliancePolicy.osMinimumVersion.SubString(0, 2) $Build = (Get-AppleUpdates -OS $OS -Version $Version | Select-String '(?\u003c=\\()[^]]+(?=\\))' -AllMatches).Matches.Value If ($OSCompliancePolicy.osMinimumBuildVersion -ne $Build) { $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value $OSCompliancePolicy.'@odata.type' $Update | Add-Member -MemberType NoteProperty -Name 'description' -Value $Description $Update | Add-Member -MemberType NoteProperty -Name 'osMinimumBuildVersion' -Value $Build $JSON = $Update | ConvertTo-Json -Depth 3 Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON Write-Host \"Updated $OS Compliance Policy $($OSCompliancePolicy.displayName) with latest Build: $Build\" -ForegroundColor Green Write-Host } Else { Write-Host \"$OS Compliance Policy $($OSCompliancePolicy.displayName) already on latest Build: $Build\" -ForegroundColor Cyan Write-Host } } ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:4:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#the-solution"},{"categories":["ios","macos"],"content":" 4.1 Script in ActionWe should practice what we preach and test our script in our own Intune environment before letting loose on a production one, so here we go. iOS 15 Compliance Policy without an existing build version Microsoft Intune iOS15 compliance policy. macOS Big Sur Compliance Policy with a current build version Microsoft Intune macOS Big Sur compliance policy. macOS Ventura Compliance Policy with an existing build version Microsoft Intune macOS Ventura compliance policy. Running the script will give us the below output: txt Updated macOS Compliance Policy Compliance_macOS_Corporate_OS_13 with latest Build: 22D49 macOS Compliance Policy Compliance_macOS_Corporate_OS_12 already on latest Build: 21G217 Updated iOS Compliance Policy Compliance_iOS_Corporate_OS_15 with latest Build: 19H307 Updated iOS Compliance Policy Compliance_iOS_Corporate_OS_16 with latest Build: 20D47 Resulting in our Compliance Policies getting updated with the latest build versions: iOS 15 Compliance Policy updated to 19H307 Updated Microsoft Intune iOS15 compliance policy. Checking this against the Apple Developer Release Feed that we haven‚Äôt made a mistake. XML \u003citem\u003e \u003ctitle\u003eiOS 15.7.3 (19H307)\u003c/title\u003e \u003clink\u003ehttps://developer.apple.com/news/releases/?id=01232023b\u003c/link\u003e \u003cguid\u003ehttps://developer.apple.com/news/releases/?id=01232023b\u003c/guid\u003e \u003cdescription\u003eView downloads\u003c/description\u003e \u003cpubDate\u003eMon, 23 Jan 2023 09:00:00 PST\u003c/pubDate\u003e \u003ccontent:encoded\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=/download class=more\u003eView downloads\u003c/a\u003e\u003c/p\u003e]]\u003e\u003c/content:encoded\u003e \u003c/item\u003e macOS Ventura Compliance Policy updated to 22D49 Updated Microsoft Intune macOS Ventura compliance policy. Again checking this against the Apple Developer Release Feed that we still haven‚Äôt made a mistake. XML \u003citem\u003e \u003ctitle\u003emacOS 13.2 (22D49)\u003c/title\u003e \u003clink\u003ehttps://developer.apple.com/news/releases/?id=01232023d\u003c/link\u003e \u003cguid\u003ehttps://developer.apple.com/news/releases/?id=01232023d\u003c/guid\u003e \u003cdescription\u003eView downloadsView release notes\u003c/description\u003e \u003cpubDate\u003eMon, 23 Jan 2023 09:00:00 PST\u003c/pubDate\u003e \u003ccontent:encoded\u003e\u003c![CDATA[\u003cp\u003e\u003ca href=/download class=more\u003eView downloads\u003c/a\u003e\u003c/p\u003e\u003cil\u003e\u003cp\u003e\u003ca href=/go/?id=macos-13.2-rn class=more\u003eView release notes\u003c/a\u003e\u003c/p\u003e\u003c/il\u003e]]\u003e\u003c/content:encoded\u003e \u003c/item\u003e Or resulting in the current build version Compliance Policies not getting updated: macOS Big Sur Compliance Policy not updated Microsoft Intune macOS Big Sur compliance policy. Overall this looks pretty good to me. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:4:1","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#script-in-action"},{"categories":["ios","macos"],"content":" 5 SummaryWe‚Äôre almost there with maintaining Operating System Compliance Policies, with Windows, iOS/iPadOS, and macOS under our belt, our next challenge will be Android, and bringing them all together into one single script. For now though, we‚Äôve reduced the overhead of having to manually update these Compliance Policies for three out of six four (let‚Äôs not mention Linux or ChromeOS just yet) Operating Systems supported in Microsoft Intune, so something to be happy about I guess. ","date":"2 February 2023","objectID":"/posts/apple-os-updating-compliance/:5:0","series":null,"tags":["intune","compliance","updates","graph","powershell","automation"],"title":"Updating Apple Operating System Compliance Policies","uri":"/posts/apple-os-updating-compliance/#summary"},{"categories":["ios","macos"],"content":"Automatically assigning Microsoft Intune Automated Device Enrolment profiles to iPhones and iPads using PowerShell and Graph API.","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/"},{"categories":["ios","macos"],"content":"Now that you‚Äôve made the financial sensible decision to migrate to Microsoft Intune for your Apple device management needs, you‚Äôve got your Apple Push Certificate, sorted your Enrolment Token, added Intune as an MDM provider, and now you‚Äôve got all your iOS/iPadOS devices happily sitting synchronised in Intune waiting to be deployed using Apple‚Äôs Automated Device Enrolment. Life is good. Until you realise that in your excitement you‚Äôve created loads of Enrolment Profiles (up to 1000 in fact, help), and you now have the daunting task of assigning your thousands (up to 200,000, fml) iOS/iPadOS devices to these profiles. No one likes clicking that much. ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:0:0","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#"},{"categories":["ios","macos"],"content":" 1 Developer Tool SneakingIf you hadn‚Äôt realised already, everything in Microsoft Intune is backed by the Graph API, to the point where if you open your browser developer tools, usually by pressing F12, you can actually see the calls to Graph being made when you click around. Edge Developer Tools and Microsoft Intune. This makes it pretty easy to identify the resource in Graph being used, as well as the call you‚Äôll be making to the API. Using this method, and actually assigning a profile to an iOS/iPadOS device in Intune, and watching what calls are made using the developer tools, allows us to capture the Graph resource endpoint and ultimately throw together the functions we need, in this case, to get and assign the Enrolment Profiles. Edge Developer Tools and the Graph API call. ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:1:0","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#developer-tool-sneaking"},{"categories":["ios","macos"],"content":" 1.1 Apple Enrolment TokenTo get all the Enrolment Profiles and Devices associated with the Apple Enrolment Program Token, we‚Äôve got to call the Token itself using the GET /deviceManagement/depOnboardingSettings resource. Note Connect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All'. PowerShell Function Get-ADEEnrolmentToken() { $graphApiVersion = 'Beta' $Resource = 'deviceManagement/depOnboardingSettings' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } This function gives us the below output, and the necessary id we can use to call the Enrolment Profiles and everything else associated with out Apple Enrolment Program Token: txt id : 17793d6e-e12d-4a04-b209-73d302b9a563 appleIdentifier : memv@ennbee.uk tokenExpirationDateTime : 16/05/2023 14:40:28 lastModifiedDateTime : 16/05/2022 14:40:52 lastSuccessfulSyncDateTime : 22/01/2023 12:30:03 lastSyncTriggeredDateTime : 18/01/2023 14:45:26 shareTokenWithSchoolDataSyncService : False lastSyncErrorCode : 0 tokenType : dep tokenName : MEMVENNBEE Intune syncedDeviceCount : 4 dataSharingConsentGranted : True roleScopeTagIds : {0} ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:1:1","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#apple-enrolment-token"},{"categories":["ios","macos"],"content":" 1.2 Enrolment ProfilesWith the Token, and more importantly the id of the Token in hand, we can now call GET /deviceManagement/depOnboardingSettings/{depOnboardingSettingId}/enrollmentProfiles to pull back all the enrolment profiles associated with that Token ID. PowerShell Function Get-ADEEnrolmentProfile() { Param( [Parameter(Mandatory = $true)] $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Punting Get-ADEEnrolmentToken into a variable $Token, we can now pull back all the Enrolment Profiles associated with Enrolment Program Token: PowerShell $Token = Get-ADEEnrolmentToken Get-ADEEnrolmentProfile -Id $Token.Id This will now list out all the Enrolment Profiles linked to the Token, with full details of each of the Enrolment Profiles: txt @odata.type : #microsoft.graph.depIOSEnrollmentProfile id : 17793d6e-e12d-4a04-b209-73d302b9a563_289e29a1-34ec-404c-a1d3-9c8dc712ea80 displayName : Enrolment_iOS_Clinical_Shared_User description : requiresUserAuthentication : False configurationEndpointUrl : https://appleconfigurator2.manage.microsoft.com/MDMServiceConfig?id=61513957-6e30-4b9f-a30a-051a20ffe3da\u0026AADTenantId=58775aec-3fd5-42a9-9c65-b4a34d4e78f2 enableAuthenticationViaCompanyPortal : False requireCompanyPortalOnSetupAssistantEnrolledDevices : False isDefault : False supervisedModeEnabled : True supportDepartment : Clinical Shared Device Users isMandatory : True locationDisabled : False supportPhoneNumber : 01904 profileRemovalDisabled : True restoreBlocked : True appleIdDisabled : True termsAndConditionsDisabled : True touchIdDisabled : True applePayDisabled : True siriDisabled : True diagnosticsDisabled : True displayToneSetupDisabled : False privacyPaneDisabled : True screenTimeScreenDisabled : True deviceNameTemplate : CLIN-S-STD-{{SERIAL}} configurationWebUrl : False enabledSkipKeys : {Android, HomeButtonSensitivity, iMessageAndFaceTime, OnBoarding‚Ä¶} iTunesPairingMode : allow restoreFromAndroidDisabled : True awaitDeviceConfiguredConfirmation : False sharedIPadMaximumUserCount : 0 enableSharedIPad : False companyPortalVppTokenId : 00000000-0000-0000-0000-000000000000 enableSingleAppEnrollmentMode : False homeButtonScreenDisabled : True iMessageAndFaceTimeScreenDisabled : True onBoardingScreenDisabled : True simSetupScreenDisabled : True softwareUpdateScreenDisabled : False watchMigrationScreenDisabled : True appearanceScreenDisabled : True expressLanguageScreenDisabled : False preferredLanguageScreenDisabled : False deviceToDeviceMigrationDisabled : True welcomeScreenDisabled : True passCodeDisabled : False zoomDisabled : False restoreCompletedScreenDisabled : True updateCompleteScreenDisabled : False forceTemporarySession : False temporarySessionTimeoutInSeconds : 0 userSessionTimeoutInSeconds : 0 passcodeLockGracePeriodInSeconds : carrierActivationUrl : userlessSharedAadModeEnabled : False managementCertificates : {} ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:1:2","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#enrolment-profiles"},{"categories":["ios","macos"],"content":" 1.3 Assigning DevicesI had to continue sneaking into the Graph API calls, as I couldn‚Äôt find any reference in the Graph documentation, to the resource used for assigning devices to a profile. I managed to find the following call to support the assignment deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles('$ProfileID')/updateDeviceProfileAssignment, this his references the Enrolment Profile Id, which we can now get using the above function, but it also needs a JSON formatted object containing the serial numbers of the devices: JSON { \"deviceIds\": \"SERIAL1, SERIAL2, SERIAL3\" } We can use a PowerShell psobject to build this for us in the function. Being able to pass through many device serial numbers is good news for us, as instead of having to call Graph like a million times for each device, we can just make the call for each profile, so you know, only hundreds of times. PowerShell Function Add-ADEEnrolmentProfileAssignment() { Param( [Parameter(Mandatory = $true)] $Id, [Parameter(Mandatory = $true)] $ProfileID, [Parameter(Mandatory = $true)] $DeviceSerials ) $graphApiVersion = 'Beta' $Resource = \"deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles('$ProfileID')/updateDeviceProfileAssignment\" $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name 'deviceIds' -Value $DeviceSerials $JSON = $Output | ConvertTo-Json -Depth 3 try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType 'application/json' } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:1:3","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#assigning-devices"},{"categories":["ios","macos"],"content":" 2 Hash Hash ArrayWe‚Äôve now got all the functions we could ever need, now we need to be able to ingest a list of serial numbers and the Enrolment Profile name that they should be associated with; easy, a CSV file and some effort is all that is required: csv Serial,EnrolmentProfile DX3FDFZ6PLFG,Enrolment_iOS_Corp_User_Standard H4QJQ01PPLFG,Enrolment_iOS_Corp_User_Standard F9GV90XKGHPD,Enrolment_iOS_Clinical_Shared_User G6VVLDJPJCLK,Enrolment_iOS_Clinical_Shared_User The tricky part, was how we actually have to use this data, creating a unique list of the Enrolment Profiles, and then based on the association of the device serial number to the profile, add each serial number to each profile. If we don‚Äôt do this, then we are going to be calling graph for each device serial number in the list, and I‚Äôd rather not piss off Microsoft. Time for a hashtable, and maybe an array. ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:2:0","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#hash-hash-array"},{"categories":["ios","macos"],"content":" 2.1 Up, Up and ArrayWe can now import the CSV file and assign it to a variable: PowerShell $CSVPath = \"C:\\Somepath\\SomeCSV.csv\" $Devices = Import-Csv -Path $CSVPath Giving us a wonderful output: txt Serial EnrolmentProfile ------ ---------------- DX3FDFZ6PLFG Enrolment_iOS_Corp_User_Standard H4QJQ01PPLFG Enrolment_iOS_Corp_User_Standard F9GV90XKGHPD Enrolment_iOS_Clinical_Shared_User G6VVLDJPJCLK Enrolment_iOS_Clinical_Shared_User Creating a new array $DeviceProfiles = @() and looping through each $Device in $Devices, we can add all the Enrolment Profiles in the CSV file to the array, finally using Get-Unique to ensure that we only have a unique list of Enrolment Profile names. PowerShell $DeviceProfiles = @() foreach ($Device in $Devices) { $DeviceProfiles += $Device.EnrolmentProfile } $UniqueDeviceProfiles = $DeviceProfiles | Get-Unique Giving us an output similar to the below: txt Enrolment_iOS_Clinical_Shared_User Enrolment_iOS_Corp_User_Standard ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:2:1","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#up-up-and-array"},{"categories":["ios","macos"],"content":" 2.2 Hash Bang WallopWith a hashtable, Assignments = @{} we can loop through each $UniqueDeviceProfile in $UniqueDeviceProfiles adding each unique Enrolment Profile as an array to the hashtable. PowerShell Assignments = @{} foreach ($UniqueDeviceProfile in $UniqueDeviceProfiles){ $Assignments[$UniqueDeviceProfile] = @() } With an output of the below: txt Name Value ---- ----- Enrolment_iOS_Clinical_Shared‚Ä¶ {} Enrolment_iOS_Corp_User_Stand‚Ä¶ {} With the hashtable and an array for each Enrolment Profile, we can finally loop through $Device in $Devices and add the device serial to the matching Enrolment Profile array. PowerShell foreach ($Device in $Devices) { $Assignments[\"$($Device.EnrolmentProfile)\"] += $Device.Serial } Giving us our final form hash table, that we can at last use, to assign devices to Enrolment Profiles. This honestly broke my brain. txt Name Value ---- ----- Enrolment_iOS_Corp_User_Stand‚Ä¶ {DX3FDFZ6PLFG, H4QJQ01PPLFG} Enrolment_iOS_Clinical_Shared‚Ä¶ {F9GV90XKGHPD, G6VVLDJPJCLK} ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:2:2","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#hash-bang-wallop"},{"categories":["ios","macos"],"content":" 3 Assigning Device Enrolment ProfilesWith that horrible mess we created, we can combine it all into a sub-par script, to actually assign these devices to the Enrolment Profiles. The full script as always is in my GitHub repo, and gives you some nice messages along the way as it runs off plays with your Intune environment, it also catches errors, which I‚Äôve been told is important. The bits you care about now, and the final pay off to our work, can be found below, remember to include the functions and authentication otherwise everything will look a little red in the PowerShell console: PowerShell $CSVPath = Read-Host 'Please provide the path to the CSV file containing a list of Serial Numbers and ADE Profile Names e.g. C:\\temp\\ADEDevices.csv' $Devices = Import-Csv -Path $CSVPath $DeviceProfiles = @() foreach ($Device in $Devices) { $DeviceProfiles += $Device.EnrolmentProfile } $UniqueDeviceProfiles = $DeviceProfiles | Get-Unique $Assignments = @{} foreach ($UniqueDeviceProfile in $UniqueDeviceProfiles){ $Assignments[$UniqueDeviceProfile] = @() } foreach ($Device in $Devices) { $Assignments[\"$($Device.EnrolmentProfile)\"] += $Device.Serial } $Token = Get-ADEEnrolmentToken foreach ($Assignment in $Assignments.GetEnumerator()) { $EnrolmentProfile = Get-ADEEnrolmentProfile -Id $Token.id | Where-Object { ($_.displayName -eq $Assignment.Name) } Add-ADEEnrolmentProfileAssignment -Id $Token.id -ProfileID $EnrolmentProfile.id -DeviceSerial $Assignment.Value } After carefully stepping through the script, we can now see the results of our efforts, and although this was only targetted to four devices, the approach will scale: Automated Deployment Profile script assignment results. Digging in a little deeper, we can see that the device has been assigned to the correct Enrolment Profile: Automated Deployment Profile assignment for a single device. Everything looks good, you‚Äôll now just need to add all your serials numbers and the associated Enrolment Profile name to the CSV file and you can starting assigning the devices in anger. ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:3:0","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#assigning-device-enrolment-profiles"},{"categories":["ios","macos"],"content":" 4 SummaryIn short, this is a pretty straight forward approach to assist with assignment of profiles in bulk, especially as part of migrating Apple Business or School Manager registered Apple devices from one MDM to Intune, without the need to click around so much. Realistically I should have encountered this problem a lot sooner, as there are hundreds of thousands of organisations moving away from their existing MDM provider to Microsoft Intune, maybe the ones with this many Apple devices weren‚Äôt lucky enough to work with me and my incessant need to script everything. ","date":"20 January 2023","objectID":"/posts/apple-ade-profile-assignment/:4:0","series":null,"tags":["intune","device enrolment","graph","powershell","automated device enrolment","automation"],"title":"Device Migration and Automated Device Enrolment Profile Assignment","uri":"/posts/apple-ade-profile-assignment/#summary"},{"categories":["windows"],"content":"Updating Windows Autopilot hybrid join device names based on serial numbers updating device certificates using Proactive remediation PowerShell scripts.","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/"},{"categories":["windows"],"content":"Nothing has really changed in the Hybrid Join Autopilot space when it comes to device names, and we‚Äôre still stuck with useless naming conventions for these devices; sometimes a prefix and random characters just isn‚Äôt a good enough identification method for Windows devices. So now that it‚Äôs 2023 it was time to look at this problem once again, mainly because my old solution broke device certificates and an Always On VPN connection that relied on them as part of the Autopilot process. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:0:0","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#"},{"categories":["windows"],"content":" 1 Name ProblemsThe trouble with the old method, a PowerShell script disguised as a Win32 App, is that it will happily rename and reboot the device during the Autopilot OOBE process, is that the device will already have a device certificate with it‚Äôs old jumbled name, and it needs this for both the VPN connection and some level of trust to the domain. What I was seeing is that the computer renamed, but it lost it‚Äôs trust and connection to the domain once the Autopilot process had finished. Not ideal when deploying device remotely. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:1:0","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#name-problems"},{"categories":["windows"],"content":" 1.1 Certificate TemplateWe can update the certificate deployment template in Intune to take into consideration the new name of the device, especially as we‚Äôre using an attribute as part of the device rename that Intune knows about, the serial number. As the Simple Certificate Enrolment Protocol (SCEP) profile supports various device or user attributes we can add these into either Subject Name or Subject Alternative Name of the issued certificate, as well as any prefix we want to add such as L-: txt CN=L-{{SerialNumber}} DNS={{FullyQualifiedDomainName}} DNS={{DeviceName}} DNS=L-{{SerialNumber}}.ennbee.local This sorts out our certificate issue, as the device will have one that has all possible device names, the initial one assigned by the Domain Join profile, and the new one after the device has been renamed. This doesn‚Äôt solve our Domain trust issue though. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:1:1","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#certificate-template"},{"categories":["windows"],"content":" 2 Proactive RemediationWe could do with a way to both check that the device name matches our expected naming convention of L-%SERIAL% for laptops, and D-%SERIAL% for desktops, and fixes the issue for us. This is where Proactive Remediation scripts come to save us, and as I got M365 licenses for Christmas we can make use of them due to this being a licensing requirement. Now that we have new tools at our disposal, and modify permissions for ‚ÄòSELF‚Äô already in place in the destination Organisational Unit allowing the computer object to rename itself, we can hack about with the old script that was doing the computer rename as part of the Autopilot process, and using Proactive Remediation scripts, we can check that the existing device name matches the expected device name. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:2:0","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#proactive-remediation"},{"categories":["windows"],"content":" 2.1 Detection ScriptFirst off we need a something to check that the device is Domain Joined (Lines 1-6), what the new Computer name is expected to be based on whether a desktop or laptop (Lines 8-21), and what the existing Computer name is (Lines 23-26). As we already have a starter for ten, this wasn‚Äôt too much of a hassle to throw together quickly. HDJRename_Detection.ps1 Try { $details = Get-ComputerInfo if (-not $details.CsPartOfDomain) { Write-Output 'Not Domain Joined' Exit 0 } $serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = 'L-' + $serial } Else { $newName = 'D-' + $serial } $newName = $newName.Replace(' ', '') if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } If ($details.CsName -ne $newName) { Write-Warning \"Existing Computer name $($details.CsName) should be $newName\" Exit 1 } Else { Write-Output \"Computer has correct name: $($details.CsName)\" Exit 0 } } Catch { Write-Error $_.Exception Exit 2000 } With Proactive Remediation scripts, we need to pass back the results of this check, and any checks, with Exit Codes and some kind of descriptive text. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:2:1","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#detection-script"},{"categories":["windows"],"content":" 2.2 Remediation ScriptWith the information about the device name in place with the detection, now we need something to fix our issues, or if you want to use bigger words, remediate them. We only want this script to run when the device can actually talk to a Domain, otherwise we‚Äôre in for a bad time of mistrust again. So updating the $domain variable with the name of the domain, we can confirm that we can talk to a Domain Controller, otherwise we exit the script with an error. PowerShell $domain = 'ennbee.local' $dcInfo = [ADSI]\"LDAP://$domain\" if ($null -eq $dcInfo.Path) { Write-Error \"No connectivity to $domain\" } We can reuse the part of the detection script for the creation of the new computer name, using whether a device has a battery or not to determine whether the device is a laptop or desktop, removing any spaces from the serial, and making sure the new device name is 15 characters or less: PowerShell $Serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = 'L-' + $Serial } Else { $newName = 'D-' + $Serial } $newName = $newName.Replace(' ', '') #Removes spaces if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } Last bit to manage is renaming the device using Rename-Computer and sending a shutdown command with our specified restart time, user notification and friendly message: PowerShell $waittime = '60' Rename-Computer -NewName $newName $waitinseconds = (New-TimeSpan -Minutes $waittime).TotalSeconds Write-Host \"Initiating a restart in $waittime minutes\" \u0026 shutdown.exe /g /t $waitinseconds /f /c 'Restarting the computer in 60 minutes due to a computer name change. Please save your work.' Write-Output \"Computer renamed from $($Details.CsName) to $newName\" This gives the user some notice that the restart is going to happen: Restart notification in Windows. All components now in place, we have the full script wrapped in the needed Try/Catch operators, otherwise the good practice PowerShell Police will get you: HDJRename_Remediation.ps1 $domain = 'ennbee.local' $waitTime = '60' Try { $dcInfo = [ADSI]\"LDAP://$domain\" if ($null -eq $dcInfo.Path) { Write-Error \"No connectivity to $domain\" } $serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = 'L-' + $serial } Else { $newName = 'D-' + $serial } $newName = $newName.Replace(' ', '') if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } Rename-Computer -NewName $newName $waitSeconds = (New-TimeSpan -Minutes $waitTime).TotalSeconds Write-Host \"Initiating a restart in $waitime minutes\" \u0026 shutdown.exe /g /t $waitSeconds /f /c \"Restarting your computer in $waitTime minutes due to a computer name change. Please save your work.\" Write-Output \"Computer renamed from $($details.CsName) to $newName\" } Catch { Write-Error $_.Exception Exit 2000 } ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:2:2","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#remediation-script"},{"categories":["windows"],"content":" 2.3 Deployment in IntuneThrowing ourselves into the safe space that is Intune, go and find the Proactive Remediation section, I‚Äôll give you a hint, it‚Äôs under Reports \u003e Endpoint Analytics. Create a new Script Package, selecting and uploading both the detection and remediation scripts as you go, you can get these from GitHub. Make sure you select ‚ÄòRun script in 64-bit PowerShell‚Äô as I couldn‚Äôt be bothered scripting a check if PowerShell was running in the 64-bit context. Remediation script in Microsoft Intune. Go ahead and assign this to a test group of devices, or if you‚Äôre brave or don‚Äôt care about testing, all devices with a Device Filter, giving the assignment a schedule; I‚Äôve gone with daily repeating every day, but amend this to your environment requirements: Remediation schedule in Microsoft Intune. Now we have to sit back and wait for devices to receive the script package, execute it, and where applicable remediate. When the devices do check in, you will be able to see the results in Intune under the Device Status, make sure you‚Äôve added both the ‚ÄòPre-remediation detection output‚Äô and ‚ÄòPost-remediation detection output‚Äô: Remediation results in Microsoft Intune. I didn‚Äôt get a screenshot in time for detection picking up errors, only the success, but you get the gist. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:2:3","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#deployment-in-intune"},{"categories":["windows"],"content":" 3 SummaryWith this method now successfully renaming the device from the Windows Desktop, the certificate in place to cater to the new computer name, we don‚Äôt end up losing domain trust or connectivity as part of the Autopilot Hybrid Join deployment, and the user is the only one impacted, not the Service Desk. I wouldn‚Äôt go as far to say this was a difficult problem, but with how flexible and powerful Proactive Remediation Scripts are, with the limitation only being your ability to write PowerShell (and obviously the correct licensing), I‚Äôd recommend using these more and more in place of wrapping PowerShell scripts as a Win32App and having to battle with creating ‚Äôtag‚Äô files as a detection method. ","date":"12 January 2023","objectID":"/posts/hybrid-join-computer-rename-again/:3:0","series":null,"tags":["windows autopilot","remediation","hybrid join","powershell"],"title":"Proactively Renaming Hybrid Azure AD Joined Devices","uri":"/posts/hybrid-join-computer-rename-again/#summary"},{"categories":["ConfigMgr"],"content":"Installing the Configuration Manager (SCCM) client on migrating Windows 10 and later devices using PowerShell.","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/"},{"categories":["ConfigMgr"],"content":"Have you ever had the pleasure of migrating Configuration Manager clients from one domain to another, or maybe between Configuration Manager environments? Tired of manually reinstalling the client from the Console? Wanting a quick and easy way to keep on top of migrated devices? You‚Äôre in luck. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:0:0","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#"},{"categories":["ConfigMgr"],"content":" 1 Problem TimeWith the migration of clients between Configuration Manager environments, or between domains that Configuration Manager manages devices on, you‚Äôll inevitably be in the situation where you need to reinstall the client on these devices to ensure that communication still occurs between the client and the Management Point. The problem here, is that the underlying computer object, and associated machine account has changed, and from a Configuration Manager perspective will be treated, as it should, as a newly discovered client. You can remedy this by forcing the un-installation and an installation of the client from within the console, but this really isn‚Äôt practical for continued migration of clients. So we need a solution, and quickly. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:1:0","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#problem-time"},{"categories":["ConfigMgr"],"content":" 2 PowerShell to the RescueAs always it‚Äôs PowerShell that will save us, a couple of useful in-built Configuration Manager commands, and a stolen/borrowed Configuration Manager Logging Function. This one will be breezy. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:2:0","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#powershell-to-the-rescue"},{"categories":["ConfigMgr"],"content":" 2.1 Computers without a ClientWe could do this in a couple of ways, create a collection in Configuration Manager of all machines without the Client installed and use this collection to push the installation: SQL select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System where SMS_R_System.Client is null Or capture all non-default devices without the client using Get-CMdevice and target them directly: PowerShell Get-CMdevice | Where-Object { ($_.IsClient -eq '') -and ($_.SMSID -notlike '*Unknown Computer*' ) -and ($_.SMSID -notlike '*Provisioning Device*') } We‚Äôre going with the latter as I‚Äôd like to know which machines are being targeted. To use the Get-CMdevice command, we need to import and connect to the Configuration Manager instance using the below when on the Primary Site Server: Powershell # Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + '\\ConfigurationManager.psd1') # Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\":\" ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:2:1","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#computers-without-a-client"},{"categories":["ConfigMgr"],"content":" 2.2 Logging FunctionsNo we‚Äôre connected we can use the command to capture all the devices we want to target, but we could do with a way to log wtf is going on as part of the re-installation, and in a format that CMTrace will be happy to read. PowerShell Function Write-log { [CmdletBinding()] Param( [parameter(Mandatory = $true)] [String]$Path, [parameter(Mandatory = $true)] [String]$Message, [parameter(Mandatory = $true)] [String]$Component, [Parameter(Mandatory = $true)] [ValidateSet('Info', 'Warning', 'Error')] [String]$Type ) switch ($Type) { 'Info' { [int]$Type = 1 } 'Warning' { [int]$Type = 2 } 'Error' { [int]$Type = 3 } } # Create a log entry $Content = \"\u003c![LOG[$Message]LOG]!\u003e\" + ` \"\u003ctime=`\"$(Get-Date -Format 'HH:mm:ss.ffffff')`\" \" + ` \"date=`\"$(Get-Date -Format 'M-d-yyyy')`\" \" + ` \"component=`\"$Component`\" \" + ` \"context=`\"$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name)`\" \" + ` \"type=`\"$Type`\" \" + ` \"thread=`\"$([Threading.Thread]::CurrentThread.ManagedThreadId)`\" \" + ` \"file=`\"`\"\u003e\" # Write the line to the log file Add-Content -Path $Path -Value $Content } If you‚Äôd like more detail head over to janikvonrotz.ch who wrote this function. With the function in place, we just need to define the $LogFilePath variable and we‚Äôre good to capture whatever horrible errors we‚Äôre to encounter as part of the script. PowerShell $LogFilePath = Join-Path $PSScriptRoot \"$(Get-Date -Format yyyy-MM-dd-HHmm) $($MyInvocation.MyCommand.Name).log\" And a way to punt the information or errors or warnings to the log file when we encounter then, something like: PowerShell Write-Error ($_ | Out-String) Write-Log -Path $LogFilePath -Message ($_ | Out-String) -Component $MyInvocation.MyCommand.Name -Type Error Below is an example of the output of the log file: The generated log file. Who would have thought I would bother putting in logging, it‚Äôs like I wrote this for an actual customer or something. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:2:2","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#logging-functions"},{"categories":["ConfigMgr"],"content":" 2.3 Client InstallationWith the bare-bone stuff in place, we will be using the Install-CMClient command to force the removal of the old client (-ForceReinstall) and force the installation of the new client (-AlwaysInstallClient), aggressive, I like it. I‚Äôve chosen to use the -DeviceId as the device identifier, over -DeviceName or -Name as because we‚Äôre in a situation where there could be duplicate machine names in the case of a client domain migration, so we need something unique. Putting this together, we‚Äôve now got the installation part of the script done, leaning on the existing $SiteCode variable to pass into this part of the script: PowerShell Install-CMClient -DeviceId $UnmanagedDevice.ResourceID -AlwaysInstallClient $true -ForceReinstall $true -SiteCode $SiteCode.Name As mentioned previously, if you were using a device collection to capture your devices without the Configuration Manager client, you could use the -CollectionId parameter instead of -DeviceId in the above script snippet. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:2:3","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#client-installation"},{"categories":["ConfigMgr"],"content":" 3 Installation TimeWith everything now in place, we can do the following: Capture the devices we want that don‚Äôt have the client installed, excluding the built-in Configuration Manager devices and Servers Loop through each device and install the Client Write to the log file when something good or bad happens This way, we can let Configuration Manager do all our heavy lifting, without manual intervention, or trying to run something from the client side to re-install the Configuration Manager Client. The full script in all it‚Äôs glory can as always be found in GitHub Install-CCMClientAlways.ps1 # Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + '\\ConfigurationManager.psd1') # Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\":\" # Functions Function Write-log { [CmdletBinding()] Param( [parameter(Mandatory = $true)] [String]$Path, [parameter(Mandatory = $true)] [String]$Message, [parameter(Mandatory = $true)] [String]$Component, [Parameter(Mandatory = $true)] [ValidateSet('Info', 'Warning', 'Error')] [String]$Type ) switch ($Type) { 'Info' { [int]$Type = 1 } 'Warning' { [int]$Type = 2 } 'Error' { [int]$Type = 3 } } # Create a log entry $Content = \"\u003c![LOG[$Message]LOG]!\u003e\" + ` \"\u003ctime=`\"$(Get-Date -Format 'HH:mm:ss.ffffff')`\" \" + ` \"date=`\"$(Get-Date -Format 'M-d-yyyy')`\" \" + ` \"component=`\"$Component`\" \" + ` \"context=`\"$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name)`\" \" + ` \"type=`\"$Type`\" \" + ` \"thread=`\"$([Threading.Thread]::CurrentThread.ManagedThreadId)`\" \" + ` \"file=`\"`\"\u003e\" # Write the line to the log file Add-Content -Path $Path -Value $Content } # Log file location same as script $LogFilePath = Join-Path $PSScriptRoot \"$(Get-Date -Format yyyy-MM-dd-HHmm) $($MyInvocation.MyCommand.Name).log\" # Gets all devices without the CCM client that are not servers or inbuilt computer objects $UnmanagedDevices = Get-CMdevice | Where-Object { ($_.IsClient -eq '') -and ($_.SMSID -notlike '*Unknown Computer*' ) -and ($_.SMSID -notlike '*Provisioning Device*') -and ($_.DeviceOS -notlike '*Server*') } Foreach ($UnmanagedDevice in $UnmanagedDevices) { Try { Write-Log -Path $LogFilePath -Message \"Attempting to install CCM client on computer $($UnmanagedDevice.Name)\" -Component $MyInvocation.MyCommand.Name -Type Info Install-CMClient -DeviceId $UnmanagedDevice.ResourceID -AlwaysInstallClient $true -ForceReinstall $true -SiteCode $SiteCode.Name } Catch { Write-Error ($_ | Out-String) Write-Log -Path $LogFilePath -Message ($_ | Out-String) -Component $MyInvocation.MyCommand.Name -Type Error } } If you need to keep this running on an on-going basis as part of a phased migration, I‚Äôd recommend hooking this into a Scheduled Task running from the Primary Site server, or if you‚Äôre feeling fancy, a Status Filter Rule to have the script triggered on an event captured by a one of the million Configuration Manager logs files for its components. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:3:0","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#installation-time"},{"categories":["ConfigMgr"],"content":" 4 SummaryLike I said, this one was a quick way to resolve an ongoing issue, but one that you may end up encountering if migrating clients between Configuration Manager sites, Domains, or even moving clients from a Workgroup to a Domain. As always, remember to test the script in your environment, utilise the -WhatIf parameter, and update the $UnmanagedDevices variable based on your own environment requirements. ","date":"15 December 2022","objectID":"/posts/configmgr-client-migration/:4:0","series":null,"tags":["windows","apps","powershell","administration","automation"],"title":"Reinstalling the Configuration Manager Client on Migrated Devices","uri":"/posts/configmgr-client-migration/#summary"},{"categories":["android","entra id"],"content":"Enrolling Android Teams Meeting Room devices in Microsoft Intune without compromising security.","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/"},{"categories":["android","entra id"],"content":"So it turns out that Android based MTR (Microsoft Teams Rooms) want to enrol into Microsoft Intune using what we generally term as a legacy enrolment method in Android Device Administrator, one in fact, that is recommended to be disabled for ‚ÄòAll Users‚Äô as it will take priority over Android Enterprise Personal Device Work Profile enrolment for personal device or BYOD (Bring Your Own Device) scenarios. This seems easy enough, create a new Enrolment Restriction and assign it to a group containing the Microsoft Teams Rooms resource accounts. Done. Post over. What if you want to ensure that all these accounts, and any future accounts used for MTR get this allowance for enrolment? ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:0:0","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#"},{"categories":["android","entra id"],"content":" 1 Device EnrolmentFirst off is creating an Enrolment Restriction profile that allows for Android Device Administrator enrolment, secondly is how we let Intune know that the devices are corporate owned, as they will be picked up as personal devices due to the enrolment method, and finally a way to capture all the MTR resource accounts together. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:1:0","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#device-enrolment"},{"categories":["android","entra id"],"content":" 1.1 Enrolment RestrictionsWe can create a new Enrolment Restriction to allow for a group of users to enrol Android devices using the Device Administrator enrolment method, and we should block personal devices as well: Android enrolment restrictions in Microsoft Intune. With the restriction now created, we need to make sure that this restriction has a higher priority than any other enrolment restriction applying to either All Users or any other group that may contains the MTR resource accounts: Android enrolment restriction priority in Microsoft Intune. Perfect. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:1:1","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#enrolment-restrictions"},{"categories":["android","entra id"],"content":" 1.2 Corporate Device IdentifiersWith the Android Device Administrator enrolment being user driven, and not a method for device enrolment that will automatically set the device as corporate owned, if we attempted to enrol these MTR devices into Intune now, we‚Äôd get an error about the platform not being supported due to us blocking personal devices in the restriction we created. Android blocked enrolment. Corporate Device Identifiers to the rescue, kind of, basically this allows us to upload a unique identifier of a device so that when a device goes through an enrolment process, Intune knows it‚Äôs a corporate owned device. So if the devices are running Android 10 and above, we‚Äôre straight out of luck and need to amend our restriction profile to allow personally owned device enrolment. However, if the device has below Android 10, we can add either the device IMEI number (don‚Äôt use this) or Serial number (do use this) in Intune to identify the device as corporate. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:1:2","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#corporate-device-identifiers"},{"categories":["android","entra id"],"content":" 2 Utilising Dynamic GroupsWith the Device Platform Enrolment restriction in place, we could do with a group to assign this restriction to, if we‚Äôre strict with our naming conventions of these resource accounts being used for the MTR, such as prefixing all account with ‚ÄòMTR-‚Äô, we could go with something simple and use (user.userPrincipalName -startsWith \"MTR-\") as part of our rule syntax. Sadly though, I don‚Äôt like nor trust human input when it comes to device management and Intune, so we need to find a different way that at least reduces the human error part, if not removes it entirely and ensure that all new MTR accounts are added to the restriction. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:2:0","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#utilising-dynamic-groups"},{"categories":["android","entra id"],"content":" 2.1 Assigned LicensesThis is where we use some of the more advanced features of Dynamic User groups, in the multi-value properties and in particular the use of licenses assigned to users. For this, we need to understand which licenses the MTR resource accounts have assigned, and find the correlating Service Plan Id for each service contained within the licenses. The below table details the common services for both the ‚ÄòMicrosoft Teams Rooms Pro‚Äô and ‚ÄòMicrosoft Teams Rooms Pro without Audio Conferencing‚Äô licenses that allows for enrolment into Intune, the Services, and the Service Plan Ids: Friendly Name Service Name Service Plan Id Azure Active Directory Premium P1 AAD_PREMIUM 41781fb2-bc02-4b7c-bd55-b576c07bb09d Microsoft 365 Phone System MCOEV 4828c8ec-dc2e-4779-b502-87ac9ce28ab7 Microsoft Intune INTUNE_A c1ec4a95-1f05-45b3-a911-aa3fa01094f5 Microsoft Teams TEAMS1 57ff2da0-773e-42df-b2af-ffb7a2317929 Skype for Business Online (Plan 2) MCOSTANDARD 0feaeb32-d00e-4d66-bd5a-43b5b83db82c Whiteboard (Plan 3) WHITEBOARD_PLAN3 4a51bca5-1eff-43f5-878c-177680f191af So with this we can attempt to construct a Dynamic User group based on these services that are assigned and enabled for the MTR accounts. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:2:1","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#assigned-licenses"},{"categories":["android","entra id"],"content":" 2.2 Some Dirty LogicSo as it turns out, the above services are part of a hundred other license options, so we need a way to drill down and find only the MTR accounts with these licenses or services assigned. I thought long and hard (about 5 minutes tbh) and came up with the below; basically making sure the above assigned licenses exist, but the user account doesn‚Äôt have any Exchange Online or SharePoint Online license assigned and enabled, hopefully filtering out any other users or user types from the group. We‚Äôre actually using the Service Name captured from the Get-AzureADUser -User 'MTR-Room1@ennbee.uk' | Select -ExpandProperty AssignedPlans PowerShell command here, to cover off all plan types under the service, as there are so many Exchange Online plan types and I want to make this as clean as possible without having to list all the Exchange Online or SharePoint Online service plan Ids. So here‚Äôs the logic we‚Äôre using to find only the MTR accounts using a Dynamic Group. Logic Rule User is assigned a Microsoft 365 Phone System license and is enabled (user.assignedPlans -any (assignedPlan.servicePlanId -eq \"4828c8ec-dc2e-4779-b502-87ac9ce28ab7\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) User is assigned any Intune license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \"SCO\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) User is assigned any Teams license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \"TeamspaceAPI\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) User is assigned any Skype for Business license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \"MicrosoftCommunicationsOnline\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) User is assigned a WhiteBoard Plan 3 license and is enabled (user.assignedPlans -any (assignedPlan.servicePlanId -eq \"4a51bca5-1eff-43f5-878c-177680f191af\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) User is not assigned any Exchange Online license that is enabled or deleted (user.assignedPlans -all (assignedPlan.service -ne \"exchange\" -and assignedPlan.capabilityStatus -eq \"Enabled\" -or assignedPlan.capabilityStatus -eq \"Deleted\")) User is not assigned any SharePoint Online license that is enabled or deleted (user.assignedPlans -all (assignedPlan.service -ne \"SharePoint\" -and assignedPlan.capabilityStatus -eq \"Enabled\" -or assignedPlan.capabilityStatus -eq \"Deleted\")) ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:2:2","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#some-dirty-logic"},{"categories":["android","entra id"],"content":" 3 Allowing Microsoft Team Room EnrolmentAfter all this effort, we can finally create the a group in Azure AD using some of the above and combine it to create the needed Rule Syntax. In the below example, the accounts didn‚Äôt have a Microsoft 365 Phone System license so the (user.assignedPlans -any (assignedPlan.servicePlanId -eq \"4828c8ec-dc2e-4779-b502-87ac9ce28ab7\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) part of the rule was removed: txt (user.assignedPlans -any (assignedPlan.service -eq \"SCO\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) and (user.assignedPlans -any (assignedPlan.service -eq \"TeamspaceAPI\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) and (user.assignedPlans -any (assignedPlan.service -eq \"MicrosoftCommunicationsOnline\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) and (user.assignedPlans -any (assignedPlan.servicePlanId -eq \"4a51bca5-1eff-43f5-878c-177680f191af\" -and assignedPlan.capabilityStatus -eq \"Enabled\")) and (user.assignedPlans -all (assignedPlan.service -ne \"exchange\" -and assignedPlan.capabilityStatus -eq \"Enabled\" -or assignedPlan.capabilityStatus -eq \"Deleted\")) and (user.assignedPlans -all (assignedPlan.service -ne \"SharePoint\" -and assignedPlan.capabilityStatus -eq \"Enabled\" -or assignedPlan.capabilityStatus -eq \"Deleted\")) ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:3:0","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#allowing-microsoft-team-room-enrolment"},{"categories":["android","entra id"],"content":" 3.1 The Dynamic GroupOnce created we now have a group and a set of rules that you should validate in your own environment before putting into production use. You may also need to tweak the logic based on which services you have enabled as part of your MTR licensing assignment. If all goes well, and you‚Äôve managed to copy and paste successfully, you should have a group with rules like the below: Dynamic Group rule in Entra ID. If you‚Äôre really lucky, the group will only populate with the user accounts you are using for the Microsoft Team Room systems, including the Android devices. Dynamic Group members in Entra ID. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:3:1","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#the-dynamic-group"},{"categories":["android","entra id"],"content":" 3.2 Updating the Enrolment RestrictionNow armed with the new group, we can use this as part of the restriction to allow these users to enrol Android devices using the Android Device Administrator method: Android enrolment restriction assignment in Microsoft Intune. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:3:2","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#updating-the-enrolment-restriction"},{"categories":["android","entra id"],"content":" 4 SummaryYou‚Äôve seen here that with a bit of time and patience, you can leverage Dynamic Groups and some of the advanced rules to your advantage, even with an edge use case like allowing only Microsoft Teams Room system accounts the ability to enrol using Android Device Administrator. This is one of many applications of Dynamic Groups throughout Microsoft Intune, and although I bad mouthed them in favour of Device Filters, they are still a necessity when you need a level of advanced logic that the filters can‚Äôt handle. ","date":"14 November 2022","objectID":"/posts/microsoft-teams-rooms-android-device-administrator/:4:0","series":null,"tags":["intune","microsoft teams","device enrolment"],"title":"Enrolling Microsoft Teams Room Systems in Intune","uri":"/posts/microsoft-teams-rooms-android-device-administrator/#summary"},{"categories":["intune"],"content":"Automatically updating Microsoft Defender Microsoft Intune device compliance policies with the latest virus definition version using PowerShell and Graph API.","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/"},{"categories":["intune"],"content":"So one of those rainy days is here, finally, and as I mentioned in a previous post many months ago, I said I‚Äôd look at ways to update other update based compliance policies periodically. That time is now, and although we‚Äôre not focussing on other Operating Systems, we‚Äôre going to have a look at updating a Microsoft Defender compliance policy with the latest platform update version. Exciting I know. ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:0:0","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#"},{"categories":["intune"],"content":" 1 Compliance Policy UpdatesTo reiterate from the previous post, and to hammer the point home, you should be updating these types of policies on a regular basis. When you update a Compliance Policy, it will trigger the devices the policy is assigned to, to re-evaluate the conditions and follow the actions for non-compliance if necessary. For the Defender settings, the one we‚Äôre wanting to update is Microsoft Defender Antimalware minimum version, which if left blank will accept any version of the service, but we should be requiring an up to date version here, you know, for security. ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:1:0","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#compliance-policy-updates"},{"categories":["intune"],"content":" 1.1 Existing FunctionsAs we have looked at this topic previously, we‚Äôre going to re-use some of the existing functions in this script that we created previously: Test-JSON Get-DeviceCompliancePolicy Update-DeviceCompliancePolicy We will also need to create a new one, to retrieve the latest Microsoft Defender Update using the Microsoft Feed Picker for Microsoft Defender Updates. ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:1:1","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#existing-functions"},{"categories":["intune"],"content":" 2 Getting Latest Platform Update VersionSo the feed we‚Äôll be using, doesn‚Äôt actually contain the platform update version, unlike the Windows Operating System feeds which put the information we needed on a plate, this time we need to work a little. We can at least use our previous attempts at capturing the RSS data, but this time, instead of grabbing the data from the feed itself and working with it, we need to grab the link that exists in the feed, grab the data from that page in order to get the version information we need to update the Compliance Policy. We can capture the link we need and associate with the variable $DefenderUpdateUri, and using a bit of magic, we can scrape the data from this link, and capture only the information we need, in this instance it‚Äôs the ‚ÄòNew version‚Äô section of the page: PowerShell $uri = 'https://support.microsoft.com/en-us/feed/atom/5d4715e7-a9c9-378e-3f83-fd410db4ef0a' [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType 'application/xml').Content -replace '[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]', '' $DefenderUpdateUri = @() foreach ($Update in $Updates.feed.entry) { if ($Update.title.'#text' -like '*platform*') { $DefenderUpdateUri += $Update.link.href } } $DefenderPlatformUpdate = Invoke-WebRequest -Uri $($DefenderUpdateUri[0]) $DefenderPlatformVersion = (($DefenderPlatformUpdate.Content).tostring() -split \"[`r`n]\" | Select-String 'New version:') -replace '[^0-9.]' Info Yes I know this is rough af, yes I know I am relying on the data existing on the page, yes I know that splitting out raw content into separate lines, selecting string data containing the information I want and stripping away everything but the numbers and periods is absolutely awful, this was a quick script OK, I‚Äôll give myself a dead leg as penance. ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:2:0","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#getting-latest-platform-update-version"},{"categories":["intune"],"content":" 2.1 A New Function is BornSo with this absolute atrocity of a method of getting the platform update version, we should wrap it all nicely into a function so we can call it in the script. PowerShell Function Get-LatestDefenderPlatformUpdate() { try { $uri = 'https://support.microsoft.com/en-us/feed/atom/5d4715e7-a9c9-378e-3f83-fd410db4ef0a' [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType 'application/xml').Content -replace '[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]', '' $DefenderUpdateUri = @() foreach ($Update in $Updates.feed.entry) { if ($Update.title.'#text' -like '*platform*') { $DefenderUpdateUri += $Update.link.href } } $DefenderPlatformUpdate = Invoke-WebRequest -Uri $($DefenderUpdateUri[0]) $DefenderPlatformVersion = (($DefenderPlatformUpdate.Content).tostring() -split \"[`r`n]\" | Select-String 'New version:') -replace '[^0-9.]' Write-Host Write-Host \"Latest Defender Platform - $DefenderPlatformVersion\" -ForegroundColor Cyan $DefenderPlatformVersion } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:2:1","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#a-new-function-is-born"},{"categories":["intune"],"content":" 3 Updating Compliance PoliciesSo with all the functions we need, we can attack the script that will actually update the Compliance Policy. As we‚Äôve done something similar previously, I don‚Äôt need to use my brain too much to hack around with the existing script, but there are some key areas to focus on‚Ä¶ ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:3:0","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#updating-compliance-policies"},{"categories":["intune"],"content":" 3.1 Getting the Defender PolicyWe need to make sure we‚Äôre grabbing the Defender policies for Windows devices so a little bit of a filter here. We‚Äôre using the @odata.type and the defenderEnabled data here. PowerShell $DefenderCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.'@odata.type').contains('windows10CompliancePolicy') -and ($_.defenderEnabled) -ne '' } ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:3:1","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#getting-the-defender-policy"},{"categories":["intune"],"content":" 3.2 Building the JSON ContentWe need to build the JSON content to update the Compliance Policy with, based on the existing data and the new Microsoft Defender Platform version. We also can use a bit of logic to see if the current version in the Compliance Policy is less than the new one, so we‚Äôre not needlessly updating the policy. PowerShell $Date = Get-Date $Description = \"Updated Defender Antivirus Compliance Policy on $Date\" $DefenderPlatformVersion = Get-LatestDefenderPlatformUpdate $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.windows10CompliancePolicy' $Update | Add-Member -MemberType NoteProperty -Name 'description' -Value $Description foreach ($DefenderCompliancePolicy in $DefenderCompliancePolicies) { if ($DefenderCompliancePolicy.defenderVersion -lt $DefenderPlatformVersion) { Write-Host Write-Host \"Updating Defender Antivirus Compliance Policy - $($DefenderCompliancePolicy.displayname)\" -ForegroundColor Green $Update | Add-Member -MemberType NoteProperty -Name 'defenderVersion' -Value $DefenderPlatformVersion # Creating JSON object to pass to Graph $JSON = $Update | ConvertTo-Json -Depth 3 # Updating the compliance policy Update-DeviceCompliancePolicy -Id $DefenderCompliancePolicy.id -JSON $JSON } else { Write-host \"Defender Antivirus Compliance Policy - $($DefenderCompliancePolicy.displayname) already up to date\" -ForegroundColor Cyan } } ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:3:2","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#building-the-json-content"},{"categories":["intune"],"content":" 3.3 Running the ScriptFirst off let‚Äôs look at the existing out-of-date Defender Compliance Policy, yup, that‚Äôs an old version of the platform: Defender Compliance Policy in Microsoft Intune. We should run the script, and make use of the hour it took to write it: PowerShell .\\Set-DefenderCompliance.ps1 Running the script will prompt you to provide a username and connect to Graph, please do what it says and login: An Entra ID authentication prompt. Then it does it‚Äôs job: The PowerShell script updating the Compliance Policy. Checking the policy to see if it updated: Updated Defender compliance policy in Microsoft Intune. And it did, I‚Äôm as surprised as you are tbh. ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:3:3","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#running-the-script"},{"categories":["intune"],"content":" 4 SummaryThe whole script is pretty shoddy even for the minimal effort it took, but it is functional (as of today), that‚Äôs the main thing. The things you do when customers ask you about automating the recommendations you present to them eh? ","date":"25 October 2022","objectID":"/posts/defender-antivirus-compliance-updates/:4:0","series":null,"tags":["windows","defender","security","compliance","updates","antivirus","graph","powershell","automation"],"title":"Updating Defender Antivirus Compliance Settings","uri":"/posts/defender-antivirus-compliance-updates/#summary"},{"categories":["android"],"content":"Automatically approving and synchronising Google Play mobile applications for Android Enterprise devices in Microsoft Intune using PowerShell and Graph API.","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/"},{"categories":["android"],"content":"We‚Äôve all had to add Managed Google Play Apps in bulk to Microsoft Intune for your Android Enterprise enrolled devices, whether this is just the raft of Microsoft Apps now that all your data is in Office 365, or the hundreds you have in a rival MDM (Mobile Device Management) solution that you‚Äôre looking to migrate away from. Anyone fancy doing this one by one with lots of mouse clicks and early onset repetitive strain injury? Didn‚Äôt think so. This will be a quick one, and annoyingly does require a bit of effort to get the app details‚Ä¶more on that later though. Onto the fun part. ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:0:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#"},{"categories":["android"],"content":" 1 Managed Google Play AppsAs always we‚Äôre leaning on Graph again, as with everything in Microsoft Intune, and knowing we‚Äôve setup our Managed Google Play account already, we can leverage this to add some Android Enterprise Apps into our tenant. Android Enterprise apps can‚Äôt be added to Microsoft Intune in the same way as iOS Store Apps or even Play Store Apps, so we can‚Äôt use POST /deviceAppManagement/mobileApps for creating these in the tenant. All the work is done at the Google side, so luckily we have a way to call this via the Graph API. ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:1:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#managed-google-play-apps"},{"categories":["android"],"content":" 2 Approving and Syncing ApplicationsWe‚Äôre not actually creating anything here, all the Apps and the associated data exists within the Managed Play Store, what we need to do is approve an app. We can use the POST /deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps action to our advantage. We can make a POST call to https://graph.microsoft.com/beta/deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps with some JSON to approve the applications we need. The JSON format we need to pass through using this call is in the format below. JSON { \"packageIds\": [ \"Package Ids value\" ], \"approveAllPermissions\": true } Info What Microsoft don‚Äôt tell you in the documentation is that the ‚ÄúPackage Ids value‚Äù actually needs to be in the format app:PackageId, i.e. app:com.microsoft.emmx, thanks Microsoft. So we‚Äôve got the bare bones of an idea, so what we need to do is get our App Package Ids together for all the Mobile Apps we want. What? You don‚Äôt have these to hand? Well sadly there isn‚Äôt a ‚Äòscripty‚Äô way of getting these, not for free at least, so I‚Äôll do you a solid and provide a list of some of the common Microsoft ones. Mobile App Name Package ID Microsoft Authenticator com.azure.authenticator Microsoft Edge com.microsoft.emmx Microsoft Excel com.microsoft.office.excel Microsoft OneDrive com.microsoft.skydrive Microsoft OneNote com.microsoft.office.onenote Microsoft Outlook com.microsoft.office.outlook Microsoft Planner com.microsoft.planner Microsoft PowerPoint com.microsoft.office.powerpoint Microsoft SharePoint com.microsoft.sharepoint Microsoft Stream com.microsoft.stream Microsoft Teams com.microsoft.teams Microsoft To Do com.microsoft.todos Microsoft Word com.microsoft.office.word Microsoft Yammer com.yammer.v1 For any others, maybe your existing MDM has them listed next the App Name, otherwise you can find an app‚Äôs package name in the URL of the app‚Äôs Google Play Store listing. For example, the URL of an app page is play.google.com/store/apps/details?id=com.example.app123. The app‚Äôs package name is com.example.app123. As we‚Äôre using PowerShell, we could do with throwing these Package Ids into an array of some sort, just so we can loop through them later on. PowerShell $AndroidAppIds = New-Object -TypeName System.Collections.ArrayList $AndroidAppIds.AddRange(@( 'com.azure.authenticator', 'com.microsoft.emmx', 'com.microsoft.office.excel', 'com.microsoft.skydrive', 'com.microsoft.office.onenote', 'com.microsoft.office.outlook', 'com.microsoft.planner', 'com.microsoft.office.powerpoint', 'com.microsoft.sharepoint', 'com.microsoft.stream', 'com.microsoft.teams', 'com.microsoft.todos', 'com.microsoft.office.word', 'com.yammer.v1' ) ) We could have also prefixed the Package Id with the required ‚Äòapp:‚Äô but that‚Äôs one for later me. ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:2:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#approving-and-syncing-applications"},{"categories":["android"],"content":" 3 The FunctionsNow we have our list of Package Ids for the Mobile Apps in a nice format, we need to build a couple of functions (obviously) to approve the Mobile Apps and then synchronise the Apps to the Microsoft Intune tenant. ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:3:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#the-functions"},{"categories":["android"],"content":" 3.1 Approving Managed Google AppsYou would have seen this format for Graph functions a lot on this site, but the important thing here is how we‚Äôre building the JSON object and adding in the required prefix. PowerShell Function Add-GoogleApplication() { param ( $PackageID ) $graphApiVersion = 'Beta' $App_resource = 'deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps' try { if (!$PackageID) {} Write-Host 'No PackageID was passed to the function, provide a valid PackageID variable' -f Red break } $PackageID = 'app:' + $PackageID $Packages = New-Object -TypeName psobject $Packages | Add-Member -MemberType NoteProperty -Name 'approveAllPermissions' -Value 'true' $Packages | Add-Member -MemberType NoteProperty -Name 'packageIds' -Value @($PackageID) $JSON = $Packages | ConvertTo-Json -Depth 3 $uri = \"https://graph.microsoft.com/$graphApiVersion/$($App_resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -ContentType 'application/json' -Body $JSON write-host \"Successfully added $PackageID from Managed Google Store\" -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:3:1","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#approving-managed-google-apps"},{"categories":["android"],"content":" 3.2 Synchronising Managed Google AppsNow that we have a way to Approve the apps, we need a way to sync them‚Ä¶bring on the POST /deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps the below function, and a POST call to the below URI txt https://graph.microsoft.com/beta/deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps PowerShell Function Invoke-SyncGoogleApplication() { [cmdletbinding()] param ( $PackageID ) $graphApiVersion = 'Beta' $App_resource = 'deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($App_resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -ContentType 'application/json' -Body $JSON Write-Host \"Successfully synchronised Google Apps\" -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:3:2","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#synchronising-managed-google-apps"},{"categories":["android"],"content":" 4 Running the ScriptThrowing in the Get-AuthTokenMSAL function we know and love to the above functions, the authentication section to Graph API, the array variable we created, and the below little snippet of a foreach loop, we can happily run through each of the Mobile App Package Ids and approve them, rounding it off with a quick sync. PowerShell foreach($AndroidAppId in $AndroidAppIds) { Add-GoogleApplication -PackageID $AndroidAppId } Invoke-SyncGoogleApplication The full Script can be found in my GitHub Repo and as always, please test this before adding hundreds of apps to the variable, you‚Äôll thank me later. Running the script gives us the following output: PowerShell script output. After a little while, we‚Äôll see the Mobile Apps in the Microsoft Intune Android Apps Portal: Microsoft Intune approved android apps. With the Mobile Apps now in the tenant, you can go ahead and assign them to your hearts content‚Ä¶or maybe script something to do this for you? ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:4:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#running-the-script"},{"categories":["android"],"content":" 5 SummaryEven if grabbing the packageId for each mobile app you want to approve and synchronise to Microsoft Intune is a a bit of a pain, and trust me, I looked at free ways to query the Play Store, this at least cuts the time down for synchronising Managed Google Play apps, especially as part of a migration to Intune. ","date":"27 September 2022","objectID":"/posts/android-enterprise-approving-google-play-apps/:5:0","series":null,"tags":["intune","administration","google","apps","graph","powershell","automation"],"title":"The Easy Way to Approve Managed Google Play Apps","uri":"/posts/android-enterprise-approving-google-play-apps/#summary"},{"categories":["intune"],"content":"Using PowerShell and Graph API to create and assign mobile app categories in Microsoft Intune for iOS and Android devices.","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/"},{"categories":["intune"],"content":"Everyone likes managing clients apps in Microsoft Intune, the grind of packing Windows apps, the chore of selecting Managed Google Play apps, the joy of assigning Apple VPP app licenses in Apple Business Manager‚Ä¶all good fun. What about assigning App Categories, do you want to be manually updating hundreds of Apps with categories? Let‚Äôs make one laborious task, less laborious, with a hacky PowerShell script. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:0:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#"},{"categories":["intune"],"content":" 1 App CategoriesMicrosoft Intune comes with a number of in-built App Categories, that you can assign to a subset of Applications, to make it easier for users to find the apps they need using the Company Portal. The Company Portal. As these are designed for use in the Company Portal, not all Apps can have categories assigned to them, mainly Managed Google Play apps, everything else we‚Äôll have a crack at. The original list of categories is a little limited, and might not fit your application estate. Original Microsoft Intune App Categories. So we should do something about this. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:1:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#app-categories"},{"categories":["intune"],"content":" 1.1 Creating App CategoriesYou could just create new app categories using Microsoft Intune, but I‚Äôm not sure that‚Äôs as exciting as you think it is, so we‚Äôll do this the sensible way and script it. To do this, we will need a way to get the existing App Categories (so we don‚Äôt create duplicates) and of course a way to create new ones. As always, it‚Äôs time for some authentication to Graph API and using the trusted Authentication function we‚Äôve used time and time before. Note Connect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All'. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:1:1","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#creating-app-categories"},{"categories":["intune"],"content":" 1.2 Getting App CategoriesWe‚Äôll be using the GET /deviceAppManagement/mobileAppCategories part of Graph for most of this, and the List option to get all existing categories using the function below. PowerShell Function Get-AppCategory() { [cmdletbinding()] $graphApiVersion = \"Beta\" $Resource = \"deviceAppManagement/mobileAppCategories\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:1:2","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#getting-app-categories"},{"categories":["intune"],"content":" 1.3 Adding App CategoriesSticking with mobileAppCategories section of Graph and using the POST /deviceAppManagement/mobileAppCategories to create new App Categories, we can push new App Categories to Microsoft Intune and all we need is the below function and a name of the category. PowerShell Function Add-AppCategory() { [cmdletbinding()] param ( $Name ) $graphApiVersion = \"Beta\" $Resource = \"deviceAppManagement/mobileAppCategories\" try { if ($Name -eq \"\" -or $null -eq $Name) { write-host \"No name specified, please specify valid Name for the App Category...\" -f Red break } else { $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \"@odata.type\" -Value \"#microsoft.graph.mobileAppCategory\" $Output | Add-Member -MemberType NoteProperty \"displayName\" -Value $Name $JSON = $Output | ConvertTo-Json -Depth 3 Test-JSON -JSON $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri-Method Post -Body $JSON -ContentType \"application/json\" } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:1:3","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#adding-app-categories"},{"categories":["intune"],"content":" 2 Updating Mobile AppsSo we have a way to create new App Categories in Microsoft Intune, so we‚Äôre a third of the way there, we now need a way to get Mobile Apps, get the App Categories assigned to the Mobile Apps, and then add new App Categories. This all seemed more straightforward when I first started this. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#updating-mobile-apps"},{"categories":["intune"],"content":" 2.1 Getting Mobile AppsOh we do love Graph here don‚Äôt we‚Ä¶more use of Graph and in particular GET /deviceAppManagement/mobileApps, we‚Äôll use this to get existing Mobile Apps, be warned though, this resource type will pull back all apps, whether Client Apps or Mobile Application Managed Apps, so we‚Äôll need to use some filtering further down the line. PowerShell Function Get-MobileApps() { [cmdletbinding()] $graphApiVersion = 'Beta' $Resource = 'deviceAppManagement/mobileApps' try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:1","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#getting-mobile-apps"},{"categories":["intune"],"content":" 2.2 Getting Mobile App assigned App CategoriesWe will also need to get the App Categories assigned to each Mobile App, as I thought best we have an option to remove some categories as well as add them. PowerShell Function Get-MobileAppsCategory() { [cmdletbinding()] param ( $Id ) $graphApiVersion = 'Beta' $Resource = \"deviceAppManagement/mobileApps/$Id/categories\" try { if ($Id -eq '' -or $null -eq $Id) { Write-Host 'No Id specified, please specify valid Id for the Mobile App...' -f Red break } else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:2","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#getting-mobile-app-assigned-app-categories"},{"categories":["intune"],"content":" 2.3 App Categories for Mobile AppsNot to hammer the point home, but you could go through each Mobile App and assign the new categories, and if you truly hate yourself, feel free to do this manually. However, we should continue on this scripting path and finish the job we started. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:3","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#app-categories-for-mobile-apps"},{"categories":["intune"],"content":" 2.4 Assigning App CategoriesMore functions to play with, this time one to assign App Categories to a Mobile App, nothing special here but we‚Äôll need to pass through the $Id of the Mobile App and the $CategoryId of the Category. One little weird one here, need to through in a $ref at the end of the uri for the call to Graph, shout out to the Intune Support Team on YouTube for this bit of information. PowerShell Function Add-MobileAppCategory() { [cmdletbinding()] param ( $Id, $CategoryId ) $graphApiVersion = 'Beta' $Resource = \"deviceAppManagement/mobileApps/$Id/categories/`$ref\" try { if ($Id -eq '' -or $null -eq $Id) { Write-Host 'No Mobile App ID specified, please specify valid Id for the Mobile App ID...' -f Red break } elseif ($CategoryId -eq '' -or $null -eq $CategoryId) { Write-Host 'No App Category ID specified, please specify valid ID for the App Category...' -f Red break } else { $value = \"https://graph.microsoft.com/$graphApiVersion/deviceAppManagement/mobileAppCategories/$CategoryId\" $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name '@odata.id' -Value $value $JSON = $Output | ConvertTo-Json -Depth 3 Test-JSON -JSON $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri-Method Post -Body $JSON -ContentType 'application/json' } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:4","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#assigning-app-categories"},{"categories":["intune"],"content":" 2.5 Removing Assigned App CategoriesLast function for today, one to remove the App Category from a Mobile App‚Ä¶we‚Äôll use this one later on. PowerShell Function Remove-MobileAppCategory() { [cmdletbinding()] param ( $Id, $CategoryId ) $graphApiVersion = 'Beta' $Resource = \"deviceAppManagement/mobileApps/$Id/categories/$CategoryId/`$ref\" try { if ($Id -eq '' -or $null -eq $Id) { Write-Host 'No Mobile App ID specified, please specify valid Id for the Mobile App ID...' -f Red break } elseif ($CategoryId -eq '' -or $null -eq $CategoryId) { Write-Host 'No App Category ID specified, please specify valid ID for the App Category...' -f Red break } else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri-Method Delete } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:2:5","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#removing-assigned-app-categories"},{"categories":["intune"],"content":" 3 Repeatable ActionsThe likelihood is that creation of App Categories is going to be a one-off task, but the assignment and removal of the categories might be a regular occurrence in your Microsoft Intune environment, so I thought we‚Äôd deal with four differing use cases: Creation of new App Categories: Upload a CSV file with the new categories in Creation of new App Categories and Assign the App Categories: still a CSV upload but follows on with assignment options Assign App Categories: plain assignment of categories to Mobile Apps Removal of Assign App Categories: Ronseal ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#repeatable-actions"},{"categories":["intune"],"content":" 3.1 Options EverywhereSo we‚Äôll use a simple prompt and choice option in the script to set the $setting variable, and use this to denote what actions we take. PowerShell Write-Host '********************************************************************************' Write-Host '**** Welcome to the Microsoft Intune App Category and Assignment Tool ****' -ForegroundColor Green Write-Host '**** This Script will add new app categories and assign them ****' -ForegroundColor Cyan Write-Host '********************************************************************************' Write-Host Write-Host ' Please Choose one of the options below: ' -ForegroundColor Yellow Write-Host Write-Host ' (1) Upload a CSV of new App Categories...' -ForegroundColor Green Write-Host Write-Host ' (2) Upload a CSV of new App Categories and assign App Categories to Apps...' -ForegroundColor Green Write-Host Write-Host ' (3) Assign App Categories to Apps...' -ForegroundColor Green Write-Host Write-Host ' (4) Remove Assigned App Categories from Apps...' -ForegroundColor Green Write-Host Write-Host ' (E) EXIT SCRIPT ' -ForegroundColor Red Write-Host $Choice_Number = '' $Choice_Number = Read-Host -Prompt 'Based on which option you want to run, please type 1, 2 or E to exit the script, then hit enter ' while ( !($Choice_Number -eq '1' -or $Choice_Number -eq '2' -or $Choice_Number -eq '3' -or $Choice_Number -eq '4' -or $Choice_Number -eq 'E')) { $Choice_Number = Read-Host -Prompt 'Invalid Option, Based on which option you want to run, please type 1, 2, 3, 4 or E to exit the test, then click enter ' } if ($Choice_Number -eq 'E') { Break } if ($Choice_Number -eq '1') { $Setting = 'Upload' } if ($Choice_Number -eq '2') { $Setting = 'Upload/Assign' } if ($Choice_Number -eq '3') { $Setting = 'Assign' } if ($Choice_Number -eq '4') { $Setting = 'Remove' } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:1","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#options-everywhere"},{"categories":["intune"],"content":" 3.2 Handling the OptionsBecause we now have the variable to play with, we can use some wonderful if statements to deal with the options depending on what has been selected when running the script: Upload Assign Remove The below goes into more detail on how each option is handled by the script. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:2","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#handling-the-options"},{"categories":["intune"],"content":" 3.3 UploadThis section will prompt for a CSV file containing new App Categories, make sure you‚Äôve got a heading of ‚ÄòName‚Äô in this file, otherwise things will be painful for you. csv Name Web Browsers Media Players Data Management Once uploaded the script will check for existing App Categories of the same name, safely ignore any it finds, and create new ones. PowerShell if ($Setting -like '*Upload*') { $CSVPath = Read-Host 'Please provide the path to the CSV file containing a list of App Categories e.g. C:\\temp\\appcategories.csv' if (!(Test-Path \"$CSVPath\")) { Write-Host \"Import Path for CSV file doesn't exist\" -ForegroundColor Red Write-Host \"Script can't continue\" -ForegroundColor Red Write-Host break } else { $AppCategories = Import-Csv -Path $CSVPath } $CurrentAppCategories = (Get-AppCategory).displayName foreach ($AppCategory in $AppCategories) { if ($AppCategory.Name -in $CurrentAppCategories) { Write-Host 'App Category '$AppCategory.Name' already exists...' -ForegroundColor Yellow Write-Host } else { Write-Host 'App Category will be created...' -ForegroundColor Yellow Write-Host try { Add-AppCategory -Name $AppCategory.Name | Out-Null Write-Host 'App Category '$AppCategory.Name' created...' -ForegroundColor Green Write-Host } catch { Write-Host 'App Category '$AppCategory.Name' not created...' -ForegroundColor Red Write-Host } } } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:3","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#upload"},{"categories":["intune"],"content":" 3.4 AssignWhether you have uploaded new App Categories, or just want to use the existing ones, now is the time to assign them to the Mobile Apps, so we need a way for you to select not only the Mobile Apps but also the App Categories you want to assign to them. We‚Äôve done this wis a simple Out-Gridview and a variable. PowerShell if ($Setting -like '*Assign*') { Write-Host 'When prompted, wait for all Mobile Apps to load, then select the App or Apps you want to assign a Category. Use The ENTER Key or Mouse \\ OK Button.' -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $MobileApps = @(Get-MobileApps | Where-Object { (!($_.'@odata.type').Contains('managed')) -and (!($_.'@odata.type').Contains('android')) } | Select-Object '@odata.type', displayName, publisher, id | Out-GridView -PassThru -Title 'Select Mobile Apps...') Write-Host 'Wait for all App Categories to load, then select the Category or Categories you want to assign to an Application. Use The ENTER Key or Mouse \\ OK Button.' -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $AddAppCategories = @(Get-AppCategory | Select-Object displayName, id | Out-GridView -PassThru -Title 'Select Apps Categories...') Write-Host 'Starting assignment of Categories to Mobile Apps' -ForegroundColor Yellow Write-Host Write-Warning 'Please confirm you are happy to continue assigning categories to applications' -WarningAction Inquire foreach ($MobileApp in $MobileApps) { $AssignedAppCategories = Get-MobileAppsCategory -Id $MobileApp.id foreach ($AddAppCategory in $AddAppCategories) { if ($AddAppCategory.displayName -in $AssignedAppCategories.displayName) { Write-Host ''$AddAppCategory.displayName' category already assigned to '$MobileApp.displayName'' -ForegroundColor Yellow Write-Host } else { Write-Host 'Adding '$AddAppCategory.displayName' category to '$MobileApp.displayName'...' -ForegroundColor Yellow try { Add-MobileAppCategory -Id $MobileApp.id -CategoryId $AddAppCategory.id Write-Host 'Added '$AddAppCategory.displayName' category to '$MobileApp.displayName'...' -ForegroundColor Green Write-Host } catch { Write-Host 'Unable to add '$AddAppCategory.displayName' category to '$MobileApp.displayName'...' -ForegroundColor Red Write-Host } } } } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:4","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#assign"},{"categories":["intune"],"content":" 3.5 RemoveThis one is a bit blunt if I‚Äôm honest, it prompts you to select the Mobile App/s you want to remove App Categories from, and then removes all of them, bit brutal, but can you be bothered selecting ‚ÄòOK‚Äô for each App Category you want removing? Didn‚Äôt think so. PowerShell if ($setting -eq 'Remove') { Write-Host 'When prompted, wait for all Mobile Apps to load, then select the App or Apps you want to remove categories from. Use The ENTER Key or Mouse \\ OK Button.' -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $MobileApps = @(Get-MobileApps | Where-Object { (!($_.'@odata.type').Contains('managed')) -and (!($_.'@odata.type').Contains('android')) } | Select-Object '@odata.type', displayName, publisher, id | Out-GridView -PassThru -Title 'Select Mobile Apps...') foreach ($MobileApp in $MobileApps) { $AssignedAppCategories = Get-MobileAppsCategory -Id $MobileApp.id If (!$AssignedAppCategories) { Write-Host 'App '$MobileApp.displayName' has no assigned App Categories...' -ForegroundColor Yellow Write-Host } Else { Write-Host 'The following App Categories for App '$MobileApp.displayName' will be removed...' -ForegroundColor Yellow $AssignedAppCategories.displayName Write-Host Start-Sleep -Seconds $sleep foreach ($AssignedAppCategory in $AssignedAppCategories) { Try { Remove-MobileAppCategory -Id $MobileApp.id -CategoryId $AssignedAppCategory.id Write-Host 'App Category '$AssignedAppCategory.displayName' removed from App '$MobileApp.displayName'' -ForegroundColor Green Write-Host } Catch { Write-Host 'Unable to remove App Category '$AssignedAppCategory.displayName' from App '$MobileApp.displayName'' -ForegroundColor Red Write-Host } } } } } ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:3:5","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#remove"},{"categories":["intune"],"content":" 4 Running the ScriptAs we‚Äôve gone through all of this just to assign some App Categories, I guess now would be the time to provide a link to the script, and show you what it does for each of the options. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:4:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#running-the-script"},{"categories":["intune"],"content":" 4.1 Creating New App CategoriesRunning the script and selecting Option 1: The start of the PowerShell script. The new App Categories available: New Microsoft Intune App Categories. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:4:1","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#creating-new-app-categories"},{"categories":["intune"],"content":" 4.2 Assigning the App CategoriesRunning the script and selecting Option 3: The PowerShell script used to assign App Categories. Selecting the Mobile Apps: The PowerShell script selecting mobile apps. Selecting the App Categories: The PowerShell script selecting app categories. Confirming the assignment of the categories: The PowerShell script confirming app categories. The new App Categories on the Edge Mobile App: The new App Categories assigned to Microsoft Edge. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:4:2","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#assigning-the-app-categories"},{"categories":["intune"],"content":" 4.3 Removing the Assigned App CategoriesRunning the script and selecting Option 4: The PowerShell script used to remove App Categories. Selecting the Mobile Apps: The PowerShell script selecting mobile apps. App Categories being removed: The PowerShell script removing app categories. No more App Categories on the Edge Mobile App: The removed App Categories assigned to Microsoft Edge. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:4:3","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#removing-the-assigned-app-categories"},{"categories":["intune"],"content":" 5 SummaryI‚Äôm impressed that you‚Äôve gotten to the bottom of this page, as there‚Äôs way too many functions and screenshots to make the pay off worthwhile, however, what we do have here is a script that can be used regularly to update App Categories, assign them to Mobile Apps, and if you ever have a truly awful day, remove the categories from the apps. All this to make an end-users life a bit easier in the Company Portal. I think I need to re-evaluate the time I spend writing scripts for user experience benefits. ","date":"10 September 2022","objectID":"/posts/creating-assigning-app-categories/:5:0","series":null,"tags":["apps","graph","powershell","administration","automation"],"title":"Creating and Assigning App Categories the Smart Way","uri":"/posts/creating-assigning-app-categories/#summary"},{"categories":["intune"],"content":"Updating Microsoft Intune device ownership state to company owned using PowerShell and Graph API.","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/"},{"categories":["intune"],"content":"What happens if you‚Äôve allowed Windows, iOS, Android, and macOS devices to enrol into Microsoft Microsoft Intune in all kinds of ways, and now you‚Äôre in a situation where devices that should be marked as corporate are marked as personal or unknown? This is more of a common situation than you think, with the need to get remote devices managed in a timely fashion, many organisations used User Driven enrolment methods, such as via the Company Portal, to enrol devices into Microsoft Intune, and without Corporate Device Identifiers, or for the case of Windows no support for them, these devices get enrolled as personal devices. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:0:0","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#"},{"categories":["intune"],"content":" 1 Corporate Device IdentifiersCorporate Device Identifiers are useful for tagging devices as corporate for devices that have not yet enrolled into Microsoft Intune, but what about those that have, and what about the poor devices that just don‚Äôt have a place in the supported corporate device identifier world: Details of supported corporate device identifiers in Microsoft Intune. We need to find a way to update devices we know are corporate owned and change the ownership type, sadly there isn‚Äôt a native way of doing this using Bulk Device Actions in Microsoft Intune, so Graph API and PowerShell it is. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:1:0","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#corporate-device-identifiers"},{"categories":["intune"],"content":" 2 Device Ownership ChangeWe‚Äôre going to leverage Graph API to update devices that we know should be marked as corporate, to corporate ownership in Microsoft Intune. You could manually change this within each device properties page, but if you‚Äôve got 100‚Äôs of devices, this isn‚Äôt a task I‚Äôd be willing to do. We can attack this problem in a couple of ways, three if you count manually changing device ownership, but we‚Äôll stick with: Serial numbers of devices we know are corporate Groups of devices that we know are corporate Now we have options, we‚Äôd better write something to make this change for these devices. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:0","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#device-ownership-change"},{"categories":["intune"],"content":" 2.1 Device ListsFirst off is putting together the list of devices you know are corporate, now I‚Äôm hoping you have an Asset Register that contains all the serial numbers of your owned devices, so you could use this to create a CSV file, make sure the serial numbers are under the heading ‚ÄòSerialNumber‚Äô as we‚Äôll need this later. txt DeviceName,SerialNumber ENB-564d71,VMware-564d710031a992c6-ca795244c03a8322 If you don‚Äôt have these serials to hand, you could probably export all data from the Microsoft Intune All Devices blade, and then filter the data to show devices with unknown or personal ownership and review them. Good luck. For the group, let‚Äôs make use of Azure AD Dynamic Groups,and find a suitable way to use the query to capture the corporate devices. This could be display name, or device make and model, or device ownership not equals corporate, or a combination of all three, really you can be creative here to fit your environment. sql (device.displayName -startsWith \"ENB-\") (device.deviceManufacturer -eq \"Dell Inc.\") and (device.deviceModel -startsWith \"XPS\") (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -ne \"Company\") (device.deviceOSType -eq \"Windows\") and (device.deviceOwnership -ne \"Company\") and (device.deviceManufacturer -eq \"Dell Inc.\") and (device.deviceModel -startsWith \"XPS\") and (device.displayName -startsWith \"ENB-\") ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:1","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#device-lists"},{"categories":["intune"],"content":" 2.2 Managed DevicesWith our list of devices, either CSV or Azure AD Group, we will need to use this data to get the Managed Device object in Microsoft Intune. To do this we will need to authenticate to Graph, and as you‚Äôve seen this one a lot on this blog already in previous posts, I won‚Äôt put the functions here, but we‚Äôre using the PowerShell Authentication Function from the Intune PowerShell Samples GitHub repo to allow us to connect to Graph. Once connected, we can now look at not only getting devices, but updating the device object, time for a function or two. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:2","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#managed-devices"},{"categories":["intune"],"content":" 2.3 Getting Managed DevicesFirst off let‚Äôs use Graph to get all Managed Devices, we can use a Where-Object clause late to fine tune which device we‚Äôre getting the details of later on. PowerShell Function Get-ManagedDevices() { param ( [switch]$IncludeEAS, [switch]$ExcludeMDM ) $graphApiVersion = \"beta\" $Resource = \"deviceManagement/managedDevices\" try { $Count_Params = 0 if ($IncludeEAS.IsPresent) { $Count_Params++ } if ($ExcludeMDM.IsPresent) { $Count_Params++ } if ($Count_Params -gt 1) { write-warning \"Multiple parameters set, specify a single parameter -IncludeEAS, -ExcludeMDM or no parameter against the function\" Write-Host break } elseif ($IncludeEAS) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource\" } elseif ($ExcludeMDM) { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=managementAgent eq 'eas'\" } else { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=managementAgent eq 'mdm' and managementAgent eq 'easmdm'\" } (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:3","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#getting-managed-devices"},{"categories":["intune"],"content":" 2.4 Set Managed Device OwnershipUsing the ‚Äòpatch‚Äô functionality in the Graph API, we can change an existing Managed Device object in Microsoft Intune, in this case, I was lazy and just wrote the function for device ownership, but the ‚Äòpatch‚Äô option would allow you to change many settings. This function only needs a couple of parameters, id and ownertype. PowerShell Function Set-ManagedDeviceOwnership() { param ( $id, $ownertype ) $graphApiVersion = \"Beta\" $Resource = \"deviceManagement/managedDevices\" try { if ($id -eq \"\" -or $null -eq $id) { write-host \"No Device id specified, please provide a device id...\" -f Red break } if ($ownerType -eq \"\" -or $null -eq $ownerType) { write-host \"No ownerType parameter specified, please provide an ownerType. Supported value personal or company...\" -f Red Write-Host break } $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name 'ownerType' -Value $ownerType $JSON = $Output | ConvertTo-Json -Depth 3 $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$ID\" Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $Json -ContentType \"application/json\" } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:4","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#set-managed-device-ownership"},{"categories":["intune"],"content":" 2.5 Importing the DevicesWe have a way to get a Managed Device and change the ownership, let‚Äôs put together a way to import devices via the two previously mentioned methods, so that we can fix whatever mistakes we got ourselves into. So we‚Äôve got either a list of devices or a group of devices we want to convert, we now need to get the Microsoft Intune device ID for each of these devices, we‚Äôll need to do this in two separate ways, one for serial number in the CSV file and one for the Azure AD device ID attribute for the members of the group. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:5","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#importing-the-devices"},{"categories":["intune"],"content":" 2.6 Serial NumberThis is the easy one, we can use the Get-ManagedDevice function we created and use the where-object clause to find the exact device we want, this is the benefit of using serial numbers. PowerShell If ($Device.SerialNumber) { try { $ManagedDevice = Get-ManagedDevices | Where-Object { $_.serialnumber -eq $Device.SerialNumber } Write-Host \"Found \"$ManagedDevice.DeviceName\" with ownership \"$ManagedDevice.ownerType\"\" -ForegroundColor Cyan Write-Host } catch { Write-Host \"Unable to find device with serial number \"$Device.SerialNumber\"\" -ForegroundColor Yellow Write-Host } } We now have the Managed Device detail, and importantly the Managed Device ID we need to change the ownership. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:6","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#serial-number"},{"categories":["intune"],"content":" 2.7 Azure AD Device IDThis one isn‚Äôt as straight forward, as it‚Äôs a three step process, we need to: Get the ID of the group based on the name Get the members of the group and their Azure AD Device ID Get the Managed Device details I could have used the AzureAD PowerShell module for this, but I didn‚Äôt want to authenticate twice, once to Graph and then again to Azure Active Directory‚Ä¶so I created a couple of functions and the script section below to get the required Managed Device ID. PowerShell $Group = Read-host \"Please provide the name of the group containing members you want to convert\" try { $id = (Get-DeviceGroup -GroupName \"$Group\").id $Devices = Get-DeviceGroupMembers -id $id } catch { Write-Host \"Unable to find the device group\" -ForegroundColor Red Write-Host \"Script can't continue\" -ForegroundColor Red Write-Host break } ... Else { try { $ManagedDevice = Get-ManagedDevices | Where-Object { $_.azureADDeviceId -eq $Device.deviceId } Write-Host \"Found \"$ManagedDevice.DeviceName\" with ownership \"$ManagedDevice.ownerType\"\" -ForegroundColor Cyan } catch { Write-Host \"Unable to find device with name \"$Device.DisplayName\"\" -ForegroundColor Yellow } } ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:7","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#azure-ad-device-id"},{"categories":["intune"],"content":" 2.8 Getting the GroupUsing the GET /groups resource in Graph and some filtering, we can get the ID of the group provided from the script. PowerShell Function Get-DeviceGroup() { param ( [string]$GroupName ) $graphApiVersion = \"v1.0\" $Resource = \"dynamic groups\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=displayName eq '$GroupName'\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:8","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#getting-the-group"},{"categories":["intune"],"content":" 2.9 Getting the Group MembershipStill using the GET /groups/{id}/members resource in Graph, but this time using the option to list the members of the group. PowerShell Function Get-DeviceGroupMembers() { param ( [string]$id ) $graphApiVersion = \"v1.0\" $Resource = \"dynamic groups\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$Resource/$id/members\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:2:9","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#getting-the-group-membership"},{"categories":["intune"],"content":" 3 Running the ScriptPutting this all together gives us a way to get the required unique identifier of the Managed Device and change the ownership to corporate, all using a handful of functions. Running the script, after authentication, will give you a prompt for options, as we all like a choice: Use a CSV file; where you‚Äôll be prompted to provide a path to the CSV file containing device serial numbers An Azure AD group; where you‚Äôll be prompted to provide a name of an Azure AD group that contains the devices you know are corporate Panic and exit the script After this, the script will just do it‚Äôs thing and go and get each device in either the CSV or the group, change the ownership, and then tell you about it: PowerShell script updating Device Ownership. You can check the results for yourself in the Microsoft Intune portal: A device with updated ownership status in Microsoft Intune. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:3:0","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#running-the-script"},{"categories":["intune"],"content":" 3.1 Testing the ScriptI haven‚Äôt put an option to prompt you to continue, and definitely no ‚Äòwhatif‚Äô option, so I‚Äôd strongly recommend testing this with a small number of devices, whether this be via CSV or an Assigned Azure AD device group instead of a Dynamic one. Don‚Äôt worry though, there is logic in the script to catch errors for the following: If the group can‚Äôt be found in Azure AD If the group member can‚Äôt be found in Microsoft Intune If the serial number can‚Äôt be found in Microsoft Intune If the change to ownership fails If any of the calls to Graph API fail ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:3:1","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#testing-the-script"},{"categories":["intune"],"content":" 4 SummaryBefore you run this against your environment, just go and check your Tenant customisation settings, mainly around whether iOS/iPadOS and Android devices receive push notifications when the device ownership state changes, you may or may not want to disable this feature. Realistically you shouldn‚Äôt need to use this script regularly, it‚Äôs really designed to be a one-shot silver bullet approach to resolving this particular issue, you should be using the enterprise enrolment methods for devices within Microsoft Intune, especially for Windows devices. ","date":"8 August 2022","objectID":"/posts/updating-enrolled-device-ownership/:4:0","series":null,"tags":["device enrolment","administration","graph","powershell"],"title":"Updating Enrolled Device Ownership Status","uri":"/posts/updating-enrolled-device-ownership/#summary"},{"categories":["ConfigMgr"],"content":"Converting Configuration Manager (SCCM) direct membership collections to query based collections using PowerShell.","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/"},{"categories":["ConfigMgr"],"content":"You may be using Direct Membership Rules in your Microsoft Configuration Manager environment, but should you really for critical production collections? No is the answer, there I said it. Mainly because they require actual effort and overhead to maintain, and secondly because there have been times where these memberships just plain disappear, for many different reasons, but primarily if the ConfigMgr Client is reinstalled on the device. So what do we do? Aggressive PowerShell scripts obviously. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:0:0","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#"},{"categories":["ConfigMgr"],"content":" 1 The ApproachWe‚Äôll need to connect to the Configuration Manager PowerShell module, which is easy enough from the Primary Site server, then carry out the following actions: Get the Device Collections with Direct Members Capture the Direct Members Create a new Query Membership Rule with the members Remove the existing Direct Members Logging? So let‚Äôs get at it‚Ä¶ ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:1:0","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#the-approach"},{"categories":["ConfigMgr"],"content":" 2 Connecting via PowerShellFrom the Configuration Manager server we can leverage the PowerShell Module, import it and then connect to the PSDrive where we get to run all the Configuration Manager commands PowerShell Import-module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + '\\ConfigurationManager.psd1') $SiteCode = Get-PSDrive -PSProvider CMSITE Set-location $SiteCode\":\" ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:0","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#connecting-via-powershell"},{"categories":["ConfigMgr"],"content":" 2.1 Getting the CollectionsI thought I‚Äôd be kind and give a couple of options to the Collection gathering, attack all of the Device Collections or, which is probably more sensible, bring up a list of collections to work with. We‚Äôre doing this through a selection option at the start of the script and using Get-CMDeviceCollection: PowerShell if ($Choice_Number -eq '1') { Write-Host \"Getting Device Collections with Direct Membership Rules...\" -ForegroundColor Yellow $Collections = @(Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like '*SMS_CollectionRuleDirect*' } | Select-Object Name, CollectionID, CollectionRules | Out-GridView -PassThru -Title 'Wait for all Collections to load, then select the Device Collections you want to convert. Use The ENTER Key or Mouse \\ OK Button.') } if ($Choice_Number -eq '2') { Write-Host \"Getting Device Collections with Direct Membership Rules...\" -ForegroundColor Yellow $Collections = Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like '*SMS_CollectionRuleDirect*' } | Select-Object Name, CollectionID, CollectionRules } We need to now identify whether these collection have Direct Members, so for each collection we can look at the CollectionRules attribute, and see if it contains SMS_CollectionRuleDirect: PowerShell foreach ($Collection in $Collections) { if ($Collection.CollectionRules -like \"*SMS_CollectionRuleDirect*\") { } } Now we know this collection has Direct Members, let‚Äôs get them using Get-CMDeviceCollectionDirectMembershipRule: PowerShell $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name Cool, easy part done. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:1","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#getting-the-collections"},{"categories":["ConfigMgr"],"content":" 2.2 Building the QueryAn easy replacement for the Direct Membership Rule is to use a List of Values Query based on System Name, so we‚Äôre going to use that, we‚Äôre going to use this as our basis for the new query once we‚Äôve captured the Direct Members in a suitable format. 2.2.1 CCM Client Computer Name SQL select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (\"COMPUTER1\", \"COMPUTER2\") 2.2.2 AD Client Computer Name SQL select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\"COMPUTER1\", \"COMPUTER2\") We also need to get the names of the Direct Members, throw them into an Array as part of the foreach loop, then squish the Array to a String and combine the template query and the members: PowerShell $RuleName = \"Direct Membership Replacement Query\" $QueryPart = \"select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\" if ($Collection.CollectionRules -like \"*SMS_CollectionRuleDirect*\") { $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name $MembersArray = @() foreach ($DirectMember in $DirectMembers) { $MembersArray += $DirectMember.RuleName } $Members = '\"{0}\"' -f ($MembersArray -join '\",\"') $QueryExpression = $QueryPart + $Members + \")\" } This gives us the complete query string which we can use later on to create the Query Membership Rule. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:2","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#building-the-query"},{"categories":["ConfigMgr"],"content":" 2.2 Building the QueryAn easy replacement for the Direct Membership Rule is to use a List of Values Query based on System Name, so we‚Äôre going to use that, we‚Äôre going to use this as our basis for the new query once we‚Äôve captured the Direct Members in a suitable format. 2.2.1 CCM Client Computer Name SQL select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (\"COMPUTER1\", \"COMPUTER2\") 2.2.2 AD Client Computer Name SQL select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\"COMPUTER1\", \"COMPUTER2\") We also need to get the names of the Direct Members, throw them into an Array as part of the foreach loop, then squish the Array to a String and combine the template query and the members: PowerShell $RuleName = \"Direct Membership Replacement Query\" $QueryPart = \"select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\" if ($Collection.CollectionRules -like \"*SMS_CollectionRuleDirect*\") { $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name $MembersArray = @() foreach ($DirectMember in $DirectMembers) { $MembersArray += $DirectMember.RuleName } $Members = '\"{0}\"' -f ($MembersArray -join '\",\"') $QueryExpression = $QueryPart + $Members + \")\" } This gives us the complete query string which we can use later on to create the Query Membership Rule. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:2","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#ccm-client-computer-name"},{"categories":["ConfigMgr"],"content":" 2.2 Building the QueryAn easy replacement for the Direct Membership Rule is to use a List of Values Query based on System Name, so we‚Äôre going to use that, we‚Äôre going to use this as our basis for the new query once we‚Äôve captured the Direct Members in a suitable format. 2.2.1 CCM Client Computer Name SQL select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (\"COMPUTER1\", \"COMPUTER2\") 2.2.2 AD Client Computer Name SQL select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\"COMPUTER1\", \"COMPUTER2\") We also need to get the names of the Direct Members, throw them into an Array as part of the foreach loop, then squish the Array to a String and combine the template query and the members: PowerShell $RuleName = \"Direct Membership Replacement Query\" $QueryPart = \"select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\" if ($Collection.CollectionRules -like \"*SMS_CollectionRuleDirect*\") { $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name $MembersArray = @() foreach ($DirectMember in $DirectMembers) { $MembersArray += $DirectMember.RuleName } $Members = '\"{0}\"' -f ($MembersArray -join '\",\"') $QueryExpression = $QueryPart + $Members + \")\" } This gives us the complete query string which we can use later on to create the Query Membership Rule. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:2","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#ad-client-computer-name"},{"categories":["ConfigMgr"],"content":" 2.3 Updating the RulesUsing Add-CMDeviceCollectionQueryMembershipRule we can create the new rule in the Collection using the variables we created earlier: PowerShell Add-CMDeviceCollectionQueryMembershipRule -CollectionName $Collection.Name -QueryExpression $QueryExpression -RuleName $RuleName And after successfully creating the rule we can use Remove-CMDeviceCollectionDirectMembershipRule to loop through the existing Direct Members and remove them: PowerShell foreach ($DirectMember in $DirectMembers) { Try { Remove-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name -ResourceID $DirectMember.ResourceID -Force } Catch { } } ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:2:3","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#updating-the-rules"},{"categories":["ConfigMgr"],"content":" 3 Running the ScriptNow we have all the bits we needed in place (cough logging cough), we can launch the script and use the option to select a Collection first as a test before we run it across the entire environment. Set-CollectionDirectToQueryMembership.ps1 #Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + '\\ConfigurationManager.psd1') #Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\":\" Clear-Host $RuleName = 'Direct Membership Replacement Query' # CCM Client Name #$QueryPart = 'select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (' # AD Name $QueryPart = 'select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (' $Merged = New-Object System.Collections.ArrayList Write-Host '********************************************************************************' Write-Host '**** Welcome to the Direct Membership Device Collection Converter Tool ****' -ForegroundColor Green Write-Host '**** This Script will convert Direct Memberships to Query Based Membership ****' -ForegroundColor Cyan Write-Host '*******************************************************************************' Write-Host Write-Host ' Please Choose one of the options below: ' -ForegroundColor Yellow Write-Host Write-Host ' (1) Manually select the Device Collections your want to convert... ' -ForegroundColor Green Write-Host Write-Host ' (2) Run the Script on all Device Collection in your environment... ' -ForegroundColor Green Write-Host Write-Host ' (E) EXIT SCRIPT ' -ForegroundColor Red Write-Host $Choice_Number = '' $Choice_Number = Read-Host -Prompt 'Based on which option you want to run, please type 1, 2 or E to exit the test, then click enter ' while ( !($Choice_Number -eq '1' -or $Choice_Number -eq '2' -or $Choice_Number -eq 'E')) { $Choice_Number = Read-Host -Prompt 'Invalid Option, Based on which option you want to run, please type 1, 2 or E to exit the test, then click enter ' } if ($Choice_Number -eq 'E') { Break } if ($Choice_Number -eq '1') { Write-Host \"Getting Device Collections with Direct Membership Rules...\" -ForegroundColor Yellow $Collections = @(Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like '*SMS_CollectionRuleDirect*' } | Select-Object Name, CollectionID, CollectionRules | Out-GridView -PassThru -Title 'Wait for all Collections to load, then select the Device Collections you want to convert. Use The ENTER Key or Mouse \\ OK Button.') } if ($Choice_Number -eq '2') { Write-Host \"Getting Device Collections with Direct Membership Rules...\" -ForegroundColor Yellow $Collections = Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like '*SMS_CollectionRuleDirect*' } | Select-Object Name, CollectionID, CollectionRules } if (!$Collections) { Write-Host 'No Collections selected, please run the script again...' -ForegroundColor Red Break } foreach ($Collection in $Collections) { if ($Collection.CollectionRules -like '*SMS_CollectionRuleDirect*') { $Output = New-Object -Type PSCustomObject $Output | Add-Member -type NoteProperty -Name ID -Value $Collection.CollectionID $Output | Add-Member -type NoteProperty -Name Collection -Value $Collection.Name Write-Host \"The Collection $($Collection.Name) contains Direct Members...\" -ForegroundColor Cyan Write-Host $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name Write-Host \"Getting direct members for Collection $($Collection.Name)...\" -ForegroundColor Cyan Write-Host $MembersArray = @() foreach ($DirectMember in $DirectMem","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:3:0","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#running-the-script"},{"categories":["ConfigMgr"],"content":" 3.1 Oh the ChoicesDoing so will prompt you with options, oooo exciting, here we‚Äôll select Option 1: The PowerShell window with script options. Doing so will open a grid view of the collections in your Configuration Manager environment, this may take a while to load, and you should wait for them to load before selecting and confirming your Collections: The PowerShell script grid view of Configuration Manager collections. Search for the Collection you want to update and select OK: The PowerShell script grid view results of a search for a Configuration Manager collection. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:3:1","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#oh-the-choices"},{"categories":["ConfigMgr"],"content":" 3.2 Converting the RulesNow the magic happens, including a nice little output table of the results of the conversion: The PowerShell window with the results of the script. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:3:2","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#converting-the-rules"},{"categories":["ConfigMgr"],"content":" 3.3 The Results Speak for ThemselvesNow the script has completed, we can go and check on the results on the Device Collection itself, look no Direct Members any more: A Configuration Manager collection with query based members. With the new Query in place: A query rule of a Configuration Manager collection. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:3:3","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#the-results-speak-for-themselves"},{"categories":["ConfigMgr"],"content":" 4 SummaryWith this small but powerful script, you can remove all Direct Membership rules and use the more sustainable (and less likely to cause you problems), Query Rule on either Collections you know have Direct Members, or if you‚Äôre feeling brave, your entire set of Device Collections. This saves you having to manually create the Rules, or even the collections, which would mean re-deploying configuration, updates, applications etc. to a new Collection. What a time saver. ","date":"28 July 2022","objectID":"/posts/configmgr-converting-direct-member-collections/:4:0","series":null,"tags":["collections","powershell","administration","automation"],"title":"Converting Configuration Manager Direct Membership Collections","uri":"/posts/configmgr-converting-direct-member-collections/#summary"},{"categories":["windows"],"content":"Configuring Dell BIOS settings using application in Microsoft Intune with PowerShell.","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/"},{"categories":["windows"],"content":"What if you‚Äôve only got Microsoft Intune to configure your Dell BIOS settings and not the glory that is Configuration Manager? How much do you like PowerShell, Win32 Apps and passwords in plain text? Well you‚Äôre in luck, I‚Äôve thrown together something that can help you out based on a need to ensure that Secure Boot is configured for Dell laptops when it was discovered via the Windows health attestation report that around 80% of the Windows devices had it turned off. (Don‚Äôt worry, I checked that the devices had GPT partitions before I just launched a PowerShell script at them.) ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:0:0","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#"},{"categories":["windows"],"content":" 1 Dell PowerShell ProviderThere are several posts kicking around the internet about using Microsoft Intune to not only change or set Dell BIOS passwords, but also using CSV files to configure BIOS settings using the Dell Command | PowerShell Provider, the below are the ones I‚Äôve found and borrowed from: systanddeploy.com ccmexec.com configjon.com These posts detail ways to use the Dell PowerShell Provider to set the BIOS configurations and an Admin BIOS Password on Dell devices, so I‚Äôm only going to focus on how I‚Äôve taken this, run with it, and made it a little easier to handle in Microsoft Intune. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:1:0","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#dell-powershell-provider"},{"categories":["windows"],"content":" 1.1 Setting up the ModuleAs we‚Äôre going to be packaging up the PowerShell script as a Win32App, we‚Äôll need to ensure that not only is the script available, but also the PowerShell module (and some rogue .dll files too for some reason). From an elevated PowerShell window run the below command to save the PowerShell module to a new folder: PowerShell Save-Module -Name DellBIOSProvider -Path C:\\Temp\\Set-DellBIOS\\ The version at the time of writing of this module is 2.6.0, which has a reliance on some of the .dll files installed from the Visual C++ Re-distributables: Details of the Dell requirements for their PowerShell module. You can just copy the below required files from a machine with the Visual C++ Redistributables already installed and paste them in the DellBiosProvider\\2.6.0 folder we created saving the PowerShell module, this sounds better than packaging and pushing out more software: msvcp100.dll msvcr100.dll msvcp140.dll vcruntime140.dll vcruntime140_1.dll ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:1:1","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#setting-up-the-module"},{"categories":["windows"],"content":" 1.2 Installing the ModuleThis is the bit where we use some of that there logic to check if the module is already installed on a machine, and if so, to bin it off and use the version packaged in the Win32App, then import the module. PowerShell $ScriptPath = (Get-Location).Path if (Test-Path -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\") { Write-Output \"DellBIOSProvider folder already exists @ $env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider.\" Write-Output \"Deleting the folder...\" Remove-Item -Path \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\" -Recurse -Force } Write-Output \"Copying DellBIOSProvider module to: $env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\" Copy-Item -Path \"$ScriptPath\\DellBIOSProvider\\\" -Destination \"$env:ProgramFiles\\WindowsPowerShell\\Modules\\\" -Recurse -Force try { Import-Module \"DellBIOSProvider\" -Force -Verbose -ErrorAction Stop Write-Output \"Importing the Dell BIOS Provider module\" } catch { Write-Output \"Error importing module: $_\" exit 1 } ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:1:2","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#installing-the-module"},{"categories":["windows"],"content":" 2 Configuring the BIOSWith the module installed, we‚Äôd better take a look on a test device what the BIOS settings and values actually are, so after importing the module run the below command to get all the BIOS setting details: PowerShell Get-ChildItem -path DellSmbios:\\ | ForEach-Object { Get-ChildItem -path @(\"DellSmbios:\\\" + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } Format-List This will dump all the existing BIOS settings, and importantly their supported values, such as: PowerShell Attribute : BootList CurrentValue : LEGACY PossibleValues : {Legacy, Uefi} PSChildName : BootSequence Attribute : SecureBoot CurrentValue : Disabled PossibleValues : {Disabled, Enabled} PSChildName : SecureBoot So now we know what Setting and their support Values are‚Ä¶ ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:2:0","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#configuring-the-bios"},{"categories":["windows"],"content":" 2.1 BIOS SettingsOther scripts use a CSV file that contain the BIOS settings you wish to configure, but this is a little clunky as you‚Äôd need to update and package the Win32App each time, so let‚Äôs use PowerShell array variables to get these settings: PowerShell [Parameter(Mandatory=$true,Position=2)][string[]]$Settings=@(), [Parameter(Mandatory=$true,Position=3)][string[]]$Values=@() Now that we have these parameters, we can pass through both the setting and the value to the script: PowerShell ./Set-BIOSSettings.ps1 -Settings BootList,SecureBoot -Values Uefi,Enabled With these arrays in place, we need to squish them together into a new array in order to query them later in the script: PowerShell [int]$max = $Settings.count $NewBIOSSettings = for ($i = 0; $i -lt $max; $i++) { [PSCustomObject]@{ Setting = $Settings[$i] Value = $Values[$i] } } We end up with a $NewBIOSSettings array variable containing the settings and their values: PowerShell Setting Value ------- ----- BootList Uefi SecureBoot Enabled ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:2:1","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#bios-settings"},{"categories":["windows"],"content":" 2.2 Making the ChangesNow we have the settings and values, as well as the PowerShell module, we can loop through each setting and apply it to the device. We‚Äôve got a couple of options here, whether the device has a BIOS Admin Password set or otherwise. PowerShell $AdminPassSet = (Get-Item -Path DellSmbios:\\Security\\IsAdminPasswordSet).CurrentValue $BIOSSettings = get-childitem -path DellSmbios:\\ | ForEach-Object { get-childitem -path @(\"DellSmbios:\\\" + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } foreach ($NewBIOSSetting in $NewBIOSSettings) { $NewItemSetting = $NewBIOSSetting.Setting $NewItemValue = $NewBIOSSetting.Value Write-Output \"Changing: $NewItemSetting \u003e $NewItemValue\" foreach ($BIOSSetting in $BIOSSettings | Where-Object { $_.attribute -eq $NewItemSetting }) { $SettingAttribute = $BIOSSetting.attribute $SettingCategory = $BIOSSetting.PSChildName If (($AdminPassSet -eq $true)) { Try { Set-Item -Path Dellsmbios:\\$SettingCategory\\$SettingAttribute -Value $NewItemValue -Password $Password Write-Output \"New value for $SettingAttribute is $NewItemValue\" New-ItemProperty -Path \"$DetectionRegPath\" -Name \"$SettingAttribute\" -Value \"$NewItemValue\" -Force | Out-Null } Catch { Write-Output \"Cannot change setting $SettingAttribute (Return code $_)\" } } Else { Try { Set-Item -Path Dellsmbios:\\$SettingCategory\\$SettingAttribute -Value $NewItemValue Write-Output \"New value for $SettingAttribute is $NewItemValue\" New-ItemProperty -Path \"$DetectionRegPath\" -Name \"$SettingAttribute\" -Value \"$NewItemValue\" -Force | Out-Null } Catch { Write-Output\"Cannot change setting $Attribute (Return code $_)\" } } } } ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:2:2","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#making-the-changes"},{"categories":["windows"],"content":" 3 App Deployment","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:0","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-deployment"},{"categories":["windows"],"content":" 3.1 Detection MethodsWe could do with a method to detect whether they have been set successfully. We can use the detection method functionality of the Win32App, and in particular the registry detection method, so using the script we can set registry values using PowerShell and query them from Microsoft Intune. We will create a new Registry Key, and then for each BIOS setting we configure, can create new registry values with the name of the setting and the value they have been configured to, i.e. ‚ÄòSecureBoot‚Äô and ‚ÄòEnabled‚Äô. PowerShell $DetectionRegPath = \"HKLM:\\SOFTWARE\\IntuneHelper\\DellBIOSProvider\" New-ItemProperty -Path \"$DetectionRegPath\" -Name \"$SettingAttribute\" -Value \"$NewItemValue\" -Force | Out-Null ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:1","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#detection-methods"},{"categories":["windows"],"content":" 3.2 App PackagingNow that we have the whole script, which you can download along with the PowerShell Module and dll files (if you cba to do it yourself), we need to wrap this content up using the Microsoft Win32 Content Prep Tool. Download the tool and dump it somewhere useful on your machine, launch a Command Prompt and in four simple steps you‚Äôll have a Win32App ready for Microsoft Intune: From the path of where the tool exists, run the tool specifying the: Source Folder PowerShell script (including extension) Output folder Whether you want to create a catalog (you don‚Äôt) The Win32App tool wrapping the Dell application. Now that you‚Äôve got the Application, time to upload it to Microsoft Intune and configure some settings. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:2","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-packaging"},{"categories":["windows"],"content":" 3.3 App InstallationNavigate to the Windows Apps section of Microsoft Intune and time to create a new app, making sure you select ‚ÄòWindows app (Win32)‚Äô as the App type. After uploading the .intunewin file make sure to use sysnative in the path of the install command, we also need to pass through the variables for the Settings and Values as well as Password for the BIOS Admin password: PowerShell C:\\Windows\\Sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -noprofile -executionpolicy Bypass -file .\\Set-DellBIOSSettings.ps1 -Password S3CurePW0RD -Settings BootList,SecureBoot -Values Uefi,Enabled Now I know what you‚Äôre saying, ‚ÄúEurrggh password is in plain text, bad, not secure, naughty‚Äù, well you‚Äôre not wrong, but then you really should be using Role-Based Access Control to protect your Microsoft Intune environment, and allowing only privileged users to access it, so maybe it‚Äôs you that‚Äôs got the issue this time. Also, I didn‚Äôt write an uninstall script, so just use the same command line for this, unless you fancy writing something yourself. Dell Command App installation parameters in Microsoft Intune. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:3","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-installation"},{"categories":["windows"],"content":" 3.4 App RequirementsMake sure you select the correct architecture for your deployment, this time it‚Äôs x64 as well as the Minimum Operating System based on the Dell BIOS Provider requirements or your own device estate settings. Dell Command App requirements in Microsoft Intune. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:4","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-requirements"},{"categories":["windows"],"content":" 3.5 App Detection MethodsAs we‚Äôve taken all that time to create something to use for a detection method in the PowerShell script itself, we should probably reference it here. Now these detections are going to be based on what Settings and Values you‚Äôre configuring, for this instance it‚Äôs BootList and SecureBoot, so let‚Äôs query them using the below settings: BootList Key path: HKLM\\SOFTWARE\\IntuneHelper\\DellBIOSProvider Value name: BootList Detection method: String comparison Operator: Equals Value: Uefi Dell Command App detection methods for UEFI in Microsoft Intune. SecureBoot Key path: HKLM\\SOFTWARE\\IntuneHelper\\DellBIOSProvider Value name: SecureBoot Detection method: String comparison Operator: Equals Value: Enabled Dell Command App detection methods for Secure Boot in Microsoft Intune. Complete the wizard as no other settings are required and deploy this App to a test device group. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:5","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-detection-methods"},{"categories":["windows"],"content":" 3.6 App MonitoringWe were kind enough to add some basic logging using the Transcript function of PowerShell into the script, so on your test device, go have a look at the log located in C:\\Windows\\Temp called Set-DellBIOSSettings.log and check to see if it‚Äôs run correctly ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:6","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#app-monitoring"},{"categories":["windows"],"content":" 3.7 Log FileDell Command log file. It did. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:7","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#log-file"},{"categories":["windows"],"content":" 3.8 Registry ItemsLet‚Äôs check the registry and make sure it‚Äôs added in the correct values: Updated Registry settings. Yup. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:8","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#registry-items"},{"categories":["windows"],"content":" 3.9 PowerShellWe can run the same command as we did at the start of this journey to confirm that our settings have applied: PowerShell Get-ChildItem -path DellSmbios:\\ | ForEach-Object { Get-ChildItem -path @(\"DellSmbios:\\\" + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } Format-List Attribute : BootList CurrentValue : UEFI BOOT PossibleValues : {Legacy, Uefi} PSChildName : BootSequence Attribute : SecureBoot CurrentValue : Enabled PossibleValues : {Disabled, Enabled} PSChildName : SecureBoot They did. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:3:9","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#powershell"},{"categories":["windows"],"content":" 4 SummaryWith some confidence, you can now push out this App with your preferred settings to a wider device group, and the benefit is that the App itself is reusable; you just need to specify which settings are to be configured in the Installation command line, and how to detect them in the Detection Method. There may be cleaner ways of doing this, probably using Proactive remediations, but then again, that requires Windows 10/11 Enterprise licensing, and we all haven‚Äôt got enterprise level money. ","date":"10 July 2022","objectID":"/posts/dell-bios-settings-intune/:4:0","series":null,"tags":["intune","dell","apps","bios","hardware","powershell"],"title":"Configuring Dell BIOS Settings with Microsoft Intune","uri":"/posts/dell-bios-settings-intune/#summary"},{"categories":["intune"],"content":"Automatically updating Microsoft Windows 10 and 11 Microsoft Intune device compliance policies using PowerShell and Graph API.","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/"},{"categories":["intune"],"content":"Let‚Äôs talk about Windows 10 and above Operating System Compliance in Microsoft Intune, and specifically how using ‚ÄòMinimum OS Version‚Äô and ‚ÄòMaximum OS Version‚Äô is dumb and you should definitely check yourself if you‚Äôre using this in your environment. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:0:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#"},{"categories":["intune"],"content":" 1 ComplianceIf you‚Äôre already using Microsoft Intune compliance policies, good for you, and extra points if you‚Äôve integrated these with Conditional Access policies. However, are you using Compliance Policies in the correct way, or even a way that makes sense? ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:1:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#compliance"},{"categories":["intune"],"content":" 1.1 Compliance GranularityI‚Äôll talk about granularity of compliance settings, and the main reason to split out these Compliance settings into separate policies, is the actions for non-compliance; you see, you only get one set of these per policy. So where you would want to mark a device as non-compliant immediately if there is no Antivirus installed, would you want it to be the same for the supported operating system builds? (Clue here, the answer is no). This is a very real-world configuration, if you‚Äôre controlling the deferral and deadline settings of Software Updates via Windows Update for Business, it wouldn‚Äôt be fair and honourable for you to mark a device as non-compliant, and potentially block access to Office 365 authenticated services, when the computer itself hasn‚Äôt even received the update to be installed. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:1:1","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#compliance-granularity"},{"categories":["intune"],"content":" 1.2 Operating System ComplianceSo now we know we should be using separate policies per compliance setting, so let‚Äôs look at Operating System Versions: Minimum and maximum operating system compliance policy settings in Microsoft Intune. With this setting you can configure the minimum and maximum operating system version, including build version using the below information to denote the format. Info The operating system version is defined as major.minor.build.revision Sounds great, if and only if all of your Windows 10 devices are all running the same Feature Update. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:1:2","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#operating-system-compliance"},{"categories":["intune"],"content":" 1.3 The ProblemLet‚Äôs say your estate has the following supported (at time of writing) Windows 10 and later versions: Windows 10 20H2 Windows 10 21H1 Windows 10 21H2 Windows 11 21H2 So to cover all of the supported operating systems your minimum operating system compliance setting is going to be 10.0.19042.1766 (June 2022). Great. This however means that any of the newer builds, patched or unpatched, will also be marked as compliant, as you know 10.0.19044.1111 is a bigger number than 10.0.19042.1766. Quick Maths. This is a problem, as do you really want to mark unpatched operating systems as compliant. Again, answer here is no. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:1:3","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#the-problem"},{"categories":["intune"],"content":" 1.4 The SolutionThis is where the ‚ÄòValid operating system builds‚Äô section in the Compliance Policy comes into play, allowing you to split out each build in your End-user computing estate and each to have their own range of minimum and maximum: Valid operating system builds in a compliance policy settings in Microsoft Intune. So there we have it, a fast turnaround for a real-world problem. Now about updating this monthly‚Ä¶ ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:1:4","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#the-solution"},{"categories":["intune"],"content":" 2 Updating ComplianceWhen you update a Compliance Policy, it will trigger the devices the policy is assigned to, to re-evaluate the conditions and follow the actions for non-compliance if necessary. So you should be updating the Operating System Compliance Policy every month, which, although it isn‚Äôt a painful task, it is a repeatable one. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#updating-compliance"},{"categories":["intune"],"content":" 2.1 Needless Automation to the RescueSo what does any good Consultant do in this situation? They write some PowerShell to do the work for them, even if writing the PowerShell script probably took longer than just updating the Compliance Policy. I‚Äôve already demonstrated my coffee fuelled scripting in previous posts and this one isn‚Äôt going to be much different. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:1","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#needless-automation-to-the-rescue"},{"categories":["intune"],"content":" 2.2 Functions are your FriendsWe‚Äôll need a few functions for this, some grabbed from the Intune PowerShell Samples GitHub repo, and some thrown together based on the samples. We‚Äôll be authenticating to Graph, grabbing the Windows Compliance Policies that have the Valid Operating System Build setting, getting the latest OS Build version from the Microsoft Atom Feeds and then updating the Compliance Policy. This sounded easier in my head if I‚Äôm honest. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:2","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#functions-are-your-friends"},{"categories":["intune"],"content":" 2.3 AuthenticationThe move to MSAL based authentication can be found in this post. Note Connect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementManagedDevices.ReadWrite.All,DeviceManagementConfiguration.ReadWrite.All'. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:3","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#authentication"},{"categories":["intune"],"content":" 2.4 Testing JSONAs we need to make sure the JSON we‚Äôre generating is valid, best we test it before launching it at Graph. PowerShell Function Test-JSON() { param ( $JSON ) try { $TestJSON = ConvertFrom-Json $JSON -ErrorAction Stop $validJson = $true } catch { $validJson = $false $_.Exception } if (!$validJson) { Write-Host \"Provided JSON isn't in valid JSON format\" -f Red break } } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:4","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#testing-json"},{"categories":["intune"],"content":" 2.5 Getting Compliance PoliciesAs we‚Äôre going to be updating Compliance Policies, we should probably have a method to actually retrieve them using GET /deviceManagement/deviceCompliancePolicies. PowerShell Function Get-DeviceCompliancePolicy() { $graphApiVersion = \"Beta\" $Resource = \"deviceManagement/deviceCompliancePolicies\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:5","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#getting-compliance-policies"},{"categories":["intune"],"content":" 2.6 Updating Compliance PoliciesThis one I had to actually sort out myself, this function allows you to push updates to existing Compliance Policies. Details on this method can be found in the Graph API documentation PATCH /deviceManagement/deviceCompliancePolicies/{deviceCompliancePolicyId} documentation. PowerShell Function Update-DeviceCompliancePolicy() { [cmdletbinding()] param ( $Id, $JSON ) $graphApiVersion = \"Beta\" $Resource = \"deviceManagement/deviceCompliancePolicies/$id\" try { if (!$Id) { write-host \"No Compliance Policy Id specified, specify a valid Compliance Policy Id\" -f Red break } if ($JSON -eq \"\" -or $null -eq $JSON) { write-host \"No JSON specified, please specify valid JSON for the Compliance Policy...\" -f Red } else { Test-JSON -JSON $JSON $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri-Method Patch -Body $JSON -ContentType \"application/json\" Write-Host Write-Host \"Successfully Updated Compliance Policy\" -ForegroundColor Green } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:6","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#updating-compliance-policies"},{"categories":["intune"],"content":" 2.7 Getting Latest Windows VersionThis is where I had a lot of issues, mainly down to the [xml] setting when parsing the RSS feed, this is down to how the content is processed when handling it live, instead of outputting it to file. Essentially, this function scrapes the Microsoft Atom Feed for Windows 10 and Windows 11 updates, dumps the versions into an array and picks out the most recent build version, avoiding ‚ÄòPreview‚Äô and ‚ÄòOut of band‚Äô updates. PowerShell Function Get-LatestWindowsUpdatesBuild() { [cmdletbinding()] param ( [ValidateSet('10', '11')] $OS, $Build ) try { if (!$OS) { write-host \"No OS specified, specify a valid Operating System number\" -f Red break } else { if ($OS -eq '10') { $uri = \"https://support.microsoft.com/en-us/feed/atom/6ae59d69-36fc-8e4d-23dd-631d98bf74a9\" } elseif ($OS -eq '11') { $uri = \"https://support.microsoft.com/en-us/feed/atom/4ec863cc-2ecd-e187-6cb3-b50c6545db92\" } [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \"application/xml\").Content -replace \"[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\", \"\" $BuildVersions = @() foreach ($Update in $Updates.feed.entry) { if (($update.title.'#text' -like \"*$Build*\") -and ($update.title.'#text' -notlike \"*Preview*\") -and ($update.title.'#text' -notlike \"*Out-of-band*\")) { $BuildVersions += $update.title.'#text' } } write-host write-host \"Latest OS Build - $($BuildVersions[0])\" -ForegroundColor Cyan $BuildVersions[0].Substring($BuildVersions[0].LastIndexOf(\".\")) -replace \"[')', '.']\", \"\" } } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:2:7","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#getting-latest-windows-version"},{"categories":["intune"],"content":" 3 Getting, Setting and UpdatingFinally we get to utilising the functions, putting it all together and updating the Compliance Policy with the latest minimum OS build version based on the latest release of each Windows 10 and later build. Let‚Äôs break down each section before I launch the full script at you. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:3:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#getting-setting-and-updating"},{"categories":["intune"],"content":" 3.1 Getting the Correct PolicyWe need to make sure we‚Äôre pulling through only Windows based Compliance Policies, and only those that have legitimate build version information. We‚Äôre using the @odata.type and the validOperatingSystemBuildRanges data here. PowerShell $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.'@odata.type').contains(\"windows10CompliancePolicy\") -and ($_.validOperatingSystemBuildRanges) -ne \"\" } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:3:1","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#getting-the-correct-policy"},{"categories":["intune"],"content":" 3.2 Getting the Build VersionsTo update each field in the Compliance Policy, we need to handle each line, in this example we only have the four currently supported versions of Windows 10, but we need the script to cater for all versions. Using this we can get the latest build version for each Windows version. PowerShell $OSBuilds = $OSCompliancePolicy.validOperatingSystemBuildRanges $OSUpdates = @() foreach ($OSBuild in $OSBuilds) { if ($OSBuild.lowestVersion -like '*10.0.1*') { $WindowsVersion = '10' } elseif ($OSbuild.lowestVersion -like '*10.0.2*') { $WindowsVersion = '11' } $OSVersion = $OSBuild.lowestVersion.Split('.')[2] $BuildVersion = Get-LatestWindowsUpdatesBuild -OS $WindowsVersion -Build $OSVersion $NewOSBuildVersion = '10.0.' + $OSVersion + '.' + $BuildVersion } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:3:2","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#getting-the-build-versions"},{"categories":["intune"],"content":" 3.3 Building the JSON PayloadNow that we have the required information, we need to build the JSON payload to update the Compliance Policy with, based on the existing data and the new minimum OS build versions. PowerShell $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.windows10CompliancePolicy' $Update | Add-Member -MemberType NoteProperty -Name 'description' -Value $Description foreach ($OSBuild in $OSBuilds) { $OSUpdate = New-Object -TypeName psobject $OSUpdate | Add-Member -MemberType NoteProperty -Name 'description' -Value $OSBuild.description $OSUpdate | Add-Member -MemberType NoteProperty -Name 'lowestVersion' -Value $NewOSBuildVersion $OSUpdate | Add-Member -MemberType NoteProperty -Name 'highestVersion' -Value $OSBuild.highestVersion $OSUpdates += $OSUpdate } $Update | Add-Member -MemberType NoteProperty -Name 'validOperatingSystemBuildRanges' -Value @($OSUpdates) $JSON = $Update | ConvertTo-Json -Depth 3 ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:3:3","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#building-the-json-payload"},{"categories":["intune"],"content":" 3.4 Fusion, HaSeeing the whole bunch of bits together looks a little bit like this, and the full script can be found in my GitHub repo. PowerShell $Date = Get-Date $Description = \"Updated Operating System Device Compliance Policy on $Date\" $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name '@odata.type' -Value '#microsoft.graph.windows10CompliancePolicy' $Update | Add-Member -MemberType NoteProperty -Name 'description' -Value $Description $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.'@odata.type').contains(\"windows10CompliancePolicy\") -and ($_.validOperatingSystemBuildRanges) -ne \"\" } foreach ($OSCompliancePolicy in $OSCompliancePolicies) { Write-Host Write-Host \"Updating Operating System Device Compliance Policy - $($OSCompliancePolicy.displayname)\" -ForegroundColor Green $OSBuilds = $OSCompliancePolicy.validOperatingSystemBuildRanges $OSUpdates = @() foreach ($OSBuild in $OSBuilds) { if ($OSBuild.lowestVersion -like '*10.0.1*') { $WindowsVersion = '10' } elseif ($OSbuild.lowestVersion -like '*10.0.2*') { $WindowsVersion = '11' } $OSVersion = $OSBuild.lowestVersion.Split('.')[2] $BuildVersion = Get-LatestWindowsUpdatesBuild -OS $WindowsVersion -Build $OSVersion $NewOSBuildVersion = '10.0.' + $OSVersion + '.' + $BuildVersion Write-Host Write-Host \"Updating OS Build Minimum version to - $NewOSBuildVersion\" -ForegroundColor Green $OSUpdate = New-Object -TypeName psobject $OSUpdate | Add-Member -MemberType NoteProperty -Name 'description' -Value $OSBuild.description $OSUpdate | Add-Member -MemberType NoteProperty -Name 'lowestVersion' -Value $NewOSBuildVersion $OSUpdate | Add-Member -MemberType NoteProperty -Name 'highestVersion' -Value $OSBuild.highestVersion $OSUpdates += $OSUpdate } # Creating JSON object to pass to Graph $Update | Add-Member -MemberType NoteProperty -Name 'validOperatingSystemBuildRanges' -Value @($OSUpdates) $JSON = $Update | ConvertTo-Json -Depth 3 # Updating the compliance policy Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON } ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:3:4","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#fusion-ha"},{"categories":["intune"],"content":" 4 The Action ShotTime to finally run this script and add some level of automation to this laborious task of updating Compliance Policy‚Ä¶ PowerShell .\\Set-WindowsOSCompliance.ps1 Running the script will prompt you to provide a username and connect to Graph, please do this and login: Authentication to Entra ID. Then it does everything for you, and tells you about it: PowerShell script updating the compliance operating system builds. Best we check the Compliance Policy to make sure it‚Äôs done what I asked it to: The updated valid operating system builds in a compliance policy settings in Microsoft Intune. It did, and a cheeky description based on when the policy was last updated. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:4:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#the-action-shot"},{"categories":["intune"],"content":" 5 SummaryThis one was a bit long winded, but it does give you an insight in not only why granular compliance policies are important, but also how to work around limitations within them. The limitations, especially when your organisation is adhering to security frameworks and need specific operating system compliance are something you may have to battle with, or in this instance, just take my example and run. Luckily other Operating System compliance such as Android or iOS/iPadOS isn‚Äôt as complicated to handle, but I might do a write up on that at some point‚Ä¶maybe a rainy day. Also, if you have the inclination, you could expand upon this script and have it run on a schedule, but you‚Äôll have to change the authentication method and associated permissions utilising an App Registration in Azure AD‚Ä¶sounds thrilling. ","date":"30 June 2022","objectID":"/posts/windows-os-compliance-updates/:5:0","series":null,"tags":["windows","compliance","updates","security","graph","powershell","automation"],"title":"Windows Operating System Compliance Updates","uri":"/posts/windows-os-compliance-updates/#summary"},{"categories":["intune"],"content":"Automatically assigning Windows Autopilot group tags using PowerShell and Graph API.","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/"},{"categories":["intune"],"content":"Now I don‚Äôt think I promised that I‚Äôd cover off bulk tagging Autopilot devices in a previous post, but you know, I was running low on things to write about. So here we are. As I like to practice what I preach, I‚Äôd left myself the task of updating 1000‚Äôs of Autopilot devices with a new Group Tag after a successful Proof-of-Concept implementation of a suitable convention and syntax. Thanks past me. So what does any good consultant do? Run away? Come up with a janky script that you‚Äôll only ever run once, that contains nested ‚Äòforeach‚Äô loops? Write a perfectly reusable and digestible PowerShell script using Graph API to update existing Autopilot devices‚Ä¶ ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:0:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#"},{"categories":["intune"],"content":" 1 The ApproachNow I needed an easy way to tag specific devices with Group Tags, and then anything that didn‚Äôt have a specific Group Tag to get a default one‚Ä¶so we‚Äôre working with two distinct use cases here. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:1:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#the-approach"},{"categories":["intune"],"content":" 2 Ready, AimFor the first, we‚Äôll start with exporting the Autopilot Devices from the tenant, as this CSV file will contain the Serial Numbers we need further down the line. Export of Windows Autopilot devices to csv from Microsoft Intune. Now with the CSV file exported, and looking something like the below: csv Serial number,Manufacturer,Model,Group tag,Profile status,Purchase order,Userless Enrollment Status \"0924-3584-5488-9044-8423-3149-46\",\"Microsoft Corporation\",\"Virtual Machine\",\"Entra\",\"Assigned\",\"\",\"Unknown\" \"7440-0683\",\"Microsoft Corporation\",\"Virtual Machine\",\"CIS\",\"Assigned\",\"\",\"Not Allowed\" \"AAA-0263-9697-7653-AAAA-AAAA-AA\",\"Microsoft Corporation\",\"Virtual Machine\",\"Entra\",\"Assigned\",\"\",\"Not Allowed\" \"DNuesTLjtKit\",\"QEMU\",\"QEMU Virtual Machine\",\"CIS\",\"Assigned\",\"\",\"Not Allowed\" \"poiuytrewqlkjhgfdsa\",\"Microsoft Corporation\",\"Virtual Machine\",\"CIS\",\"Assigned\",\"\",\"Not Allowed\" \"qwertyuiopasdfghjklzxcvbnm\",\"Microsoft Corporation\",\"Virtual Machine\",\"CIS\",\"Assigned\",\"\",\"Not Allowed\" Go ahead and laboriously update the CSV file with Group Tags and remove any devices that you want tagging with the default one. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:2:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#ready-aim"},{"categories":["intune"],"content":" 3 Repeat OffendersWe need a way to not only set the Group Tag, but fetch the ID of the Autopilot device, and as we‚Äôre doing this potentially 100‚Äôs of times, and I did say this was a repeatable and reusable script, we should create a PowerShell function or two. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:3:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#repeat-offenders"},{"categories":["intune"],"content":" 3.1 Handshake TimeLets steal the PowerShell Authentication Function from the Intune PowerShell Samples GitHub repo to allow us to connect to Graph. Note Connect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementManagedDevices.ReadWrite.All'. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:3:1","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#handshake-time"},{"categories":["intune"],"content":" 3.2 Autopilot FunctionsNow we can have a nice authenticated chat to Graph, we need to talk to the Autopilot section, deviceManagement/windowsAutopilotDeviceIdentities in fact. So let‚Äôs get all Autopilot devices, as we‚Äôll need this to: Get all Autopilot devices without a Group Tag set Get the Autopilot device Id for the entries in the CSV file we created ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:3:2","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#autopilot-functions"},{"categories":["intune"],"content":" 3.3 Getting Autopilot Devices PowerShell Function Get-AutopilotDevices() { $graphApiVersion = \"Beta\" $Resource = \"deviceManagement/windowsAutopilotDeviceIdentities\" try { $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:3:3","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#getting-autopilot-devices"},{"categories":["intune"],"content":" 3.4 Update Autopilot Device AttributesNow we can use the below function to set the Autopilot Group Tag (I should could probably update this to set other device attributes). PowerShell Function Set-AutopilotDevice() { [CmdletBinding()] param( $Id, $GroupTag ) $graphApiVersion = \"Beta\" $Resource = \"deviceManagement/windowsAutopilotDeviceIdentities/$Id/updateDeviceProperties\" try { if (!$id) { write-host \"No Autopilot device Id specified, specify a valid Autopilot device Id\" -f Red break } if (!$GroupTag) { $GroupTag = Read-host \"No Group Tag specified, specify a Group Tag\" } $Autopilot = New-Object -TypeName psobject $Autopilot | Add-Member -MemberType NoteProperty -Name 'groupTag' -Value $GroupTag $JSON = $Autopilot | ConvertTo-Json -Depth 3 $uri = \"https://graph.microsoft.com/$graphApiVersion/$($Resource)\" Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \"application/json\" write-host \"Successfully added '$GroupTag' to device\" -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:3:4","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#update-autopilot-device-attributes"},{"categories":["intune"],"content":" 4 Scary Stuff Lies AheadSo we now have the functions in order to connect, get and set all the things we need. Here comes the fun part, PowerShell logic driven by four cups of coffee. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:4:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#scary-stuff-lies-ahead"},{"categories":["intune"],"content":" 4.1 Script ParametersBefore that, some lovely parameters to ensure you can‚Äôt really mess things up. Method: Set to be either ‚ÄòCSV‚Äô or ‚ÄòOnline‚Äô, used for loading that beautiful CSV created earlier, or to just grab all the Autopilot devices in the tenant with a blank Group Tag DefaultGroupTag: The ‚ÄòCatch All‚Äô Group Tag for those devices that don‚Äôt have one set already ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:4:1","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#script-parameters"},{"categories":["intune"],"content":" 4.2 The Logic?Here we have the guts of the script, designed so that you run it through once with the CSV option, then a second time using the Online option. Don‚Äôt ask me why I did it this way, four coffees remember. I was also kind enough to capture any of the devices in the CSV file missing a Group Tag and prompt to enter one in. Very kind. PowerShell if ($method -eq 'csv') { $csvPath = Read-Host 'Please provide the path to the csv file containing a list of device serial numbers and new Group Tag e.g. C:\\temp\\devices.csv' if (!(Test-Path \"$csvPath\")) { Write-Host \"Import Path for csv file doesn't exist\" -ForegroundColor Red Write-Host \"Script can't continue\" -ForegroundColor Red Write-Host break } else { $autopilotDevices = Import-Csv -Path $csvPath } } else { Write-Host 'Getting all Autopilot devices without a Group Tag' -ForegroundColor Cyan $autopilotDevices = Get-AutopilotDevices | Where-Object { ($null -eq $_.groupTag) -or ($_.groupTag) -eq '' } $groupTag = Read-Host \"Please enter the default group tag for devices without a tag:\" } # Sets Group Tag foreach ($autopilotDevice in $autopilotDevices) { $id = $autopilotDevice.id if (!$id) { Write-Host 'No Autopilot Device Id, getting Id from Graph' -ForegroundColor Cyan $id = (Get-AutopilotDevices | Where-Object { ($_.serialNumber -eq $autopilotDevice.'serial Number') }).id Write-Host \"ID:'$Id' found for device with serial '$($autopilotDevice.'Serial number')'\" -ForegroundColor Green } if ($method -eq 'csv') { $groupTag = $autopilotDevice.'group Tag' if (!$groupTag) { Write-Host 'No Autopilot Device Group Tag found in csv' -ForegroundColor Cyan $groupTag = Read-Host \"Please enter the group tag for device with serial $($autopilotDevice.'serial Number') now:\" } } try { Set-AutopilotDevice -id $id -groupTag $groupTag Write-Host \"Group tag: '$groupTag' set for device with serial $($autopilotDevice.'Serial number')\" -ForegroundColor Green } catch { Write-Host \"Group tag: '$groupTag' not set for device with serial $($autopilotDevice.'Serial number')\" -ForegroundColor Red } } ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:4:2","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#the-logic"},{"categories":["intune"],"content":" 5 FireSo bring it all together into a mega-script we now have a way to update the Autopilot Group Tags. So let‚Äôs give it a go. Info There is no -whatif command, so I‚Äôd start with the CSV of a couple of test devices. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:5:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#fire"},{"categories":["intune"],"content":" 5.1 Sniper TimeRunning the script with the CSV option: PowerShell .\\Set-AutopilotGroupTag.ps1 -tenantId 'bb690aa6-53c6-4d51-affe-ab80c6d710de' -method csv We first have to Authenticate, we‚Äôre using Device Authentication so following the instructions in the script: Authentication prompt to Graph. Now we need to provide the path to the CSV file: txt Please provide the path to the CSV file containing a list of device serial numbers and new Group Tag e.g. C:\\temp\\devices.csv: Now the script will run and update all the devices in the CSV file with their corresponding Group Tags: The PowerShell script output after assigning Group Tags. And if we check in Intune: The updated Group Tags on Autopilot devices in Microsoft Intune. Which amazingly, the Group Tag matches the data in the CSV file we created earlier. Too early to call this a win outright, but we‚Äôre on the way. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:5:1","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#sniper-time"},{"categories":["intune"],"content":" 5.2 Shotgun ApproachWe need to now clear up the remaining devices without Group Tags, this one we can‚Äôt really test, unless you fancy improving the script. Similar setup to the CSV run, but this time the arguments look like the below: PowerShell .\\Set-AutopilotGroupTag.ps1 -tenantId 'bb690aa6-53c6-4d51-affe-ab80c6d710de' -Method Online We‚Äôre already authenticated, so we can skip that bit, and we‚Äôre not using the CSV option so it will get straight to the good stuff, where you will be prompted to set the default group tag: txt Please enter the default group tag for devices without a tag: Entra Then the script will go and update Autopilot devices missing the group tag: The PowerShell script output after assigning Group Tags. And if we check in Intune: The updated Group Tags on Autopilot devices in Microsoft Intune. This Group Tag matches the prompted tag we set when running the script. I‚Äôd call this one a win. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:5:2","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#shotgun-approach"},{"categories":["intune"],"content":" 6 SummaryThere might be easier ways of doing this, or a little less caffeine fuelled at least, but if you want to bulk set Group Tags to your existing Autopilot devices, this does seem like a half decent approach. For new devices, I recommend that you work with your supplier/OEM and get them to tag them as part of the on-boarding. Also, you can run this many times, so if you do want to re-tag devices, you can use the CSV method to do so. Also also, you should look at this post about using dynamic groups to ring fence your newly tagged devices. ","date":"19 June 2022","objectID":"/posts/windows-autopilot-retrofitting-group-tags/:6:0","series":null,"tags":["windows","windows autopilot","device enrolment","graph","powershell","automation"],"title":"Retrofitting Windows Autopilot Group Tags","uri":"/posts/windows-autopilot-retrofitting-group-tags/#summary"},{"categories":["intune","entra id"],"content":"Comparing Entra ID Dynamic Groups with Microsoft Intune Device Filters.","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/"},{"categories":["intune","entra id"],"content":"Now if you‚Äôve ever spoken to me about Microsoft Intune and using Dynamic Groups for management of users and devices, I probably would have talked your ears off about the attribute usage, which attributes are suitable, and that moving away from assigned groups to dynamic is the only way forward for Modern Device Management. What if I told you, that there‚Äôs something on par with these holy grail groups, and maybe, just maybe, even better. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:0:0","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#"},{"categories":["intune","entra id"],"content":" 1 My Beloved Dynamic GroupsBefore we jump into Device Filters, let us talk about Dynamic Groups a little‚Ä¶ Firstly, I would highly recommend the use of these groups, especially for grouping devices, whether this be based on enrolment type, ownership, operating system type or version‚Ä¶and if you‚Äôve got something or someone managing your user attributes, that you use them for user groups. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:1:0","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#my-beloved-dynamic-groups"},{"categories":["intune","entra id"],"content":" 1.1 The LimitationsThis sadly, is how quickly these groups update; Microsoft probably realised that people were using these groups in relation to device management, and also realised that the enumeration of the groups was using precious Compute infrastructure, for free, smh. So Microsoft reduced how often these groups fully updated to once every 24 hours. Now this is no good when we want to target settings and restrictions, or even just application deployment to these dynamically populated groups, we end up with delaying installations, configuration settings or even connectivity. Not a fan. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:1:1","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#the-limitations"},{"categories":["intune","entra id"],"content":" 2 Bring on the FiltersSo where Microsoft take away with one hand, they give with the other, and this is the new world of Device Filters. At a high level, what makes filters so much better for use in Microsoft Intune comes down a couple of things: The filter evaluation is done when the device enrols and/or checks in with the Intune service; this means the speed of evaluation is significantly faster than dynamic groups. Filters are entirely reusable meaning we can now create one filter and use it for many areas within Microsoft Intune. Device Filter evaluation workflow. Before a policy is applied to a device, filters dynamically evaluate applicability: You create a filter for any platform based on some device properties. You assign a policy or app to the group. In the assignment, you add the filter in either include or exclude mode. For example, you ‚Äúinclude‚Äù personal devices, or you ‚Äúexclude‚Äù personal devices from the policy. The filter is evaluated when the device enrols or at any other time a policy evaluates. You see the filter results based on the evaluation. For example, the app or policies applies, or it doesn‚Äôt apply. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:2:0","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#bring-on-the-filters"},{"categories":["intune","entra id"],"content":" 2.1 Inconsistent AssignmentsSo we‚Äôve talked about the limitations with Dynamic Groups, but we do need to talk about the limitations with Device Filters‚Ä¶ Not all areas of Microsoft Intune support the use of Filters (as of today, though this will hopefully change), meaning that you can‚Äôt provide a consistent application method of assignments. For example, Autopilot profiles don‚Äôt support filters, and nor do Endpoint Security Profiles, nor PowerShell scripts, nor MAM policies: Missing Filter assignment options in Microsoft Intune. However, a lot of crucial areas do, including Compliance, Configuration and Windows Update for Business profiles: Filter assignment options in Microsoft Intune. Groups looking good here. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:2:1","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#inconsistent-assignments"},{"categories":["intune","entra id"],"content":" 2.2 Fewer PropertiesDevice Filters have fewer attribute properties to work with compared with Dynamic Groups, so any advanced filtering like with Autopilot Group Tags will still need to be done using Dynamic Groups. Device Filters Device Filter properties in Microsoft Intune. Dynamic Groups Dynamic Security Group properties in Microsoft Entra ID. Win for the Groups. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:2:2","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#fewer-properties"},{"categories":["intune","entra id"],"content":" 2.3 Fewer OperatorsDevice Filters do not support advanced logic with the operators such as ‚ÄòMatch‚Äô, so turbo advanced filtering such as in Intelligent Phased Windows Update for Business Deployments need to be handled with groups still. Device Filters Device Filter operators in Microsoft Intune. Dynamic Groups Dynamic Security Group operators in Microsoft Entra ID. Another win there, 3-0 to the Groups. ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:2:3","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#fewer-operators"},{"categories":["intune","entra id"],"content":" 3 SummaryEven with these Device Filter limitations (and the 3-0 loss), the benefits of reusability and speed in which they are processed still shine through over Dynamic Groups in many areas of Microsoft Intune, and I strongly recommend moving to using the ‚ÄòAll Devices‚Äô and ‚ÄòAll Users‚Äô in-built assignments in conjunction with Device Filters, just to make your life that little bit easier when managing devices. You‚Äôve come this far, so why not give creating them a shot and create a filter or two? ","date":"8 June 2022","objectID":"/posts/endpoint-manager-device-filters/:3:0","series":null,"tags":["administration","dynamic groups","device filters"],"title":"Dynamic Groups vs Device Filters","uri":"/posts/endpoint-manager-device-filters/#summary"},{"categories":["windows"],"content":"Deploying custom Windows languages for Windows Autopilot devices using PowerShell in Microsoft Intune.","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/"},{"categories":["windows"],"content":"Have you ever wondered how to ensure that a number of languages are available for selection to end users on shared Windows 10 devices? The thought hadn‚Äôt crossed my mind, but then again, you encounter new use cases and requirements on a weekly basis. This was one of those occasions, needing a Library Kiosk machine to have a set of languages available to users upon login to the machine. ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:0:0","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#"},{"categories":["windows"],"content":" 1 ConfigurationThere are a number of posts out in the wild on how to fully change the Windows languages on a device by device basis, but in this instance we needed to keep the core language as en-GB but allow end users to select their preferred input language within Windows, and ensure that this language list can be modified in the event of new languages being required. Let‚Äôs crack on shall we‚Ä¶ ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:0","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#configuration"},{"categories":["windows"],"content":" 1.1 Windows User Language ListYou may be familiar with the ‚Äòold‚Äô way of automating the setting user languages in Windows 7, calling control.exe intl.cpl,,/f:\"c:\\Unattend.xml\" and assigning an xml file with the required user languages, luckily with Windows 10 comes the Set-WinUserLanguageList PowerShell command. Microsoft does a great job of detailing how this command is used, so below is the way I‚Äôve created a new list, and appended the required languages using the region tag. This allows for new languages to be added to the script readily. PowerShell # Sets the Windows Languages $LanguageList = New-WinUserLanguageList -Language 'en-GB' $Languages = New-Object -TypeName System.Collections.ArrayList $Languages.AddRange(@( \"en-US\", \"ar-SA\", \"zh-HK\", \"zh-CN\", \"zh-TW\", \"el-GR\", \"he-IL\", \"ja-JP\", \"ko-KR\", \"zh-Hant-TW\", \"jp-JP\", \"am-ET\", \"Cy-az-AZ\", \"Lt-az-AZ\", \"fa-IR\", \"ka-GE\" )) Foreach($Language in $Languages){ $LanguageList.Add($Language) } Try{ Set-WinUserLanguageList -LanguageList $LanguageList -Force } Catch{ Write-Error \"Unable to set the language list $($_.Exception.Message)\" } ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:1","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#windows-user-language-list"},{"categories":["windows"],"content":" 1.2 Task SchedulingThis script allows the creation and installation of a User Language List, containing the required languages needed for each user who accesses the shared device. This seemed all a bit too perfect for this requirement; updatable list of languages, uses native PowerShell commands, can be deployed via Microsoft Intune. That was until I realised this only works correctly under a user context, and I also need it to run each time a user logs on to the machine. So now we need a way to create a Scheduled Task and have it run the PowerShell script, without the end user seeing it run. Luckily, I was using a script to map network drives, generated from here to do something similar, time to not reinvent the wheel and just make use of someone else‚Äôs hard work. Let‚Äôs break down the sections of the script. ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:2","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#task-scheduling"},{"categories":["windows"],"content":" 1.3 Running as SYSTEMFirst off the detecting whether the script is being run under a SYSTEM context; this is important, as when deployed via Microsoft Intune the script will be running under this context, at this time we want the script to create the scheduled task, not run the containing PowerShell, in this instance the addition of user languages. PowerShell function Test-RunningAsSystem { [CmdletBinding()] param() process { return [bool]($(whoami -user) -match \"S-1-5-18\") } } ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:3","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#running-as-system"},{"categories":["windows"],"content":" 1.4 Creating the TaskNow we have determined whether we‚Äôre running as SYSTEM or not, now time to create the Scheduled Task, and to have the script launched, using a dirty vbs file, to hide the PowerShell windows. PowerShell if (Test-RunningAsSystem) { Start-Transcript -Path $(Join-Path -Path $env:temp -ChildPath \"WindowsLanguages-ST.log\") Write-Output \"Running as System --\u003e creating scheduled task which will run on user logon\" # Get the current script path and content and save it to the client $currentScript = Get-Content -Path $($PSCommandPath) $schtaskScript = $currentScript[(0) .. ($currentScript.IndexOf(\"#!SCHTASKCOMESHERE!#\") - 1)] $scriptSavePath = $(Join-Path -Path $env:ProgramData -ChildPath \"Intune-Helper\\Windows-Languages\") if (-not (Test-Path $scriptSavePath)) { New-Item -ItemType Directory -Path $scriptSavePath -Force } $scriptSavePathName = \"Set-WindowsLanguages.ps1\" $scriptPath = $(Join-Path -Path $scriptSavePath -ChildPath $scriptSavePathName) $schtaskScript | Out-File -FilePath $scriptPath -Force # Create dummy vbscript to hide PowerShell Window popping up at logon $vbsDummyScript = \" Dim shell,fso,file Set shell=CreateObject(`\"WScript.Shell`\") Set fso=CreateObject(`\"Scripting.FileSystemObject`\") strPath=WScript.Arguments.Item(0) If fso.FileExists(strPath) Then set file=fso.GetFile(strPath) strCMD=`\"powershell -nologo -executionpolicy ByPass -command `\" \u0026 Chr(34) \u0026 `\"\u0026{`\" \u0026_ file.ShortPath \u0026 `\"}`\" \u0026 Chr(34) shell.Run strCMD,0 End If \" $scriptSavePathName = \"WindowsLanguages-VBSHelper.vbs\" $dummyScriptPath = $(Join-Path -Path $scriptSavePath -ChildPath $scriptSavePathName) $vbsDummyScript | Out-File -FilePath $dummyScriptPath -Force $wscriptPath = Join-Path $env:SystemRoot -ChildPath \"System32\\wscript.exe\" # Register a scheduled task to run for all users and execute the script on logon $schtaskName = \"Intune Helper - Windows Languages\" $schtaskDescription = \"Applies Windows Languages using a PowerShell script.\" $trigger = New-ScheduledTaskTrigger -AtLogOn #Execute task in users context $principal = New-ScheduledTaskPrincipal -GroupId \"S-1-5-32-545\" -Id \"Author\" #call the vbscript helper and pass the PosH script as argument $action = New-ScheduledTaskAction -Execute $wscriptPath -Argument \"`\"$dummyScriptPath`\" `\"$scriptPath`\"\" $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries $null = Register-ScheduledTask -TaskName $schtaskName -Trigger $trigger -Action $action -Principal $principal -Settings $settings -Description $schtaskDescription -Force Start-ScheduledTask -TaskName $schtaskName Stop-Transcript } Now we‚Äôve got the bones of the script, we can put it all together and deploy it using Microsoft Intune. The full script can be found here ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:4","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#creating-the-task"},{"categories":["windows"],"content":" 1.5 DeploymentSave the above script and create a new PowerShell script deployment in Microsoft Intune using the following configuration settings, then deploy to a test group of devices. Platform script in Microsoft Intune. Now we have a way to deploy additional languages to Windows 10 devices, and have the Keyboard inputs available when the user has logged onto the device. The user just needs to select the language from the notification area. Language options on a Windows device. ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:1:5","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#deployment"},{"categories":["windows"],"content":" 2 SummaryPretty straight forward right? Setting the language list, letting ‚ÄòWindows Features on Demand‚Äô just download the required files, plus, you can amend the languages within the script and re-deploy, allowing you to add or remove any required languages for your users without having to deal with Language Packs. ","date":"21 May 2022","objectID":"/posts/windows-autopilot-languages/:2:0","series":null,"tags":["intune","windows autopilot","accessibility","powershell"],"title":"Configuring Available User Languages on Windows Devices","uri":"/posts/windows-autopilot-languages/#summary"},{"categories":["intune"],"content":"Utilising Microsoft Intune Windows Autopilot group tags for dynamic device grouping.","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/"},{"categories":["intune"],"content":"So you‚Äôre using Windows Autopilot in some shape or form to deploy Windows 10/11 devices to your users, and you‚Äôre probably already familiar with the Autopilot dynamic group queries used for targetting these devices, right? Good. So what if you have multiple deployment profiles, or different device use cases with the same profile, or different user personas, or test and pilot deployments, or a range of applications, configurations or scripts that you want to separate out to the devices or users of the devices? You probably do‚Ä¶what‚Äôs that you say, you‚Äôre using static groups to manage these? Let me show you the way forward. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:0:0","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#"},{"categories":["intune"],"content":" 1 ConfigurationIf you‚Äôve got this far, you‚Äôll probably know that Windows Autopilot is the modern deployment method for Windows 10/11 devices, allowing an organisation to pre-register corporate-owned devices (using their unique hardware hashes) and link these devices to the Azure AD tenant. Once the device is attached to the tenant, it is considered a trusted device that can be enrolled using Autopilot. Below is an overview of the Windows Autopilot process, the bit we‚Äôre talking about is the Hardware Vendor adding the Device IDs; this is where the Vendor can also add Group Tags. Autopilot Group Tag Assignment process. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:0","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#configuration"},{"categories":["intune"],"content":" 1.1 Group TagsA hidden gem with Autopilot service, is the Group Tag attribute for Autopilot devices, this tag can be provided during the pre-registration by a supplier or OEM, and can be configured or updated after the device has been imported. This attribute is attached the computer object that exists in Azure AD, sadly not labelled as ‚ÄúGroup Tag‚Äù, but as ‚ÄúOrderID‚Äù (this will be important later). As this attribute exists, we can utilise it with Dynamic Device groups‚Ä¶do you see where this is going? ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:1","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#group-tags"},{"categories":["intune"],"content":" 1.2 Naming ConventionsNow he have this little beaut of a trick, we can start to look at how we use the Group Tag attribute to our advantage, and address some of the potential use cases for grouping Autopilot devices, whether this be based on deployment type, application assignment or just for overall better management of devices. I‚Äôm a big fan of having things named in a readable way, it just makes life a bit more straight forward in Microsoft Intune, and Group Tags are no different. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:2","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#naming-conventions"},{"categories":["intune"],"content":" 1.3 SyntaxYour convention may differ from the below, as it will be entirely based on your own requirements, however I‚Äôll give you a syntax starter for ten so you have an understanding of your options. Position Value Description 1-2 AJ / HJ The Azure AD Join type - Azure AD or Hybrid Joined 3-4 LT / DT / VM The Device Type - Laptop, Desktop or Virtual Machine 5 U / S / K The Device Use Case - User Assigned, Shared or Kiosk 6-8 STD / ADM The User Type - Standard or Admin 9-11 FIN / HR / PAY The Users Department - Finance, HR or, Payroll etc. 12-13 UK / US / FR The Device Location - United Kingdom, United States, France etc. With this basic syntax in place, we can build out the Group Tag for devices: Group Tag Description AJ-LT-U-STD-PAY-US Azure AD Joined Laptop, assigned to a User, with no Admin rights, in Payroll in the United States HJ-DT-S-ADM-FIN-UK Hybrid Azure AD Joined Desktop, configured as a Shared Device, with Admin rights, in Finance in the United Kingdom ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:3","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#syntax"},{"categories":["intune"],"content":" 1.4 Dynamic GroupsNow that we have sorted out the syntax and conventions, it‚Äôs now time to create some dynamic groups in Azure AD. We‚Äôre not only going to create specific groups that equal the Group Tag, but groups that match the Group Tag. This allows assignment of Deployment Profiles, Configuration Profiles and Applications to all device types in a dynamic way, alleviating the need to manually manage groups. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:4","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#dynamic-groups"},{"categories":["intune"],"content":" 1.5 Example GroupsThe below dynamic query would contain all Azure AD Joined Autopilot Laptops: PowerShell (device.devicePhysicalIds -any _ ‚ÄìstartsWith \"[OrderID]:AJ-LT\") This one contains all the Autopilot Desktops in Finance, whether Hybrid Joined or Azure AD Joined: PowerShell (device.devicePhysicalIds -any (_ -match \"^\\[OrderID\\]:.*DT.*FIN.*\")) This this one with all Laptops in France: PowerShell (device.devicePhysicalIds -any (_ -match \"^\\[OrderID\\]:.*LT.*FR$\")) And this this one with all Azure AD joined Laptops with Admin users in Payroll in all countries: PowerShell (device.devicePhysicalIds -any (_ -match \"^\\[OrderID\\]:AJ-LT.*ADM-PAY.*\")) You get the picture‚Ä¶the possibilities for both the syntax and the dynamic groups using Regex are pretty much endless, and should be tailored to how you manage devices in Microsoft Intune. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:5","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#example-groups"},{"categories":["intune"],"content":" 1.6 ApplicationWith the creation of these groups, you can now assign, well, pretty much anything in Microsoft Intune, to them. Lets say you want all Laptops to have a BitLocker Endpoint Protection profile, but not Desktops‚Ä¶you can do this. What about assigning an application to all HR devices that are Hybrid Joined, yup, you can do that too. If you‚Äôre really all up in there with Microsoft Intune, you‚Äôre probably using Role Based Access Control (RBAC), these groups also allow for segregated management of devices based on location, department, join type etc. for specific User Roles or permission such as Remote Wipe or Application Deployment‚Ä¶I know, exciting. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:1:6","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#application"},{"categories":["intune"],"content":" 2 SummaryWhat we have here, is a relatively painless way of tagging devices in any way you want to, kind of like creating a classic Organisational Structure but way more interesting and with the ability to do so without being constrained to a flat structure. The next step is to clearly define your naming convention and syntax for the Group Tags, and have fun I guess. Now if you‚Äôre asking how to tag these devices on mass, without having to manually do so, well that‚Äôs another post. ","date":"28 April 2022","objectID":"/posts/autopilot-power-of-group-tags/:2:0","series":null,"tags":["windows","windows autopilot","device enrolment"],"title":"The Hidden Power of Windows Autopilot Group Tags","uri":"/posts/autopilot-power-of-group-tags/#summary"},{"categories":["macos"],"content":"Applying National Cyber Security Centre (NCSC) settings for macOS devices in Microsoft Intune.","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/"},{"categories":["macos"],"content":"If you‚Äôve ever had to implement baseline security settings, whether this be Centre for Internet Security (CIS), Cyber Security Essentials (CSE), or National Cyber Security Centre (NCSC), you‚Äôll probably have encountered some level of pain when it comes to non-Microsoft devices, as the guidance, is, well, complicated. NCSC do provide documented guides for macOS along with a GitHub repo containing a script and a list of recommended security settings, but what do these look like in Microsoft Intune? And what if you need to make changes? What about if you have exceptions? ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:0:0","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#"},{"categories":["macos"],"content":" 1 Custom Configuration TemplateI‚Äôm not going to detail all of these NCSC settings in this post, otherwise I‚Äôll do myself out of a job, but I can help with the security settings don‚Äôt exist natively within the macOS Device Restriction template. All the below security settings utilise the Custom configuration template for macOS‚Ä¶straight from the horses mouth: ‚ÄúThe custom configuration template allows IT admins to assign settings that aren‚Äôt built into Intune yet. For macOS devices, you can import a .mobileconfig file that you created using Profile Manager or a different tool.‚Äù Sounds perfect right? Details on how to create these profiles are below, but for now, let‚Äôs look at the NCSC settings and their associated mobileconfig files. ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:0","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#custom-configuration-template"},{"categories":["macos"],"content":" 1.1 Automatic UpdatesNow the NCSC guidelines advise that Operating System and Software updates should be applied automatically, with no deferral of when they are available or installed. From the NCSC documentation: Setting Value Comments Defer macOS Updates No n/a Defer app Updates No n/a This one is pretty definite in what it wants. Sadly, there isn‚Äôt an option in Microsoft Intune to enforce this setting, but we can achieve this using a custom profile and generated mobileconfig file. deferUpdates.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e3C307E14-8CDD-4EB8-A696-AC967397CE40\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e0250B0DD-84C3-4DA4-91B3-6FA7824F54CD\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Automatic Software Update Settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eConfigures the macOS software update settings to enable all automatic update options.\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eA1936EA9-62CC-407B-94B0-1AD14BD513BE\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.apple.SoftwareUpdate\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003ecom.apple.SoftwareUpdate.A1936EA9-62CC-407B-94B0-1AD14BD513BE\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Automatic Software Update Settings\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eConfigures the macOS software update settings to enable all automatic update options.\u003cstring/\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eConfigDataInstall\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eCriticalUpdateInstall\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eAutomaticCheckEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003erestrict-software-update-require-admin-to-install\u003c/key\u003e \u003cfalse/\u003e \u003ckey\u003eAutomaticDownload\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eAutomaticallyInstallAppUpdates\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eAutomaticallyInstallMacOSUpdates\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eCatalogURL\u003c/key\u003e \u003c/string\u003e \u003ckey\u003eAllowPreReleaseInstallation\u003c/key\u003e \u003ctrue/\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:1","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#automatic-updates"},{"categories":["macos"],"content":" 1.2 Fast User Switching and Automatic LogonApparently Fast User Switching is a bad thing, as is automatically logging in, so they want this disabled too. From the NCSC documentation: Setting Value Comments Enable Fast User Switching No n/a Disable automatic login Yes n/a I wish they would stick with either ‚ÄòEnable‚Äô or ‚ÄòDisable‚Äô, the mixture is headache inducing. However, mobileconfig file to the rescue. logonSettings.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003cdict\u003e \u003ckey\u003ecom.apple.loginwindow\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eForced\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003emcx_preference_settings\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eDisableFDEAutoLogin\u003c/key\u003e \u003ctrue/\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/dict\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003e\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Disable Fast User Switching and Autologon\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e7243A790-723E-4433-ABA4-629C1A99264C\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.apple.ManagedClient.preferences\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e7243A790-723E-4433-ABA4-629C1A99264C\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/array\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003e\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Disable Fast User Switching and Autologon\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003eAF624C73-095F-4C69-89FB-A0A771D1225E\u003c/string\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eAF624C73-095F-4C69-89FB-A0A771D1225E\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:2","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#fast-user-switching-and-automatic-logon"},{"categories":["macos"],"content":" 1.3 Hiding System PreferencesThis one makes more sense, as you don‚Äôt want users meddling with certain System Preferences such as, iCloud, Sharing, Startup Disk and Security. From the NCSC documentation: Setting Value Comments Restrict items in System Preferences Yes (disable selected items) iCloud Profiles Security \u0026 Privacy Startup Disk Sharing (enables remote management) Siri Xsan - If not in use FibreChannel - if not in use Now you could flat out disable them, but remember, NCSC is a guideline, so we‚Äôre just going to hide them instead‚Ä¶ hideSystemPrefs.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.apple.systempreferences\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003ecom.apple.systempreferences.12D5D87D-F18F-4807-84A8-1E77FBF0EA4B\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e12D5D87D-F18F-4807-84A8-1E77FBF0EA4B\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003ecom.apple.systempreferences\u003c/string\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eNCSC Hide System Preferences;iCloud, Security, Startup Disk and Sharing\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003eHiddenPreferencePanes\u003c/key\u003e \u003carray\u003e \u003cstring\u003ecom.apple.preferences.icloud\u003c/string\u003e \u003cstring\u003ecom.apple.preference.security\u003c/string\u003e \u003cstring\u003ecom.apple.preference.startupdisk\u003c/string\u003e \u003cstring\u003ecom.apple.preferences.sharing\u003c/string\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/array\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eNCSC Hide System Preferences;iCloud, Security, Startup Disk and Sharing\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Hide System Preferences\u003c/string\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003ecom.apple.systempreferences\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eBE218051-ED0B-4555-ADFB-86AA3072BB35\u003c/string\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eUser\u003c/string\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:3","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#hiding-system-preferences"},{"categories":["macos"],"content":" 1.4 Time ServersNot so sure on this one, must be down to ensuring that the system time is correct for validation of certificates‚Ä¶maybe. From the NCSC documentation: Setting Value Comments Time Server Specify time server by device location Organisations should refer to their MDM documentation for instructions on setting this up See what I mean about it being complicated, thanks NCSC. Anyway, here‚Äôs the mobileconfig file setting the time servers to be time.euro.apple.com if you‚Äôre in Europe obviously. timeServers.mobileconfig \u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e \u003c!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"\u003e \u003cplist version=\"1.0\"\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003ePayloadContent\u003c/key\u003e \u003cdict\u003e \u003ckey\u003ecom.apple.MCX\u003c/key\u003e \u003cdict\u003e \u003ckey\u003eForced\u003c/key\u003e \u003carray\u003e \u003cdict\u003e \u003ckey\u003emcx_preference_settings\u003c/key\u003e \u003cdict\u003e \u003ckey\u003etimeServer\u003c/key\u003e \u003cstring\u003etime.euro.apple.com\u003c/string\u003e \u003c/dict\u003e \u003c/dict\u003e \u003c/array\u003e \u003c/dict\u003e \u003c/dict\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eConfigures Time Servers\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Automatic Time Servers\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003e4B63BB1E-0D4D-4DD2-BF93-4AAB46523179\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003ecom.apple.ManagedClient.preferences\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003e4B63BB1E-0D4D-4DD2-BF93-4AAB46523179\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/array\u003e \u003ckey\u003ePayloadDescription\u003c/key\u003e \u003cstring\u003eConfigures Time Servers\u003c/string\u003e \u003ckey\u003ePayloadDisplayName\u003c/key\u003e \u003cstring\u003eNCSC Automatic Time Servers\u003c/string\u003e \u003ckey\u003ePayloadEnabled\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadIdentifier\u003c/key\u003e \u003cstring\u003eEE4E0945-5074-4EF1-A375-2B9688644D8F\u003c/string\u003e \u003ckey\u003ePayloadOrganization\u003c/key\u003e \u003cstring\u003eennbee.uk\u003c/string\u003e \u003ckey\u003ePayloadRemovalDisallowed\u003c/key\u003e \u003ctrue/\u003e \u003ckey\u003ePayloadScope\u003c/key\u003e \u003cstring\u003eSystem\u003c/string\u003e \u003ckey\u003ePayloadType\u003c/key\u003e \u003cstring\u003eConfiguration\u003c/string\u003e \u003ckey\u003ePayloadUUID\u003c/key\u003e \u003cstring\u003eEE4E0945-5074-4EF1-A375-2B9688644D8F\u003c/string\u003e \u003ckey\u003ePayloadVersion\u003c/key\u003e \u003cinteger\u003e1\u003c/integer\u003e \u003c/dict\u003e \u003c/plist\u003e ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:4","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#time-servers"},{"categories":["macos"],"content":" 1.5 Creating Custom Configuration ProfilesNow that we have the required mobileconfig files, and that you‚Äôve saved them with that file extension (it‚Äôs basically glorified XML to be honest), we can look at creating these Custom Configuration Profiles: Browse to the macOS Configuration page and select Create profile: macOS Configuration profiles in Microsoft Intune. Under Profile type select Templates, then select Custom and then select Create: macOS Configuration profile templates in Microsoft Intune. Give the Custom profile a suitable name and select Next: macOS Configuration custom profile naming in Microsoft Intune. Give the Custom configuration profile name a suitable name, ensure the Deployment channel is ‚ÄòDevice channel‚Äô and upload the mobileconfig file: macOS Configuration custom profile in Microsoft Intune. Select Next and assign the profile to the required Device Group. Repeat for all the mobileconfig files created. ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:1:5","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#creating-custom-configuration-profiles"},{"categories":["macos"],"content":" 2 SummaryThis was a bit of a whirlwind tour of Custom Configuration Profiles for macOS, and there is a huge amount that can be controlled, managed, and dictated using them. If you have a macOS device, you can use Apple Configuration 2 to create these files, if you don‚Äôt, then have fun with the Apple Developer Device Management Guide, like I did‚Ä¶ ","date":"21 April 2022","objectID":"/posts/macos-ncsc-settings/:2:0","series":null,"tags":["intune","security","ncsc","custom profiles","configuration","Endpoint Security"],"title":"macOS National Cyber Security Centre Security Settings in Intune","uri":"/posts/macos-ncsc-settings/#summary"},{"categories":["windows"],"content":"Renaming Windows Autopilot Hybrid Join devices based on device serial number using Microsoft Intune.","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/"},{"categories":["windows"],"content":"You‚Äôve probably hit the limitation with Windows Autopilot Hybrid Azure AD Join deployments and the device name templates being less than flexible, restricting to only a prefix and, well, that‚Äôs it. You‚Äôve also probably been asked whether you can configure the device name to match an asset tag or another unique bit of information, well this script, adapted from an existing one by Michael Niehaus can help. ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:0:0","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#"},{"categories":["windows"],"content":" 1 ConfigurationThe below sections detail the steps carried out to modify the script to work without the need for an Azure web application, and can be deployed locally to rename devices. ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:1:0","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#configuration"},{"categories":["windows"],"content":" 1.1 Adding the VariablesThe post linked above details the steps required to ensure that the computer object itself has the ability to initiate the rename, and the below script has been changed to use existing device information, such as serial, instead of a web service: On-premises domain variable Computer name prefix variable Wait time before restart This means that it can be deployed to existing environments without the need to deploy, or pay for, an Azure Web App. The first section details the parameters that can used and updated. powershell #Sets the variables for the customer $domain = \"onprem.local\" #local domain $ComputerPrefix = \"PRE-\" #Prefix $waittime = \"60\" #sets the restart wait time in minutes ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:1:1","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#adding-the-variables"},{"categories":["windows"],"content":" 1.2 Getting the Device NameThis next section pulls back the serial number and ensures that the computer name is less than 15 characters. powershell #Get serial and removes commas $Serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber $newName = $ComputerPrefix + $Serial $newName = $newName.Replace(\" \",\"\") #Removes spaces #shortens name if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:1:2","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#getting-the-device-name"},{"categories":["windows"],"content":" 1.3 The Waiting GameUsing New-TimeSpan we can convert the $waittime variable into whatever time format we need, and as we‚Äôre using the shutdown command, we need seconds: powershell $waitinseconds = (New-TimeSpan -Minutes $waittime).Seconds Write-Host \"Initiating a restart in $waitime minutes\" \u0026 shutdown.exe /g /t $waitinseconds /f /c \"Restarting the computer in $wait minutes due to a computer name change. Please save your work.\" ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:1:3","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#the-waiting-game"},{"categories":["windows"],"content":" 1.4 The Whole ThingThe full script can be found here, I would strongly advise testing this prior to pushing it out via Microsoft Intune. ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:1:4","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#the-whole-thing"},{"categories":["windows"],"content":" 2 DeploymentSave the above script and create a new PowerShell script deployment in Microsoft Intune using the following configuration settings, then deploy to a test group of devices: Platform script in Microsoft Intune. Bingo! another battle won. ","date":"20 March 2022","objectID":"/posts/hybrid-join-computer-rename/:2:0","series":null,"tags":["windows autopilot","hybrid join","powershell"],"title":"Renaming Windows Autopilot Hybrid Joined Devices","uri":"/posts/hybrid-join-computer-rename/#deployment"},{"categories":null,"content":"Odds\u0026Endpoints Information","date":"1 January 0001","objectID":"/information/","series":null,"tags":null,"title":"Information","uri":"/information/"},{"categories":null,"content":" 1 DisclaimerThe views expressed anywhere on this site are strictly mine and not the opinions and views of my employer or any vendor mentioned. All information is provided ‚Äúas is‚Äù with no warranties, and should be tested prior to any implementation, and I hold no liability for the outcome of the information, scripts, or other content provided on this site. ","date":"1 January 0001","objectID":"/information/:1:0","series":null,"tags":null,"title":"Information","uri":"/information/#disclaimer"},{"categories":null,"content":" 2 PrivacyThis site collects usage data using Google Analytics 4 using cookies, giving us insight into the number of people that visit our website. All data is anonymised and we do not sell nor share any data with third parties. A cookie is a small file, typically of letters and numbers, downloaded on to a device when the user accesses our website. A cookie is stored on your hard drive. ","date":"1 January 0001","objectID":"/information/:2:0","series":null,"tags":null,"title":"Information","uri":"/information/#privacy"},{"categories":null,"content":" 2.1 About CookiesA cookie is a small file of letters and numbers that we store on your browser or the hard drive of your computer if you agree. Cookies contain information that is transferred to your computer‚Äôs hard drive. Our website uses cookies to distinguish you from other users of our website. This helps us to provide you with a good experience when you browse our website and allows us to improve our website. By continuing to browse the website, you are agreeing to our use of cookies. We may use the following cookies: Analytical/performance cookies. They allow us to recognise and count the number of visitors and to see how visitors move around our website when they are using it. This helps us to improve the way our website works, for example, by ensuring that users are finding what they are looking for easily. ","date":"1 January 0001","objectID":"/information/:2:1","series":null,"tags":null,"title":"Information","uri":"/information/#about-cookies"},{"categories":null,"content":" 2.2 Analytics ProvidersPlease note that we use Google Analytics, which places cookies on your computer, to help the website analyse how visitors use the website. The information generated by the cookie about your use of the website (including a randomisation of your IP address) will be transmitted to and stored by Google for the purpose of evaluating your use of the website, compiling reports on website activity for website operators and providing to us other services relating to website activity and internet usage. You can prevent Google‚Äôs collection and use of data by downloading and installing the browser plug-in available under google.com/dlpage/gaoptout. Please visit google.com/intl/en/policies/privacy/ for further information on how Google uses your data. ","date":"1 January 0001","objectID":"/information/:2:2","series":null,"tags":null,"title":"Information","uri":"/information/#analytics-providers"},{"categories":null,"content":" 2.3 Rejecting CookiesYou block cookies by activating the setting on your browser that allows you to refuse the setting of all or some cookies or by choosing to deny Cookies when prompted, then no information will be collected whatsoever. ","date":"1 January 0001","objectID":"/information/:2:3","series":null,"tags":null,"title":"Information","uri":"/information/#rejecting-cookies"},{"categories":null,"content":" 3 Authors","date":"1 January 0001","objectID":"/information/:3:0","series":null,"tags":null,"title":"Information","uri":"/information/#authors"},{"categories":null,"content":" 3.1 Nick BentonI‚Äôm Nick Benton, an end-user computing specialist with over a decade of experience in consulting, architecture, design, and implementation of modern device management, and enterprise mobility solutions. I currently have the role of Principal Cloud Endpoint Consultant at Phoenix Software Ltd who were the Global Microsoft Partner of the Year for Modern Endpoint Management 2023, where my main focus is assisting customers in their road to a modern workplace cloud first approach, using Microsoft Intune, with a focus on migration, security and zero touch deployments. I use this website as a platform to share content with the community, based on solutions I find, to problems encountered in real world scenarios. ","date":"1 January 0001","objectID":"/information/:3:1","series":null,"tags":null,"title":"Information","uri":"/information/#nick-benton"},{"categories":null,"content":" 3.2 Jonathan FallisI currently work as a Technical Consultant in the Cloud Endpoint practice at Phoenix Software Ltd (who, in recognition for outstanding achievements, have been awarded Microsoft Partner of the Year for 2023), specialising in the deployment and management of Microsoft Intune, a pivotal tool for modern device management and application deployment. Beyond working with Microsoft Intune, I am passionate about PowerBI Reporting and PowerShell scripting. This interest extends beyond professional obligation, reflecting a genuine enthusiasm for the products and trying to apply them to everyday life. Whether supporting clients on their cloud journey, harnessing PowerBI for insightful data reporting or crafting PowerShell scripts to automate complex tasks day-to-day, I‚Äôm normally geeking out somewhere. Outside of tech, I am a father, motorcyclist, petrol head and a big football \u0026 music fan. ","date":"1 January 0001","objectID":"/information/:3:2","series":null,"tags":null,"title":"Information","uri":"/information/#jonathan-fallis"}]