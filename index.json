
[{"content":"","date":"8 October 2024","externalUrl":null,"permalink":"/","section":"MEM v ENNBEE - Battles with Modern Endpoint Management","summary":"","title":"MEM v ENNBEE - Battles with Modern Endpoint Management","type":"page"},{"content":"","date":"8 October 2024","externalUrl":null,"permalink":"/posts/","section":"Posts","summary":"","title":"Posts","type":"posts"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/android/","section":"Categories","summary":"","title":"Android","type":"categories"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/tags/dynamic-groups/","section":"Tags","summary":"","title":"Dynamic Groups","type":"tags"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/ios/","section":"Categories","summary":"","title":"iOS/iPadOS","type":"categories"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/macos/","section":"Categories","summary":"","title":"macOS","type":"categories"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/intune/","section":"Categories","summary":"","title":"Microsoft Intune","type":"categories"},{"content":"I\u0026rsquo;m an end-user computing specialist with over a decade of experience in consulting, architecture, design, and implementation of modern device management, and enterprise mobility solutions. I currently have the role of Principal Cloud Endpoint Consultant at Phoenix Software Ltd who are the Global Microsoft Partner of the Year for Modern Endpoint Management 2023, where my main focus is assisting customers in their road to a modern workplace cloud first approach, using Microsoft Intune, with a focus on migration, security and zero touch deployments.\nI use this website as a platform to share content with the community, based on solutions I find, to problems encountered in real world scenarios.\n","date":"24 September 2024","externalUrl":null,"permalink":"/authors/ennbee/","section":"Authors","summary":"I\u0026rsquo;m an end-user computing specialist with over a decade of experience in consulting, architecture, design, and implementation of modern device management, and enterprise mobility solutions.","title":"Nick Benton","type":"authors"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/tags/security/","section":"Tags","summary":"","title":"Security","type":"tags"},{"content":"We\u0026rsquo;ve looked at phasing the deployment of Windows Updates in a smart way with Dynamic Security Groups, we\u0026rsquo;ve looked at allowing VIP users to opt out of phased Windows update installation, we\u0026rsquo;ve even looked at how we deliver macOS operating system and software updates just like we do with Windows, what else is there to do now?\nAllowing an end user to choose what day they get their updates? Am I OK? Probably not, but if you\u0026rsquo;re wanting to empower your users to select when they get their updates, this might be an interesting read, especially when I explain how we\u0026rsquo;re going to achieve this.\nWhy Self-Service Updates? # I mean, why not? As much as updates are there to ensure devices are secure, or as secure as they can be when it comes to operating system vulnerabilities, it is the user that is actually impacted by the installation of updates and enforced device restarts. So why not give them some control over when updates are installing. So how are we going to give the users a choice\u0026hellip;\nMicrosoft Company Portal Device Category prompt. Yeah, Device Categories. In for a penny in for a pound when it comes to bad choices eh?\nDevice Categories? # Yes I know what you\u0026rsquo;re thinking, relying on end users to select the correct device category in the Company Portal, and then using that attribute to group devices to apply update settings sounds like a bad idea, but hear me out, please.\nThe Word of the Day is \u0026ldquo;Inaccurate\u0026rdquo; # First before I convince you that this isn\u0026rsquo;t the worst thing in the world, we should see what the some of the issues are with Device Categories in their general use:\nA user will just select whatever device category they want - this leads to inaccurate assignment of device categories. A Windows user might not ever open the Company Portal - this means a category is never selected and grouping or filtering based on categories becomes inaccurate. An Intune administrator user can rename a category - if dynamic security groups or device filters rely on this category name, then these grouping become inaccurate. Now I\u0026rsquo;m not going to be able to solve all the issues here, especially as there isn\u0026rsquo;t an RBAC setting specifically for Device Categories, but we should be able to deal with a couple of them at least.\nIf you are using Device Categories, I\u0026rsquo;m not coming for you here, but I would be very careful when using them for anything important. Configuring Device Categories # Before you excitedly go and create your new Device Categories, do me a solid and check that your users are actually able to select them from the Company Portal. Go check Tenant Customisation settings in Microsoft Intune, and turn on, if like me you\u0026rsquo;d in anger previously turned off the below option:\nMicrosoft Intune Tenant Customisation. Now that you know how to just turn on or turn off Device Categories, if you\u0026rsquo;re not convinced, turn them off and go find another post to read, otherwise keep reading.\nDays of the Week # If you\u0026rsquo;re still here, and want to see how to let your users choose when they get their updates, we can look at creating the following Device Categories based on the the day of the week:\nDay of Update Device Category Sunday Update my device on a Sunday Monday Update my device on a Monday Tuesday Update my device on a Tuesday Wednesday Update my device on a Wednesday Thursday Update my device on a Thursday Friday Update my device on a Friday Saturday Update my device on a Saturday You can of course name these Device Categories something more suitable to your environment, and limit the days of the week if you\u0026rsquo;d like, just remember that this is an end user selecting a category, so some fancy naming convention won\u0026rsquo;t necessarily make as much sense to them as it does to you.\nWith the Device Categories now in place, we can take on the advice of Microsoft for a change:\nCreate device categories to help organize devices and build dynamic device groups.\nAnd go and create some Dynamic Security Groups in Entra using them.\nDynamic Device Groups # To support the ability for end users to get updates on the day they expect, we\u0026rsquo;re going to go and create some new Dynamic Device Groups in Entra.\nWe can not only use these groups for include assignments for our update policies, but also exclude assignments, ensuring that even if an end user doesn\u0026rsquo;t bother opening the Company Portal, that they\u0026rsquo;ll still get some level of update, just maybe not when they want it.\nDevice Category Groups # These are the obvious ones, as we\u0026rsquo;ve created our Device Categories now, we need corresponding groups in Entra that we can use to capture the devices based on the category selected. Obviously my group rule matches my category names, yours might be different.\nDay of Update Group Name Rule Sunday SG_MDM_Devices_Updates_Sunday (device.deviceCategory -eq \u0026quot;Update my device on a Sunday\u0026quot;) Monday SG_MDM_Devices_Updates_Monday (device.deviceCategory -eq \u0026quot;Update my device on a Monday\u0026quot;) Tuesday SG_MDM_Devices_Updates_Tuesday (device.deviceCategory -eq \u0026quot;Update my device on a Tuesday\u0026quot;) Wednesday SG_MDM_Devices_Updates_Wednesday (device.deviceCategory -eq \u0026quot;Update my device on a Wednesday\u0026quot;) Thursday SG_MDM_Devices_Updates_Thursday (device.deviceCategory -eq \u0026quot;Update my device on a Thursday\u0026quot;) Friday SG_MDM_Devices_Updates_Friday (device.deviceCategory -eq \u0026quot;Update my device on a Friday\u0026quot;) Saturday SG_MDM_Devices_Updates_Saturday (device.deviceCategory -eq \u0026quot;Update my device on a Saturday\u0026quot;) You may have noticed that I\u0026rsquo;m not using any other attributes in these groups, as we\u0026rsquo;re going to use them across all operating system types, and where we can we\u0026rsquo;ll use Device Filters to apply to more granular devices, based on something like device ownership. If you want to be more specific here, and create a set of groups per operating system or per ownership type, go for it, it\u0026rsquo;s your environment after all, just remember that these Device Categories do not care about ownership, operating system, or otherwise.\nSpreading the Update Load # So what if we still want some phasing across supported update policies (it\u0026rsquo;s Windows, only Windows), and you don\u0026rsquo;t want all the users who selected the Update my device on a Thursday Device Category to get the update on the same Thursday?\nWell with a couple of additional Dynamic Security Groups, we can have two update policies for the same day but a week apart, splitting devices roughly in half.\nScope Group Name Rule Initial Production SG_MDM_Devices_Updates_A (device.deviceManagementAppId -ne null) and ((device.deviceId -startsWith \u0026quot;1\u0026quot;) or (device.deviceId -startsWith \u0026quot;3\u0026quot;) or (device.deviceId -startsWith \u0026quot;5\u0026quot;) or (device.deviceId -startsWith \u0026quot;7\u0026quot;) or (device.deviceId -startsWith \u0026quot;9\u0026quot;) or (device.deviceId -startsWith \u0026quot;a\u0026quot;) or (device.deviceId -startsWith \u0026quot;c\u0026quot;) or (device.deviceId -startsWith \u0026quot;e\u0026quot;)) Final Production SG_MDM_Devices_Updates_B (device.deviceManagementAppId -ne null) and ((device.deviceId -startsWith \u0026quot;0\u0026quot;) or (device.deviceId -startsWith \u0026quot;2\u0026quot;) or (device.deviceId -startsWith \u0026quot;4\u0026quot;) or (device.deviceId -startsWith \u0026quot;6\u0026quot;) or (device.deviceId -startsWith \u0026quot;8\u0026quot;) or (device.deviceId -startsWith \u0026quot;b\u0026quot;) or (device.deviceId -startsWith \u0026quot;d\u0026quot;) or (device.deviceId -startsWith \u0026quot;f\u0026quot;)) We\u0026rsquo;ve seen these types of groups before so they shouldn\u0026rsquo;t be too much of a surprise to you, but in short, we\u0026rsquo;re splitting all the devices into ~50% groups using the UUID associated with each deviceId object in Entra.\nWe can then use these groups when creating our Windows Update rings for our weekday specific updates.\nSoftware Update Profiles # In the case where we get users who do not select a Device Category for whatever reason, we can build out update profiles in our usual way, whether this be a phased approach or otherwise, but we need to ensure that these policies only apply to devices without a selected update day.\nTo achieve this, we can just exclude our created Device Category dynamic security groups from our existing update policies.\nmacOS Update Policy Exclusions. So for any existing update profiles, make sure you are excluding, in this instance, the seven created groups, allowing devices to get updates regardless of whether a user has bothered to open the Company Portal or not.\nNow on to the weekday specific policies.\nWindows Update Rings # This one requires a little more brain power than the other update policies, all to cope with the idea that you want to split devices across differing weeks, but on the same days.\nAs maths isn\u0026rsquo;t my strong point, we\u0026rsquo;re going to leverage the option to install updates at a scheduled time; this has it\u0026rsquo;s downsides relating to whether a device is actually active during that time of day, but is easier to work out than using deferral and deadline settings that I\u0026rsquo;ve covered previously.\nWith the idea we need to create two update rings for each day to help spread the load, we can create one for Thursday on the first week of the month:\nWindows Update Ring for updates on a Thursday. Assigning this to the Thursday based Dynamic Security Group, but excluding one of our Production groups we created to split devices across update rings.\nCreating a second Update Ring for Thursday, but amending the week of the month and the assignment using the second week:\nWindows Update Ring for updates on a Thursday. Keeping the same include assignment, but amending the exclude assignment to the other Production group.\nNow you\u0026rsquo;ve got your head around that, go create 14 update rings üòÖ with the below settings:\nQuality update deferral period (days) - 0 days Automatic update behaviour - Auto install and restart at a scheduled time Deadline for quality updates - 0 days Automatic behaviour frequency: Day of Update Week Include Assignment Exclude Assignment Sunday Second week of the month SG_MDM_Devices_Updates_Sunday SG_MDM_Devices_Updates_B Sunday Third week of the month SG_MDM_Devices_Updates_Sunday SG_MDM_Devices_Updates_A Monday Second week of the month SG_MDM_Devices_Updates_Monday SG_MDM_Devices_Updates_B Monday Third week of the month SG_MDM_Devices_Updates_Monday SG_MDM_Devices_Updates_A Tuesday Second week of the month SG_MDM_Devices_Updates_Tuesday SG_MDM_Devices_Updates_B Tuesday Third week of the month SG_MDM_Devices_Updates_Tuesday SG_MDM_Devices_Updates_A Wednesday Second week of the month SG_MDM_Devices_Updates_Wednesday SG_MDM_Devices_Updates_B Wednesday Third week of the month SG_MDM_Devices_Updates_Wednesday SG_MDM_Devices_Updates_A Thursday Second week of the month SG_MDM_Devices_Updates_Thursday SG_MDM_Devices_Updates_B Thursday Third week of the month SG_MDM_Devices_Updates_Thursday SG_MDM_Devices_Updates_A Friday Second week of the month SG_MDM_Devices_Updates_Friday SG_MDM_Devices_Updates_B Friday Third week of the month SG_MDM_Devices_Updates_Friday SG_MDM_Devices_Updates_A Saturday Second week of the month SG_MDM_Devices_Updates_Saturday SG_MDM_Devices_Updates_B Saturday Third week of the month SG_MDM_Devices_Updates_Saturday SG_MDM_Devices_Updates_A Your mileage may vary with which week of the month you\u0026rsquo;re choosing (remembering that the days in the second week might not be after Patch Tuesday), and if you really want to spread things out across the whole month, you can create smaller Production groups and four update rings per day.\niOS/iPadOS Update Policies # On to the easier ones, and for whatever reason, ones that we don\u0026rsquo;t consider to warrant any kind of phasing. So go and create some iOS/iPadOS Update Policies and configure each update policy with the below default settings, making changes only to the Time Window configuration for each day of the week:\nUpdate to install - Install iOS/iPadOS Latest update Schedule type - Update during scheduled time Time zone - UTC¬±00 (select your own time zone) Time window: Day of Update Time Window Assignment Sunday Sunday 12AM - Monday 12AM SG_MDM_Devices_Updates_Sunday Monday Monday 12AM - Tuesday 12AM SG_MDM_Devices_Updates_Monday Tuesday Tuesday 12AM - Wednesday 12AM SG_MDM_Devices_Updates_Tuesday Wednesday Wednesday 12AM - Thursday 12AM SG_MDM_Devices_Updates_Wednesday Thursday Thursday 12AM - Friday 12AM SG_MDM_Devices_Updates_Thursday Friday Friday 12AM - Saturday 12AM SG_MDM_Devices_Updates_Friday Saturday Saturday 12AM - Sunday 12AM SG_MDM_Devices_Updates_Saturday You can see an example of how this has been configured below for delivering updates on a Monday:\niOS Update Policy for updates on a Monday. You could, and I mean could, use the same logic behind the Windows update phasing, and split each day into twelve-hour sections, or more if you really hate yourself, and use the Production groups to split the delivery of updates in the morning and afternoon on the same day.\nBut you know, iOS updates don\u0026rsquo;t break devices ü§®.\nmacOS Update Policies # We\u0026rsquo;re almost there, so time for the macOS Update Policies, we\u0026rsquo;re sticking with this profile for now as gives us the behaviour we want, not one of the other options for software updates , configuring each with the default settings below:\nCritical updates - Install immediately Firmware updates - Install immediately Configuration file updates - Install immediately All other updates (OS, built-in apps) - Install immediately Schedule type - Update during scheduled time Time zone - UTC¬±00 (select your own time zone) Time window: Day of Update Time Window Assignment Sunday Sunday 12AM - Monday 12AM SG_MDM_Devices_Updates_Sunday Monday Monday 12AM - Tuesday 12AM SG_MDM_Devices_Updates_Monday Tuesday Tuesday 12AM - Wednesday 12AM SG_MDM_Devices_Updates_Tuesday Wednesday Wednesday 12AM - Thursday 12AM SG_MDM_Devices_Updates_Wednesday Thursday Thursday 12AM - Friday 12AM SG_MDM_Devices_Updates_Thursday Friday Friday 12AM - Saturday 12AM SG_MDM_Devices_Updates_Friday Saturday Saturday 12AM - Sunday 12AM SG_MDM_Devices_Updates_Saturday macOS Update Policy for updates on a Wednesday. Again, you can split these down to more granular times, but why bother, macOS updates definitely don\u0026rsquo;t break macOS devices ü§ê.\nAndroid Update Policies # Yeah, sorry, not an option for Android Enterprise devices, as there isn\u0026rsquo;t support for specific update install days. Let\u0026rsquo;s just let the user think they have some control over their updates here, a little placebo never hurt anyone.\nAndroid Device Restriction Profile. Just create a new Device Restriction profile and set System update under General to be Automatic, no need to even use the Dynamic Security Groups, just go ahead and assign this to all applicable devices.\nUser Experience # Now that you\u0026rsquo;ve got all your Dynamic Security Groups sorted, each Software Update policy created and assigned, across each of the supported operating systems, all is left to do is wait for users to select a Device Category.\nDevice Categories in the Company Portal on macOS. Really your users can\u0026rsquo;t miss them, and with Android, iOS/iPadOS, and macOS enrolment pretty much forcing you to open the Company Portal, you should get some uptake.\nIf you fancy, you could create a new Device Category for \u0026ldquo;I don\u0026rsquo;t care about updates\u0026rdquo;, and leverage that in either existing Dynamic Security Groups to leave the device in your standard Software Update deployment approaches. Summary # If you\u0026rsquo;ve followed along, (and I assume most people switched off when I suggested using Device Categories), you could have some over arching catch-all update policies that will apply updates when you want them to, across as many phases or stages as you see fit and user selected update policies, allowing the user some control, or the semblance of control in some instances, as to when their device is updated and/or restarted all from the selection of a Device Category.\nEmpowering.\nI\u0026rsquo;m not going to say this is the best approach for update delivery, nor am I suggesting you drop your current software update deployment approach in favour of something entirely user-driven, but I am at least showing you what is possible, with functionality in Microsoft Intune that often gets overlooked, or misused for whatever reason.\n","date":"24 September 2024","externalUrl":null,"permalink":"/posts/updates-self-service-deployment/","section":"Posts","summary":"Fancy letting your end users select what day of the week they get their device updates allowing them to be truly empowered but still ensure a level of device security, sure you do.","title":"Self-Service Software Update Deployments","type":"posts"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/tags/updates/","section":"Tags","summary":"","title":"Software Updates","type":"tags"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"24 September 2024","externalUrl":null,"permalink":"/categories/windows/","section":"Categories","summary":"","title":"Windows 10 and later","type":"categories"},{"content":"","date":"2 September 2024","externalUrl":null,"permalink":"/tags/apps/","section":"Tags","summary":"","title":"Apps","type":"tags"},{"content":"","date":"2 September 2024","externalUrl":null,"permalink":"/tags/co-management/","section":"Tags","summary":"","title":"Co-management","type":"tags"},{"content":"You\u0026rsquo;ve just implemented a Cloud Management Gateway to help your hybrid joined Windows devices communicate to Configuration Manager over the internet, but what if they\u0026rsquo;re orphaned and unable to communicate to Configuration Manager to get the new Client Settings?\nThis one might be little niche if I\u0026rsquo;m honest, but there is a scenario where you\u0026rsquo;ve implemented a Cloud Management Gateway (CMG) as part of your Configuration Manager topology, your hybrid joined Windows devices are co-managed, but they no longer communicate back to the on-premises Configuration Manager Management Point for some reason, and you need to tell these remote devices that they can now use the Cloud Management Gateway.\nThe reason could be that you have a user initiated VPN that no-one actually uses, you\u0026rsquo;re lacking a device tunnel for communication back to on-premises services, or you just have no VPN whatsoever, and these devices have just aged out of Configuration Manager never to be seen again.\nHow on earth are we going to sort these rogue orphaned devices out, and get them back speaking with Configuration Manager and a Cloud Management Gateway?\nClient Communication # Usually after implementing a Cloud Management Gateway, you just wait for your devices to check back in to the Management Point during a location request, and when they\u0026rsquo;re classified as Currently Internet they\u0026rsquo;ll happily communicate with the CMG, as long as they meet the client authentication requirements obviously.\nThis won\u0026rsquo;t work for devices that don\u0026rsquo;t currently talk to Configuration Manager, nor if they\u0026rsquo;ve disappeared from the console and discovery. So how do we deal with this?\nJust Install the Client # Strangely, Microsoft actually recommended just re-installing the ConfigMgr Client on these devices, which isn\u0026rsquo;t a bad shout, so that\u0026rsquo;s at least the start of the process; with the devices hybrid joined and co-managed for at least the Client Apps workload, we can just package up the latest ConfigMgr client from the Primary Site server and punt it to the device estate.\n\u0026ldquo;Oh, but what about using native tooling, isn\u0026rsquo;t there a way to get Microsoft Intune to do this for you?\u0026rdquo;, I hear you cry. Well yes, but also no.\nMicrosoft Entra hybrid joined devices - If the device is targeted with co-management settings policy, in Microsoft Entra hybrid join scenario, the autopilot provisioning times out during ESP phase.\nand\u0026hellip;\nClients that authenticate with PKI certificates. You can\u0026rsquo;t provision the certificate on the device before the Configuration Manager client installs and needs to authenticate to the CMG. Microsoft Entra ID is recommended for client authentication. For more information, see Plan for CMG client authentication: Microsoft Entra ID.\nThe co-management authority setting in Microsoft Intune is great, for your Entra only Autopilot devices, and as covered previously, but just doesn\u0026rsquo;t work for the hybrid joined world, so a Win32 app it is, but what else do we need to consider?\nClient Authentication # Before we even look at packaging up the Configuration Manager client, we need to think about how these now essentially Internet-based devices are going to authenticate and communicate to the Cloud Management Gateway.\nAs these aren\u0026rsquo;t fresh out the box devices, we shouldn\u0026rsquo;t need to treat them as such, so we can discard the need of using a site token as part of the installation, as these devices will already be hybrid joined, or have a device certificate to allow existing authentication.\nWith this we can just look at how we make sure the devices are meeting the client authentication pre-requisites for the following two client authentication methods.\nPKI Authentication # I\u0026rsquo;m going to take a stab in the dark and suggest that these orphaned devices, if using PKI authentication, already have a certificate and the full chain of trust required to allow for PKI authentication, but we should be sure of this and not just assume.\nSo as part of our soon to be packaged Win32 app, we need to utilise a PowerShell script to check that a certificate from your Internal Certification Authority exists with the correct extensions, and it\u0026rsquo;s valid using App Requirements in Microsoft Intune.\nThrowing together a quick script and updating the $certCA with the distinguished name of your Issuing Certification Authority, we can loop through all certificates issued to the device, making sure that the certificate has come from your internal CA, then check if the date is valid.\n$ready = 0 $certCA = \u0026#39;CN=ennbee-LAB-CA, DC=ennbee, DC=local\u0026#39; #Certificate Authority Name $date = Get-Date #Used for checking valid certificate $certPath = \u0026#39;cert:\\LocalMachine\\My\u0026#39; $certs = Get-ChildItem -Path $certPath foreach ($cert in $certs) { $certThumbPath = $certPath + \u0026#34;\\$($cert.Thumbprint)\u0026#34; if ($cert.Issuer -eq $certCA -and $cert.Extensions.EnhancedKeyUsages.FriendlyName -contains \u0026#39;Client Authentication\u0026#39;) { $certValid = Get-ChildItem -Path $certThumbPath | Select-Object NotAfter, NotBefore if ($date -gt $certValid.NotBefore -and $date -lt $certValid.NotAfter) { $ready++ } } } if ($ready -gt 0) { Write-Output Ready } If the script finds at least one certificate, as really the Configuration Manager client isn\u0026rsquo;t that fussy about which certificate it uses, just that there is one, the script will return a Ready output back to Microsoft Intune, which we can then use as a positive identifier that the app installation can start.\nEntra Authentication # If you decided that you couldn\u0026rsquo;t be bothered with PKI authentication (I mean who can really?), then the other option would have been to leverage the Microsoft Entra ID join state of the device, and here we\u0026rsquo;re making more broad assumptions that you\u0026rsquo;re meeting all other pre-requisites for this authentication method.\nThe one we care about is the join state, as really this is the only one we can query from the client itself, so more PowerShell and using the ever trusty dsregcmd to get the join state of the device.\n$ready = 0 $dsRegCmd = dsregcmd /status $dsRegOutput = New-Object -TypeName PSObject $dsRegCmd | Select-String -Pattern \u0026#39; *[A-z]+ : [A-z]+ *\u0026#39; | ForEach-Object { Add-Member -InputObject $dsRegOutput -MemberType NoteProperty -Name (([String]$_).Trim() -split \u0026#39; : \u0026#39;)[0] -Value (([String]$_).Trim() -split \u0026#39; : \u0026#39;)[1] } if ($dsRegOutput.AzureAdJoined -eq \u0026#39;YES\u0026#39;) { $ready++ } if ($ready -gt 0) { Write-Output Ready } With a bit of a hack, we can take the output of dsregcmd /status and throw it into a new PSObject, which gives us an sample output of the below:\nAzureAdJoined : YES EnterpriseJoined : NO DomainJoined : YES Virtual Desktop : NOT SET Device Name : XXXXXX Thumbprint : XXXXXX DeviceCertificateValidity : [ 2023-10-31 13:36:52.000 UTC -- 2033-10-31 14:06:52.000 UTC ] KeyProvider : Microsoft Platform Crypto Provider TpmProtected : YES DeviceAuthStatus : SUCCESS TenantName : MEM v ENNBEE With the area we care about being the AzureAdJoined state, which can be referenced with $dsRegOutput.AzureAdJoined in the PowerShell script. Sticking with the Ready output here as well, we now have something we can confirm as part of the requirements for the application installation.\nClient Installation Settings # As we\u0026rsquo;re using Microsoft Intune to push out a packaged version of the client, we can\u0026rsquo;t rely on a standard detection rule such as file , msi, or registry, as there is no guarantee that the version of the client already installed, isn\u0026rsquo;t the same as the one we\u0026rsquo;re trying to deploy.\nTo get around this little hurdle, along with a couple of others along the way including the installation parameter for the ConfigMgr client, we need to create a PowerShell script to carry out the installation for us, taking into consideration the two main authentications methods of PKI and Entra authentication, as well as the requirements for the command line installation.\nCommand Line Installation # For both authentication types, we need the following command line options and switches:\nCCMHOSTNAME - The You\u0026rsquo;ll find the Cloud Management Gateway hostname in the ConfigMgr console under the Cloud Services settings. SMSSITECODE - Is pretty obviously your ConfigMgr site code. SMSMP - Required to specify the internal management point when the client is set to intranet connectivity. /mp - The management point address for the Cloud Management Gateway, it\u0026rsquo;s the one with the \u0026lsquo;https://\u0026rsquo; prefix. /forceinstall will uninstall the existing client first, and is useful if the installed version of the client is the same as the version being deployed. With the PKI authentication we need some additional switches:\n/NoCRLCheck - Useful if the internal PKI environment hasn\u0026rsquo;t a public certificate revocation list (CRL), no needed if you\u0026rsquo;re using a public certificate on the Cloud Management Gateway. /UsePKICert - Tells the installation to use a PKI certificate for authentication to the Cloud Management Gateway. Finally for Entra authentication we need some details from the Enterprise App used for this authentication method when setting up Azure Services in ConfigMgr:\nAADTENANTID - Can be found in your Entra ID tenant. AADCLIENTAPPID - Is the Client ID of the Enterprise App and can be found in Entra ID. AADRESOURCEURI - Is the internal URL used for the service sometimes it\u0026rsquo;s in the format \u0026lsquo;https://localhost\u0026rsquo; can be found in Enterprise App in Entra ID. So with all these switches now available, time to put them to good use and create a PowerShell script, that can be used for both authentication methods.\nInstallation Script # As I don\u0026rsquo;t like to repeat myself, we can create one PowerShell script for both authentication types, using a switch parameter to control which of the command line settings are used for the installation, and passing though the details of the below mandatory parameters for both installation types:\nccmSiteCode - ConfigMgr Site Code, so something like \u0026quot;ENB\u0026quot;. ccmMP - The URL of the internal ConfigMgr Management Point such as \u0026quot;https://configmgrmp.ennbee.local\u0026quot;. cmgAddress - The address of the Cloud Management Gateway (without the \u0026lsquo;https://\u0026rsquo; bit, as we\u0026rsquo;re building that for the required parameter), so \u0026quot;CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\u0026quot; For the parameters required for the PKI authentication:\nPKI - A switch parameter that used to create the command line arguments for PKI authentication over Entra authentication. For the Entra authentication method we need to pass through the non-mandatory parameters:\ntenantId - This is the UUID for your tenant, so something similar to \u0026quot;daf4a1c2-3a0c-401b-966f-0b855d3abd1a\u0026quot; clientAppId - The client App object ID from Entra, so for me it\u0026rsquo;s \u0026quot;7506ee10-f7ec-415a-b415-cd3d58790d97\u0026quot; clientAppURL - The client App URI configured in the Enterprise App, like \u0026quot;https://localhost\u0026quot; I\u0026rsquo;ve left these as non-mandatory and without any flight checks, as you\u0026rsquo;re not going to, a) see the output of the script, and b) I trust you to just use the script correctly.\nSo we now have an installation script in all its glory, ready to be packaged along with the ConfigMgr client installation files so we can punt it into Microsoft Intune.\n[CmdletBinding()] param( [Parameter(Mandatory = $false)] [switch]$PKI, [Parameter(Mandatory = $true)] [String]$ccmSiteCode, [Parameter(Mandatory = $true)] [String]$ccmMP, [Parameter(Mandatory = $true)] [String]$cmgAddress, [Parameter(Mandatory = $false)] [String]$tenantId, [Parameter(Mandatory = $false)] [String]$clientAppId, [Parameter(Mandatory = $false)] [String]$clientAppURL ) try { if ($PKI) { $arguments = \u0026#34;/forceinstall /NoCRLCheck /UsePKICert /mp:$(\u0026#39;https://\u0026#39; + $cmgAddress) CCMHOSTNAME=$($cmgAddress) SMSSITECODE=$($ccmSiteCode) SMSMP=$($ccmMP)\u0026#34; } else { $arguments = \u0026#34;/forceinstall /mp:$(\u0026#39;https://\u0026#39; + $cmgAddress) CCMHOSTNAME=$($cmgAddress) SMSSITECODE=$($ccmSiteCode) SMSMP=$($ccmMP) AADTENANTID=$($tenantId) AADCLIENTAPPID=$($clientAppId) AADRESOURCEURI=$($clientAppURL)\u0026#34; } Start-Process -FilePath \u0026#34;$PSScriptRoot\\ccmsetup.exe\u0026#34; -PassThru -Wait -ArgumentList $arguments # Create a tag file just so Intune knows this was run $tagPath = \u0026#34;$($env:ProgramData)\\Microsoft\\CCMCMGInstall\u0026#34; If (-not (Test-Path $tagPath)) { mkdir $tagPath -Force } $scriptName = $MyInvocation.MyCommand.Name Set-Content -Path \u0026#34;$tagPath\\$scriptName.tag\u0026#34; -Value \u0026#34;Installed\u0026#34; } catch { $error[0] } To allow us to detect whether the installation of the app has happened, and to avoid using native detection methods, I\u0026rsquo;ve included the creation of a .tag file in the script, which we can look for as part of the detection. To give you an example of the what the commands look like for PKI authentication it should look something like the below:\n.\\Install-ConfigMgrClientCMG.ps1 -PKI -ccmSiteCode \u0026#34;ENB\u0026#34; -ccmMP \u0026#34;https://configmgrmp.ennbee.local\u0026#34; -cmgAddress \u0026#34;CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\u0026#34; And for Entra authentication it\u0026rsquo;ll look like this, making sure to pass through the additional parameters for $tenantId, $clientAppId , and $clientAppURL:\n.\\Install-ConfigMgrClientCMG.ps1 -ccmSiteCode \u0026#34;ENB\u0026#34; -ccmMP \u0026#34;https://configmgrmp.ennbee.local\u0026#34; -cmgAddress \u0026#34;CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\u0026#34; -tenantId \u0026#34;daf4a1c2-3a0c-401b-966f-0b855d3abd1a\u0026#34; -clientAppId \u0026#34;7506ee10-f7ec-415a-b415-cd3d58790d97\u0026#34; -clientAppURL \u0026#34;https://localhost\u0026#34; Script done, time to package it up and punt it out to clients.\nApplication Packaging # Packaging up the Configuration Manager client for deployment from Microsoft Intune has been documented countless times, so just do a quick Bing Google search, but I\u0026rsquo;ll cover the high level steps so you don\u0026rsquo;t have to flit about the internet:\nGrab a copy of the latest client installation files from your Configuration Manager Primary Site server and plonk them somewhere on your Windows device: They\u0026rsquo;ll be in \\\\localhost\\SMS_[SITECODE]\\cd.latest\\SMSSETUP\\CLIENT where [SITECODE] is your site code. Go and get the latest version of the Microsoft-Win32-Content-Prep-Tool Extract this somewhere sensible on your computer. Download the Client installation script from my GitHub repo. Place this in the same location as the Configuration Manager client files, where ccmsetup.exe exists in fact. You should now have a folder with the client install content and PowerShell script looking like this:\nConfiguration Manager client installation files. Time to package the files.\nUsing the IntuneWinAppUtil # Now we have all the required files, navigate in an elevated Terminal window to where you extracted the Microsoft-Win32-Content-Prep-Tool, running a command similar to the below, specifying the source folder (-c) as where you copied the Configuration Manager client installation files, the setup file (-s) as the PowerShell script, and the output (-o) where you want the new intunewin file to be created:\n.\\IntuneWinAppUtil.exe -c \u0026#34;C:\\Source\\Installers\\CCMClient\u0026#34; -s Install-ConfigMgrClientCMG.ps1 -o \u0026#34;C:\\Source\\Installers\u0026#34; -q This will hopefully give us an output similar to the below:\nOutput of the Microsoft-Win32-Content-Prep-Tool command. And a new file Install-ConfigMgrClientCMG.intunewin in C:\\Source\\Installers ready to be uploaded to Microsoft Intune.\nClient Deployment # The rest of the deployment process happens over in Microsoft Intune so throw yourself over to Windows Apps blade, as we\u0026rsquo;ll need to create two new Win32 apps for each of our authentication methods, uploading the same .intunewin file for both apps.\nBoth applications will have similar App Information, so feel free to amend the wording in this section.\nApp Info section in Microsoft Intune for the Win32app. I haven\u0026rsquo;t bothered configuring an app logo, as Microsoft don\u0026rsquo;t üëÄ. PKI Authentication Application # When configuring the PKI authentication application, our installation command and requirements need to reflect this authentication type, so for our install command we need something like the below:\n\u0026#34;%systemroot%\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#34; -NoProfile -ExecutionPolicy Bypass -File Install-ConfigMgrClientCMG.ps1 -PKI -ccmSiteCode \u0026#34;ENB\u0026#34; -ccmMP \u0026#34;https://configmgrmp.ennbee.local\u0026#34; -cmgAddress \u0026#34;CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\u0026#34; The uninstall command is just removing the .tag file we create during the installation script:\ncmd.exe /c del %ProgramData%\\Microsoft\\CCMCMGInstall\\Install-ConfigMgrClientCMG.ps1.tag Program section in Microsoft Intune for the Win32app for PKI authentication. Make sure you update the installation time and the installation context otherwise you\u0026rsquo;ll be in for a bad time. As we\u0026rsquo;ve taken the time to write a custom requirement rule, we need to add this to the standard requirements section, uploading the script for PKI authentication we created and modified previously, and updating the output data type to String and expected value of Ready accordingly.\nRequirements section in Microsoft Intune for the Win32app for PKI authentication. Moving on to the next page in the process, we need to create our Detection rule using the .tag file that gets created during the installation. So go and add a new detection rule using the File option, with the path to the file being %ProgramData%\\Microsoft\\CCMCMGInstall and checking if the Install-ConfigMgrClientCMG.ps1.tag file exists:\nDetection Rule section in Microsoft Intune for the Win32app for PKI authentication. We can skip to the end of the process, as we have no further settings to configure, and I\u0026rsquo;d suggest assigning this on a small Proof-of-Concept group as part of testing, prior to just launching it to your entire device estate.\nPKI authentication done, what about the Entra authentication?\nEntra Authentication Application # This process is going to look very familiar, but there some key differences, but the start is the same so go create a new Windows app (Win32) in Microsoft Intune, complete the App information page with the information needed after uploading the .intunewin file again.\nFor the Program page, we need to amend our install command to the below passing in the required parameters we covered earlier:\n\u0026#34;%systemroot%\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#34; -NoProfile -ExecutionPolicy Bypass -File Install-ConfigMgrClientCMG.ps1 -ccmSiteCode \u0026#34;ENB\u0026#34; -ccmMP \u0026#34;https://configmgrmp.ennbee.local\u0026#34; -cmgAddress \u0026#34;CONFIGMGRCMG.CLOUDAPP.NET/CCM_Proxy_MutualAuth/72186325152220500\u0026#34; -tenantId \u0026#34;daf4a1c2-3a0c-401b-966f-0b855d3abd1a\u0026#34; -clientAppId \u0026#34;7506ee10-f7ec-415a-b415-cd3d58790d97\u0026#34; -clientAppURL \u0026#34;https://localhost\u0026#34; The uninstall command remains the same however:\ncmd.exe /c del %ProgramData%\\Microsoft\\CCMCMGInstall\\Install-ConfigMgrClientCMG.ps1.tag Program section in Microsoft Intune for the Win32app for Entra authentication. As with the PKI authentication configuration we need to add our Entra requirement script, updating the output data type to String and value of Ready.\nRequirements section in Microsoft Intune for the Win32app for Entra authentication. Same as with PKI authentication we need to create our Detection rule using the very same .tag file.\nDetection Rule section in Microsoft Intune for the Win32app for Entra authentication. Click Click Next OK-ing our way to the end, we now have both applications ready to be deployed to our orphaned Configuration Manager client devices.\nClient Installation # If you really want to double-down on getting this issue resolved, you can deploy both apps with the differing installation commands and requirements to the same Entra ID group, then regardless of whether they\u0026rsquo;ve got a valid certificate or they\u0026rsquo;re Entra joined, they\u0026rsquo;ll give the Configuration Manager client installation a good go.\nAs the detection method is the same for both apps, you\u0026rsquo;re not going to impact devices that have already run one or the other app.\nMicrosoft Intune Reporting # Giving Microsoft Intune a little while to catch up with the deployments, we should start seeing devices report back their installation status, and show any devices that are not meeting the requirements:\nA device failing the PKI requirements check in Microsoft Intune. With the same assignment group being used across both apps, we need to keep an eye out for devices that are failing both requirements checks. As well as devices that are actually reporting as installing the application:\nApp installation overview in Microsoft Intune. This isn\u0026rsquo;t the end of the story though, as Microsoft Intune is just telling us whether the client setup files are now on the targeted devices after meeting either the Entra Join or Client Certificate requirements.\nClient Installation Logs # Now we\u0026rsquo;ve assigned our new app to a group of devices that are no longer communicating with Configuration Manager, we can go and jump on a device targeted by the app, and keep an eye on the ccmsetup.log in C:\\Windows\\ccmsetup.\nWhat we\u0026rsquo;re looking for here, is the start of the installation passing through the parameters we configured in the PowerShell script we created:\nThe ccmsetup.log log file running the Configuration Manager client installation. You can now trail this log to make sure that the device is authenticating to the Cloud Management Gateway, and await for a final exit code of either 0, successful install or 7, pending restart, with both denote that the client has successfully installed, and communicated to Configuration Manager.\nSummary # This one might not have been the most conventional approach to Configuration Manager client installation, but the situation, as strange as it is, forced our hand to think of a non-standard way to push out the Configuration Manager client to these orphaned Windows devices to allow them to successfully phone home to the Configuration Manager Management Points using the Cloud Management Gateway without physically getting our hands on them.\nAt least with this method, and not just blindly pushing out the client without the requirements and installation arguments, means that devices are only going to start chatting to the Cloud Management Gateway when they can actually authenticate to it, regardless of which authentication method you\u0026rsquo;re using in your environment.\nThe status of your clients can be monitored in Configuration Manager Cloud management dashboard, as the app we pushed will start the ccmsetup process, authenticate to the Cloud Management Gateway, allowing them to check back in with Configuration Manager.\n","date":"2 September 2024","externalUrl":null,"permalink":"/posts/configmgr-client-install-cmg/","section":"Posts","summary":"You\u0026rsquo;ve just implemented a Cloud Management Gateway to help your hybrid joined Windows devices communicate to Configuration Manager over the internet, but what if they\u0026rsquo;re orphaned and unable to communicate to Configuration Manager to get the new Client Settings?","title":"Installing the Configuration Manager Client on Orphaned Internet Devices","type":"posts"},{"content":"","date":"2 September 2024","externalUrl":null,"permalink":"/categories/configmgr/","section":"Categories","summary":"","title":"Microsoft Configuration Manager","type":"categories"},{"content":"","date":"2 September 2024","externalUrl":null,"permalink":"/tags/powershell/","section":"Tags","summary":"","title":"PowerShell","type":"tags"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/tags/cis/","section":"Tags","summary":"","title":"Center for Internet Security (CIS)","type":"tags"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/tags/custom-profiles/","section":"Tags","summary":"","title":"Custom Profiles","type":"tags"},{"content":"I currently work as a Technical Consultant in the Cloud Endpoint practice at Phoenix Software Ltd (who, in recognition for outstanding achievements, have been awarded Microsoft Partner of the Year for 2023), specialising in the deployment and management of Microsoft Intune, a pivotal tool for modern device management and application deployment.\nBeyond working with Microsoft Intune, I am passionate about PowerBI Reporting and PowerShell scripting. This interest extends beyond professional obligation, reflecting a genuine enthusiasm for the products and trying to apply them to everyday life. Whether supporting clients on their cloud journey, harnessing PowerBI for insightful data reporting or crafting PowerShell scripts to automate complex tasks day-to-day, I‚Äôm normally geeking out somewhere.\nOutside of tech, I am a father, motorcyclist, petrol head and a big football \u0026amp; music fan.\n","date":"12 August 2024","externalUrl":null,"permalink":"/authors/jonathanfallis/","section":"Authors","summary":"I currently work as a Technical Consultant in the Cloud Endpoint practice at Phoenix Software Ltd (who, in recognition for outstanding achievements, have been awarded Microsoft Partner of the Year for 2023), specialising in the deployment and management of Microsoft Intune, a pivotal tool for modern device management and application deployment.","title":"Jonathan Fallis","type":"authors"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/series/patching-gaps-in-the-cis-windows-11-benchmark/","section":"Series","summary":"","title":"Patching Gaps in the CIS Windows 11 Benchmark","type":"series"},{"content":"This is the final part in this series, covering the final boss CIS Level 2 settings; I\u0026rsquo;ve brought back Jonathan to share the pain again.\nAfter the weeks reviewing and working on the benchmark, we can both happily say that we\u0026rsquo;re very glad to not have to look at CIS benchmarks for a while\u0026hellip;until they release a new one for you know iOS 18 or something (foreshadowing).\nThe settings in the CIS Level 2 benchmark are for the hardcore security fans out there, high security environments, or for when you just plain hate your end-users and just want to stop them from using their Windows 11 devices in normal ways.\nLet\u0026rsquo;s start on a positive note though, and look into some of the settings in the CIS build kit that just weren\u0026rsquo;t put together with logical though processes.\nCIS Level 2 Issues # Remember that the CIS Level 2 settings on their own aren\u0026rsquo;t particularly useful without their BitLocker and Level 1 counterparts, issues or otherwise üòÑ.\nAll CIS profiles in Microsoft Intune. So make sure you have a good understanding of the impact of these levels by looking at all posts in this series.\nFor now though, let\u0026rsquo;s continue into CIS Level 2 build kit profiles and work out where the issues sit.\nWindows Enterprise Edition # Before we even look at the problems enabling the DisableStoreOriginatedApps setting will cause, it\u0026rsquo;s worth mentioning that this setting is a Windows Enterprise/Education edition only configuration:\nPolicyCSP Edition settings for DisableStoreOriginatedApps So exactly like the previous post, a quick PowerShell script would allow us to configure the registry equivalent setting.\nWindows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\WindowsStore. Sadly though, this is a true Windows Enterprise/Education setting and will do absolutely nothing on any other Windows edition, so there\u0026rsquo;s no point in building a PowerShell script to apply the registry setting to our Windows Professional or otherwise devices.\nUser Settings # We\u0026rsquo;ve seen this previously so for the sake of completeness we should also break out the user specific settings into their own profiles, and assign these to users and not devices.\nUser Only settings not applying to the device context in Microsoft Intune. CIS (L2) Administrative Templates (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; Windows Media Player \u0026gt; Playback Prevent Codec Download (User) Enabled Administrative Templates \u0026gt; System \u0026gt; Internet Communication Management \u0026gt; Internet Communication settings Turn off Help Experience Improvement Program (User) Enabled More user only settings.\nCIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Windows Spotlight (User) Block The amended profiles and the new user based profiles, CIS (L2) Administrative Templates (User) - Windows 11 Intune 3.0.1 and CIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 are available for you to import into Microsoft Intune. Miscellaneous Settings # As with CIS Level 1, there are some settings they couldn\u0026rsquo;t shoehorn into a Settings Catalog policy, leaving us to create a new Custom Profile picking up the pieces.\nCIS (L2) Level 2 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value AllowSharedUserAppData ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/AllowSharedUserAppData Integer 0 DisableEnterpriseAuthProxy ./Device/Vendor/MSFT/Policy/Config/System/DisableEnterpriseAuthProxy Integer 1 AllowLocation ./Device/Vendor/MSFT/Policy/Config/System/AllowLocation Integer 0 DisallowCloudNotification ./Device/Vendor/MSFT/Policy/Config/Notifications/DisallowCloudNotification Integer 1 We\u0026rsquo;ll deal with the impact of these settings later on, for now just be happy we can create them in Microsoft Intune.\nA Custom profile for you to import, CIS (L2) Level 1 Misc - Windows 11 Intune 3.0.1, these were exported using Intune Management so you\u0026rsquo;ll need to import them using the same tool. CIS Level 2 Settings # Now we\u0026rsquo;ve covered the missing or at least misconfigured CIS Level 2 settings, let\u0026rsquo;s dig into their impact on Windows 11 cloud native devices.\nCIS Level 2 settings in Microsoft Intune. Starting in no particular order (we lied, it\u0026rsquo;s the worst one first).\nBlocking Store Apps # Well this one is a a bit of a kicker, we could deal with some end user experience changes as part of the CIS benchmark, what we can\u0026rsquo;t deal with are Microsoft Store apps being disabled entirely.\nApplication Blocked message in Windows 11. CIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Disable Store Originated Apps Enabled This kind of takes the piss mick really, it\u0026rsquo;s not just the built-in apps such as Paint, Calculator and the like, but any UWP app that has come from the store originally, including the Company Portal, and any UWP based Microsoft Store app (new) apps you\u0026rsquo;ve deployed from Microsoft Intune like Mozilla Firefox.\nMicrosoft Intune deployed Store Win32 Apps, such as Adobe Reader, are safe though, which does align with the CIS benchmark documents reasoning:\nThe Store service is a retail outlet built into Windows, primarily for consumer use. In an enterprise managed environment, the IT department should be managing the installation of all applications to reduce the risk of the installation of vulnerable software.\nDid someone not tell CIS that we are managing the installation of apps, they just happen to be store apps now?\nUWP Store (new) Apps from Microsoft Intune will still get installed on your devices, they just won\u0026rsquo;t actually run üò¨. Blocking App Updates # It\u0026rsquo;s not enough that the Store originated apps are gone, but also the ability to allow them to update.\nDisable turns off the launch of all apps from the Microsoft Store that came pre-installed or were downloaded. Apps will not be updated. Your Store will also be disabled.\nSo that leave\u0026rsquo;s us with outdated unpatched applications, which doesn\u0026rsquo;t make any sense from a security stand point.\nEven if you can\u0026rsquo;t actually use the applications, you\u0026rsquo;re stopping them from being updated? Surely this is a bad move CIS?\nEither way, you can force them to update using a Remediation script, as has been covered before:\nKeeping Windows Store Apps Updated with Microsoft Intune 6 February 2024\u0026middot; loading Microsoft Intune Windows 10 and later Software Updates Remediation Scripts Apps PowerShell Windows Autopilot Security Now we all love the new Windows Store, especially for deploying applications from Microsoft Intune, but we should find a way to keep these UWP applications up to date without additional license cost. OneDrive Settings # Let\u0026rsquo;s say goodbye to OneDrive whilst we\u0026rsquo;re at it; the CIS Level 2 settings actively stop OneDrive from being available across all of Windows 11.\nCIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value System Disable One Drive File Sync Sync disabled. This doesn\u0026rsquo;t just block the ability synchronise files locally from OneDrive or SharePoint Online, but removes OneDrive from File Explorer, and any integration into applications as well.\nEnabling this setting prevents users from accidentally (or intentionally) uploading confidential or sensitive corporate information to the OneDrive cloud service using the Next Generation Sync Client.\nWhere on earth are users meant to upload corporate information if not to OneDrive ffs üßê.\nNo working around this one, leaving your end-users only able to access files in OneDrive from the web, and pretty much breaking any option to utilise known folder move across Windows devices.\nCloud Search # More feature breaking settings inbound, with the below settings stopping users having the ability to search either OneDrive or SharePoint Online content from within the Windows 11 search bar.\nCIS (L2) Section 11.1 - 80 (No Services) - Windows 11 Intune 3.0.1 Category Setting Value Search Allow Cloud Search Not allowed. Do CIS hate Microsoft integrations? Or do they love the Microsoft Edge homepage integration with OneDrive and SharePoint, and are just forcing uses to access this to find their recently worked on documents, or collaborations?\nDue to privacy concerns, data should never be sent to any third-party since this data could contain sensitive information.\nDo they realise that these Windows 11 devices are already sharing quite a lot of information with Microsoft, what\u0026rsquo;s a few extra documents going to hurt?\nRemote Desktop # It just keeps getting better. No remote desktop access, even for those users explicitly given permission to remote desktop.\nCIS (L2) Administrative Templates - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; Remote Desktop Services \u0026gt; Remote Desktop Session Host \u0026gt; Connections Allow users to connect remotely by using Remote Desktop Services Disabled Surely there must be a bit of wriggle room with this one based upon the rationale in the CIS Benchmark document?\nAny account with the Allow log on through Remote Desktop Services user right can log on to the remote console of the computer. If you do not restrict access to legitimate users who need to log on to the console of the computer, unauthorized users could download and execute malicious code to elevate their privileges.\nIt looks like you might be able to get away with not disabling this, if you\u0026rsquo;re controlling the Allow log on through Remote Desktop Services, which we actually are, in the Level 1 profile CIS (L1) User Rights Global - Windows 11 Intune 3.0.1.\nLocating Devices # You might not have any interest in using the locate device functionality within Microsoft Intune, to legitimately find lost or stolen Windows devices (and not to be nosey and abuse privileges), but some people do.\nLocate device failing in Microsoft Intune. Those people should not try and align themselves to CIS Level 2, as one of the key requirements for locating a device, is allowing location services, which after we configured the miscellaneous settings earlier is now disabled.\nCIS (L2) Level 2 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value AllowLocation ./Device/Vendor/MSFT/Policy/Config/System/AllowLocation Integer 0 Turns out though, if you have a legitimate reason, you might be able to change this setting, and maybe some others\u0026hellip;\nThis setting affects the location feature (e.g. GPS or other location tracking). From a security perspective, it‚Äôs not a good idea to reveal your location to software in most cases, but there are legitimate uses, such as mapping software. However, they should not be used in high security environments.\n\u0026hellip;and allow location services to find out if your dad really went to get milk your lost and stolen devices.\nOrganisational Messages # Whoever is using these in Microsoft Intune, please let us know üòÇ.\nEither way to use Organisational Messages there are a handful of pre-requisites, specifically Windows Spotlight, which we are now blocking.\nCIS (L2) Section 11.1 - 80 (No Services) (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Windows Spotlight (User) Block So another bit of Microsoft Intune functionality is gone.\nNext.\nWindows System Services # We\u0026rsquo;ve seen something like this somewhere before, this time it\u0026rsquo;s another whole set of system services up for the chop, with the impact of disabling these services detailed below.\nCIS (L2) System Services - Windows 11 Intune 3.0.1 Service Name Service Description Impact BTAGService Bluetooth Audio Gateway Service No more Bluetooth headsets or speakers. bthserv Bluetooth Support Service No more Bluetooth devices. MapsBroker Downloaded Maps Manager Makes no difference as Maps is blocked anyways lfsvc Geolocation Service There goes Location services again. lltdsvc Link-Layer Topology Discovery Mapper No network device discovery maps. MSiSCSI Microsoft iSCSI Initiator Service No iSCSI attached devices. PNRPsvc Peer Name Resolution Protocol No chatting to internet devices about their names. p2psvc Peer Networking Grouping Definitely no chatting to internet devices about their names. p2pimsvc Peer Networking Identity Manager Seriously no chatting to internet devices about their names. PNRPAutoReg PNRP Machine Name Publication Service We get it, no chatting to internet devices about their names. Spooler Print Spooler No printing, not even to PDF but you know PrintNightmare was a thing. wercplsupport Problem Reports and Solutions Control Panel Support No reporting issues, shhhhhh your mouth. RasAuto Remote Access Auto Connection Manager No Always On VPN device tunnel connections. SessionEnv Remote Desktop Configuration Just no Remote Desktop access. TermService Remote Desktop LocalServices Still no Remote Desktop access. UmRdpService Remote Desktop LocalServices UserMode Port Redirector More no Remote Desktop Access. RemoteRegistry Remote Registry No Remote Registry access. LanmanServer Server No File or Print sharing. SNMP SNMP Service No SNMP communication. WerSvc Windows Error Reporting Service CIS hates errors. Wecsvc Windows Event Collector Also events. Bet it hates Birthdays as well. WpnService Windows Push Notifications System Service We can assume that Organisation Messages are dead, as the network endpoints are specifically called out. PushToInstall Windows PushToInstall Service Does this kill the deployment of Store Apps from Microsoft Intune? It does not, phew. WinRM Windows Remote Management No remote PowerShell sessions. If after understanding the entire impact of disabling these services, you still want to have to disable them, you can deploy the provided PowerShell script using Microsoft Intune with deployment settings:\nCIS Level 2 services PowerShell Script in Microsoft Intune. The PowerShell Script CIS (L2) System Services - Windows 11 Intune 3.0.1 is available to download and add as a new Platform Script to Microsoft Intune. And following on from the previous improvement, you can deploy a Remediation detection script to devices in scope of CIS Level 2.\nCIS (L2) System Services - Windows 11 Intune 3.0.1_Detection.ps1 $cisServices = @( \u0026#39;BTAGService\u0026#39;, # Bluetooth Audio Gateway Service \u0026#39;bthserv\u0026#39;, # Bluetooth Support Service \u0026#39;MapsBroker\u0026#39;, # Downloaded Maps Manager \u0026#39;lfsvc\u0026#39;, # Geolocation Service \u0026#39;lltdsvc\u0026#39;, # Link-Layer Topology Discovery Mapper \u0026#39;MSiSCSI\u0026#39;, # Microsoft iSCSI Initiator Service \u0026#39;PNRPsvc\u0026#39;, # Peer Name Resolution Protocol \u0026#39;p2psvc\u0026#39;, # Peer Networking Grouping \u0026#39;p2pimsvc\u0026#39;, # Peer Networking Identity Manager \u0026#39;PNRPAutoReg\u0026#39;, # PNRP Machine Name Publication Service \u0026#39;Spooler\u0026#39;, # Print Spooler \u0026#39;wercplsupport\u0026#39;, # Problem Reports and Solutions Control Panel Support \u0026#39;RasAuto\u0026#39;, # Remote Access Auto Connection Manager \u0026#39;SessionEnv\u0026#39;, # Remote Desktop Configuration \u0026#39;TermService\u0026#39;, # Remote Desktop LocalServices \u0026#39;UmRdpService\u0026#39;, # Remote Desktop LocalServices UserMode Port Redirector \u0026#39;RemoteRegistry\u0026#39;, # Remote Registry \u0026#39;LanmanServer\u0026#39;, # Server \u0026#39;SNMP\u0026#39;, # SNMP Service \u0026#39;WerSvc\u0026#39;, # Windows Error Reporting Service \u0026#39;Wecsvc\u0026#39;, # Windows Event Collector \u0026#39;WpnService\u0026#39;, # Windows Push Notifications System Service \u0026#39;PushToInstall\u0026#39;, # Windows PushToInstall Service \u0026#39;WinRM\u0026#39; # Windows Remote Management ) # Get current state on the services in the array above. $localServices = Get-Service -Name $cisServices -ErrorAction SilentlyContinue $notDisabled = 0 foreach ($cisService in $cisServices) { # Make sure service name in the list matches with local system services. # Added because of Computer Browser mismatch with \u0026#34;bowser\u0026#34; service $foundService = $localServices | Where-Object { $_.Name -eq $cisService } if ($foundService) { if ($foundService.StartType -ne \u0026#39;Disabled\u0026#39;) { $notDisabled++ } } } if ($notDisabled -gt 0) { Write-Output \u0026#34;Found $notDisabled service(s) that should be disabled for CIS Level 2.\u0026#34; Exit 1 } else { Write-Output \u0026#39;All required services are disabled for CIS Level 2.\u0026#39; Exit 0 } Along with a suitable remediation script, to ensure that the CIS Level 2 services are set to disabled, and all the nice functionality is gone.\nCIS (L2) System Services - Windows 11 Intune 3.0.1_Detection.ps1 $cisServices = @( \u0026#39;BTAGService\u0026#39;, # Bluetooth Audio Gateway Service \u0026#39;bthserv\u0026#39;, # Bluetooth Support Service \u0026#39;MapsBroker\u0026#39;, # Downloaded Maps Manager \u0026#39;lfsvc\u0026#39;, # Geolocation Service \u0026#39;lltdsvc\u0026#39;, # Link-Layer Topology Discovery Mapper \u0026#39;MSiSCSI\u0026#39;, # Microsoft iSCSI Initiator Service \u0026#39;PNRPsvc\u0026#39;, # Peer Name Resolution Protocol \u0026#39;p2psvc\u0026#39;, # Peer Networking Grouping \u0026#39;p2pimsvc\u0026#39;, # Peer Networking Identity Manager \u0026#39;PNRPAutoReg\u0026#39;, # PNRP Machine Name Publication Service \u0026#39;Spooler\u0026#39;, # Print Spooler \u0026#39;wercplsupport\u0026#39;, # Problem Reports and Solutions Control Panel Support \u0026#39;RasAuto\u0026#39;, # Remote Access Auto Connection Manager \u0026#39;SessionEnv\u0026#39;, # Remote Desktop Configuration \u0026#39;TermService\u0026#39;, # Remote Desktop LocalServices \u0026#39;UmRdpService\u0026#39;, # Remote Desktop LocalServices UserMode Port Redirector \u0026#39;RemoteRegistry\u0026#39;, # Remote Registry \u0026#39;LanmanServer\u0026#39;, # Server \u0026#39;SNMP\u0026#39;, # SNMP Service \u0026#39;WerSvc\u0026#39;, # Windows Error Reporting Service \u0026#39;Wecsvc\u0026#39;, # Windows Event Collector \u0026#39;WpnService\u0026#39;, # Windows Push Notifications System Service \u0026#39;PushToInstall\u0026#39;, # Windows PushToInstall Service \u0026#39;WinRM\u0026#39; # Windows Remote Management ) # Get current state on the services in the array above. $localServices = Get-Service -Name $cisServices -ErrorAction SilentlyContinue $notDisabled = 0 try { foreach ($service in $cisServices) { # Make sure service name in the list matches with local system services. # Added because of Computer Browser mismatch with \u0026#34;bowser\u0026#34; service $foundService = $localServices | Where-Object { $_.Name -eq $service } if ($foundService) { if ($foundService.StartType -ne \u0026#39;Disabled\u0026#39;) { $notDisabled++ Set-Service $FoundService.Name -StartupType Disabled -Force -ErrorAction SilentlyContinue } } } Write-Output \u0026#34;Found $notDisabled service(s) that are now disabled.\u0026#34; Exit 0 } catch { Write-Output \u0026#34;Unable to disable $notDisabled service(s).\u0026#34; Exit 2000 } Deployed using Microsoft Intune to your devices:\nCIS Level 2 services remediation in Microsoft Intune. Set a suitable schedule for the remediation to run, so you know, you\u0026rsquo;re breaking things on the regular.\nThe CIS (L2) System Services - Windows 11 Intune 3.0.1 detection and remediation scripts are available for your to add into your Microsoft Intune tenant. Summary # That\u0026rsquo;s it. We are done.\nWhat we have realised over the course of this series, is that unless you are required to align to CIS Level 2 settings, don\u0026rsquo;t do it.\nNo seriously, unless you really want to limit what features and functionality your end users, and support teams have access to, to allow them to carry out their normal day to day workloads, there is limited value to implement the CIS Level 2 settings just for nish and giggles.\nOverall though, these CIS benchmarks do provide a baseline for device security on Windows 11, but it isn\u0026rsquo;t the complete story, they\u0026rsquo;re not a cheat sheet to full device security, they\u0026rsquo;re just a component part.\nHave a go yourself implementing the profiles, and see for yourself exactly where the gaps are, what the actual impact is to your own devices, and try and make sense of all 1040 pages of the CIS Windows 11 Benchmark document üòÖ.\n","date":"12 August 2024","externalUrl":null,"permalink":"/posts/windows-cis-patching-gaps-part4/","section":"Posts","summary":"This is the last part in the series around the CIS (Center for Internet Security) benchmark for Windows 11, and we\u0026rsquo;d like to say that we\u0026rsquo;ve saved the best post for last, but we\u0026rsquo;d be lying. Surely the Level 2 settings can\u0026rsquo;t be worse than the Level 1?","title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 2 Windows 11","type":"posts"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/tags/remediation/","section":"Tags","summary":"","title":"Remediation Scripts","type":"tags"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/series/","section":"Series","summary":"","title":"Series","type":"series"},{"content":"","date":"12 August 2024","externalUrl":null,"permalink":"/tags/settings-catalog/","section":"Tags","summary":"","title":"Settings Catalog","type":"tags"},{"content":"When I started in my current role, I was asked to ensure that I set a specific Out of Office message in Outlook, letting anyone either internally or externally know that I was working on a Customer engagement and to leave me alone contact someone else if they needed assistance.\nNow I\u0026rsquo;m not one for handling repetitive tasks, or any task tbh, manually, so I opened up the trusty free friend that is Microsoft Flow Power Automate in my work/school account, and set about configuring a power automate flow, to set this automatic reply, automatically.\nCreating the Flow # We\u0026rsquo;ll cut to the chase here, as this isn\u0026rsquo;t Microsoft Intune, and although follows a similar Click Click Next OK setup, doesn\u0026rsquo;t require as much thought.\nSetting a Calendar Event Trigger # To create a flow and associated trigger go sign in to Power Automate, select Create, then select Automated cloud flow:\nCreating a new automated cloud flow. Give it a name, and enter in When an upcoming event is starting soon (V3) in the search field for the trigger for the flow to start, and select Create:\nAdding a trigger to an automated cloud flow. Once created, select the trigger, and if required allow the connection to your Exchange Online calendar, the select the Calendar Id, you can then update the settings for how often to check for events:\nUpdating the trigger settings in the flow. Now we have a trigger that will monitor your Exchange Online calendar for events starting soon. We need to give the Flow some conditions to work with.\nSetting an Out of Office Condition # As we only care about calendar events marked as Out of Office, we should add in a Condition.\nSelect the little + sign under the trigger, and select Add add an action (we\u0026rsquo;ll be doing this a few times, so get familiar with it):\nAdding an action to the flow trigger. Search for Condition and oddly enough, select Condition in the search results:\nAdding a Condition action to the flow trigger. Within the value field select the Harry Potter looking lightning bolt , to use data from the trigger above, and search for Show as selecting it, and updating the condition to look like the below:\nAdding logic into the Condition action for Out of Office events. Which now means that when the trigger looks at events in the calendar, it has a decision to make when an event is marked as Out of Office.\nSetting a Private Status Condition # As I also like to take time off from work, I thought best we leverage the flow to not only set up an automatic reply when I\u0026rsquo;m working with a customer, but also when I am genuinely Out of the Office.\nTo make life easier for myself, I mark actual holidays in my calendar as Private, so we can use this additional flag on the calendar event and add another condition to the flow under the True section of the Condition we created previously.\nSame as before, select the little + sign under the True option, and select Add add an action searching again for Condition, this time after selecting Harry Potter, search for Sensitivity:\nAdding logic into the Condition action for Private events. Configure the logic to say that Sensitivity is equal to private, meaning that if the event discovered is both Out of Office and Private do something.\nNow onto the something.\nSetting the Out of Office for Holidays # For our holiday automatic reply, we\u0026rsquo;re working under the True section of the condition, select Add an action again, this time search for Set up automatic replies (V2):\nAdding an automatic reply under the True condition. You will now be presented with a raft of options, select Show all to bring up all the setting we need to configure to set your Out of Office message, and using the Harry Potter option for each, add in the settings in the table:\nItem Value Status Scheduled External Audience All Start Time DateTime Start time Start Time TimeZone Time zone End Time DateTime End time End Time TimeZone Time zone With the above settings looking like the below:\nConfiguring automatic reply settings under the True condition. This will configure the Automatic Reply to start based on the start time of the event, and end when the event ends.\nWe\u0026rsquo;re not done quite yet, as we need to add in a message to send to people inside the organisation, and outside.\nLuckily the message supports HTML, so you make it look pretty, or you can just plonk in some basic information:\nItem Value Internal Reply Message I am currently sunning myself and have turned off my work emails, good luck have fun. External Reply Message I am currently out of the office and will not be able to respond to your email until my return. Looking like the below in the flow:\nConfiguring automatic reply messages under the True condition. That\u0026rsquo;s our holiday message sorted, how about we finish this off and get the other message sorted for when we\u0026rsquo;re actually doing some work but cba answering emails are unavailable.\nSetting the Out of Office for Engagements # With our customer engagement automatic reply, we\u0026rsquo;re working under the False section of the same condition, but still adding a new action by selecting Add an action again, searching for Set up automatic replies (V2).\nFill in the same settings as we did for the holiday message, but this time we should have a different reply message, as you know, we\u0026rsquo;re still able to respond to emails, just not quickly:\nConfiguring automatic reply settings under the True condition. Adding in a suitable but more professional message to both internal and external recipients:\nConfiguring automatic reply messages under the False condition. That\u0026rsquo;s it, you\u0026rsquo;re done. The whole flow should look something like the below, and obviously you can rename things to make like easier.\nOverview of the entire Flow. Don\u0026rsquo;t forget to Save your flow, and now it will happily work in the background setting Out of Office messages on your behalf.\nSummary # Not sure what to say here, this is well off topic from my usual content, but I was asked many times by people how I\u0026rsquo;ve set this up, so here it is.\nGo play around in Power Automate, but don\u0026rsquo;t come back to me if you\u0026rsquo;re having issues, unless it\u0026rsquo;s with something in Microsoft Intune\n","date":"26 July 2024","externalUrl":null,"permalink":"/posts/powerautomate-out-of-office/","section":"Posts","summary":"I\u0026rsquo;m not sure what I\u0026rsquo;m doing playing around with Power Automate, but here we are. Like many people, I have a habit of forgetting to set an Out of Office message when I\u0026rsquo;m actually on holiday, or when I\u0026rsquo;m working with customers. Let\u0026rsquo;s see if we can make something do this for us.","title":"Automatically Setting an Out of Office Message with Power Automate","type":"posts"},{"content":"","date":"26 July 2024","externalUrl":null,"permalink":"/tags/automation/","section":"Tags","summary":"","title":"Automation","type":"tags"},{"content":"","date":"26 July 2024","externalUrl":null,"permalink":"/categories/power-automate/","section":"Categories","summary":"","title":"Power Automate","type":"categories"},{"content":"","date":"22 July 2024","externalUrl":null,"permalink":"/tags/endpoint-security/","section":"Tags","summary":"","title":"Endpoint Security","type":"tags"},{"content":"","date":"22 July 2024","externalUrl":null,"permalink":"/tags/firewall/","section":"Tags","summary":"","title":"Firewall","type":"tags"},{"content":"What do you do when someone reaches out on GitHub about one of your scripts no longer working as expected?\nWell it\u0026rsquo;s obvious that you just assume that they\u0026rsquo;re doing something wrong\u0026hellip;\n\u0026hellip;what if they\u0026rsquo;re not wrong though?\nWhat if the script you created to convert the old style of Firewall Rule policies created using the now defunct migration tool doesn\u0026rsquo;t work because the rules it created are now Settings Catalog policies, ruining not just a good PowerShell script, but a blog post whilst it\u0026rsquo;s at it?\nModernising Microsoft Intune Firewall Rule Policies 12 September 2023\u0026middot; loading Microsoft Intune Windows 10 and later PowerShell Graph API Settings Catalog Security Firewall Automation Endpoint Security If you\u0026rsquo;ve ever experienced the joys of migrating Group Policy and in particular Windows Defender Firewall rules away from Group Policy to Microsoft Intune, you\u0026rsquo;ve probably encountered the Rule Migration Tool, and for now this tool has worked well. So what\u0026rsquo;s the catch? Well you write a blog post about it\u0026hellip;duh.\n1. The Tool # First off, let\u0026rsquo;s look at the Migration Tool which I\u0026rsquo;m pretty sure we\u0026rsquo;ve all used in our time allowing the automatic creation of Firewall Rule policies, taking existing Group Policy applied rules from a target device and punting them straight into Microsoft Intune.\nOh it\u0026rsquo;s gone.\nWell Microsoft you are correct, the old version of the tool did create the old mdm Endpoint Security Profiles, and it did use the old authentication method, but it also did work.\nIf you\u0026rsquo;re sensible nice enough to follow me on LinkedIn you might have spotted that as a favour to a stranger (not the first time mind you), I updated the migration tool to support the new authentication method, and a couple of other bits as well.\n2. The Script # I\u0026rsquo;m not using this post to break down exactly how I fixed updated the PowerShell script in the short term, but in summary I\u0026hellip;\nRemoved the reliance on the Microsoft GitHub repo to download content. Changed authentication to use the Microsoft.Graph PowerShell module. Changed the web requests to use Invoke-MgGraphRequest for calls to Graph. Forced the PowerShell script to create Endpoint Security templates for firewall rule policies instead of Configuration Profiles. Changed the Authentication to Graph to use device authentication as I\u0026rsquo;m a dirty macOS user. Disabled sending any telemetry data on success and failure of rule creation to Microsoft, as they have too much data on me already. Fixed an issue when checking for profile name matching when there are no existing firewall rule policies in Microsoft Intune. To use the script itself, you:\nDownload the FirewallRuleMigration.zip file and extract on your Windows device. Open PowerShell as Administrator. Navigate to the extracted folder, your PowerShell prompt should be in the FirewallRuleMigration folder. Run Set-ExecutionPolicy Bypass accepting all prompts like a good little child. Run ./Export-FirewallRules.ps1 with the corresponding switches (includeDisabledRules, includeLocalRules) if required. Authenticate to Graph using a Global Admin account, twice*. Enter a new profile name for the Firewall rules policy when prompted. Wait for rules to be uploaded to Microsoft Intune. *The script will disconnect all existing Graph sessions, and connect twice; once to allow for consent to be provided, the following to allow the script to run following the consent request.\nSo with this new script in hand, you can still migrate your Group Policy applied Firewall rules to Microsoft Intune, nice eh?\n3. Firewall Rules 2: The Conversioning # What I did not expect when running the PowerShell script, and after it created the Firewall Rule policies in Microsoft Intune, were them to just change.\nWhat I expected, is that I\u0026rsquo;d have to use my old script to actually convert them from the old versions\u0026hellip;\nFirewall Rule Policies created using the Migration Tool. \u0026hellip;and not just wait ten minutes for them to transition to new rules.\nFirewall Rule Policies converted using Microsoft secret sauce. So wtf is happening?\nNo clue.\n4. Are Microsoft Magicians? # Yes.\n5. The Truthening # The original Firewall Rule policies created by my wonderful PowerShell script are still using the legacy templates in Microsoft Intune:\nFirewall Rule Policies the old worse way of dealing with them. And to prove I didn\u0026rsquo;t spend my evening somehow manually creating 150 firewall rules in a way you can no longer create them, you can see the audit log showing that the policies were created at the timestamp:\nDefinitely real and not made up Microsoft Intune audit log. But oh what have we found here with our super secret snooping skills?\nClicking on one of the items that were created by the PowerShell script, we get a bit more detail:\nStill a real and not made up Microsoft Intune audit log but with more detail. But what\u0026rsquo;s this at the bottom of the entry:\nOMG it\u0026rsquo;s migrating. Zoom and enhance. Yeah this means nothing.\nThe audit log is showing that a new legacy Firewall Rule policy is being created, how do we know? Well it\u0026rsquo;s still using the old Endpoint Security templateId value of 4356d05c-a4ab-4a07-9ece-739f7c792910.\nAnother screenshot of some audit stuff. Running a quick Graph Explorer GET request to:\nhttps://graph.microsoft.com/beta/deviceManagement/templates?`$filter=(isof(%27microsoft.graph.securityBaselineTemplate%27)) and you\u0026rsquo;ll see all the Endpoint Security Templates, and specifically this one:\n{ \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.securityBaselineTemplate\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;4356d05c-a4ab-4a07-9ece-739f7c792910\u0026#34;, \u0026#34;displayName\u0026#34;: \u0026#34;Windows Firewall rules\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Windows Firewall allows administrators to define granular Firewall rules. Define firewall rules with specific ports, protocols, applications and networks, to allow or block network traffic.\u0026#34;, \u0026#34;versionInfo\u0026#34;: \u0026#34;2006\u0026#34;, \u0026#34;isDeprecated\u0026#34;: false, \u0026#34;intentCount\u0026#34;: 2, \u0026#34;templateType\u0026#34;: \u0026#34;securityTemplate\u0026#34;, \u0026#34;platformType\u0026#34;: \u0026#34;windows10AndLater\u0026#34;, \u0026#34;templateSubtype\u0026#34;: \u0026#34;firewall\u0026#34;, \u0026#34;publishedDateTime\u0026#34;: \u0026#34;2020-03-11T00:00:00Z\u0026#34; } Either way Microsoft is doing some wizardry behind the scenes not available to see with the naked eye.\nSo go check your own Firewall Rule policies, I bet they\u0026rsquo;ll be the new Settings Catalog ones. I\u0026rsquo;ll wait (hint, I won\u0026rsquo;t).\nOr if you like, use the PowerShell script to create some new old ones, then just wait a little bit and see them evolve into Settings Catalog policies.\nWho\u0026rsquo;s that Pok√©mon Firewall Rule policy?\nIt\u0026rsquo;s a Settings Catalog policy for Firewall Rules!\nFirewall Rule Policies the new much better way of dealing with them. 5. Summary # Honestly, not sure what you want from me here; there might have been a communication about this in the What\u0026rsquo;s new in Intune, maybe a blog post, maybe not.\nEither way you\u0026rsquo;ve got a new version of the Migration Tool script, a bit of background on how it works, and a dive into the world of things that just happen without us knowing in Microsoft Intune land.\nOff you jog now.\n","date":"22 July 2024","externalUrl":null,"permalink":"/posts/firewall-rule-policy-conversion/","section":"Posts","summary":"When did Microsoft go all covert ops (maybe don\u0026rsquo;t answer that question) and start making changes to your very own Firewall Rule policies in Microsoft Intune without letting anyone know? Or did they?","title":"Microsoft Intune and the Curious Case of the Converting Firewall Rule Policy","type":"posts"},{"content":"With the investigation into the impact of the CIS benchmark on BitLocker and Windows Autopilot now a fond and distant memory, it\u0026rsquo;s time for me to stand Jonathan down (it was his Birthday after all, and he has his own content to create), pull up my sleeves, and get to testing the CIS Level 1 settings across the full Windows 11 operating system itself.\nThis decision to go it alone, had absolutely nothing to do with me already knowing that there were more missing settings in the benchmark build kit than settings that actually break Windows 11, I promise ü§´.\nSo what is the CIS Level 1 benchmark missing?\nCIS Level 1 Issues # Well probably a few things, but let\u0026rsquo;s sadly look at the settings in the CIS Level 1 benchmark that are going to cause some headaches across Windows 11.\nUser Rights Assignment # It looks like when configuring User Rights in the Microsoft Intune benchmark, CIS \u0026ldquo;did a Microsoft\u0026rdquo;, and forgot that languages other than English are used across the vanilla Windows 11 operating system, just like the initial release of the Security Baseline for Windows 11 23H2 identified by James Robinson:\nTrying to apply the new 23H2 #Intune Baseline and using a non-English OS? You\u0026#39;ll probably break the ability to log into devices because the group names are localised.@IntuneSuppTeam These need changing to the equivalent well-known SID or a lot of devices are gonna go pop. pic.twitter.com/zY7yWfR3yl\n\u0026mdash; James Robinson | MVP (@SkipToEndpoint) April 6, 2024 In short, the CIS policy uses english language names, instead of the well-known SIDs across all of the User Rights settings, meaning operating systems in a non-english language will hit some issues, mainly with users actually being able to logon to the device.\nMicrosoft fixed this slight oversight pretty sharpish, however the same can\u0026rsquo;t be said for CIS üëÄ.\nTo give you a sample of the User Rights assignment policy, have a look at the below, covering some of the settings and associated account names in english:\nCIS (L1) User Rights - Windows 11 Intune 3.0.1 Category Setting Value User Rights Access From Network Administrators, Remote Desktop Users User Rights Allow Local Log On Administrators, Users User Rights Create Global Objects Administrators, LOCAL SERVICE, NETWORK SERVICE, SERVICE User Rights Deny Access From Network Guests, Local account User Rights Increase Scheduling Priority Administrators, Window Manager\\Window Manager Group Compared with the below extract of the updated policy, which has been amended to support the use of the SIDs:\nCIS (L1) User Rights Global - Windows 11 Intune 3.0.1 Category Setting Value User Rights Access From Network *S-1-5-32-544, *S-1-5-32-555 User Rights Allow Local Log On *S-1-5-32-544, *S-1-5-32-545 User Rights Create Global Objects *S-1-5-32-544, *S-1-5-19, *S-1-5-20, *S-1-5-6 User Rights Deny Access From Network *S-1-5-32-546, *S-1-5-113 User Rights Increase Scheduling Priority *S-1-5-32-544, *S-1-5-90-0 If we just applied and trusted CIS here, then it is quite likely that for non-English operating systems, users would not have been able to sign-in to their Windows device.\nYou can import the updated version of the CIS (L1) User Rights Global - Windows 11 Intune 3.0.1 profile into your Microsoft Intune tenant instead of manually updating the profile, like we had to üôÉ. Edited\u0026hellip;\nThanks to Jimmy Winberg in the comments, the areas in the CIS profile that reference a null identifier, have now been updated to use the NULL SID S-1-0-0 to stop errors in the event logs. Miscellaneous Settings # These settings that exist in the benchmark document, can only, as of today, be added into Microsoft Intune using a Custom Profile which should be pretty easy (foreshadowing).\nCIS Level 1 Miscellaneous settings document. So we should create a new profile to capture the three CIS Level 1 settings detailed in the document with the below Custom Profile settings.\nCIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value BlockNonAdminUserInstall ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/BlockNonAdminUserInstall Integer 1 AllowWindowsConsumerFeatures ./Device/Vendor/MSFT/Policy/Config/Experience/AllowWindowsConsumerFeatures Integer 0 AllowAutoConnectToWiFiSenseHotspots ./Device/Vendor/MSFT/Policy/Config/Wifi/AllowAutoConnectToWiFiSenseHotspots Integer 0 Here\u0026rsquo;s a Custom Profile for you, CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1, exporting using the Intune Management tool. Anyone spot a problem? I\u0026rsquo;ll give you a minute.\nNow we can\u0026rsquo;t blame CIS for the issues their recommended settings cause, as this one fully goes to Microsoft. Devices getting the setting BlockNonAdminUserInstall set to enabled, causes issues with the Photos app on the device for devices running the April 2024 patch.\nCIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Name OMA-URI Data Type Value BlockNonAdminUserInstall ./Device/Vendor/MSFT/Policy/Config/ApplicationManagement/BlockNonAdminUserInstall Integer 1 We also can\u0026rsquo;t blame CIS for both AllowWindowsConsumerFeatures and BlockNonAdminUserInstall failing to apply to devices either, as due to the June 2024 patch devices which should be activated to Windows 11 Enterprise as part of subscription activation, don\u0026rsquo;t, leaving devices at their original Windows edition, in this case Windows Pro.\nCIS Level 1 Miscellaneous setting custom profile assignment error. Meaning that neither AllowWindowsConsumerFeatures and BlockNonAdminUserInstall will apply to non-Enterprise editions of Windows:\nPolicyCSP Edition settings for BlockNonAdminUserInstall Are there any other settings in the benchmark require specific Windows editions?\nWindows Edition Requirements # The Windows subscription activation issues, and subsequent edition downgrade, highlighted something I hadn\u0026rsquo;t considered, just how many settings in the CIS 3.0.1 benchmark for Level 1 actually require an Enterprise or Education editions of Windows, or at least just don\u0026rsquo;t work on Pro editions?\nWell I\u0026rsquo;m not going to count them for you (I actually did, it\u0026rsquo;s seven).\nSetting Profile AllowWindowsConsumerFeatures CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 BlockNonAdminUserInstall CIS (L1) Level 1 Misc - Windows 11 Intune 3.0.1 Allow Spotlight Collection (User) CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 Disable Consumer Account State Content CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Require Private Store Only CIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Credential Guard CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 Require Platform Security Features CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 If you\u0026rsquo;ve only got devices running Windows Professional, you can say goodbye to blocking the Windows Consumer Features, or by requiring the Windows Private Store, blocking access to the store itself, or worse, device security settings in Credential Guard and Secure Boot not applying.\nSettings that require Windows Enterprise editions to apply to a device. So this leaves a bit of a gap in the Level 1 benchmark for these Windows Professional cloud native devices, or does it?\nWell no, we just can\u0026rsquo;t use Microsoft Intune native settings to configure them. What we can do is use our favourite tooling Group Policy, PowerShell, to go and set some corresponding registry settings to ensure we\u0026rsquo;re in-line with the benchmark.\nWe can create a PowerShell script to create the six, (yes I said six), registry settings. These exist in the HKLM registry hive, so we can happily update them using a PowerShell and a Platform Script in Microsoft Intune.\nCIS (L1) Windows Pro Settings - Windows 11 Intune 3.0.1.ps1 # Windows Pro Device Settings $regSettings = @() $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\Software\\Policies\\Microsoft\\Windows\\CloudContent\u0026#39;; name = \u0026#39;DisableWindowsConsumerFeatures\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows\\CloudContent\u0026#39;; name = \u0026#39;DisableConsumerAccountStateContent\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\Software\\Policies\\Microsoft\\Windows\\Appx\u0026#39;; name = \u0026#39;BlockNonAdminUserInstall\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\Software\\Policies\\Microsoft\\WindowsStore\u0026#39;; name = \u0026#39;RequirePrivateStoreOnly\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\Software\\Policies\\Microsoft\\Windows\\DeviceGuard\u0026#39;; name = \u0026#39;LsaCfgFlags\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } $regSettings += [pscustomobject]@{path = \u0026#39;HKLM:\\Software\\Policies\\Microsoft\\Windows\\DeviceGuard\u0026#39;; name = \u0026#39;RequirePlatformSecurityFeatures\u0026#39;; value = \u0026#39;1\u0026#39;; type = \u0026#39;DWord\u0026#39; } Try { foreach ($regSetting in $regSettings) { if (!(Test-Path $($regSetting.path))){ New-Item -Path $($regSetting.path) -Force } New-ItemProperty -Path $($regSetting.path) -Name $($regSetting.name) -Value $($regSetting.value) -PropertyType $($regSetting.type) -Force } Exit 0 } Catch { Write-Error $_.ErrorDetails Exit 1 } Sadly, the Allow Spotlight Collection setting, only exists in the HKCU part of the registry, and sits under the HKCU:\\Software\\Policies key which standard users don\u0026rsquo;t have access to write to. So we don\u0026rsquo;t have a way to create this new item using PowerShell and Platform Scripts natively.\nJonathan has informed me that you could apply the Allow Spotlight Collection setting in HKCU using the PSAppDeployToolkit, specifically the Invoke-HKCURegistrySettingsForAllUsers functionality, so off you trot and do that. The rest of registry entries in CIS (L1) Windows Pro Settings - Windows 11 Intune 3.0.1.ps1 are fine, so deploy them to your devices using a Platform Script:\nPlatform Script configuring Windows Enterprise only Policy CSP Settings. Using Platform Scripts, we\u0026rsquo;re currently limited to assignments without Device Filters, so we don\u0026rsquo;t have a way to target just Windows devices that aren\u0026rsquo;t on Windows 11 Enterprise/Education (operating system edition isn\u0026rsquo;t an attribute stored in the Entra ID computer object, so no Dynamic Groups either).\nSeeing the script do it\u0026rsquo;s thing, we now have the configured registry settings, (at least those in HKLM), set on the device, with the expected behaviour of the CIS benchmark:\nWindows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\Windows\\CloudContent. Windows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\Windows\\Appx. Windows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\WindowsStore. Windows Pro registry settings under HKLM:\\Software\\Policies\\Microsoft\\Windows\\DeviceGuard. The CIS (L1) Windows Pro Settings - Windows 11 Intune 3.0.1.ps1 PowerShell scripts should be added as Platform scripts in Microsoft Intune. User Settings # Any other assignment issues you want to throw our way and not document CIS? No? Are you sure?\nHaving reviewed the device assignment states after by default assigning the imported build kit settings to groups of devices in Microsoft Intune, I was left pondering as to why CIS wouldn\u0026rsquo;t mention that there are User only settings in each of the profiles.\nUser Only settings not applying to the device context in Microsoft Intune. This isn\u0026rsquo;t such a bad thing, as you\u0026rsquo;re just going to get a Not Applicable state when assigned to the SYSTEM context of the device, the user on the device will be fine though.\nHowever, for good practice assignment, we should split out the user settings from the profiles, and create new ones, allowing a consistent assignment of settings.\nCIS (L1) Admin Templates - Windows Components (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; Network Sharing Prevent users from sharing files within their profile. (User) Enabled Administrative Templates \u0026gt; Windows Components \u0026gt; Attachment Manager Do not preserve zone information in file attachments (User) Disabled Administrative Templates \u0026gt; Windows Components \u0026gt; Attachment Manager Notify antivirus programs when opening attachments (User) Enabled CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 Category Setting Value Experience Allow Spotlight Collection (User) 0 Microsoft App Store MSI Always Install With Elevated Privileges (User) Disabled Administrative Templates \u0026gt; Windows Components \u0026gt; Attachment Manager Notify antivirus programs when opening attachments (User) Enabled CIS (L1) Section 1 - 3.9.1.1 (User) - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Start Menu and Taskbar \u0026gt; Notifications Turn off toast notifications on the lock screen (User) Enabled Administrative Templates \u0026gt; Control Panel \u0026gt; Personalization Enable screen saver (User) Enabled The amended profiles and the new user based profiles, CIS (L1) Admin Templates - Windows Components (User) - Windows 11 Intune 3.0.1, CIS (L1) Section 22 - 80 (User) - Windows 11 Intune 3.0.1 and CIS (L1) Section 1 - 3.9.1.1 (User) - Windows 11 Intune 3.0.1 are available for you to import, don\u0026rsquo;t say I\u0026rsquo;m not kind to you all. CIS Level 1 Settings # Now hopefully we\u0026rsquo;re done with settings in the Level 1 benchmark that just don\u0026rsquo;t work properly, we can look at settings that are missing, or settings that are just going to annoy your end-users or support teams ü´†.\nLocal Administrator Password Solution # On to recommendations that exist in the Benchmark document but not in the build kit, we can start with Windows LAPS.\nThe Windows LAPS settings don\u0026rsquo;t exist in the build kit as it\u0026rsquo;s configured under Account Protection in the Endpoint Security section of Microsoft Intune, so I assume CIS just didn\u0026rsquo;t include it as there is no native import functionality.\nTaking the information provided in the benchmark document, we need to cover off everything under section 85 Windows LAPS, as they\u0026rsquo;re all CIS Level 1 settings.\nAn excerpt from the CIS 3.0.1 benchmark for Windows LAPS. We can easily create a new Account Protection policy in Microsoft Intune to meet these requirements, with the settings below:\nCIS (L1) Windows LAPS - Windows 11 Intune 3.0.1 Category Setting Value LAPS Backup Directory Backup the password to Azure AD only LAPS Password Age Days 30 or fewer* LAPS Administrator Account Name Admin LAPS Password Complexity Large letters + small letters + numbers + special characters (improved readability) LAPS Password Length 15 or more* LAPS Post Authentication Actions Reset the password and logoff the managed account (or higher)* LAPS Post Authentication Reset Delay 8 (or fewer hours, but not 0)* *These are the minimum settings to adhere to the CIS benchmark, so amend as you see fit.\nDon\u0026rsquo;t forget if you are going to use Windows LAPS, that you enable the feature in Entra ID, and review the requirements to allow you to actually use it on your Windows 11 devices. The CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 CIS policy sets the built-in administrator account name to Admin, so make sure either you update the setting below in the imported policy to match any changes to the LAPS setting, or be happy with what it\u0026rsquo;s called:\nCIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Accounts Rename Administrator Account Admin We can\u0026rsquo;t export a Endpoint Security profile, even if they\u0026rsquo;re technically Settings Catalog profiles, so we\u0026rsquo;re using the Intune Management tool, allowing you to import the CIS (L1) Windows LAPS - Windows 11 Intune 3.0.1 profile instead of having to create it. Windows Updates and Delivery Optimisation # Is it all good in the world of Windows Update for Business settings in the CIS benchmark? Well kind of, if you want all of your devices to install updates every day, with no phasing, and just blindly update to the latest Feature Update after 180 days.\nCIS (L1) Windows Update - Windows 11 Intune 3.0.1 Category Setting Value Windows Update For Business Defer Feature Updates Period In Days 180 Windows Update For Business Defer Quality Updates Period (Days) 0 Windows Update For Business Scheduled Install Day Every day It\u0026rsquo;s not like there\u0026rsquo;s even much room for manoeuvre; the Feature Update deferral is a minimum of 180 days, so you could phase the delivery of Feature Updates at least, but the Quality Update deferral can only be zero days, so out goes the window for any kind of phasing.\nMaybe CIS has more faith in Windows Updates not breaking devices than others ü´¢.\nAt least there\u0026rsquo;s a setting in the build kit for Delivery Optimisation, so all our devices installing Quality and Feature updates at the same time don\u0026rsquo;t smash the WAN connection to bits\u0026hellip;\nCIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Delivery Optimization DO Download Mode HTTP only, no peering Oh.\nIt\u0026rsquo;s OK, we can have any of the settings available to us in Microsoft Intune, just not HTTP blended with Internet peering.\nSection 22.1 (L1) Ensure \u0026lsquo;DO Download Mode\u0026rsquo; is NOT set to \u0026lsquo;HTTP blended with Internet Peering\u0026rsquo;. Just goes to show that you do really need to read the associated CIS Benchmark document along with using the build kit, or just take the word of someone on the internet that things work üò¨.\nMicrosoft Store # As mentioned previously, having a Microsoft Intune setting to Require Private Store Only is only a Windows Enterprise edition feature, however we sorted that with the PowerShell script, so now that the setting is applying to all devices correctly, it blocks the store.\nCIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Require Private Store Only Only Private store is enabled. As there isn\u0026rsquo;t such as thing as a Private Store now the the Microsoft Store for Business has been retired (has it?), then the outcome of the setting above just blocks access to the store.\nThe Microsoft Store blocked by the Require Private Store setting in Microsoft Intune. In the same profile though at least the store apps are being kept up to date:\nCIS (L1) Section 22 - 80 - Windows 11 Intune 3.0.1 Category Setting Value Microsoft App Store Allow apps from the Microsoft app store to auto update Allowed. But with no way easy way to check that apps are actually being updated, you\u0026rsquo;d better look at another option to ensure the built-in apps are kept up to date üòâ.\nWindows Defender # You\u0026rsquo;d think there\u0026rsquo;d be nothing majorly wrong with the Windows Defender settings in the build kit, or the benchmark document itself, and on first glance all looks well apart from the lack of any kind remediations to quarantine or delete detected threats.\nYou might not be using Windows Defender as your primary antivirus solution, so CIS not assuming you are is a good thing.\nBut based on this, CIS wouldn\u0026rsquo;t include anything in the imported profiles that does require Windows Defender to be acting a as primary solution and/or in active mode though?\nCIS (L1) Defender - Windows 11 Intune 3.0.1 Category Setting Value Defender Block executable content from email client and webmail Block Defender Block Office applications from injecting code into other processes Block Defender Block Office applications from creating executable content Block Defender Block abuse of exploited vulnerable signed drivers (Device) Block Defender Block persistence through WMI event subscription Block Defender Block untrusted and unsigned processes that run from USB Block Defender Block JavaScript or VBScript from launching downloaded executable content Block Defender Block credential stealing from the Windows local security authority subsystem Block Defender Block Adobe Reader from creating child processes Block Defender Block all Office applications from creating child processes Block Defender Block Office communication application from creating child processes Block Defender Block Win32 API calls from Office macros Block Defender Block execution of potentially obfuscated scripts Block Ah, 13 Attack Surface Reduction Rules, and all in block mode , not an audit setting in sight. Brilliant.\nSo even if you do meet the dependencies below for the ASR rules to actually apply, they\u0026rsquo;re all going to straight up block everything they find that matches the rules.\nMicrosoft Defender Antivirus must be enabled and configured as primary anti-virus solution, and must be in the following mode:\nPrimary antivirus/antimalware solution State: Active mode Which is another good reason to actually check to see what these build kit profiles are configuring, without blindly applying them to you device estate and being all surprised when stuff stops working.\nWindows System Services # CIS provide a PowerShell script as part of the Level 1 benchmark to disable some scary looking Windows System Services, specifically the below (even if the Xbox ones are already disabled by CIS (L1) System Services - Windows 11 Intune 3.0.1).\nThe table below details the apparent effect of disabling these services.\nService Name Service Description Impact Browser Computer Browser No more discovery of network devices. IISADMIN IIS Admin Service No SMTP or FTP configuration in IIS. irmon Infrared monitor service No transfer of data using Infrared. SharedAccess Internet Connection Sharing No sharing of network connections, bye bye Hyper-V bridging. LxssManager LxssManager Bye bye Windows Subsystem for Linux. FTPSVC Microsoft FTP Service Clearly no more FTP servers. sshd OpenSSH SSH Server Same as above but SSH servers. RpcLocator Remote Procedure Call (RPC) Locator Nowt, legacy service. RemoteAccess Routing and Remote Access As on the tin, used for RRAS servers. simptcp Simple TCP/IP LocalServices$LocalServices Apparently has little use in modern environments, and is an optional Windows feature. sacsvr Special Administration Console Helper Remote command prompt used as part of Windows Emergency Management Services and Serial Console. SSDPSRV SSDP Discovery UPnP device discovery is now dead. upnphost UPnP Device Host UPnP device discovery is still dead. WMSvc Web Management Service No more management of local web servers. WMPNetworkSvc Windows Media Player Network Sharing Service No media sharing from Windows Media Player. icssvc Windows Mobile Hotspot Service No creation of Mobile hotspots. W3SVC World Wide Web Publishing Service No more local web servers. XboxGipSvc Xbox Accessory Management Service No playing games. XblAuthManager Xbox Live Auth Manager No logging into games. XblGameSave Xbox Live Game Save No saving games. XboxNetApiSvc Xbox Live Networking Service No games. So happy with all the functionality that is being prevented, we can deploy the provided script using Microsoft Intune Platform Scripts with deployment settings looking something like this:\nCIS Level 1 services PowerShell Script in Microsoft Intune. The PowerShell Script CIS (L1) System Services - Windows 11 Intune 3.0.1 is available to download and add as a new Platform Script to Microsoft Intune. Now this is all well and good for disabling the services, once, but what happens if someone manages to enable them after the script has run, now what?\nWell Remediations that\u0026rsquo;s what.\nA quick modification to the existing script, to use some logic round how many of the services are not currently disabled, passing this back to Microsoft Intune as part of a detection script:\nCIS (L1) System Services - Windows 11 Intune 3.0.1_Detection.ps1 $cisServices = @( \u0026#39;Browser\u0026#39;, # Computer Browser \u0026#39;IISADMIN\u0026#39;, # IIS Admin Service \u0026#39;irmon\u0026#39;, # Infrared monitor service \u0026#39;SharedAccess\u0026#39;, # Internet Connection Sharing \u0026#39;LxssManager\u0026#39;, # LxssManager \u0026#39;FTPSVC\u0026#39;, # Microsoft FTP Service \u0026#39;sshd\u0026#39;, # OpenSSH SSH Server \u0026#39;RpcLocator\u0026#39;, # Remote Procedure Call (RPC) Locator \u0026#39;RemoteAccess\u0026#39;, # Routing and Remote Access \u0026#39;simptcp\u0026#39;, # Simple TCP/IP LocalServices$LocalServices \u0026#39;sacsvr\u0026#39;, # Special Administration Console Helper \u0026#39;SSDPSRV\u0026#39;, # SSDP Discovery \u0026#39;upnphost\u0026#39;, # UPnP Device Host \u0026#39;WMSvc\u0026#39;, # Web Management Service \u0026#39;WMPNetworkSvc\u0026#39;, # Windows Media Player Network Sharing Service \u0026#39;icssvc\u0026#39;, # Windows Mobile Hotspot Service \u0026#39;W3SVC\u0026#39;, # World Wide Web Publishing Service \u0026#39;XboxGipSvc\u0026#39;, # Xbox Accessory Management Service \u0026#39;XblAuthManager\u0026#39;, # Xbox Live Auth Manager \u0026#39;XblGameSave\u0026#39;, # Xbox Live Game Save \u0026#39;XboxNetApiSvc\u0026#39; # Xbox Live Networking Service ) # Get current state on the services in the array above. $localServices = Get-Service -Name $cisServices -ErrorAction SilentlyContinue $notDisabled = 0 foreach ($cisService in $cisServices) { # Make sure service name in the list matches with local system services. # Added because of Computer Browser mismatch with \u0026#34;bowser\u0026#34; service $foundService = $localServices | Where-Object { $_.Name -eq $cisService } if ($foundService) { if ($foundService.StartType -ne \u0026#39;Disabled\u0026#39;) { $notDisabled++ } } } if ($notDisabled -gt 0) { Write-Output \u0026#34;Found $notDisabled service(s) that should be disabled for CIS Level 1.\u0026#34; Exit 1 } else { Write-Output \u0026#34;All required servicess are disabled for CIS Level 1.\u0026#34; Exit 0 } Then a simple remediation script to loop through each service and disable it:\nCIS (L1) System Services - Windows 11 Intune 3.0.1_Remediation.ps1 $cisServices = @( \u0026#39;Browser\u0026#39;, # Computer Browser \u0026#39;IISADMIN\u0026#39;, # IIS Admin Service \u0026#39;irmon\u0026#39;, # Infrared monitor service \u0026#39;SharedAccess\u0026#39;, # Internet Connection Sharing \u0026#39;LxssManager\u0026#39;, # LxssManager \u0026#39;FTPSVC\u0026#39;, # Microsoft FTP Service \u0026#39;sshd\u0026#39;, # OpenSSH SSH Server \u0026#39;RpcLocator\u0026#39;, # Remote Procedure Call (RPC) Locator \u0026#39;RemoteAccess\u0026#39;, # Routing and Remote Access \u0026#39;simptcp\u0026#39;, # Simple TCP/IP LocalServices$LocalServices \u0026#39;sacsvr\u0026#39;, # Special Administration Console Helper \u0026#39;SSDPSRV\u0026#39;, # SSDP Discovery \u0026#39;upnphost\u0026#39;, # UPnP Device Host \u0026#39;WMSvc\u0026#39;, # Web Management Service \u0026#39;WMPNetworkSvc\u0026#39;, # Windows Media Player Network Sharing Service \u0026#39;icssvc\u0026#39;, # Windows Mobile Hotspot Service \u0026#39;W3SVC\u0026#39;, # World Wide Web Publishing Service \u0026#39;XboxGipSvc\u0026#39;, # Xbox Accessory Management Service \u0026#39;XblAuthManager\u0026#39;, # Xbox Live Auth Manager \u0026#39;XblGameSave\u0026#39;, # Xbox Live Game Save \u0026#39;XboxNetApiSvc\u0026#39; # Xbox Live Networking Service ) # Get current state on the services in the array above. $localServices = Get-Service -Name $cisServices -ErrorAction SilentlyContinue $notDisabled = 0 try { foreach ($service in $cisServices) { # Make sure service name in the list matches with local system services. # Added because of Computer Browser mismatch with \u0026#34;bowser\u0026#34; service $foundService = $localServices | Where-Object { $_.Name -eq $service } if ($foundService) { if ($foundService.StartType -ne \u0026#39;Disabled\u0026#39;) { $notDisabled++ Set-Service $FoundService.Name -StartupType Disabled -Force -ErrorAction SilentlyContinue } } } Write-Output \u0026#34;Found $notDisabled service(s) that are now disabled.\u0026#34; Exit 0 } catch { Write-Output \u0026#34;Unable to disable $notDisabled service(s).\u0026#34; Exit 2000 } Deployed using Microsoft Intune to your devices:\nCIS Level 1 services remediation in Microsoft Intune. Ensuring you set a suitable schedule for the remediation to run, daily is probably overkill, just make sure it\u0026rsquo;s running before any kind of CIS audit üòÇ.\nThe CIS (L1) System Services - Windows 11 Intune 3.0.1 detection and remediation scripts are available for your to add into your Microsoft Intune tenant. Summary # What I\u0026rsquo;ve learnt looking over the CIS Level 1 settings, is that there are some pretty large gaps in the build kit; settings that just don\u0026rsquo;t exist such as with Windows LAPS, settings that only apply to users and not devices, settings that only apply to specific editions of Windows, minimum settings that will cause unexpected behaviour, and some normal good practice settings for security solutions such as Windows Defender that are just plain missing.\nThis does mean though, that applying a CIS benchmark is only part of the story when it comes to securing your Windows 11 cloud native devices, and it\u0026rsquo;s worth looking into other Security Baselines (cough Microsoft cough) to help harden not only the operating system, but applications that reside on top.\nNext up is the final part in the series, the dreaded CIS Level 2 settings, surely it can\u0026rsquo;t get any worse?\n","date":"15 July 2024","externalUrl":null,"permalink":"/posts/windows-cis-patching-gaps-part3/","section":"Posts","summary":"The impact of the CIS settings on BitLocker and Windows Autopilot now done and dusted, we should broaden our horizons and start to look at what other problems the CIS level 1 benchmark brings to Windows 11 as a whole. Are there any? Will it be smooth sailing? Yeah, no.","title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows 11","type":"posts"},{"content":"We\u0026rsquo;re no stranger to renaming Windows Autopilot devices having looked at this with Hybrid joined devices not once, but twice, to allow people to be happier with the names of their corporate owned devices, and not the random nature Windows Autopilot Hybrid Join deployments gives them.\nSo what gives, why am I looking at this again?\nYeah, it\u0026rsquo;s Windows Autopilot v2, (honestly I hope that name doesn\u0026rsquo;t stick), and after looking at the post Gannon Novak put together around the subject, I thought to myself, \u0026ldquo;I wonder if there are other ways to achieve this?\u0026rdquo;.\nGuess what? There are.\nRenaming Devices # I\u0026rsquo;ll be frank, this method is misaligned to good practice (which is nice way of saying, \u0026ldquo;janky\u0026rdquo;), but until there is a way to do this in Microsoft Intune within the device preparation policy itself, and you still care about naming your devices and not just leaving users to decide their device names on Windows Pro devices at least\u0026hellip;\nWindows Autopilot Device Name prompt. \u0026hellip;this is all you\u0026rsquo;ve got.\nCustom Profiles # Ah shh, here we go again, digging around in the Policy CSP to try and find something to allow for a device rename.\nThere are a couple of settings detailed in the Policy CSP that support device naming, or device renaming, both DNSComputerName and ComputerName.\nAs we\u0026rsquo;re only dealing with Windows 11 devices due to the requirements for Windows Autopilot Device Preparation, we\u0026rsquo;ll stick with DNSComputerName due to the note with ComputerName:\nFor desktop PCs on Windows 10, version 2004 or later, use the Ext/Microsoft/DNSComputerName node in DevDetail CSP.\nTaking stock of the provided DNSComputerName documentation, when configuring a device name, we should utilise one of the suggested variables:\nWe recommend using %SERIAL% or %RAND:x% with a high character limit to reduce the chance of name collision when generating a random name. This feature doesn\u0026rsquo;t check if a particular name is already present in the environment.\nSo when configuring our device name, we can utilise a prefix and a variable such as ENB-%SERIAL% to hope there are no device name clashes:\nSetting the device name using DNSComputerName in Microsoft Intune. We can create a new Custom Profile in Microsoft Intune with the below setting, allowing for the device to have a more suitable name:\nWindows Autopilot v2 - Device Rename Name OMA-URI Data Type Value DNSComputerName ./DevDetail/Ext/Microsoft/DNSComputerName String ENB-%SERIAL% Device named, how do we make it stick, and by this, I mean how do we force a restart?\nForcing the Restart # Well we can cheat, well we use the fact that there are some known issues with specific Security settings and their impact to Windows Autopilot causing device restarts, which we have looked at before.\nPatching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot 23 June 2024\u0026middot; loading Microsoft Intune Windows 10 and later Security Center for Internet Security (CIS) Windows Autopilot Windows Hello Settings Catalog PowerShell With the CIS BitLocker and associated DMA settings reviewed and updated, now is time to delve into the Windows 11 specific settings that exist in the CIS Level 1 benchmark. What issues do they bring to Windows Autopilot, what solutions can we find? Honestly, who knows. So picking at least one of the settings from the Policy CSP for Device Guard, (which you should be applying to your Windows 11 devices anyway), we can look to force a restart as part of the application of the Custom Profile containing our device name settings:\nWindows Autopilot v2 - Device Rename Name OMA-URI Data Type Value DNSComputerName ./DevDetail/Ext/Microsoft/DNSComputerName String ENB-%SERIAL% EnableVirtualizationBasedSecurity ./Device/Vendor/MSFT/Policy/Config/DeviceGuard/EnableVirtualizationBasedSecurity Integer 1 I picked EnableVirtualizationBasedSecurity but you can select any in the document, they all cause some type of restart during OOBE. Making sure to assign this new profile to the same group of devices used in your APDP (is this really any better than APv2?) policy:\nWindows Autopilot Device Preparation Policy device group assignment. If you like screenshots of Microsoft Intune, here\u0026rsquo;s another one for you, this time of the Custom Profile:\nWindows Autopilot Device Preparation rename policy assignment. Renaming in Action # You can see this rename process in action, and the device restart, following all the other OOBE gumph which I\u0026rsquo;ve kindly sped up:\nAlthough the device itself is now happily renamed, Microsoft Intune is being a little whinge about the assignment of the profile:\nProfile assignment errors in Microsoft Intune for DNSComputerName. Yeah, errors, and not ones we can do anything about either, but at least the device got renamed right? Nowt to complain about here. Jog on.\nSummary # There you have it, another way to rename shiny new APDP devices (stop trying to make \u0026ldquo;APDP\u0026rdquo; happen), but honestly, I\u0026rsquo;m almost done caring about device names at this point.\nThe whole Autopilot Deployment Device Preparation process is user centric, what exactly are you using device names for? Applying settings to specific dynamic security groups based on device name?\nI mean this is a bad idea right, firstly APDP (I\u0026rsquo;m still trying, leave me alone.) hands you a group of devices which you can use, secondly, if you\u0026rsquo;re applying settings to devices based on something trivial like the device name, what\u0026rsquo;s stopping an Administrative user changing the device name and circumventing your policies? Literally nothing.\nSo instead of complaining that there are missing features with APDP (last time I promise), like renaming devices, or lack of other deployment methods, or that it takes longer than normal, or there\u0026rsquo;s more user interaction, can we just all move on and find other better ways of grouping devices, you know like with Device Filters and User assignments.\n","date":"2 July 2024","externalUrl":null,"permalink":"/posts/windows-autopilot-v2-renaming/","section":"Posts","summary":"So Microsoft released Windows Autopilot Device Preparation, or more commonly known as APv2, into General Availability a little while ago. So with this production release we should be able to name our corporate owned Windows devices right Microsoft? Right?","title":"Renaming Windows Autopilot v2 Devices","type":"posts"},{"content":"","date":"2 July 2024","externalUrl":null,"permalink":"/tags/windows-autopilot/","section":"Tags","summary":"","title":"Windows Autopilot","type":"tags"},{"content":"","date":"2 July 2024","externalUrl":null,"permalink":"/tags/windows-autopilot-v2/","section":"Tags","summary":"","title":"Windows Autopilot Device Preparation","type":"tags"},{"content":"We started with the BitLocker and DMA (Direct Memory Access) settings in the first post in this Windows 11 CIS benchmark based series, now is the time we dig deeper into the broader Level 1 settings, this time looking at the impact to Windows Autopilot cloud native deployments.\nJonathan has more than enough experience with testing these policies and the impact to Windows Autopilot, as I made asked him to help me review the impact of them following his initial run in with the community version of the CIS Microsoft Intune templates.\nSo please send him your thanks, as without his turmoil of dealing with the CIS policies breaking his devices, and the constant nagging from me as to when he\u0026rsquo;s done with testing and finding solutions, there wouldn\u0026rsquo;t be the content for this post or in fact the series.\nRight, onto the fruits of my our labour.\nCIS Level 1 Settings # We already have a grasp of the settings that cause problems with Windows Autopilot, so we can start to try and find solutions to the discovered issues, all without reducing the overall security of the Windows 11 operating system too much ü§ê.\nCIS Level 1 settings in Microsoft Intune. There might be a surprising amount of wiggle room with some of the CIS Level 1 benchmark settings, that maybe aren\u0026rsquo;t entirely obvious at first, starting with the documented problems\u0026hellip;\nDisable Automatic Admin Logon # You\u0026rsquo;re correct CIS, of course you should disable the use of automatic logons for administrator accounts, and it should be implemented without hesitation.\nNo one should be automatically logging on to a Windows device as a administrator, unless you\u0026rsquo;re maybe defaultuser0 as part of the Windows Autopilot process right?\nCIS (L1) Section 1 - 3.9.1.1 - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; MSS (Legacy) MSS: (AutoAdminLogon) Enable Automatic Logon (not recommended) Disabled The above configuration, will bin out the Enrolment Status Page, reboot, and leave you with a Windows Autopilot device at a logon screen with the defaultuser0 being your only option for sign in, and pretty much nothing from Microsoft Intune applied to it:\nWindows logon screen with the defaultuser0 logon prompt. We did already know about the AutoAdminLogon setting causing the issue with Windows Autopilot, as it is documented, but who has time to read all of these articles üòÇ.\nBut how do we stop this from breaking Autopilot exactly?\nAs pointed out in the comments, the Policy CSP documentation is a little vague around supported operating system versions, so we\u0026rsquo;ve found an alternative way to meet this requirement without breaking Windows Autopilot deployments. Instead of attempting to using Microsoft Intune native configuration, we can lean on the registry setting to configure this CIS level 1 requirement:\nAutoAdminLogon registry setting reference. To ensure it doesn\u0026rsquo;t break anything, we can deploy a remediation script to set the registry value, assigning the script to users, meaning that it won\u0026rsquo;t apply until after the Autopilot process has completed.\nThe detection script will look for the AutoAdminLogon string value, and if it does not exist, or it is not set to 0 will report an error:\nCIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Detection.ps1 Try { $registry = \u0026#39;HKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\u0026#39; $setting = \u0026#39;AutoAdminLogon\u0026#39; # Checks if the key and if the string value AutoAdminLogon exists Try { $value = Get-ItemPropertyValue -Path $registry -Name $setting } Catch { Write-Warning \u0026#34;$setting not configured.\u0026#34; Exit 1 } # if the key and dword exist checks the value. if ($value -ne \u0026#39;0\u0026#39;) { Write-Warning \u0026#34;$setting enabled.\u0026#34; Exit 1 } else { Write-Output \u0026#34;$setting disabled.\u0026#34; Exit 0 } } Catch { Write-Error $_.Exception Exit 2000 } With the remediation configured to create the AutoAdminLogon if required, and set it to 0, to disable this option:\nCIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1_Remediation.ps1 Try { $registry = \u0026#39;HKLM:\\Software\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\u0026#39; $setting = \u0026#39;AutoAdminLogon\u0026#39; $path = Test-Path $registry # checks if the key exists, if not creates the key and AutoAdminLogon string. if ($path -eq $false) { New-Item -Path $registry -Force | Out-Null New-ItemProperty -Path $registry -Name $setting -Value 0 -PropertyType String -Force | Out-Null Write-Output \u0026#34;$setting disabled.\u0026#34; Exit 0 } else { # checks if the AutoAdminLogon string exists, if not creates it. Try { # if the AutoAdminLogon dword exists updates it. Get-ItemPropertyValue -Path $registry -Name $setting Set-ItemProperty -Path $registry -Name $setting -Value 0 Write-Output \u0026#34;$setting disabled.\u0026#34; Exit 0 } Catch { New-ItemProperty -Path $registry -Name $setting -Value 0 -PropertyType string -Force | Out-Null Write-Output \u0026#34;$setting disabled.\u0026#34; Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } Deploying this to a group of users in Microsoft Intune, with settings similar to the below, with a suitable evaluation schedule:\nCIS Level 1 AutoAdminLogon remediation in Microsoft Intune. The CIS (L1) Section 3.5.1 - Windows 11 Intune 3.0.1 detection and remediation scripts are available for your to add into your Microsoft Intune tenant. Interactive Logon Messages # More breaking of Windows Autopilot, this time with pre-provisioned deployments, with another known and documented feature problem. Thanks CIS üò¨.\nCIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Interactive Logon Message Text For Users Attempting To Log On Configured Local Policies Security Options Interactive Logon Message Title For Users Attempting To Log On Configured I know a logon message is important, and is included in other security baselines and not just for Windows devices either, but come on now, do we really need this?\nWell yes if you want to stick with the CIS benchmark.\nSo once more to stripping out this setting into a separate profile, this time keeping the same configuration settings, but assigning this to all your corporate-owned devices, but excluding a group of Windows Autopilot devices configured for pre-provisioned deployments using rules based on the enrollmentProfileName associated with the device.\nCIS (L1) Section 45.10-45.11 - Windows 11 Intune 3.0.1 Category Setting Value Local Policies Security Options Interactive Logon Message Text For Users Attempting To Log On Configured Local Policies Security Options Interactive Logon Message Title For Users Attempting To Log On Configured Don\u0026rsquo;t forget to actually configure these settings, unlike in the CIS profiles where they\u0026rsquo;re just set to Test test test üòÇ:\nWindows logon message setting in Microsoft Intune. You can import CIS (L1) Section 45.10-45.11 - Windows 11 Intune 3.0.1 and the amended CIS (L1) Local Policies Security Options - Windows 11 Intune 3.0.1 profiles into your Microsoft Intune tenant. Virtualization Based Security # We\u0026rsquo;d encountered a rogue device restart during Windows Autopilot when configuring a BitLocker PIN, which did actually work to our advantage, but what caused them?\nCIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 Category Setting Value Device Guard Configure System Guard Launch Unmanaged Enables Secure Launch if supported by hardware Device Guard Credential Guard Configured Device Guard Enable Virtualization Based Security enable virtualization based security. Device Guard Require Platform Security Features Turns on VBS with Secure Boot. Yeah it\u0026rsquo;s those ones, that are specifically called out to cause device restarts.\nThese policies require a reboot\u0026hellip; to work around this issue, the policies can be targeted to users instead of devices so that they apply later in the process.\nLuckily for us we\u0026rsquo;ve been given a workaround, just assign the CIS (L1) Virtualization Based Technology - Windows 11 Intune 3.0.1 profile to a group of users instead of devices.\nStrangely enough this isn\u0026rsquo;t mentioned in the CIS documentation anywhere, so thanks to Microsoft for looking out for us.\nDisable Network Selection UI # We\u0026rsquo;d come across this issue one a while ago, with the below setting stopping users from connecting to a new wireless network at the logon screen. You\u0026rsquo;d think this wouldn\u0026rsquo;t be too much of an issue, even during User-Driven Windows Autopilot, but where it does become a problem though, is with pre-provisioning.\nCIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; System \u0026gt; Logon Do not display network selection UI Enabled With a user deploying their own device, they\u0026rsquo;re asked to connect to a wireless network (who has network cables in their own house? Jonathan apparently üòÖ) before starting Windows Autopilot, so this network will now be available at logon, and no need to select a new one.\nWith pre-provisioned deployments, only the network that was connected to during deployment, and/or wireless or wired networks deployed to the device from Microsoft Intune are available to connect to from the logon screen.\nMeaning if you build devices on-premises, and then give them to end-users to take home, with the setting above, they won\u0026rsquo;t be able to connect to a new network from the logon screen.\nWindows logon screen with the no network logon prompt. Saving changing this across all devices, as it only impacts Windows Autopilot devices, you can remove this setting from the benchmark profiles, and create a new policy with the below settings:\nCIS (L1) Section 3.10.25.2 - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; System \u0026gt; Logon Do not display network selection UI Disabled Then assign it to your corporate devices, excluding Dynamic Security Groups containing Windows Autopilot Devices where their profile allows the use of pre-provisioning as in the Interactive Logon Messages section.\nThis will enable these devices, and these only, to select a new network not previously connected to, before logging onto their device, which if they\u0026rsquo;ve been deployed somewhere other than the current location, means they can actually sign in üòÜ.\nDespite this only being one setting to create, we\u0026rsquo;ve been nice and made the CIS (L1) Section 3.10.25.2 - Windows 11 Intune 3.0.1 profile available for you to import, along with the amended original profile CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1. Windows Hello for Business # Now Windows Hello for Business isn\u0026rsquo;t strictly a Windows Autopilot thing, but if you\u0026rsquo;re deploying a Windows Hello for Business policy to either your users or devices, then they\u0026rsquo;re going to get prompted to configure Windows Hello when they sign in.\nSo we were happy to see the use of Windows Hello for Business as an authentication method, to add multi-factor authentication to Windows 11 accounts, recommend by CIS üéâ.\nCIS (L1) Device Lock \u0026amp; WHFB - Windows 11 Intune 3.0.1 Category Setting Value Windows Hello For Business Minimum PIN Length 6 Windows Hello For Business Require Security Device true Windows Hello For Business Facial Features Use Enhanced Anti Spoofing true You haven\u0026rsquo;t configured additional settings somewhere else that will impact the use of Windows Hello have you CIS?\nAccount options in Windows 11 unable to configure Windows Hello PIN. What\u0026rsquo;s that? You have? You\u0026rsquo;re advising that Windows Hello for Business should be used to protect accounts, but you\u0026rsquo;re stopping the use of convenience PINs, that are required to setup Windows Hello.\nCIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; System \u0026gt; Logon Turn on convenience PIN sign-in Disabled As pointed out in the comments, this isn\u0026rsquo;t strictly true; although Windows Hello and Windows Hello for Business share the same \u0026ldquo;Windows Hello\u0026rdquo; family name, they aren\u0026rsquo;t actually related, sort of like a step-brother üëÄ setup.\nSo although the above setting will stop a user from setting up a PIN in the more traditional sense, it will not stop the Windows Hello for Business configuration from applying.\nBe aware though, there are settings in the CIS (L1) Device Lock \u0026amp; WHFB - Windows 11 Intune 3.0.1 profile, that will impact the configuration of Windows Hello if you don\u0026rsquo;t have a policy in place to require PIN complexity settings.\nCIS Benchmark Device Lock Warning. Yeah, it\u0026rsquo;s these ones they\u0026rsquo;re talking about.\nCIS (L1) Device Lock \u0026amp; WHFB - Windows 11 Intune 3.0.1 Category Setting Value Device Lock Device Password Enabled Enabled Device Lock Alphanumeric Device Password Required Password, Numeric PIN, or Alphanumeric PIN required. Device Lock Device Password Expiration 365 Device Lock Device Password History 24 Device Lock Min Device Password Length 14 Device Lock Minimum Password Age 1 These Device Lock settings are known to cause problems with Windows Autopilot, to get around that, it is recommended to assign the below profile to Users and not devices where applicable. So make sure you\u0026rsquo;ve got a Windows Hello for Business policy already created and deployed to your users, with at least the below setting configured to enable Windows Hello for Business.\nCIS (L1) Windows Hello for Business (User) - Windows 11 Intune 3.0.1 Category Setting Value Windows Hello For Business Use Passport For Work (User) true The amended profile CIS (L1) Admin Templates - System - Windows 11 Intune 3.0.1 and Windows Hello profile are available for import CIS (L1) Windows Hello for Business - Windows 11 Intune 3.0.1. With the above configuration, your users will get the post logon Windows Hello experience following a successful Windows Autopilot deployment.\nIf you don\u0026rsquo;t want to force the setup of Windows Hello for Business, you can disable the post logon setup using a Custom Profile, though there are consequences. Summary # We did say that the impact of the CIS Level 1 settings on Windows Autopilot was going to be a little difficult to deal with, but we got there, with some creative assignments, mild exclusions, and a little bit of common sense.\nSecurity and end-user experience don\u0026rsquo;t tend to wander off hand in hand into the distance to live happily ever after, but there is now a way to deal with these issues using Microsoft Intune native tooling, and a good understanding of the application of the CIS benchmark.\nThe next chapter in this investigation of the CIS benchmark for Windows 11 covers the impact on the wider Windows 11 operating system, and happily there aren\u0026rsquo;t as many things that break functionality. There are however, some interesting choices.\n","date":"23 June 2024","externalUrl":null,"permalink":"/posts/windows-cis-patching-gaps-part2/","section":"Posts","summary":"With the CIS BitLocker and associated DMA settings reviewed and updated, now is time to delve into the Windows 11 specific settings that exist in the CIS Level 1 benchmark. What issues do they bring to Windows Autopilot, what solutions can we find? Honestly, who knows.","title":"Patching Gaps in the CIS Windows 11 Benchmark - Level 1 Windows Autopilot","type":"posts"},{"content":"","date":"23 June 2024","externalUrl":null,"permalink":"/tags/windows-hello/","section":"Tags","summary":"","title":"Windows Hello","type":"tags"},{"content":"","date":"15 June 2024","externalUrl":null,"permalink":"/tags/bitlocker/","section":"Tags","summary":"","title":"BitLocker","type":"tags"},{"content":"","date":"15 June 2024","externalUrl":null,"permalink":"/tags/dma/","section":"Tags","summary":"","title":"Direct Memory Access","type":"tags"},{"content":"With the release of the CIS (Center for Internet Security) Windows 11 Benchmark 3.0.1, the corresponding release of the Microsoft Intune build kit, and my colleague Jonathan Fallis covering the CIS community version of the benchmark (and the limitations) on his website, we both thought it would be best to share our combined experience when working with the newly available CIS build kit; focussing on BitLocker security settings in the initial part of this series.\nOver the course of three four posts, we\u0026rsquo;ll be aiming to find and fix any issues the build kit profiles create for Windows 11 cloud native devices, improve functionality using Microsoft Intune where we can, and add any missing configurations between the downloadable benchmark documents and the build kit.\nLet\u0026rsquo;s start with the obvious place.\nCIS Build Kits # If you have access to the CIS Workbench as part of an organisational account, you can download the Windows 11 build kit for Microsoft Intune, which when extracted will give you exported Settings Catalog profiles in JSON format, ready to import into Microsoft Intune:\nIt turns out the we have more access in the CIS Workbench than we realised, you can still register but this will only get you access to the benchmark documents, not the build kits. Imported CIS profiles in Microsoft Intune. Each of these profiles is aligned with the CIS benchmark whether Level 1, Level 2, or BitLocker settings, and instead of blindly applying these to your device estate, you really should have a look at the following sections on BitLocker profiles, as we build upon our existing understanding of their impact, and fix some issues along the way.\nCIS BitLocker Settings # With only the single BitLocker related policy in the build kit, you\u0026rsquo;d think encrypting a device with these benchmark settings would be easy.\nImported CIS BitLocker profiles in Microsoft Intune. Usually you just configure the use of TPM as the pre-boot authentication, allow Standard Users to encrypt the device, encryption method and cipher strength, encryption method, and boom there you have it, automatically and silently encrypted protected devices.\nWell not according to CIS, and for good reason.\nEncryption Settings # Before we look at the rationale behind the recommended CIS settings for BitLocker, one thing that stood out to us when reviewing the provided policy, and the corresponding benchmark document, is a lack of actual encryption settings.\nSpecifically, the ones that allow for silent encryption to happen\u0026hellip;so we need to create a supplemental Settings Catalog policy, to allow for encryption to actually start without pestering a user.\nCIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; BitLocker Require Device Encryption Enabled Administrative Templates \u0026gt; BitLocker Allow Warning For Other Disk Encryption False Administrative Templates \u0026gt; BitLocker Allow Standard User Encryption Enabled Along with our preferred encryption ciphers for encryption.\nCIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption Choose drive encryption method and cipher strength (Windows 10 [Version 1511] and later) Enabled Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption Select the encryption method for operating system drives: XTS-AES 256-bit Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption Select the encryption method for fixed data drives: XTS-AES 256-bit Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption Select the encryption method for removable data drives: XTS-AES 256-bit Finally, our encryption method selecting either Full encryption or Used Space Only encryption.\nCIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Enforce drive encryption type on operating system drives Enabled Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Select the encryption type: (Device) Used Space Only encryption With the gaps in the CIS benchmark policy now plugged, we can look into some of the other settings and see if our silent encryption settings are going to work.\nYou can import the CIS (BL) BitLocker Supplement - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of manually creating the profile. TPM with PIN Authentication # Well here\u0026rsquo;s a problem, the CIS provided BitLocker profile doesn\u0026rsquo;t allow for TPM only authentication, so out the window goes our ability to silently encrypt the device then.\nCompatible TPM startup - Configure this as Allow TPM or Require TPM Compatible TPM startup PIN - Configure this as Do not allow startup PIN with TPM Compatible TPM startup key - Configure this as Do not allow startup Key with TPM Compatible TPM startup key and PIN - Configure this as Do not allow startup Key and PIN with TPM Why are CIS requiring both TPM and PIN for BitLocker authentication and stopping us having fun with device encryption?\nBitLocker with TPM-only authentication allows for a computer to enter the power-on state without any pre-boot authentication. Therefore, an attacker may be able to perform DMA (Direct Memory Access) attacks.\nAh yeah, a security reason, makes sense. The settings from the profile below show the pre-boot authentication options, requiring startup PIN with TPM, and blocking everything else.\nCIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup key and PIN Do not allow startup key and PIN with TPM Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup Do not allow TPM Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup PIN Require startup PIN with TPM Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup key Do not allow startup key with TPM What we could do to alleviate the requirement for a user to configure a PIN to start BitLocker encryption, is slightly amend the policy (and hope that we don\u0026rsquo;t get audited), changing the below settings to allow the use of TPM and TPM with PIN protectors.\nCIS (BL) BitLocker Silent Encryption - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup Allow TPM Administrative Templates \u0026gt; Windows Components \u0026gt; BitLocker Drive Encryption \u0026gt; Operating System Drives Configure TPM startup PIN Allow startup PIN with TPM With the settings in Microsoft Intune looking something like this:\nAmended BitLocker benchmark policy in Microsoft Intune. This will enable silent encryption, protecting the data on the device, but also allowing a PIN to be configured afterwards.\nYou can import the CIS (BL) BitLocker Silent Encryption - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of updating the existing profile. BitLocker PIN # So how about setting this BitLocker PIN then?\nWell to remove a user from the equation, we can deploy a PowerShell script to set the BitLocker PIN based on the serial number of the device.\nCIS (BL) BitLocker TPMandPIN - Windows 11 Intune 3.0.1.ps1 Try { $osVolume = Get-BitLockerVolume | Where-Object { $_.VolumeType -eq \u0026#39;OperatingSystem\u0026#39; } # Detects and removes existing TpmPin key protectors as there can only be one if ($osVolume.KeyProtector.KeyProtectorType -contains \u0026#39;TpmPin\u0026#39;) { $osVolume.KeyProtector | Where-Object { $_.KeyProtectorType -eq \u0026#39;TpmPin\u0026#39; } | ForEach-Object { Remove-BitLockerKeyProtector -MountPoint $osVolume.MountPoint -KeyProtectorId $_.KeyProtectorId } } # Sets a recovery password key protector if one doesn\u0026#39;t exist, needed for TpmPin key protector if ($osVolume.KeyProtector.KeyProtectorType -notcontains \u0026#39;RecoveryPassword\u0026#39;) { Enable-BitLocker -MountPoint $osVolume.MountPoint -RecoveryPasswordProtector } # Configures the PIN and Enables BitLocker using the TpmPin key protector $deviceSerial = (((Get-WmiObject -Class win32_bios).Serialnumber).ToUpper() -replace \u0026#39;[^a-zA-Z0-9]\u0026#39;, \u0026#39;\u0026#39;) If ($deviceSerial.length -gt 14) { $deviceSerial = $deviceSerial.Substring(0, 14) # Reduce to 14 characters if longer } $devicePIN = ConvertTo-SecureString $deviceSerial -AsPlainText -Force Enable-BitLocker -MountPoint $osVolume.MountPoint -Pin $devicePIN -TpmAndPinProtector -ErrorAction SilentlyContinue | Out-Null # Gets the recovery key and escrows to Entra (Get-BitLockerVolume).KeyProtector | Where-Object { $_.KeyProtectorType -eq \u0026#39;RecoveryPassword\u0026#39; } | ForEach-Object { BackupToAAD-BitLockerKeyProtector -MountPoint $osVolume.MountPoint -KeyProtectorId $_.KeyProtectorId } Exit 0 } Catch { $ErrorMessage = $_.Exception.Message Write-Warning $ErrorMessage Exit 1 } The script, in short will carry out the following:\nRemoves any existing TpmPin key protectors, as there can only be one #highlander. If a Recovery Key key protector doesn\u0026rsquo;t exist, it will create one. Get the serial number of the device, converting it to uppercase, and shortening it to the first 14-characters if it\u0026rsquo;s longer than that. Creates a new TpmPin key protector with the PIN set to the converted serial number. Backups the recovery key to Entra. It can then be deployed to your Windows Autopilot devices using a Platform Script in Microsoft Intune in conjunction with the supplemental policy we created, with the below settings:\nBitLocker Platform script settings in Microsoft Intune. Using a Platform script over a remediation script allows this to be run (maybe) during Windows Autopilot, or if you\u0026rsquo;re fancy and using the new Windows Autopilot device preparation method, actually guarantee that it runs during the deployment.\nFor our test Windows Autopilot device with the inventive serial number qwertyuiopasdfghjklzxcvbnm, set using Advanced Settings Editor for Hyper-V Virtual Machines and by running a hand across a keyboard\u0026hellip;\nWindows Autopilot device serial number. We can see that after restarting during Windows Autopilot (forced by another CIS setting, but more on that another time), the device is now asking for a BitLocker PIN, and low and behold it\u0026rsquo;s the first 14-characters of the device serial number in uppercase:\nAfter deploying the PowerShell script, remember to tell your end users what their BitLocker PIN is, and get them to change it themselves within Windows after the Windows Autopilot deployment has completed.\nThe CIS (BL) BitLocker TPMandPIN - Windows 11 Intune 3.0.1.ps1 PowerShell script should be added to a Platform script in Microsoft Intune, but feel free to test it manually first. Thunderbolt DMA Protection # We\u0026rsquo;ve looked at DMA (Direct Memory Access) settings previously, but looking at exceptions to security hardening not the implementation of them, but we\u0026rsquo;re familiar with what they are at least.\nThe settings in the CIS profile basically reduce two threat types to BitLocker; what it actually does from an end user experience perspective, is stop peripherals connected to a dock using a Thunderbolt port connection to a Windows device from being used prior to logon.\nCIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Prevent installation of devices that match any of these device IDs Enabled Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Also apply to matching devices that are already installed. True Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Prevented device IDs PCI\\CC_0C0A Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Prevent installation of devices using drivers that match these device setup classes Enabled Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Also apply to matching devices that are already installed. True Administrative Templates \u0026gt; System \u0026gt; Device Installation \u0026gt; Device Installation Restrictions Prevented Classes {d48179be-ec20-11d1-b6b8-00c04fa372a7}, {7ebefbc0-3200-11d2-b4c2-00a0C9697d07}, {c06ff265-ae09-48f0-812c-16753d7cba83}, {6bdd1fc1-810f-11d0-bec7-08002be2092f} To further secure BitLocker and protect from attacks, additional controls exist in the same CIS policy to disable standby power states:\nCIS (BL) BitLocker - Windows 11 Intune 3.0.1 Category Setting Value Administrative Templates \u0026gt; System \u0026gt; Power Management \u0026gt; Sleep Setting Allow standby states (S1-S3) when sleeping (on battery) Disabled Administrative Templates \u0026gt; System \u0026gt; Power Management \u0026gt; Sleep Setting Allow standby states (S1-S3) when sleeping (plugged in) Disabled Leaving us only with one potential exposure of the three in the linked article:\nSystems that are left turned on. Systems that are left in the Standby power state. Systems that use the TPM-only BitLocker protector. We can\u0026rsquo;t do much about devices that are left turned on sadly, short of powering down systems programmatically, which isn\u0026rsquo;t going to please anyone, so these DMA settings are going to have to stay exactly as they are.\nMiscellaneous Settings # So this won\u0026rsquo;t be the first example of where it\u0026rsquo;s important to review the benchmark documentation and not just use the build kit, as there are additional BitLocker settings under section 86.1.4 (BL) Ensure \u0026lsquo;Enumeration policy for external devices incompatible with Kernel DMA Protection\u0026rsquo; is set to \u0026lsquo;Enabled: Block All\u0026rsquo; surrounding device enumeration policies and more DMA protection:\nExtract of the CIS 3.0.1 benchmark for BitLocker section 86.1.4 This setting now exists within Settings Catalog, so we no longer need a Custom Profile, as pointed out in the CIS Intune community (which we have finally joined üòÖ) To meet these additional requirements, we did need to configure a new Custom Profile, in Microsoft Intune to align to the DeviceEnumerationPolicy recommendation in the benchmark, but now we can just use a Settings Catalog profile instead.\nCIS (BL) BitLocker Misc - Windows 11 Intune 3.0.1 Category Setting Value Dma Guard Device Enumeration Policy Block all (Most restrictive) Which was created based on the details in the Policy CSP article. This is another device impact setting, adding to the Thunderbolt DMA protection settings, and stopping DMA capable devices that cannot be sandboxed, remapped, or isolated in memory.\nBe cautious though, as this policy setting does require a restart, but doesn\u0026rsquo;t force one.\nYou can now import the CIS (BL) BitLocker Misc - Windows 11 Intune 3.0.1 into your Microsoft Intune tenant instead of having to use a Custom profile. Summary # So that\u0026rsquo;s all there is to the CIS benchmark for Windows 11 BitLocker security in Microsoft Intune, pretty simple really üòÖ.\nWe hope you now have a good grasp on exactly what the benchmark and policy settings are doing regarding BitLocker and the security around it, why the policies are applying these settings, and importantly how to improve and work with the restrictions to make not only the implementation in Microsoft Intune more straight forward, but also the end-user experience.\nThis saves you just implementing the benchmark build kit settings in Microsoft Intune and being all when your devices don\u0026rsquo;t just encrypt themselves, or your keyboards connected to docks don\u0026rsquo;t work at the sign-in screen.\nNext up for us in the series are the CIS Level 1 settings, and if you thought the BitLocker settings were painful, you\u0026rsquo;re in for a shock üòÜ.\n","date":"15 June 2024","externalUrl":null,"permalink":"/posts/windows-cis-patching-gaps-part1/","section":"Posts","summary":"Everyone loves a security benchmark, and with the imminent move to Windows 11 for everyone, the Center for Internet Security released version 3.0.1 of theirs, including a build kit for Microsoft Intune, but what does this build kit break for BitLocker encryption?","title":"Patching Gaps in the CIS Windows 11 Benchmark - BitLocker","type":"posts"},{"content":"I don\u0026rsquo;t usually write \u0026ldquo;how-to\u0026rdquo; guides, let alone write topics that aren\u0026rsquo;t deeply embedded with Microsoft Intune or PowerShell, but I recently hit an issue when trying to setup a Windows Autopilot ARM based virtual machine using UTM on my Apple Silicon (humble brag) based macOS device.\nWith the recent announcement of the next generation of Windows Autopilot and Windows Autopilot device preparation now being official, I imagine there are now more and more people that are using macOS devices but need to test Windows Autopilot in a Virtual Machine, and thought, here\u0026rsquo;s an easy on trend blog post, that I should share the solution to the issue I encountered.\nAs always though, before you go and jump to how I fixed the problem, you should probably read the entire post to get a full picture of the scenario.\nWindows Virtualisation # As I spent all my pocket money on a MacBook Air M1, I\u0026rsquo;ve got none left to pay for virtualisation apps, so I use UTM; I mean, it\u0026rsquo;s also a lot better to use than others out there, and supports virtualising many operating systems natively without emulation, including Windows 11 ARM versions.\nSo if you\u0026rsquo;re not using UTM, go and download it from the website, or install it using Homebrew if you\u0026rsquo;re that way inclined:\nbrew install utm Before we go and setup a new Virtual Machine, we need to get the Windows 11 installation media, otherwise we\u0026rsquo;re not going to make any progress.\nWindows Installation Images # To make life a lot easier when downloading the supported iso files for Windows 11 ARM, I\u0026rsquo;d suggest installing CrystalFetch. This gives a user interface to downloading the Windows installation image, without having to build them yourself.\nYou can download CrystalFetch either from the App Store, or again install it with Homebrew:\nbrew install crystalfetch Once you\u0026rsquo;ve installed CrystalFetch, launch it and kick off the download of the version of Windows 11 you want:\nCrystalFetch preparing to download Windows 11 ARM en-gb. I had success with the en-gb variant of the Windows 11 ARM iso, the en-us just didn\u0026rsquo;t want to complete the download and build. Now that we have our installation media downloaded, we can go setup a new Virtual Machine in UTM.\nVirtual Machine Setup # Opening UTM, you\u0026rsquo;ll need to select Create a New Virtual Machine, then following along with the video below to configure it:\nNow that we have our Virtual Machine configured, time to power it on and install Windows.\nCheck me out recording videos instead of screen-shotting everything a thousand times\u0026hellip;for those interested I use Kap. Windows 11 Installation # After starting the machine, smush the keyboard when prompted to boot from the iso that we attached during the setup, we should have all at least installed Windows 11 once before, but watch the video if you need a refresh.\nWe\u0026rsquo;re not bothering with a product key, as a) I cba typing one out, and b) we can just use Microsoft Intune or Subscription Activation to sort out keys and the license later on.\nMake sure that you do actually have a way to apply a license otherwise big bad Microsoft will be knocking at your door asking you to pony up some cash. Windows Autopilot Preparation # With our newly built Windows 11 ARM Virtual Machine now available and booted, for the original Autopilot deployment configuration we still need to capture the hardware hash from the device and upload this to Microsoft Intune.\nI\u0026rsquo;m a great fan of the work Michael Niehaus has done to improve the Windows Autopilot process overall, so we\u0026rsquo;re using a PowerShell script based on his initial version to get the hardware hash.\nHardware Hash ID # We can start this capture process by running the below commands after launching a CMD prompt using Shift+F10 on the keyboard:\nRun powershell from the CMD prompt. Run Set-ExecutionPolicy Bypass to allow the installation of scripts. Run Install-Script Get-WindowsAutopilotInfoCommunity and accept all prompts. Run Get-WindowsAutopilotInfoCommunity.ps1 -Online to capture the hardware hash, authenticate to Microsoft Entra, and upload the hardware hash to Microsoft Intune. If you want a break down of the script, check out this post. You can see the overall process in the video below:\nNow after we\u0026rsquo;ve authenticated to Microsoft Entra, there appears to be an issue\u0026hellip;PowerShell you\u0026rsquo;ve got red on you.\nFailing to get the hardware hash from the device. We don\u0026rsquo;t need to be a genius here to see that the error given relates to a lack of serialNumber on the virtual machine itself, which is required to build the hardware hash value that we need to add the device to Microsoft Intune as an Autopilot device.\nSo what gives?\nAdding a Serial Number # Well sadly our Virtual Machine is missing a serial number, it can\u0026rsquo;t pull a rogue one through from the macOS host like it would using Hyper-V on a Windows host, and UTM isn\u0026rsquo;t giving it one. So I guess we need to sort this out ourselves.\nAs UTM is built upon QEMU we have the ability to pass through QEMU parameters to the Virtual Machine, one of which gives us the option to configure a serial number. Wonderful.\nGo ahead and gracefully shutdown your Windows Virtual Machine, and right click and select edit in UTM:\nUTM Virtual Machine edit menu. Then navigate to QEMU \u0026gt; Arguments:\nUTM Virtual Machine QEMU parameters. Selecting New we can add in the following line:\n-smbios Followed by selecting New again, to add in the below where XXXXXXXX is the value of a serial number:\ntype=1,serial=XXXXXXXX I use this site to generate a random one. So for example:\ntype=1,serial=DNuesTLjtKit Which should look like the below in the parameters:\nSerial number parameters in the QEMU parameter settings in the Virtual Machine. Select Save, which on the screenshot is the button next to Cancel but for whatever reason in dark mode you can\u0026rsquo;t see the text.\nWindows Autopilot Deployment # Now we\u0026rsquo;ve added in the required serial number, go ahead and power on the Virtual Machine and we\u0026rsquo;ll try the capture again.\nAs we\u0026rsquo;ve already installed the required modules and set the PowerShell execution policy, we just need to launch the CMD prompt again using Shift+F10, running the below commands:\nRun powershell from the CMD prompt. Run Get-WindowsAutopilotInfoCommunity.ps1 -Online There are other parameters you can use with this script, but we\u0026rsquo;ll keep it simple for now. If you\u0026rsquo;ve done all this in good time, your original authentication token will still be valid, if not you will be prompted to authenticate to Entra again, either way the script should happily run and capture the hardware hash:\nI didn\u0026rsquo;t record audio with the video so just hum some royalty free music to yourself. We can see now that as the device has a serial number, the PowerShell script can successfully capture the hardware hash and upload this to Microsoft Intune:\nCompleted synchronisation of a new Windows Autopilot device. We can check the progress of the upload in Microsoft Intune, so navigate to Devices \u0026gt; Enrollment and under the Windows Autopilot heading select Devices, and we should now see our newly uploaded device:\nWindows Autopilot Devices in Microsoft Intune. We could have assigned a Group Tag as part of the PowerShell script using:\nGet-WindowsAutopilotInfoCommunity.ps1 -Online -GroupTag Entra But I didn\u0026rsquo;t, so assigning that Group Tag now will allow for a Deployment Profile to be assigned:\nWindows Autopilot devices with Group Tag and profile assigned in Microsoft Intune. We can now restart our Windows 11 device, and low and behold it\u0026rsquo;s ready to start the Windows Autopilot deployment process:\nVirtual Machine starting the Windows Autopilot Deployment. Or if you really want to watch the more of the process:\nRight, that\u0026rsquo;s it, a new Windows 11 ARM Autopilot device enrolled in your Microsoft Intune tenant and ready for you to do whatever you want with it.\nSummary # This might have seemed like a long winded post for something as simple as adding in two parameters to the Virtual Machine in UTM, and you\u0026rsquo;re right, it was.\nBut now that you know how to add a serial number to a Windows 11 Virtual Machine on macOS, you can always utilise this with some of the optional steps for Windows Autopilot device preparation, using Corporate Device Identifiers allowing for uploading of Windows device identifiers (serial number, manufacturer, model) ensuring that only trusted devices go through Windows Autopilot device preparation, (once it\u0026rsquo;s no longer a known issue üòû).\nAt least now you can test your Windows settings on an new Window 11 Autopilot device from the comfort of your precious macOS device, just like I do üòÖ.\nIf you want an overview Windows Autopilot device preparation and the corporate device identifier process, I recommend this article from Joost Gelijsteen. ","date":"3 June 2024","externalUrl":null,"permalink":"/posts/macos-windows-autopilot-utm/","section":"Posts","summary":"With all this chat about macOS device management in Microsoft Intune, I wonder how many people are macOS users but still need to test Microsoft Intune settings on Windows devices? Well fear not, there is a way to deploy a Windows Autopilot Virtual machine on your macOS device for testing.","title":"Creating Windows Autopilot Virtual Machines on macOS","type":"posts"},{"content":"","date":"3 June 2024","externalUrl":null,"permalink":"/tags/device-enrolment/","section":"Tags","summary":"","title":"Device Enrolment","type":"tags"},{"content":"","date":"18 May 2024","externalUrl":null,"permalink":"/tags/graph/","section":"Tags","summary":"","title":"Graph API","type":"tags"},{"content":"","date":"18 May 2024","externalUrl":null,"permalink":"/series/risk-based-windows-11-feature-update-deployment/","section":"Series","summary":"","title":"Risk Based Windows 11 Feature Update Deployment","type":"series"},{"content":"Finally we\u0026rsquo;re at the end of the series, where be bring all the components together from the previous three posts into one sub par suitable looking PowerShell script, allowing us to not only kick off the Feature Update Readiness report, but capture the risk state for each device, tag each device using Extension Attributes, and then automatically group these devices with Dynamic Security Groups in order to deploy our Windows 11 23H2 Feature Update to low risk devices whilst we give our selves breathing space to fix the others.\nLet\u0026rsquo;s get down, let\u0026rsquo;s get down to business.\nScript Overview # Before I let you loose with the script, and suggest that you go off and run this against your environment, let me talk you through what it actually does:\nConnects to Microsoft Graph - taking the tenantId and scopes from the script parameters, connects using Connect-MgGraph using the \u0026lsquo;Microsoft.Graph\u0026rsquo; PowerShell module. Tells you what the script will do - gives you an overview of what the script will actually do, I know, how kind of me. Gives you the rules for the Dynamic Security Groups - this is based on the extensionAttribute and featureUpdateBuild parameters selected when initially running the script, I could have automated this, but everyone has their own naming conventions so I cba. Gives you the option to stop the script - yeah, even I have panic moments when running these types of scripts, so it at least gives you the option to Alt+F4 out of it. Checks that the extensionAttribute selected isn\u0026rsquo;t already populated with something else - this one is key, I don\u0026rsquo;t want you blaming me when the script goes and overwrites an extensionAttribute you\u0026rsquo;re using for something else. If it finds any device with data in the selected extensionAttribute other than something the script has set, it\u0026rsquo;ll bin out the script. Gets all Windows devices from Entra ID - will enumerate all your Windows devices in Entra ID, as we need their objectID to allow us to add extension attributes to. Kicks off and waits for a Windows Feature Update Readiness report - using the featureUpdateBuild parameter, will start a report, wait for it to complete, then capture all the risk data. Prompts if you want to assign extension attributes - this is your final call for running away, nothing so far has been modified or updated, so use this as your option to escape if you need to. Assigns the risk based extension attributes - this is the bulk of the work, and with a little patience, depending on how many devices you actually have, will go and tag devices with their Feature Update risk rating on the extensionAttribute you chose. That\u0026rsquo;s all there is to it.\nImportantly this script can be run many many times, as we want to ensure that your devices are getting tagged with the correct risk, or if their risk has changed that it get\u0026rsquo;s updated, or if they haven\u0026rsquo;t reported back to Microsoft Intune with their readiness state, or if Microsoft have taken 52 hours to process the data and it\u0026rsquo;s only just appeared. Running the Script # So now you have an overview of what the script üòá actually does, let\u0026rsquo;s see how we start it and what the output looks like.\nIf we want to start our journey to Windows 11 23H2, and by now you should really be looking at starting this migration, as it\u0026rsquo;s not that long until the support for Windows 10 ends, we can run the PowerShell script using the below, passing in your Entra ID Tenant ID to tenantId, the selected featureUpdateBuild, in this case 23H2, and your extensionAttribute of choice:\n.\\Invoke-Windows11Accelerator.ps1 -tenantId \u0026#39;36019fe7-a342-4d98-9126-1b6f94904ac7\u0026#39; -featureUpdateBuild \u0026#39;23H2\u0026#39; -extensionAttribute \u0026#39;15\u0026#39; -target \u0026#39;device\u0026#39; -deploy The script has been updated to support different targets, either user or device, along with an option to run this in demo mode without the deploy switch. Deployment Preparation # Following the authentication to Microsoft Graph PowerShell with Connect-MgGraph, with the scopes configured in the script as Group.ReadWrite.All, Device.ReadWrite.All, DeviceManagementManagedDevices.ReadWrite.All, DeviceManagementConfiguration.ReadWrite.All, we\u0026rsquo;re presented with the first stage in the process:\nThe start of the Get Ready for Windows 11 PowerShell script. Providing us with the information I promised it would, including the generated Dynamic Security Group rules allowing your to create them in Entra ID to support the Windows 11 23H2 Feature Update deployment:\nGroup Rule Low Risk (device.extensionAttribute15 -eq LowRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Medium Risk (device.extensionAttribute15 -eq MediumRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) High Risk (device.extensionAttribute15 -eq HighRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Not Ready (device.extensionAttribute15 -eq NotReady-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Unknown (device.extensionAttribute15 -eq Unknown-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Getting Device Information # Blindly continuing the script, as so far the script has actually done nothing, it will happily go and get all your Windows devices from Entra ID, and check if there is any existing data we don\u0026rsquo;t want, in the selected extensionAttribute15, for us this time, we\u0026rsquo;re all clear, so it continues and starts the Feature Update Readiness report for Windows 11 23H2, and processes all the associated data:\nThe confirmation section of the Get Ready for Windows 11 PowerShell script. If there was data in extensionAttribute15 for any device in Entra ID, then the script would break at this point telling you to go do your homework on extensionAttributes. Now that we have details of all the devices, from both Entra ID and the Feature Update Readiness report, we\u0026rsquo;re ready to start tagging devices.\nThis is your last chance to bail out.\nRisk Tagging Devices # Now that you\u0026rsquo;ve not bottled it continued with the script, congratulations you\u0026rsquo;re on your way to delivering Windows 11 23H2 to your device estate, with the script happily churning away through the data and devices, assigning each and every one in scope of the Feature Update Readiness report.\nEach device will now be tagged on your selected extensionAttribute with their associated update risk status from:\nLow risk - There are no known compatibility risks associated with the device. Medium risk - There are only minor, or non-blocking, compatibility risks associated with this device, such as applications that are automatically removed during upgrade. High risk - There are multiple or blocking compatibility risks associated with this device, such as applications that block an upgrade. Not ready - The device isn\u0026rsquo;t capable of upgrading to the target OS version. Unknown - A readiness status couldn\u0026rsquo;t be determined. Ensure that the device is properly configured to send Windows diagnostic data. In the format of [RiskState]-W11-[FeatureUpdate] i.e., LowRisk-W11-23H2, NotReady-W11-23H2.\nThe assignment section of the Get Ready for Windows 11 PowerShell script. I thought I\u0026rsquo;d colour code the output of this section, though it serves no purpose other than to look nice.\nWhat it does show though, are devices being assigned to their respective risk rating where appropriate, and when a device has been updated to Windows 11 23H2, it will clear the extensionAttribute. If you\u0026rsquo;ve created the Dynamic Security Groups based on the rules provided by the script, they should now start slowly populating with devices.\nLeaping back to part three in the series, you\u0026rsquo;re now in a position to create your Feature Update profiles, allowing you to safely deploy the Windows 11 23H2 Feature Update to your devices categorised as low risk, whilst you assign someone else in your team to investigate the issues with the medium and high risk devices üòÇ.\nRemember, this script is designed to run multiple times, so after your first run, you should probably set a reminder to run it again and again until either your number of \u0026lsquo;unknown\u0026rsquo; devices is zero, or close enough that you\u0026rsquo;re comfortable to move forward with the deployment of the Feature Update. Summary # Yes I know the script could have done more, it could have created the Dynamic Security Groups and the Feature Update profiles, and assigned them whilst it was there, but two things here, firstly no-one should just blindly run a script that punts a brand new operating system out to devices, and secondly, I wouldn\u0026rsquo;t have been able to create a series of blog posts explaining each step of the way if I\u0026rsquo;d done all the work for you in PowerShell.\nThe script, and the content of this series gives you a better understanding on how to leverage the existing information in Microsoft Intune to assist you with deploying Windows 11 23H2, well in time for the end of support date of Windows 10. It also allows you to start the deployment of the Feature Update to known low risk devices, giving you more time to investigate those with applications or drivers that are going to get removed during the update, or will block the Feature Update entirely.\nAll in all, this is a great place to start with deploying Windows 11 23H2, but it isn\u0026rsquo;t the end of your process. It is however the end of this series.\n","date":"18 May 2024","externalUrl":null,"permalink":"/posts/windows-11-risk-based-deployment-part4/","section":"Posts","summary":"The final part in this series looks at how to bring everything together under a single, repeatable script, allowing for the capture of readiness state, the tagging of devices to support the distribution of Windows 11 23H2.","title":"Risk Based Windows 11 Feature Update Deployment - Automation","type":"posts"},{"content":"","date":"8 May 2024","externalUrl":null,"permalink":"/tags/conditional-access/","section":"Tags","summary":"","title":"Conditional Access","type":"tags"},{"content":"","date":"8 May 2024","externalUrl":null,"permalink":"/tags/configuration/","section":"Tags","summary":"","title":"Configuration","type":"tags"},{"content":"So it\u0026rsquo;s finally here, after all the coming soon announcements, and the promise that we can use Entra ID authentication methods on macOS devices, we now have Platform SSO at our disposal in Microsoft Intune, well at least in Public Preview.\nI\u0026rsquo;m not going to deep dive into configuring Platform SSO as I\u0026rsquo;ll assume you\u0026rsquo;ve either already had a go yourself, or found someone else who has, as honestly it\u0026rsquo;s now a massive selling point of moving macOS devices into Microsoft Intune away from other MDM solutions.\nNow we can use Entra ID account for SSO on the macOS device itself, what about our good friend the web browser, and in particular Google Chrome?\nBrowser Support # If like me you\u0026rsquo;ve been patiently waiting for Platform SSO to appear, you\u0026rsquo;ve probably already looked at the pre-requisites for configuration, so let\u0026rsquo;s just assume you\u0026rsquo;ve done these already, or you\u0026rsquo;re a least aware of them, and if you haven\u0026rsquo;t sorted them, crack on and sort yourself out.\nThe bit we\u0026rsquo;re interested in is the supported browsers, and shock, both Microsoft Edge and Safari are supported out the box already (ish). Google Chrome however needs a little more convincing, as it does on Windows, to work with Single Sign On configurations.\nPlatform SSO requires you install and enable the Windows Accounts extension. You can add the app to Intune, and assign it to the devices that use Google Chrome.\nThat last line is interesting though Microsoft, as deploying Google Chrome extensions isn\u0026rsquo;t as easy as click click next OK.\nLuckily though, Microsoft have provided links to setting up Google Chrome on macOS and how to configure the forced installation of extensions which we\u0026rsquo;ll be utilising to make Google Chrome and Platform SSO play nicely.\nConfiguring this extension will not only improve the users sign-in experience, but allow for the use of Conditional Access Policies when using Google Chrome:\nmacOS devices using the Enterprise SSO plugin require the Microsoft Single Sign On extension to support SSO and device-based Conditional Access in Google Chrome.\nPlatform SSO Configuration # Yes, I did say I wasn\u0026rsquo;t going to dig into the Platform SSO configuration, but without actually configuring it we\u0026rsquo;re not going to be able to utilise the authentication method into Google Chrome, so if you cba following the Microsoft Learn article have a look at the below, and the exported JSON which you can import into your own Microsoft Intune tenant if you\u0026rsquo;re lazy productive with your time.\nCategory Setting Value Authentication Authentication Method (Deprecated) UserSecureEnclaveKey Authentication Screen Locked Behavior Do Not Handle Authentication Registration Token {{DEVICEREGISTRATION}} Authentication Team Identifier UBF8T346G9 Authentication Extension Identifier com.microsoft.CompanyPortalMac.ssoextension Authentication Type Redirect Authentication URLs https://login.microsoftonline.com https://login.microsoft.com https://sts.windows.net https://login-us.microsoftonline.com https://login.microsoftonline.us Authentication \u0026gt; Platform SSO Account Display Name MEM v ENNBEE Account Authentication \u0026gt; Platform SSO Authentication Method UserSecureEnclaveKey Authentication \u0026gt; Platform SSO Enable Authorization Enabled Authentication \u0026gt; Platform SSO Enable Create User At Login Enabled Authentication \u0026gt; Platform SSO Login Frequency 64800 Authentication \u0026gt; Platform SSO New User Authorization Mode Standard Authentication \u0026gt; Platform SSO Use Shared Device Keys Enabled Authentication \u0026gt; Platform SSO User Authorization Mode Standard This settings catalog profile is configured to use UserSecureEnclaveKey for Passwordless authentication, but feel free to amend any other settings in the Microsoft Learn article as you see fit.\nAssigning this to a group of test devices, yes I do actually test things, you should get the glorious device registration and sign-in experience with Entra ID credentials we\u0026rsquo;ve all been after.\nIf you encounter issues with the Entra Join and registration, have a look at the troubleshooting guide for Platform SSO, specifically the Entra Join permissions. Google Chrome Deployment # With the Platform SSO configuration setup and deployed, we can now focus our attention on how we manage Google Chrome on macOS devices, including delivering the app, as well as configuring it to support the required Microsoft Single Sign On extension.\nI shouldn\u0026rsquo;t be teaching you all to suck eggs, but for completions sake, we should probably go through deploying Google Chrome to your Microsoft Intune enrolled macOS devices, and we\u0026rsquo;ve got a couple of ways to do this, depending on whether you want to force install this on your end user devices, or allow the app to be installed by the user.\nRequired App Deployment # If you just want to get the latest version of Google Chrome out there to all assigned devices, then the easiest approach is to use a Shell Script and in particular the one in the shell-intune-samples GitHub repository, which will run on a device, got get the latest Google Chrome version download, and install it.\nSetting Value Upload Script installGoogleChrome.zsh Run script as signed-in user No Hide script notifications on devices Not configured Script frequency Not configured Max number of times to retry if script fails 3 times Shell Script for deploying Google Chrome to macOS devices in Microsoft Intune.. After your assigned group of test devices check in to Microsoft Intune and the script runs successfully, your devices should download and install Google Chrome.\nIf you want to see progress or errors with the script, the script log file is located in /Library/Logs/Microsoft/IntuneScripts/GoogleChrome on the targetted macOS device. Available App Deployment # If you want to make the app available to your end users via the Company Portal, and who doesn\u0026rsquo;t love self-service, then go ahead and download the pkg installer.\nAs we\u0026rsquo;re looking to make the app available our only option in Microsoft Intune is to upload the file using the Line-of-business app, as pkg apps although great for pre and post deployment scripts, don\u0026rsquo;t give the option for making apps available in the Company Portal.\nSetting Value Select file GoogleChrome.pkg Name Google Chrome Description Chrome is the official web browser from Google, built to be fast, secure and customisable. Download now and make it yours Publisher Google Minimum operating system Catalina 10.15 Ignore app version Yes Install as managed No Included apps com.google.Chrome 124.0.6367.119 Publisher Google Line-of-business app for deploying Google Chrome to macOS devices in Microsoft Intune. Deploying this app to a group of users, will allow your end users to select the option to install Google Chrome on their macOS device from the Company Portal:\nCompany Portal available apps. Two of many potential methods to install Google Chrome now sorted, onto what we\u0026rsquo;re here for in the single sign on configuration.\nGoogle Chrome Configuration # Google being quite a large enterprise, realise that you might want to actually configure Google Chrome on your devices, and give you examples of property list files for configuring the app on macOS devices as part of their Chrome Browser bundle, but we\u0026rsquo;re looking for specific settings today, around the requirement to force install a specific of extension to support Platform SSO.\nCustom Configuration Profiles # Using the examples provided by Google, we have a basis to create our custom mobileconfig file, which when complete, can be uploaded to Microsoft Intune and deployed to our macOS devices.\nAs we\u0026rsquo;re focusing solely on the forced installation of the Microsoft Single Sign On extension, we can strip out everything else from the example, and can update the configuration file to install the extension we want.\nWe need to update the settings under the key installation_mode setting the string value to force_installed, this in conjunction with the ID of the extension we want to force install ppnbnpeolgkicgegkbkbjmhlideopiji (which we can get from the extension URL itself), allows us to configure a custom profile for Google Chrome to ensure that the extension that unlocks all the Platform SSO goodness is deployed to devices with Google Chrome installed.\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;com.google.Chrome\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;Forced\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;mcx_preference_settings\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;ExtensionSettings\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;ppnbnpeolgkicgegkbkbjmhlideopiji\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;installation_mode\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;force_installed\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;update_url\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;https://clients2.google.com/service/update2/crx\u0026lt;/string\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Google Chrome Platform SSO Extension Settings\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.google.Chrome.extensions.platformsso\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.ManagedClient.preferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;0f644bb2-a1e0-4a90-a093-934f32e126de\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Google Chrome Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Google Chrome Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.google.Chrome\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;MEM v ENNBEE\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadRemovalDisallowed\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadScope\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;System\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;a01d7a80-6db0-4392-a8a9-989147fb2aa1\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; The other settings in the profile ensure that the profile is installed in the system context and cannot be removed by an end user.\nThe PayloadUUID keys should be unique to your environment, so go ahead and generate new ones for your own profile. Custom Template # Now armed with our saved mobileconfig profile, we can create a new macOS Configuration Profile, using the Template profile type, and selecting Custom, giving the profile a name by smashing your hand on the keyboard aligned to your naming convention, we can then complete the remaining sections of the profile uploading the mobileconfig profile we saved previously:\nSetting Value Custom configuration profile name Google Chrome Platform SSO Profile Deployment channel Device channel Configuration profile file GoogleChromepSSO.mobileconfig Custom Profile in Microsoft Intune for macOS. Give the configuration profile a suitable name, I\u0026rsquo;ve gone with Google Chrome Platform SSO Profile, as really you\u0026rsquo;re only going to see this on the device itself under the Profile section of System Preferences.\nAs the custom profile sets the PayloadScope as System our Deployment channel should be set to Device channel. We should probably assign this profile to our test devices, so go ahead and do that, and after a while we should get some greens:\nCustom Profile Report in Microsoft Intune for macOS. Checking on the assigned macOS 14 test device itself under System Preferences \u0026gt; Privacy \u0026amp; Security \u0026gt; Profiles we can see the profile has installed correctly:\nThe profile installed under System Preferences. One last thing to look at, and that\u0026rsquo;s the extensions in Google Chrome itself:\nGoogle Chrome installed extensions. It is, and the user is unable to disable or remove it, as why would we want them to?\nSo what does SSO look like on Google Chrome with Secure Enclave key authentication? Well it\u0026rsquo;s the same process as with Microsoft Edge and Safari:\nA user opens the browser and accesses a Microsoft Entra authenticated service such as outlook.office.com. If there is a valid token for the user, the user is not prompted to sign-in to the service, otherwise re-authentication with TouchID is required before access. Subsequent login prompts to Microsoft Entra authenticated services like teams.microsoft.com are now automatically passed through using SSO. All that to make browser sign-ins a little easier and to allow for the use of Conditional Access Policies üòÖ.\nIf you encounter issues with Google Chrome SSO, please refer to the Microsoft Learn documentation. Summary # Platform SSO on macOS in Microsoft Intune is a big thing, it\u0026rsquo;s likely the last hurdle or excuse people were using to stay away from using a Microsoft product to manage an Apple device.\nIf you\u0026rsquo;re already in bed with Microsoft and associated services, then something as trivial as where your precious Apple devices are managed shouldn\u0026rsquo;t be stopping you from jumping two footed straight into enrolling your macOS devices into Microsoft Intune, especially now that you can use Entra ID authentication across them.\nOn top of this, we can now configure the most used browsers on a macOS device to leverage and make use of Platform SSO, to stop users from being bogged down with sign-in prompts that their colleagues on low-spec Windows laptops don\u0026rsquo;t have to deal with.\nIt\u0026rsquo;s a win win in my books.\n","date":"8 May 2024","externalUrl":null,"permalink":"/posts/macos-platformsso-google-chrome/","section":"Posts","summary":"With all the hype about Platform SSO on macOS devices, now is the time to try out not just the standard functionality, but the integration into web browsers such as Google Chrome. We take a look at how to configure this using Microsoft Intune.","title":"Configuring Google Chrome on macOS for Platform Single Sign-On","type":"posts"},{"content":"","date":"8 May 2024","externalUrl":null,"permalink":"/tags/platform-sso/","section":"Tags","summary":"","title":"Platform SSO","type":"tags"},{"content":"We\u0026rsquo;re almost there now; we\u0026rsquo;ve generated and captured the data from a Feature Update Readiness Report and we\u0026rsquo;ve tagged and grouped devices based on their readiness state using Dynamic Security Groups. All of this is useful when deploying a Windows 11 Feature Update, in this instance 23H2, to devices, so let\u0026rsquo;s look at how we actually deploy the new Feature Update to these groups of devices and get you on your Windows 11 journey.\nUsing Feature Update Profiles # Yes, I am usually against silently paywalled areas of Microsoft Intune, but there isn\u0026rsquo;t really any better way of getting devices upgraded to a Feature Update in a controlled manner, you could use Target Release Version but then you\u0026rsquo;re risking all devices updating all at once, or using deferral settings for Feature Updates in Windows Update Rings, but that all relies on the data the Feature Update is released, not ideal really.\nSo I\u0026rsquo;m sorry, if you\u0026rsquo;re not already covered by one of the (at time of writing) license pre-requisites to use Feature Update profiles then I suggest finding some cash down the back of the sofa.\nLicensing Pre-requisites # So let\u0026rsquo;s make sure you\u0026rsquo;re covered by the requirements for Feature Update first, starting with the licenses, make sure your are covered for the \u0026lsquo;Windows Update for Business deployment service\u0026rsquo; with have one of the below licenses:\nWindows 10/11 Enterprise E3 or E5 (included in Microsoft 365 F3, E3, or E5) Windows 10/11 Education A3 or A5 (included in Microsoft 365 A3 or A5) Windows Virtual Desktop Access E3 or E5 Microsoft 365 Business Premium In addition to a license for Intune, your organization must have one of the following subscriptions that include a license for Windows Update for Business deployment service.\nThat should be pretty easy to sort out, it\u0026rsquo;s only one license isn\u0026rsquo;t it Microsoft? Please don\u0026rsquo;t audit me.\nTelemetry Pre-requisites # Reading through the other requirements, one of which we already touched upon in part one, and you should have configured as part of using the Feature Update Readiness Report, is telemetry data.\nIf you\u0026rsquo;ve gotten to this part of the series and you\u0026rsquo;re still wondering why your reports are empty, it\u0026rsquo;s probably the fact that when Windows 10 was first released all those years ago, you aggressively disabled telemetry reporting for fear of Microsoft using your data.\nWell, here we are now, needed this telemetry data, go and configure a Settings Catalog profile with the settings below and assign it to all your devices, do it now.\nCategory Setting Value Description System Allow Telemetry Basic Sends all required telemetry information to Microsoft. System Configure Telemetry Opt In Change Notification Disable telemetry change notifications Stops users panicking about data, what they don\u0026rsquo;t know won\u0026rsquo;t hurt them. System Configure Telemetry Opt In Settings Ux Disable Telemetry opt-in Settings Stops users from changing telemetry settings This, once Microsoft has processed your data, will allow for the delivery of Feature Updates.\nWe\u0026rsquo;re almost done, I promise.\nService Pre-requisites # Well, who\u0026rsquo;s been caught out with the issue where monthly updates happily deploy, but you\u0026rsquo;ve been scratching your head about why Feature Updates haven\u0026rsquo;t been offered to a device yet?\nYeah me neither, but we should at least be definite with this requirement that the Microsoft Account Sign-In Assistant (wlidsvc) is not disabled.\nCategory Setting Value Description Accounts Allow Microsoft Account Sign In Assistant Manual start If this is disabled, will block the use of Feature Updates on Windows 10 and later devices. This will set the service is set to Manual (Trigger Start), which allows it to run when needed. You may as well lob the above setting into the same Settings Catalog profile as the telemetry data settings, saves creating multiple granular profiles when you\u0026rsquo;re not dealing with specific exclusions, giving us something like the below.\nMicrosoft Intune settings catalog policy. Right, on to setting up the Feature Update profiles.\nTargetting Feature Update Profiles # As we\u0026rsquo;re not using deferral settings within Windows Update Rings, and instead opting for the use of Feature Update profiles to deploy new versions of the Windows operating system, we need to set all Feature Update deferrals in our existing Update Rings to be zero, but to stop the flood of devices attempt to update to a newer version of Windows 10 or 11, before we change this setting, let\u0026rsquo;s look at how we keep devices at the required level.\nFeature Update Dynamic Groups # That\u0026rsquo;s right, more Dynamic Device Security Groups, this time we\u0026rsquo;re going to ring-fence devices based on the operating system they are currently running, and assign a corresponding Feature Update of the same version, yes this sounds a little backward when our end goal is to upgrade devices to Windows 11 23H2, but bear with me there\u0026rsquo;s logic around this.\nBased on the current (at time of writing) Feature Update versions available in Microsoft Intune, we need to create at groups for at least each of the below versions.\nMicrosoft Feature Update profile with immediate installation. So go and create some new groups in Entra ID with the below rules to capture your corporate owned Windows devices at each Feature Update version\nGroup Rule Windows 10 21H2 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOSVersion -startswith \u0026quot;10.0.19044\u0026quot;) Windows 10 22H2 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOSVersion -startswith \u0026quot;10.0.19045\u0026quot;) Windows 11 21H2 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOSVersion -startswith \u0026quot;10.0.22000\u0026quot;) Windows 11 22H2 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOSVersion -startswith \u0026quot;10.0.22621\u0026quot;) Windows 11 23H2 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOSVersion -startswith \u0026quot;10.0.22631\u0026quot;) Your mileage may vary with this, as it could be you\u0026rsquo;ve got other devices that aren\u0026rsquo;t covered by one of these Feature Update profile versions, if that is the case create dynamic device groups for these other versions too, and we\u0026rsquo;ll work out what to do with them later.\nFeature Update Version # With our grouped devices based on version at hand, we can now create Feature Update Profiles for each of these versions, configuring them to be immediately available, and assigned to the dynamic device groups we/ve just created.\nFeature Update Version Rollout options Group Windows 10, version 21H2 Make update available as soon as possible Windows 10 21H2 Windows 10, version 22H2 Make update available as soon as possible Windows 10 22H2 Windows 11, version 21H2 Make update available as soon as possible Windows 11 21H2 Windows 11, version 22H2 Make update available as soon as possible Windows 11 22H2 Windows 11, version 23H2 Make update available as soon as possible Windows 11 23H2 For your devices that are running lower versions of Windows 10, then you\u0026rsquo;ve got a couple of options, either assign the group to one of the above newly created version targeting Feature Update profiles, or, using a Settings Catalog profile with Target Release Version configured to the required version to keep your LTSC or otherwise Windows 10 devices exactly where they need to be.\nWith these now in place, we can happily remove the Feature Update deferral settings in our Windows Update rings, without the fear that devices are just going to jump to a version we don\u0026rsquo;t want them to be on, yet.\nDeployment Feature Update Profiles # Now you may be thinking, all of this is well and good, but how are we going to distribute Windows 11 23H2 after gathering compatibility data and grouping devices based on their upgrade risk, well, fear not, as there is documented behaviour when a device is in scope of multiple Feature Update profiles, in short, a device will install the most recent Feature Update version, in long\u0026hellip;\nEach Windows feature update policy supports a single update. When a device is targeted by more than one policy, it might be targeted with multiple update versions. The Windows Update service can only offer a device one feature update at a time, and always offers the latest update version that targets the device. Because Windows 11 updates are considered to be later versions than Windows 10, the service always offers the Windows 11 update to a device targeted by both Windows 10 and Windows 11 updates. This is done because deploying a Windows 11 update to a Windows 10 device is a supported upgrade path. So this behaviour is exactly what we need, a way to keep devices on their current version, until they are in scope of a newer version, in this case, Windows 11 23H2.\nDeploying Windows 11 Feature Updates # Onto the fun part, the fruition of my our hard work, being able to roll out Windows 11 23H2 safely. Let\u0026rsquo;s go and create a new Feature Update profile for Windows 11 23H2 for our low risk devices, this time instead of an immediate roll out option, we\u0026rsquo;re going to utilise the \u0026lsquo;Make update available gradually\u0026rsquo; option, which uses magic \u0026#x1fa84;.\nMicrosoft Feature Update profile with phased installation. Well it\u0026rsquo;s not necessarily magic, there must be something in the background that allows the splitting of a targeted include assignment group or groups into equal sized smaller manageable virtual groups between the start date and end date, separated by number of days between them.\nA few things to note before we go and assign this profile:\nThe start of the first group availability must be at least two days in advance of the current date, which allows the magic to happen to split the devices. The final group availability may not occur on the specified date, based on the how many days between groups has been configured, something about maths and whole numbers. Installation deadlines and grace periods in Windows Update rings are adhered to, so ensure that you have this configured to something sensible, and lower than the number of days between groups otherwise you\u0026rsquo;ll end up with overlapping deployments. We\u0026rsquo;re here, the end, we have a profile for deploying Windows 11 23H2 and we can assign this to our ready to go, low risk tagged, group of Windows 10 devices, that\u0026rsquo;s exciting.\nMicrosoft Feature Update profile assignment. With these devices telling you that they\u0026rsquo;re happy to update to Windows 11, you can safely sit back and watch the reports update with the status of the Feature Update deployment, giving you time to work through the issues reported by the medium and high risk device issues.\nOr if you\u0026rsquo;re like me, just take a chance deploying the Feature Update to the medium risk devices, I mean who cares if a driver get\u0026rsquo;s removed, you should be updating them anyway üòÇ.\nSummary # This should now give you confidence in deploying a Windows 11 Feature Update to the devices that have told you that they\u0026rsquo;re OK to update, based on the Microsoft backed information captured from the Readiness Report, starting your migration to Windows 11 from Windows 10 well before the end of support, pat yourself on the back.\nEven if all of your Windows 10 and later devices are reporting their compatibility information, this isn\u0026rsquo;t the end of the story, what if you\u0026rsquo;ve resolved some of the medium or high risk issues? What if those devices that were captured by medium or high risk tags are now reporting as low risk? What if there are new Windows 10 devices enrolled into Microsoft Intune? What if devices that had low disk space now have enough free space?\nThese are all valid questions I\u0026rsquo;ve just come up with, and in the last part of this series, I\u0026rsquo;ll be taking you through a PowerShell script that combines what we\u0026rsquo;ve covered into a fool-proof deployment that can be run regularly, ensuring that Windows 10 devices don\u0026rsquo;t get left behind.\n","date":"5 May 2024","externalUrl":null,"permalink":"/posts/windows-11-risk-based-deployment-part3/","section":"Posts","summary":"Using the data captured from a Windows 11 Feature Update Readiness report to successfully tag device attributes to device objects, and group them based on risk, we now look at how to deploy Feature Updates to these devices in a controlled manner.","title":"Risk Based Windows 11 Feature Update Deployment - Feature Updates","type":"posts"},{"content":"I\u0026rsquo;d strongly suggest, if you haven\u0026rsquo;t already, skimming over the first part of this series as this will give you a good understanding of where we started, and hopefully where we\u0026rsquo;re trying to get to with putting the Feature Update Readiness Reports in Microsoft Intune to good use allowing for a risk based deployment approach of Windows 11 23H2.\nMicrosoft Feature Update readiness report. With our precious data in hand, we can move onto how we group devices based on the risk, and hopefully make the transition to Windows 11 a relatively painless one.\nDevice Attributes # Those with a keen pair of eyes, may have spotted a previous post allowing the tagging of a device using device attributes for exceptions to Conditional Access Policies, and I may have hinted at the time that these attributes may have other uses. Well guess what, they do.\nWe can take the data from the Readiness Report, that we formatted and updated with both a string representation of the risk state, and the Entra ID computer ObjectId of the device, and use this information to tag devices with their risk state for the Windows 11 Feature Update they were assessed against. Clever eh?\nGetting Existing Device Attribute Values # We\u0026rsquo;ve already got a function to update device attributes on device objects, and I say update, as the call to Graph is using PATCH which means that it will overwrite the existing value for the attribute we want to update.\nThis is both good, as it means we don\u0026rsquo;t need to worry about changes to the devices Feature Update risk state, and bad, because we should probably check that our chosen attribute is not already used for something else, like for Conditional Access Policies exclusions.\nSo can we find a way to pull back all devices where our device attribute of choice, this time extensionAttribute15, is not empty? Sure why not.\nConnect to Graph using the latest module and Connect-MgGraph -Scopes 'Device.ReadWrite.All'. $extensionAttribute = \u0026#39;extensionAttribute15\u0026#39; $windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq \u0026#39;Windows\u0026#39; } foreach ($windowsDevice in $windowsDevices) { $attribute = ($windowsDevice.extensionAttributes | ConvertTo-Json | ConvertFrom-Json).$extensionAttribute if ($attribute){ Write-Host \u0026#34;$($windowsDevice.displayName) already has a value of \u0026#39;$attribute\u0026#39; configured in extension attribute $extensionAttribute\u0026#34; -ForegroundColor Red } } This can be run in isolation, to check before assigning the risk based device attributes whether you\u0026rsquo;re going to be overwriting anything important, as the PATCH to update the attribute is pretty destructive.\nFor our situation, we know what values to actually expect on the device attribute that are valid (LowRisk-W11-23H2, MediumRisk-W11-23H2, HighRisk-W11-23H2, NotReady-W11-23H2, Unknown-W11-23H2), so we should expand upon the above to add some depth to the logic by creating an array variable of safe extension attribute values in $safeAttributes, which will allow us to run the assignment of attribute values multiple times, which is going to be important.\n$extensionAttribute = \u0026#39;extensionAttribute15\u0026#39; $windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq \u0026#39;Windows\u0026#39; } $attributeErrors = 0 $safeAttributes = @(\u0026#34;LowRisk-W11-23H2\u0026#34;,\u0026#34;MediumRisk-W11-23H2\u0026#34;,\u0026#34;HighRisk-W11-23H2\u0026#34;,\u0026#34;NotReady-W11-23H2\u0026#34;,\u0026#34;Unknown-W11-23H2\u0026#34;) foreach ($windowsDevice in $windowsDevices) { $attribute = ($windowsDevice.extensionAttributes | ConvertTo-Json | ConvertFrom-Json).$extensionAttribute if ($attribute -notin $safeAttributes){ if ($null -ne $attribute){ Write-Host \u0026#34;$($windowsDevice.displayName) already has a value of \u0026#39;$attribute\u0026#39; configured in extension attribute $extensionAttribute\u0026#34; -ForegroundColor Yellow $attributeErrors = $attributeErrors + 1 } } } if ($attributeErrors -gt 0){ Write-Host \u0026#34;Please review the devices reporting as having existing data in the selected attribute $extensionAttribute, and run the script using a different attribute selection.\u0026#34; -ForegroundColor Red break } The above will now check to see if our selected extension attribute extensionAttribute15 contains a value not in the safe list, or not null, and increment an error variable $attributeErrors, then throw a wobbly if the value of that variable is greater than zero.\nPre-flight checks over for now, onto assigning a value to our attribute.\nUpdating Device Attributes # We\u0026rsquo;ve dealt with this function previously, so no need to go into detail on this one, but it is expecting some JSON content and an Id to be able to assign the attribute values.\nFunction Add-DeviceAttribute() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON, [parameter(Mandatory = $true)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;devices/$Id\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } Using the above and the data we have previously captured in part one in the $reportArray variable:\nUpdated Readiness report data array. We can loop through each and every device in the array, and with the values for both the RiskState and ObjectID we can happily update some attributes.\nForeach ($object in $reportArray) { $JSON = @\u0026#34; { \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;$extensionAttribute\u0026#34;: \u0026#34;$($object.RiskState)\u0026#34; } } \u0026#34;@ Add-DeviceAttribute -Id $object.ObjectID -JSON $JSON Start-Sleep -Seconds 3 } Now while totally suitable, and will work it\u0026rsquo;s way through the devices updating them based on the initial run, we need to be able to update the same extension attribute in subsequent runs, and with the call to Graph using PATCH we\u0026rsquo;re covered, but there is no RiskState for devices already upgraded to the Windows 11 Feature Update version, so devices following an upgrade and new readiness report, will still be tagged with their old risk rating.\nMaintaining Device Attributes # I\u0026rsquo;m not usually this tidy with my scripts, but we should clean up after ourselves, and as the Feature Update Readiness Report relies on a number of moving parts, no less devices themselves sending data, and the 52 hours of waiting for data to process, the aim here is to regularly run the whole script to ensure accurate assessment and tagging of devices.\nSo let\u0026rsquo;s add a little something something, and using the values from ReadinessStatus we can assess whether a device is already upgraded to our Windows 11 Feature Update version or not based on the ReadinessStatus equalling 4 and send the correct JSON data to Graph to ensure consistent assignment of the value of the extension attribute.\nForeach ($object in $reportArray) { if ($object.ReadinessStatus -ne \u0026#39;4\u0026#39;) { $JSON = @\u0026#34; { \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;$extensionAttribute\u0026#34;: \u0026#34;$($object.RiskState)\u0026#34; } } \u0026#34;@ } else { $JSON = @\u0026#34; { \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;$extensionAttribute\u0026#34;: \u0026#34;\u0026#34; } } \u0026#34;@ } Add-DeviceAttribute -Id $object.ObjectID -JSON $JSON Start-Sleep -Seconds 3 } There we go, we can tag our devices using extension attributes with their risk state, not just once, but many many times, and keep on top of devices that have been updated to Windows 11 already.\nA quick straw poll of devices in Entra ID, we can see that the tag has applied successfully:\nWe should do something sensible with these tags on the devices now.\nDynamic Security Groups # Ah my love affair between Dynamic Security Groups and Device Filters rears it\u0026rsquo;s head again, and despite the recommendations to stop using certain operators, there are still times when Dynamic Groups are going to win out over Device Filters.\nWith Feature Update deployments in Microsoft Intune not supporting the use of Device Filters, and as we\u0026rsquo;ve tagged the Entra ID object of the device, and not the Microsoft Intune object, we don\u0026rsquo;t have any say in the matter, so we have to use groups this time.\nFeature Update assignment in Microsoft Intune. So what are we doing with the groups? Well we can create dynamic device groups to capture corporate owned Windows devices based on their risk state.\nCreating Dynamic Device Security Groups # So off you go, create some groups with the below rules, and if you\u0026rsquo;ve been following along, you\u0026rsquo;ll realise that we now have ring-fenced devices based on just how ready they are to update to Windows 11. Cool eh? (rhetorical, it is obviously cool.)\nGroup Rule Low Risk (device.extensionAttribute15 -eq LowRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Medium Risk (device.extensionAttribute15 -eq MediumRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) High Risk (device.extensionAttribute15 -eq HighRisk-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Not Ready (device.extensionAttribute15 -eq NotReady-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Unknown (device.extensionAttribute15 -eq Unknown-W11-23H2) and (device.deviceOSType -eq Windows) and (device.deviceOwnership -eq Company) Give the groups a little while to populate, hopefully not 24 hours, but all being well and good, the members should flood in.\nGroup Membership Check # Ok ok, let\u0026rsquo;s not just take my word for it, after all we\u0026rsquo;re not best friends colleagues just yet, in fact I bet some of you don\u0026rsquo;t even follow me on LinkedIn üòÖ, anyway let\u0026rsquo;s look at the output of the report we initially created.\nMicrosoft Feature Update readiness report. Let\u0026rsquo;s look at the break down of devices in each risk category:\nLow Risk - 278 devices Medium Risk - 68 devices High Risk - 0 devices (lucky) Not Ready - 14 devices Unknown - 48 devices Now have a look at the obviously un-doctored screenshots of each of our Dynamic Device Security Groups:\nAnd there you have it, matchy matchy values for each of the risk types. You\u0026rsquo;ll notice there isn\u0026rsquo;t a group for the three devices already upgraded to Windows 11 23H2, as we don\u0026rsquo;t care about these ones for the purpose of a Feature Update to the same version that\u0026rsquo;s already installed.\nSummary # We\u0026rsquo;re on the home stretch now, having captured all the data we need to truly assess the readiness state of a deployment of a Windows 11 23H2 feature update, successfully tagging the Windows device objects in Entra ID with a suitably named risk state, and gathered all devices of the same risk state using Dynamic Device Security Groups.\nWhat else do you want from me? Ah yes, a way to utilise the groups we created as part of deploying the Feature Update, you know the whole point of this series. Tune in next week time for the next exciting post in this series. I bet you\u0026rsquo;re thrilled about that.\n","date":"19 April 2024","externalUrl":null,"permalink":"/posts/windows-11-risk-based-deployment-part2/","section":"Posts","summary":"Having looked into capturing the Feature Update Readiness data for Windows 11 23H2 for our Windows devices, we can now use this risk based data to tag them with their associated risk, grouping them together to allow for sensible Feature Update profile assignment.","title":"Risk Based Windows 11 Feature Update Deployment - Device Attributes","type":"posts"},{"content":"","date":"6 April 2024","externalUrl":null,"permalink":"/tags/ncsc/","section":"Tags","summary":"","title":"National Cyber Security Centre (NCSC)","type":"tags"},{"content":"So you\u0026rsquo;ve pulled the trigger on managing macOS devices in Microsoft Intune, and with this year being the year of macOS for Microsoft (this seems like an oxymoron), you should probably look at how to handle software updates.\nI\u0026rsquo;ve been waiting a little while to put this post together, as unlike the monthly release of Windows Updates, macOS updates come few and far between, with the recent release of Sonoma 14.4 on March 7th 2024, giving me an actual update to test any phased update configurations. Though maybe I should have got this post out sooner looking at the reception that the update has gotten since its release.\nEither way, as Microsoft Intune is now a safe space for macOS device management, instead of the mild headache it used to be, we can now look at how we control the update of software on these devices, so macOS users don\u0026rsquo;t escape the same fate placed upon your normal everyday Windows user.\nUpdate Configuration Precedence # I wish this was as straight forward as Windows Update Rings, but it isn\u0026rsquo;t, and with the recent changes to macOS device management in Microsoft Intune, we now have three different ways to control updates on these devices.\nI\u0026rsquo;m not sure we needed all three, but there is a clear documented hierarchy for the settings, along with which versions of macOS support each. In summary though, the precedence of update configuration profiles looks like this:\nManaged software updates - Settings catalog \u0026gt; Declarative Device Management \u0026gt; Software Update Update policies - Devices \u0026gt; Update policies for macOS Software updates - Settings catalog \u0026gt; System Updates \u0026gt; Software Update I\u0026rsquo;m going to avoid numbers 1 and 2, and although this goes against my love of all things latest and greatest, and leans on the user to install updates, it does give us the functionality of phased updates we require, and without reliance on specific versions of the operating system.\nDeployment Approach # As with our previous look at update deployment across Windows devices, we\u0026rsquo;re going to split our macOS device estate into key deployment groups, this time we\u0026rsquo;re back with four, I\u0026rsquo;ll explain why later.\nSticking with the Pilot, Pre-production, and production deployment approach, we end up with something like the below:\nPilot - This should be a stratified sample of either users or devices, ~5% of your device estate. Pre-Production - The early adopters deployment, ~15% of your device estate. Initial Production - The first production deployment, ~30% of your device estate. Final Production - The final production deployment, the remaining ~50% of the device estate. These groups can be used not just for macOS software updates, but also with some additional configuration, Microsoft Updates as well. What a world we live in.\nDeployment Groups # As we like to please Microsoft, we\u0026rsquo;re going to use what are referred to as efficient groups, stopping the use operators like match, in the hope that they reinstate Microsoft Developer Intune subscriptions for free.\nGroup Type Membership Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;MacMDM\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;0\u0026quot;) or (device.deviceId -startsWith \u0026quot;1\u0026quot;) or (device.deviceId -startsWith \u0026quot;a\u0026quot;)) Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;MacMDM\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;2\u0026quot;) or (device.deviceId -startsWith \u0026quot;3\u0026quot;) or (device.deviceId -startsWith \u0026quot;4\u0026quot;) or (device.deviceId -startsWith \u0026quot;b\u0026quot;) or (device.deviceId -startsWith \u0026quot;c\u0026quot;)) Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;MacMDM\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;5\u0026quot;) or (device.deviceId -startsWith \u0026quot;6\u0026quot;) or (device.deviceId -startsWith \u0026quot;7\u0026quot;) or (device.deviceId -startsWith \u0026quot;8\u0026quot;) or (device.deviceId -startsWith \u0026quot;9\u0026quot;) or (device.deviceId -startsWith \u0026quot;d\u0026quot;) or (device.deviceId -startsWith \u0026quot;e\u0026quot;) or (device.deviceId -startsWith \u0026quot;f\u0026quot;)) These groups will naturally split your macOS device estate across the three pre-production and production dynamic groups, allowing for suitable phasing of the delivery of updates.\nWith the Pilot group, you should add devices into this group that you want to get updates the earliest, so actual pilot devices here please, not your own or your work besties.\nDeployment Assignments # To ensure that we aren\u0026rsquo;t getting conflict with policy assignment, we need to ensure a device is receiving more than one update policy, whether this is a Software Update or otherwise üòâ.\nAs we\u0026rsquo;ve got the Dynamic Groups ring-fencing devices based on device.deviceId, the only conflict we may encounter is with the assigned group.\nTo alleviate that conflict, we need to ensure that all our update ring assignments are excluding this group:\nUpdate Ring Included Groups Excluded Groups Pilot Pilot Group - Pre-Production Pre-Production Group Pilot Group Initial Production Initial Production Group Pilot Group Final Production Final Production Group Pilot Group This approach can be used across all update assignment settings covered in the rest of this post.\nSoftware Update Configuration # Before we start looking at the option to delay or defer software updates, we need to create a baseline configuration that sets devices update preference settings, to allow for this phased approach of update delivery.\nSo with a quick Settings Catalog profile created with the below settings, and assigned to your devices, we can ensure that the devices will get the updates they need, but when we tell them:\nCategory Setting Value Software Update Config Data Install True Software Update Automatic Check Enabled True Software Update Allow Pre Release Installation False Software Update Critical Update Install True Software Update Restrict Software Update Require Admin To Install False Software Update Automatic Download True Microsoft Intune Settings Catalog for macOS Software Update settings. You\u0026rsquo;ll notice that for Critical Update Install and Config Data Install we\u0026rsquo;re allowing these to just happen, you should, as they\u0026rsquo;re important. What we want to control is when devices get OS updates, not leaving gaping security flaws in devices.\nPhased Software Updates # The phasing of Software update is a little bit of a pain, but it can be achieved using the below settings, creating one Settings Catalog profile for each deployment group. Now you don\u0026rsquo;t get the same pause and uninstall functionality as you would with Windows Update Rings, but at least you\u0026rsquo;re not pushing out updates all at once to devices.\nUpdate Ring Automatically Install App Updates Automatically Install Mac OS Updates Force Delayed App Software Updates Force Delayed Software Updates Enforced Software Update Delay Enforced Software Update Non OS Deferred Install Delay Enforced Software Update Minor OS Deferred Install Delay Pilot True True False False - - - Pre-Production False False True True 5 5 5 Initial Production False False True True 9 9 9 Final Production False False True True 12 12 12 These phased deployment of updates across the groups, will ensure that there is enough time between each phase to identify any issues (cough like with Sonoma 14.4 cough), allowing for some level of testing of updates prior to a full deployment across your whole macOS device estate.\nWhen assigning these profiles to the created deployment groups, ensure that you are excluding the Pilot group from the pre-production and production profiles. Software Update Results # Seeing the Settings Catalog profiles in action, with a first look at the configuration being applied:\nmacOS Update Configuration Settings. Looks good, and matches what we\u0026rsquo;ve configured in our baseline software update profile.\nChecking on the status of the updates, we\u0026rsquo;ve actually got Sonoma 14.4 available on this device, regardless of the deployment group it\u0026rsquo;s a member of, as 7+12=19 (quick maths) which is less than the date of this post:\nmacOS Update Configuration Settings. Luckily we\u0026rsquo;ll be ready with our configured deferral settings for the next macOS software update release, and I hope it goes a little better than this release.\nMicrosoft AutoUpdate Settings # Bringing additional functionality to our update deployments, and to allow for the management of visibility and installation of any update covered under the Microsoft AutoUpdate (MAU) application, we need to to implement some more baseline settings to configure Microsoft AutoUpdate.\nSo go create yourself another Settings Catalog profile, and throw the below settings into it:\nCategory Setting Value Microsoft AutoUpdate (MAU) Disable Office Insider membership True Microsoft AutoUpdate (MAU) Enable AutoUpdate True Microsoft AutoUpdate (MAU) Number of minutes for the final countdown timer 60 Microsoft AutoUpdate (MAU) Register app on launch True Microsoft AutoUpdate (MAU) Update channel Current Channel Microsoft AutoUpdate (MAU) Update check frequency (mins) 240 Microsoft Intune Settings Catalog for macOS Microsoft AutoUpdate settings. Feel free to amened the Number of minutes for the final countdown timer and Update check frequency (mins) if you like your user base more than I do.\nUpdated the Enable AutoUpdate settings based on feedback from Somesh Pathak (MVP) Phased Microsoft Updates # To phase the delivery of Microsoft Application updates across the four deployment groups, you will need to create four separate Settings Catalog profiles with the below settings, with restrictions configured to stop users checking for updates and relying on the deferral and deadline settings where applicable.\nUpdate Ring Enable check for updates Deferred updates Days before forced updates Pilot True - - Pre-Production False Defer 3 days 2 Initial Production False Defer 7 days 2 Final Production False Defer 7 days 5 You can now see why I stuck with four deployment groups, as we love working within the National Cyber Security Centre guidelines to ensure that updates are installed in that wonderful 14-day window, and the Microsoft AutoUpdate configuration only allows set values for Deferred updates.\nWhen assigning these profiles to the created deployment groups, ensure that you are excluding the Pilot group from the pre-production and production profiles. Microsoft Update Results # Checking in on a device that is set to defer and delay the installation of Microsoft Updates, we can see that the profile has applied correctly:\nMicrosoft AutoUpdate Settings. With no ability for the end user to install the updates on their own, and the correct configuration applied to the device we\u0026rsquo;re off to a good start.\nLet\u0026rsquo;s look at the updates themselves:\nMicrosoft AutoUpdate Updates. Perfect, the Microsoft AutoUpdate application has detected that there are actually updates, but will adhere to the deferral and deadline settings, ensuring that the application updates do get installed, but when we want them to, not at the whim of the end user.\nSummary # With each deployment group now configured to get update deferrals and installation deadlines for Software, Operating System, and Microsoft Applications aligned to the same day, we have the ability to unify the deployment approach of updates to Microsoft Intune managed macOS devices.\nThis may not give us all the functionality we want just yet, still relying on users to carry out installations, but until there is another flexible approach to enforced software updates that doesn\u0026rsquo;t rely on check-in or day of the week, or scripts and property lists, or community tools like nudge, this will have to do.\nWe are at least, one step closer to getting some level of feature parity between device management for Windows devices and macOS devices in Microsoft Intune, and with more on the horizon, it\u0026rsquo;s a good time to be a hybrid macOS and Windows device consultant.\n","date":"6 April 2024","externalUrl":null,"permalink":"/posts/macos-updates-phased-deployment/","section":"Posts","summary":"So you\u0026rsquo;ve pulled the trigger on managing macOS devices in Microsoft Intune, and with this year being the year of macOS for Microsoft (this seems like an oxymoron), you should probably look at how to handle software updates.","title":"Software Update Deployment Rings for Managed macOS Devices","type":"posts"},{"content":"At the time of writing we are only a few hundred days away from the end of support of Windows 10 22H2, and really we should all be recommending the move to Windows 11, not just because it\u0026rsquo;s shiny and new, but also it\u0026rsquo;s going to actually get security updates.\nMany organisations are happily running Windows 10 and have been for some time, and have probably dabbled with Windows 11, mainly IT staff who wanted to be on the latest and greatest. This however isn\u0026rsquo;t going to get your devices to Windows 11 any time soon, and instead of distributing a Feature Update blindly, we should probably make use of the information in the Feature Update Readiness Reports in Microsoft Intune.\nThis report is useful from a visibility perspective, we can see the risk of updating a device to a specific Feature Update, drill into effected devices, and get a greater understanding of the overall Windows 11 readiness for a device estate. That\u0026rsquo;s it though. What if we can extend the reports use?\nPart one in this series looks at how we can create and capture the Feature Update Readiness Report data with PowerShell and Graph API, so at some point we can use it to make informed, but automated decisions for Windows 11 Feature Update deployment.\nFeature Update Readiness Report # We\u0026rsquo;re going to lean onto this report and use it to be able to tag devices with their Feature Update readiness state, from the current supported values:\nLow risk - There are no known compatibility risks associated with the device. Medium risk - There are only minor, or non-blocking, compatibility risks associated with this device, such as applications that are automatically removed during upgrade. High risk - There are multiple or blocking compatibility risks associated with this device, such as applications that block an upgrade. Replace device - The device isn\u0026rsquo;t capable of upgrading to the target OS version. Upgraded - The device is already running a version of Windows equal to or greater than the target OS version. Unknown - A readiness status couldn\u0026rsquo;t be determined. Ensure that the device is properly configured to send Windows diagnostic data. Microsoft Feature Update readiness report. These readiness states are all going to be pretty handy, as we hopefully can capture those devices that are at a level of risk, or unknown risk of an update to Windows 11, and allow a targeted and safe deployment of the Feature Update.\nReport Pre-requisites # This one is a bit of a kicker, and I\u0026rsquo;d recommend looking at the pre-requisites as soon as possible, in fact, go look at them now and come back when you\u0026rsquo;ve implemented them\u0026hellip;\nRight, now they\u0026rsquo;re in place, let\u0026rsquo;s talk about why I told you to just go ahead and turn some things on, well in order for us to use the report, we need to ensure that devices are able to send data, Microsoft is able to process the data, and the fact you have to wait 52 hours for the data to be processed.\nSo based on this, anything we do using the data needs to be able to run multiple times, as not all devices in the estate are going to send their data at the same time.\nGraph and Feature Update Readiness Reports # Let\u0026rsquo;s see how we can get the report data using the Microsoft Graph PowerShell SDK, as always I\u0026rsquo;ve investigated the calls to Graph using Developer Tools in my browser of choice (Microsoft Edge, obviously), and from my findings and the fact that reports are individual to the account running them, we need a way to start a report, and then get the report.\nCreating Feature Update Readiness Reports # We\u0026rsquo;ll start with the call to create a new readiness report, we need to POST to deviceManagement/reports/cachedReportConfigurations with some JSON content in the below format, specifying the version of Feature Update we want to report on, for us, we want Windows 11 23H2, so the value we\u0026rsquo;re after is NI23H2.\n{ \u0026#34;id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;filter\u0026#34;: \u0026#34;(TargetOS eq \u0026#39;NI23H2\u0026#39;) and (DeviceScopesTag eq \u0026#39;00000\u0026#39;)\u0026#34;, \u0026#34;orderBy\u0026#34;: [], \u0026#34;select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34; ], \u0026#34;metadata\u0026#34;: \u0026#34;TargetOS=\u0026gt;filterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u0026gt;filterPicker=RGVmYXVsdA==\u0026#34; } This will then start the generation of a report in the background, which isn\u0026rsquo;t instant, so we\u0026rsquo;ll need a way to not only capture the report data, but also a way to wait until it\u0026rsquo;s available. At least we\u0026rsquo;ve got a way to kick off a report, so we should create a function to do this, you know, so it\u0026rsquo;s easily repeatable.\nEnsure that you\u0026rsquo;re connecting to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All', we\u0026rsquo;ll need some more scopes later, but for now this one will do. Function New-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceManagement/reports/cachedReportConfigurations\u0026#39; try { Test-Json -Json $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can now start a new report using New-ReportFeatureUpdateReadiness -JSON $JSONContent passing through our JSON content for the creation of a report, now we need to detect whether the report is ready, and then when it is ready, to download the data in the report.\nGetting Feature Update Readiness Report Status # More digging with developer mode in Edge reveals surprisingly both a GET request to deviceManagement/reports/cachedReportConfigurations('$Id') (where $Id is the Id of a generated report), this will be useful as the output of this call gives us a status of the report.\nGraph Explorer showing Feature Update readiness report. So let\u0026rsquo;s create ourselves a function to handle getting the Feature Update Readiness report.\nFunction Get-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/reports/cachedReportConfigurations(\u0026#39;$Id\u0026#39;)\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Get } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; -f Red Write-Host Write-Error \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Write-Host break } } With the function above and a little bit of common sense and a while loop, we can sit and happily wait until the report status equals completed after creating a new report.\n$featureUpdateCreateJSON = @\u0026#34; { \u0026#34;id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;filter\u0026#34;: \u0026#34;(TargetOS eq \u0026#39;NI23H2\u0026#39;) and (DeviceScopesTag eq \u0026#39;00000\u0026#39;)\u0026#34;, \u0026#34;orderBy\u0026#34;: [], \u0026#34;select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34; ], \u0026#34;metadata\u0026#34;: \u0026#34;TargetOS=\u0026gt;filterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u0026gt;filterPicker=RGVmYXVsdA==\u0026#34; } \u0026#34;@ $startFeatureUpdateReport = New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON While ((Get-ReportFeatureUpdateReadiness -Id $startFeatureUpdateReport.id).status -ne \u0026#39;completed\u0026#39;) { Write-Host \u0026#39;Waiting for the Feature Update report to finish processing...\u0026#39; -ForegroundColor Cyan Start-Sleep -Seconds 3 } Great, creation of the report and understanding whether the report is complete is now in the bag, now we need to look at how we actually get the data in the report.\nGetting Feature Update Readiness Report Data # More fun with Edge Developer Mode when browsing around the Feature Update Readiness Reporting in the Microsoft Intune Portal, and a crawl through the Graph API documentation, reveals another call to Graph, but this time it\u0026rsquo;s another POST, but to deviceManagement/reports/cachedReportConfigurations, this time with slightly different JSON content. Interesting.\n{ \u0026#34;Id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;Skip\u0026#34;: 0, \u0026#34;Top\u0026#34;: 50, \u0026#34;Search\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OrderBy\u0026#34;: [], \u0026#34;Select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34;, \u0026#34;DeviceId\u0026#34;, \u0026#34;AadDeviceId\u0026#34;, \u0026#34;Ownership\u0026#34; ], \u0026#34;filter\u0026#34;: \u0026#34;\u0026#34; } I tell you what is going to be fun, the fact that this call works between device 0 in the Skip and device 50 in the Top parameters, so it isn\u0026rsquo;t pulling back all data for all devices. Well that\u0026rsquo;s great news, who doesn\u0026rsquo;t love pagination?\nGraph Explorer with created readiness report. When I first looked at this call to Graph, the report data was passed back nicely inline, not any more though, it downloads a file, but at least the file is just a plain text file and contains all the data for the first 50 devices.\nAs we have a new use case, we can update the Get-ReportFeatureUpdateReadiness function to handle both the initial call to get the status of a report, but also the data in the report, using logic to determine both the Graph endpoint as well as the request, and bit of a hacky way to deal with the downloaded file.\nFunction Get-ReportFeatureUpdateReadiness() { [cmdletbinding()] param ( [parameter(Mandatory = $false)] $Id, [parameter(Mandatory = $false)] $JSON ) $graphApiVersion = \u0026#39;Beta\u0026#39; if ($id) { $Resource = \u0026#34;deviceManagement/reports/cachedReportConfigurations(\u0026#39;$Id\u0026#39;)\u0026#34; } elseif ($JSON) { $Resource = \u0026#39;deviceManagement/reports/getCachedReport\u0026#39; } try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; if ($id) { Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($JSON) { $tempFile = [System.IO.Path]::GetTempFileName() Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; -OutputFilePath $tempFile Get-Content -Raw $tempFile | ConvertFrom-Json Remove-Item $tempFile } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; -f Red Write-Host Write-Error \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Write-Host break } } So now we can capture the data for the first 50 devices in the report, but we need a way to get all the data, and pass it into something we can call later on, because random data flying about in PowerShell is pretty useless.\nHandling Feature Update Readiness Report Data # Let\u0026rsquo;s start with using our new functions and a call to Graph to create the report using New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON, followed by a check to see if the report data is ready, then we can get the initial report data with Get-ReportFeatureUpdateReadiness -JSON $featureUpdateGetJSON, then we can iterate through the report data if there is more than 50 devices in the initial call to capture all the data, incrementing the $i variable by 50 each time, and continue to get device data until there are no more devices left, passing the data into a new array $featureUpdateReportDetails. Simple right \u0026#x1f643;\n$featureUpdateCreateJSON = @\u0026#34; { \u0026#34;id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;filter\u0026#34;: \u0026#34;(TargetOS eq \u0026#39;NI23H2\u0026#39;) and (DeviceScopesTag eq \u0026#39;00000\u0026#39;)\u0026#34;, \u0026#34;orderBy\u0026#34;: [], \u0026#34;select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34; ], \u0026#34;metadata\u0026#34;: \u0026#34;TargetOS=\u0026gt;filterPicker=V2luZG93cyUyMDExJTIwLSUyMHZlcnNpb24lMjAyMkgy,DeviceScopesTag=\u0026gt;filterPicker=RGVmYXVsdA==\u0026#34; } \u0026#34;@ $featureUpdateGetJSON = @\u0026#39; { \u0026#34;Id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;Skip\u0026#34;: 0, \u0026#34;Top\u0026#34;: 50, \u0026#34;Search\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OrderBy\u0026#34;: [], \u0026#34;Select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34;, \u0026#34;DeviceId\u0026#34;, \u0026#34;AadDeviceId\u0026#34;, \u0026#34;Ownership\u0026#34; ], \u0026#34;filter\u0026#34;: \u0026#34;\u0026#34; } \u0026#39;@ $startFeatureUpdateReport = New-ReportFeatureUpdateReadiness -JSON $featureUpdateCreateJSON While ((Get-ReportFeatureUpdateReadiness -Id $startFeatureUpdateReport.id).status -ne \u0026#39;completed\u0026#39;) { Start-Sleep -Seconds 3 } $featureUpdateReport = Get-ReportFeatureUpdateReadiness -JSON $featureUpdateGetJSON $featureUpdateReportDetails = @() $featureUpdateReportDetails += $featureUpdateReport.Values $i = 0 if ($($featureUpdateReport.TotalRowCount) -gt 50) { while ($i -le $($featureUpdateReport.TotalRowCount)) { $i = $i + 50 $getNextJSON = @\u0026#34; { \u0026#34;Id\u0026#34;: \u0026#34;MEMUpgradeReadinessDevice_00000000-0000-0000-0000-000000000001\u0026#34;, \u0026#34;Skip\u0026#34;: $i, \u0026#34;Top\u0026#34;: 50, \u0026#34;Search\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;OrderBy\u0026#34;: [], \u0026#34;Select\u0026#34;: [ \u0026#34;DeviceName\u0026#34;, \u0026#34;DeviceManufacturer\u0026#34;, \u0026#34;DeviceModel\u0026#34;, \u0026#34;OSVersion\u0026#34;, \u0026#34;ReadinessStatus\u0026#34;, \u0026#34;SystemRequirements\u0026#34;, \u0026#34;AppIssuesCount\u0026#34;, \u0026#34;DriverIssuesCount\u0026#34;, \u0026#34;AppOtherIssuesCount\u0026#34;, \u0026#34;DeviceId\u0026#34;, \u0026#34;AadDeviceId\u0026#34;, \u0026#34;Ownership\u0026#34; ], \u0026#34;filter\u0026#34;: \u0026#34;\u0026#34; } \u0026#34;@ # Sleep to stop throttling issues Start-Sleep -Seconds 3 $featureUpdateReportNext = Get-ReportFeatureUpdateReadiness -JSON $getNextJSON $featureUpdateReportDetails += $featureUpdateReportNext.Values } } With all of this in hand, we now have an array $featureUpdateReportDetails variable with their readiness data, good, bad, and indifferent for all devices that have actually reported back. Now we need to format it into something useful.\nProcessing Feature Update Report Data # We should take the data gathered from the Readiness Report in the $featureUpdateReportDetails variable, which looks ugly as sin, and create a new report using a PSCustomObject array variable $reportArray, but with some sense around the data that exists.\nLooping through each object in the initial array, we can create the new array using the below.\n$reportArray = @() foreach ($device in $featureUpdateReportDetails) { $reportArray += [PSCustomObject]@{ \u0026#39;AadDeviceId\u0026#39; = $device[0] \u0026#39;AppIssuesCount\u0026#39; = $device[1] \u0026#39;AppOtherIssuesCount\u0026#39; = $device[2] \u0026#39;DeviceId\u0026#39; = $device[3] \u0026#39;DeviceManufacturer\u0026#39; = $device[4] \u0026#39;DeviceModel\u0026#39; = $device[5] \u0026#39;DeviceName\u0026#39; = $device[6] \u0026#39;DriverIssuesCount\u0026#39; = $device[7] \u0026#39;OSVersion\u0026#39; = $device[8] \u0026#39;Ownership\u0026#39; = $device[9] \u0026#39;ReadinessStatus\u0026#39; = $device[10] \u0026#39;SystemRequirements\u0026#39; = $device[11] } } Giving us something a little easier to reference later down the line.\nReadiness report data array. You might not know what\u0026rsquo;s coming in part two of this series, but luckily I do, so, there are two bits of information we are going to add into the new report array that will be very useful.\nReadiness Status Value # Firstly is a translation of the risk state number to something useful, looking at the documentation we can establish that the values captured translate to the below.\nReadiness status value Report value 0 Low risk 1 Medium risk 2 High risk 3 Replace device 4 Upgraded 5 Unknown With this, we should have some foresight that whatever value we\u0026rsquo;re assigning to each status value must be repeatable, so let\u0026rsquo;s use a switch on the value in the foreach loop, and assign a string based on the risk state, and Feature Update version associated with that risk state. This $riskState variable can then be added into the $reportArray array.\n$reportArray = @() foreach ($device in $featureUpdateReportDetails) { $riskState = switch ($device[10]) { \u0026#39;0\u0026#39; { \u0026#34;LowRisk-W11-23H2\u0026#34; } \u0026#39;1\u0026#39; { \u0026#34;MediumRisk-W11-23H2\u0026#34; } \u0026#39;2\u0026#39; { \u0026#34;HighRisk-W11-23H2\u0026#34; } \u0026#39;3\u0026#39; { \u0026#34;NotReady-W11-23H2\u0026#34; } \u0026#39;5\u0026#39; { \u0026#34;Unknown-W11-23H2\u0026#34; } } $reportArray += [PSCustomObject]@{ \u0026#39;AadDeviceId\u0026#39; = $device[0] \u0026#39;AppIssuesCount\u0026#39; = $device[1] \u0026#39;AppOtherIssuesCount\u0026#39; = $device[2] \u0026#39;DeviceId\u0026#39; = $device[3] \u0026#39;DeviceManufacturer\u0026#39; = $device[4] \u0026#39;DeviceModel\u0026#39; = $device[5] \u0026#39;DeviceName\u0026#39; = $device[6] \u0026#39;DriverIssuesCount\u0026#39; = $device[7] \u0026#39;OSVersion\u0026#39; = $device[8] \u0026#39;Ownership\u0026#39; = $device[9] \u0026#39;ReadinessStatus\u0026#39; = $device[10] \u0026#39;SystemRequirements\u0026#39; = $device[11] \u0026#39;RiskState\u0026#39; = $riskState } } I\u0026rsquo;ve not bothered with dealing with 4, as these are devices already upgraded to this version of Windows, so we don\u0026rsquo;t care about them. So that deals with the risk state of a device, what else is up my sleeve.\nEntra ID Device Objects # Some of the avid readers of the blog, may have worked out why this next part is important, for those slower off the mark, hang tight, I\u0026rsquo;ll do my best to talk you through it. If the end goal here is to tag a device with it\u0026rsquo;s Feature Update risk status, making use of the information in the Feature Update Readiness Report, we need an object to tag.\nTo get these objects, we\u0026rsquo;re going to have to query Entra ID for all device objects, and get their information, allowing us to compare the AadDeviceId from the report data, to the associated objectId in Entra ID.\nSadly the built-in functionality within the Graph PowerShell module is going to limit us to 999 devices, so we\u0026rsquo;re leaning on an existing function to get more devices than the set device limit.\nFunction Get-EntraIDDevice() { $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;devices\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource\u0026#34; $GraphResults = Invoke-MgGraphRequest -Uri $uri -Method Get $Results = @() $Results += $GraphResults.value $Pages = $GraphResults.\u0026#39;@odata.nextLink\u0026#39; while ($null -ne $Pages) { $Additional = Invoke-MgGraphRequest -Uri $Pages -Method Get if ($Pages) { $Pages = $Additional.\u0026#39;@odata.nextLink\u0026#39; } $Results += $Additional.value } $Results } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; -f Red Write-Host Write-Error \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Write-Host break } } We can now get all Windows devices, as we don\u0026rsquo;t care about any other types this time around, and then compare the AadDeviceId with the $windowsDevices variable containing all Entra ID device objects, adding a new ObjectID into the mix.\n$windowsDevices = Get-EntraIDDevice | Where-Object { $_.operatingSystem -eq \u0026#39;Windows\u0026#39; } $reportArray = @() foreach ($device in $featureUpdateReportDetails) { $riskState = switch ($device[10]) { \u0026#39;0\u0026#39; { \u0026#34;LowRisk-W11-23H2\u0026#34; } \u0026#39;1\u0026#39; { \u0026#34;MediumRisk-W11-23H2\u0026#34; } \u0026#39;2\u0026#39; { \u0026#34;HighRisk-W11-23H2\u0026#34; } \u0026#39;3\u0026#39; { \u0026#34;NotReady-W11-23H2\u0026#34; } \u0026#39;5\u0026#39; { \u0026#34;Unknown-W11-23H2\u0026#34; } } $reportArray += [PSCustomObject]@{ \u0026#39;AadDeviceId\u0026#39; = $device[0] \u0026#39;AppIssuesCount\u0026#39; = $device[1] \u0026#39;AppOtherIssuesCount\u0026#39; = $device[2] \u0026#39;DeviceId\u0026#39; = $device[3] \u0026#39;DeviceManufacturer\u0026#39; = $device[4] \u0026#39;DeviceModel\u0026#39; = $device[5] \u0026#39;DeviceName\u0026#39; = $device[6] \u0026#39;DriverIssuesCount\u0026#39; = $device[7] \u0026#39;OSVersion\u0026#39; = $device[8] \u0026#39;Ownership\u0026#39; = $device[9] \u0026#39;ReadinessStatus\u0026#39; = $device[10] \u0026#39;SystemRequirements\u0026#39; = $device[11] \u0026#39;RiskState\u0026#39; = $riskState \u0026#39;ObjectID\u0026#39; = $(($windowsDevices | Where-Object { $_.deviceid -eq $device[0] }).id) } } A quick glimpse at the data in the array now, not only shows the assigned risk state for the Feature Update version we\u0026rsquo;re looking to deploy, but also the Entra ID ObjectId for each device.\nUpdated Readiness report data array. The array now has all the data we need for part two, we have the device details, including the Entra ID computer object Id, the risk state, and everything else we could possibly ask for to make our lives easier when deploying Windows 11 Feature Updates.\nSummary # I\u0026rsquo;ve learnt from watching both Neighbours and Doctors as a student, that each episode should end on a cliffhanger and the viewer wanting more, so that\u0026rsquo;s what\u0026rsquo;s happened here, I hope.\nAt least for now, we\u0026rsquo;ve got a clear way to start, wait, capture, and process data from a Feature Update Readiness Reports in Microsoft Intune, and add some additional data to the report that will hopefully allow us to deploy our favourite flavour of Windows 11 using a phased, controlled, and risk based approach.\n","date":"25 March 2024","externalUrl":null,"permalink":"/posts/windows-11-risk-based-deployment-part1/","section":"Posts","summary":"With Windows 10 support coming to an end sooner than you\u0026rsquo;d expect, in the first part of this series we look at ways to capture Feature Update Readiness Report data using PowerShell and Graph to help with the rollout of the new Windows 11 operating system.","title":"Risk Based Windows 11 Feature Update Deployment - Reporting","type":"posts"},{"content":"Configuring silent encryption for Windows 10 and later devices in Microsoft Intune isn\u0026rsquo;t anything new, removing reliance on Administrator permissions to encrypt a device, setting the encryption algorithm used, and ensuring that the data on the device is protected.\nBut what happens when your devices configured for silent encryption, don\u0026rsquo;t even automatically encrypt, with devices complaining about the detection of Un-allowed DMA capable bus/device(s) in the event log, preventing automatic encryption from starting.\nWith the Microsoft recommendation to create registry items to allow for these exceptions on the devices failing to automatically encrypt, we should see if a bit of PowerShell and Microsoft Intune can do to fix this issue.\nDirect Memory Access Exceptions # If you are subject to this DMA-based issue, and if you\u0026rsquo;ve got either Dell, HP or Lenovo devices you probably are, with the BitLocker-API Management event log complaining about these Un-allowed DMA exceptions in Event ID 4112, with text similar to the below:\nThe following DMA (Direct Memory Access) capable devices are not declared as protected from external access, which can block security features such as BitLocker automatic device encryption: LPC Controller: PCI\\VEN_8086\u0026amp;DEV_519D (Intel(R) LPC Controller - 519D) PCI-to-PCI Bridge: PCI\\VEN_8086\u0026amp;DEV_51B1 (Intel(R) PCI Express Root Port #10 - 51B1) And System Information showing something like this:\nSystem Information showing DMA Exceptions. Instead of having to manually create the recommended registry settings, only after changing permissions on the Key to allow for these exceptions detailed in the Microsoft Support Article, we should find a way to do this automatically.\nPlatform Scripts # You might be wondering why we\u0026rsquo;re going for a \u0026ldquo;dumb\u0026rdquo; PowerShell script instead of the \u0026ldquo;fancy\u0026rdquo; remediation approach that I am fond of?\nWell the simple answer is that Platform scripts, running under the required SYSTEM context, will run during Windows Autopilot, so we can ensure that devices with the DMA issue are resolved during the deployment process instead of after it, allowing for BitLocker automatic encryption to complete in flight, you know for security and that.\nSo there.\nRegistry Settings # We need a way to easily add the required registry entries to allow for the exceptions, taking into consideration that a single model, or manufacturer, of device could have multiple exceptions.\nFor this, we can just build a new pscustomobject as part of an array variable $dmaDevices, and as the actual name of the registry value doesn\u0026rsquo;t matter, our main focus is the value.\n$dmaDevices = @() $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) LPC Controller - 519D\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_519D\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #10 - 51B1\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_51B1\u0026#39;} With the $dmaDevices array variable, we can then loop through each item in the array, and add the required data to the registry key HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses with a New-ItemProperty command:\n$regPath = \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses\u0026#39; foreach ($dmaDevice in $dmaDevices) { New-ItemProperty -Path $regPath -Name $dmaDevice.name -Value $dmaDevice.value -PropertyType String -Force } Great, we have to a way to add in these exceptions, but as they are exceptions, we should be more sniper and less shotgun.\nDevice Model Queries # Instead of this blanket set of new registry items assigned to all devices, which from a security stance isn\u0026rsquo;t the best look, we should make sure that make and model specific settings are applying.\nInstead of having the create many many Dynamic Device Groups in Entra for each make and model, we can achieve this granularity of model specific settings by using a quick (Get-WmiObject -Class:Win32_ComputerSystem).Model to pull back the model of the device, before we start fiddling with its registry.\n$dmaDevices = @() $deviceModel = (Get-WmiObject -Class:Win32_ComputerSystem).Model if ($deviceModel -in \u0026#39;Latitude 1\u0026#39;, \u0026#39;Latitude 2\u0026#39;) { $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) LPC Controller - 519D\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_519D\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #10 - 51B1\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_51B1\u0026#39;} } elseif ($deviceModel -in \u0026#39;Lenovo 1\u0026#39;, \u0026#39;Lenovo 2\u0026#39;) { $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #20 - A343\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A343\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #9 - A330\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A330\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) Xeon(R) E3 - 1200/1500 v5/6th Gen Intel(R) Core(TM) PCIe Controller (x16) - 1901\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_1901\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #15 - A336\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A336\u0026#39;} } The if and subsequent elseif statements allow us to ensure that only the DMA exceptions per model, or groups of models, are going to be applied, with the statement allowing for a lookup of multiple models using the -in operator.\nSo if you have multiple models with the same PCI\\VEN_8086\u0026amp;DEV_A30D exception for example, these can be grouped together. Nice eh?\nPowerShell Example # Combining both the device model logic, and the creation of new registry items in the correct location, we have the below, which can act as a template or example for the rest of your devices with these issues.\n# Allow for silent and automatic BitLocker Encryption # https://learn.microsoft.com/en-us/windows-hardware/design/device-experiences/oem-bitlocker#un-allowed-dma-capable-busdevices-detected $regPath = \u0026#39;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\DmaSecurity\\AllowedBuses\u0026#39; $dmaDevices = @() $devicesLenovo = @(\u0026#39;20UACTO1WW\u0026#39;, \u0026#39;20KG0005AU\u0026#39;) $devicesDell = @(\u0026#39;Latitude 7320\u0026#39;,\u0026#39;Latitude 5320\u0026#39;) $devicesHP = @(\u0026#39;HP EliteBook 8540p\u0026#39;) Try { $deviceModel = (Get-WmiObject -Class:Win32_ComputerSystem).Model if ($deviceModel -in $devicesDell) { $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) LPC Controller - 519D\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_519D\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #10 - 51B1\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_51B1\u0026#39;} } elseif ($deviceModel -in $devicesLenovo) { $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #20 - A343\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A343\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #9 - A330\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A330\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) Xeon(R) E3 - 1200/1500 v5/6th Gen Intel(R) Core(TM) PCIe Controller (x16) - 1901\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_1901\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #15 - A336\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A336\u0026#39;} } elseif ($deviceModel -in $devicesHP ){ $dmaDevices += [pscustomobject]@{name = \u0026#39;PCI Express Upstream Switch Port - 15EF\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_15EF\u0026#39;} $dmaDevices += [pscustomobject]@{name = \u0026#39;Intel(R) PCI Express Root Port #17 - A340\u0026#39;; value = \u0026#39;PCI\\VEN_8086\u0026amp;DEV_A340\u0026#39;} } foreach ($dmaDevice in $dmaDevices) { New-ItemProperty -Path $regPath -Name $dmaDevice.name -Value $dmaDevice.value -PropertyType String -Force } Exit 0 } Catch { Write-Error $_.ErrorDetails Exit 1 } This can be modified based on your own device estate, grouping devices by manufacturer or model, or just by which exceptions need to be made.\nYou can update or modify the variables used for each of the manufacturers $devicesLenovo, $devicesDell, and $devicesHP, as the likelihood is that you may need more granularity across the manufacturers. Script Testing # Now as the registry key has restrictive permissions, you can modify these manually for testing as per the article, or you can use PsExec to run PowerShell as SYSTEM using PsExec.exe -s -i powershell.exe.\nAllowing you to test locally on devices before deploying using Microsoft Intune, and with a bit of luck, you should see something like the below:\nRegistry settings showing DMA Exception values. After successful testing, you\u0026rsquo;re now ready to deploy this as a Platform Script in Microsoft Intune, using the below configuration.\nItem Detail Name BitLocker DMA Exceptions Description https://memv.ennbee.uk/posts/bitlocker-dma-exceptions/ PowerShell script Set-BitLockerDMAExceptions.ps1 Run this script using the logged on credentials No Enforce script signature check No Run script in 64 bit PowerShell Host Yes Included groups Dynamic Autopilot Group Now your devices should happily encrypt with BitLocker automatically, without hitting one of these DMA exceptions.\nSummary # Once you\u0026rsquo;ve captured the DMA exceptions of devices failing to automatically encrypt with BitLocker, along with the model of device that is effected, you can update the PowerShell script, taking care with the model names, this can then be deployed using Microsoft Intune to a dynamic group of Windows Autopilot devices.\nAs we\u0026rsquo;ve gone to the effort of being specific with our exceptions, in the event that a device model is not in the list, then nothing will happen, but if a model is in the list of effected devices, the registry will get updated, and BitLocker will stop being a little whinge about not being able to start encryption due to some kind of security issue.\n","date":"16 March 2024","externalUrl":null,"permalink":"/posts/bitlocker-dma-exceptions/","section":"Posts","summary":"So you\u0026rsquo;ve configured BitLocker encryption in Microsoft Intune, but some of your devices are failing to encrypt complaining about a DMA exception issue as part of Automatic Encryption. How can we fix that without creating a gaping security hole?","title":"Remediating BitLocker DMA Exception Errors with Microsoft Intune","type":"posts"},{"content":"If you\u0026rsquo;ve been living under a rock, or you don\u0026rsquo;t have to deal with firewall and proxy requirements for accessing Microsoft Online services, you probably won\u0026rsquo;t be aware that Microsoft publish their URLs and IP addresses for their services using a web service.\nSadly I don\u0026rsquo;t live under a rock, and when I get the pleasure working with customers who are blocking all inbound and outbound traffic from Windows devices unless there is a matching firewall rule, getting these devices to talk to Microsoft Intune and other Microsoft services, can be a bit of a pain without the web service as a reference.\nNow because I\u0026rsquo;m desperate to write PowerShell scripts there is no way I\u0026rsquo;m going to copy paste a million times between an actual queryable web service and Microsoft Intune to create the necessary firewall rules. Let\u0026rsquo;s look at how we can leverage the web service to create some much needed firewall settings.\nReusable Settings Groups # So here we are, back looking at Defender Windows firewall rules in Microsoft Intune again, and after moving legacy firewall rules to the Settings Catalog versions previously, to make use of Reusable Settings Groups, we\u0026rsquo;re now heavily leaning into these reusable options, to ensure that all Windows 10 and later devices can communicate successfully to the Microsoft Online endpoints.\nBefore we look at how to deal with the data available in the Microsoft web service, we should look at how we can create these reusable settings groups in Microsoft Intune using Graph, and make use of the option to auto resolve URLs, which should make life a little bit easier for the ever changing internet landscape.\nJSON Formatting # We at least have experience dealing with building the JSON structure required for Settings Catalog profiles previously, and it wasn\u0026rsquo;t particularly straight forward, so after a hesitant dig with Developer Tools we can see that when you create a new reusable setting in Microsoft Intune, we\u0026rsquo;re sending a POST call to the deviceManagement/reusablePolicySettings endpoint, with JSON similar to the below.\n{ \u0026#34;displayName\u0026#34;: \u0026#34;ReusableTest\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;My very first reusable group.\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;settingInstance\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;groupSettingCollectionValue\u0026#34;: [ { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_true\u0026#34;, \u0026#34;children\u0026#34;: [] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;memv.ennbee.uk\u0026#34; } } ] }, { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_false\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_addresses\u0026#34;, \u0026#34;simpleSettingCollectionValue\u0026#34;: [ { \u0026#34;value\u0026#34;: \u0026#34;8.8.8.8\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34; } ] } ] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;Google DNS\u0026#34; } } ] } ] }, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementReusablePolicySetting\u0026#34; } Comparing this with the created reusable group below, we can see that each children section of the JSON structure is looking after each of created items.\nReusable firewall settings in Microsoft Intune. With a single children section for each auto resolve URL, and one section containing each of the IP addresses, and luckily for us, the structure of the JSON is the same whether it\u0026rsquo;s the first setting in the list or the last, bar a trailing ,.\nLet\u0026rsquo;s look at how we can use PowerShell to build out our JSON structure for a reusable settings group.\nBuilding the JSON Format # This one looks a lot less of a headache compared to building Settings Catalog JSON structures, with hopefully minimal logic needed to distinguish the first and subsequent settings, and very few variables to handle and pass in, to allow the creation of our very own reusable settings group containing all the URLs and IP addresses from the Microsoft web service.\nWe can break down the whole JSON structure into $*JSON variable sections that can be updated with subsequent variables when processing the captured data from the web service:\n$startJSON - Looking at the start of the JSON, this section won\u0026rsquo;t change between reusable groups other than for $displayName and $description,which we can pass variables into for each. $urlJSON - For groups that contain either multiple URLs, or URLs and IPs, we\u0026rsquo;re going to have to build in some logic to deal with the trailing , for the initial URL, but for now let\u0026rsquo;s ignore that and focus on just adding in the $url variable to this section of the JSON. $ipStartJSON - With IP addresses, they are all contained within a single section, similar to each URL, so we need to create the JSON structure for the start of the IP section. $ipJSON - This is where we can add our IP addresses, with one IP per section, being added to the JSON using the $ip variable. Similar to having multiple URLs, we\u0026rsquo;ll need to loop through all IP addresses and ensure that each IP has the required JSON format. $ipEndJSON - After we captured all the IP addresses, and the relevant JSON structure, we just need to tail off the full set of IP addresses with a closing structure like below. Apparently the IP address group needs an identity, which we can pass in using the variables $ipName. $endJSON - Finally to round off the full JSON structure, we need to complete the format with the required @odata.type value. In a very straightforward way, we can build out a similar JSON structure compared to the one we initially captured using the Developer Tools, but using PowerShell, combing each of the $*JSON variables.\n$displayName = \u0026#39;Test Reusable Group\u0026#39; $description = \u0026#39; My very second reusable group\u0026#39; $url = \u0026#39;*.ennbee.uk\u0026#39; $ip = \u0026#39;1.1.1.1\u0026#39; $ipsName = \u0026#39;OneOneOneOne DNS\u0026#39; $startJSON = @\u0026#34; { \u0026#34;displayName\u0026#34;: \u0026#34;$displayName\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;$description\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;settingInstance\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;groupSettingCollectionValue\u0026#34;: [ \u0026#34;@ $urlJSON = @\u0026#34; { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_true\u0026#34;, \u0026#34;children\u0026#34;: [] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$url\u0026#34; } } ] }, \u0026#34;@ $ipStartJSON = @\u0026#39; { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_false\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_addresses\u0026#34;, \u0026#34;simpleSettingCollectionValue\u0026#34;: [ \u0026#39;@ $ipJSON = @\u0026#34; { \u0026#34;value\u0026#34;: \u0026#34;$ip\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34; } \u0026#34;@ $ipEndJSON = @\u0026#34; ] } ] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$ipsName\u0026#34; } } ] } \u0026#34;@ $endJSON = @\u0026#39; ] }, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementReusablePolicySetting\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;73d46494-6e54-4fbc-9707-e69bfef7d538\u0026#34; } \u0026#39;@ $JSON = $startJSON + $urlJSON + $ipStartJSON + $ipJSON + $ipEndJSON + $endJSON We don\u0026rsquo;t have to worry about PowerShell messing around with the JSON formatting, as Graph is pretty accepting as long as what we\u0026rsquo;re submitting is a valid JSON. This gives us the valid JSON structure in the $JSON variable, which we can test using Graph Explorer to see if it will create our required reusable group setting.\n{ \u0026#34;displayName\u0026#34;: \u0026#34;Test Reusable Group\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34; My very second reusable group\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;settingInstance\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}\u0026#34;, \u0026#34;groupSettingCollectionValue\u0026#34;: [ { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_true\u0026#34;, \u0026#34;children\u0026#34;: [] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;*.ennbee.uk\u0026#34; } } ] }, { \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_autoresolve_false\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_addresses\u0026#34;, \u0026#34;simpleSettingCollectionValue\u0026#34;: [ { \u0026#34;value\u0026#34;: \u0026#34;1.1.1.1\u0026#34;, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34; } ] } ] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_dynamickeywords_addresses_{id}_keyword\u0026#34;, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;OneOneOneOne DNS\u0026#34; } } ] } ] }, \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementReusablePolicySetting\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;73d46494-6e54-4fbc-9707-e69bfef7d538\u0026#34; } Using Graph Explorer with a POST request to https://graph.microsoft.com/beta/deviceManagement/reusablePolicySettings/ and the above JSON we get a happy looking 201 response, and checking in Microsoft Intune, we now have a new reusable group at our disposal.\nReusable firewall settings created using Graph Explorer in Microsoft Intune. Though one new reusable group setting, with a single URL and IP address isn\u0026rsquo;t really going to help us when there are quite a lot Microsoft Network Endpoints to deal with. So what now?\nMicrosoft Network Endpoint Web Service # As we now have a way to create the reusable group settings, albeit basic, we should look at how we get the network endpoints for Microsoft services from the web service.\nAs Microsoft actually gives you example commands to query the web service and pull back the URLs and IP addresses for each service area, we can use this data and pass it into our newfound ability to create the required firewall settings.\nCapturing Network Endpoints # Using the examples as a start, we can query the web service with an Invoke-MgGraphRequest, and because I\u0026rsquo;m nice, we\u0026rsquo;re going to allow the modification of the uri in the request based on user selected values from the options available in the documentation, along with a generated UUID for the request.\n... [ValidateSet(\u0026#39;Worldwide\u0026#39;, \u0026#39;China\u0026#39;, \u0026#39;USGovDoD\u0026#39;, \u0026#39;USGovGCCHigh\u0026#39;)] [String]$instance = \u0026#39;Worldwide\u0026#39;, [String]$tenantName, [ValidateSet(\u0026#39;Common\u0026#39;, \u0026#39;MEM\u0026#39;, \u0026#39;Skype\u0026#39;, \u0026#39;Exchange\u0026#39;, \u0026#39;SharePoint\u0026#39;)] [String[]]$serviceAreas = @(\u0026#39;Common\u0026#39;, \u0026#39;MEM\u0026#39;, \u0026#39;Skype\u0026#39;, \u0026#39;Exchange\u0026#39;, \u0026#39;SharePoint\u0026#39;) foreach (serviceArea in serviceAreas) { $webService = (\u0026#34;https://endpoints.office.com/endpoints/$instance`?`TenantName=$tenantName`\u0026amp;`ServiceAreas=$serviceArea`\u0026amp;`clientrequestid=\u0026#34; + ([GUID]::NewGuid()).Guid) $endpointSets = (Invoke-MgGraphRequest -Uri $webService) | Where-Object { $_.serviceArea -eq $serviceArea } } Because I love Microsoft Intune, we\u0026rsquo;ll have a sneak peak at the output of $endpointSets for the MEM serviceArea, and guess what? We now have all the URLs, IP addresses, and required ports needed for successful communication for all clients.\nid : 163 serviceArea : MEM serviceAreaDisplayName : Microsoft Endpoint Manager urls : {*.manage.microsoft.com, manage.microsoft.com} ips : {13.67.13.176/28, 13.67.15.128/27, 13.69.67.224/28, 13.69.231.128/28‚Ä¶} tcpPorts : 80,443 expressRoute : False category : Allow required : True id : 164 serviceArea : MEM serviceAreaDisplayName : Microsoft Endpoint Manager urls : {*.delivery.mp.microsoft.com, *.prod.do.dsp.mp.microsoft.com, *.update.microsoft.com, *.windowsupdate.com‚Ä¶} tcpPorts : 443 expressRoute : False category : Default required : True Great, all done, time to move on as all your network endpoints obviously exist in this web service right Microsoft? Nope.\nSome network endpoints were previously published and haven\u0026rsquo;t been included in the Microsoft 365 IP Address and URL Web Service. The web service publishes network endpoints that are required for Microsoft 365 connectivity across an enterprise perimeter network.\nAdditional Network Endpoints # Not to worry, we can add any custom network endpoints and their associated URLs and IPs, and throw that at an array variable $reusableSettings, so for Microsoft Stream we\u0026rsquo;ve got something like the below.\n$reusableSettings = @() $urlsStream = @( \u0026#39;*.cloudapp.net\u0026#39;, \u0026#39;*.api.microsoftstream.com\u0026#39;, \u0026#39;*.notification.api.microsoftstream.com\u0026#39;, \u0026#39;amp.azure.net\u0026#39;, \u0026#39;api.microsoftstream.com\u0026#39; \u0026#39;az416426.vo.msecnd.net\u0026#39;, \u0026#39;s0.assets-yammer.com\u0026#39;, \u0026#39;vortex.data.microsoft.com\u0026#39;, \u0026#39;web.microsoftstream.com\u0026#39; ) $reusableSettings += [pscustomobject]@{displayName = \u0026#39;Microsoft Stream URLs\u0026#39;; description = \u0026#39;Network Endpoints for Microsoft Stream on TCP Ports(s) 80,443\u0026#39;; urls = $urlsStream; ips = $null; ipsName = $null } I\u0026rsquo;ve got you covered for the other network endpoints mentioned in that article that don\u0026rsquo;t exist in the web service, such as the Support and Recovery endpoints, the Windows Store, and anything else I could think of for Microsoft Intune, Windows Autopilot, and Office 365 Apps.\nMoving on swiftly.\nProcessing the Network Endpoints # With our network endpoints in the web service, and those not in the web service captured, we can now process the endpoints into something we can reuse to create the setting in Microsoft Intune. We can group these in a couple of ways.\nGrouping by Service Area # This one is easy-ish, and we can group the URLs and IP addresses by service area, ignoring any particular port requirement. So if you\u0026rsquo;re after a relatively open locked-down Windows Firewall, this one\u0026rsquo;s for you, at the end of the day, we should trust Microsoft at least a little bit.\nShort of handling the data we\u0026rsquo;ve captured and creating the variables we know we need to create the JSON content, ensuring that we\u0026rsquo;re not duplicating either URLs or IPs (Microsoft Intune will complain about duplicates if you try and do this manually, so I assume Graph will throw a wobbly too), and the wonderful kicker that is a single reusable group not having more than 100 items, we can process the data into a the $reusableSettings array variable ready for processing later.\n$reusableSettings = @() $urls = $endpointSets.urls | Sort-Object | Get-Unique $ips = $endpointSets.ips | Sort-Object | Get-Unique $name = $endpointSets.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + \u0026#39; URLs and IPs\u0026#39; $description = \u0026#34;All URL and IP Network Endpoints for $name\u0026#34; $ipsName = \u0026#34;IP Addresses for $name\u0026#34; # Plus one as IPs only count as a single setting if (($urls.Count + 1) -le 100) { $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } else { $displayName = $name + \u0026#39; IPs\u0026#39; $description = \u0026#34;IP Network Endpoints for $name\u0026#34; $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $null; ips = $ips; ipsName = $ipsName } $counter = [pscustomobject] @{ Value = 0 } $groupSize = 100 $urlSubSets = $urls | Group-Object -Property { [math]::Floor($counter.Value++ / $groupSize) } foreach ($urlSubSet in $urlSubSets) { $displayName = $name + \u0026#39; URLs \u0026#39; + $urlSubSet.Name $description = \u0026#34;URL Network Endpoints for $name\u0026#34; $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urlSubSet.Group; ips = $null; ipsName = $null } } } I got around the 100 item limit, by punting IP addresses into one pscustomobject, and splitting the URLs into separate ones using a bit of quick maths, if the number of URLs in urls.Count plus the single IP address item is greater than 100. Sticking with my love/hate affair with Microsoft Intune, we can look at the content stored in the $reusableSettings variable for MEM.\ndisplayName : Microsoft Endpoint Manager URLs and IPs\rdescription : All URL and IP Network Endpoints for Microsoft Endpoint Manager\rurls : {*.delivery.mp.microsoft.com, *.dl.delivery.mp.microsoft.com, *.do.dsp.mp.microsoft.com, *.emdl.ws.microsoft.com‚Ä¶}\rips : {104.46.162.96/27, 13.67.13.176/28, 13.67.15.128/27, 13.69.231.128/28‚Ä¶}\ripsName : IP Addresses for Microsoft Endpoint Manager Perfect, we now have all we need to create reusable groups based on service, though if you\u0026rsquo;re fond of the more restrictive firewall rule keeping reading.\nGrouping by Ports # This is where it get\u0026rsquo;s a little more interesting, as you\u0026rsquo;d think there would be some consistency with the format of the string of ports contained in the tcpPorts and udpPorts values coming from the web service, there is not, so we need a way to deal with values essentially being the same, so 80, 443 and 443, 80, which, are, the, same. Please fix this Microsoft.\nEither way, with a bit of string bashing and a dirty .Foreach loop, we can reformat the tcpPorts and udpPorts values, keeping them in the same $endpointSets variable, so we can unify URLs and IP addresses where the port requirements are exactly the same.\n$reusableSettings = @() $endpointSets.ForEach({ if ($_.tcpPorts) { $_.tcpPorts = $(($_.tcpPorts.Replace(\u0026#39; \u0026#39;, \u0026#39;\u0026#39;).Split(\u0026#39;,\u0026#39;) | Sort-Object) -join \u0026#39;,\u0026#39;) } if ($_.udpPorts) { $_.udpPorts = $(($_.udpPorts.Replace(\u0026#39; \u0026#39;, \u0026#39;\u0026#39;).Split(\u0026#39;,\u0026#39;) | Sort-Object) -join \u0026#39;,\u0026#39;) } }) $tcpSets = $endpointSets | Group-Object tcpPorts foreach ($tcpSet in $tcpSets) { $urls = $tcpSet.Group.urls | Sort-Object | Get-Unique $ips = $tcpSet.Group.ips | Sort-Object | Get-Unique $tcpPorts = $tcpSet.Name $name = $tcpSet.Group.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + \u0026#39; URLs and IPs\u0026#39; + \u0026#39; TCP \u0026#39; + $tcpPorts $description = \u0026#34;All URL and IP Network Endpoints for $name on TCP Port(s) $($tcpSet.Name)\u0026#34; $ipsName = \u0026#34;IP Addresses for $name\u0026#34; $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } $udpSets = $endpointSets | Where-Object { $null -ne $_.udpPorts } | Group-Object udpPorts foreach ($udpSet in $udpSets) { $urls = $udpSet.Group.urls | Sort-Object | Get-Unique $ips = $udpSet.Group.ips | Sort-Object | Get-Unique $udpPorts = $udpSet.Name $name = $udpSet.Group.serviceAreaDisplayName | Sort-Object | Get-Unique $displayName = $name + \u0026#39; URLs and IPs\u0026#39; + \u0026#39; UDP \u0026#39; + $udpPorts $description = \u0026#34;All URL and IP Network Endpoints for $name on UDP Port(s) $($udpSet.Name)\u0026#34; $ipsName = \u0026#34;IP Addresses for $name\u0026#34; $reusableSettings += [pscustomobject]@{displayName = $displayName; description = $description; urls = $urls; ips = $ips; ipsName = $ipsName } } There are some endpoints that have no TCP port or UDP port requirements, so instead of just releasing them into the wild, I\u0026rsquo;ve kept them in the TCP scope, as I thought they\u0026rsquo;d be more useful there. So with that, we now have our URLs and IP addresses grouped by their port requirements into the $reusableSettings array variable, ready for processing; you know, for the more secure manager of Windows Firewalls.\ndisplayName : Microsoft Endpoint Manager URLs and IPs TCP 3544,443,7680,80\rdescription : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 3544,443,7680,80\rurls : {*.dl.delivery.mp.microsoft.com, *.do.dsp.mp.microsoft.com, *.emdl.ws.microsoft.com, emdl.ws.microsoft.com}\rips :\ripsName : IP Addresses for Microsoft Endpoint Manager\rdisplayName : Microsoft Endpoint Manager URLs and IPs TCP 443\rdescription : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 443\rurls : {*.delivery.mp.microsoft.com, *.monitor.azure.com, *.notify.windows.com, *.prod.do.dsp.mp.microsoft.com‚Ä¶}\rips :\ripsName : IP Addresses for Microsoft Endpoint Manager\rdisplayName : Microsoft Endpoint Manager URLs and IPs TCP 443,80\rdescription : All URL and IP Network Endpoints for Microsoft Endpoint Manager on TCP Port(s) 443,80\rurls : {*.manage.microsoft.com, manage.microsoft.com}\rips : {104.46.162.96/27, 13.67.13.176/28, 13.67.15.128/27, 13.69.231.128/28‚Ä¶}\ripsName : IP Addresses for Microsoft Endpoint Manager\rdisplayName : Microsoft Endpoint Manager URLs and IPs UDP 123\rdescription : All URL and IP Network Endpoints for Microsoft Endpoint Manager on UDP Port(s) 123\rurls : {time.windows.com, www.msftconnecttest.com, www.msftncsi.com}\rips :\ripsName : IP Addresses for Microsoft Endpoint Manager Don\u0026rsquo;t worry, we\u0026rsquo;re near the bit you actually care about, the script to do all this for you.\nDeploying Reusable Groups of Firewall Settings # I won\u0026rsquo;t go into the ins and outs of the horrendous logic I used to create the correct JSON structure for multiple URLs, but you can dig through the script yourself if you are that way inclined. I will walk you through running the script, as this is the payoff to all of this.\nYou can run the script using the below as a reference, which will:\nAuthenticate to Graph using the Microsoft.Graph PowerShell module (No more MSAL.PS module for me). Connect to the web service for your selected instance (If you don\u0026rsquo;t select an instance it will default to Worldwide) Create reusable groups for Microsoft Online services (All services are selected by default unless you specify items in the serviceAreas parameter). Group the reusable groups by the service area or by ports (groupBy parameter). Pass through the tenantName parameter into any URL that supports it (think the SharePoint and OneDrive URLs). Deploying Service Area Based Settings # To add the reusable settings grouped by the serviceArea for all services in scope, use the below as an example:\n.\\Invoke-MgReusableFirewall.ps1 -tenantId \u0026#39;45019fd4-a342-4d98-9126-1b6f94904ac7\u0026#39; -tenantName \u0026#39;ennnbeee\u0026#39; -instance Worldwide -groupBy \u0026#39;service\u0026#39; All being well the script will go do it\u0026rsquo;s thing and create the settings in Microsoft Intune for you:\nScript created reusable firewall settings grouped by service area. It did, well done Microsoft Intune :clapping_hands:.\nDigging into the Microsoft Endpoint Manager URLS and IPs setting, we can see that the URLs are and IP addresses are now contained within the reusable setting.\nScript created reusable firewall settings grouped by service area for IP Addresses. Take my word for it, or use the script, to see the other reusable settings.\nDeploying Port Based Settings # To add the reusable settings grouped by the tcpPorts and udpPorts for all services in scope, use the below as an example:\n.\\Invoke-MgReusableFirewall.ps1 -tenantId \u0026#39;45019fd4-a342-4d98-9126-1b6f94904ac7\u0026#39; -tenantName \u0026#39;ennnbeee\u0026#39; -instance Worldwide -groupBy \u0026#39;ports\u0026#39; And after the script works out what to do with all the values, we get the below in Microsoft Intune:\nScript created reusable firewall settings grouped by network port. Now looking at the Exchange Online URLs and IPs TCP 143,587,993,995 setting, again all required URLs and IP addresses have been added to the group.\nScript created reusable firewall settings IP addresses grouped by network port. Brilliant, no more copy/paste for me, or in fact, you.\nSummary # With the reusable firewall settings now in place in Microsoft Intune after being deployed using the script, you can use these groups in existing or new firewall rules policies that support reusable settings, allowing you to either configure a blanket allow all for the service areas, or be more specific and allow only the port requirements for each service area based on data provided by Microsoft in their web service.\nI would look at how to automatically create these firewall rule policies automatically, but I\u0026rsquo;m still scared of dealing with the logic behind creating them from last time, but at least you\u0026rsquo;re not having to copy and paste URls and IP addresses for Microsoft Online services into Microsoft Intune any more.\n","date":"9 March 2024","externalUrl":null,"permalink":"/posts/resusable-firewall-settings-microsoft-online/","section":"Posts","summary":"It\u0026rsquo;s time to remove another manual process, this time the creation of Microsoft 365 network endpoints for Windows Firewall Rules in Microsoft Intune, because nobody should be creating these manually.","title":"Creating Reusable Groups of Firewall Settings for Microsoft Online Services","type":"posts"},{"content":"So this isn\u0026rsquo;t the first time we\u0026rsquo;ve looked at improving the management of updates using Microsoft Intune, and probably won\u0026rsquo;t be the last time either, especially with declarative device management looming, for Apple and hopefully Windows devices, covering configuration of software updates.\nBut with the introduction of the Windows Autopatch service, and getting hands on with it recently, it prompted me to revisit my previous approach to phased update delivery, so I thought I\u0026rsquo;d share my findings, this time across not just Windows Updates.\nDeployment Approach # Previously, we configured a set of four Update Rings, but now we\u0026rsquo;ll include an early adopters ring as a pre-production release, kind of a fail safe prior to your production deployment of updates; that final catch before you target the entire device estate:\nTest - This should be devices that are dedicated for testing, ~1% of your device estate. Pilot - This should be a stratified sample of either users or devices, ~5% of your device estate. Pre-Production - The early adopters deployment, ~15% of your device estate. Initial Production - The first production deployment, ~30% of your device estate. Final Production - The final production deployment, the remaining ~50% of the device estate. The aim is tht the above groupings are reusable and can be used across not just Windows Updates, but Office Updates, and Driver updates too. Let\u0026rsquo;s look at the membership of these groups.\nDeployment Groups # Despite Microsoft recommending to stop using the match operators in favour of startsWith there are times when you might have to ignore them, this could be one of those times when we look at how we split a device estate into the phased breakdowns we\u0026rsquo;re looking to achieve.\nAfter testing this in the real world, with reset Autopilot Hybrid join devices, you end up with a little bit of conflict on group membership due to there being two computer objects in Entra.\nTo avoid this, I\u0026rsquo;ve added in (device.deviceManagementAppId -ne null) to the group rules, only capturing those devices that are actually enrolled in Microsoft Intune.\nInefficient Dynamic Groups # For the members of Test and Pilot groups, these should be targeted members, not just any old device, so ensure you populate these groups with true test devices, and suitable pilot devices for update testing.\nYou\u0026rsquo;ll notice that this time we\u0026rsquo;re using Dynamic Groups across all the pre-production and production groups, and using a new attribute of deviceId, which is a wonderful UUID associated with all Entra computer objects, and it being a UUID gives us a nice split of devices based on the queries used.\nGroup Type Membership Test Group Assigned TBC Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceId -match \u0026quot;^[0-1,a]\u0026quot;) Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceId -match \u0026quot;^[2-4,b-c]\u0026quot;) Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and (device.deviceId -match \u0026quot;^[5-9,d-f]\u0026quot;) With the start of the deviceId only ever being in the range of 0-9 or a-f we\u0026rsquo;ve an easy way to split our devices across the three production level groups, and ensure that we are capturing all devices, using the match operator, and the regular expression similar to ^[0-9,a-f] to detect whether the deviceId starts with one of the values in the ranges provided.\nYou may want to tweak the rules used here, to alter the size of each of the production groups, by changing the range of the ^[0-9,a-f] query. Efficient Dynamic Groups # If you want to please Microsoft Daddy, then you could use these alternative queries for the groups, Test and Pilot are still assigned, so don\u0026rsquo;t forget to populate those members.\nGroup Type Membership Test Group Assigned TBC Pilot Group Assigned TBC Pre-Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;0\u0026quot;) or (device.deviceId -startsWith \u0026quot;1\u0026quot;) or (device.deviceId -startsWith \u0026quot;a\u0026quot;)) Initial Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;2\u0026quot;) or (device.deviceId -startsWith \u0026quot;3\u0026quot;) or (device.deviceId -startsWith \u0026quot;4\u0026quot;) or (device.deviceId -startsWith \u0026quot;b\u0026quot;) or (device.deviceId -startsWith \u0026quot;c\u0026quot;)) Final Production Group Dynamic Device (device.deviceManagementAppId -ne null) and (device.deviceOSType -eq \u0026quot;Windows\u0026quot;) and (device.deviceOwnership -eq \u0026quot;Company\u0026quot;) and ((device.deviceId -startsWith \u0026quot;5\u0026quot;) or (device.deviceId -startsWith \u0026quot;6\u0026quot;) or (device.deviceId -startsWith \u0026quot;7\u0026quot;) or (device.deviceId -startsWith \u0026quot;8\u0026quot;) or (device.deviceId -startsWith \u0026quot;9\u0026quot;) or (device.deviceId -startsWith \u0026quot;d\u0026quot;) or (device.deviceId -startsWith \u0026quot;e\u0026quot;) or (device.deviceId -startsWith \u0026quot;f\u0026quot;)) Much more efficient.\nVIP Groups # What about those people who complain about when they\u0026rsquo;re getting updates, I mean you could tell them to jog on that you can\u0026rsquo;t change the behaviour, or you could cater for the more VIP user, and allow for their device to sit in a different update group.\nSo more assigned groups are required for each potential exception or change to production level deployment options.\nGroup Type Membership VIP Pre-Production Group Assigned TBC VIP Initial Production Group Assigned TBC VIP Final Production Group Assigned TBC See, we can please the senior members of the company with IT solutions.\nWindows Update Rings # Now with suitable groups at our disposal, we can create our Windows Update Rings in Microsoft Intune for each of the five phases, and after reviewing and experiencing Windows Update Rings personally instead of just recommending them, I\u0026rsquo;ve decided to set zero-day installation deadlines, in favour of longer grace periods, still working within the National Cyber Security Centre 14-day window.\nUpdate Ring Deferral Deadline Grace Period Updates Installed Test 0 days 0 days 1 day After 1 day, Wednesday Pilot 2 days 0 days 1 day After 3 days, Friday Pre-Production 5 days 0 days 2 days After 7 days, Tuesday Initial Production 8 days 0 days 2 days After 10 days, Friday Final Production 11 days 0 days 3 days After 14 days, Tuesday You see something else new? Yes, I\u0026rsquo;ve avoided device restarts on weekends following a chat with fellow lover of Microsoft Intune, Jonathan Fallis, meaning that for a weekday based \u0026lsquo;working week\u0026rsquo;, updates get installed and devices restarted when the device is actually on, not over a weekend when realistically the device is still in the office and powered off, or being used to watch Netflix in bed.\nThis also allows for our VIP users to pick which day they actually want their device to restart, based on whatever day they\u0026rsquo;re not playing golf üèåÔ∏è‚Äç‚ôÄÔ∏è.\nOffice Update Rings # Oooooh this one is new, and straight up robbed from Windows Autopatch, and although doesn\u0026rsquo;t exist as a dedicated blade in Microsoft Intune, we can use the glorious Settings Catalog profiles to configure Office Update Channels, deferral, and deadline settings for Microsoft 365 App updates.\nTo start, we need to configure some baseline Office Update settings. So go create yourself a new Settings Catalog profile, and throw the below settings into it.\nCategory Setting Value Microsoft Office 2016 (Machine) \u0026gt; Updates Location for updates: (Device) http://officecdn.microsoft.com/pr/55336b82-a18d-4dd6-b5f6-9e5095c314a6 Microsoft Office 2016 (Machine) \u0026gt; Updates Enable Automatic Updates Enabled Microsoft Office 2016 (Machine) \u0026gt; Updates Hide option to enable or disable updates Enabled Microsoft Office 2016 (Machine) \u0026gt; Updates Hide Update Notifications Disabled Microsoft Office 2016 (Machine) \u0026gt; Updates Update Channel Enabled Microsoft Office 2016 (Machine) \u0026gt; Updates Channel Name (Device) Monthly Enterprise Channel Microsoft Office 2016 (Machine) \u0026gt; Updates Update Path Enabled With the update channel configured to Monthly Enterprise, and a bit of a change to the user experience, let\u0026rsquo;s see what else we can borrow from Windows Autopatch.\nMake sure you assign this to all your devices in scope of updates, using either an existing group, or the built in \u0026lsquo;All Devices\u0026rsquo; group and a suitable Device Filter. Phased Office Updates # With a similar approach to the Windows Update Rings, we can create corresponding Settings Catalog profiles for our five deployment phases, aligning as best we can the end result, which is installed updates, to the restart of the updates delivered as part of the Windows Update ring configuration.\nAll settings exist under the same category as before, Microsoft Office 2016 (Machine) \u0026gt; Updates.\nUpdate Ring Delay downloading and installing updates for Office Days: (Device) Update Deadline Deadline: (Device) Updates Installed Test Enabled 0 Enabled 1 After 1 day, Wednesday Pilot Enabled 2 Enabled 1 After 3 days, Friday Pre-Production Enabled 5 Enabled 2 After 7 days, Tuesday Initial Production Enabled 8 Enabled 2 After 10 days, Friday Final Production Enabled 11 Enabled 3 After 14 days, Tuesday As Office Updates are released with the same update cadence as our normal updates on a \u0026lsquo;Patch Tuesday\u0026rsquo;, then the installation time falls on the same days, meaning that all updates should be installed and the device restarted on the same day, reducing overall disruption to the users.\nUpdate Ring Assignment # After creating the Windows Update Rings, and our faux Office Update Rings using the above settings, we cover how we assign our phased deployment groups to each suitable Update Ring.\nFeel free to alter the deferral, deadline, and grace periods where applicable to your device estate, but please if you want the experience to be as expected, use the below assignment targets. Update Ring Included Groups Excluded Groups Test Test Group - Pilot Pilot Group Test Group Pre-Production Pre-Production Group Test Group, Pilot Group Initial Production Initial Production Group Test Group, Pilot Group Final Production Final Production Group Test Group, Pilot Group I\u0026rsquo;m assuming here that you aren\u0026rsquo;t putting VIP user devices in Test and Pilot, because you don\u0026rsquo;t want to anger them, maybe do it on your last day .\nThis is an improvement on our previous version of Update Ring assignment, as we\u0026rsquo;re not relying on excludes and dynamic groups to update to ensure there are no conflicts. VIP Ring Assignment # To get the expected behaviour for our VIP groups, we need to consider what happens when we want to ensure a VIP device is in the correct Update Ring, which includes making sure there are no conflicts across the rings.\nChanging the assignments of our Update Rings to the below, will allow for the manual assignment based on a devices VIP group membership.\nUpdate Ring Included Groups Excluded Groups Test Test Group - Pilot Pilot Group Test Group Pre-Production Pre-Production Group, VIP Pre-Production Test Group, Pilot Group, VIP Initial Production, VIP Final Production Initial Production Initial-Production Group, VIP Initial-Production Test Group, Pilot Group, VIP Pre-Production, VIP Final Production Final Production Final Production, VIP Final Production Test Group, Pilot Group, VIP Pre-Production, VIP Initial Production For example if device name VIP-7wa7f4c35, with deviceId ec759183-4492-44f4-a2ec-dbc33470bf48 (which will captured by the \u0026lsquo;Final Production\u0026rsquo; dynamic group), is added to group VIP Initial Production, it will exclude the device from the \u0026lsquo;Final Production\u0026rsquo; Update Ring, and assign the Update Ring for \u0026lsquo;Initial Production\u0026rsquo;, with the device restarting after updates on a Friday.\nAdding in not only new include assignments, but exclude assignments, will ensure that devices in these groups are assigned to the correct Update Ring.\nSummary # All of this should give you the option to not only suitably phase Windows, Microsoft, and Office Updates, with each subsequent Update Ring starting only after the next, but also allow the shift of devices around without conflict, whether this is for VIP users or otherwise.\nIt also provides your end users with clear details of the days of when their device will not only get updated, but also restart, without too much of a headache, or interruption to their casual personal use of their corporate owned device.\n","date":"19 February 2024","externalUrl":null,"permalink":"/posts/flexible-update-deployments/","section":"Posts","summary":"It\u0026rsquo;s been a while since we\u0026rsquo;ve looked at deploying Microsoft and Windows Updates using Microsoft Intune, this time we look at different ways to phase our deployments across a device estate.","title":"A Flexible Approach to Microsoft Update Deployments","type":"posts"},{"content":"This isn\u0026rsquo;t the first time we\u0026rsquo;ve looked at deploying backgrounds for Microsoft Teams on macOS, but it\u0026rsquo;s been a while since we answered an internet strangers question, and hopefully my scripting has come on a little way since then (spoiler: it hasn\u0026rsquo;t).\nNow that the \u0026lsquo;New\u0026rsquo; Microsoft Teams app is the de facto version available to download from Microsoft replacing the \u0026lsquo;Classic\u0026rsquo; one, we should at least look at how it handles uploaded backgrounds and if required update our existing script to support not only the \u0026lsquo;Classic\u0026rsquo; version, but the \u0026lsquo;New\u0026rsquo; version too.\nApplication Differences # Before we go digging into the existing script to work out what has broken with the new version of app, we should check to see what, if any differences there are across both version for the purpose of our script.\nUploaded Background Locations # Digging around the internet, and on a macOS device with both apps installed, we can see that uploaded backgrounds from the client itself are stored in the below locations:\nClassic App - $HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads New App - $HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads So this is similar to the change in uploaded background location for the Windows version that Florian Salzmann found in their post about updating backgrounds for the new Windows Teams client.\nApplication Name # Another thing to note, is how we were detecting whether the Teams app was installed, referencing the app name, which has also changed, only slightly though but it is still a change:\nClassic App - Microsoft Teams classic.app New App - Microsoft Teams (work or school).app Great, so we need to take into account the file path change, and the app name change. Anything else Microsoft?\nBackground File Names # Yes, obviously. When testing the upload of a background in the \u0026lsquo;New\u0026rsquo; app, I noticed that the background files are renamed to a UUID and created a thumbnail file of the same background, so something similar to the below.\n898ffbba-4997-4911-b2ab-b5d8ef4998d2.png and 898ffbba-4997-4911-b2ab-b5d8ef4998d2_thumb.png\nOK, so we\u0026rsquo;ll need a way to generate a UUID whilst we\u0026rsquo;re at it. The \u0026lsquo;Classic\u0026rsquo; app doesn\u0026rsquo;t care what the files are called, which might be useful.\nBackground Deployment Script # Let\u0026rsquo;s start at least with the existing script and amend or update it to take into consideration the following:\nDetection of whether a Teams app is installed. Detection of which of the \u0026lsquo;Classic\u0026rsquo; or \u0026lsquo;New\u0026rsquo; apps is installed. Managing which directory is used for the uploaded backgrounds. Managing the use of a UUID for the background files for the \u0026lsquo;New\u0026rsquo; app. Not a lot to consider, and with our new found exposure to Shell scripts, we should be more than capable \u0026#x1f610;.\nVariables and Logs # As the uploaded backgrounds will reside within the context of the user signed in to the macOS device, we need to ensure that the script, when running from Microsoft Intune is also running under the user context.\nThis means that the log file stored in path set by the logAndMetaDir variable, must be accessible to the user, hence the choice and use of the built-in variable $HOME.\nYou should update the backGroundUrls array variable with the URLs for the backgrounds you want to use in Microsoft Teams, otherwise everything will look like I branded it.\nbackGroundUrls=(\u0026#34;https://raw.githubusercontent.com/ennnbeee/ennnbeee.github.io/main/bgr.png\u0026#34; \u0026#34;https://raw.githubusercontent.com/ennnbeee/ennnbeee.github.io/main/img/featured.png\u0026#34;) scriptName=\u0026#34;SetNewTeamsBackgrounds\u0026#34; logAndMetaDir=\u0026#34;$HOME/Library/Logs/Microsoft/IntuneScripts/$scriptName\u0026#34; # Running under the user context log=\u0026#34;$logAndMetaDir/$scriptName.log\u0026#34; if [ -d $logAndMetaDir ]; then echo \u0026#34;# $(date) | Log directory already exists - $logAndMetaDir\u0026#34; else echo \u0026#34;# $(date) | Creating log directory - $logAndMetaDir\u0026#34; mkdir -p \u0026#34;$logAndMetaDir\u0026#34; fi We\u0026rsquo;re covering off the logic to create the log file directory whilst we\u0026rsquo;re at it, so we can at least write the output of the script to a file log in this location.\nChecking versions of the Teams App # Having spent a lot of time browsing the shell-intune-samples GitHub repo, and testing a number of these scripts, the Dock script caught my eye, as it was updated to detect which version of Teams is installed when attempting to add it to a Dock configuration.\nSo I\u0026rsquo;ve taken the existing function, and updated it for our purpose, to not only set the teamsApp variable of the app, but also the teamsUpload variable for the path to the uploaded background folders.\nfunction checkAndSetInstalledMSTeamsPath () { if [[ -a \u0026#34;/Applications/Microsoft Teams.app\u0026#34; ]];then teamsApp=\u0026#34;/Applications/Microsoft Teams.app\u0026#34; teamsUpload=\u0026#34;$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\u0026#34; elif [[ -a \u0026#34;/Applications/Microsoft Teams classic.app\u0026#34; ]];then teamsApp=\u0026#34;/Applications/Microsoft Teams classic.app\u0026#34; teamsUpload=\u0026#34;$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\u0026#34; elif [[ -a \u0026#34;/Applications/Microsoft Teams (work or school).app\u0026#34; ]]; then teamsApp=\u0026#34;/Applications/Microsoft Teams (work or school).app\u0026#34; teamsUpload=\u0026#34;$HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads\u0026#34; elif [[ -a \u0026#34;/Applications/Microsoft Teams (work preview).app\u0026#34; ]]; then teamsApp=\u0026#34;/Applications/Microsoft Teams (work preview).app\u0026#34; teamsUpload=\u0026#34;$HOME/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads\u0026#34; fi } We can now call this function to populate the two defined variables, and also detect whether the variable is empty to detect whether Teams is actually installed or not.\nDetecting if Teams is Installed # We\u0026rsquo;ve configured two variables here, ready and teamsMissing, this allows us to continue the running of the script until Teams is actually detected, and in the event that it is installed, will allow the script to continue.\nready=0 while [[ $ready -ne 1 ]];do teamsMissing=0 checkAndSetInstalledMSTeamsPath if [[ -z \u0026#34;$teamsApp\u0026#34; ]]; then let teamsMissing=$teamsMissing+1 echo \u0026#34;$(date) | Microsoft Teams application is missing.\u0026#34; else echo \u0026#34;$(date) | Microsoft Teams application is installed.\u0026#34; fi if [[ $teamsMissing -eq 0 ]]; then ready=1 echo \u0026#34;$(date) | Microsoft Teams App $teamsApp found, lets download the backgrounds.\u0026#34; else echo \u0026#34;$(date) | Waiting for 10 seconds before trying again.\u0026#34; sleep 10 fi done Ensure that you are deploying one of the app versions to your macOS devices using Microsoft Intune, before deploying the script, otherwise it\u0026rsquo;s going to sit there and run in the background.\nCreating the Uploads Directory # Now that we\u0026rsquo;re on the move the download of the files to the correct background upload directory, we should detect whether the directory exists, and if not create it.\nif [[ -d ${teamsUpload} ]] then echo \u0026#34;$(date) | Microsoft Teams Background Upload directory [$teamsUpload] already exists\u0026#34; else echo \u0026#34;$(date) | Creating directory [$teamsUpload]\u0026#34; mkdir -p \u0026#34;$teamsUpload\u0026#34; fi For the \u0026lsquo;Classic\u0026rsquo; app, unless you have actually uploaded a background through the client yourself, this directory doesn\u0026rsquo;t exist.\nDownloading the Backgrounds # As mentioned, the \u0026lsquo;New\u0026rsquo; app needs the files stored with UUID filenames, and the \u0026lsquo;Classic\u0026rsquo; app doesn\u0026rsquo;t care, as this is the case, we can just use a UUID file name for both scenarios.\nGenerating a UUID on macOS we can use uuidgen, and we\u0026rsquo;ve converted the output of this command to lowercase, assigning two new variables backgroundFile and backgroundThumb to use the uuid variable in their file name.\nSo looping through each backGroundUrl in the backGroundUrls array, we can go and download the file to the relevant directory, saved with the UUID file name.\nfor backGroundUrl in \u0026#34;${backGroundUrls[@]}\u0026#34;; do uuid=$(uuidgen | tr \u0026#34;[:upper:]\u0026#34; \u0026#34;[:lower:]\u0026#34;) backgroundFile=$uuid.png backgroundThumb=${uuid}_thumb.png curl -L -o \u0026#34;$teamsUpload/$backgroundFile\u0026#34; $backGroundUrl if [[ $teamsUpload = *Containers* ]];then curl -L -o \u0026#34;$teamsUpload/$backgroundThumb\u0026#34; $backGroundUrl fi done We\u0026rsquo;ve added in logic to detect whether the teamsUpload path variable is for the \u0026lsquo;New\u0026rsquo; app, and if it is, to download the background file but save it with the require _thumb in the filename.\nDeploying the Script # With the script to hand, we can now use Microsoft Intune Shell Scripts to deploy the script to our device estate with the below settings, having uploaded the downloaded file.\nSetting Value Description Run script as signed-in user Yes The background upload directory is a user directory. Hide script notifications on devices Yes Don\u0026rsquo;t tell users things are happening. Script frequency Not Configured We don\u0026rsquo;t want the script to run multiple times. Max number of times to retry if script fails 3 times If Teams isn\u0026rsquo;t installed and the device is restarted, we need a way to re-run the script. Assign this to a test group of macOS devices that has one of the Microsoft Teams apps installed, otherwise you\u0026rsquo;ll be waiting a long time to see the results.\nShell Script Results # Once a device has checked in to Microsoft Intune, and a user is signed in to the device, the script should run, storing the log file in the location defined in the variable.\nSo for this device it\u0026rsquo;s Users/ennbee/Library/Logs/Microsoft/IntuneScripts/SetNewTeamsBackgrounds\nLog directory. We can now check our test devices, one running the \u0026lsquo;Classic\u0026rsquo; app, and one the \u0026lsquo;New\u0026rsquo; app to see what has actually happened.\n\u0026lsquo;Classic\u0026rsquo; Teams Results # Opening the log file, we can see the results of the script running on a device with the \u0026lsquo;Classic\u0026rsquo; app.\nLog for Classic Teams. With the files downloaded to the Users/ennbee/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads directory.\nHaving a look in the directory location, we can see that two new files exist, both with UUID based filenames.\nBackgrounds directory for Classic Teams. Opening \u0026lsquo;Classic\u0026rsquo; Teams, we can now see and use these uploaded backgrounds.\nClassic Teams showing the backgrounds. \u0026lsquo;New\u0026rsquo; Teams Results # It\u0026rsquo;s a similar story with the \u0026lsquo;New\u0026rsquo; apps, with the log showing successful download of the backgrounds to Users/ennbee/Library/Containers/com.microsoft.teams2/Data/Library/Application Support/Microsoft/MSTeams/Backgrounds/Uploads.\nLog for New Teams. This time we also have the creation of the thumbnail files in the same directory.\nBackgrounds directory for New Teams. When opening the \u0026lsquo;New\u0026rsquo; Teams app (notice the icon in the top left), we have the uploaded backgrounds available as well.\nNew Teams showing the backgrounds. If the Teams app is already open when the script runs to download the new backgrounds, they won\u0026rsquo;t be available until the app is closed and re-opened. Summary # It\u0026rsquo;s been a while since I\u0026rsquo;ve had to put together a new Shell script for macOS, but with Microsoft investing more functionality for macOS devices in Microsoft Intune, and with recent updates to the shell-intune-samples GitHub repo, now is a great time to look at how to better manage your macOS device estate using the new tooling and capabilities.\nBeing a personal macOS user, but a professional Windows 11 user, it\u0026rsquo;s a pretty exciting time that Microsoft Intune is providing more and more support for macOS devices at an enterprise level.\nHowever until there is native ability to deploy backgrounds (for free) to your macOS Teams clients, you\u0026rsquo;ll have to rely on people like me spending their spare time writing hacky looking Shell scripts üòÖ.\n","date":"14 February 2024","externalUrl":null,"permalink":"/posts/macos-teams-new-backgrounds/","section":"Posts","summary":"With the availability of the new Microsoft Teams client for macOS, we should build upon an existing script to deploy backgrounds, and update it to support not just the new version but the classic version as well.","title":"Custom Backgrounds for macOS New and Classic Microsoft Teams Apps","type":"posts"},{"content":"","date":"14 February 2024","externalUrl":null,"permalink":"/tags/microsoft-teams/","section":"Tags","summary":"","title":"Microsoft Teams","type":"tags"},{"content":"","date":"14 February 2024","externalUrl":null,"permalink":"/tags/shell-script/","section":"Tags","summary":"","title":"Shell Script","type":"tags"},{"content":"So we\u0026rsquo;re all onboard with the New Microsoft Store, and deploying both UWP and Win32 apps from Microsoft Intune is an absolute breeze, and reduces the effort of deploying applications to a click click next OK exercise. What about the UWP apps that are already installed on a Windows Autopilot device, shouldn\u0026rsquo;t we give them a bit of love? If you care at all about users and security you should.\nAllowing App Updates # Regardless of how you are blocking or allowing the Microsoft Store, remembering that the store needs to be available to allow for apps from Microsoft Intune to be deployed, we should at least configure devices to allow for updates.\nA simple Settings Catalog profile will do the job here, with the below settings configured.\nCategory Setting Value Microsoft App Store Allow apps from the Microsoft app store to auto update Allowed Settings Catalog profile for Microsoft Store. Assign this profile to your devices, all of them obviously, no testing needed here.\nForcing App Updates # There\u0026rsquo;s a lot of chatter about how to force store apps to update, but essentially we can kick off an update using the below Get-CimInstance query.\nGet-CimInstance -Namespace \u0026#34;Root\\cimv2\\mdm\\dmmap\u0026#34; -ClassName \u0026#34;MDM_EnterpriseModernAppManagement_AppManagement01\u0026#34; | Invoke-CimMethod -MethodName UpdateScanMethod Now as we\u0026rsquo;re calling areas that require elevation, standard users are bang out of luck from running this, and even running this elevated as Administrator does absolutely nothing for the apps themselves, something about install context.\nSo what are our options? Well for testing it\u0026rsquo;s PsExec.\nRunning the above from PowerShell running as system using PsExec.exe -s -i powershell.exe, we can kick off the app update query.\nPSEXEC running the store app update command. Nothing much to look at here, but if you\u0026rsquo;ve got the store open, you should now see updates in the Downloads and Updates section, if you\u0026rsquo;re lazy run start ms-windows-store://downloadsandupdates as a standard user to open the correct area of the store.\nThe Microsoft Store updating apps. Brilliant, apps are now trying their hardest to update. Now we\u0026rsquo;ve got a method to update the apps, no one is going to run this manually on a regular basis, and we love a Microsoft Intune Remediation.\nThis method will only update Store Apps installed in the System context if there is no user signed into the device; for Apps installed in the User context, a user must be signed in for the apps to update. Go figure üòÖ. Remediation Settings # So now we\u0026rsquo;ve got a way to start the update of the apps, let\u0026rsquo;s find a way to work out if we need to kick off an update. Back to the initial query we created, and if we run the below section of the command, we\u0026rsquo;ll get an output that we might be able to work with.\nGet-CimInstance -Namespace \u0026#34;Root\\cimv2\\mdm\\dmmap\u0026#34; -ClassName \u0026#34;MDM_EnterpriseModernAppManagement_AppManagement01\u0026#34; The result of the Get-CimInstance query. Guess what, we do, that LastScanError is looking mighty interesting, and it being Microsoft I bet that an exit code of zero means success, but we should have a look at the reference document just in case.\nReports the last error code returned by the update scan.\nThis is a required node.\nOK, so it isn\u0026rsquo;t that clear, but we\u0026rsquo;ve got a way to detect whether the last update of apps was successful, and with the Settings Catalog policy created earlier we should be keeping apps up to date from then on.\nDetection Script # We can use the above, and a little logic to detect whether the result of the LastScanError is a zero or not, and if it\u0026rsquo;s not a zero throw an Exit 1 to allow a remediation to run.\ntry { $wmiObj = Get-CimInstance -Namespace \u0026#34;Root\\cimv2\\mdm\\dmmap\u0026#34; -ClassName \u0026#34;MDM_EnterpriseModernAppManagement_AppManagement01\u0026#34; if ($wmiObj.LastScanError -ne \u0026#39;0\u0026#39;) { Write-Output \u0026#34;Windows Store Apps not updated.\u0026#34; Exit 1 } else { Write-Output \u0026#34;Windows Store Apps updated.\u0026#34; Exit 0 } } catch { Write-Output \u0026#34;Unable to query Store App Update status.\u0026#34; Exit 2000 } On to the remediation portion.\nRemediation Script # We\u0026rsquo;ve already done the ground work with the previous queries to test the update of apps, so this one is very straightforward.\nTry { Get-CimInstance -Namespace \u0026#34;Root\\cimv2\\mdm\\dmmap\u0026#34; -ClassName \u0026#34;MDM_EnterpriseModernAppManagement_AppManagement01\u0026#34; | Invoke-CimMethod -MethodName UpdateScanMethod Write-Output \u0026#34;Windows Store Apps updated.\u0026#34; Exit 0 } Catch { Write-Output \u0026#34;Windows Store Apps not updated.\u0026#34; Exit 2000 } Just make sure we\u0026rsquo;re exiting with the correct codes, and giving an explanation, as per the detection script, of the result of the remediation.\nDeploying the Remediation # We\u0026rsquo;ve seen remediations a handful of times now in this blog, so go ahead and create a new Remediation Script in Microsoft Intune mirroring the below settings. Be aware that we definitely do not want to be running this as the user, we need that glorious system context.\nMicrosoft Intune Remediation Script. I\u0026rsquo;ve assigned this to All Devices with my beloved Device Filters on a daily schedule, but if you\u0026rsquo;re more cautious than I am, assign this to a smaller proof-of-concept group.\nAfter a while, you should start seeing the results of the Remediation, and hopefully positive ones to boot.\nMicrosoft Intune Remediation Results. If all goes well, your devices will start actually updating the \u0026lsquo;Built In\u0026rsquo; apps you haven\u0026rsquo;t ripped out with a PowerShell script, and Microsoft Intune UWP store apps you\u0026rsquo;ve deployed, though your users may start complaining about the apps looking like they\u0026rsquo;re loading in the Start Menu üòÇ.\nSummary # All in all a quick and dirty solution to a very simple problem with new Windows Autopilot devices and existing Microsoft Intune managed Windows devices, at least this way they\u0026rsquo;ll do what they should have done in the first place and just keep themselves updated.\nIf only all the issues I encounter during my days could be solved with a simple Remediation script.\nThe detection and remediation scripts are available, as always in my Github Repo. ","date":"6 February 2024","externalUrl":null,"permalink":"/posts/updating-windows-store-apps/","section":"Posts","summary":"Now we all love the new Windows Store, especially for deploying applications from Microsoft Intune, but we should find a way to keep these UWP applications up to date without additional license cost.","title":"Keeping Windows Store Apps Updated with Microsoft Intune","type":"posts"},{"content":"If you\u0026rsquo;ve been under a rock, or like me, don\u0026rsquo;t have to manage updates on a Windows device estate any more, chances are you might not have seen the issues with the size of the Windows Recovery Environment or WinRE, partition when applying Windows Updates like KB5034441, luckily Microsoft released a \u0026lsquo;fix\u0026rsquo; for this in KB5028997 to resize the partition to allow for updates to install.\nNow if this were me, I\u0026rsquo;d be looking for a way to push out this fix to the impacted devices, and thanks to u/InternetStranger4You, they created a PowerShell script to do just that, so all credit goes their way.\nSo why I am writing this? Well, let\u0026rsquo;s find a way to use Microsoft Intune Remediations, to detect and fix devices that are falling short of the partition size requirement.\nDetection Methods # To get ourselves in a good position, we should look at a way to detect that the existing Windows Recovery Environment partition is of a suitable size, from this we can either leave it well alone, or hack at it to increase it\u0026rsquo;s size, once, and only once.\nFirst We Detect # Working with the remediation format and capture of information, we can quite simply loop through all physical disks with Get-PhysicalDisk, detecting where one of these disks contains partitions with a \u0026lsquo;C\u0026rsquo; drive (Yes I am assuming here that the disk holding the C drive is holding the Recovery Partition, prove me wrong though), using Get-Partition, and then comparing the size of the disk to our variable in bytes, $partitionSize. and then get the amount of free space available in the volume with Get-Volume, comparing this to our variable for required space $freePartitionSpace.\nThe detection method has been updated to detect free space in the Recovery Partition, instead of blindly increasing it by 250MB. #Recovery Partition free size required for KB5028997 $freePartitionSpace = \u0026#39;250000000\u0026#39; #bytes Try { $computerDisks = Get-PhysicalDisk foreach ($computerDisk in $computerDisks) { $diskPartitions = Get-Partition -DiskNumber $computerDisk.DeviceId -ErrorAction Ignore if ($diskPartitions.DriveLetter -contains \u0026#39;C\u0026#39; -and $null -ne $diskPartitions) { $systemDrive = $computerDisk } } $recPartition = Get-Partition -DiskNumber $systemDrive.DeviceId | Where-Object { $_.Type -eq \u0026#39;Recovery\u0026#39; } $recVolume = Get-Volume -Partition $recPartition if ($recVolume.SizeRemaining -le $freePartitionSpace) { Write-Output \u0026#34;Recovery Partition Free Space $($($recVolume.SizeRemaining) / 1000000) MB is smaller than required $($freePartitionSpace / 1000000) MB\u0026#34; Exit 1 } else { Write-Output \u0026#34;Recovery Partition Free Space $($($recVolume.SizeRemaining) / 1000000) MB is larger than required $($freePartitionSpace / 1000000) MB\u0026#34; Exit 0 } } Catch { Write-Output \u0026#39;Recovery Partition not found.\u0026#39; Exit 2000 } If the result of the comparison is that the size of the partition is smaller than the 750MB configured in $partitionSize free space of the partition is smaller than the 250MB configured in $freePartitionSpace, then we\u0026rsquo;ll report the status with Write-Output and Exit 1, otherwise, all is OK so we Exit 0 still reporting something.\nThen We Report # So, we should see how many devices are effected by a small partition size, so for fun, we can push out just the detection script using a Remediation, but with a non-functioning remediation script.\nWrite-Output \u0026#34;Reporting Only\u0026#34; Exit 0 This will at least give you some idea of the devices that would be impacted by the true remediation script.\nMicrosoft Intune Remediation Script for reporting. I\u0026rsquo;ve assigned this to the All Devices group, but with a Device Filter for only corporate owned devices, set to run once, as we\u0026rsquo;re just reporting on this issue for now.\nMicrosoft Intune Remediation assignment for reporting. After waiting a little while, or if you\u0026rsquo;re impatient use the on-demand feature, we can then review the results; we can see several devices that are now complaining that their WinRE partition is too small.\nMicrosoft Intune Remediation reporting results. Luckily for us, there are at least some devices where they are happy with the size of their partition.\nMicrosoft Intune Remediation reporting detail. Remediation Methods # As we have a good understanding following the implementation of the report only style Remediation, we can now investigate how best to actually fix the issue. For this, we can take the existing script by u/InternetStranger4You and modifying it to support the required exit codes for Microsoft Intune.\nScript Breakdown # The script itself is taking the manual steps detailed by Microsoft in KB5028997, and wrapping them nicely in PowerShell, but I\u0026rsquo;ll walk through the settings so we\u0026rsquo;re all on the same page:\nEnsures that the script can read the contents of the reagentc.exe command by capture the output of the process using New-Object System.Diagnostics.ProcessStartInfo as the output data is used throughout the script. Checks if there is anything wrong with WinRE with if (($stdout.IndexOf('harddisk') -ne -1) -and ($stdout.IndexOf('partition') -ne -1)), and if so exits. Disables the recovery environment Start-Process 'reagentc.exe' -ArgumentList '/disable' -Wait -NoNewWindow to allow for modification to the partition. Captures information about the Disk the Recovery partition sits on, and the partition itself. Resizes the partition beneath the Recovery partition by 250MB Get-Disk $diskNum | Resize-Partition -PartitionNumber ($recPartNum - 1) -Size ($size - 250MB) Removes the existing Recovery partition aggressively Get-Disk $diskNum | Remove-Partition -PartitionNumber $recPartNum -Confirm:$false Passes the required arguments for DiskPart to a text file \u0026lsquo;ResizeREScript.txt\u0026rsquo; located in $env:TEMP that can be called on later that: Creates a new partition on the disk based on whether the partition style is GPO or MBR Applies the correct attributes to the new partition to configure it as a Recovery partition Formats the partition in NTFS format Finally enabling the recovery agent with Start-Process 'reagentc.exe' -ArgumentList '/enable' -Wait -NoNewWindow to allow for the failing update to be installed. All of these settings are exactly as per the Microsoft provided document, but you know, done for you.\nNow We Attack # To allow the script to work within a Remediation, we need to ensure that the data being passed back to Microsoft Intune is suitable, and other that wrapping the bulk of the script in some Try and Catch logic, and handling the output of the commands with Write-Output and corresponding Exit codes, there isn\u0026rsquo;t a whole heap for us to do thankfully.\n#Script to fix the recovery partition for KB5028997 by /u/InternetStranger4You, updated by Nick Benton #Mostly Powershell version of Microsoft\u0026#39;s support article: https://support.microsoft.com/en-us/topic/kb5028997-instructions-to-manually-resize-your-partition-to-install-the-winre-update-400faa27-9343-461c-ada9-24c8229763bf #Test in your own environment before running. Not responsible for any damages. Try { #Run reagentc.exe /info and save the output $pinfo = New-Object System.Diagnostics.ProcessStartInfo $pinfo.FileName = \u0026#39;reagentc.exe\u0026#39; $pinfo.RedirectStandardOutput = $true $pinfo.UseShellExecute = $false $pinfo.Arguments = \u0026#39;/info\u0026#39; $p = New-Object System.Diagnostics.Process $p.StartInfo = $pinfo $p.Start() | Out-Null $p.WaitForExit() $stdout = $p.StandardOutput.ReadToEnd() #Verify that disk and partition are listed in reagentc.exe /info. If blank, then something is wrong with WinRE if (($stdout.IndexOf(\u0026#39;harddisk\u0026#39;) -ne -1) -and ($stdout.IndexOf(\u0026#39;partition\u0026#39;) -ne -1)) { #Disable Windows recovery environment Start-Process \u0026#39;reagentc.exe\u0026#39; -ArgumentList \u0026#39;/disable\u0026#39; -Wait -NoNewWindow #Get recovery disk number and partition number $diskNum = $stdout.substring($stdout.IndexOf(\u0026#39;harddisk\u0026#39;) + 8, 1) $recPartNum = $stdout.substring($stdout.IndexOf(\u0026#39;partition\u0026#39;) + 9, 1) #Resize partition before the recovery partition $size = Get-Disk $diskNum | Get-Partition -PartitionNumber ($recPartNum - 1) | Select-Object -ExpandProperty Size Get-Disk $diskNum | Resize-Partition -PartitionNumber ($recPartNum - 1) -Size ($size - 250MB) #Remove the recovery partition Get-Disk $diskNum | Remove-Partition -PartitionNumber $recPartNum -Confirm:$false #Create new partion with diskpart script $diskpartScriptPath = $env:TEMP $diskpartScriptName = \u0026#39;ResizeREScript.txt\u0026#39; $diskpartScript = $diskpartScriptPath + \u0026#39;\\\u0026#39; + $diskpartScriptName \u0026#34;sel disk $($diskNum)\u0026#34; | Out-File -FilePath $diskpartScript -Encoding utf8 -Force $PartStyle = Get-Disk $diskNum | Select-Object -ExpandProperty PartitionStyle if ($partStyle -eq \u0026#39;GPT\u0026#39;) { #GPT partition commands \u0026#39;create partition primary id=de94bba4-06d1-4d40-a16a-bfd50179d6ac\u0026#39; | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force \u0026#39;gpt attributes =0x8000000000000001\u0026#39; | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force } else { #MBR partition command \u0026#39;create partition primary id=27\u0026#39; | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force } \u0026#34;format quick fs=ntfs label=`\u0026#34;Windows RE tools`\u0026#34;\u0026#34; | Out-File -FilePath $diskpartScript -Encoding utf8 -Append -Force Start-Process \u0026#39;diskpart.exe\u0026#39; -ArgumentList \u0026#34;/s $($diskpartScriptName)\u0026#34; -Wait -NoNewWindow -WorkingDirectory $diskpartScriptPath #Enable the recovery environment Start-Process \u0026#39;reagentc.exe\u0026#39; -ArgumentList \u0026#39;/enable\u0026#39; -Wait -NoNewWindow Write-Output \u0026#39;Recovery Partition Extended Successfully.\u0026#39; Exit 0 } else { Write-Output \u0026#39;Recovery partition not found. Aborting script.\u0026#39; Exit 1 } } Catch { Write-Output \u0026#39;Unable to update Recovery Partition on the device.\u0026#39; Exit 2000 } With the script now in a more useful format, on to how we deploy this to a select group of test devices.\nDeploying the Remediation # I would strongly advised testing this in small numbers before you go deploying the the All Devices group, and use a new Remediation with the same detection script method as before, but this time with the fully functioning remediation script, so we can actually fix this issue that Microsoft has caused.\nThe Remediation should look something like the below, again with a schedule for once as we don\u0026rsquo;t need this running more than once.\nMicrosoft Intune Remediation Script. If we\u0026rsquo;ve been successful in our deployment we should start seeing device report back the status of the remediation, and advise where there are issues with the size of the WinRE partition.\nMicrosoft Intune Remediation Detection results. Following the successful run of the remediation script, we now have an output of the results with a device that had issues with the partition size, now successfully remediated.\nMicrosoft Intune Remediation Remediation results. All is left to do now, is find some more test devices to add to the assignment group, and monitor their progress.\nSummary # In short, this should allow you to get over the hurdle caused by the failing update delivery, and also give the devices with the issue a push in the right direction following the update to their recovery partition size, to allow them to realise they can now install the update. I can\u0026rsquo;t take credit for the scripting of the Microsoft published resolution, that goes to u/InternetStranger4You, but with this and moving it to a Remediation in Microsoft Intune, means that it can do the heavy lifting on your behalf.\nOr you can just wait for Microsoft to release a fix, totally up to you.\nThanks to piotrxj in the comments for the updated detection method.\nI hold no responsibility for the impact to your devices or environments, please, please, please test this on devices you do not care about first before even contemplating pushing this to a wider audience. ","date":"31 January 2024","externalUrl":null,"permalink":"/posts/winre-parition-resize-kb5034441/","section":"Posts","summary":"When Microsoft releases an update that won\u0026rsquo;t install due to the size of a Recovery partition, what do you do? Follow the manual steps provided by Microsoft or blindly follow a script created by a stranger on the internet?","title":"Automatically Resizing the WinRE Partition for Windows Update KB5034441","type":"posts"},{"content":"Imagine you\u0026rsquo;ve spent time getting your Windows devices enrolled into Intune, they\u0026rsquo;re all getting Device Compliance policies, and you\u0026rsquo;ve finally pulled the trigger on your shiny new Conditional Access Policy that require device compliance for all your users across Windows devices, and low and behold, you\u0026rsquo;ve broken access to Microsoft 365 authenticated services from your Remote Desktop service environment, or even VDI environments.\nSo what next? Use the trusted location exemption in your policy for the virtual environment? What happens if the public facing address range is the same as your workstation environments or that you\u0026rsquo;d rather not blow a massive hole in security by allowing an entire IP address range free access to Microsoft 365 authenticated services? That\u0026rsquo;s not very Zero Trust of you is it.\nFiltering Devices # Luckily within the the Conditional Access Policy configuration, there is a way to filter devices based on the device object registered with Entra ID, there are some useful native device attributes that can be used as long as your devices have registered in Entra ID (think Hybrid Entra Joined for this VDI environment).\nWhat happens when you can\u0026rsquo;t find a suitable attribute to use that excludes your virtual environment, but still includes your end user computer workstations? The answer here are the attributes extensionAttribute1-15, which are attributes attached only to the Entra ID device object, and not synchronised, and require specific permissions to set using Graph. These seem like a good way to go.\nGetting Attributes # For us to understand how these attributes can be updated or added, we\u0026rsquo;d probably best take a look at how we see the attributes in the first place. Let\u0026rsquo;s start with a device in Entra ID, we can see from the below where these attributes should be:\nAn Entra ID Windows device. Currently this device has no attributes assigned, shock. We\u0026rsquo;ll need the Object ID in a second, so may as well grab it now.\nWhat about using Graph? We can pull back these attributes by querying the device itself, using a GET to https://graph.microsoft.com/beta/devices/{objectId}/, so for this device the call is https://graph.microsoft.com/beta/devices/492a52d0-ec1a-40ed-8ea5-79f27aa0f8bf/.\nGraph Explorer showing empty device attributes. Yup still no attributes.\nAdding Attributes # Now that we can see where these attributes reside on the device object in Entra ID, if we\u0026rsquo;re going to be using them as a filtering option in our Conditional Access Policy, we should probably have a look at how we update them.\nPretty straight forward, as it\u0026rsquo;s the device object we\u0026rsquo;re updating, we can create, remove, or replace these attributes using a PATCH to the same Graph endpoint https://graph.microsoft.com/beta/devices/492a52d0-ec1a-40ed-8ea5-79f27aa0f8bf/ using the JSON format in the documentation and like the example below.\n{ \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;extensionAttribute1\u0026#34;: \u0026#34;I\u0026#39;m an Attribute\u0026#34;, \u0026#34;extensionAttribute2\u0026#34;: \u0026#34;I\u0026#39;m also an Attribute\u0026#34; } } Punting the above to the device using Graph Explorer, we get the expected response of {} which is always pleasant, and querying the device object again with a GET, we can now see the attributes updated.\nGraph Explorer showing a new device attribute. We\u0026rsquo;re onto something here.\nUpdating or Removing Attributes # We need to be careful with our PATCH calls to the device object, as they will update the attributes, this means removal and update of existing attributes, you can see using the below example that we can change extensionAttribute1 and just plain remove extensionAttribute2.\n{ \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;extensionAttribute1\u0026#34;: \u0026#34;CAP-00-Out\u0026#34;, \u0026#34;extensionAttribute2\u0026#34;: \u0026#34;\u0026#34; } } Now the device object is an attribute crisis.\nGraph Explorer showing updated device attributes. I\u0026rsquo;ve given the attribute a sensible value of CAP-00-Out as we can utilise the range of operators available in the Conditional Access Policy device filter for the attributes.\nFilter for Devices # So now we have a way to essentially tag devices we want to exclude from a Conditional Access Policy, we should look at how we create a device filter, and also explore the fact we can build a naming convention with these \u0026ldquo;tags\u0026rdquo; and utilise the operators available.\nYou have to be careful with filtering within Conditional Access Policies, as there is some level of logic over not only supported operators, but also the attributes that use the operators, and how they are evaluated.\nFor our scenario, we\u0026rsquo;re going to use extensionAttributes which as of today, support the following operators Equals, NotEquals, StartsWith, NotStartsWith, EndsWith, NotEndsWith, Contains, NotContains, In, NotIn\nSo building a quick query in the policy, we can exclude devices where extensionAttribute1 equals CAP-00-Out.\nConditional Access Policy filter using the equals operator. Or if we want to be clever and capture devices where where extensionAttribute1 ends in Out regardless of the other content.\nConditional Access Policy filter using the ends with operator. So there is value in coming up with good naming conventions across all areas of Entra ID and Microsoft Intune, who knew?\nFiltering in Action # Having created a Conditional Access Policy in Report-only mode to Require device to be marked as compliant or Require Microsoft Entra hybrid joined device on Windows device platforms, with the filter to exclude devices matching device.extensionAttribute1 -eq \u0026quot;CAP-00-Out\u0026quot;, we can see in the sign in logs for the user in scope of the policy, when accessing Microsoft 365 authenticated resources, that they are not subject to the policy.\nUser sign in logs in Entra ID. Which for our situation is exactly the outcome we\u0026rsquo;re after. Now time to make this less of a manual process.\nPowerShell and Graph # I\u0026rsquo;ll assume you\u0026rsquo;re familiar with authenticating to Graph, and this time instead of the trusty MSAL.PS module I\u0026rsquo;m using Microsoft the native commands, ikr, shocking. Now that we\u0026rsquo;re connected to Graph with the required scope options using Connect-MgGraph -Scopes 'Device.ReadWrite.All', we need to be able to pull back all the devices we want to assign an attribute to.\nGetting Devices # Who knew that when working in non-development tenants that you\u0026rsquo;d have to consider pagination, so yeah, I had to throw something together to pull back all Entra ID device objects using the very same Graph endpoint we used earlier to look at a single device https://graph.microsoft.com/beta/devices/ and the Invoke-MgGraphRequest command.\nFunction Get-DeviceAAD() { $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;devices\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource\u0026#34; $GraphResults = Invoke-MgGraphRequest -Method GET -Uri $uri $Results = @() $Results += $GraphResults.value $Pages = $GraphResults.\u0026#39;@odata.nextLink\u0026#39; while ($null -ne $Pages) { $Additional = Invoke-MgGraphRequest -Method GET -Uri $Pages if ($Pages) { $Pages = $Additional.\u0026#39;@odata.nextLink\u0026#39; } $Results += $Additional.value } $Results } catch { Write-Error $Error[0].ErrorDetails.Message break } } For the pagination, we\u0026rsquo;re capturing the results of the web request into an array variable $Results, and looping through the @odata.nextLink data with a subsequent Graph calls, adding each result back into the same array variable until there are no more results. Simple right?\nRunning this will allow us to pull back all Entra ID device objects, and with the below we can present them in a table using Out-GridView.\n$Devices = @(Get-DeviceAAD | Select-Object displayName, operatingSystem, manufacturer, model, id, deviceId | Out-GridView -PassThru -Title \u0026#39;Select Devices to update extension attributes...\u0026#39;) Allowing the selection of the devices that need their extension attributes updating, and importantly the id of the device object used to update the attribute.\nThe PowerShell script grid view for Entra ID devices. Extension Attribute JSON # The JSON content we can build from another Out-GridView prompt, with some logic so that you only select a single extension Attribute to update, and we can pass that selection using $Attribute and a simple Read-Host to prompt for the value of the attribute itself, added to the $attributeValue variable into the JSON format needed to update the extension attributes.\n$extensionAttributes = @() for ($i = 1; $i -le 15; $i++) { $extensionAttributes += \u0026#39;extensionAttribute\u0026#39; + $i } $Attribute = @($extensionAttributes | Out-GridView -PassThru -Title \u0026#39;Select only one attribute you wish to update...\u0026#39;) while ($Attribute.count -gt 1) { Write-Host \u0026#39;Only select one attribute to update...\u0026#39; -ForegroundColor Yellow $Attribute = @($extensionAttributes | Out-GridView -PassThru -Title \u0026#39;Select only one attribute you wish to update...\u0026#39;) } With the data required now captured, we can build the JSON that can be passed to the device object Graph endpoint to update the required data.\n$JSON = @\u0026#34; { \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;$Attribute\u0026#34;: \u0026#34;$attributeValue\u0026#34; } } \u0026#34;@ Running these PowerShell sections in isolation we get a JSON output similar to the below:\n{ \u0026#34;extensionAttributes\u0026#34;: { \u0026#34;extensionAttribute1\u0026#34;: \u0026#34;CAP-00-Out\u0026#34; } } Giving us the required data and attribute value to update the device object, now we just need a function to do this.\nUpdating Attributes Function # With the device or devices now at our disposable, including the Id we used earlier in Graph Explorer, we could do with a function to update the device with the new extension attribute value, handing over the JSON content we created that is required to update the object.\nFunction Add-DeviceAttribute() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON, [parameter(Mandatory = $true)] $deviceID ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;devices/$deviceID\u0026#34; try { Test-Json -Json $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } Now we can run the below passing in the device object id and the JSON content to update the device attributes.\nforeach ($device in $devices){ Add-DeviceAttribute -deviceID $device.id -JSON $JSON } Bulk Updating Device Attributes # Now we have all the component parts, we can build the full script giving us an option with Mode and options Update and Remove to choose whether we want to update attributes, or remove them.\nRemoving Attributes # We should probably run this a couple of times to show what the script can do, we\u0026rsquo;ll start with removing the data in an attribute using the below.\n./Invoke-DeviceExtensionAttributes.ps1 -tenantId \u0026#39;e3bdd962-ac3d-4bd1-9b3c-39eebfee352b\u0026#39; -Mode Remove Taking our existing device PHXNB-695630804 we used and manually added attributes to, we can clear our original data in extensionAttribute1.\nSelecting the device when prompted.\nThe PowerShell script grid view for Entra ID devices. Selecting the attribute we want to clear.\nThe PowerShell script grid view for extension attributes to be removed. Confirming we want to continue.\nThe PowerShell script prompting whether to continue with the removal of the extension attribute. Now we can check the device in Entra ID and confirm that the attribute has now been cleared.\nA device in Entra ID with the extension attribute removed. Now that we\u0026rsquo;ve got a blank canvas, let\u0026rsquo;s update some device objects with a new extension attribute value.\nUpdating Attributes # We can now run the script again, but with the Update option, and start tagging multiple devices at once.\n./Invoke-DeviceExtensionAttributes.ps1 -tenantId \u0026#39;e3bdd962-ac3d-4bd1-9b3c-39eebfee352b\u0026#39; -Mode Update This time we\u0026rsquo;re asked to enter in the value of the attribute, here entering CAP-00-Out\nThe PowerShell script prompting for the attribute value. Selecting a handful of devices when prompted.\nThe PowerShell script grid view for Entra ID devices. Selecting the attribute we want to update.\nThe PowerShell script grid view for extension attributes to be added. This warning section now shows how many devices, the attribute extension to be updated and the new value.\nThe PowerShell script prompting whether to continue with the update of the extension attribute. Confirming we want to continue, the devices have now been updated with the CAP-00-Out in extensionAttribute1.\nA device in Entra ID with the extension attribute confirmed. Checking a device in Entra ID gives us exactly the result we want.\nA device in Entra ID with the extension attribute updated. Take my word for it that the other five devices have updated too üòÖ.\nSummary # This may seem like a simple script, and honestly it is, but the application of the script, to allow for tagging of extension attributes by privileged accounts only, on Entra ID device objects, that are not overwritten by directory sync for hybrid joined Windows devices, changes to device operating system version etc. for all device objects, gives us two major bits of functionality:\nConditional Access Policy inclusion or exclusion Dynamic Security Groups Our use case was for exclusion of Conditional Access Policies, but with the dynamic security group option, the possibilities for tagging device objects in this way and grouping them becomes almost endless, want to group devices for specific configuration in Microsoft Intune? Yup. Want to group devices for specific application deployments in Microsoft Intune? Also yup. Want to exclude groups of devices from Microsoft Intune profiles for some reason where existing Entra ID attributes or Device Filters don\u0026rsquo;t cut it, this one too.\nWhat we have created here is at least a method for the assignment of these tags, what you can do is take this and apply it to your own requirements, hopefully making the management of devices a little more straight forward.\n","date":"10 January 2024","externalUrl":null,"permalink":"/posts/device-attributes-cap/","section":"Posts","summary":"So you like Intune Device Compliance and the integration with Conditional Access, what about if you\u0026rsquo;ve got VDI or Remote Desktop infrastructure that you want to exclude from specific policies, how do you go about that in a safe and controlled way.","title":"Using Entra ID Device Attributes for Conditional Access Exceptions","type":"posts"},{"content":"If you\u0026rsquo;ve ever experienced the joys of migrating Group Policy and in particular Windows Defender Firewall rules away from Group Policy to Microsoft Intune, you\u0026rsquo;ve probably encountered the Rule Migration Tool, and for now this tool has worked well, beavering away grabbing firewall rules from a source Windows 10 or later device and punting them straight in Microsoft Intune. So what\u0026rsquo;s the catch?\nWell with the move to Settings Catalog based policies all over the shop in Microsoft Intune, and the advent of Reusable Settings for Defender Firewall Rules, these \u0026ldquo;legacy\u0026rdquo; Endpoint Security Defender Firewall Rule profiles don\u0026rsquo;t support the new world, so how do we fix that?\nIt\u0026rsquo;s obviously PowerShell and Graph, you should know this by now.\nThe functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. Getting Firewall Rule Profiles # I haven\u0026rsquo;t had time to update my fork of the Rule Migration Tool to support Settings Catalog policies just yet, so instead of focusing on capturing new rules, let\u0026rsquo;s look at how we get the rules from existing Endpoint Security profiles. I\u0026rsquo;ve worked long enough on bodging together my own PowerShell functions that I can pull back existing profiles and the data, so let\u0026rsquo;s do that first to see what we\u0026rsquo;re working with, as we\u0026rsquo;ll need to translate these existing rules into the new format.\nOnce we\u0026rsquo;ve authenticated to Graph using Connect-MgGraph and using the functions below to get the Endpoint Security profiles, Endpoint Security Templates and Endpoint Security Categories and finally each setting within the profile we can put all the existing rules into a variable that we can work with.\nEndpoint Security Profile # This function will get all Endpoint Security profiles, or a specific profile by either Id or Name. We\u0026rsquo;ll need this to get the profiles that contains all the firewall rules we want to migrate.\nFunction Get-DeviceEndpointSecProfile() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceManagement/intents\u0026#39; try { if ($Id) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($name) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.displayName).contains(\u0026#34;$name\u0026#34;) } } Else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Method Get -Uri $uri).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Endpoint Security Templates # As Endpoint Security profiles are a little more complicated that other profiles in Microsoft Intune, and rely on underpinning templates, we also have to get the template being used by the profile itself. We can pass the templateId captured from an Endpoint Security Profile using the above function into the Id parameter in the below function.\nFunction Get-DeviceEndpointSecTemplate() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/templates?`$filter=(isof(%27microsoft.graph.securityBaselineTemplate%27))\u0026#34; try { if ($Id) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($name) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.displayName).contains(\u0026#34;$name\u0026#34;) } } Else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Method Get -Uri $uri).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Endpoint Security Template Categories # Lastly, we now need to be able to get all the Endpoint Security categories that are assigned to the template allowing us to extract the actual content of the profile, and using the function above, we can get all the categories for the template by taking the id of the Endpoint Security Template, looping through each category in the template, and finally being able to extract the data we need.\nAll of this makes me glad that Settings Catalog profiles are being used more and more in Microsoft Intune.\nFunction Get-DeviceEndpointSecCategorySetting() { \u0026lt;# .SYNOPSIS This function is used to get an Endpoint Security category setting from a specific policy using the Graph API REST interface .DESCRIPTION The function connects to the Graph API Interface and gets a policy category setting .EXAMPLE Get-EndpointSecurityCategorySetting -PolicyId $policyId -categoryId $categoryId Gets an Endpoint Security Categories from a specific template in Endpoint Manager .NOTES NAME: Get-EndpointSecurityCategory #\u0026gt; [cmdletbinding()] param ( [Parameter(Mandatory = $true)] $Id, [Parameter(Mandatory = $true)] $categoryId ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/intents/$Id/categories/$categoryId/settings?`$expand=Microsoft.Graph.DeviceManagementComplexSettingInstance/Value\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Method Get -Uri $uri).value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Capturing Firewall Rules # Using existing legacy Endpoint Security Firewall Rule profiles in a tenant, we just need to know their names so we can pass them into an array variable, so we can use the below profile names as examples.\nLegacy Firewall Rule policies in Microsoft Intune. Adding them into an array so we can loop through each one of them, and extract the needed data.\n$FirewallPolicies = @(\u0026#39;LegacyRules-0\u0026#39;, \u0026#39;LegacyRules-1\u0026#39;,\u0026#39;LegacyRules-2\u0026#39;, \u0026#39;LegacyRules-3\u0026#39;) Using the Endpoint Security functions we can now process each of the profiles and rip out all the rules into a useable format using a new array variable $FWRules.\n$FWRules = @() foreach ($FirewallPolicy in $FirewallPolicies) { $EndpointSecProfile = Get-DeviceEndpointSecProfile -Name $FirewallPolicy $EndpointSecTemplates = Get-DeviceEndpointSecTemplate $EndpointSecTemplate = $EndpointSecTemplates | Where-Object { $_.id -eq $EndpointSecProfile.templateId } $EndpointSecCategories = Get-DeviceEndpointSecTemplateCategory -Id $EndpointSecTemplate.id foreach ($EndpointSecCategory in $EndpointSecCategories) { $EndpointSecSettings = Get-DeviceEndpointSecCategorySetting -Id $EndpointSecProfile.id -categoryId $EndpointSecCategories.id $FWRules += $EndpointSecSettings.valueJson | ConvertFrom-Json } } With these we now have the $FWRules array of Firewall Rules captured from the existing profiles similar to the below.\ndisplayName : NVIDIA SHIELD Streaming SSAS UDP Exception description : UDP exceptions for NVIDIA SHIELD Streaming SSAS (mDNS) trafficDirection : in action : allowed profileTypes : {notConfigured} packageFamilyName : filePath : C:\\Program Files\\NVIDIA Corporation\\NvContainer\\nvcontainer.exe serviceName : protocol : 17 localPortRanges : {5353} remotePortRanges : {} interfaceTypes : {notConfigured} localUserAuthorizations : useAnyLocalAddressRange : True actualLocalAddressRanges : {} useAnyRemoteAddressRange : True actualRemoteAddressRanges : {} displayName : BlueStacks Service Hyper-V description : trafficDirection : in action : allowed profileTypes : {notConfigured} packageFamilyName : filePath : serviceName : protocol : 6 localPortRanges : {2860-2892} remotePortRanges : {} interfaceTypes : {notConfigured} localUserAuthorizations : useAnyLocalAddressRange : True actualLocalAddressRanges : {} useAnyRemoteAddressRange : False actualRemoteAddressRanges : {172.31.224.0/255.255.240.0} We now have the data we need to start building firewall rules in the new Setting Catalog format. Surely it get\u0026rsquo;s easier, (hint: it doesn\u0026rsquo;t).\nCreating Firewall Rules # We now have the information from the existing legacy profiles allowing us to create rules in the Settings Catalog policy format, so we should process each of the rules we\u0026rsquo;ve captured and pass the data into reusable variables in preparation for building the JSON structure.\nFirewall Rule Grouping # One thing I didn\u0026rsquo;t expect is that Settings Catalog policies, for Firewall rules at least, have a maximum number of rules, 100 in fact. Compared with the legacy profiles maximum of 150, we\u0026rsquo;re going to have to split out the rules in $FWRules into 100 rule groups to allow us to add them to a single policy.\n$counter = [pscustomobject] @{ Value = 0 } $groupSize = 100 $FWRuleGroups = $FWRules | Group-Object -Property { [math]::Floor($counter.Value++ / $groupSize) } With the above, we can ensure that we are breaking the rules into 100 rule sections that we can then reference using the $FWRuleGroups variable when building the new policies.\nCount Name Group ----- ---- ----- 100 0 {@{displayName=Wi-Fi Direct Spooler Use (Out); description=Outbound rule to use WSD printers on Wi-Fi Direct networks.; trafficDirection=out; 100 1 {@{displayName=Network Discovery (SSDP-In); description=Inbound rule for Network Discovery to allow use of the Simple Service Discovery Protocol. [UDP 100 2 {@{displayName=teams.exe; description=; trafficDirection=in; action=allowed; profileTypes=System.Object[]; packageFamilyName=; 100 3 {@{displayName=Microsoft Sync Center; description=Microsoft Sync Center; trafficDirection=in; action=allowed; profileTypes=System.Object[]; 63 4 {@{displayName=Microsoft Office Outlook; description=; trafficDirection=in; action=allowed; profileTypes=System.Object[]; packageFamilyName=; These groups can now be used to create separate Settings Catalog policies.\nDuplicate Rule Names # So for each of these rule groups in the $FWRuleGroups variable, we need to take each rule and extract the data, adding it to a variable that we can reference later, as well as one important different between the legacy and the new profiles\u0026hellip;we can\u0026rsquo;t have duplicate rule names. Yeah this one bit me in the arse pretty hard during testing, and I can tell you now I have thrown in a very quick fix for this using a counter in the form of the $RuleNameCount variable.\nforeach ($FWRuleGroup in $FWRuleGroups) { $Rules = $FWRuleGroup.Group $RuleNameCount = 0 foreach ($Rule in $Rules) { # Capturing existing rules with duplicate names, as Settings Catalog will not allow duplicates $DuplicateNames = $Rules.displayName | Group-Object | Where-Object { $_.count -gt 1 } $Name = $Rule.displayName if ($DuplicateNames.name -contains $Name) { $Name = $Name + \u0026#39;-\u0026#39; + $RuleNameCount++ } } } This isn\u0026rsquo;t the cleanest, but at least it gets us over the line with making sure every rule has a unique name. As you can see from the below, in just one of the groups we have a number of duplicates.\nCount Name Group ----- ---- ----- 2 App Installer {App Installer, App Installer} 7 Captive Portal Flow {Captive Portal Flow, Captive Portal Flow, Captive Portal Flow, Captive Portal Flow‚Ä¶} 2 Company Portal {Company Portal, Company Portal} 2 Dell SupportAssist for H‚Ä¶ {Dell SupportAssist for Home PCs, Dell SupportAssist for Home PCs} 2 Microsoft Edge {Microsoft Edge, Microsoft Edge} 3 Microsoft Edge (mDNS-In) {Microsoft Edge (mDNS-In), Microsoft Edge (mDNS-In), Microsoft Edge (mDNS-In)} 2 Microsoft Sticky Notes {Microsoft Sticky Notes, Microsoft Sticky Notes} 2 Microsoft Store {Microsoft Store, Microsoft Store} 2 Microsoft To Do {Microsoft To Do, Microsoft To Do} 4 VMware Remote MKS {VMware Remote MKS, VMware Remote MKS, VMware Remote MKS, VMware Remote MKS} 23 Windows Feature Experien‚Ä¶ {Windows Feature Experience Pack, Windows Feature Experience Pack, Windows Feature Experience Pack, Windows Feature Experience Pack‚Ä¶} Rule Processing # On to how we capture the rest of the rule settings, and you may have noticed that not every rule will have every setting, for good reason, but we need to ensure that for each rule processed we\u0026rsquo;re not taking through data from the previous rule, so we can update the code snippet above to capture the data into variables, but clear them out before we do so.\nforeach ($FWRuleGroup in $FWRuleGroups) { $Rules = $FWRuleGroup.Group $RuleNameCount = 0 foreach ($Rule in $Rules) { Clear-Variable -Name (\u0026#39;Name\u0026#39;, \u0026#39;Description\u0026#39;, \u0026#39;Direction\u0026#39;, \u0026#39;Action\u0026#39;, \u0026#39;FWProfiles\u0026#39;, \u0026#39;PackageFamilyName\u0026#39;, \u0026#39;FilePath\u0026#39;, \u0026#39;Service\u0026#39;, \u0026#39;Protocol\u0026#39;, \u0026#39;LocalPorts\u0026#39;, \u0026#39;RemotePorts\u0026#39;, \u0026#39;Interfaces\u0026#39;, \u0026#39;UseAnyLocalAddresses\u0026#39;, \u0026#39;LocalAddresses\u0026#39;, \u0026#39;UseAnyRemoteAddresses\u0026#39;, \u0026#39;RemoteAddresses\u0026#39;) -ErrorAction Ignore # Capturing existing rules with duplicate names, as Settings Catalog will not allow duplicates $DuplicateNames = $Rules.displayName | Group-Object | Where-Object { $_.count -gt 1 } $Name = $Rule.displayName if ($DuplicateNames.name -contains $Name) { $Name = $Name + \u0026#39;-\u0026#39; + $RuleNameCount++ } $Description = $Rule.description $Direction = $Rule.trafficDirection $Action = $Rule.action $FWProfiles = $Rule.profileTypes $PackageFamilyName = $Rule.packageFamilyName $FilePath = ($Rule.filePath).Replace(\u0026#39;\\\u0026#39;, \u0026#39;\\\\\u0026#39;) $Service = $Rule.serviceName $Protocol = $Rule.protocol $LocalPorts = $Rule.localPortRanges $RemotePorts = $Rule.remotePortRanges $Interfaces = $Rule.interfaceTypes $AuthUsers = $Rule.localUserAuthorizations $UseAnyLocalAddresses = $Rule.useAnyLocalAddressRange $LocalAddresses = $Rule.actualLocalAddressRanges $UseAnyRemoteAddresses = $Rule.useAnyRemoteAddressRange $RemoteAddresses = $Rule.actualRemoteAddressRanges } } We now have the information from the existing rules to create new ones. Now to the fun part of JSON formatting.\nCreating Settings Catalog Policies # Luckily we have experience creating Settings Catalog policies, and have a good grasp of the JSON formatting required not just for the policy itself, but also for the settings contained within, with the first setting having differing JSON formatting structure and data compared with all subsequent settings. So I had at least an idea on how to build the JSON data to throw it at Microsoft Intune.\nBuilding the Policy # With the rules in neat little groups, and with all the variables in place, we can loop through each of them to create individual Settings Catalog policies, we need to make sure that each policy has a unique name, so we can just take an existing $PolicyName variable and append the group name to it, as these are sequential numbers, giving us something like COPE_FW_RulesMigrated-0, COPE_FW_RulesMigrated-1, COPE_FW_RulesMigrated-2, COPE_FW_RulesMigrated-3, COPE_FW_RulesMigrated-4 for the five groups we have in our example.\nEach Settings Catalog Policy starts and ends with the same JSON data structure, so we can top and tail each policy with these new variables $JSONPolicyStart and $JSONPolicyEnd, passing in the $NewPolicyName and $PolicyDescription.\nforeach ($FWRuleGroup in $FWRuleGroups) { $NewPolicyName = $PolicyName + \u0026#39;-\u0026#39; + $FWRuleGroup.Name $PolicyDescription = \u0026#39;Migrated Firewall Rules Policy\u0026#39; $JSONPolicyStart = @\u0026#34; { \u0026#34;description\u0026#34;: \u0026#34;$PolicyDescription\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;$NewPolicyName\u0026#34;, \u0026#34;platforms\u0026#34;: \u0026#34;windows10\u0026#34;, \u0026#34;technologies@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationTechnologies\u0026#34;, \u0026#34;technologies\u0026#34;: \u0026#34;mdm,microsoftSense\u0026#34;, \u0026#34;templateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationPolicyTemplateReference\u0026#34;, \u0026#34;templateId\u0026#34;: \u0026#34;19c8aa67-f286-4861-9aa0-f23541d31680_1\u0026#34;, \u0026#34;templateFamily@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationTemplateFamily\u0026#34;, \u0026#34;templateFamily\u0026#34;: \u0026#34;endpointSecurityFirewall\u0026#34;, \u0026#34;templateDisplayName\u0026#34;: \u0026#34;Microsoft Defender Firewall Rules\u0026#34;, \u0026#34;templateDisplayVersion\u0026#34;: \u0026#34;Version 1\u0026#34; }, \u0026#34;settings\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSetting\u0026#34;, \u0026#34;settingInstance\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\u0026#34;, \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;76c7a8be-67d2-44bf-81a5-38c94926b1a1\u0026#34; }, \u0026#34;groupSettingCollectionValue@odata.type\u0026#34;: \u0026#34;#Collection(microsoft.graph.deviceManagementConfigurationGroupSettingValue)\u0026#34;, \u0026#34;groupSettingCollectionValue\u0026#34;: [ \u0026#34;@ $JSONPolicyEnd = @\u0026#39; ] } } ] } \u0026#39;@ } This was the easy part of the process, we now need to focus on the rules themselves.\nBuilding the Rules # As I\u0026rsquo;ve mentioned before, the initial rule in each policy has different JSON structure and data than the rest, so we can reuse our previous way of dealing this checking whether the rule is the first in the array.\nif ($Rule -eq $Rules[0]) { ... } else { ... } On top of this we need to build in logic to only add in JSON data when the rule requires it. Now there are a lot of potentials with each rule, but there are some consistencies across them all which we can look at now, the rest, well you can have a gander at the full script.\nThe start of each rule is the same, which is kind of Microsoft.\n$JSONRuleStart = @\u0026#39; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;children@odata.type\u0026#34;: \u0026#34;#Collection(microsoft.graph.deviceManagementConfigurationSettingInstance)\u0026#34;, \u0026#34;children\u0026#34;: [ \u0026#39;@ But that\u0026rsquo;s it for niceties, each of the options for every rule has different formatting, let\u0026rsquo;s look at comparing just the JSON data for the name of the rule.\nJSON Differences # The first rule in the policy has additional content, mainly in the settingValueTemplateId sections across each object.\n$JSONRuleName = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\u0026#34;, \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;116a696a-3270-493e-9938-c336cf05ea98\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$Name\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSettingValueTemplateReference\u0026#34;, \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;12994a33-6185-4c3d-a0e8-69316f6293ea\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, \u0026#34;@ Compared with each subsequent Rule name, where the JSON doesn\u0026rsquo;t need the settingValueTemplateId and other sections.\n$JSONRuleName = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$Name\u0026#34; } }, \u0026#34;@ You get the idea, now imagine spending half a day reviewing and comparing JSON for each of the potential options in the rule, I can\u0026rsquo;t say it was an enjoyable time, but here we are.\nBringing the above together, we\u0026rsquo;ll get something like the below.\nif ($Rule -eq $Rules[0]) { $JSONRuleName = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSettingInstanceTemplateReference\u0026#34;, \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;116a696a-3270-493e-9938-c336cf05ea98\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$Name\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSettingValueTemplateReference\u0026#34;, \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;12994a33-6185-4c3d-a0e8-69316f6293ea\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, \u0026#34;@ } else { $JSONRuleName = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;vendor_msft_firewall_mdmstore_firewallrules_{firewallrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$Name\u0026#34; } }, \u0026#34;@ } Completing the Policy # With the JSON data for all our rule(s) now in place, or at least hopefully, we need to combine all the $JSONRule* variables per rule into a new variable $JSONRule, and the add that rule to a new array variable $JSONAllRules that can be used to build the full Settings Catalog policy.\n$JSONAllRules = @() ... $JSONRule = $JSONRuleStart + $JSONRuleName + $JSONRuleState + $JSONRuleDirection + $JSONRuleProtocol + $JSONRuleLocalAddressRange + $JSONRuleInterface + $JSONRulePackageFamily + $JSONRuleFilePath + $JSONRuleAuthUsers + $JSONRuleRemotePorts + $JSONRuleFWProfile + $JSONRuleService + $JSONRuleLocalPorts + $JSONRuleRemoteAddressRange + $JSONRuleAction + $JSONRuleDescription + $JSONRuleEnd $JSONAllRules += $JSONRule Now we have the start of the policy, the end of the policy, and the middle bit containing all the rules, we can combine them into one mega-JSON variable.\n$JSONPolicy = $JSONPolicyStart + $JSONAllRules + $JSONPolicyEnd And using the function below, we can send this to Graph and create ourselves a new Settings Catalog policy.\nFunction New-DeviceSettingsCatalog() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceManagement/configurationPolicies\u0026#39; try { Test-Json -Json $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } Which looks something like this.\nNew-DeviceSettingsCatalog -JSON $JSONPolicy With, if all went well, the response below.\n@odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : b9ae4e1f-7f78-4506-8520-aa7919f06a73 name : COPE_FW_RulesMigrated-4 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:33:27 lastModifiedDateTime : 14/09/2023 09:33:27 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} This looks pretty good if I do say so myself.\nRunning the Script # The full script which let\u0026rsquo;s be honest, is what you\u0026rsquo;re after, can be run using the below command, passing in the required variables for tenantId, policyName, and oldFirewallPolicies\n./Invoke-MgConvertFirewallRules.ps1 -tenantId \u0026#34;yourtenantId\u0026#34; -policyName \u0026#34;COPE_FW_RulesMigrated\u0026#34; -oldFirewallPolicies \u0026#34;LegacyRules-0\u0026#34;, \u0026#34;LegacyRules-1\u0026#34;, \u0026#34;LegacyRules-2\u0026#34;, \u0026#34;LegacyRules-3\u0026#34; After authenticated to Graph, this will give us the below output having successfully created the new Settings Catalog policies.\nFound Legacy Firewall Rule Profile LegacyRules-0 Found Legacy Firewall Rule Profile LegacyRules-1 Found Legacy Firewall Rule Profile LegacyRules-2 Found Legacy Firewall Rule Profile LegacyRules-3 Captured 463 rules from the provided legacy Endpoint Security Firewall Rules profiles. Creating new Settings Catalog Policy COPE_FW_RulesMigrated-0 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 14c02164-36ce-446f-9101-90c833ee441e name : COPE_FW_RulesMigrated-0 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:30 lastModifiedDateTime : 14/09/2023 09:40:30 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-0 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-1 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 213957bd-2bc1-4103-af59-25e406894213 name : COPE_FW_RulesMigrated-1 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:31 lastModifiedDateTime : 14/09/2023 09:40:31 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-1 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-2 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 8eade932-9563-4cc5-b24e-9b478f98cebe name : COPE_FW_RulesMigrated-2 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:33 lastModifiedDateTime : 14/09/2023 09:40:33 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-2 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-3 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : 9723ffd1-198e-4b96-8572-668e16c8dbda name : COPE_FW_RulesMigrated-3 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:34 lastModifiedDateTime : 14/09/2023 09:40:34 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-3 Creating new Settings Catalog Policy COPE_FW_RulesMigrated-4 @odata.context : https://graph.microsoft.com/beta/$metadata#deviceManagement/configurationPolicies/$entity id : a82b554f-34a9-4f1c-bc46-05e1d399e255 name : COPE_FW_RulesMigrated-4 description : Migrated Firewall Rules Policy platforms : windows10 technologies : mdm,microsoftSense createdDateTime : 14/09/2023 09:40:35 lastModifiedDateTime : 14/09/2023 09:40:35 settingCount : 1 creationSource : roleScopeTagIds : {0} priorityMetaData : templateReference : @{templateId=19c8aa67-f286-4861-9aa0-f23541d31680_1; templateFamily=endpointSecurityFirewall; templateDisplayName=Microsoft Defender Firewall Rules; templateDisplayVersion=Version 1} Successfully created new Settings Catalog Policy COPE_FW_RulesMigrated-4 I\u0026rsquo;d call that a win in my books.\nComparing Profiles to Policies # Checking in Microsoft Intune we should have five new policies that contain the same rules as the legacy profiles. With the new rules having the supplied name prefix, and using the updated policies.\nThe clue is the \u0026lsquo;Target\u0026rsquo; being mdm,microsoftSense not just mdm New Firewall Rule policies in Microsoft Intune. Let\u0026rsquo;s have a gander at comparing the rules between the profiles, with the old profile looking like the below with the rule detail.\nLegacy Firewall Rule policy settings in Microsoft Intune. And the new policy looking pretty damn good.\nNew Firewall Rule policy settings in Microsoft Intune. I think we\u0026rsquo;re done.\nSummary # This, and the script, as usual all came about from improving a Customers Microsoft Intune environment. The customer being very security focussed was blocking legitimately everything inbound and outbound unless there was a firewall rule; this included all Microsoft 365 endpoints.\nWith their existing rules in legacy profiles, they had to have rules with all the IP addresses for these Microsoft endpoints, and keep these up-to-date across multiple profiles.\nThis obviously wasn\u0026rsquo;t ideal, and with the advent of the reusable settings and the auto discovery of addresses and domains for firewall rules in Settings Catalog policies, allowed for more confidence in the rules, a reduced maintenance overhead, and you know, new stuff is cool.\nThere is still a scenario I need to look at, and I mentioned that at the start, looking at the original Microsoft Rule Migration Tool and getting that to create Settings Catalog policies instead of the legacy format, but that is one for a very very rainy day.\n","date":"12 September 2023","externalUrl":null,"permalink":"/posts/settings-catalog-firewall-rules/","section":"Posts","summary":"If you\u0026rsquo;ve ever experienced the joys of migrating Group Policy and in particular Windows Defender Firewall rules away from Group Policy to Microsoft Intune, you\u0026rsquo;ve probably encountered the Rule Migration Tool, and for now this tool has worked well. So what\u0026rsquo;s the catch?","title":"Modernising Microsoft Intune Firewall Rule Policies","type":"posts"},{"content":"You might have been asked the question, especially from organisations that currently utilise Microsoft Configuration Manager, about how you mimic existing Device Collections used for Software Update deployments in Microsoft Intune.\nWith Configuration Manager having the backing of Microsoft SQL, and a hardware inventory that collects every granular detail about Windows devices, splitting out your device estate into logical phases is very easy to achieve.\nBut what about Microsoft Intune, how do we phase these updates in a similar way to Configuration Manager?\nWindows Update for Business Rings # The first thing we need to understand is how many WUfB (Windows Update for Business) rings we should create, usually based on the size of your Windows device estate, for now we\u0026rsquo;ll stick with four update rings:\nTesting Ring: This should be devices that are dedicated for testing, not IT machines. Roughly 5% of your device estate. Pilot Ring: This should be a stratified sample of either users or devices, not friends and family (HR and Finance). Roughly 15% of your device estate. Initial Production Ring: This should be roughly half of the remaining devices, roughly 30% of your device estate. Final Production Ring: This should cover all remaining devices, so 50% of the device estate. These rings can be created in Microsoft Intune with differing deferral periods, installation deadlines, and if you like, grace periods.\nInstallation Settings # Taking the Update Rings above, we should ensure that the end result of deferral, deadlines, and grace periods is that that there is no crossover between the timings. What I mean is that you don\u0026rsquo;t want to discover an issue with devices in the Pilot Ring after the Initial Production Ring has already started deploying updates, this sounds like a nightmare.\nSo we can use settings similar to those in the below table to ensure that one phase doesn\u0026rsquo;t start until the previous has completed.\nUpdate Ring Deferral Deadline Grace Period Updates Installed Testing Ring 0 days 1 day 0 days 1 day Pilot Ring 2 days 1 day 1 day 4 days Initial Production Ring 6 days 2 days 1 day 9 days Final Production Ring 10 days 2 days 1 day 13 days You may have noticed that we\u0026rsquo;re working within a 14-day window here, because we all love NCSC Guidelines. So with the Update Rings configured, we now need to look at how these are assigned to Users and Devices.\nUsers versus Devices Assignment # Now assignment of Update Rings is no different to any other assignment in Microsoft Intune, and by that I mean that you cannot mix assignment target identities within Include and Exclude targets. We do also need to consider not just the individual Update Ring assignment, but how they all interact together. What we don\u0026rsquo;t want is a device meant to be in the Final Production ring, getting a 0-day deferral because the user is in the Testing Ring.\nSo we should stick with assigning these rings to a single identity, but which one?\nI mean, the answer is Devices, but I\u0026rsquo;ll explain why.\nIf you\u0026rsquo;re using Users, which seems like the easier approach as finding and managing pilot users is pretty straight forward, it means that the Update Ring will follow them regardless of which device they login to. This is not the functionality we want, updates are delivered to devices, not users, so let\u0026rsquo;s see how we can group devices together in a sensible way.\nUpdate Ring Groups # So now we need to find a way group devices in a sensible way, so let\u0026rsquo;s create three (yes three) new Azure AD Microsoft Entra ID Security Groups for each of the Update Rings.\nWindows Updates Testing Windows Updates Pilot Windows Updates Initial Production With both the Testing and Pilot ring being specifically designated devices, we can use Assigned Groups and add Windows devices to each of those groups, what are we doing with the \u0026lsquo;Windows Updates Initial Production\u0026rsquo; group though?\nDynamic Groups # Now I know I love Device Filters, and do not fear, we\u0026rsquo;ll need one of these later, but as covered previously Dynamic Groups are more powerful, and for this use case will perfectly fit our need to split our Windows device estate in half-ish.\nDevice Name is how we\u0026rsquo;re going to split our device estate, whether these are you old-school naming conventions on-premises based on asset tag, serial number or otherwise, Autopilot Azure AD Join MEID Join (really?) devices with a prefix and a serial, or god forbid Autopilot Hybrid Joined devices with a prefix and random numbers.\nEither way, we should be able use Dynamic Device Groups to capture half of the device estate.\nStart of Device Name Matching # Before we look at how we capture the devices let\u0026rsquo;s look at some device name examples starting with a list of devices with a mixture of device names.\nENB-BDZX4M3 ENB-3231EQSM PGT-45E8LN1S VIP-ec9d473986d9 ITS-CRJ7C39 CON-f6f64b04a9e7 As we have some kind of naming convention here with a three letter prefix follow by a hyphen and then some random characters, we should be able to capture half of the devices by pulling back only devices that after the hyphen start with odd numbers (1, 3, 5, 7, 9), or alternate letters (a, c, e, etc.).\nThrowing open you\u0026rsquo;re favourite RegEx tester we can plonk in the device names and start playing with queries, and if we want to be exact so we only capture devices that match our three character prefix followed by a hyphen and an odd number, we can use an expression like this.\n^[a-zA-Z]{3}-d*[13579] For capturing devices that match the three character prefix followed by a hyphen and alternative lowercase characters, we can use the expression below.\n^[a-zA-Z]{3}-d*[acegikmoqsuwy] For capturing devices that match the three character prefix followed by a hyphen and alternative uppercase characters, we can use the expression below.\n^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY] To give you an insight into the expression:\n^: Start of the string [a-zA-Z]{3}-: First three characters are either uppercase or lowercase letters followed by a hyphen d*[13579]: One odd number d*[acegikmoqsuwy]: One alternative lowercase letter from the supplied range d*[ACEGIKMOQSUWY]: One alternative uppercase letter from the supplied range This should cover our requirements, we just need to create the Dynamic Group query.\nEnd of Device Name Matching # What happens if you\u0026rsquo;re still using asset tag naming conventions, most of these devices will all start with the same letter or number, so we need a way to split these in a different way.\nLooking at the sample device list below, we can create a new expression that looks at the last number of the device name, but taking into consideration the prefix, hyphen, and only the following six digits.\nLTP-002003 LTP-002042 DTP-001191 DTP-000117 LTP-000008 Once again into RegEx testing we can plonk in the device names and start playing with queries, this time we just want to match devices with any three character prefix followed by a hyphen, but end in an odd number.\n^[a-zA-Z]{3}-\\d{5}[13579]$ An overview of the expression:\n^: Start of the string [a-zA-Z]{3}-: First three characters are either uppercase or lowercase letters followed by a hyphen \\d{5}: Matches five digits after the hyphen [13579]$: The sixth digit is odd This should work for the sample asset tag named devices.\nDynamic Group Query # As well as the using one of the above name matching expressions, we could do with capturing whether the device is actually a Windows Corporate-Owned device.\nSo let\u0026rsquo;s build our Dynamic Group Query based on the below requirements.\n(device.deviceOSType -eq \u0026quot;Windows\u0026quot;): Any Windows Device (device.deviceOSVersion -startsWith \u0026quot;10\u0026quot;): Any device with an Operating System that starts with 10 (device.deviceOwnership -eq \u0026quot;Company\u0026quot;): Any device that is corporate owned ((device.displayName -match \u0026quot;^[a-zA-Z]{3}-d*[13579]\u0026quot;): Device name matches our naming convention followed by an odd number (device.displayName -match \u0026quot;^[a-zA-Z]{3}-d*[acegikmoqsuwy]\u0026quot;): Device name matches our naming convention followed by a lowercase letter in the set (device.displayName -match \u0026quot;^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY]\u0026quot;)): Device name matches our naming convention followed by a uppercase letter in the set We need to throw in some and and or into the mix to ensure we\u0026rsquo;re only grabbing the correct devices, but the full query can be found below.\n(device.deviceOSType -eq \u0026#34;Windows\u0026#34;) and (device.deviceOSVersion -startsWith \u0026#34;10\u0026#34;) and (device.deviceOwnership -eq \u0026#34;Company\u0026#34;) and ((device.displayName -match \u0026#34;^[a-zA-Z]{3}-d*[13579]\u0026#34;) or (device.displayName -match \u0026#34;^[a-zA-Z]{3}-d*[acegikmoqsuwy]\u0026#34;) or (device.displayName -match \u0026#34;^[a-zA-Z]{3}-d*[ACEGIKMOQSUWY]\u0026#34;)) Using our sample of devices names, the above query would capture the highlighted names below.\nENB-BDZX4M3 ENB-3231EQSM PGT-45E8LN1S VIP-ec9d473986d9 ITS-CRJ7C39 CON-f6f64b04a9e7 Expanding this over an entire device estate should give us roughly half of all Windows 10 and later corporate owned devices.\nUpdate Ring Assignment # So have pretty much all we need to actually start assigning our Update Rings to device groups, but hang fire, we\u0026rsquo;ve only created three groups and have four Update Rings, what gives?\nWell for the final ring, we need to cover all remaining Windows corporate owned devices, so we can use the built-in \u0026lsquo;All Devices\u0026rsquo; group and a Device Filter that only pulls back corporate owned devices, so something like (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;).\nNow we can start assigning, but we need to make sure that there is no conflict with the profiles, so we\u0026rsquo;ll make use of both Include and Exclude assignment targets, detailed in the table below.\nUpdate Ring Include Group Filter Mode Exclude Groups Testing Ring Windows Updates Testing n/a n/a n/a Pilot Ring Windows Updates Pilot n/a n/a Windows Updates Testing Initial Production Ring Windows Updates Initial Production n/a n/a Windows Updates Testing, Windows Updates Pilot Final Production Ring All Devices Corporate Windows Include Windows Updates Testing, Windows Updates Pilot, Windows Updates Initial Production Once you\u0026rsquo;ve assigned the Update Rings and confirmed that devices are receiving the correct one, you\u0026rsquo;re good to go. Simple really.\nSummary # There you have it, a phased and self maintaining deployment of Windows Updates across your device estate, allowing you to truly control when devices are getting updates and an ability to pause update rings in the event of an issue without taking out all of your device estate at once.\nObviously you can tailor the number of Update Rings and logic behind splitting devices across them, but it was hard enough for me to work out the RegEx for these two examples to be honest with you.\nI\u0026rsquo;d suggest you start with understanding what devices you need to target, their naming conventions if any, and then play around with RegEx to ensure that you are capturing the correct devices, no one wants unexpected Windows Updates.\nOnce happy with your expressions, you can then create the Dynamic Group and review the membership before going all gung ho and straight up assigning the Update Ring profile to the group, you know, just in case.\n","date":"17 July 2023","externalUrl":null,"permalink":"/posts/windows-update-phased-deployment/","section":"Posts","summary":"You might have been asked the question, especially from organisations that currently utilise Microsoft Configuration Manager, about how you mimic existing Device Collections used for Software Update deployments in Microsoft Intune..","title":"Intelligent Phased Windows Update for Business Deployments","type":"posts"},{"content":"We looked at some of the ways to secure macOS devices in Microsoft Intune, aligned with the NCSC platform guidance in macOS National Cyber Security Centre Security Settings in Intune, but this was when macOS device management in Intune was, at best, in beta.\nGeneral hardening has been covered previously by Hubert Maslowski in their post that covers device compliance and configuration settings, but we\u0026rsquo;re looking at ensuring that the macOS devices meet the National Cyber Security Centre settings, including Cyber Essentials requirements.\nNow with the additional macOS settings, and new macOS versions, I thought we should look at how we can now secure these enrolled devices aligned to these known good practice settings.\nNCSC Guidelines # Handily, NCSC provide a list of their recommendations for macOS device security, and unlike our previous attempt at hardening, we don\u0026rsquo;t need to rely on mobileconfig custom settings to deliver these hardening requirements.\nThe settings from the platform guidance we\u0026rsquo;ll cover in this post are as detailed in the sections below. We\u0026rsquo;re not going to cover all the restrictions, the implications, and the expected behaviour, as the company I work for charges customers for this and I already provide too much \u0026lsquo;value add\u0026rsquo; as part of consultancy as it is.\nDevice Password Settings # Password complexity in the NCSC guidance is a little open ended, however when you dig through their other guidance, we can see that the new requirements for passwords on macOS devices have the restrictions of the below:\n12 Characters or more Allow the use of lower case, upper case, numbers Block the use of special characters Block the use of simple passwords that have repeating, ascending, or descending characters Password does not expire Remember previous 24 passwords Minimum activity before a password is required set to five minutes The NCSC guidance does cover screen saver settings, and password sharing settings, so we can include those as well when configuring password settings.\nRequire password after sleep or screen saver begins within five seconds Disable password sharing Disable proximity based password sharing requests With the above, we can easily create a device compliance policy\u0026hellip;\nMicrosoft Intune macOS compliance policy for passwords. When a compliance policy contains password restrictions, this will force the end user to change their password at next logon, and result in any attempt at elevation to fail with existing credentials until the password has been updated. \u0026hellip;and a device restrictions profile to meet these requirements.\nMicrosoft Intune macOS configuration profile for passwords. As there isn\u0026rsquo;t a five second option for when a password is required, with the minimum being one minute, we\u0026rsquo;ve set this to be immediately. Login Restrictions # There are a number of recommendations when it comes to the login window, with most of these impacting the end-user experience, but obviously for good security based reasons. We can group the restrictions into one Settings Catalog profile and one Device Restriction profile, who knows why Microsoft didn\u0026rsquo;t just make them all available within Settings Catalogs.\nUsing a Settings Catalog profile we can cover the following restrictions.\nDisable Guest User Disable console logon Log out users after three minutes of inactivity* Block user setting a lock message *We can\u0026rsquo;t do three minutes so five will have to do, Microsoft Intune supports between five minutes and 24 hours. Microsoft Intune macOS configuration profile for login settings. For the Device Restriction Profile we can cover the restriction below.\nShow only Name and Password Text fields Microsoft Intune macOS configuration profile for login settings. Software Updates # Ah yes, software updates, basically we need to ensure that updates are installed within a 14-day window from the release of the update, that the updates can be installed by the end user, and that only production updates can be installed.\nAutomatically install macOS updates Allow non-admin users to install software updates Do not defer macOS Updates Allow installation of macOS beta releases With these requirements we can create the Settings Catalog profile below to adhere to the restrictions.\nMicrosoft Intune macOS configuration profile for software update settings. The Microsoft documentation talks about these settings in the Additional settings section, there appears to be a caveat to that whole document that these update settings will only apply to Supervised macOS devices. Restrict Items in System Preferences # Limiting access to areas in the System areas used to be accomplished by a custom profile, but now we can use a Settings Catalog profile, oh how Intune has changed. The excerpt from the NCSC guide is as follows.\nDisable iCloud Profiles Disable Security \u0026amp; Privacy Disable Startup Disk Disable Sharing (enables remote management) Disable Siri Disable Xsan (If not in use) Disable FibreChannel (if not in use). We can now use a Settings Catalog profile to hide these system preference panes, using the Apple Developer Reference as a reference for each of these system preferences, allowing us to restrict the following areas:\nSystem Preference Value iCloud Profiles com.apple.preferences.icloud Security and Privacy com.apple.preference.security Startup Disk com.apple.preference.startupdisk Sharing com.apple.preferences.sharing Siri com.apple.Siri-Settings.extension Xsan com.apple.Xsan FibreChannel com.apple.prefpanel.fibrechannel With this we can create a new profile using the Disabled Preference Panes option.\nMicrosoft Intune macOS configuration profile for system preferences. This will then disable these panes on the device for the end user, stopping them adding iCloud accounts, configuring sharing settings include remote control, along with other NCSC deemed risky areas on the macOS device.\nTime Server Configuration # This one is nice and easy, and a lot easier to handle now in Intune, without the need to create a new mobileconfig file, we can just throw both the time zone and time servers into the same Settings Catalog profile as per the requirement below.\nSpecify time server by device location Ensure that you are selecting location specific time servers, in this instance we\u0026rsquo;re in the UK so using the UK servers from the NTP Pool Project, you may want to configure your own servers, but remember these devices may not always be on your local corporate network.\nMicrosoft Intune macOS configuration profile for time zone settings. Summary # Even if you\u0026rsquo;re not aligning to NCSC or Cyber Essentials guidance for your macOS devices, this post will be useful as a good practice security configuration, as well as the fact that Microsoft is investing into the management of operating systems that aren\u0026rsquo;t Windows in Microsoft Intune.\nThere have been many developments with macOS device management with new changes coming for these devices already listed in the In Development page, hopefully one day we\u0026rsquo;ll get Azure Active Directory Microsoft Entra ID joined macOS devices\u0026hellip;we can but hope.\n","date":"11 July 2023","externalUrl":null,"permalink":"/posts/macos-ncsc-revisited/","section":"Posts","summary":"With the improved support for macOS devices in Microsoft Intune, it\u0026rsquo;s time we revisited how to secure macOS devices aligned the National Cyber Security Centre guidance.","title":"Revisiting macOS National Cyber Security Centre Security Settings","type":"posts"},{"content":"","date":"27 June 2023","externalUrl":null,"permalink":"/tags/assignments/","section":"Tags","summary":"","title":"Assignments","type":"tags"},{"content":"Fresh off the back of a trawl of a Modern Endpoint Management LinkedIn group, someone wanted the ability to assign existing Settings Catalog profiles in Microsoft Intune to additional Groups\u0026hellip;this sounded like a quick win if you fancy manually doing it, but no one wants that, and as I had experience of dealing with the logic when assigning apps, I thought I\u0026rsquo;d give it a go.\nThe functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. Assignment Overview # Assigning Settings Catalog profiles for Windows, macOS, and iOS/iPadOS devices isn\u0026rsquo;t anything new, though Settings Catalogs were a bit of a revelation when they first appeared in Microsoft Intune allowing you to build profiles from scratch with a searchable interface, and with the ability to assign them to groups and use Device Filters, I jumped at the chance to use them in place of custom profiles where applicable.\nWhat about the assignment though, what does that look like?\nAssignment Restrictions # Settings Catalog assignment isn\u0026rsquo;t too dissimilar from assigning any other profile type, though as you\u0026rsquo;ll discover through subsequent posts, each has it\u0026rsquo;s own nuance when it comes to how you assign the profiles. So let\u0026rsquo;s list what we can do when it comes to assignment, and what we can\u0026rsquo;t do, as this will shape how we build out a PowerShell function to allow us to assign profiles in bulk.\nAssignment Wins # These assignments, if already familiar with Microsoft Intune, shouldn\u0026rsquo;t come as any surprise:\nIncluded Groups: Assigning to All Devices, All Users, and Groups of Devices or Users Included Groups: Assigning to All Devices with an Include Device Filter, All Users with an Include Device Filter, and Groups of Devices or Users with an Include Device Filter Included Groups: Assigning to All Devices with an Exclude Device Filter, All Users with an Exclude Device Filter, and Groups of Devices or Users with an Exclude Device Filter Excluded Groups: Assigning to Groups of Devices or Users Remember that when excluding groups, you cannot mix user and device groups across include and exclude. So this is pretty useful and should, especially with Device Filters, be all you need for assignment. What about the things we can\u0026rsquo;t do?\nAssignment No-nos # The list below is the current list of things you cannot do with the assignments for Settings Catalogs, and takes into consideration whether there are existing assignments on the profile:\nIncluded Groups: Assigning to All Devices and a Group of Devices or Users Included Groups: Assigning to All Users and a Group of Devices or Users Included Groups: Assigning to a Group that already has an assignment Included Groups: Assigning to All Devices that already has an assignment Included Groups: Assigning to All Users that already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Devices already has an assignment Included Groups: Assigning to Groups of Devices or Users if All Users already has an assignment Excluded Groups: Assigning to Groups of Devices or Users with any Device Filter Excluded Groups: Assigning to All Devices or All Users Excluded Groups: Assigning to a Group that already has an assignment There are many restrictions when it comes to adding additional assignments, the above are the important ones, as we don\u0026rsquo;t want to be creating ourselves issues with assignments later on. Though this is going to give me a headache writing PowerShell to deal with this logic.\nGetting Settings Catalog Information # We\u0026rsquo;ve now got a good grip on the methods for assignment, but to start this all off, we need a way to get both the the Settings Catalog profile itself, a method to capture all existing assignments, and importantly, how to add assignments to the profile.\nGetting Settings Catalogs # I already had the PowerShell function below at my disposal, so after connecting to Graph API using Connect-MgGraph and the Graph PowerShell SDK module, we can use the deviceManagementConfigurationPolicy endpoint in the below function to pull back either all Settings Catalogs, or specific ones using either the Id or Name.\nFunction Get-DeviceSettingsCatalog() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] $Name, [Parameter(Mandatory = $false)] $Id ) $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#34;deviceManagement/configurationPolicies?`$filter=technologies has \u0026#39;mdm\u0026#39;\u0026#34; try { if ($Id) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource/$Id\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Get } elseif ($Name) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value | Where-Object { ($_.Name).contains(\u0026#34;$Name\u0026#34;) } } Else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; Write-Host \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Break } } Running this function will get us the information we need in the Id of the Setting Catalog profile.\ncreatedDateTime : 08/03/2023 13:39:14 creationSource : description : lastModifiedDateTime : 10/05/2023 08:40:16 name : Corporate_Configuration_Policy_Conflict platforms : windows10 priorityMetaData : roleScopeTagIds : {0} settingCount : 1 technologies : mdm id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 templateReference : @{templateId=; templateFamily=none; templateDisplayName=; templateDisplayVersion=} With a way to get a Settings Catalog profile, we now need a way to pull back any and all assignments for a profile using the deviceManagementConfigurationPolicyAssignments endpoint in Graph and the above Id of the profile.\nGetting Settings Catalog Assignments # Function Get-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/configurationPolicies/$Id/assignments\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).value } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; Write-Host \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Break } } This is the set of assignments on an existing Settings Catalog profile that we can now query.\nSettings Catalog assignments in Microsoft Intune. Passing through the Id we will get an output that looks like the below for the above assignments, with the target being the important part, as this contains the details of the types of assignments as well as the Ids of the groups the profile is assigned to.\nid : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_b2358c32-aff8-4408-bf90-d6c4c4e73a90 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=; deviceAndAppManagementAssignmentFilterType=none; groupId=b2358c32-aff8-4408-bf90-d6c4c4e73a90} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_c4480982-3342-4dc5-9c58-b272a77b7ab1 source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.groupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=4feb8cf9-1529-41d6-80bb-498922c5e567; deviceAndAppManagementAssignmentFilterType=include; groupId=c4480982-3342-4dc5-9c58-b272a77b7ab1} id : 0565e69e-7bba-455a-bfaa-4ca6680a02b5_f9c1e630-771d-4c12-b366-8a3e4db0509a source : direct sourceId : 0565e69e-7bba-455a-bfaa-4ca6680a02b5 target : @{@odata.type=#microsoft.graph.exclusionGroupAssignmentTarget; deviceAndAppManagementAssignmentFilterId=; deviceAndAppManagementAssignmentFilterType=none; groupId=f9c1e630-771d-4c12-b366-8a3e4db0509a} So we kinda have the bits we need to get existing assignments, what about adding a new assignment?\nAssigning Settings Catalogs # First thing to note about assignments in Microsoft Intune, is there is no PATCH option with Graph API for the assignment endpoints, what this means is there is no native way to update the assignments of a Settings Catalog profile, the default behaviour is to replace any and all existing assignments. After trying to deal with the restrictions around assignments, I can understand why there is no PATCH option, as it\u0026rsquo;s a nightmare dealing with the logic.\nWe however, are not an API, so we can apply our squishy human brains and work something out to give us the ability to add new assignments, without ripping out the existing ones surely?\nBuilding New Assignments # So where do we start exactly? With the many different ways to assign a profile, or the twelfty different restrictions when adding new assignments to existing ones? Let\u0026rsquo;s go with the relatively simple creation of new assignments first, as this seems a little more straightforward.\nLuckily for us, Microsoft provide documentation for the JSON format of the payload required to create a new assignment, and as we have our own function to get existing assignments, we can quite easily build out the required data in PowerShell based on each of the methods for assignment.\nThe table below details the data used for each assignment method, so this is useful reference for us when building our own assignment function.\nTarget Type Name Value Group Include @odata.type #microsoft.graph.groupAssignmentTarget groupId Id of the Assignment Group Group Exclude @odata.type #microsoft.graph.exclusionGroupAssignmentTarget groupId Id of the Assignment Group All Users Include @odata.type #microsoft.graph.allLicensedUsersAssignmentTarget All Devices Include @odata.type #microsoft.graph.allDevicesAssignmentTarget Device Filter Include deviceAndAppManagementAssignmentFilterType Include deviceAndAppManagementAssignmentFilterId Id of the Device Filter Device Filter Exclude deviceAndAppManagementAssignmentFilterType Exclude deviceAndAppManagementAssignmentFilterId Id of the Device Filter So we can take the above and using the below excerpt from an existing assignment function, build the required JSON data.\n$TargetGroup = New-Object -TypeName psobject if ($GroupId) { if ($AssignmentType -eq \u0026#39;Exclude\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.exclusionGroupAssignmentTarget\u0026#39; } elseif ($AssignmentType -eq \u0026#39;Include\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; } $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value \u0026#34;$GroupId\u0026#34; } else { if ($All -eq \u0026#39;Users\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39; } ElseIf ($All -eq \u0026#39;Devices\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39; } } if ($FilterType) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $FilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $FilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup This will give us the correct format that can be submitted to Graph API to create a new assignment for example for All Users with a Device Filter.\n{ \u0026#34;assignments\u0026#34;: [ { \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterId\u0026#34;: \u0026#34;4feb8cf9-1529-41d6-80bb-498922c5e567\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterType\u0026#34;: \u0026#34;include\u0026#34; } } ] } Or including a Group with a Device Filter.\n{ \u0026#34;assignments\u0026#34;: [ { \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.groupAssignmentTarget\u0026#34;, \u0026#34;groupId\u0026#34;: \u0026#34;f9c1e630-771d-4c12-b366-8a3e4db0509a\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterId\u0026#34;: \u0026#34;4feb8cf9-1529-41d6-80bb-498922c5e567\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterType\u0026#34;: \u0026#34;include\u0026#34; } } ] } That was the easy part, and we can take the above methods to create new assignments. So now onto the head scratcher.\nCapturing Existing Assignments # We have the Get-DeviceSettingsCatalogAssignment function at our disposal now, so we can query a Settings Catalog profile to get any existing assignments, which is going to be important when dealing with the logic of adding new ones, for now we just need to get the existing ones into a useable JSON format so we can punt it back to Graph API.\n#Gets existing Assignments $Assignments = Get-DeviceSettingsCatalogAssignment -Id $Id # Creates an array for the existing assignments $TargetGroups = @() foreach ($Assignment in $Assignments) { $TargetGroup = New-Object -TypeName psobject $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value $Assignment.target.\u0026#39;@odata.type\u0026#39; if ($Assignment.target.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*groupAssignmentTarget*\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value $Assignment.target.groupId } if ($Assignment.target.deviceAndAppManagementAssignmentFilterType -ne \u0026#39;none\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups += $Target } This captures the existing assignments and adds them to the $TargetGroups array variable, which can then be added to for any new assignments we want to add, then converted to JSON and eventually posted to Graph API.\nSo for our example, the output of the above would look something like the below.\n{ \u0026#34;assignments\u0026#34;: [ { \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.groupAssignmentTarget\u0026#34;, \u0026#34;groupId\u0026#34;: \u0026#34;b2358c32-aff8-4408-bf90-d6c4c4e73a90\u0026#34; } }, { \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.groupAssignmentTarget\u0026#34;, \u0026#34;groupId\u0026#34;: \u0026#34;c4480982-3342-4dc5-9c58-b272a77b7ab1\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterId\u0026#34;: \u0026#34;4feb8cf9-1529-41d6-80bb-498922c5e567\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterType\u0026#34;: \u0026#34;include\u0026#34; } }, { \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.exclusionGroupAssignmentTarget\u0026#34;, \u0026#34;groupId\u0026#34;: \u0026#34;f9c1e630-771d-4c12-b366-8a3e4db0509a\u0026#34; } } ] } We\u0026rsquo;re onto something here, time to look at the logic around adding new assignments to existing ones, mmmm logic my favourite coffee fuelled exercise.\nHandling Existing Assignments # Now that we can capture existing assignment, we need to deal with the logic when trying to add new assignments to the Settings Catalog profile. This will not be fun.\nLet\u0026rsquo;s go through each of the assignment non-nos we\u0026rsquo;ve already covered in this post.\nInclude Assignments # Assigning to All Devices and a Group of Devices or Users We just need to check if the function parameter $All which equates to an option to assign to All Device or All Users exists, and whether there are any existing group targetted assignment on the Settings Catalog profile.\nElseIf (($All -ne \u0026#39;\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups\u0026#39; break } Assigning to All Users and a Group of Devices or Users This one is covered by the above logic, as we wrote the If statement to only look for the $All parameter which takes into consideration both the All Devices and All Users assignment targets.\nAssigning to a Group that already has an assignment This one is pretty easy really, we just need to compare the GroupId of the new assignment, to any existing assignments targetting to groups, and if the Ids match, to stop the function from running.\nIf (($GroupId -ne \u0026#39;\u0026#39;) -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning \u0026#39;The policy is already assigned to the Group\u0026#39; break } Assigning to All Devices that already has an assignment Similar to the above, we\u0026rsquo;re checking to see if the new All Devices assignment already existing, and if it does, stopping the progress of the assignment.\nIf (($All -eq \u0026#39;Devices\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to the All Devices group\u0026#39; break } Assigning to All Users that already has an assignment This was pretty much a copy and paste of the above, just swapping the devices parameters for the users one.\nIf (($All -eq \u0026#39;Users\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to the All Users group\u0026#39; break } Assigning to Groups of Devices or Users if All Devices already has an assignment We need to identity whether a group assignment is being created, which is captured with the $GroupId function parameter, and whether either the All Devices or All Users assignment target exists, and if it does break the function from running.\nIf (($GroupId -ne \u0026#39;\u0026#39;) -and (($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;) -or ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;))) { Write-Warning \u0026#39;The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group\u0026#39; break } Assigning to Groups of Devices or Users if All Users already has an assignment This one is captured in the above logic, which is lucky as I was running out of steam by this point.\nExclude Assignments # Assigning to Groups of Devices or Users with any Device Filter Using the parameters of the function itself, we can stop this assignment type, with parameters configured for Group assignment in $GroupID and the Assignment Type parameter $AssignmentType, as well as the Filter ID parameter $FilterId. With this combination of parameters being true, we can throw an error and stop the function from running.\nIf (($AssignmentType -eq \u0026#39;Exclude\u0026#39;) -and ($GroupId -ne \u0026#39;\u0026#39;) -and ($FilterId -ne \u0026#39;\u0026#39;)) { Write-Warning \u0026#39;You cannot assign a group with a filter as an exclude assignment\u0026#39; break } Assigning to All Devices or All Users We can again handle this in the function itself, with parameters for an \u0026lsquo;All Devices or Users\u0026rsquo; assignment and the \u0026lsquo;Assignment Type\u0026rsquo;, so if you select the $All assignment and the assignment type $AssignmentType equalling Exclude, we can throw an error.\nIf (($All -ne \u0026#39;\u0026#39;) -and ($AssignmentType -eq \u0026#39;Exclude\u0026#39;)) { Write-Warning \u0026#39;You cannot All Devices or All Users groups as an exclude assignment\u0026#39; break } Assigning to a Group that already has an assignment The logic for this is exactly the same as the Include assignment type, as whether there is an include or exclude assignment for the same group, the result is the same.\nThe Assignment Function # We now have all the component parts, all is left to do is to throw them all at Visual Studio Code and pray that we\u0026rsquo;ve got something that works, configuring all the required logic and the function parameters to allow the assignment of new groups to Settings Catalog profiles.\nI\u0026rsquo;ve given the option to not only add to existing assignments, but also to just flatten the existing ones and create new using the $AssignmentAction parameter.\nFunction Add-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Id, [parameter(Mandatory = $false)] [string]$GroupId, [parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Include\u0026#39;, \u0026#39;Exclude\u0026#39;)] [string]$AssignmentType, [parameter(Mandatory = $false)] [string]$FilterId, [parameter(Mandatory = $false)] [ValidateSet(\u0026#39;Include\u0026#39;, \u0026#39;Exclude\u0026#39;)] [string]$FilterType, [parameter(Mandatory = $false)] [ValidateSet(\u0026#39;Users\u0026#39;, \u0026#39;Devices\u0026#39;)] [string]$All, [parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Replace\u0026#39;, \u0026#39;Add\u0026#39;)] $AssignmentAction ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/configurationPolicies/$Id/assign\u0026#34; try { # Stopping assignmnent of All Users or All Devices as an exclude assignment if (($All -ne \u0026#39;\u0026#39;) -and ($AssignmentType -eq \u0026#39;Exclude\u0026#39;)) { Write-Warning \u0026#39;You cannot All Devices or All Users groups as an exclude assignment\u0026#39; break } # Stopping assignment of group and All Devices/Users if (($All -ne \u0026#39;\u0026#39;) -and ($GroupId -ne \u0026#39;\u0026#39;)) { Write-Warning \u0026#39;You cannot assign to All Devices or All Users, and groups\u0026#39; break } # Stopping assignment of group with filter as an exclude assignment if (($AssignmentType -eq \u0026#39;Exclude\u0026#39;) -and ($GroupId -ne \u0026#39;\u0026#39;) -and ($FilterId -ne \u0026#39;\u0026#39;)) { Write-Warning \u0026#39;You cannot assign a group with a filter as an exclude assignment\u0026#39; break } # If Adding an assignment to existing assignments If ($AssignmentAction -eq \u0026#39;Add\u0026#39;) { # Checking if there are Assignments already configured $Assignments = Get-DeviceSettingsCatalogAssignment -Id $Id if ($Assignments.count -ge 1) { # Checking if the group is already assigned If (($GroupId -ne \u0026#39;\u0026#39;) -and ($GroupId -in $Assignments.target.groupId)) { Write-Warning \u0026#39;The policy is already assigned to the Group\u0026#39; break } # Checking if already assigned to All Devices ElseIf (($All -eq \u0026#39;Devices\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to the All Devices group\u0026#39; break } # Checking if aleady assigned to All users ElseIf (($All -eq \u0026#39;Users\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to the All Users group\u0026#39; break } # Checking if already assigned to groups when assigning \u0026#39;All\u0026#39; assignment ElseIf (($All -ne \u0026#39;\u0026#39;) -and ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39;)) { Write-Warning \u0026#39;The policy is already assigned to a group(s), and cannot be assigned to All Devices or All Users groups\u0026#39; break } # Checking if already assigned to \u0026#39;All\u0026#39; when assigning groups ElseIf (($GroupId -ne \u0026#39;\u0026#39;) -and (($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;) -or ($Assignments.target.\u0026#39;@odata.type\u0026#39; -contains \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;))) { Write-Warning \u0026#39;The policy is already assigned to All Devices or All Users groups, and cannot be assigned to a group\u0026#39; break } # If new assignment viable, captures existing assignments Else { # Creates an array for the existing assignments $TargetGroups = @() foreach ($Assignment in $Assignments) { $TargetGroup = New-Object -TypeName psobject $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value $Assignment.target.\u0026#39;@odata.type\u0026#39; if ($Assignment.target.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*groupAssignmentTarget*\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value $Assignment.target.groupId } if ($Assignment.target.deviceAndAppManagementAssignmentFilterType -ne \u0026#39;none\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups += $Target } } } } # Creates the new assignment $TargetGroup = New-Object -TypeName psobject if ($GroupId) { if ($AssignmentType -eq \u0026#39;Exclude\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.exclusionGroupAssignmentTarget\u0026#39; } elseif ($AssignmentType -eq \u0026#39;Include\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; } $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value \u0026#34;$GroupId\u0026#34; } else { if ($All -eq \u0026#39;Users\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39; } ElseIf ($All -eq \u0026#39;Devices\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39; } } if ($FilterType) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $FilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $FilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups += $Target # Creating JSON object to pass to Graph $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;assignments\u0026#39; -Value @($TargetGroups) $JSON = $Output | ConvertTo-Json -Depth 3 # POST to Graph Service $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { $exs = $Error.ErrorDetails $ex = $exs[0] Write-Host \u0026#34;Response content:`n$ex\u0026#34; -f Red Write-Host \u0026#34;Request to $Uri failed with HTTP Status $($ex.Message)\u0026#34; Break } } That\u0026rsquo;s all there is to it, which is hilarious as I\u0026rsquo;m pretty sure I aged significantly when coming up with this function. Let\u0026rsquo;s see how we can use this to create new assignments.\nUsing the Assignment Function # We need to start by getting the Id of an existing Settings Catalog profile, so we can reference this Id when creating new assignments, and if we\u0026rsquo;re using Devices Filters or Groups, we need to get the Ids of those as well.\n$Policy = Get-DeviceSettingsCatalog | Where-Object { $_.Name -eq \u0026#39;Corporate_Configuration_Policy_Conflict\u0026#39; } $Group = Get-MDMGroup -GroupName \u0026#39;SG_MDM_Devices_Corporate_POC\u0026#39; $Filter = Get-DeviceFilter -Name \u0026#39;Corporate_Windows_All\u0026#39; Right, onto the fun parts. I\u0026rsquo;ve provided examples of each of the possible assignment methods below and in an example script which as always can be found on GitHub\n# Adding an include Group assignment Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Add -AssignmentType Include -GroupId $group.id # Adding an include Group assignment with include filter Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Add -AssignmentType Include -GroupId $group.id -FilterType Include -FilterID $Filter.id # Adding an exclude Group assignment Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Add -AssignmentType Exclude -GroupId $group.id # Adding an Include All Devices assignment Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Add -AssignmentType Include -All Devices # Adding an Include All Devices assignment with filter Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Add -AssignmentType Include -All Devices -FilterType Include -FilterID $Filter.id # Replacing all assignment and adding an Include All Users assignment Add-DeviceSettingsCatalogAssignment -Id $Policy.id -AssignmentAction Replace -AssignmentType Include -All Users If all went to plan, we should now be able to successfully create Settings Catalog profile assignments as little and often as we\u0026rsquo;d like, with the ability to now get all of your Settings Catalog profiles, and for each of them create and add new assignments.\nSummary # This will end up being the first in a series of posts about managing assignments in Microsoft Intune, but luckily for me, Settings Catalog assignment is one of the more complicated ones (he says already knowing the Application assignment is more complicated) so the next one I look at should be a little less logic heavy, as well as the fact I should be able to reuse some of the Settings Catalog profile assignment function across many areas of Microsoft Intune.\n","date":"27 June 2023","externalUrl":null,"permalink":"/posts/managing-intune-assignment-settingscatalog/","section":"Posts","summary":"Ever wanted to the ability to re-assign all of your Setting Catalog profiles in Intune to additional device and user groups without having to painstakingly go through each one manually? Well this post is for you.","title":"Managing Assignments in Microsoft Intune: Settings Catalog Profiles","type":"posts"},{"content":"","date":"11 June 2023","externalUrl":null,"permalink":"/tags/antivirus/","section":"Tags","summary":"","title":"Antivirus","type":"tags"},{"content":"","date":"11 June 2023","externalUrl":null,"permalink":"/tags/compliance/","section":"Tags","summary":"","title":"Compliance","type":"tags"},{"content":"So what happens when you\u0026rsquo;re not using Windows Defender on your Windows 10 and later Microsoft Intune enrolled devices, and you\u0026rsquo;re not happy with the basic compliance checks for Third-Party Antivirus products?\nMicrosoft have come to the rescue with their Custom Compliance Settings, so let\u0026rsquo;s utilise this detect and check policy, and leverage it to detect and report on Non-Microsoft Antivirus products, their real time protection status, as well as whether the definitions are up to date.\nCustom Compliance Policies # As Custom Compliance isn\u0026rsquo;t that new a feature of Microsoft Intune, I\u0026rsquo;m not going to deep dive into the process, a number of other people have done that already:\nPeter van der Woude Call4Cloud Device Advice We\u0026rsquo;re going to focus on how to use it to achieve our goal, detecting additional information about third-party Antivirus solutions.\nPowerShell and WMI # We need a way to get information about the expected active Antivirus product, in this instance \u0026lsquo;Sophos Antivirus\u0026rsquo;, installed on device; to do this we can use the WMI Class AntiVirusProduct within the root\\SecurityCenter2 namespace.\nGet-WmiObject -Namespace \u0026#34;root\\SecurityCenter2\u0026#34; -Class AntiVirusProduct This will pull back details about the Antivirus software registered by Windows, as you can see from the below, it will pull back all products registered, including Windows Defender.\n__GENUS : 2 __CLASS : AntiVirusProduct __SUPERCLASS : __DYNASTY : AntiVirusProduct __RELPATH : AntiVirusProduct.instanceGuid=\u0026#34;{8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE}\u0026#34; __PROPERTY_COUNT : 6 __DERIVATION : {} __SERVER : LT01540 __NAMESPACE : ROOT\\SecurityCenter2 __PATH : \\\\LT01540\\ROOT\\SecurityCenter2:AntiVirusProduct.instanceGuid=\u0026#34;{8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE}\u0026#34; displayName : Sophos Anti-Virus instanceGuid : {8E0623B8-CF1C-DFFE-CEA3-AA41BDA4B8EE} pathToSignedProductExe : C:\\Program Files (x86)\\Sophos\\Sophos Anti-Virus\\WSCClient.exe pathToSignedReportingExe : C:\\Program Files (x86)\\Sophos\\Sophos Anti-Virus\\WSCClient.exe productState : 331776 timestamp : Tue, 16 Nov 2021 17:29:40 GMT __GENUS : 2 __CLASS : AntiVirusProduct __SUPERCLASS : __DYNASTY : AntiVirusProduct __RELPATH : AntiVirusProduct.instanceGuid=\u0026#34;{D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\u0026#34; __PROPERTY_COUNT : 6 __DERIVATION : {} __SERVER : __NAMESPACE : ROOT\\SecurityCenter2 __PATH : \\\\\\ROOT\\SecurityCenter2:AntiVirusProduct.instanceGuid=\u0026#34;{D68DDC3A-831F-4fae-9E44-DA132C1ACF46}\u0026#34; displayName : Windows Defender instanceGuid : {D68DDC3A-831F-4fae-9E44-DA132C1ACF46} pathToSignedProductExe : windowsdefender:// pathToSignedReportingExe : %ProgramFiles%\\Windows Defender\\MsMpeng.exe productState : 393472 timestamp : Thu, 16 Dec 2021 10:49:39 GMT So we will need a way to filter only to the expected active Antivirus software installed.\nAntivirus Product State # With the information available about the Antivirus products, we need to be able to identify whether Real Time Protection is running, as well as whether the Definitions are up to date. I\u0026rsquo;d say luckily, but I\u0026rsquo;d be lying, we have the productState information to work with.\nproductState : 393472 This hex value does translate into something we can use to identify the definition and protection status checks, and thanks to Marc Schneider we can actually understand this number and how to use it as part of a Custom Compliance policy.\nThe six-digit value for \u0026lsquo;productState\u0026rsquo; can be broken down into three pairs of two-digits, with each actually meaning something once converted to a hex string:\n1st Pair: Product Type 2nd Pair: Real Time Protection Status 3rd Pair: Definition Status The 2nd and 3rd pair may report differently depending on your Antivirus product, as detailed in this post, so you will have to check this on a device with up-to-date definitions as well as real time protection enabled to be sure. The values for each of these pairs for Sophos Antivirus can be seen below:\nItem Value Description Real Time Protection Status 00 Off 01 Expired 10 On 11 Snoozed Definition Status 00 Up to Date 10 Out of Date So we now have a way to identify and confirm that both Real Time protection is enabled, and Definitions are in place for the Antivirus product of choosing.\nDetection Script Creation # With a couple of variables, some hex conversion, switches, and a little bit of logic, we can get the information we need and throw it into the JSON format required by Microsoft to allow the Custom Compliance script to work as expected.\nWe\u0026rsquo;ve used the $AVClient variable, which will allow re-use of the script depending on which product is installed across your device estate.\nWe also have to be able to capture and present back when the script doesn\u0026rsquo;t detect the specified $AVClient variable, otherwise we\u0026rsquo;ll get some grim looking compliance errors on those devices.\n$avClient = \u0026#39;Sophos Anti-Virus\u0026#39; $avProduct = Get-WmiObject -Namespace \u0026#39;root\\SecurityCenter2\u0026#39; -Class AntiVirusProduct | Where-Object { $_.displayName -eq $avClient } | Select-Object -First 1 $avSummary = New-Object -TypeName PSObject If ($avProduct) { $hexProductState = [Convert]::ToString($avProduct.productState, 16).PadLeft(6, \u0026#39;0\u0026#39;) $hexRealTimeProtection = $hexProductState.Substring(2, 2) $hexDefinitionStatus = $hexProductState.Substring(4, 2) $realTimeProtectionStatus = switch ($hexRealTimeProtection) { \u0026#39;00\u0026#39; { \u0026#39;Off\u0026#39; } \u0026#39;01\u0026#39; { \u0026#39;Expired\u0026#39; } \u0026#39;10\u0026#39; { \u0026#39;On\u0026#39; } \u0026#39;11\u0026#39; { \u0026#39;Snoozed\u0026#39; } default { \u0026#39;Unknown\u0026#39; } } $definitionStatus = switch ($hexDefinitionStatus) { \u0026#39;00\u0026#39; { \u0026#39;Up to Date\u0026#39; } \u0026#39;10\u0026#39; { \u0026#39;Out of Date\u0026#39; } default { \u0026#39;Unknown\u0026#39; } } $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient\u0026#34; -Value $avProduct.displayName $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient real time protection enabled\u0026#34; -Value $realTimeProtectionStatus $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient definitions up-to-date\u0026#34; -Value $definitionStatus } Else { $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient\u0026#34; -Value \u0026#39;Error: No Antivirus product found\u0026#39; $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient real time protection enabled\u0026#34; -Value \u0026#39;Error: No Antivirus product found\u0026#39; $avSummary | Add-Member -MemberType NoteProperty -Name \u0026#34;$avClient definitions up-to-date\u0026#34; -Value \u0026#39;Error: No Antivirus product found\u0026#39; } return $avSummary | ConvertTo-Json -Compress Running this script on a machine with the Antivirus product installed would be a good idea to test that the scripts works, and is outputting the correct information in the required format for Intune to translate.\nThe output from the script should look a little bit like the below:\n{\u0026#34;Sophos Anti-Virus\u0026#34;:\u0026#34;Sophos Anti-Virus\u0026#34;,\u0026#34;Sophos Anti-Virus real time protection enabled\u0026#34;:\u0026#34;On\u0026#34;,\u0026#34;Sophos Anti-Virus definitions up-to-date\u0026#34;:\u0026#34;Up to Date\u0026#34;} JSON Checks # As we\u0026rsquo;ve seen in the JSON check requirements from Microsoft, we now need to build out a JSON file using the template as a starter, making sure that our JSON output from the script can be translated into something the Custom Compliance Policy can use.\nBelow is the updated JSON content we can use for the check, I\u0026rsquo;ve kept this quite light touch if I\u0026rsquo;m honest, and not specific to the Antivirus product, again so this can be re-used without changing a million things.\nYou will need to change the Operand for the first Rule to match the Antivirus product name you have installed, and if you want to, feel free to update the following fields to your taste:\nMoreInfoUrl Title Description Updated to include improved presentation to the end user of the issues as displayed in the Company Portal. { \u0026#34;Rules\u0026#34;: [ { \u0026#34;SettingName\u0026#34;: \u0026#34;Sophos Anti-Virus\u0026#34;, \u0026#34;Operator\u0026#34;: \u0026#34;IsEquals\u0026#34;, \u0026#34;DataType\u0026#34;: \u0026#34;String\u0026#34;, \u0026#34;Operand\u0026#34;: \u0026#34;Sophos Anti-Virus\u0026#34;, \u0026#34;MoreInfoUrl\u0026#34;: \u0026#34;https://support.home.sophos.com/hc/en-us/categories/115001242663-Installing-Sophos-Home\u0026#34;, \u0026#34;RemediationStrings\u0026#34;: [ { \u0026#34;Language\u0026#34;: \u0026#34;en_US\u0026#34;, \u0026#34;Title\u0026#34;: \u0026#34;Sophos Anti-Virus was not detected.\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;You must have Sophos Antivirus installed on your device to protect it from malware.\u0026#34; } ] }, { \u0026#34;SettingName\u0026#34;: \u0026#34;Sophos Anti-Virus real time protection enabled\u0026#34;, \u0026#34;Operator\u0026#34;: \u0026#34;IsEquals\u0026#34;, \u0026#34;DataType\u0026#34;: \u0026#34;String\u0026#34;, \u0026#34;Operand\u0026#34;: \u0026#34;On\u0026#34;, \u0026#34;MoreInfoUrl\u0026#34;: \u0026#34;https://support.home.sophos.com/hc/en-us/articles/115005596186-Configuring-Real-Time-Protection\u0026#34;, \u0026#34;RemediationStrings\u0026#34;: [ { \u0026#34;Language\u0026#34;: \u0026#34;en_US\u0026#34;, \u0026#34;Title\u0026#34;: \u0026#34;Sophos Antivirus real time protection is not enabled\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;Real time protection must be enabled in Sophos to protect your device, please enable this setting.\u0026#34; } ] }, { \u0026#34;SettingName\u0026#34;: \u0026#34;Sophos Anti-Virus definitions up-to-date\u0026#34;, \u0026#34;Operator\u0026#34;: \u0026#34;IsEquals\u0026#34;, \u0026#34;DataType\u0026#34;: \u0026#34;String\u0026#34;, \u0026#34;Operand\u0026#34;: \u0026#34;Up to Date\u0026#34;, \u0026#34;MoreInfoUrl\u0026#34;: \u0026#34;https://kb.mit.edu/confluence/pages/viewpage.action?pageId=152584581#:~:text=By%20default%2C%20Sophos%20Anti%2DVirus,as%20detailed%20%E2%80%93%20is%20not%20necessary.\u0026#34;, \u0026#34;RemediationStrings\u0026#34;: [ { \u0026#34;Language\u0026#34;: \u0026#34;en_US\u0026#34;, \u0026#34;Title\u0026#34;: \u0026#34;Sophos Antivirus definitions are not up to date.\u0026#34;, \u0026#34;Description\u0026#34;: \u0026#34;Please update the Sophos Antivirus definitions to ensure you device is protected from malware.\u0026#34; } ] } ] } Deploying Custom Compliance # We\u0026rsquo;ve now got both a PowerShell script and JSON file, so the last steps are to throw these into Microsoft Intune.\nFirst off we need to add the PowerShell script in the Compliance Scripts section.\nCompliance Policy script in Microsoft Intune. Following this, we can now create our Custom Compliance policy for Windows; select the previously created PowerShell script, and we\u0026rsquo;ll need to upload the JSON file created earlier.\nCompliance Policy in Microsoft Intune. Once we\u0026rsquo;ve got this in place, we can now assign the Compliance Policy.\nChecking Compliance State # With the Custom Compliance policy deployed, and waiting a little while for devices to start reporting back, we can check on the status of the devices it has been assigned to.\nWe have some good devices Microsoft Intune Compliance check with good results. Some not so good Microsoft Intune Compliance check with poor results. and some truly problematic Microsoft Intune Compliance check with bad results. With this Compliance Policy now in place, we not only get a view of the device estate, but can integrate Compliance into Conditional Access Policies, so it\u0026rsquo;s not a bad situation to be in at all.\nSummary # Custom Compliance does seem like a bit of an effort, and it currently has minimal operators for the JSON check, an inability to add more than one PowerShell script to a single policy, an eight hour wait for the Compliance state to update after remediation, and a few other limitations, but for those organisations that aren\u0026rsquo;t fully in bed with Microsoft when it comes down to endpoint protection products, it does offer a way to extend compliance to these solutions.\n","date":"11 June 2023","externalUrl":null,"permalink":"/posts/custom-compliance-third-party-av/","section":"Posts","summary":"So what happens when you\u0026rsquo;re not using Windows Defender on your Windows 10 and later Microsoft Intune enrolled devices, and you\u0026rsquo;re not happy with the basic compliance checks for Third-Party Antivirus products?","title":"Detailed Compliance for Non-Microsoft Antivirus Solutions","type":"posts"},{"content":"So you\u0026rsquo;re interested in Endpoint Privilege Management in Microsoft Intune, you\u0026rsquo;ve found, begged for, borrowed or stolen the money for shiny new Intune Suite or EPM licenses, and in you\u0026rsquo;re excitement you\u0026rsquo;ve gone and deployed a new policy to audit using the Reporting Scope options, all elevations across your managed Windows 10 and later devices. Now what?\nWell it\u0026rsquo;s policy creation time, but that seems like a labour intensive (well many clicks) task, and as much as the reports give you all the required information you need to review unmanaged elevations and create new policies and elevation rules, there has to be a better way to take the data in the report and create these policies and subsequent rules for you.\nThe functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. EPM Reporting # The Endpoint elevation report in Microsoft Intune will give us the data we need to create hash based rules, so let\u0026rsquo;s find a way to get the report data and export it with some collated information to make reviewing the elevations a little easier, as no one wants to review individual elevations from each user on a case by case basis, unless you\u0026rsquo;re in InfoSec.\nMicrosoft Intune Elevation Report. Getting Report Data # Once connected to Graph API using Connect-MgGraph we can use the deviceManagement/privilegeManagementElevations endpoint (of which there is no documentation currently, tut tut Microsoft) to pull back the report data. I\u0026rsquo;ve given the option to pull back Managed, Unmanaged, and All elevation types with this function so it\u0026rsquo;s at least reusable, though for now we only care about the Unmanaged elevations.\nFunction Get-DeviceEPMReport() { [cmdletbinding()] param ( [Parameter(Mandatory = $false)] [ValidateSet(\u0026#39;Managed\u0026#39;, \u0026#39;Unmanaged\u0026#39;)] [String]$Elevation, [Parameter(Mandatory = $false)] $Top ) $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;deviceManagement/privilegeManagementElevations\u0026#39; try { if ($Elevation -eq \u0026#39;Managed\u0026#39;) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)?filter=(elevationType ne \u0026#39;unmanagedElevation\u0026#39;)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).value } elseif ($Elevation -eq \u0026#39;Unmanaged\u0026#39;) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)?filter=(elevationType eq \u0026#39;unmanagedElevation\u0026#39;)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).value } else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Running the PowerShell function will give us an output of each Unmanaged elevation, which we can then process, apply some groupings, and eventually export.\nGet-DeviceEPMReport -Elevation Unmanaged Screenshot PowerShell script elevation report output. Exporting Report Data # Now that we have the data from the elevation report, I thought it best we group the elevations by hash value, as this is a unique identifier for each application that has been elevated by a user, as well as counting the number of elevations for that application, the users who have elevated, and the devices they have elevated from.\nThe above information, and below details required for rule creation, allows us to review the elevations and whether we want to create rules from them:\nCount of Elevations for the application: so we can see whether this is a widely used elevated application Elevated application file name: required for rule creation Elevated application internal name Elevated application publisher Elevated application product name Elevated application description Elevated application file path: formatted with \\\\ as is required by the rule creation Elevated application file version Users who have elevated the application: formatted for only unique users so we can assess which users are elevating the application Devices where the application has been elevated: formatted for only unique devices so we can assess from which devices the application is being elevated The below PowerShell captures all the required data in the correct formats to a new $Report array variable, which we can then export to CSV once we\u0026rsquo;ve cycled through all elevations.\n$Report = @() $Hashes = Get-DeviceEPMReport -Elevation Unmanaged | Group-Object -Property hash foreach ($Hash in $Hashes) { $Elevations = $Hash.Group $Users = @() $Devices = @() foreach ($Elevation in $Elevations) { $FileName = $Elevation.filePath | Split-Path -Leaf $FileInternalName = $Elevation.internalName $FileCompany = $Elevation.companyName $FileProduct = $Elevation.productName $FileDescription = $Elevation.fileDescription $FilePath = ($Elevation.filePath | Split-Path) -replace \u0026#39;\\\\\u0026#39;, \u0026#39;\\\\\u0026#39; $FileVersion = $Elevation.fileVersion $Users += $Elevation.upn $Devices += $Elevation.deviceName } $Data = [PSCustomObject]@{ ElevationCount = $Hash.Count Product = $FileProduct Description = $FileDescription Publisher = $FileCompany FileName = $FileName FileInternalName = $FileInternalName FileVersion = $FileVersion FilePath = $FilePath FileHash = $Hash.Name Users = (($Users | Get-Unique) -join \u0026#39; \u0026#39; | Out-String).Trim() Devices = (($Devices | Get-Unique) -join \u0026#39; \u0026#39; | Out-String).Trim() ElevationType = \u0026#39;Automatic/UserAuthentication/UserJustification\u0026#39; Group = \u0026#39;GroupName\u0026#39; } $Report += $Data } Exporting the $Report variable to CSV using the append function for each elevation, we get something like the below.\n\u0026#34;ElevationCount\u0026#34;,\u0026#34;Product\u0026#34;,\u0026#34;Description\u0026#34;,\u0026#34;Publisher\u0026#34;,\u0026#34;FileName\u0026#34;,\u0026#34;FileInternalName\u0026#34;,\u0026#34;FileVersion\u0026#34;,\u0026#34;FilePath\u0026#34;,\u0026#34;FileHash\u0026#34;,\u0026#34;Users\u0026#34;,\u0026#34;Devices\u0026#34;,\u0026#34;ElevationType\u0026#34;,\u0026#34;Group\u0026#34;\r\u0026#34;6\u0026#34;,\u0026#34;Microsoft¬Æ Windows¬Æ Operating System\u0026#34;,\u0026#34;Windows PowerShell\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;powershell.exe\u0026#34;,\u0026#34;POWERSHELL\u0026#34;,\u0026#34;10.0.19041.2913\u0026#34;,\u0026#34;C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\u0026#34;,\u0026#34;B4E7BC24BF3F5C3DA2EB6E9EC5EC10F90099DEFA91B820F2F3FC70DD9E4785C4\u0026#34;,\u0026#34;AzureAD\\AlexWilber AzureAD\\ChristieCline\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ DESKTOP-7KFLL12\u0026#34;,\u0026#34;Automatic/UserAuthentication/UserJustification\u0026#34;,\u0026#34;GroupName\u0026#34;\r\u0026#34;4\u0026#34;,\u0026#34;PaladinVPN\u0026#34;,\u0026#34;PaladinVPN\u0026#34;,\u0026#34;Ledger Media Ltd\u0026#34;,\u0026#34;PaladinVPN.exe\u0026#34;,\u0026#34;PaladinVPN.exe\u0026#34;,\u0026#34;2.1.3.102\u0026#34;,\u0026#34;C:\\\\Program Files (x86)\\\\PaladinVPN\u0026#34;,\u0026#34;B6EF395DE2F28162DBAFCA79BAABEBB211245A68425CE096402030417FEA1160\u0026#34;,\u0026#34;AzureAD\\AlexWilber\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ\u0026#34;,\u0026#34;Automatic/UserAuthentication/UserJustification\u0026#34;,\u0026#34;GroupName\u0026#34;\r\u0026#34;12\u0026#34;,\u0026#34;Microsoft¬Æ Windows¬Æ Operating System\u0026#34;,\u0026#34;Windows Command Processor\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;cmd.exe\u0026#34;,\u0026#34;cmd\u0026#34;,\u0026#34;10.0.19041.746\u0026#34;,\u0026#34;C:\\\\Windows\\\\system32\u0026#34;,\u0026#34;B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450\u0026#34;,\u0026#34;AzureAD\\AlexWilber AzureAD\\ChristieCline\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ DESKTOP-7KFLL12\u0026#34;,\u0026#34;Automatic/UserAuthentication/UserJustification\u0026#34;,\u0026#34;GroupName\u0026#34; Now we have something to review, with two additional fields of ElevationType and Group that we will use for creation of new EPM policies and rules later on, forward planning here.\nEPM Policies # I have no shame when I say that I started from Andrew Taylor\u0026rsquo;s script to create EPM rules using PowerShell, allowing the creation of new EPM Policies and associated rules in Microsoft Intune based on a local files on the machine the script is being executed from. For me what this was missing was the ability to create multiple rules per EPM policy, and the to not rely on the file being local to the machine running the script to capture the required rule data.\nImporting Rule Data # With the CSV report exported, we now need to update the file itself, removing entries where we don\u0026rsquo;t want to create rules, and updating those we do want to create with both the ElevationType and Group for each rule we want to create. The ElevationType field needs to be populated with one of the below entries based on the approval type to be used:\nAutomatic: elevation happens invisibly to the user. There\u0026rsquo;s no prompt, and no indication that the file is running in an elevated context. UserAuthentication: A user confirmed elevation always requires the user to click on a confirmation prompt to run the file requiring users to authenticate using their organization credentials. UserJustification: A user confirmed elevation always requires the user to click on a confirmation prompt to run the file requiring the user to enter a business justification. The group field is there to not only reference which Azure Active Directory or synchronised Active Directory group the rule will apply to, but will allow for grouping of rules into a single policy, as this just makes sense as we\u0026rsquo;ll be applying the policy to the same group.\nGrouping EPM Rules # As we want to create a single policy for each provided group, containing all applicable rules, we need to capture the data based on the assignment group, this can be done pretty easily using the Group-Object command.\n$Policies = Import-Csv -Path $ImportPath | Group-Object -Property Group Now we can check if the supplied group exists, using the below function to search for the group based on it\u0026rsquo;s name.\nFunction Get-IntuneGroup() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Name ) $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;groups\u0026#39; try { $authToken[\u0026#39;ConsistencyLevel\u0026#39;] = \u0026#39;eventual\u0026#39; $searchterm = \u0026#39;search=\u0026#34;displayName:\u0026#39; + $Name + \u0026#39;\u0026#34;\u0026#39; $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource`?$searchterm\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Take note of the change to the $authtoken variable which needs updating to include \u0026lsquo;ConsistencyLevel\u0026rsquo; to support advanced queries using Graph API. We can ensure that the group exists prior to deploying the EPM policies to Microsoft Intune, and set the variables for each new rule to be created based on the data in the CSV file.\nforeach ($Policy in $Policies) { $Group = Get-IntuneGroup -Name $Policy.Name if ($null -eq $Group) { Write-Output \u0026#34;$($Policy.Name) group does not exist, unable to create EPM Policy\u0026#34; break } else { $Rules = $Policy.Group $JSONRules = @() foreach ($Rule in $Rules) { $FileName = $Rule.FileName $FileInternalName = $Rule.FileInternalName $FilePath = $Rule.FilePath $FileHash = $Rule.FileHash $ElevationType = $Rule.ElevationType $FileProduct = $Rule.Product -replace \u0026#39;[^\\x30-\\x39\\x41-\\x5A\\x61-\\x7A]+\u0026#39;, \u0026#39; \u0026#39; $FileDescription = $Rule.Description $RuleDescription = $($Rule.Publisher + \u0026#39; \u0026#39; + $Rule.Description) -replace \u0026#39;[^\\x30-\\x39\\x41-\\x5A\\x61-\\x7A]+\u0026#39;, \u0026#39; \u0026#39; Now onto the fun that is EPM policy and rule creation.\nCreating Settings Catalog Policies # The EPM Policies sit within the Setting Catalog space in Microsoft Intune, and it\u0026rsquo;s no secret that creating new Settings Catalog policies in Microsoft Intune is no walk in the park as per this post from Powers Hell. Our issue, in addition to Settings Catalogs creation being a pain in the arse, is that we want to create multiple rules in one EPM policy which comes with it\u0026rsquo;s own headache.\nUsing add-epmfilerule.ps1 and exports of EPM policies using Intune PowerShell Samples as a basis for the JSON structure, we can build the policy with multuple rules in stages with separate sections for the policy and rules.\nPolicy Start JSON # Easy one to start with as this section will be the same for each policy created, passing in variables from the imported CSV report.\n$JSONPolicyStart = @\u0026#34; { \u0026#34;description\u0026#34;: \u0026#34;EPM Policy for $($Group.displayName)\u0026#34;, \u0026#34;name\u0026#34;: \u0026#34;EPM Policy for $($Group.displayName)\u0026#34;, \u0026#34;platforms\u0026#34;: \u0026#34;windows10\u0026#34;, \u0026#34;settings\u0026#34;: [ { \u0026#34;settingInstance\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationGroupSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;ee3d2e5f-6b3d-4cb1-af9b-37b02d3dbae2\u0026#34; }, \u0026#34;groupSettingCollectionValue\u0026#34;: [ \u0026#34;@ Policy End JSON # This finishes off the JSON file needed to submit to Graph API, again this will be the same for each EPM policy.\n$JSONPolicyEnd = @\u0026#34; ] } } ], \u0026#34;technologies\u0026#34;: \u0026#34;endpointPrivilegeManagement\u0026#34;, \u0026#34;templateReference\u0026#34;: { \u0026#34;templateId\u0026#34;: \u0026#34;cff02aad-51b1-498d-83ad-81161a393f56_1\u0026#34; } } \u0026#34;@ That\u0026rsquo;s the simple part done, now to get our head around the rules.\nCreating the Initial Rule # The first rule in an EPM policy has differing JSON formatting than any subsequent rules, requiring settingValueTemplateId values. We\u0026rsquo;ll use logic in the PowerShell script to identify whether the each rule is the first in the list by querying the array of rules to check if the rule being processed is the first.\nInitial Rule Start JSON # The variables we created, and populated by the CSV file, are added to the JSON for the following values:\nRule Description Application Product Name Application Internal Name File Hash $JSONRuleStart = @\u0026#34; { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_appliesto\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;0cde1c42-c701-44b1-94b7-438dd4536128\u0026#34; }, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_allusers\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;2ec26569-c08f-434c-af3d-a50ac4a1ce26\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false }, \u0026#34;children\u0026#34;: [] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_description\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;b3714f3a-ead8-4682-a16f-ffa264c9d58f\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$RuleDescription\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;5e82a1e9-ef4f-43ea-8031-93aace2ad14d\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_productname\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;234631a1-aeb1-436f-9e05-dcd9489caf08\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileProduct\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;e466f96d-0633-40b3-86a4-9e093b696077\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_internalname\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;08511f12-25b5-4218-812c-39a2db444ef1\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileInternalName\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;ec295dd4-6bbc-4fa8-a503-960784c53f41\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filehash\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;e4436e2c-1584-4fba-8e38-78737cbbbfdf\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileHash\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;1adcc6f7-9fa4-4ce3-8941-2ce22cf5e404\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, \u0026#34;@ Initial Rule Elevation JSON # Based on the updated $ElevationType variable in the CSV file, we can define which of the below three elevation type JSON formats are passed into the policy JSON.\nInitial Rule Elevation Automatic # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;children\u0026#34;: [], \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\u0026#34; }, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\u0026#34; }, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;bc5a31ac-95b5-4ec6-be1f-50a384bb165f\u0026#34; } }, \u0026#34;@ Initial Rule Elevation User Authentication # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\u0026#34;, \u0026#34;choiceSettingCollectionValue\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;children\u0026#34;: [], \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\u0026#34; } ], \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\u0026#34; } ], \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\u0026#34; }, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\u0026#34; }, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;bc5a31ac-95b5-4ec6-be1f-50a384bb165f\u0026#34; } }, \u0026#34;@ Initial Rule Elevation User Business Justification # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\u0026#34;, \u0026#34;choiceSettingCollectionValue\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingValue\u0026#34;, \u0026#34;children\u0026#34;: [], \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\u0026#34; } ], \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\u0026#34; } ], \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;cb2ea689-ebc3-42ea-a7a4-c704bb13e3ad\u0026#34; }, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\u0026#34; }, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;bc5a31ac-95b5-4ec6-be1f-50a384bb165f\u0026#34; } }, \u0026#34;@ Initial Rule End JSON # The JSON contained below tails the first rule creation, with variables passed through based on the CSV report imported data for the following values:\nFile Description Rule Name File Name File Path $JSONRuleEnd = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filedescription\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;5e10c5a9-d3ca-4684-b425-e52238cf3c8b\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileDescription\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;df3081ea-4ea7-4f34-ac87-49b2e84d4c4b\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;fdabfcf9-afa4-4dbf-a4ef-d5c1549065e1\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileDescription $TypeDescription\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;03f003e5-43ef-4e7e-bf30-57f00781fdcc\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filename\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;0c1ceb2b-bbd4-46d4-9ba5-9ee7abe1f094\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FileName\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;a165327c-f0e5-4c7d-9af1-d856b02191f7\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filepath\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: { \u0026#34;settingInstanceTemplateId\u0026#34;: \u0026#34;c3b7fda4-db6a-421d-bf04-d485e9d0cfb1\u0026#34; }, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;$FilePath\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: { \u0026#34;settingValueTemplateId\u0026#34;: \u0026#34;f011bcfc-03cd-4b28-a1f4-305278d7a030\u0026#34;, \u0026#34;useTemplateDefault\u0026#34;: false } } } ] \u0026#34;@ Creating Subsequent Rules # This is where I was on the strugglebus understanding what format the JSON needed to be in when a policy has multiple rules. Eventually I worked out that any additional rule added to the policy has different JSON formatting, with no need for the settingValueTemplateId values, so here we go.\nRule Start JSON # The variables we created are added to the JSON in the same was as the initial rule, but with a differing JSON structure.\n$JSONRuleStart = @\u0026#34; { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_appliesto\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_allusers\u0026#34;, \u0026#34;children\u0026#34;: [] } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_description\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$RuleDescription\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_productname\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileProduct\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_internalname\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileInternalName\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filehash\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileHash\u0026#34; } }, \u0026#34;@ Rule Elevation JSON # Based on the $ElevationType variable, we can define which of the below three elevation type JSON formats are passed into the policy JSON, but this time with different JSON structure.\nRule Elevation Automatic # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_automatic\u0026#34;, \u0026#34;children\u0026#34;: [] } }, \u0026#34;@ Rule Elevation User Authentication # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingCollectionValue\u0026#34;: [ { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_1\u0026#34;, \u0026#34;children\u0026#34;: [] } ] } ] } }, \u0026#34;@ Rule Elevation User Business Justification # $JSONRuleElev = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingValue\u0026#34;: { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_self\u0026#34;, \u0026#34;children\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationChoiceSettingCollectionInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;choiceSettingCollectionValue\u0026#34;: [ { \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_ruletype_validation_0\u0026#34;, \u0026#34;children\u0026#34;: [] } ] } ] } }, \u0026#34;@ Rule End JSON # The JSON below tails rule creation, with variables passed through based on the CSV report imported data, again with different JSON structure.\n$JSONRuleEnd = @\u0026#34; { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filedescription\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileDescription\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_name\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileDescription $TypeDescription\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filename\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FileName\u0026#34; } }, { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationSimpleSettingInstance\u0026#34;, \u0026#34;settingDefinitionId\u0026#34;: \u0026#34;device_vendor_msft_policy_privilegemanagement_elevationrules_{elevationrulename}_filepath\u0026#34;, \u0026#34;settingInstanceTemplateReference\u0026#34;: null, \u0026#34;simpleSettingValue\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.deviceManagementConfigurationStringSettingValue\u0026#34;, \u0026#34;settingValueTemplateReference\u0026#34;: null, \u0026#34;value\u0026#34;: \u0026#34;$FilePath\u0026#34; } } ] \u0026#34;@ Rule Ending JSON # By this point I\u0026rsquo;m tired of looking at JSON, but we need to close off the rules before we complete the policy JSON as a whole; we have to identify whether the rule being processed is last rule, as the end of the JSON for rules will need to be different, in this case whether a }, or a }, so we can use a quick query as to whether the rule being processed is the last in the array.\nif ($Rule -eq $Rules[-1]) { $JSONRuleEnding = @\u0026#39; } \u0026#39;@ } else { $JSONRuleEnding = @\u0026#39; }, \u0026#39;@ } Submitting EPM Policies # At this point we should have the all the JSON content we need, now is time to combine them all to form the master JSON which can be submitted to Graph API, but we need to firstly combine all the JSON variables, and secondly have a way to pass it to the API.\nFinal Policy JSON # Luckily we can define an array variable $JSONRules which we can add each combined rule to as we loop through each rule in the set.\n$JSONRule = $JSONRuleStart + $JSONRuleElev + $JSONRuleEnd + $JSONRuleEnding $JSONRules += $JSONRule Adding these combined rules to the $JSONPolicyStart and $JSONPolicyEnd variables will give us the required JSON file we can submit to Graph API.\n$JSONOutput = $JSONPolicyStart + $JSONRules + $JSONPolicyEnd Pushing to Graph API # JSON file complete, let\u0026rsquo;s use a function to push the data to Microsoft Intune via Graph API, as I\u0026rsquo;m not hand cranking this for every policy we want to create.\nFunction New-DeviceSettingsCatalog() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $JSON ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceManagement/configurationPolicies\u0026#39; try { Test-Json -Json $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can now pass through the $JSONOutput variable to the above function.\n$EPMPolicy = New-DeviceSettingsCatalog -JSON $JSONOutput With this we now have a method to push new policies, and if required, with multiple rules to Microsoft Intune.\nAssigning EPM Policies # Now we have a way to create new EPM policies and rules, grouping the rules by the assignment group, it would only be right to square this all off by assigning the policy to the same group, outrageous I know. To do this we need another function using the deviceManagement/configurationPolicies/$Id/assign Graph API endpoint to create a new Settings Catalog policy assignment.\nFunction Add-DeviceSettingsCatalogAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$Id, [parameter(Mandatory = $false)] [string]$Name, [parameter(Mandatory = $true)] [string]$TargetGroupId, [parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Include\u0026#39;, \u0026#39;Exclude\u0026#39;)] [string]$AssignmentType ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/configurationPolicies/$Id/assign\u0026#34; try { $TargetGroup = New-Object -TypeName psobject if ($AssignmentType -eq \u0026#39;Exclude\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.exclusionGroupAssignmentTarget\u0026#39; } elseif ($AssignmentType -eq \u0026#39;Include\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; } $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value \u0026#34;$TargetGroupId\u0026#34; $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups = $Target # Creating JSON object to pass to Graph $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;assignments\u0026#39; -Value @($TargetGroups) $JSON = $Output | ConvertTo-Json -Depth 3 # POST to Graph Service $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; Write-Host \u0026#34;Successfully assigned policy $Name\u0026#34; -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } We can finally assign the policy passing through the required information from the $EPMPolicy variable that contains the details of the newly created EPM policy.\nAdd-DeviceSettingsCatalogAssignment -id $EPMPolicy.id -TargetGroupId $Group.id -AssignmentType Include If you\u0026rsquo;re still with me, and you probably are as I haven\u0026rsquo;t posted the full script yet, congratulations, we\u0026rsquo;re almost there.\nEPM Policy Deployment # We\u0026rsquo;re here, finally, with a complete PowerShell Script ready to be used and abused. Let\u0026rsquo;s look at the options we have when running the script.\nReport Mode # Running the script with the below parameters we can export the existing Unmanaged elevations to a location of our choosing that you will be prompted for after running the script.\n./Invoke-EPNRules.ps1 -tenantID \u0026#39;bb690aa6-53c6-4d51-affe-ab80c6d710de\u0026#39; -Deployment Report This CSV file can then updated with the elevation types and groups the rules can be assigned to, as per the example below.\n\u0026#34;ElevationCount\u0026#34;,\u0026#34;Product\u0026#34;,\u0026#34;Description\u0026#34;,\u0026#34;Publisher\u0026#34;,\u0026#34;FileName\u0026#34;,\u0026#34;FilePath\u0026#34;,\u0026#34;FileHash\u0026#34;,\u0026#34;Users\u0026#34;,\u0026#34;Devices\u0026#34;,\u0026#34;ElevationType\u0026#34;,\u0026#34;Group\u0026#34;\r\u0026#34;6\u0026#34;,\u0026#34;Microsoft¬Æ Windows¬Æ Operating System\u0026#34;,\u0026#34;Windows PowerShell\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;powershell.exe\u0026#34;,\u0026#34;C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\u0026#34;,\u0026#34;B4E7BC24BF3F5C3DA2EB6E9EC5EC10F90099DEFA91B820F2F3FC70DD9E4785C4\u0026#34;,\u0026#34;AzureAD\\AlexWilber AzureAD\\ChristieCline\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ DESKTOP-7KFLL12\u0026#34;,\u0026#34;UserJustification\u0026#34;,\u0026#34;sg-IT\u0026#34;\r\u0026#34;4\u0026#34;,\u0026#34;PaladinVPN\u0026#34;,\u0026#34;PaladinVPN\u0026#34;,\u0026#34;Ledger Media Ltd\u0026#34;,\u0026#34;PaladinVPN.exe\u0026#34;,\u0026#34;C:\\\\Program Files (x86)\\\\PaladinVPN\u0026#34;,\u0026#34;B6EF395DE2F28162DBAFCA79BAABEBB211245A68425CE096402030417FEA1160\u0026#34;,\u0026#34;AzureAD\\AlexWilber\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ\u0026#34;,\u0026#34;Automatic\u0026#34;,\u0026#34;sg-Operations\u0026#34;\r\u0026#34;12\u0026#34;,\u0026#34;Microsoft¬Æ Windows¬Æ Operating System\u0026#34;,\u0026#34;Windows Command Processor\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;cmd.exe\u0026#34;,\u0026#34;C:\\\\Windows\\\\system32\u0026#34;,\u0026#34;B99D61D874728EDC0918CA0EB10EAB93D381E7367E377406E65963366C874450\u0026#34;,\u0026#34;AzureAD\\AlexWilber AzureAD\\ChristieCline\u0026#34;,\u0026#34;DESKTOP-DL6CCRJ DESKTOP-7KFLL12\u0026#34;,\u0026#34;UserAuthentication\u0026#34;,\u0026#34;sg-IT\u0026#34; Create Mode # The CSV file can then be used for the creation of rules using the below command (you will be prompted for the path to the CSV file).\n./Invoke-EPNRules.ps1 -tenantID \u0026#39;bb690aa6-53c6-4d51-affe-ab80c6d710de\u0026#39; -Deployment Import Which will result in the EPM policies being created:\nMicrosoft Intune Elevation Policy. Drilling into the EPM policy we can see the rules that were created:\nMicrosoft Intune Elevation Rules. Digging a little further we can see the settings for the rules:\nPowerShell User Approved with Business Justification Microsoft Intune Elevation Rules Detail for Business Justification. Command Prompt User Approved with Authentication Microsoft Intune Elevation Rules Detail for Authentication. Create and Assign Mode # Or if you want to be reckless bold and create and assign the policies, use the below (you will be prompted for the path to the CSV file).\n./Invoke-EPNRules.ps1 -tenantID \u0026#39;bb690aa6-53c6-4d51-affe-ab80c6d710de\u0026#39; -Deployment ImportAssign Which will give us the above policies created, but also assigned to the relevant groups:\nMicrosoft Intune Elevation Rules assignment. Summary # This script doesn\u0026rsquo;t take into consideration the members of the groups as part of the assignment, and subsequently any conflict or crossover of rules on a per user or device basis, but then I can\u0026rsquo;t script every step of logic as part of an Endpoint Privilege Management implementation, you still have to use your brain somewhere along the way.\nWhat it does give you is an ability to readily identify the priority of elevations required by your user base, a way to review the applications actively being elevated, and importantly a way to use this data and information to automatically create Endpoint Privilege Management policies and rules without the risk of human error when creating rules manually.\n","date":"1 June 2023","externalUrl":null,"permalink":"/posts/automate-endpoint-privilege-management/","section":"Posts","summary":"So you‚Äôre interested in Endpoint Privilege Management in Microsoft Intune and in you‚Äôre excitement you‚Äôve gone and deployed a new policy to audit using the Reporting Scope options, all elevations across your managed Windows 10 and later devices. Now what?","title":"Automating Endpoint Privilege Management Policies with PowerShell","type":"posts"},{"content":"","date":"1 June 2023","externalUrl":null,"permalink":"/tags/endpoint-privilege-management/","section":"Tags","summary":"","title":"Endpoint Privilege Management","type":"tags"},{"content":"What happens when a stranger on the Internet asks you to look at something they\u0026rsquo;ve got a problem with? Well clearly you jump at the chance and hope that it\u0026rsquo;s not a body part this time. So here we are, looking at how to deploy Microsoft Teams Backgrounds to macOS devices using Intune, for organisations without the licensing to allow for corporate branding using Microsoft Teams Premium Experience.\nTeams Meeting Backgrounds # So after a quick search, to add new backgrounds for Teams we need to dump files in ~/Library/Application Support/Microsoft/Teams/Backgrounds, this directory will exist under the logged in User context, so we\u0026rsquo;re going to need a way to both create an \u0026lsquo;Uploads\u0026rsquo; directory and dump the background files in there.\nChecking for the Teams App # Before we start throwing files in a directory, we should probably check to see if Teams is actually installed, luckily having spent many evenings peering over the macOS Shell Scripts hosted in Intune Shell Scripts, we can use the Dock Customisation script, as there\u0026rsquo;s a section in there that waits for the detection of apps before allowing the script to continue.\nSo we\u0026rsquo;ll pinch that section and update it so it\u0026rsquo;s only checking for the Microsoft Teams.app\nteamsapp=\u0026#34;/Applications/Microsoft Teams.app\u0026#34; while [[ $ready -ne 1 ]]; do missingappcount=0 if [[ -a \u0026#34;$teamsapp\u0026#34; ]]; then echo \u0026#34;$(date) | $teamsapp is installed\u0026#34; else let missingappcount=$missingappcount+1 fi echo \u0026#34;$(date) | [$missingappcount] application missing\u0026#34; if [[ $missingappcount -eq 0 ]]; then ready=1 echo \u0026#34;$(date) | Teams App found, lets prep the dock\u0026#34; else echo \u0026#34;$(date) | Waiting for 10 seconds\u0026#34; sleep 10 fi done This will sit and wait for Teams to be detected, so make sure you\u0026rsquo;ve either already deployed Teams to your devices and/or have a \u0026lsquo;Required\u0026rsquo; install intent for either Microsoft Teams or Microsoft Office, in Intune.\nGetting the Logged in User # Like the Dock Customisation script, we can run the script from Intune as the signed-in user, and as we\u0026rsquo;re dealing with data in the User context, this makes the most sense. We can capture the signed-in user using the built-in $HOME variable, and creating a new teamsUpload variable to use later.\nteamsUpload=\u0026#34;$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\u0026#34; Checking the Background Directory # Right, that was easier than I thought, we should look at how to check if the directory exists, and if not create it.\nif [[ -d ${teamsUpload} ]] then echo \u0026#34;$(date) | Teams Background Upload dir [$teamsUpload] already exists\u0026#34; else echo \u0026#34;$(date) | Creating [$teamsUpload]\u0026#34; mkdir -p \u0026#34;$teamsUpload\u0026#34; fi Now onto how we get files in the directory, without just copy and pasting.\nYou may have noticed by now that I\u0026rsquo;m not explaining in much depth how the Shell commands work, well that\u0026rsquo;s because I\u0026rsquo;m still on a steep learning curve myself. Bear with me here, it ain\u0026rsquo;t PowerShell is it. Deploying Files with Shell Scripts # I already know there\u0026rsquo;s a working method to deploy a Desktop Background to a macOS device enrolled in Microsoft Intune. So we\u0026rsquo;ll do what any right minded Consultant would do, and steal modify the script to our needs.\nScript Variables # The original script used a single variable wallpaperurl to capture the desktop wallpaper URL, which is nice and all, and obviously fits the Desktop Background purpose, but we\u0026rsquo;d like to give our users options of Teams Backgrounds, so we\u0026rsquo;ll use an array to hold our list of URLs to the background files (see I am learning).\nbackgroundurls=(\u0026#34;https://memv.ennbee.uk/bgr.png\u0026#34; \u0026#34;https://memv.ennbee.uk/wp-lt.png\u0026#34; \u0026#34;https://memv.ennbee.uk/wp.png\u0026#34;) For any additional URLs, you can add a new line to the array.\nThis lack of a $ when configuring new variables is unsettling me if I\u0026rsquo;m honest, but we move. Downloading with Curl # Pretty simple really, even I can use curl to download the background files to the directory location -L, passing in the URL and a filename as part of the output -o option. We\u0026rsquo;ve added the `-s\u0026rsquo; so as to not clog the log file with the raw download data.\ncurl -s -L -o $teamsUpload/$backgroundfile $backgroundurl We now need to loop through each of the items in the backgroundurls array, and we also need to give each a filename for backgroundfile that isn\u0026rsquo;t duplicated, otherwise we\u0026rsquo;ll end up downloading and overwriting the same file for each URL in the array.\nIncremental Filenames # We can quickly create new file names as part of the for loop needed for the items in the array, by incrementing a variable, and appending that variable to the backgroundfile variable.\ni=0 for backgroundurl in \u0026#34;${backgroundurls[@]}\u0026#34;; do ((i=i+1)) backgroundfile=\u0026#34;TeamsBackground$i.png\u0026#34; ... done This will make sure that each downloaded background file gets a new filename, this won\u0026rsquo;t cater for multiple initiations of the script, but remember, I\u0026rsquo;m still new at this.\nTeams Background Script # The full script looks pretty much like the below, which is just a squishing together of the bits we\u0026rsquo;ve already covered in this post.\n#!/bin/bash #set -x ############################################################################################ ## ## Script to download Teams Backgrounds ## ########################################### # Define variables # Add new background URLs to the array backgroundurls=(\u0026#34;https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/Msft_Nostalgia_Landscape.jpg\u0026#34; \u0026#34;https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/SupportUkraine_Heart_TeamsBackground.jpg\u0026#34; \u0026#34;https://raw.githubusercontent.com/ennnbeee/mem-scripts/main/Intune/Scripts/Shell/TeamsBackgrounds/covermichael.jpg\u0026#34;) scriptname=\u0026#34;SetTeamsBackground\u0026#34; teamsapp=\u0026#34;/Applications/Microsoft Teams.app\u0026#34; logandmetadir=\u0026#34;$HOME/Library/Logs/Microsoft/Intune/Scripts/$scriptname\u0026#34; log=\u0026#34;$logandmetadir/$scriptname.log\u0026#34; teamsUpload=\u0026#34;$HOME/Library/Application Support/Microsoft/Teams/Backgrounds/Uploads\u0026#34; ## Check if the log directory has been created if [ -d $logandmetadir ]; then ## Already created echo \u0026#34;# $(date) | Log directory already exists - $logandmetadir\u0026#34; else ## Creating Metadirectory echo \u0026#34;# $(date) | creating log directory - $logandmetadir\u0026#34; mkdir -p \u0026#34;$logandmetadir\u0026#34; fi # start logging exec 1\u0026gt;\u0026gt;\u0026#34;$log\u0026#34; 2\u0026gt;\u0026amp;1 echo \u0026#34;\u0026#34; echo \u0026#34;##############################################################\u0026#34; echo \u0026#34;# $(date) | Starting download of Teams Backgrounds\u0026#34; echo \u0026#34;############################################################\u0026#34; echo \u0026#34;\u0026#34; ## ## Checking if Teams is Installed ## while [[ $ready -ne 1 ]]; do missingappcount=0 if [[ -e \u0026#34;$teamsapp\u0026#34; ]]; then echo \u0026#34;$(date) | $teamsapp is installed\u0026#34; else let missingappcount=$missingappcount+1 fi echo \u0026#34;$(date) | [$missingappcount] application missing\u0026#34; if [[ $missingappcount -eq 0 ]]; then ready=1 echo \u0026#34;$(date) | Teams App found, lets download the backgrounds\u0026#34; else echo \u0026#34;$(date) | Waiting for 10 seconds\u0026#34; sleep 10 fi done ## ## Checking if Teams Backgrounds Upload directory exists and create it if it\u0026#39;s missing ## if [[ -d ${teamsUpload} ]]; then echo \u0026#34;$(date) | Teams Background Upload dir [$teamsUpload] already exists\u0026#34; else echo \u0026#34;$(date) | Creating [$teamsUpload]\u0026#34; mkdir -p \u0026#34;$teamsUpload\u0026#34; fi ## ## Attempt to download the files. No point checking if it already exists since we want to overwrite it anyway ## i=0 for backgroundurl in \u0026#34;${backgroundurls[@]}\u0026#34;; do ((i = i + 1)) backgroundfile=\u0026#34;TeamsBackground$i.png\u0026#34; echo \u0026#34;$(date) | Downloading Background from [$backgroundurl] to [$teamsUpload/$backgroundfile]\u0026#34; curl -L -o \u0026#34;$teamsUpload/$backgroundfile\u0026#34; $backgroundurl if [ \u0026#34;$?\u0026#34; = \u0026#34;0\u0026#34; ]; then echo \u0026#34;$(date) | Teams Background [$backgroundurl] downloaded to [$teamsUpload/$backgroundfile]\u0026#34; else echo \u0026#34;$(date) | Failed to download Teams Background image from [$backgroundurl]\u0026#34; fi done Time to add this into Intune and reap the rewards.\nIntune Shell Scripts # As with everything Microsoft, there are some requirements and limitations with using Shell Scripts for macOS so have a read before you blindly start trying to push out scripts to your device estate. After you\u0026rsquo;ve read these requirements, create a new Shell Script with the below settings.\nSetting Value Shell script downloadTeamsBackground.sh File contents Uploaded Script Run script as signed-in user Yes Hide script notifications on devices Not Configured Script frequency Not Configured Max number of times to retry if script fails 3 times Looking a little like the below.\nmacOS Shell Script in Microsoft Intune. Now we\u0026rsquo;ve added the Shell Script, this can be deployed to the \u0026lsquo;All Users\u0026rsquo;, \u0026lsquo;All Devices\u0026rsquo; groups (Don\u0026rsquo;t do this as we don\u0026rsquo;t have Device Filters to use) or Groups of your choosing.\nChecking Microsoft Teams # With the Script deployed from Intune and assigned to a group of devices, we can check on the devices themselves to make sure that the script has run successfully using the log file, checking that the new backgrounds have downloaded to the correct directory, and that these backgrounds appear in Microsoft Teams.\nScript Logging # As per the configured variable in the script, we can find the log $HOME/Library/Logs/Microsoft/Intune/Scripts/SetTeamsBackground/SetTeamsBackground.log, opening it we can check on the status of the downloads.\nmacOS Shell Script logging on a targeted device. Everything looks solid we should check the download directory.\nBackground Directory # As we can see three files in the Uploads directory, all named appropriately.\nTeams background folder and contents on a targeted device. Teams Background Effects # Last check is in a Microsoft Teams meeting.\nTeams backgrounds within a Teams meeting. All good here as well, we can relax and have a coffee.\nIf Microsoft Teams was open when the backgrounds were deployed, it will need a restart to pick up the new backgrounds. I did think about force quitting the app, but didn\u0026rsquo;t think users would appreciate that. Summary # This was a pretty straight forward method to deploy backgrounds to Microsoft Teams using Intune Shell Scripts, and not a bad start to my journey into advanced management of macOS devices (despite actually being a macOS user). I\u0026rsquo;d recommend familiarising yourself with the Intune Shell Samples, as this is where started when hacking about with Shell scripts for macOS devices.\nOr you could just pay for Microsoft Teams Premium, but where\u0026rsquo;s the fun in that?\n","date":"14 March 2023","externalUrl":null,"permalink":"/posts/macos-teams-backgrounds/","section":"Posts","summary":"What happens when a stranger on the Internet asks you to look at something they\u0026rsquo;ve got a problem with? Here we are, looking at how to deploy Microsoft Teams Backgrounds to macOS devices.","title":"Deploying Teams Backgrounds to macOS Devices","type":"posts"},{"content":"As both Microsoft Intune and Configuration Manager are a match made in heaven, there are many reasons to still utilise both, either using Co-Management or just plain old Tenant Attach, so imagine my joy when Microsoft released Co-Management Authority in Intune, and I thought the days of packaging the Configuration Manager Client were over.\nNow imagine my face when I read the requirements and the fact it doesn\u0026rsquo;t support Autopilot Hybrid Join scenarios.\nI get it, installing the client during Autopilot will pretty much break the deployment, but there should be a way to install the client and not have it bend over and only accept Configuration Manager deployed workloads.\nPackaging the Configuration Manager Client has been covered, many, many, many, many times, almost to death in fact, so I\u0026rsquo;m not going to show you how to package the client files, what I am going to show you is a couple of tricks to make the installation easier, and not break Autopilot.\nApp Requirement Rules # To stop the application from running during the Autopilot process, we can add in a Requirement Rule to ensure that we\u0026rsquo;re not in the Out of Box Experience (OOBE). We\u0026rsquo;ve got a couple of options here, whether it\u0026rsquo;s detecting if the CloudExperienceHostBroker Service is running, or if the User account context is running under defaultUser0.\nI\u0026rsquo;ve gone with the Service approach, as it saves Intune having to run Get-ComputerInfo -Property CsUserName every time it wants to check if the requirement has been met.\nWith this, we can create a Requirement Rule Script using the below to check if the CloudExperienceHostBroker service is running, and if not returning Install:\n$ESPProcess = Get-Process -Name CloudExperienceHostBroker -ErrorAction SilentlyContinue if ($ESPProcess.Count -eq 0) { Return \u0026#39;Install\u0026#39; } Pretty straight forward for one of my documented scripts, but either way, save the file locally as something you can remember.\nCreate the rule in Intune with the below settings:\nItem Value Requirement Type Script Script Name Autopilot_Not_Running.ps1 Script content {{Script Content}} Run script as 32-bit process on 64-bit clients No Run this script using the logged on credentials No Enforce script signature check No Select Output data type String Operator Equals Value Install Giving us something like this:\nMicrosoft Intune application requirement rule. This will now stop the installation from even starting during Autopilot phase, and only start the installation once the requirement has been met.\nApp Detection Methods # Now that we can control when the Client is installed, we need a way to detect that it has installed, and to be honest, we don\u0026rsquo;t actually care if the Client itself has installed correctly, as the Client setup will just sit and try to install itself every ten minutes until it can.\nIf we had a detection rule for either the MSI product code, or a File check for the client itself, we\u0026rsquo;d be waiting for an absolute age for Intune to be happy and confirm the installation state. We do not want this.\nWhat we do want, is a quick and easy way to ensure that the setup files exist on the device, then we can let the ccmsetup.exe do it\u0026rsquo;s magical thing and install the Client and the associated service.\nSo for the detection rule, we\u0026rsquo;ll just look for the presence of the setup file:\nItem Value Rule Type File Path %windir%\\ccmsetup File or Folder ccmsetup.exe Detection Method File or Folder Exists Associated with a 32-bit app on 64-bit client No This looks a little bit like the below:\nMicrosoft Intune application detection method. Allowing for a quick and easy detection of the required setup files on the device.\nIntune Only Mode # If you\u0026rsquo;re wanting Intune to manage all the workloads on the device, and not rely on Co-Managed Workloads at all, there is a solution for this, and one taken straight from Microsoft and their implementation of the Co-Management Authority in Intune.\nYour endpoints enrolled in Intune today have a concept of management authority. That authority tells the device what service owns the management of the workloads on that device. The authority owner can be tracked by a simple registry key and value. This is the value that they\u0026rsquo;re on about:\nHKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server When provisioning a device with Autopilot, the above key gets created right after you enter your username and password on the enrolment screen. This key tells the device who the authority is for workload management* Here\u0026rsquo;s the legend for the key:\n1 ‚Äì Intune 2 ‚Äì Configuration Manager Right, so if we really wanted to stick with Intune as the management authority here, we can leverage the above information and force the device to stick with Intune for it\u0026rsquo;s management needs, and in the case of App deployment, the device will still receive Apps from both Intune and Configuration Manger if the key value is set to Intune.\nProactive Remediation # As I\u0026rsquo;ve mentioned previously if you\u0026rsquo;re licensed to use Proactive Remediation Scripts, you should be using them, and in anger. We can throw together a script that looks for the registry key HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\\ConfigInfo, create it if it doesn\u0026rsquo;t exist, and set it to 1 telling the device to only deal with Intune.\nDetection Script # As with all Proactive Remediation scripts, we need a method to detect, which is run initially upon assessment, and subsequently after remediation. A standard check, fix, check situation. For the detection method, we\u0026rsquo;re looking for both the Registry Key and the item.\nTry { $Registry = \u0026#39;HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\u0026#39; $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $False) { Write-Warning \u0026#39;Co-Management Authority Not Confgured\u0026#39; Exit 1 } else { if ($Authority -ne \u0026#39;1\u0026#39;) { Write-Warning \u0026#39;Co-Management Authority set to Configuration Manager\u0026#39; Exit 1 } else { Write-Output \u0026#39;Co-Management Authority set to Intune\u0026#39; Exit 0 } } } Catch { Write-Error $_.Exception Exit 2000 } Remediation Script # If either the Key or the Data are not detected, we have a Remediation script that configures either the Key and the Data, or just the Data.\nTry { $Registry = \u0026#39;HKLM:\\SOFTWARE\\Microsoft\\DeviceManageabilityCSP\\Provider\\MS DM Server\u0026#39; $Path = Test-Path $Registry $Authority = Get-ItemPropertyValue -Path $Registry -Name ConfigInfo -ErrorAction SilentlyContinue if ($Path -eq $false) { New-Item -Path $Registry -Force | Out-Null New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } else { if ($Authority -ne \u0026#39;1\u0026#39;) { New-ItemProperty -Path $Registry -Name ConfigInfo -Value 1 -PropertyType String -Force } } } Catch { Write-Error $_.Exception Exit 2000 } Creating a Custom Script # With the above PowerShell scripts saved, we can now create our own Proactive Remediation Script and deploy this to the devices we only want to be managed by Intune, in this case, the Hybrid Joined Autopilot devices:\nMicrosoft Intune remediation script. Make sure you\u0026rsquo;re using 64-bit PowerShell for this script, as we don\u0026rsquo;t want anything screwy going on with the registry settings.\nSummary # We\u0026rsquo;ve managed to delay the installation of the Configuration Manager Client, as well as ensure it\u0026rsquo;s detected quickly once installed, and once it does install and the Client starts looking at Configuration Manager for it\u0026rsquo;s Co-Management settings, we\u0026rsquo;ve even got a way to tell Configuration Manager to look the other way and not break Autopilot whilst letting Intune do its thing.\nAll in all, although not a Microsoft supported method for deploying the Client, it is one that works. As you\u0026rsquo;ve realised by now, I\u0026rsquo;m not about documented good practice.\n","date":"1 March 2023","externalUrl":null,"permalink":"/posts/configmgr-client-hybrid-autopilot/","section":"Posts","summary":"Installing the Configuration Manager client on Hybrid Azure AD Joined Autopilot devices should be an easy process right?","title":"Co-Managing Windows Autopilot Hybrid Join Devices","type":"posts"},{"content":"","date":"1 March 2023","externalUrl":null,"permalink":"/tags/hybrid-join/","section":"Tags","summary":"","title":"Hybrid Entra Join","type":"tags"},{"content":"","date":"13 February 2023","externalUrl":null,"permalink":"/tags/administration/","section":"Tags","summary":"","title":"Administration","type":"tags"},{"content":"No one, and I mean no one, really wants to manually and individually assign Mobile Apps to Users or Devices in Intune, especially after you\u0026rsquo;ve happily used a script to Approve Managed Google Play Apps in their 100\u0026rsquo;s as part of migrating to Microsoft Intune from other below par Mobile Device Management solutions.\nWe could try and use Policy Sets here, but you know, they\u0026rsquo;re in preview, and more importantly they have issues like not supporting Managed Google Play or Apple VPP apps, so that\u0026rsquo;s a no go.\nSo here we are again, throwing together functions, logic, and some kind of user interface, to allow us to assign these mobile apps in bulk with minimal headache and increase to any pre-existing repetitive strain injuries.\nThe functions, authentication, and script have now been updated to support the use of the Graph PowerShell SDK. Mobile App Assignment # First off, before we even start looking at how we bring this all together, is to understand how we can assign an App using Graph. So as we\u0026rsquo;ve done before, we could look under the hood and check the Browser Developer Tools to see what is actually going on, or we can just check the Graph documentation.\nWith this we now know that to use the POST /deviceAppManagement/mobileApps/{mobileAppId}/assign call, we\u0026rsquo;ll need the {mobileAppId}, we\u0026rsquo;re in luck, as we\u0026rsquo;ve already got a function Get-MobileApps to do this for us.\nAssignment Types # Knowing the call to Graph is the easy bit, building the JSON data we\u0026rsquo;re sending to it using the POST request is a different story, but at least we\u0026rsquo;ve got a framework to start us off, thanks Microsoft.\n{ \u0026#34;mobileAppAssignments\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.mobileAppAssignment\u0026#34;, \u0026#34;id\u0026#34;: \u0026#34;591620b7-20b7-5916-b720-1659b7201659\u0026#34;, \u0026#34;intent\u0026#34;: \u0026#34;required\u0026#34;, \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;microsoft.graph.deviceAndAppManagementAssignmentTarget\u0026#34; }, \u0026#34;settings\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;microsoft.graph.mobileAppAssignmentSettings\u0026#34; } } ] } We\u0026rsquo;ve built JSON data in PowerShell before, so this one isn\u0026rsquo;t any different, we do however need to cater for Installation Intents, Assignment Groups, Device Filters, and Device Filter States. These can be broken down as below, with the ones we actually care about in bold.\nItem Details Installation Intents Required, Available for Enrolled Devices, Available for Un-enrolled Devices, Uninstall Assignment Groups All Users, All Devices, Groups Filters States Include, Exclude We need to allow for the ability to assign Mobile Apps to all permutations of the above, whether this is a Required installation to All Devices, including a Device Filter, or an Available installation to a Group of Users. You get the picture.\nApp Assignment JSON # We can now start to build the JSON data we can POST to Graph, but we do need a bit more information when it comes to the content of the JSON data, in particular what is acceptable in the microsoft.graph.deviceAndAppManagementAssignmentTarget as well as how we pass through a Device Filter as part of the assignment, what headings are needed depending on the Assignment Target as well as the Install Intent.\nThe below structure details the setup for the JSON:\nmobileAppAssignments odata.type #microsoft.graph.mobileAppAssignment: This will be the same for each request intent required: Requiring the App to be installed available: Making the App available to be installed uninstall: Uninstalling the App target odata.type #microsoft.graph.groupAssignmentTarget: Assigns the App the a Group groupId: If using the group assignment, the Id of the Group #microsoft.graph.allLicensedUsersAssignmentTarget: Assigns the App the inbuilt All Users Group #microsoft.graph.allDevicesAssignmentTarget: Assigns the App the inbuilt All Devices Group deviceAndAppManagementAssignmentFilterId id: Device Filter Id deviceAndAppManagementAssignmentFilterType include: Includes the devices in the filter exclude: Excludes the devices in the filter We need to build separate objects in PowerShell to complete the JSON hierarchy, and we can happily do this using PowerShell using something like the below:\nBuilding the PSObject for odata.type and intent, with the App to be an Available Installation Intent:\n$Target = New-Object -TypeName PSObject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.mobileAppAssignment\u0026#39; $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;intent\u0026#39; -Value \u0026#39;available If we\u0026rsquo;re going for a Group based assignment including a Device Filter, we can build this and add to the existing $Target object using:\n$TargetGroup = New-Object -TypeName PSObject $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value \u0026#39;{Group.Id}\u0026#39; $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value \u0026#39;{FilterId}\u0026#39; $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value \u0026#39;include\u0026#39; $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup Then the final PSObject for mobileAppAssignments, adding everything together, and converting it to JSON:\n$Output = New-Object -TypeName PSObject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;mobileAppAssignments\u0026#39; -Value @($Target) $JSON = $Output | ConvertTo-Json -Depth 3 Giving us the below output:\n{ \u0026#34;mobileAppAssignments\u0026#34;: [ { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.mobileAppAssignment\u0026#34;, \u0026#34;intent\u0026#34;: \u0026#34;available\u0026#34;, \u0026#34;target\u0026#34;: { \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.groupAssignmentTarget\u0026#34;, \u0026#34;groupId\u0026#34;: \u0026#34;{Group.Id}\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterId\u0026#34;: \u0026#34;{FilterId}\u0026#34;, \u0026#34;deviceAndAppManagementAssignmentFilterType\u0026#34;: \u0026#34;include\u0026#34; } } ] } This looks miraculously like the Microsoft example, but you know, same same but different. If it actually had the correct {FilterId} and {GroupId} in place, it would allow us to assign an App when pushed to Graph.\nWe\u0026rsquo;re getting there, bear with me, I thought this post would be shorter.\nFunction Building Blocks # There are a few components we need to put together in the form of functions to enable the assignment of Mobile Apps, if we\u0026rsquo;re being complete about this, and for once we are (ish), we need to consider the following:\nGetting Mobile Apps Getting Device Filters Getting Groups Getting existing Assignments Dealing with existing Assignments All of the above will alter the way we deal with the JSON data we are creating, so one for future me to deal with. For now, on to the functions.\nRemember we\u0026rsquo;ll need to authenticate to Graph using Connect-MgGraph for all of these.\nGetting Mobile Apps # This one has come straight from an existing script, but we\u0026rsquo;ll need to filter the data gathered, otherwise we\u0026rsquo;re dragging back every Mobile App, including those referenced in App Protection Policies, and we don\u0026rsquo;t want to do anything with those today.\nFunction Get-MobileApps() { [cmdletbinding()] $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceAppManagement/mobileApps\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Getting Device Filters # To fix our missing {FilterId} issue, we need to be able to capture this data. This is a quick one, as we just need a call to GET deviceManagement/assignmentFilters resource, once we\u0026rsquo;ve authenticated to Graph of course.\nFunction Get-DeviceFilter() { $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;deviceManagement/assignmentFilters\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } This function will pull back all Device Filters in the Intune tenant, so we might need to filter this down later on.\nGetting Groups # Ah yes, Groups, I\u0026rsquo;d almost forgotten about these, but Dynamic Groups still have a place in Intune, and we need the {GroupId} to make this work, so we should find a way to grab these as well. As with the Device Filters, this is a call to Graph, but using the GET groups resource to capture the group id we need.\nIt was supposed to be so easy, however as we need to limit the number of Groups being pulled back, we need a way to search for a Group name. Here comes the Search Query Parameter, and importantly the need for ConsistencyLevel in the headers in the connection Invoke-MgGraphRequest -Headers @{ConsistencyLevel = 'eventual' }.\nName Value ---- ----- Content-Type application/json ConsistencyLevel eventual ExpiresOn 09/02/2023 11:49:47 +00:00 Authorization Bearer eyJ0eXAiOiJKV1QiLCJub25jZSI6ImFVUTNp... So eventually we have the Get-MDMGroup function, which will require a $GroupName parameter to search for the Groups to retrieve.\nFunction Get-MDMGroup() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [string]$GroupName ) $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#39;groups\u0026#39; try { $authToken[\u0026#39;ConsistencyLevel\u0026#39;] = \u0026#39;eventual\u0026#39; $searchterm = \u0026#39;search=\u0026#34;displayName:\u0026#39; + $GroupName + \u0026#39;\u0026#34;\u0026#39; $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource`?$searchterm\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Honestly, after that I wish I\u0026rsquo;d excluded Group based assignments, and we should have used one of the many PowerShell modules to pull back groups, but I like Graph, I like a consistent approach, and I\u0026rsquo;m using PowerShell Core 7.\nGetting Existing Assignments # We could be brutal with this script, and strip out the existing App assignments when assigning new ones, which is the default behaviour with POST, but I\u0026rsquo;m pretty sure that would make for some unhappy users. I couldn\u0026rsquo;t see a PATCH option for assignments, so we are going to have to write something ourselves to sort this at some point.\nHere is the function we can use to pull back the existing assignment data, I honestly can\u0026rsquo;t remember why I\u0026rsquo;ve done it this way, I think it was due to the lovely format in which the assignments were displayed, but here we only need an App $Id to make this one work.\nFunction Get-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/?`$expand=categories,assignments\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get) } catch { Write-Error $Error[0].ErrorDetails.Message break } } Removing Existing Assignments # Even if we\u0026rsquo;re not accidentally removing existing assignments, we should give ourselves the option to undo any mistakes that we make when assigning Mobile Apps, so a quick tour of Graph gives us the DELETE mobileAppAssignment resource, and with a couple of parameters needed for both the App $Id and the Assignment $AssignmentId, we\u0026rsquo;ve got ourselves a function to get us out of trouble if we need it.\nFunction Remove-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] $Id, [parameter(Mandatory = $true)] $AssignmentId ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/assignments/$AssignmentId\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Delete) } catch { Write-Error $Error[0].ErrorDetails.Message break } } App Assignment Function # Finally we have all the parts to build the function, using the parameters below we can pass through the information needed to build the JSON data, pass through options as to whether we\u0026rsquo;re adding or replacing the assignment, and using some level of logic make sure we\u0026rsquo;re not messing this data up along the way.\nParameters # I\u0026rsquo;ve niced myself here and given options for the application of the function, covering all our requirements for assignment. A break down of the parameters can be found below:\nParameter Description Required Data Id The Id of the Mobile App, obtained via Get-MobileApps True String TargetGroupId The Id of a Group if assigning to a Group obtained via Get-MDMGroup False String InstallIntent Whether the Assignment is set as Available or Required True Available/Required FilterID The ID of a Device Filter if assigning using Device Filters obtained via Get-DeviceFilter False String FilterMode The Filter mode if assigning using Device Filters False Include/Exclude All Used if assigning to the in-built \u0026lsquo;All Users\u0026rsquo; or \u0026lsquo;All Devices\u0026rsquo; groups False Devices/Users Action Whether to Add to existing Assignments, or to Replace them True Add/Replace Add Application Assignment # Here is the function in all it\u0026rsquo;s janky glory, ready to be used and abused by whatever I call PowerShell and acceptable user interfaces. We\u0026rsquo;ve got the ability to capture existing assignments, as well as logic on duplicate assignment methods, and of course adding new ones to the Mobile App in question.\nFunction Add-ApplicationAssignment() { [cmdletbinding()] param ( [parameter(Mandatory = $true)] [ValidateNotNullOrEmpty()] $Id, [parameter(Mandatory = $false)] [ValidateNotNullOrEmpty()] $TargetGroupId, [parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Available\u0026#39;, \u0026#39;Required\u0026#39;)] [ValidateNotNullOrEmpty()] $InstallIntent, $FilterID, [ValidateSet(\u0026#39;Include\u0026#39;, \u0026#39;Exclude\u0026#39;)] $FilterMode, [parameter(Mandatory = $false)] [ValidateSet(\u0026#39;Users\u0026#39;, \u0026#39;Devices\u0026#39;)] [ValidateNotNullOrEmpty()] $All, [parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Replace\u0026#39;, \u0026#39;Add\u0026#39;)] $Action ) $graphApiVersion = \u0026#39;beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/assign\u0026#34; try { $TargetGroups = @() If ($Action -eq \u0026#39;Add\u0026#39;) { # Checking if there are Assignments already configured $Assignments = (Get-ApplicationAssignment -Id $Id).assignments if (@($Assignments).count -ge 1) { foreach ($Assignment in $Assignments) { If (($null -ne $TargetGroupId) -and ($TargetGroupId -eq $Assignment.target.groupId)) { Write-Host \u0026#39;The App is already assigned to the Group\u0026#39; -ForegroundColor Yellow } ElseIf (($All -eq \u0026#39;Devices\u0026#39;) -and ($Assignment.target.\u0026#39;@odata.type\u0026#39; -eq \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;)) { Write-Host \u0026#39;The App is already assigned to the All Devices Group\u0026#39; -ForegroundColor Yellow } ElseIf (($All -eq \u0026#39;Users\u0026#39;) -and ($Assignment.target.\u0026#39;@odata.type\u0026#39; -eq \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;)) { Write-Host \u0026#39;The App is already assigned to the All Users Group\u0026#39; -ForegroundColor Yellow } Else { $TargetGroup = New-Object -TypeName psobject if (($Assignment.target).\u0026#39;@odata.type\u0026#39; -eq \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value $Assignment.target.groupId } elseif (($Assignment.target).\u0026#39;@odata.type\u0026#39; -eq \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39; } elseif (($Assignment.target).\u0026#39;@odata.type\u0026#39; -eq \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39; } if ($Assignment.target.deviceAndAppManagementAssignmentFilterType -ne \u0026#39;none\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterId $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $Assignment.target.deviceAndAppManagementAssignmentFilterType } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.mobileAppAssignment\u0026#39; $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;intent\u0026#39; -Value $Assignment.intent $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups += $Target } } } } $Target = New-Object -TypeName psobject $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.mobileAppAssignment\u0026#39; $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;intent\u0026#39; -Value $InstallIntent $TargetGroup = New-Object -TypeName psobject if ($TargetGroupId) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.groupAssignmentTarget\u0026#39; $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;groupId\u0026#39; -Value $TargetGroupId } else { if ($All -eq \u0026#39;Users\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allLicensedUsersAssignmentTarget\u0026#39; } ElseIf ($All -eq \u0026#39;Devices\u0026#39;) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.allDevicesAssignmentTarget\u0026#39; } } if ($FilterMode) { $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterId\u0026#39; -Value $FilterID $TargetGroup | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceAndAppManagementAssignmentFilterType\u0026#39; -Value $FilterMode } $Target | Add-Member -MemberType NoteProperty -Name \u0026#39;target\u0026#39; -Value $TargetGroup $TargetGroups += $Target $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;mobileAppAssignments\u0026#39; -Value @($TargetGroups) $JSON = $Output | ConvertTo-Json -Depth 3 $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } I can\u0026rsquo;t say I\u0026rsquo;m proud of this function, but it does cater for whatever I\u0026rsquo;ve thrown at it.\nFunction Actions # Running this function allows us to finally assign a Mobile App, I\u0026rsquo;m starting to think I could have just manually assigned the Apps at this point, but I\u0026rsquo;m confident I\u0026rsquo;ll have to use this script again and again in the future.\nReplacing Assignment for an App, with the intent as Required to the \u0026lsquo;All Devices\u0026rsquo; group, with an include Device Filter : Add-ApplicationAssignment -Id {AppId} -InstallIntent Required -All All Devices -FilterMode Include -FilterID {FilterId} -Action Replace Adding an Assignment for an App, with an intent as Available to a Group with no Device Filter would looks something like this: Add-ApplicationAssignment -Id {AppId} -InstallIntent Available -TargetGroupId {Group.Id} -Action Add Adding an Assignment for an App, with the intent as Required to a Group with an exclude Device Filter would looks something like this: Add-ApplicationAssignment -Id {AppId} -InstallIntent Available -TargetGroupId {Group.Id} -FilterMode Exclude -FilterID {FilterId} -Action Add I think we\u0026rsquo;re done here.\nRunning, Assigning and Hiding # I\u0026rsquo;ve included a whole lot of logic and user interface when it comes to this script, and as most of my time has been spent battling with existing assignments, new functions and the headache that is building JSON data from the existing assignment content, I\u0026rsquo;m not going to go into any detail about this part of the script but you can as always find it in GitHub if you want to have a gander at what consists as good practice in my mind.\nThe Payoff # It\u0026rsquo;s got to the point now where I honestly couldn\u0026rsquo;t be bothered to take screenshots of the script in action, plus it would make this already lengthy post even longer, so through the wonder that is screen recording and YouTube you can see the script in action demonstrating the following:\nAdding new Assignments for multiple Apps, with install intent as Required to the All Devices group with a Device Filter Adding new Assignments for multiple Apps, with install intent as Available to a Group with a Device Filter Replacing Assignments for multiple Apps, with install intent as Available to the All Users group with a Device Filter Removing all Assignments for multiple Apps Adding new Assignments for multiple Apps, with install intent as Required to the All Devices group with a Device Filter Adding Assignments for multiple Apps, with install intent as Available to the All Users group with a Device Filter I haven\u0026rsquo;t recorded every possible option, as I have coffee to drink and other awful PowerShell to write, but you get the gist.\nSummary # This felt like a long journey, even with some of the existing foundation functions already at our fingertips, but a worthy one as I\u0026rsquo;m never going to have to individually assign loads of Mobile Apps again, and thanks to this effort, nor do you.\nAs much as there is some intelligence to the script you will still have to use your own knowledge of Intune for when is best to use Devices, Users and Groups, but we can\u0026rsquo;t solve all our problems with PowerShell, trust me, I\u0026rsquo;m trying. The script however does give you an easy way to bulk assign Mobile Apps in Intune, fully strip out assignments, or even just make every Mobile App available to everyone all at once, without too much clicking about.\nThere is definitely room for improvement and expansion, and at some point I\u0026rsquo;ll extend this to cover the assignment of Windows and macOS Apps; but for now you\u0026rsquo;ll have to make do with Android and iOS.\nAs always, please test this one before going large and selecting all your Mobile Apps, I\u0026rsquo;ve included warning break points for a reason.\n","date":"13 February 2023","externalUrl":null,"permalink":"/posts/assigning-intune-applications/","section":"Posts","summary":"No one, and I mean no one, really wants to manually and individually assign Mobile Apps to Users or Devices in Intune in their 100\u0026rsquo;s, so we should find a solution for this bulk assignment approach.","title":"Assigning Intune Mobile Apps Quickly and Consistently","type":"posts"},{"content":"I\u0026rsquo;m not going to go over old ground in too much detail, as I\u0026rsquo;ve already covered the importance of keeping your Operating System Compliance Policies up to date in line with the release of new updates, as well as a way to update your compliance policies using Graph and PowerShell.\nWhat I am going to do is extend this automated Compliance Policy update functionality to Apple Updates as well, it\u0026rsquo;s like I\u0026rsquo;ve been working with a customer that only has iOS/iPadOS devices in Intune or something.\nI guess when I end up working with a customer with only Android devices, that I\u0026rsquo;ll finally be able to put all the pieces together and have one script to update them all.\nOperating System Build Versions # Unlike the Windows Valid Operating System Builds option in Compliance Policies, Apple policies don\u0026rsquo;t give you the option of having a set of versions to work with, limited to only the following settings:\nMinimum OS version Maximum OS version Minimum OS build version Maximum OS build version With Apple having different build versions per Operating System, whether this is iOS/iPadOS or macOS, we\u0026rsquo;re unable to have one Compliance Policy that covers all the supported OS versions, and need to have specific policies per supported Operating System.\nDevice Filters # Now we all know where I stand on Device Filters and they come to the rescue once again, as we need separate Compliance Policies and the ability to target these to the correct devices.\nWe can create filters for each of the current supported (at time of writing) iOS/iPadOS and macOS operating systems:\nDescription OS Filter Rule All Corporate iOS 15 devices iOS (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;) and (device.osVersion -startsWith \u0026quot;15\u0026quot;) All Corporate iOS 16 devices iOS (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;) and (device.osVersion -startsWith \u0026quot;16\u0026quot;) All Corporate Big Sur devices macOS (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;) and (device.osVersion -startsWith \u0026quot;11\u0026quot;) All Corporate Monterey devices macOS (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;) and (device.osVersion -startsWith \u0026quot;12\u0026quot;) All Corporate Ventura devices macOS (device.deviceOwnership -eq \u0026quot;Corporate\u0026quot;) and (device.osVersion -startsWith \u0026quot;13\u0026quot;) Using these we can now create a Compliance Policy for each Operating System version, assigning it to the All Devices or All Users groups and include the corresponding Device Filter.\nCompliance Policies # You\u0026rsquo;ve probably created Compliance Policies before, and if you haven\u0026rsquo;t there are only a few clicks needed to configure one in preparation for the Operating System compliance check.\nAs the Apple build versions are unique, we don\u0026rsquo;t need to add in the settings Minimum OS version and Maximum OS version, though they are both a useful visual aide, and I could do with referencing them when I come to write a script to update the Compliance Policy.\nSo go ahead and create your Compliance Policies for each supported Operating System version, assigning them to the required group and filter:\nOS Version Minimum OS version iOS iOS 15 15.0.0 iOS iOS 16 16.0.0 macOS Big Sur 11.0.0 macOS Monterey 12.0.0 macOS Ventura 13.0.0 With both the Compliance Policies and the Device Filters in place, now we can move onto how we update the Build Versions.\nUpdates and RSS Feeds # As with the Windows Updates, Apple make their updates available in an easy to digest RSS feed which should make scraping back the information we need pretty straight forward:\n\u0026lt;item\u0026gt; \u0026lt;title\u0026gt;iOS 16.3 (20D47)\u0026lt;/title\u0026gt; \u0026lt;link\u0026gt;https://developer.apple.com/news/releases/?id=01232023f\u0026lt;/link\u0026gt; \u0026lt;guid\u0026gt;https://developer.apple.com/news/releases/?id=01232023f\u0026lt;/guid\u0026gt; \u0026lt;description\u0026gt;View downloadsView release notes\u0026lt;/description\u0026gt; \u0026lt;pubDate\u0026gt;Mon, 23 Jan 2023 09:00:00 PST\u0026lt;/pubDate\u0026gt; \u0026lt;content:encoded\u0026gt;\u0026lt;![CDATA[\u0026lt;p\u0026gt;\u0026lt;a href=/download class=more\u0026gt;View downloads\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;il\u0026gt;\u0026lt;p\u0026gt;\u0026lt;a href=/go/?id=ios-16.3-rn class=more\u0026gt;View release notes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/il\u0026gt;]]\u0026gt;\u0026lt;/content:encoded\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;title\u0026gt;iPadOS 16.3 (20D47)\u0026lt;/title\u0026gt; \u0026lt;link\u0026gt;https://developer.apple.com/news/releases/?id=01232023e\u0026lt;/link\u0026gt; \u0026lt;guid\u0026gt;https://developer.apple.com/news/releases/?id=01232023e\u0026lt;/guid\u0026gt; \u0026lt;description\u0026gt;View downloadsView release notes\u0026lt;/description\u0026gt; \u0026lt;pubDate\u0026gt;Mon, 23 Jan 2023 09:00:00 PST\u0026lt;/pubDate\u0026gt; \u0026lt;content:encoded\u0026gt;\u0026lt;![CDATA[\u0026lt;p\u0026gt;\u0026lt;a href=/download class=more\u0026gt;View downloads\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;il\u0026gt;\u0026lt;p\u0026gt;\u0026lt;a href=/go/?id=iPadOS-16.3-rn class=more\u0026gt;View release notes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/il\u0026gt;]]\u0026gt;\u0026lt;/content:encoded\u0026gt; \u0026lt;/item\u0026gt; \u0026lt;item\u0026gt; \u0026lt;title\u0026gt;macOS 13.2 (22D49)\u0026lt;/title\u0026gt; \u0026lt;link\u0026gt;https://developer.apple.com/news/releases/?id=01232023d\u0026lt;/link\u0026gt; \u0026lt;guid\u0026gt;https://developer.apple.com/news/releases/?id=01232023d\u0026lt;/guid\u0026gt; \u0026lt;description\u0026gt;View downloadsView release notes\u0026lt;/description\u0026gt; \u0026lt;pubDate\u0026gt;Mon, 23 Jan 2023 09:00:00 PST\u0026lt;/pubDate\u0026gt; \u0026lt;content:encoded\u0026gt;\u0026lt;![CDATA[\u0026lt;p\u0026gt;\u0026lt;a href=/download class=more\u0026gt;View downloads\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;il\u0026gt;\u0026lt;p\u0026gt;\u0026lt;a href=/go/?id=macos-13.2-rn class=more\u0026gt;View release notes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/il\u0026gt;]]\u0026gt;\u0026lt;/content:encoded\u0026gt; \u0026lt;/item\u0026gt; So all the information we need is contained within the title of each item in the feed, in particular we\u0026rsquo;ll be needing the Build Version in order to use this to update our Compliance Policy.\nGetting the Build Version # With the $uri set to the RSS feed, we can Invoke-WebRequest to pull through the data into the variable $Updates, making sure we\u0026rsquo;re processing it as XML, and removing any unsupported characters.\n$uri = \u0026#39;https://developer.apple.com/news/releases/rss/releases.rss\u0026#39; [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \u0026#39;application/xml\u0026#39;).Content -replace \u0026#39;[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\u0026#39;, \u0026#39;\u0026#39; As the feed has multiple update releases for each Operating System, we need to pass them into an array, so we can select the most recent one:\n$BuildVersion = @() Whilst looping through each item in the feed, we can filter each $Update based on both the Operating System $OS, and the version $Version, to ensure that we\u0026rsquo;re only pulling back the data we require, returning only the first and newest update.\nforeach ($Update in $Updates.rss.channel.Item) { if (($Update.title -like \u0026#34;*$OS*\u0026#34;) -and ($Update.title -like \u0026#34;*$Version*\u0026#34;)) { $BuildVersion += $Update.title } } return $BuildVersion[0] Running this all together, passing through iOS and 16 for the variables, we get an output of:\niOS 16.3 (20D47) This looks promising.\nCreating the Function # As the aim is to repeat both the process of updating Compliance Policies, and tailoring for the multiple Operating Systems and versions, we should wrap the above in a Function.\nFunction Get-AppleUpdates() { \u0026lt;# .SYNOPSIS This function is used to get the latest Apple Updates from the Apple Developer RSS Feeds .DESCRIPTION The function pulls the RSS feed from the Apple Developer RSS Feeds .EXAMPLE Get-AppleUpdates -OS iOS -Version 15 #\u0026gt; [cmdletbinding()] param ( [Parameter(Mandatory = $true)] [ValidateSet(\u0026#39;iOS\u0026#39;, \u0026#39;macOS\u0026#39;)] $OS, [Parameter(Mandatory = $true)] $Version ) try { $uri = \u0026#39;https://developer.apple.com/news/releases/rss/releases.rss\u0026#39; [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \u0026#39;application/xml\u0026#39;).Content -replace \u0026#39;[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\u0026#39;, \u0026#39;\u0026#39; $BuildVersion = @() foreach ($Update in $Updates.rss.channel.Item) { if (($Update.title -like \u0026#34;*$OS*\u0026#34;) -and ($Update.title -like \u0026#34;*$Version*\u0026#34;)) { $BuildVersion += $Update.title } } return $BuildVersion[0] } catch { Write-Error $Error[0].ErrorDetails.Message break } } This can now be called within PowerShell using the below as examples:\nGet-AppleUpdates -OS iOS -Version 16 Get-AppleUpdates -OS macOS -Version 13 Updating Compliance # We\u0026rsquo;ve already got functions from our last expedition into this topic for getting and updating Compliance Policies, checking for valid JSON as well as the usual suspect for authentication using Connect-MgGraph, so thank you to previous me for this.\nArmed with our new function for getting the latest Apple Build versions, we now need to build out the script to do our job for us.\nGetting the Policies # As we only care about iOS/iPadOS and macOS today, we need to filter the policies we are retrieving using the Get-DeviceCompliancePolicy function, this can be accomplished by using the @odata.type, and also only those policies with a osMinimumVersion configured:\n$OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { (($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#39;iosCompliancePolicy\u0026#39;) -or ($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#39;macOSCompliancePolicy\u0026#39;)) -and ($_.osMinimumVersion) -ne $null } Now with the policies in the variable, we can loop through each and set our $OS variable based on the @odata.type of the policy, and grab the $Version variable using the first two digits of osMinimumVersion, as we\u0026rsquo;ll need these for the Get-AppleUpdates parameters.\nforeach ($OSCompliancePolicy in $OSCompliancePolicies) { If ($OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*ios*\u0026#39;) { $OS = \u0026#39;iOS\u0026#39; } elseif ($OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*macOS*\u0026#39;) { $OS = \u0026#39;macOS\u0026#39; } $Version = $OSCompliancePolicy.osMinimumVersion.SubString(0, 2) } Handling Build Versions # Now the output of the function gives us all the information we could ask for, but we actually only need a small part of it, the bit in brackets: iOS 16.3 (20D47)\nSo we can strip out the data between the brackets, using the magic of Regex and add this to a new variable we\u0026rsquo;ll use later to update the Compliance Policy in question:\n$Build = (Get-AppleUpdates -OS $OS -Version $Version | Select-String \u0026#39;(?\u0026lt;=\\()[^]]+(?=\\))\u0026#39; -AllMatches).Matches.Value Building the JSON Data # To update our Compliance Policy, we need to send it some JSON data in a particular format as part of the Update-DeviceCompliancePolicy function, we can build this using both the existing information captured from the Get-DeviceCompliancePolicy and the newly acquired build version, then finally calling the function to update the Compliance Policy.\n$Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value $OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $Description $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;osMinimumBuildVersion\u0026#39; -Value $Build $JSON = $Update | ConvertTo-Json -Depth 3 Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON All being good, this data looks something like this for our iOS 16 Compliance Policy:\n{ \u0026#34;@odata.type\u0026#34;: \u0026#34;#microsoft.graph.iosCompliancePolicy\u0026#34;, \u0026#34;description\u0026#34;: \u0026#34;Updated Operating System Device Compliance Policy on 26-01-2023 10:39:29\u0026#34;, \u0026#34;osMinimumBuildVersion\u0026#34;: \u0026#34;20D47\u0026#34; } We can now submit this JSON data to Graph, passing through the required Compliance Policy id, allowing us to update the required policy:\nUpdate-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON All going well, we now have an updated policy with the correct and most recent build version for the Operating System.\nThe Solution # We have all the component parts to bring the full script together, of which you can see below without the functions and Graph Authentication.\nKey things to note here that we haven\u0026rsquo;t covered individually is the check to see if the build version is already up to date, as there\u0026rsquo;s no point triggering a Compliance Check on devices if nothing has changed.\n$Date = Get-Date -Format \u0026#39;dd-MM-yyyy hh:mm:ss\u0026#39; $Description = \u0026#34;Updated Operating System Device Compliance Policy on $Date\u0026#34; $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { (($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#39;iosCompliancePolicy\u0026#39;) -or ($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#39;macOSCompliancePolicy\u0026#39;)) -and ($_.osMinimumVersion) -ne $null } foreach ($OSCompliancePolicy in $OSCompliancePolicies) { If ($OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*ios*\u0026#39;) { $OS = \u0026#39;iOS\u0026#39; } elseif ($OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; -like \u0026#39;*macOS*\u0026#39;) { $OS = \u0026#39;macOS\u0026#39; } $Version = $OSCompliancePolicy.osMinimumVersion.SubString(0, 2) $Build = (Get-AppleUpdates -OS $OS -Version $Version | Select-String \u0026#39;(?\u0026lt;=\\()[^]]+(?=\\))\u0026#39; -AllMatches).Matches.Value If ($OSCompliancePolicy.osMinimumBuildVersion -ne $Build) { $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value $OSCompliancePolicy.\u0026#39;@odata.type\u0026#39; $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $Description $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;osMinimumBuildVersion\u0026#39; -Value $Build $JSON = $Update | ConvertTo-Json -Depth 3 Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON Write-Host \u0026#34;Updated $OS Compliance Policy $($OSCompliancePolicy.displayName) with latest Build: $Build\u0026#34; -ForegroundColor Green Write-Host } Else { Write-Host \u0026#34;$OS Compliance Policy $($OSCompliancePolicy.displayName) already on latest Build: $Build\u0026#34; -ForegroundColor Cyan Write-Host } } Script in Action # We should practice what we preach and test our script in our own Intune environment before letting loose on a production one, so here we go.\niOS 15 Compliance Policy without an existing build version Microsoft Intune iOS15 compliance policy. macOS Big Sur Compliance Policy with a current build version Microsoft Intune macOS Big Sur compliance policy. macOS Ventura Compliance Policy with an existing build version Microsoft Intune macOS Ventura compliance policy. Running the script will give us the below output:\nUpdated macOS Compliance Policy Compliance_macOS_Corporate_OS_13 with latest Build: 22D49 macOS Compliance Policy Compliance_macOS_Corporate_OS_12 already on latest Build: 21G217 Updated iOS Compliance Policy Compliance_iOS_Corporate_OS_15 with latest Build: 19H307 Updated iOS Compliance Policy Compliance_iOS_Corporate_OS_16 with latest Build: 20D47 Resulting in our Compliance Policies getting updated with the latest build versions:\niOS 15 Compliance Policy updated to 19H307 Updated Microsoft Intune iOS15 compliance policy. Checking this against the Apple Developer Release Feed that we haven\u0026rsquo;t made a mistake.\n\u0026lt;item\u0026gt; \u0026lt;title\u0026gt;iOS 15.7.3 (19H307)\u0026lt;/title\u0026gt; \u0026lt;link\u0026gt;https://developer.apple.com/news/releases/?id=01232023b\u0026lt;/link\u0026gt; \u0026lt;guid\u0026gt;https://developer.apple.com/news/releases/?id=01232023b\u0026lt;/guid\u0026gt; \u0026lt;description\u0026gt;View downloads\u0026lt;/description\u0026gt; \u0026lt;pubDate\u0026gt;Mon, 23 Jan 2023 09:00:00 PST\u0026lt;/pubDate\u0026gt; \u0026lt;content:encoded\u0026gt;\u0026lt;![CDATA[\u0026lt;p\u0026gt;\u0026lt;a href=/download class=more\u0026gt;View downloads\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;]]\u0026gt;\u0026lt;/content:encoded\u0026gt; \u0026lt;/item\u0026gt; macOS Ventura Compliance Policy updated to 22D49 Updated Microsoft Intune macOS Ventura compliance policy. Again checking this against the Apple Developer Release Feed that we still haven\u0026rsquo;t made a mistake.\n\u0026lt;item\u0026gt; \u0026lt;title\u0026gt;macOS 13.2 (22D49)\u0026lt;/title\u0026gt; \u0026lt;link\u0026gt;https://developer.apple.com/news/releases/?id=01232023d\u0026lt;/link\u0026gt; \u0026lt;guid\u0026gt;https://developer.apple.com/news/releases/?id=01232023d\u0026lt;/guid\u0026gt; \u0026lt;description\u0026gt;View downloadsView release notes\u0026lt;/description\u0026gt; \u0026lt;pubDate\u0026gt;Mon, 23 Jan 2023 09:00:00 PST\u0026lt;/pubDate\u0026gt; \u0026lt;content:encoded\u0026gt;\u0026lt;![CDATA[\u0026lt;p\u0026gt;\u0026lt;a href=/download class=more\u0026gt;View downloads\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;il\u0026gt;\u0026lt;p\u0026gt;\u0026lt;a href=/go/?id=macos-13.2-rn class=more\u0026gt;View release notes\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt;\u0026lt;/il\u0026gt;]]\u0026gt;\u0026lt;/content:encoded\u0026gt; \u0026lt;/item\u0026gt; Or resulting in the current build version Compliance Policies not getting updated:\nmacOS Big Sur Compliance Policy not updated Microsoft Intune macOS Big Sur compliance policy. Overall this looks pretty good to me.\nSummary # We\u0026rsquo;re almost there with maintaining Operating System Compliance Policies, with Windows, iOS/iPadOS, and macOS under our belt, our next challenge will be Android, and bringing them all together into one single script.\nFor now though, we\u0026rsquo;ve reduced the overhead of having to manually update these Compliance Policies for three out of six four (let\u0026rsquo;s not mention Linux or ChromeOS just yet) Operating Systems supported in Microsoft Intune, so something to be happy about I guess.\n","date":"2 February 2023","externalUrl":null,"permalink":"/posts/apple-os-updating-compliance/","section":"Posts","summary":"Apple devices shouldn\u0026rsquo;t be exempt from Operating System compliance policies, and these policies should share the same fate as Windows ones, and be updated monthly in line with update release cycles.","title":"Updating Apple Operating System Compliance Policies","type":"posts"},{"content":"","date":"20 January 2023","externalUrl":null,"permalink":"/tags/automated-device-enrolment/","section":"Tags","summary":"","title":"Automated Device Enrolment","type":"tags"},{"content":"Now that you\u0026rsquo;ve made the financial sensible decision to migrate to Microsoft Intune for your Apple device management needs, you\u0026rsquo;ve got your Apple Push Certificate, sorted your Enrolment Token, added Intune as an MDM provider, and now you\u0026rsquo;ve got all your iOS/iPadOS devices happily sitting synchronised in Intune waiting to be deployed using Apple\u0026rsquo;s Automated Device Enrolment. Life is good.\nUntil you realise that in your excitement you\u0026rsquo;ve created loads of Enrolment Profiles (up to 1000 in fact, help), and you now have the daunting task of assigning your thousands (up to 200,000, fml) iOS/iPadOS devices to these profiles.\nNo one likes clicking that much.\nDeveloper Tool Sneaking # If you hadn\u0026rsquo;t realised already, everything in Microsoft Intune is backed by the Graph API, to the point where if you open your browser developer tools, usually by pressing F12, you can actually see the calls to Graph being made when you click around.\nEdge Developer Tools and Microsoft Intune. This makes it pretty easy to identify the resource in Graph being used, as well as the call you\u0026rsquo;ll be making to the API.\nUsing this method, and actually assigning a profile to an iOS/iPadOS device in Intune, and watching what calls are made using the developer tools, allows us to capture the Graph resource endpoint and ultimately throw together the functions we need, in this case, to get and assign the Enrolment Profiles.\nEdge Developer Tools and the Graph API call. Apple Enrolment Token # To get all the Enrolment Profiles and Devices associated with the Apple Enrolment Program Token, we\u0026rsquo;ve got to call the Token itself using the GET /deviceManagement/depOnboardingSettings resource.\nConnect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All'. Function Get-ADEEnrolmentToken() { $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceManagement/depOnboardingSettings\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } This function gives us the below output, and the necessary id we can use to call the Enrolment Profiles and everything else associated with out Apple Enrolment Program Token:\nid : 17793d6e-e12d-4a04-b209-73d302b9a563 appleIdentifier : memv@ennbee.uk tokenExpirationDateTime : 16/05/2023 14:40:28 lastModifiedDateTime : 16/05/2022 14:40:52 lastSuccessfulSyncDateTime : 22/01/2023 12:30:03 lastSyncTriggeredDateTime : 18/01/2023 14:45:26 shareTokenWithSchoolDataSyncService : False lastSyncErrorCode : 0 tokenType : dep tokenName : MEMVENNBEE Intune syncedDeviceCount : 4 dataSharingConsentGranted : True roleScopeTagIds : {0} Enrolment Profiles # With the Token, and more importantly the id of the Token in hand, we can now call GET /deviceManagement/depOnboardingSettings/{depOnboardingSettingId}/enrollmentProfiles to pull back all the enrolment profiles associated with that Token ID.\nFunction Get-ADEEnrolmentProfile() { Param( [Parameter(Mandatory = $true)] $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Punting Get-ADEEnrolmentToken into a variable $Token, we can now pull back all the Enrolment Profiles associated with Enrolment Program Token:\n$Token = Get-ADEEnrolmentToken Get-ADEEnrolmentProfile -Id $Token.Id This will now list out all the Enrolment Profiles linked to the Token, with full details of each of the Enrolment Profiles:\n@odata.type : #microsoft.graph.depIOSEnrollmentProfile id : 17793d6e-e12d-4a04-b209-73d302b9a563_289e29a1-34ec-404c-a1d3-9c8dc712ea80 displayName : Enrolment_iOS_Clinical_Shared_User description : requiresUserAuthentication : False configurationEndpointUrl : https://appleconfigurator2.manage.microsoft.com/MDMServiceConfig?id=61513957-6e30-4b9f-a30a-051a20ffe3da\u0026amp;AADTenantId=58775aec-3fd5-42a9-9c65-b4a34d4e78f2 enableAuthenticationViaCompanyPortal : False requireCompanyPortalOnSetupAssistantEnrolledDevices : False isDefault : False supervisedModeEnabled : True supportDepartment : Clinical Shared Device Users isMandatory : True locationDisabled : False supportPhoneNumber : 01904 profileRemovalDisabled : True restoreBlocked : True appleIdDisabled : True termsAndConditionsDisabled : True touchIdDisabled : True applePayDisabled : True siriDisabled : True diagnosticsDisabled : True displayToneSetupDisabled : False privacyPaneDisabled : True screenTimeScreenDisabled : True deviceNameTemplate : CLIN-S-STD-{{SERIAL}} configurationWebUrl : False enabledSkipKeys : {Android, HomeButtonSensitivity, iMessageAndFaceTime, OnBoarding‚Ä¶} iTunesPairingMode : allow restoreFromAndroidDisabled : True awaitDeviceConfiguredConfirmation : False sharedIPadMaximumUserCount : 0 enableSharedIPad : False companyPortalVppTokenId : 00000000-0000-0000-0000-000000000000 enableSingleAppEnrollmentMode : False homeButtonScreenDisabled : True iMessageAndFaceTimeScreenDisabled : True onBoardingScreenDisabled : True simSetupScreenDisabled : True softwareUpdateScreenDisabled : False watchMigrationScreenDisabled : True appearanceScreenDisabled : True expressLanguageScreenDisabled : False preferredLanguageScreenDisabled : False deviceToDeviceMigrationDisabled : True welcomeScreenDisabled : True passCodeDisabled : False zoomDisabled : False restoreCompletedScreenDisabled : True updateCompleteScreenDisabled : False forceTemporarySession : False temporarySessionTimeoutInSeconds : 0 userSessionTimeoutInSeconds : 0 passcodeLockGracePeriodInSeconds : carrierActivationUrl : userlessSharedAadModeEnabled : False managementCertificates : {} Assigning Devices # I had to continue sneaking into the Graph API calls, as I couldn\u0026rsquo;t find any reference in the Graph documentation, to the resource used for assigning devices to a profile.\nI managed to find the following call to support the assignment deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles('$ProfileID')/updateDeviceProfileAssignment, this his references the Enrolment Profile Id, which we can now get using the above function, but it also needs a JSON formatted object containing the serial numbers of the devices:\n{ \u0026#34;deviceIds\u0026#34;: \u0026#34;SERIAL1, SERIAL2, SERIAL3\u0026#34; } We can use a PowerShell psobject to build this for us in the function.\nBeing able to pass through many device serial numbers is good news for us, as instead of having to call Graph like a million times for each device, we can just make the call for each profile, so you know, only hundreds of times.\nFunction Add-ADEEnrolmentProfileAssignment() { Param( [Parameter(Mandatory = $true)] $Id, [Parameter(Mandatory = $true)] $ProfileID, [Parameter(Mandatory = $true)] $DeviceSerials ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceManagement/depOnboardingSettings/$Id/enrollmentProfiles(\u0026#39;$ProfileID\u0026#39;)/updateDeviceProfileAssignment\u0026#34; $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;deviceIds\u0026#39; -Value $DeviceSerials $JSON = $Output | ConvertTo-Json -Depth 3 try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } catch { Write-Error $Error[0].ErrorDetails.Message break } } Hash Hash Array # We\u0026rsquo;ve now got all the functions we could ever need, now we need to be able to ingest a list of serial numbers and the Enrolment Profile name that they should be associated with; easy, a CSV file and some effort is all that is required:\nSerial,EnrolmentProfile\rDX3FDFZ6PLFG,Enrolment_iOS_Corp_User_Standard\rH4QJQ01PPLFG,Enrolment_iOS_Corp_User_Standard\rF9GV90XKGHPD,Enrolment_iOS_Clinical_Shared_User\rG6VVLDJPJCLK,Enrolment_iOS_Clinical_Shared_User The tricky part, was how we actually have to use this data, creating a unique list of the Enrolment Profiles, and then based on the association of the device serial number to the profile, add each serial number to each profile.\nIf we don\u0026rsquo;t do this, then we are going to be calling graph for each device serial number in the list, and I\u0026rsquo;d rather not piss off Microsoft. Time for a hashtable, and maybe an array.\nUp, Up and Array # We can now import the CSV file and assign it to a variable:\n$CSVPath = \u0026#34;C:\\Somepath\\SomeCSV.csv\u0026#34; $Devices = Import-Csv -Path $CSVPath Giving us a wonderful output:\nSerial EnrolmentProfile ------ ---------------- DX3FDFZ6PLFG Enrolment_iOS_Corp_User_Standard H4QJQ01PPLFG Enrolment_iOS_Corp_User_Standard F9GV90XKGHPD Enrolment_iOS_Clinical_Shared_User G6VVLDJPJCLK Enrolment_iOS_Clinical_Shared_User Creating a new array $DeviceProfiles = @() and looping through each $Device in $Devices, we can add all the Enrolment Profiles in the CSV file to the array, finally using Get-Unique to ensure that we only have a unique list of Enrolment Profile names.\n$DeviceProfiles = @() foreach ($Device in $Devices) { $DeviceProfiles += $Device.EnrolmentProfile } $UniqueDeviceProfiles = $DeviceProfiles | Get-Unique Giving us an output similar to the below:\nEnrolment_iOS_Clinical_Shared_User Enrolment_iOS_Corp_User_Standard Hash Bang Wallop # With a hashtable, Assignments = @{} we can loop through each $UniqueDeviceProfile in $UniqueDeviceProfiles adding each unique Enrolment Profile as an array to the hashtable.\nAssignments = @{} foreach ($UniqueDeviceProfile in $UniqueDeviceProfiles){ $Assignments[$UniqueDeviceProfile] = @() } With an output of the below:\nName Value ---- ----- Enrolment_iOS_Clinical_Shared‚Ä¶ {} Enrolment_iOS_Corp_User_Stand‚Ä¶ {} With the hashtable and an array for each Enrolment Profile, we can finally loop through $Device in $Devices and add the device serial to the matching Enrolment Profile array.\nforeach ($Device in $Devices) { $Assignments[\u0026#34;$($Device.EnrolmentProfile)\u0026#34;] += $Device.Serial } Giving us our final form hash table, that we can at last use, to assign devices to Enrolment Profiles. This honestly broke my brain.\nName Value ---- ----- Enrolment_iOS_Corp_User_Stand‚Ä¶ {DX3FDFZ6PLFG, H4QJQ01PPLFG} Enrolment_iOS_Clinical_Shared‚Ä¶ {F9GV90XKGHPD, G6VVLDJPJCLK} Assigning Device Enrolment Profiles # With that horrible mess we created, we can combine it all into a sub-par script, to actually assign these devices to the Enrolment Profiles.\nThe full script as always is in my GitHub repo, and gives you some nice messages along the way as it runs off plays with your Intune environment, it also catches errors, which I\u0026rsquo;ve been told is important.\nThe bits you care about now, and the final pay off to our work, can be found below, remember to include the functions and authentication otherwise everything will look a little red in the PowerShell console:\n$CSVPath = Read-Host \u0026#39;Please provide the path to the CSV file containing a list of Serial Numbers and ADE Profile Names e.g. C:\\temp\\ADEDevices.csv\u0026#39; $Devices = Import-Csv -Path $CSVPath $DeviceProfiles = @() foreach ($Device in $Devices) { $DeviceProfiles += $Device.EnrolmentProfile } $UniqueDeviceProfiles = $DeviceProfiles | Get-Unique $Assignments = @{} foreach ($UniqueDeviceProfile in $UniqueDeviceProfiles){ $Assignments[$UniqueDeviceProfile] = @() } foreach ($Device in $Devices) { $Assignments[\u0026#34;$($Device.EnrolmentProfile)\u0026#34;] += $Device.Serial } $Token = Get-ADEEnrolmentToken foreach ($Assignment in $Assignments.GetEnumerator()) { $EnrolmentProfile = Get-ADEEnrolmentProfile -Id $Token.id | Where-Object { ($_.displayName -eq $Assignment.Name) } Add-ADEEnrolmentProfileAssignment -Id $Token.id -ProfileID $EnrolmentProfile.id -DeviceSerial $Assignment.Value } After carefully stepping through the script, we can now see the results of our efforts, and although this was only targetted to four devices, the approach will scale:\nAutomated Deployment Profile script assignment results. Digging in a little deeper, we can see that the device has been assigned to the correct Enrolment Profile:\nAutomated Deployment Profile assignment for a single device. Everything looks good, you\u0026rsquo;ll now just need to add all your serials numbers and the associated Enrolment Profile name to the CSV file and you can starting assigning the devices in anger.\nSummary # In short, this is a pretty straight forward approach to assist with assignment of profiles in bulk, especially as part of migrating Apple Business or School Manager registered Apple devices from one MDM to Intune, without the need to click around so much.\nRealistically I should have encountered this problem a lot sooner, as there are hundreds of thousands of organisations moving away from their existing MDM provider to Microsoft Intune, maybe the ones with this many Apple devices weren\u0026rsquo;t lucky enough to work with me and my incessant need to script everything.\n","date":"20 January 2023","externalUrl":null,"permalink":"/posts/apple-ade-profile-assignment/","section":"Posts","summary":"Migrating iOS/iPadOS device to Microsoft Intune shouldn\u0026rsquo;t be a headache, and assignment of Automated Device Enrolment profiles with Apple Business Manager integration isn\u0026rsquo;t the exception.","title":"Device Migration and Automated Device Enrolment Profile Assignment","type":"posts"},{"content":"Nothing has really changed in the Hybrid Join Autopilot space when it comes to device names, and we\u0026rsquo;re still stuck with useless naming conventions for these devices; sometimes a prefix and random characters just isn\u0026rsquo;t a good enough identification method for Windows devices.\nSo now that it\u0026rsquo;s 2023 it was time to look at this problem once again, mainly because my old solution broke device certificates and an Always On VPN connection that relied on them as part of the Autopilot process.\nName Problems # The trouble with the old method, a PowerShell script disguised as a Win32 App, is that it will happily rename and reboot the device during the Autopilot OOBE process, is that the device will already have a device certificate with it\u0026rsquo;s old jumbled name, and it needs this for both the VPN connection and some level of trust to the domain.\nWhat I was seeing is that the computer renamed, but it lost it\u0026rsquo;s trust and connection to the domain once the Autopilot process had finished. Not ideal when deploying device remotely.\nCertificate Template # We can update the certificate deployment template in Intune to take into consideration the new name of the device, especially as we\u0026rsquo;re using an attribute as part of the device rename that Intune knows about, the serial number.\nAs the Simple Certificate Enrolment Protocol (SCEP) profile supports various device or user attributes we can add these into either Subject Name or Subject Alternative Name of the issued certificate, as well as any prefix we want to add such as L-:\nCN=L-{{SerialNumber}} DNS={{FullyQualifiedDomainName}} DNS={{DeviceName}} DNS=L-{{SerialNumber}}.ennbee.local This sorts out our certificate issue, as the device will have one that has all possible device names, the initial one assigned by the Domain Join profile, and the new one after the device has been renamed. This doesn\u0026rsquo;t solve our Domain trust issue though.\nProactive Remediation # We could do with a way to both check that the device name matches our expected naming convention of L-%SERIAL% for laptops, and D-%SERIAL% for desktops, and fixes the issue for us.\nThis is where Proactive Remediation scripts come to save us, and as I got M365 licenses for Christmas we can make use of them due to this being a licensing requirement.\nNow that we have new tools at our disposal, and modify permissions for \u0026lsquo;SELF\u0026rsquo; already in place in the destination Organisational Unit allowing the computer object to rename itself, we can hack about with the old script that was doing the computer rename as part of the Autopilot process, and using Proactive Remediation scripts, we can check that the existing device name matches the expected device name.\nDetection Script # First off we need a something to check that the device is Domain Joined (Lines 1-6), what the new Computer name is expected to be based on whether a desktop or laptop (Lines 8-21), and what the existing Computer name is (Lines 23-26). As we already have a starter for ten, this wasn\u0026rsquo;t too much of a hassle to throw together quickly.\nTry { $details = Get-ComputerInfo if (-not $details.CsPartOfDomain) { Write-Output \u0026#39;Not Domain Joined\u0026#39; Exit 0 } $serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = \u0026#39;L-\u0026#39; + $serial } Else { $newName = \u0026#39;D-\u0026#39; + $serial } $newName = $newName.Replace(\u0026#39; \u0026#39;, \u0026#39;\u0026#39;) if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } If ($details.CsName -ne $newName) { Write-Warning \u0026#34;Existing Computer name $($details.CsName) should be $newName\u0026#34; Exit 1 } Else { Write-Output \u0026#34;Computer has correct name: $($details.CsName)\u0026#34; Exit 0 } } Catch { Write-Error $_.Exception Exit 2000 } With Proactive Remediation scripts, we need to pass back the results of this check, and any checks, with Exit Codes and some kind of descriptive text.\nRemediation Script # With the information about the device name in place with the detection, now we need something to fix our issues, or if you want to use bigger words, remediate them.\nWe only want this script to run when the device can actually talk to a Domain, otherwise we\u0026rsquo;re in for a bad time of mistrust again. So updating the $domain variable with the name of the domain, we can confirm that we can talk to a Domain Controller, otherwise we exit the script with an error.\n$domain = \u0026#39;ennbee.local\u0026#39; $dcInfo = [ADSI]\u0026#34;LDAP://$domain\u0026#34; if ($null -eq $dcInfo.Path) { Write-Error \u0026#34;No connectivity to $domain\u0026#34; } We can reuse the part of the detection script for the creation of the new computer name, using whether a device has a battery or not to determine whether the device is a laptop or desktop, removing any spaces from the serial, and making sure the new device name is 15 characters or less:\n$Serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = \u0026#39;L-\u0026#39; + $Serial } Else { $newName = \u0026#39;D-\u0026#39; + $Serial } $newName = $newName.Replace(\u0026#39; \u0026#39;, \u0026#39;\u0026#39;) #Removes spaces if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } Last bit to manage is renaming the device using Rename-Computer and sending a shutdown command with our specified restart time, user notification and friendly message:\n$waittime = \u0026#39;60\u0026#39; Rename-Computer -NewName $newName $waitinseconds = (New-TimeSpan -Minutes $waittime).TotalSeconds Write-Host \u0026#34;Initiating a restart in $waittime minutes\u0026#34; \u0026amp; shutdown.exe /g /t $waitinseconds /f /c \u0026#39;Restarting the computer in 60 minutes due to a computer name change. Please save your work.\u0026#39; Write-Output \u0026#34;Computer renamed from $($Details.CsName) to $newName\u0026#34; This gives the user some notice that the restart is going to happen:\nRestart notification in Windows. All components now in place, we have the full script wrapped in the needed Try/Catch operators, otherwise the good practice PowerShell Police will get you:\n$domain = \u0026#39;ennbee.local\u0026#39; $waitTime = \u0026#39;60\u0026#39; Try { $dcInfo = [ADSI]\u0026#34;LDAP://$domain\u0026#34; if ($null -eq $dcInfo.Path) { Write-Error \u0026#34;No connectivity to $domain\u0026#34; } $serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber If (Get-WmiObject -Class win32_battery) { $newName = \u0026#39;L-\u0026#39; + $serial } Else { $newName = \u0026#39;D-\u0026#39; + $serial } $newName = $newName.Replace(\u0026#39; \u0026#39;, \u0026#39;\u0026#39;) if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } Rename-Computer -NewName $newName $waitSeconds = (New-TimeSpan -Minutes $waitTime).TotalSeconds Write-Host \u0026#34;Initiating a restart in $waitime minutes\u0026#34; \u0026amp; shutdown.exe /g /t $waitSeconds /f /c \u0026#34;Restarting your computer in $waitTime minutes due to a computer name change. Please save your work.\u0026#34; Write-Output \u0026#34;Computer renamed from $($details.CsName) to $newName\u0026#34; } Catch { Write-Error $_.Exception Exit 2000 } Deployment in Intune # Throwing ourselves into the safe space that is Intune, go and find the Proactive Remediation section, I\u0026rsquo;ll give you a hint, it\u0026rsquo;s under Reports \u0026gt; Endpoint Analytics.\nCreate a new Script Package, selecting and uploading both the detection and remediation scripts as you go, you can get these from GitHub. Make sure you select \u0026lsquo;Run script in 64-bit PowerShell\u0026rsquo; as I couldn\u0026rsquo;t be bothered scripting a check if PowerShell was running in the 64-bit context.\nRemediation script in Microsoft Intune. Go ahead and assign this to a test group of devices, or if you\u0026rsquo;re brave or don\u0026rsquo;t care about testing, all devices with a Device Filter, giving the assignment a schedule; I\u0026rsquo;ve gone with daily repeating every day, but amend this to your environment requirements:\nRemediation schedule in Microsoft Intune. Now we have to sit back and wait for devices to receive the script package, execute it, and where applicable remediate.\nWhen the devices do check in, you will be able to see the results in Intune under the Device Status, make sure you\u0026rsquo;ve added both the \u0026lsquo;Pre-remediation detection output\u0026rsquo; and \u0026lsquo;Post-remediation detection output\u0026rsquo;:\nRemediation results in Microsoft Intune. I didn\u0026rsquo;t get a screenshot in time for detection picking up errors, only the success, but you get the gist.\nSummary # With this method now successfully renaming the device from the Windows Desktop, the certificate in place to cater to the new computer name, we don\u0026rsquo;t end up losing domain trust or connectivity as part of the Autopilot Hybrid Join deployment, and the user is the only one impacted, not the Service Desk.\nI wouldn\u0026rsquo;t go as far to say this was a difficult problem, but with how flexible and powerful Proactive Remediation Scripts are, with the limitation only being your ability to write PowerShell (and obviously the correct licensing), I\u0026rsquo;d recommend using these more and more in place of wrapping PowerShell scripts as a Win32App and having to battle with creating \u0026rsquo;tag\u0026rsquo; files as a detection method.\n","date":"12 January 2023","externalUrl":null,"permalink":"/posts/hybrid-join-computer-rename-again/","section":"Posts","summary":"Nothing has really changed in the Hybrid Join Autopilot space when it comes to device names, and we\u0026rsquo;re still stuck with useless naming conventions for these devices; sometimes a prefix and random characters just isn\u0026rsquo;t a good enough identification method for Windows devices.","title":"Proactively Renaming Hybrid Azure AD Joined Devices","type":"posts"},{"content":"Have you ever had the pleasure of migrating Configuration Manager clients from one domain to another, or maybe between Configuration Manager environments? Tired of manually reinstalling the client from the Console? Wanting a quick and easy way to keep on top of migrated devices? You\u0026rsquo;re in luck.\nProblem Time # With the migration of clients between Configuration Manager environments, or between domains that Configuration Manager manages devices on, you\u0026rsquo;ll inevitably be in the situation where you need to reinstall the client on these devices to ensure that communication still occurs between the client and the Management Point.\nThe problem here, is that the underlying computer object, and associated machine account has changed, and from a Configuration Manager perspective will be treated, as it should, as a newly discovered client. You can remedy this by forcing the un-installation and an installation of the client from within the console, but this really isn\u0026rsquo;t practical for continued migration of clients. So we need a solution, and quickly.\nPowerShell to the Rescue # As always it\u0026rsquo;s PowerShell that will save us, a couple of useful in-built Configuration Manager commands, and a stolen/borrowed Configuration Manager Logging Function.\nThis one will be breezy.\nComputers without a Client # We could do this in a couple of ways, create a collection in Configuration Manager of all machines without the Client installed and use this collection to push the installation:\nselect SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System where SMS_R_System.Client is null Or capture all non-default devices without the client using Get-CMdevice and target them directly:\nGet-CMdevice | Where-Object { ($_.IsClient -eq \u0026#39;\u0026#39;) -and ($_.SMSID -notlike \u0026#39;*Unknown Computer*\u0026#39; ) -and ($_.SMSID -notlike \u0026#39;*Provisioning Device*\u0026#39;) } We\u0026rsquo;re going with the latter as I\u0026rsquo;d like to know which machines are being targeted.\nTo use the Get-CMdevice command, we need to import and connect to the Configuration Manager instance using the below when on the Primary Site Server:\n# Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + \u0026#39;\\ConfigurationManager.psd1\u0026#39;) # Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\u0026#34;:\u0026#34; Logging Functions # No we\u0026rsquo;re connected we can use the command to capture all the devices we want to target, but we could do with a way to log wtf is going on as part of the re-installation, and in a format that CMTrace will be happy to read.\nFunction Write-log { [CmdletBinding()] Param( [parameter(Mandatory = $true)] [String]$Path, [parameter(Mandatory = $true)] [String]$Message, [parameter(Mandatory = $true)] [String]$Component, [Parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Info\u0026#39;, \u0026#39;Warning\u0026#39;, \u0026#39;Error\u0026#39;)] [String]$Type ) switch ($Type) { \u0026#39;Info\u0026#39; { [int]$Type = 1 } \u0026#39;Warning\u0026#39; { [int]$Type = 2 } \u0026#39;Error\u0026#39; { [int]$Type = 3 } } # Create a log entry $Content = \u0026#34;\u0026lt;![LOG[$Message]LOG]!\u0026gt;\u0026#34; + ` \u0026#34;\u0026lt;time=`\u0026#34;$(Get-Date -Format \u0026#39;HH:mm:ss.ffffff\u0026#39;)`\u0026#34; \u0026#34; + ` \u0026#34;date=`\u0026#34;$(Get-Date -Format \u0026#39;M-d-yyyy\u0026#39;)`\u0026#34; \u0026#34; + ` \u0026#34;component=`\u0026#34;$Component`\u0026#34; \u0026#34; + ` \u0026#34;context=`\u0026#34;$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name)`\u0026#34; \u0026#34; + ` \u0026#34;type=`\u0026#34;$Type`\u0026#34; \u0026#34; + ` \u0026#34;thread=`\u0026#34;$([Threading.Thread]::CurrentThread.ManagedThreadId)`\u0026#34; \u0026#34; + ` \u0026#34;file=`\u0026#34;`\u0026#34;\u0026gt;\u0026#34; # Write the line to the log file Add-Content -Path $Path -Value $Content } If you\u0026rsquo;d like more detail head over to janikvonrotz.ch who wrote this function.\nWith the function in place, we just need to define the $LogFilePath variable and we\u0026rsquo;re good to capture whatever horrible errors we\u0026rsquo;re to encounter as part of the script.\n$LogFilePath = Join-Path $PSScriptRoot \u0026#34;$(Get-Date -Format yyyy-MM-dd-HHmm) $($MyInvocation.MyCommand.Name).log\u0026#34; And a way to punt the information or errors or warnings to the log file when we encounter then, something like:\nWrite-Error ($_ | Out-String) Write-Log -Path $LogFilePath -Message ($_ | Out-String) -Component $MyInvocation.MyCommand.Name -Type Error Below is an example of the output of the log file:\nThe generated log file. Who would have thought I would bother putting in logging, it\u0026rsquo;s like I wrote this for an actual customer or something.\nClient Installation # With the bare-bone stuff in place, we will be using the Install-CMClient command to force the removal of the old client (-ForceReinstall) and force the installation of the new client (-AlwaysInstallClient), aggressive, I like it.\nI\u0026rsquo;ve chosen to use the -DeviceId as the device identifier, over -DeviceName or -Name as because we\u0026rsquo;re in a situation where there could be duplicate machine names in the case of a client domain migration, so we need something unique.\nPutting this together, we\u0026rsquo;ve now got the installation part of the script done, leaning on the existing $SiteCode variable to pass into this part of the script:\nInstall-CMClient -DeviceId $UnmanagedDevice.ResourceID -AlwaysInstallClient $true -ForceReinstall $true -SiteCode $SiteCode.Name As mentioned previously, if you were using a device collection to capture your devices without the Configuration Manager client, you could use the -CollectionId parameter instead of -DeviceId in the above script snippet.\nInstallation Time # With everything now in place, we can do the following:\nCapture the devices we want that don\u0026rsquo;t have the client installed, excluding the built-in Configuration Manager devices and Servers Loop through each device and install the Client Write to the log file when something good or bad happens This way, we can let Configuration Manager do all our heavy lifting, without manual intervention, or trying to run something from the client side to re-install the Configuration Manager Client.\nThe full script in all it\u0026rsquo;s glory can as always be found in GitHub\n# Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + \u0026#39;\\ConfigurationManager.psd1\u0026#39;) # Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\u0026#34;:\u0026#34; # Functions Function Write-log { [CmdletBinding()] Param( [parameter(Mandatory = $true)] [String]$Path, [parameter(Mandatory = $true)] [String]$Message, [parameter(Mandatory = $true)] [String]$Component, [Parameter(Mandatory = $true)] [ValidateSet(\u0026#39;Info\u0026#39;, \u0026#39;Warning\u0026#39;, \u0026#39;Error\u0026#39;)] [String]$Type ) switch ($Type) { \u0026#39;Info\u0026#39; { [int]$Type = 1 } \u0026#39;Warning\u0026#39; { [int]$Type = 2 } \u0026#39;Error\u0026#39; { [int]$Type = 3 } } # Create a log entry $Content = \u0026#34;\u0026lt;![LOG[$Message]LOG]!\u0026gt;\u0026#34; + ` \u0026#34;\u0026lt;time=`\u0026#34;$(Get-Date -Format \u0026#39;HH:mm:ss.ffffff\u0026#39;)`\u0026#34; \u0026#34; + ` \u0026#34;date=`\u0026#34;$(Get-Date -Format \u0026#39;M-d-yyyy\u0026#39;)`\u0026#34; \u0026#34; + ` \u0026#34;component=`\u0026#34;$Component`\u0026#34; \u0026#34; + ` \u0026#34;context=`\u0026#34;$([System.Security.Principal.WindowsIdentity]::GetCurrent().Name)`\u0026#34; \u0026#34; + ` \u0026#34;type=`\u0026#34;$Type`\u0026#34; \u0026#34; + ` \u0026#34;thread=`\u0026#34;$([Threading.Thread]::CurrentThread.ManagedThreadId)`\u0026#34; \u0026#34; + ` \u0026#34;file=`\u0026#34;`\u0026#34;\u0026gt;\u0026#34; # Write the line to the log file Add-Content -Path $Path -Value $Content } # Log file location same as script $LogFilePath = Join-Path $PSScriptRoot \u0026#34;$(Get-Date -Format yyyy-MM-dd-HHmm) $($MyInvocation.MyCommand.Name).log\u0026#34; # Gets all devices without the CCM client that are not servers or inbuilt computer objects $UnmanagedDevices = Get-CMdevice | Where-Object { ($_.IsClient -eq \u0026#39;\u0026#39;) -and ($_.SMSID -notlike \u0026#39;*Unknown Computer*\u0026#39; ) -and ($_.SMSID -notlike \u0026#39;*Provisioning Device*\u0026#39;) -and ($_.DeviceOS -notlike \u0026#39;*Server*\u0026#39;) } Foreach ($UnmanagedDevice in $UnmanagedDevices) { Try { Write-Log -Path $LogFilePath -Message \u0026#34;Attempting to install CCM client on computer $($UnmanagedDevice.Name)\u0026#34; -Component $MyInvocation.MyCommand.Name -Type Info Install-CMClient -DeviceId $UnmanagedDevice.ResourceID -AlwaysInstallClient $true -ForceReinstall $true -SiteCode $SiteCode.Name } Catch { Write-Error ($_ | Out-String) Write-Log -Path $LogFilePath -Message ($_ | Out-String) -Component $MyInvocation.MyCommand.Name -Type Error } } If you need to keep this running on an on-going basis as part of a phased migration, I\u0026rsquo;d recommend hooking this into a Scheduled Task running from the Primary Site server, or if you\u0026rsquo;re feeling fancy, a Status Filter Rule to have the script triggered on an event captured by a one of the million Configuration Manager logs files for its components.\nSummary # Like I said, this one was a quick way to resolve an ongoing issue, but one that you may end up encountering if migrating clients between Configuration Manager sites, Domains, or even moving clients from a Workgroup to a Domain.\nAs always, remember to test the script in your environment, utilise the -WhatIf parameter, and update the $UnmanagedDevices variable based on your own environment requirements.\n","date":"15 December 2022","externalUrl":null,"permalink":"/posts/configmgr-client-migration/","section":"Posts","summary":"Have you ever had the pleasure of migrating Configuration Manager clients from one domain to another, or maybe between Configuration Manager environments? Tired of manually reinstalling the client from the Console? Wanting a quick and easy way to keep on top of migrated devices? You\u0026rsquo;re in luck.","title":"Reinstalling the Configuration Manager Client on Migrated Devices","type":"posts"},{"content":"So it turns out that Android based MTR (Microsoft Teams Rooms) want to enrol into Microsoft Intune using what we generally term as a legacy enrolment method in Android Device Administrator, one in fact, that is recommended to be disabled for \u0026lsquo;All Users\u0026rsquo; as it will take priority over Android Enterprise Personal Device Work Profile enrolment for personal device or BYOD (Bring Your Own Device) scenarios.\nThis seems easy enough, create a new Enrolment Restriction and assign it to a group containing the Microsoft Teams Rooms resource accounts. Done. Post over.\nWhat if you want to ensure that all these accounts, and any future accounts used for MTR get this allowance for enrolment?\nDevice Enrolment # First off is creating an Enrolment Restriction profile that allows for Android Device Administrator enrolment, secondly is how we let Intune know that the devices are corporate owned, as they will be picked up as personal devices due to the enrolment method, and finally a way to capture all the MTR resource accounts together.\nEnrolment Restrictions # We can create a new Enrolment Restriction to allow for a group of users to enrol Android devices using the Device Administrator enrolment method, and we should block personal devices as well:\nAndroid enrolment restrictions in Microsoft Intune. With the restriction now created, we need to make sure that this restriction has a higher priority than any other enrolment restriction applying to either All Users or any other group that may contains the MTR resource accounts:\nAndroid enrolment restriction priority in Microsoft Intune. Perfect.\nCorporate Device Identifiers # With the Android Device Administrator enrolment being user driven, and not a method for device enrolment that will automatically set the device as corporate owned, if we attempted to enrol these MTR devices into Intune now, we\u0026rsquo;d get an error about the platform not being supported due to us blocking personal devices in the restriction we created.\nAndroid blocked enrolment. Corporate Device Identifiers to the rescue, kind of, basically this allows us to upload a unique identifier of a device so that when a device goes through an enrolment process, Intune knows it\u0026rsquo;s a corporate owned device.\nSo if the devices are running Android 10 and above, we\u0026rsquo;re straight out of luck and need to amend our restriction profile to allow personally owned device enrolment.\nHowever, if the device has below Android 10, we can add either the device IMEI number (don\u0026rsquo;t use this) or Serial number (do use this) in Intune to identify the device as corporate.\nUtilising Dynamic Groups # With the Device Platform Enrolment restriction in place, we could do with a group to assign this restriction to, if we\u0026rsquo;re strict with our naming conventions of these resource accounts being used for the MTR, such as prefixing all account with \u0026lsquo;MTR-\u0026rsquo;, we could go with something simple and use (user.userPrincipalName -startsWith \u0026quot;MTR-\u0026quot;) as part of our rule syntax.\nSadly though, I don\u0026rsquo;t like nor trust human input when it comes to device management and Intune, so we need to find a different way that at least reduces the human error part, if not removes it entirely and ensure that all new MTR accounts are added to the restriction.\nAssigned Licenses # This is where we use some of the more advanced features of Dynamic User groups, in the multi-value properties and in particular the use of licenses assigned to users. For this, we need to understand which licenses the MTR resource accounts have assigned, and find the correlating Service Plan Id for each service contained within the licenses.\nThe below table details the common services for both the \u0026lsquo;Microsoft Teams Rooms Pro\u0026rsquo; and \u0026lsquo;Microsoft Teams Rooms Pro without Audio Conferencing\u0026rsquo; licenses that allows for enrolment into Intune, the Services, and the Service Plan Ids:\nFriendly Name Service Name Service Plan Id Azure Active Directory Premium P1 AAD_PREMIUM 41781fb2-bc02-4b7c-bd55-b576c07bb09d Microsoft 365 Phone System MCOEV 4828c8ec-dc2e-4779-b502-87ac9ce28ab7 Microsoft Intune INTUNE_A c1ec4a95-1f05-45b3-a911-aa3fa01094f5 Microsoft Teams TEAMS1 57ff2da0-773e-42df-b2af-ffb7a2317929 Skype for Business Online (Plan 2) MCOSTANDARD 0feaeb32-d00e-4d66-bd5a-43b5b83db82c Whiteboard (Plan 3) WHITEBOARD_PLAN3 4a51bca5-1eff-43f5-878c-177680f191af So with this we can attempt to construct a Dynamic User group based on these services that are assigned and enabled for the MTR accounts.\nSome Dirty Logic # So as it turns out, the above services are part of a hundred other license options, so we need a way to drill down and find only the MTR accounts with these licenses or services assigned.\nI thought long and hard (about 5 minutes tbh) and came up with the below; basically making sure the above assigned licenses exist, but the user account doesn\u0026rsquo;t have any Exchange Online or SharePoint Online license assigned and enabled, hopefully filtering out any other users or user types from the group.\nWe\u0026rsquo;re actually using the Service Name captured from the Get-AzureADUser -User 'MTR-Room1@ennbee.uk' | Select -ExpandProperty AssignedPlans PowerShell command here, to cover off all plan types under the service, as there are so many Exchange Online plan types and I want to make this as clean as possible without having to list all the Exchange Online or SharePoint Online service plan Ids.\nSo here\u0026rsquo;s the logic we\u0026rsquo;re using to find only the MTR accounts using a Dynamic Group.\nLogic Rule User is assigned a Microsoft 365 Phone System license and is enabled (user.assignedPlans -any (assignedPlan.servicePlanId -eq \u0026quot;4828c8ec-dc2e-4779-b502-87ac9ce28ab7\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) User is assigned any Intune license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \u0026quot;SCO\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) User is assigned any Teams license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \u0026quot;TeamspaceAPI\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) User is assigned any Skype for Business license and is enabled (user.assignedPlans -any (assignedPlan.service -eq \u0026quot;MicrosoftCommunicationsOnline\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) User is assigned a WhiteBoard Plan 3 license and is enabled (user.assignedPlans -any (assignedPlan.servicePlanId -eq \u0026quot;4a51bca5-1eff-43f5-878c-177680f191af\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) User is not assigned any Exchange Online license that is enabled or deleted (user.assignedPlans -all (assignedPlan.service -ne \u0026quot;exchange\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot; -or assignedPlan.capabilityStatus -eq \u0026quot;Deleted\u0026quot;)) User is not assigned any SharePoint Online license that is enabled or deleted (user.assignedPlans -all (assignedPlan.service -ne \u0026quot;SharePoint\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot; -or assignedPlan.capabilityStatus -eq \u0026quot;Deleted\u0026quot;)) Allowing Microsoft Team Room Enrolment # After all this effort, we can finally create the a group in Azure AD using some of the above and combine it to create the needed Rule Syntax.\nIn the below example, the accounts didn\u0026rsquo;t have a Microsoft 365 Phone System license so the (user.assignedPlans -any (assignedPlan.servicePlanId -eq \u0026quot;4828c8ec-dc2e-4779-b502-87ac9ce28ab7\u0026quot; -and assignedPlan.capabilityStatus -eq \u0026quot;Enabled\u0026quot;)) part of the rule was removed:\n(user.assignedPlans -any (assignedPlan.service -eq \u0026#34;SCO\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34;)) and (user.assignedPlans -any (assignedPlan.service -eq \u0026#34;TeamspaceAPI\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34;)) and (user.assignedPlans -any (assignedPlan.service -eq \u0026#34;MicrosoftCommunicationsOnline\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34;)) and (user.assignedPlans -any (assignedPlan.servicePlanId -eq \u0026#34;4a51bca5-1eff-43f5-878c-177680f191af\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34;)) and (user.assignedPlans -all (assignedPlan.service -ne \u0026#34;exchange\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34; -or assignedPlan.capabilityStatus -eq \u0026#34;Deleted\u0026#34;)) and (user.assignedPlans -all (assignedPlan.service -ne \u0026#34;SharePoint\u0026#34; -and assignedPlan.capabilityStatus -eq \u0026#34;Enabled\u0026#34; -or assignedPlan.capabilityStatus -eq \u0026#34;Deleted\u0026#34;)) The Dynamic Group # Once created we now have a group and a set of rules that you should validate in your own environment before putting into production use. You may also need to tweak the logic based on which services you have enabled as part of your MTR licensing assignment.\nIf all goes well, and you\u0026rsquo;ve managed to copy and paste successfully, you should have a group with rules like the below:\nDynamic Group rule in Entra ID. If you\u0026rsquo;re really lucky, the group will only populate with the user accounts you are using for the Microsoft Team Room systems, including the Android devices.\nDynamic Group members in Entra ID. Updating the Enrolment Restriction # Now armed with the new group, we can use this as part of the restriction to allow these users to enrol Android devices using the Android Device Administrator method:\nAndroid enrolment restriction assignment in Microsoft Intune. Summary # You\u0026rsquo;ve seen here that with a bit of time and patience, you can leverage Dynamic Groups and some of the advanced rules to your advantage, even with an edge use case like allowing only Microsoft Teams Room system accounts the ability to enrol using Android Device Administrator.\nThis is one of many applications of Dynamic Groups throughout Microsoft Intune, and although I bad mouthed them in favour of Device Filters, they are still a necessity when you need a level of advanced logic that the filters can\u0026rsquo;t handle.\n","date":"14 November 2022","externalUrl":null,"permalink":"/posts/microsoft-teams-rooms-android-device-administrator/","section":"Posts","summary":"What if you want to ensure that all of your Microsoft Teams Rooms System accounts, and any future accounts can enrol using Android Device Administrator in Microsoft Intune?","title":"Enrolling Microsoft Teams Room Systems in Intune","type":"posts"},{"content":"","date":"1 November 2022","externalUrl":null,"permalink":"/tags/authentication/","section":"Tags","summary":"","title":"Authentication","type":"tags"},{"content":"With the impending retirement of the Azure AD Graph API and ADAL authentication methods, and by impending, I mean the end of 2022, we should probably look at how we move away from the existing authentication methods I\u0026rsquo;ve been using in all of my scripts and into the new realms of MSAL (Microsoft Authentication Library).\nHold tight, this will be quick.\nBackground # The driver for this move away from the now deemed legacy ADAL (Azure Active Directory Authentication Library) authentication method, is Microsoft\u0026rsquo;s aim to move everyone and everything to PowerShell 7 core and allow for full cross-platform compatibility for PowerShell.\nThe issue with PowerShell 7 however, is that it doesn\u0026rsquo;t natively support the \u0026lsquo;old\u0026rsquo; ADAL authentication libraries only with the use of -UseWindowsPowerShell compatibility flag, hence the need to move to an alternative authentication method.\nMSAL PowerShell Module # Save reinventing the wheel, we can use the MSAL.PS module written by Jason Thompson to achieve authentication to Graph API without the reliance on PowerShell 5 and the AzureAD or ADAL PowerShell modules.\nThis module has been designed to utilise PowerShell core and subsequently be operating system agnostic, with a new device code authentication workflow for devices that have constraints around input.\nInstall-Module MSAL.PS -Scope CurrentUser So we can now use the well used Microsoft Intune PowerShell App Id, and our tenant information to authenticate using the MSAL.PS module using ths new -DeviceCode option for authentication, generating a code that we can use on any device to authenticate on behalf of our initial request:\nGet-MsalToken -ClientId \u0026#39;d1ddf0e4-d672-4dae-b554-9d5bdfd93547\u0026#39; -TenantId \u0026#39;ennbee.uk\u0026#39; -DeviceCode Opening up the presented URL https://microsoft.com/devicelogin prompts us to enter in the code we received: Device Code Entra authentication prompt. From here we can sign in with the required User Account: Sign-in prompt for Entra authentication. Confirm the Application we are signing into: Enterprise app sign-in confirmation. Finally receiving confirmation of the sign in and a prompt to close the window: Authentication confirmation. Once the Window is closed, we now have an authentication token in the shell to use to our heart\u0026rsquo;s content.\nThe New World # With a new way to acquire our Graph API token, we should look at updating the tried and tested Authentication Methods kindly provided by Microsoft in the powershell-intune-samples repo that we have been relying on to authenticate to Graph API.\nAn Updated Function # We need to update the Get-AuthToken function, and sensibly rename it, to do the following:\nDetect the new MSAL.PS PowerShell module and prompt if it\u0026rsquo;s not installed Import the MSAL.PS PowerShell module Strip out the unneeded variables Remove any and all reference to the ADAL DLL libraries Get a new authentication token Function Get-AuthTokenMSAL { \u0026lt;# .SYNOPSIS This function is used to authenticate with the Graph API REST interface .DESCRIPTION The function authenticate with the Graph API Interface with the tenant name .EXAMPLE Get-AuthTokenMSAL Authenticates you with the Graph API interface using MSAL.PS module .NOTES NAME: Get-AuthTokenMSAL #\u0026gt; [cmdletbinding()] param ( [Parameter(Mandatory = $true)] $User ) $userUpn = New-Object \u0026#39;System.Net.Mail.MailAddress\u0026#39; -ArgumentList $User if ($userUpn.Host -like \u0026#39;*onmicrosoft.com*\u0026#39;) { $tenant = Read-Host -Prompt \u0026#39;Please specify your Tenant name i.e. company.com\u0026#39; Write-Host } else { $tenant = $userUpn.Host } Write-Host \u0026#39;Checking for MSAL.PS module...\u0026#39; $MSALModule = Get-Module -Name \u0026#39;MSAL.PS\u0026#39; -ListAvailable if ($null -eq $MSALModule) { Write-Host Write-Host \u0026#39;MSAL.PS Powershell module not installed...\u0026#39; -f Red Write-Host \u0026#34;Install by running \u0026#39;Install-Module MSAL.PS -Scope CurrentUser\u0026#39; from an elevated PowerShell prompt\u0026#34; -f Yellow Write-Host \u0026#34;Script can\u0026#39;t continue...\u0026#34; -f Red Write-Host exit } if ($MSALModule.count -gt 1) { $Latest_Version = ($MSALModule | Select-Object version | Sort-Object)[-1] $MSALModule = $MSALModule | Where-Object { $_.version -eq $Latest_Version.version } # Checking if there are multiple versions of the same module found if ($MSALModule.count -gt 1) { $MSALModule = $MSALModule | Select-Object -Unique } } $ClientId = \u0026#39;d1ddf0e4-d672-4dae-b554-9d5bdfd93547\u0026#39; $RedirectUri = \u0026#39;urn:ietf:wg:oauth:2.0:oob\u0026#39; $Authority = \u0026#34;https://login.microsoftonline.com/$Tenant\u0026#34; try { Import-Module $MSALModule.Name if ($PSVersionTable.PSVersion.Major -ne 7) { $authResult = Get-MsalToken -ClientId $ClientId -Interactive -RedirectUri $RedirectUri -Authority $Authority } else { $authResult = Get-MsalToken -ClientId $ClientId -Interactive -RedirectUri $RedirectUri -Authority $Authority -DeviceCode } # If the accesstoken is valid then create the authentication header if ($authResult.AccessToken) { # Creating header for Authorization token $authHeader = @{ \u0026#39;Content-Type\u0026#39; = \u0026#39;application/json\u0026#39; \u0026#39;Authorization\u0026#39; = \u0026#39;Bearer \u0026#39; + $authResult.AccessToken \u0026#39;ExpiresOn\u0026#39; = $authResult.ExpiresOn } return $authHeader } else { Write-Host Write-Host \u0026#39;Authorization Access Token is null, please re-run authentication...\u0026#39; -ForegroundColor Red Write-Host break } } catch { Write-Host $_.Exception.Message -f Red Write-Host $_.Exception.ItemName -f Red Write-Host break } } Updating Authentication Method # With the new Get-AuthTokenMSAL function in our arsenal, we can quickly update the authentication method to call this function.\nif ($global:authToken) { $DateTime = (Get-Date).ToUniversalTime() $TokenExpires = ($authToken.ExpiresOn.datetime - $DateTime).Minutes if ($TokenExpires -le 0) { Write-Host \u0026#39;Authentication Token expired\u0026#39; $TokenExpires \u0026#39;minutes ago\u0026#39; -ForegroundColor Yellow if ($null -eq $User -or $User -eq \u0026#39;\u0026#39;) { $User = Read-Host -Prompt \u0026#39;Please specify your user principal name for Azure Authentication\u0026#39; } $global:authToken = Get-AuthTokenMSAL -User $User Write-Host \u0026#39;Connected to Graph API\u0026#39; -ForegroundColor Green } Else { Write-Host \u0026#39;Connected to Graph API\u0026#39; -ForegroundColor Green } } else { if ($null -eq $User -or $User -eq \u0026#39;\u0026#39;) { $User = Read-Host -Prompt \u0026#39;Please specify your user principal name for Azure Authentication\u0026#39; } $global:authToken = Get-AuthTokenMSAL -User $User Write-Host \u0026#39;Connected to Graph API\u0026#39; -ForegroundColor Green } Running both the function and authentication code gives us something like the below:\nPowerShell Graph authentication notification. And once you\u0026rsquo;ve run through the Device Code authentication method show earlier, it will give you the token you need in the $authToken variable to use across all the existing scripts in the powershell-intune-samples\nPowerShell Graph authentication token. Summary # With the MSAL based authentication in place, and updating scripts to use the new function and associated code, we can lean back and relax a little when Microsoft depreciates and ends the use of ADAL based authentication methods.\nIf you\u0026rsquo;d like a more detailed understanding of MSAL and how to move away from ADAL, I\u0026rsquo;d recommend having a glance over the following:\nOverview of the Microsoft Authentication Library (MSAL) Migrate applications to the Microsoft Authentication Library (MSAL) I won\u0026rsquo;t be, I\u0026rsquo;ll be tirelessly updating all my scripts to use the new authentication method. This is what happens when Microsoft extends their deadlines and gives you more time to use old technologies.\n","date":"1 November 2022","externalUrl":null,"permalink":"/posts/finally-moving-to-msal-auth/","section":"Posts","summary":"With the impending retirement of the Azure AD Graph API and ADAL authentication methods, and by impending, I mean the end of 2022, we should probably look at how we move away from the existing authentication methods.","title":"Migrating from AzureAD Authentication for Graph API","type":"posts"},{"content":"","date":"25 October 2022","externalUrl":null,"permalink":"/tags/defender/","section":"Tags","summary":"","title":"Microsoft Defender","type":"tags"},{"content":"So one of those rainy days is here, finally, and as I mentioned in a previous post many months ago, I said I\u0026rsquo;d look at ways to update other update based compliance policies periodically.\nThat time is now, and although we\u0026rsquo;re not focussing on other Operating Systems, we\u0026rsquo;re going to have a look at updating a Microsoft Defender compliance policy with the latest platform update version.\nExciting I know.\nCompliance Policy Updates # To reiterate from the previous post, and to hammer the point home, you should be updating these types of policies on a regular basis. When you update a Compliance Policy, it will trigger the devices the policy is assigned to, to re-evaluate the conditions and follow the actions for non-compliance if necessary.\nFor the Defender settings, the one we\u0026rsquo;re wanting to update is Microsoft Defender Antimalware minimum version, which if left blank will accept any version of the service, but we should be requiring an up to date version here, you know, for security.\nExisting Functions # As we have looked at this topic previously, we\u0026rsquo;re going to re-use some of the existing functions in this script that we created previously:\nTest-JSON Get-DeviceCompliancePolicy Update-DeviceCompliancePolicy We will also need to create a new one, to retrieve the latest Microsoft Defender Update using the Microsoft Feed Picker for Microsoft Defender Updates.\nGetting Latest Platform Update Version # So the feed we\u0026rsquo;ll be using, doesn\u0026rsquo;t actually contain the platform update version, unlike the Windows Operating System feeds which put the information we needed on a plate, this time we need to work a little.\nWe can at least use our previous attempts at capturing the RSS data, but this time, instead of grabbing the data from the feed itself and working with it, we need to grab the link that exists in the feed, grab the data from that page in order to get the version information we need to update the Compliance Policy.\nWe can capture the link we need and associate with the variable $DefenderUpdateUri, and using a bit of magic, we can scrape the data from this link, and capture only the information we need, in this instance it\u0026rsquo;s the \u0026lsquo;New version\u0026rsquo; section of the page:\n$uri = \u0026#39;https://support.microsoft.com/en-us/feed/atom/5d4715e7-a9c9-378e-3f83-fd410db4ef0a\u0026#39; [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \u0026#39;application/xml\u0026#39;).Content -replace \u0026#39;[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\u0026#39;, \u0026#39;\u0026#39; $DefenderUpdateUri = @() foreach ($Update in $Updates.feed.entry) { if ($Update.title.\u0026#39;#text\u0026#39; -like \u0026#39;*platform*\u0026#39;) { $DefenderUpdateUri += $Update.link.href } } $DefenderPlatformUpdate = Invoke-WebRequest -Uri $($DefenderUpdateUri[0]) $DefenderPlatformVersion = (($DefenderPlatformUpdate.Content).tostring() -split \u0026#34;[`r`n]\u0026#34; | Select-String \u0026#39;New version:\u0026#39;) -replace \u0026#39;[^0-9.]\u0026#39; Yes I know this is rough af, yes I know I am relying on the data existing on the page, yes I know that splitting out raw content into separate lines, selecting string data containing the information I want and stripping away everything but the numbers and periods is absolutely awful, this was a quick script OK, I\u0026rsquo;ll give myself a dead leg as penance. A New Function is Born # So with this absolute atrocity of a method of getting the platform update version, we should wrap it all nicely into a function so we can call it in the script.\nFunction Get-LatestDefenderPlatformUpdate() { try { $uri = \u0026#39;https://support.microsoft.com/en-us/feed/atom/5d4715e7-a9c9-378e-3f83-fd410db4ef0a\u0026#39; [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \u0026#39;application/xml\u0026#39;).Content -replace \u0026#39;[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\u0026#39;, \u0026#39;\u0026#39; $DefenderUpdateUri = @() foreach ($Update in $Updates.feed.entry) { if ($Update.title.\u0026#39;#text\u0026#39; -like \u0026#39;*platform*\u0026#39;) { $DefenderUpdateUri += $Update.link.href } } $DefenderPlatformUpdate = Invoke-WebRequest -Uri $($DefenderUpdateUri[0]) $DefenderPlatformVersion = (($DefenderPlatformUpdate.Content).tostring() -split \u0026#34;[`r`n]\u0026#34; | Select-String \u0026#39;New version:\u0026#39;) -replace \u0026#39;[^0-9.]\u0026#39; Write-Host Write-Host \u0026#34;Latest Defender Platform - $DefenderPlatformVersion\u0026#34; -ForegroundColor Cyan $DefenderPlatformVersion } catch { Write-Error $Error[0].ErrorDetails.Message break } } Updating Compliance Policies # So with all the functions we need, we can attack the script that will actually update the Compliance Policy. As we\u0026rsquo;ve done something similar previously, I don\u0026rsquo;t need to use my brain too much to hack around with the existing script, but there are some key areas to focus on\u0026hellip;\nGetting the Defender Policy # We need to make sure we\u0026rsquo;re grabbing the Defender policies for Windows devices so a little bit of a filter here. We\u0026rsquo;re using the @odata.type and the defenderEnabled data here.\n$DefenderCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#39;windows10CompliancePolicy\u0026#39;) -and ($_.defenderEnabled) -ne \u0026#39;\u0026#39; } Building the JSON Content # We need to build the JSON content to update the Compliance Policy with, based on the existing data and the new Microsoft Defender Platform version. We also can use a bit of logic to see if the current version in the Compliance Policy is less than the new one, so we\u0026rsquo;re not needlessly updating the policy.\n$Date = Get-Date $Description = \u0026#34;Updated Defender Antivirus Compliance Policy on $Date\u0026#34; $DefenderPlatformVersion = Get-LatestDefenderPlatformUpdate $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.windows10CompliancePolicy\u0026#39; $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $Description foreach ($DefenderCompliancePolicy in $DefenderCompliancePolicies) { if ($DefenderCompliancePolicy.defenderVersion -lt $DefenderPlatformVersion) { Write-Host Write-Host \u0026#34;Updating Defender Antivirus Compliance Policy - $($DefenderCompliancePolicy.displayname)\u0026#34; -ForegroundColor Green $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;defenderVersion\u0026#39; -Value $DefenderPlatformVersion # Creating JSON object to pass to Graph $JSON = $Update | ConvertTo-Json -Depth 3 # Updating the compliance policy Update-DeviceCompliancePolicy -Id $DefenderCompliancePolicy.id -JSON $JSON } else { Write-host \u0026#34;Defender Antivirus Compliance Policy - $($DefenderCompliancePolicy.displayname) already up to date\u0026#34; -ForegroundColor Cyan } } Running the Script # First off let\u0026rsquo;s look at the existing out-of-date Defender Compliance Policy, yup, that\u0026rsquo;s an old version of the platform:\nDefender Compliance Policy in Microsoft Intune. We should run the script, and make use of the hour it took to write it:\n.\\Set-DefenderCompliance.ps1 Running the script will prompt you to provide a username and connect to Graph, please do what it says and login:\nAn Entra ID authentication prompt. Then it does it\u0026rsquo;s job:\nThe PowerShell script updating the Compliance Policy. Checking the policy to see if it updated:\nUpdated Defender compliance policy in Microsoft Intune. And it did, I\u0026rsquo;m as surprised as you are tbh.\nSummary # The whole script is pretty shoddy even for the minimal effort it took, but it is functional (as of today), that\u0026rsquo;s the main thing.\nThe things you do when customers ask you about automating the recommendations you present to them eh?\n","date":"25 October 2022","externalUrl":null,"permalink":"/posts/defender-antivirus-compliance-updates/","section":"Posts","summary":"We\u0026rsquo;re going to have a look at updating a Microsoft Defender compliance policy with the latest platform update version, automatically.","title":"Updating Defender Antivirus Compliance Settings","type":"posts"},{"content":"","date":"27 September 2022","externalUrl":null,"permalink":"/tags/google/","section":"Tags","summary":"","title":"Google","type":"tags"},{"content":"We\u0026rsquo;ve all had to add Managed Google Play Apps in bulk to Microsoft Intune for your Android Enterprise enrolled devices, whether this is just the raft of Microsoft Apps now that all your data is in Office 365, or the hundreds you have in a rival MDM (Mobile Device Management) solution that you\u0026rsquo;re looking to migrate away from.\nAnyone fancy doing this one by one with lots of mouse clicks and early onset repetitive strain injury? Didn\u0026rsquo;t think so.\nThis will be a quick one, and annoyingly does require a bit of effort to get the app details\u0026hellip;more on that later though. Onto the fun part.\nManaged Google Play Apps # As always we\u0026rsquo;re leaning on Graph again, as with everything in Microsoft Intune, and knowing we\u0026rsquo;ve setup our Managed Google Play account already, we can leverage this to add some Android Enterprise Apps into our tenant.\nAndroid Enterprise apps can\u0026rsquo;t be added to Microsoft Intune in the same way as iOS Store Apps or even Play Store Apps, so we can\u0026rsquo;t use POST /deviceAppManagement/mobileApps for creating these in the tenant. All the work is done at the Google side, so luckily we have a way to call this via the Graph API.\nApproving and Syncing Applications # We\u0026rsquo;re not actually creating anything here, all the Apps and the associated data exists within the Managed Play Store, what we need to do is approve an app. We can use the POST /deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps action to our advantage.\nWe can make a POST call to https://graph.microsoft.com/beta/deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps with some JSON to approve the applications we need.\nThe JSON format we need to pass through using this call is in the format below.\n{ \u0026#34;packageIds\u0026#34;: [ \u0026#34;Package Ids value\u0026#34; ], \u0026#34;approveAllPermissions\u0026#34;: true } What Microsoft don\u0026rsquo;t tell you in the documentation is that the \u0026ldquo;Package Ids value\u0026rdquo; actually needs to be in the format \u0026ldquo;app:PackageId\u0026rdquo;, i.e. \u0026ldquo;app:com.microsoft.emmx\u0026rdquo;, thanks Microsoft. So we\u0026rsquo;ve got the bare bones of an idea, so what we need to do is get our App Package Ids together for all the Mobile Apps we want. What? You don\u0026rsquo;t have these to hand? Well sadly there isn\u0026rsquo;t a \u0026lsquo;scripty\u0026rsquo; way of getting these, not for free at least, so I\u0026rsquo;ll do you a solid and provide a list of some of the common Microsoft ones.\nMobile App Name Package ID Microsoft Authenticator com.azure.authenticator Microsoft Edge com.microsoft.emmx Microsoft Excel com.microsoft.office.excel Microsoft OneDrive com.microsoft.skydrive Microsoft OneNote com.microsoft.office.onenote Microsoft Outlook com.microsoft.office.outlook Microsoft Planner com.microsoft.planner Microsoft PowerPoint com.microsoft.office.powerpoint Microsoft SharePoint com.microsoft.sharepoint Microsoft Stream com.microsoft.stream Microsoft Teams com.microsoft.teams Microsoft To Do com.microsoft.todos Microsoft Word com.microsoft.office.word Microsoft Yammer com.yammer.v1 For any others, maybe your existing MDM has them listed next the App Name, otherwise you can find an app\u0026rsquo;s package name in the URL of the app‚Äôs Google Play Store listing.\nFor example, the URL of an app page is play.google.com/store/apps/details?id=com.example.app123. The app\u0026rsquo;s package name is com.example.app123.\nAs we\u0026rsquo;re using PowerShell, we could do with throwing these Package Ids into an array of some sort, just so we can loop through them later on.\n$AndroidAppIds = New-Object -TypeName System.Collections.ArrayList $AndroidAppIds.AddRange(@( \u0026#39;com.azure.authenticator\u0026#39;, \u0026#39;com.microsoft.emmx\u0026#39;, \u0026#39;com.microsoft.office.excel\u0026#39;, \u0026#39;com.microsoft.skydrive\u0026#39;, \u0026#39;com.microsoft.office.onenote\u0026#39;, \u0026#39;com.microsoft.office.outlook\u0026#39;, \u0026#39;com.microsoft.planner\u0026#39;, \u0026#39;com.microsoft.office.powerpoint\u0026#39;, \u0026#39;com.microsoft.sharepoint\u0026#39;, \u0026#39;com.microsoft.stream\u0026#39;, \u0026#39;com.microsoft.teams\u0026#39;, \u0026#39;com.microsoft.todos\u0026#39;, \u0026#39;com.microsoft.office.word\u0026#39;, \u0026#39;com.yammer.v1\u0026#39; ) ) We could have also prefixed the Package Id with the required \u0026lsquo;app:\u0026rsquo; but that\u0026rsquo;s one for later me.\nThe Functions # Now we have our list of Package Ids for the Mobile Apps in a nice format, we need to build a couple of functions (obviously) to approve the Mobile Apps and then synchronise the Apps to the Microsoft Intune tenant.\nApproving Managed Google Apps # You would have seen this format for Graph functions a lot on this site, but the important thing here is how we\u0026rsquo;re building the JSON object and adding in the required prefix.\nFunction Add-GoogleApplication() { param ( $PackageID ) $graphApiVersion = \u0026#39;Beta\u0026#39; $App_resource = \u0026#39;deviceManagement/androidManagedStoreAccountEnterpriseSettings/approveApps\u0026#39; try { if (!$PackageID) {} Write-Host \u0026#39;No PackageID was passed to the function, provide a valid PackageID variable\u0026#39; -f Red break } $PackageID = \u0026#39;app:\u0026#39; + $PackageID $Packages = New-Object -TypeName psobject $Packages | Add-Member -MemberType NoteProperty -Name \u0026#39;approveAllPermissions\u0026#39; -Value \u0026#39;true\u0026#39; $Packages | Add-Member -MemberType NoteProperty -Name \u0026#39;packageIds\u0026#39; -Value @($PackageID) $JSON = $Packages | ConvertTo-Json -Depth 3 $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($App_resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -ContentType \u0026#39;application/json\u0026#39; -Body $JSON write-host \u0026#34;Successfully added $PackageID from Managed Google Store\u0026#34; -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } Synchronising Managed Google Apps # Now that we have a way to Approve the apps, we need a way to sync them\u0026hellip;bring on the POST /deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps the below function, and a POST call to the below URI\nhttps://graph.microsoft.com/beta/deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps Function Invoke-SyncGoogleApplication() { [cmdletbinding()] param ( $PackageID ) $graphApiVersion = \u0026#39;Beta\u0026#39; $App_resource = \u0026#39;deviceManagement/androidManagedStoreAccountEnterpriseSettings/syncApps\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($App_resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -ContentType \u0026#39;application/json\u0026#39; -Body $JSON Write-Host \u0026#34;Successfully synchronised Google Apps\u0026#34; -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } Running the Script # Throwing in the Get-AuthTokenMSAL function we know and love to the above functions, the authentication section to Graph API, the array variable we created, and the below little snippet of a foreach loop, we can happily run through each of the Mobile App Package Ids and approve them, rounding it off with a quick sync.\nforeach($AndroidAppId in $AndroidAppIds) { Add-GoogleApplication -PackageID $AndroidAppId } Invoke-SyncGoogleApplication The full Script can be found in my GitHub Repo and as always, please test this before adding hundreds of apps to the variable, you\u0026rsquo;ll thank me later.\nRunning the script gives us the following output:\nPowerShell script output. After a little while, we\u0026rsquo;ll see the Mobile Apps in the Microsoft Intune Android Apps Portal:\nMicrosoft Intune approved android apps. With the Mobile Apps now in the tenant, you can go ahead and assign them to your hearts content\u0026hellip;or maybe script something to do this for you?\nSummary # Even if grabbing the packageId for each mobile app you want to approve and synchronise to Microsoft Intune is a a bit of a pain, and trust me, I looked at free ways to query the Play Store, this at least cuts the time down for synchronising Managed Google Play apps, especially as part of a migration to Intune.\n","date":"27 September 2022","externalUrl":null,"permalink":"/posts/approving-managed-google-play-apps/","section":"Posts","summary":"We\u0026rsquo;ve all had to add Managed Google Play Apps in bulk to Microsoft Intune for your Android Enterprise enrolled devices, sometimes in the hundreds, let\u0026rsquo;s see if we can make this easier and less clicky.","title":"The Easy Way to Approve Managed Google Play Apps","type":"posts"},{"content":"Everyone likes managing clients apps in Microsoft Intune, the grind of packing Windows apps, the chore of selecting Managed Google Play apps, the joy of assigning Apple VPP app licenses in Apple Business Manager\u0026hellip;all good fun.\nWhat about assigning App Categories, do you want to be manually updating hundreds of Apps with categories? Let\u0026rsquo;s make one laborious task, less laborious, with a hacky PowerShell script.\nApp Categories # Microsoft Intune comes with a number of in-built App Categories, that you can assign to a subset of Applications, to make it easier for users to find the apps they need using the Company Portal.\nThe Company Portal. As these are designed for use in the Company Portal, not all Apps can have categories assigned to them, mainly Managed Google Play apps, everything else we\u0026rsquo;ll have a crack at.\nThe original list of categories is a little limited, and might not fit your application estate. Original Microsoft Intune App Categories. So we should do something about this.\nCreating App Categories # You could just create new app categories using Microsoft Intune, but I\u0026rsquo;m not sure that\u0026rsquo;s as exciting as you think it is, so we\u0026rsquo;ll do this the sensible way and script it. To do this, we will need a way to get the existing App Categories (so we don\u0026rsquo;t create duplicates) and of course a way to create new ones.\nAs always, it\u0026rsquo;s time for some authentication to Graph API and using the trusted Authentication function we\u0026rsquo;ve used time and time before.\nConnect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementConfiguration.ReadWrite.All'. Getting App Categories # We\u0026rsquo;ll be using the GET /deviceAppManagement/mobileAppCategories part of Graph for most of this, and the List option to get all existing categories using the function below.\nFunction Get-AppCategory() { [cmdletbinding()] $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceAppManagement/mobileAppCategories\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Adding App Categories # Sticking with mobileAppCategories section of Graph and using the POST /deviceAppManagement/mobileAppCategories to create new App Categories, we can push new App Categories to Microsoft Intune and all we need is the below function and a name of the category.\nFunction Add-AppCategory() { [cmdletbinding()] param ( $Name ) $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceAppManagement/mobileAppCategories\u0026#34; try { if ($Name -eq \u0026#34;\u0026#34; -or $null -eq $Name) { write-host \u0026#34;No name specified, please specify valid Name for the App Category...\u0026#34; -f Red break } else { $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#34;@odata.type\u0026#34; -Value \u0026#34;#microsoft.graph.mobileAppCategory\u0026#34; $Output | Add-Member -MemberType NoteProperty \u0026#34;displayName\u0026#34; -Value $Name $JSON = $Output | ConvertTo-Json -Depth 3 Test-JSON -JSON $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri-Method Post -Body $JSON -ContentType \u0026#34;application/json\u0026#34; } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Updating Mobile Apps # So we have a way to create new App Categories in Microsoft Intune, so we\u0026rsquo;re a third of the way there, we now need a way to get Mobile Apps, get the App Categories assigned to the Mobile Apps, and then add new App Categories. This all seemed more straightforward when I first started this.\nGetting Mobile Apps # Oh we do love Graph here don\u0026rsquo;t we\u0026hellip;more use of Graph and in particular GET /deviceAppManagement/mobileApps, we\u0026rsquo;ll use this to get existing Mobile Apps, be warned though, this resource type will pull back all apps, whether Client Apps or Mobile Application Managed Apps, so we\u0026rsquo;ll need to use some filtering further down the line.\nFunction Get-MobileApps() { [cmdletbinding()] $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#39;deviceAppManagement/mobileApps\u0026#39; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Getting Mobile App assigned App Categories # We will also need to get the App Categories assigned to each Mobile App, as I thought best we have an option to remove some categories as well as add them.\nFunction Get-MobileAppsCategory() { [cmdletbinding()] param ( $Id ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/categories\u0026#34; try { if ($Id -eq \u0026#39;\u0026#39; -or $null -eq $Id) { Write-Host \u0026#39;No Id specified, please specify valid Id for the Mobile App...\u0026#39; -f Red break } else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } } catch { Write-Error $Error[0].ErrorDetails.Message break } } App Categories for Mobile Apps # Not to hammer the point home, but you could go through each Mobile App and assign the new categories, and if you truly hate yourself, feel free to do this manually. However, we should continue on this scripting path and finish the job we started.\nAssigning App Categories # More functions to play with, this time one to assign App Categories to a Mobile App, nothing special here but we\u0026rsquo;ll need to pass through the $Id of the Mobile App and the $CategoryId of the Category.\nOne little weird one here, need to through in a $ref at the end of the uri for the call to Graph, shout out to the Intune Support Team on YouTube for this bit of information.\nFunction Add-MobileAppCategory() { [cmdletbinding()] param ( $Id, $CategoryId ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/categories/`$ref\u0026#34; try { if ($Id -eq \u0026#39;\u0026#39; -or $null -eq $Id) { Write-Host \u0026#39;No Mobile App ID specified, please specify valid Id for the Mobile App ID...\u0026#39; -f Red break } elseif ($CategoryId -eq \u0026#39;\u0026#39; -or $null -eq $CategoryId) { Write-Host \u0026#39;No App Category ID specified, please specify valid ID for the App Category...\u0026#39; -f Red break } else { $value = \u0026#34;https://graph.microsoft.com/$graphApiVersion/deviceAppManagement/mobileAppCategories/$CategoryId\u0026#34; $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.id\u0026#39; -Value $value $JSON = $Output | ConvertTo-Json -Depth 3 Test-JSON -JSON $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri-Method Post -Body $JSON -ContentType \u0026#39;application/json\u0026#39; } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Removing Assigned App Categories # Last function for today, one to remove the App Category from a Mobile App\u0026hellip;we\u0026rsquo;ll use this one later on.\nFunction Remove-MobileAppCategory() { [cmdletbinding()] param ( $Id, $CategoryId ) $graphApiVersion = \u0026#39;Beta\u0026#39; $Resource = \u0026#34;deviceAppManagement/mobileApps/$Id/categories/$CategoryId/`$ref\u0026#34; try { if ($Id -eq \u0026#39;\u0026#39; -or $null -eq $Id) { Write-Host \u0026#39;No Mobile App ID specified, please specify valid Id for the Mobile App ID...\u0026#39; -f Red break } elseif ($CategoryId -eq \u0026#39;\u0026#39; -or $null -eq $CategoryId) { Write-Host \u0026#39;No App Category ID specified, please specify valid ID for the App Category...\u0026#39; -f Red break } else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri-Method Delete } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Repeatable Actions # The likelihood is that creation of App Categories is going to be a one-off task, but the assignment and removal of the categories might be a regular occurrence in your Microsoft Intune environment, so I thought we\u0026rsquo;d deal with four differing use cases:\nCreation of new App Categories: Upload a CSV file with the new categories in Creation of new App Categories and Assign the App Categories: still a CSV upload but follows on with assignment options Assign App Categories: plain assignment of categories to Mobile Apps Removal of Assign App Categories: Ronseal Options Everywhere # So we\u0026rsquo;ll use a simple prompt and choice option in the script to set the $setting variable, and use this to denote what actions we take.\nWrite-Host \u0026#39;********************************************************************************\u0026#39; Write-Host \u0026#39;**** Welcome to the Microsoft Intune App Category and Assignment Tool ****\u0026#39; -ForegroundColor Green Write-Host \u0026#39;**** This Script will add new app categories and assign them ****\u0026#39; -ForegroundColor Cyan Write-Host \u0026#39;********************************************************************************\u0026#39; Write-Host Write-Host \u0026#39; Please Choose one of the options below: \u0026#39; -ForegroundColor Yellow Write-Host Write-Host \u0026#39; (1) Upload a CSV of new App Categories...\u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (2) Upload a CSV of new App Categories and assign App Categories to Apps...\u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (3) Assign App Categories to Apps...\u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (4) Remove Assigned App Categories from Apps...\u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (E) EXIT SCRIPT \u0026#39; -ForegroundColor Red Write-Host $Choice_Number = \u0026#39;\u0026#39; $Choice_Number = Read-Host -Prompt \u0026#39;Based on which option you want to run, please type 1, 2 or E to exit the script, then hit enter \u0026#39; while ( !($Choice_Number -eq \u0026#39;1\u0026#39; -or $Choice_Number -eq \u0026#39;2\u0026#39; -or $Choice_Number -eq \u0026#39;3\u0026#39; -or $Choice_Number -eq \u0026#39;4\u0026#39; -or $Choice_Number -eq \u0026#39;E\u0026#39;)) { $Choice_Number = Read-Host -Prompt \u0026#39;Invalid Option, Based on which option you want to run, please type 1, 2, 3, 4 or E to exit the test, then click enter \u0026#39; } if ($Choice_Number -eq \u0026#39;E\u0026#39;) { Break } if ($Choice_Number -eq \u0026#39;1\u0026#39;) { $Setting = \u0026#39;Upload\u0026#39; } if ($Choice_Number -eq \u0026#39;2\u0026#39;) { $Setting = \u0026#39;Upload/Assign\u0026#39; } if ($Choice_Number -eq \u0026#39;3\u0026#39;) { $Setting = \u0026#39;Assign\u0026#39; } if ($Choice_Number -eq \u0026#39;4\u0026#39;) { $Setting = \u0026#39;Remove\u0026#39; } Handling the Options # Because we now have the variable to play with, we can use some wonderful if statements to deal with the options depending on what has been selected when running the script:\nUpload Assign Remove The below goes into more detail on how each option is handled by the script.\nUpload # This section will prompt for a CSV file containing new App Categories, make sure you\u0026rsquo;ve got a heading of \u0026lsquo;Name\u0026rsquo; in this file, otherwise things will be painful for you.\nName\rWeb Browsers\rMedia Players\rData Management Once uploaded the script will check for existing App Categories of the same name, safely ignore any it finds, and create new ones.\nif ($Setting -like \u0026#39;*Upload*\u0026#39;) { $CSVPath = Read-Host \u0026#39;Please provide the path to the CSV file containing a list of App Categories e.g. C:\\temp\\appcategories.csv\u0026#39; if (!(Test-Path \u0026#34;$CSVPath\u0026#34;)) { Write-Host \u0026#34;Import Path for CSV file doesn\u0026#39;t exist\u0026#34; -ForegroundColor Red Write-Host \u0026#34;Script can\u0026#39;t continue\u0026#34; -ForegroundColor Red Write-Host break } else { $AppCategories = Import-Csv -Path $CSVPath } $CurrentAppCategories = (Get-AppCategory).displayName foreach ($AppCategory in $AppCategories) { if ($AppCategory.Name -in $CurrentAppCategories) { Write-Host \u0026#39;App Category \u0026#39;$AppCategory.Name\u0026#39; already exists...\u0026#39; -ForegroundColor Yellow Write-Host } else { Write-Host \u0026#39;App Category will be created...\u0026#39; -ForegroundColor Yellow Write-Host try { Add-AppCategory -Name $AppCategory.Name | Out-Null Write-Host \u0026#39;App Category \u0026#39;$AppCategory.Name\u0026#39; created...\u0026#39; -ForegroundColor Green Write-Host } catch { Write-Host \u0026#39;App Category \u0026#39;$AppCategory.Name\u0026#39; not created...\u0026#39; -ForegroundColor Red Write-Host } } } } Assign # Whether you have uploaded new App Categories, or just want to use the existing ones, now is the time to assign them to the Mobile Apps, so we need a way for you to select not only the Mobile Apps but also the App Categories you want to assign to them. We\u0026rsquo;ve done this wis a simple Out-Gridview and a variable.\nif ($Setting -like \u0026#39;*Assign*\u0026#39;) { Write-Host \u0026#39;When prompted, wait for all Mobile Apps to load, then select the App or Apps you want to assign a Category. Use The ENTER Key or Mouse \\ OK Button.\u0026#39; -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $MobileApps = @(Get-MobileApps | Where-Object { (!($_.\u0026#39;@odata.type\u0026#39;).Contains(\u0026#39;managed\u0026#39;)) -and (!($_.\u0026#39;@odata.type\u0026#39;).Contains(\u0026#39;android\u0026#39;)) } | Select-Object \u0026#39;@odata.type\u0026#39;, displayName, publisher, id | Out-GridView -PassThru -Title \u0026#39;Select Mobile Apps...\u0026#39;) Write-Host \u0026#39;Wait for all App Categories to load, then select the Category or Categories you want to assign to an Application. Use The ENTER Key or Mouse \\ OK Button.\u0026#39; -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $AddAppCategories = @(Get-AppCategory | Select-Object displayName, id | Out-GridView -PassThru -Title \u0026#39;Select Apps Categories...\u0026#39;) Write-Host \u0026#39;Starting assignment of Categories to Mobile Apps\u0026#39; -ForegroundColor Yellow Write-Host Write-Warning \u0026#39;Please confirm you are happy to continue assigning categories to applications\u0026#39; -WarningAction Inquire foreach ($MobileApp in $MobileApps) { $AssignedAppCategories = Get-MobileAppsCategory -Id $MobileApp.id foreach ($AddAppCategory in $AddAppCategories) { if ($AddAppCategory.displayName -in $AssignedAppCategories.displayName) { Write-Host \u0026#39;\u0026#39;$AddAppCategory.displayName\u0026#39; category already assigned to \u0026#39;$MobileApp.displayName\u0026#39;\u0026#39; -ForegroundColor Yellow Write-Host } else { Write-Host \u0026#39;Adding \u0026#39;$AddAppCategory.displayName\u0026#39; category to \u0026#39;$MobileApp.displayName\u0026#39;...\u0026#39; -ForegroundColor Yellow try { Add-MobileAppCategory -Id $MobileApp.id -CategoryId $AddAppCategory.id Write-Host \u0026#39;Added \u0026#39;$AddAppCategory.displayName\u0026#39; category to \u0026#39;$MobileApp.displayName\u0026#39;...\u0026#39; -ForegroundColor Green Write-Host } catch { Write-Host \u0026#39;Unable to add \u0026#39;$AddAppCategory.displayName\u0026#39; category to \u0026#39;$MobileApp.displayName\u0026#39;...\u0026#39; -ForegroundColor Red Write-Host } } } } } Remove # This one is a bit blunt if I\u0026rsquo;m honest, it prompts you to select the Mobile App/s you want to remove App Categories from, and then removes all of them, bit brutal, but can you be bothered selecting \u0026lsquo;OK\u0026rsquo; for each App Category you want removing? Didn\u0026rsquo;t think so.\nif ($setting -eq \u0026#39;Remove\u0026#39;) { Write-Host \u0026#39;When prompted, wait for all Mobile Apps to load, then select the App or Apps you want to remove categories from. Use The ENTER Key or Mouse \\ OK Button.\u0026#39; -ForegroundColor Yellow Write-Host Start-Sleep -Seconds $sleep $MobileApps = @(Get-MobileApps | Where-Object { (!($_.\u0026#39;@odata.type\u0026#39;).Contains(\u0026#39;managed\u0026#39;)) -and (!($_.\u0026#39;@odata.type\u0026#39;).Contains(\u0026#39;android\u0026#39;)) } | Select-Object \u0026#39;@odata.type\u0026#39;, displayName, publisher, id | Out-GridView -PassThru -Title \u0026#39;Select Mobile Apps...\u0026#39;) foreach ($MobileApp in $MobileApps) { $AssignedAppCategories = Get-MobileAppsCategory -Id $MobileApp.id If (!$AssignedAppCategories) { Write-Host \u0026#39;App \u0026#39;$MobileApp.displayName\u0026#39; has no assigned App Categories...\u0026#39; -ForegroundColor Yellow Write-Host } Else { Write-Host \u0026#39;The following App Categories for App \u0026#39;$MobileApp.displayName\u0026#39; will be removed...\u0026#39; -ForegroundColor Yellow $AssignedAppCategories.displayName Write-Host Start-Sleep -Seconds $sleep foreach ($AssignedAppCategory in $AssignedAppCategories) { Try { Remove-MobileAppCategory -Id $MobileApp.id -CategoryId $AssignedAppCategory.id Write-Host \u0026#39;App Category \u0026#39;$AssignedAppCategory.displayName\u0026#39; removed from App \u0026#39;$MobileApp.displayName\u0026#39;\u0026#39; -ForegroundColor Green Write-Host } Catch { Write-Host \u0026#39;Unable to remove App Category \u0026#39;$AssignedAppCategory.displayName\u0026#39; from App \u0026#39;$MobileApp.displayName\u0026#39;\u0026#39; -ForegroundColor Red Write-Host } } } } } Running the Script # As we\u0026rsquo;ve gone through all of this just to assign some App Categories, I guess now would be the time to provide a link to the script, and show you what it does for each of the options.\nCreating New App Categories # Running the script and selecting Option 1: The start of the PowerShell script. The new App Categories available: New Microsoft Intune App Categories. Assigning the App Categories # Running the script and selecting Option 3: The PowerShell script used to assign App Categories. Selecting the Mobile Apps: The PowerShell script selecting mobile apps. Selecting the App Categories: The PowerShell script selecting app categories. Confirming the assignment of the categories: The PowerShell script confirming app categories. The new App Categories on the Edge Mobile App: The new App Categories assigned to Microsoft Edge. Removing the Assigned App Categories # Running the script and selecting Option 4: The PowerShell script used to remove App Categories. Selecting the Mobile Apps: The PowerShell script selecting mobile apps. App Categories being removed: The PowerShell script removing app categories. No more App Categories on the Edge Mobile App: The removed App Categories assigned to Microsoft Edge. Summary # I\u0026rsquo;m impressed that you\u0026rsquo;ve gotten to the bottom of this page, as there\u0026rsquo;s way too many functions and screenshots to make the pay off worthwhile, however, what we do have here is a script that can be used regularly to update App Categories, assign them to Mobile Apps, and if you ever have a truly awful day, remove the categories from the apps.\nAll this to make an end-users life a bit easier in the Company Portal. I think I need to re-evaluate the time I spend writing scripts for user experience benefits.\n","date":"10 September 2022","externalUrl":null,"permalink":"/posts/creating-assigning-app-categories/","section":"Posts","summary":"What about assigning App Categories, do you want to be manually updating hundreds of Apps with categories? Let\u0026rsquo;s make one laborious task, less laborious, with a hacky PowerShell script.","title":"Creating and Assigning App Categories the Smart Way","type":"posts"},{"content":"What happens if you\u0026rsquo;ve allowed Windows, iOS, Android, and macOS devices to enrol into Microsoft Microsoft Intune in all kinds of ways, and now you\u0026rsquo;re in a situation where devices that should be marked as corporate are marked as personal or unknown?\nThis is more of a common situation than you think, with the need to get remote devices managed in a timely fashion, many organisations used User Driven enrolment methods, such as via the Company Portal, to enrol devices into Microsoft Intune, and without Corporate Device Identifiers, or for the case of Windows no support for them, these devices get enrolled as personal devices.\nCorporate Device Identifiers # Corporate Device Identifiers are useful for tagging devices as corporate for devices that have not yet enrolled into Microsoft Intune, but what about those that have, and what about the poor devices that just don\u0026rsquo;t have a place in the supported corporate device identifier world:\nDetails of supported corporate device identifiers in Microsoft Intune. We need to find a way to update devices we know are corporate owned and change the ownership type, sadly there isn\u0026rsquo;t a native way of doing this using Bulk Device Actions in Microsoft Intune, so Graph API and PowerShell it is.\nDevice Ownership Change # We\u0026rsquo;re going to leverage Graph API to update devices that we know should be marked as corporate, to corporate ownership in Microsoft Intune. You could manually change this within each device properties page, but if you\u0026rsquo;ve got 100\u0026rsquo;s of devices, this isn\u0026rsquo;t a task I\u0026rsquo;d be willing to do.\nWe can attack this problem in a couple of ways, three if you count manually changing device ownership, but we\u0026rsquo;ll stick with:\nSerial numbers of devices we know are corporate Groups of devices that we know are corporate Now we have options, we\u0026rsquo;d better write something to make this change for these devices.\nDevice Lists # First off is putting together the list of devices you know are corporate, now I\u0026rsquo;m hoping you have an Asset Register that contains all the serial numbers of your owned devices, so you could use this to create a CSV file, make sure the serial numbers are under the heading \u0026lsquo;SerialNumber\u0026rsquo; as we\u0026rsquo;ll need this later.\nDeviceName,SerialNumber ENB-564d71,VMware-564d710031a992c6-ca795244c03a8322 If you don\u0026rsquo;t have these serials to hand, you could probably export all data from the Microsoft Intune All Devices blade, and then filter the data to show devices with unknown or personal ownership and review them. Good luck.\nFor the group, let\u0026rsquo;s make use of Azure AD Dynamic Groups,and find a suitable way to use the query to capture the corporate devices. This could be display name, or device make and model, or device ownership not equals corporate, or a combination of all three, really you can be creative here to fit your environment.\n(device.displayName -startsWith \u0026#34;ENB-\u0026#34;) (device.deviceManufacturer -eq \u0026#34;Dell Inc.\u0026#34;) and (device.deviceModel -startsWith \u0026#34;XPS\u0026#34;) (device.deviceOSType -eq \u0026#34;Windows\u0026#34;) and (device.deviceOwnership -ne \u0026#34;Company\u0026#34;) (device.deviceOSType -eq \u0026#34;Windows\u0026#34;) and (device.deviceOwnership -ne \u0026#34;Company\u0026#34;) and (device.deviceManufacturer -eq \u0026#34;Dell Inc.\u0026#34;) and (device.deviceModel -startsWith \u0026#34;XPS\u0026#34;) and (device.displayName -startsWith \u0026#34;ENB-\u0026#34;) Managed Devices # With our list of devices, either CSV or Azure AD Group, we will need to use this data to get the Managed Device object in Microsoft Intune.\nTo do this we will need to authenticate to Graph, and as you\u0026rsquo;ve seen this one a lot on this blog already in previous posts, I won\u0026rsquo;t put the functions here, but we\u0026rsquo;re using the PowerShell Authentication Function from the Intune PowerShell Samples GitHub repo to allow us to connect to Graph.\nOnce connected, we can now look at not only getting devices, but updating the device object, time for a function or two.\nGetting Managed Devices # First off let\u0026rsquo;s use Graph to get all Managed Devices, we can use a Where-Object clause late to fine tune which device we\u0026rsquo;re getting the details of later on.\nFunction Get-ManagedDevices() { param ( [switch]$IncludeEAS, [switch]$ExcludeMDM ) $graphApiVersion = \u0026#34;beta\u0026#34; $Resource = \u0026#34;deviceManagement/managedDevices\u0026#34; try { $Count_Params = 0 if ($IncludeEAS.IsPresent) { $Count_Params++ } if ($ExcludeMDM.IsPresent) { $Count_Params++ } if ($Count_Params -gt 1) { write-warning \u0026#34;Multiple parameters set, specify a single parameter -IncludeEAS, -ExcludeMDM or no parameter against the function\u0026#34; Write-Host break } elseif ($IncludeEAS) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource\u0026#34; } elseif ($ExcludeMDM) { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=managementAgent eq \u0026#39;eas\u0026#39;\u0026#34; } else { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=managementAgent eq \u0026#39;mdm\u0026#39; and managementAgent eq \u0026#39;easmdm\u0026#39;\u0026#34; } (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Set Managed Device Ownership # Using the \u0026lsquo;patch\u0026rsquo; functionality in the Graph API, we can change an existing Managed Device object in Microsoft Intune, in this case, I was lazy and just wrote the function for device ownership, but the \u0026lsquo;patch\u0026rsquo; option would allow you to change many settings.\nThis function only needs a couple of parameters, id and ownertype.\nFunction Set-ManagedDeviceOwnership() { param ( $id, $ownertype ) $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceManagement/managedDevices\u0026#34; try { if ($id -eq \u0026#34;\u0026#34; -or $null -eq $id) { write-host \u0026#34;No Device id specified, please provide a device id...\u0026#34; -f Red break } if ($ownerType -eq \u0026#34;\u0026#34; -or $null -eq $ownerType) { write-host \u0026#34;No ownerType parameter specified, please provide an ownerType. Supported value personal or company...\u0026#34; -f Red Write-Host break } $Output = New-Object -TypeName psobject $Output | Add-Member -MemberType NoteProperty -Name \u0026#39;ownerType\u0026#39; -Value $ownerType $JSON = $Output | ConvertTo-Json -Depth 3 $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource/$ID\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Patch -Body $Json -ContentType \u0026#34;application/json\u0026#34; } catch { Write-Error $Error[0].ErrorDetails.Message break } } Importing the Devices # We have a way to get a Managed Device and change the ownership, let\u0026rsquo;s put together a way to import devices via the two previously mentioned methods, so that we can fix whatever mistakes we got ourselves into.\nSo we\u0026rsquo;ve got either a list of devices or a group of devices we want to convert, we now need to get the Microsoft Intune device ID for each of these devices, we\u0026rsquo;ll need to do this in two separate ways, one for serial number in the CSV file and one for the Azure AD device ID attribute for the members of the group.\nSerial Number # This is the easy one, we can use the Get-ManagedDevice function we created and use the where-object clause to find the exact device we want, this is the benefit of using serial numbers.\nIf ($Device.SerialNumber) { try { $ManagedDevice = Get-ManagedDevices | Where-Object { $_.serialnumber -eq $Device.SerialNumber } Write-Host \u0026#34;Found \u0026#34;$ManagedDevice.DeviceName\u0026#34; with ownership \u0026#34;$ManagedDevice.ownerType\u0026#34;\u0026#34; -ForegroundColor Cyan Write-Host } catch { Write-Host \u0026#34;Unable to find device with serial number \u0026#34;$Device.SerialNumber\u0026#34;\u0026#34; -ForegroundColor Yellow Write-Host } } We now have the Managed Device detail, and importantly the Managed Device ID we need to change the ownership.\nAzure AD Device ID # This one isn\u0026rsquo;t as straight forward, as it\u0026rsquo;s a three step process, we need to:\nGet the ID of the group based on the name Get the members of the group and their Azure AD Device ID Get the Managed Device details I could have used the AzureAD PowerShell module for this, but I didn\u0026rsquo;t want to authenticate twice, once to Graph and then again to Azure Active Directory\u0026hellip;so I created a couple of functions and the script section below to get the required Managed Device ID.\n$Group = Read-host \u0026#34;Please provide the name of the group containing members you want to convert\u0026#34; try { $id = (Get-DeviceGroup -GroupName \u0026#34;$Group\u0026#34;).id $Devices = Get-DeviceGroupMembers -id $id } catch { Write-Host \u0026#34;Unable to find the device group\u0026#34; -ForegroundColor Red Write-Host \u0026#34;Script can\u0026#39;t continue\u0026#34; -ForegroundColor Red Write-Host break } ... Else { try { $ManagedDevice = Get-ManagedDevices | Where-Object { $_.azureADDeviceId -eq $Device.deviceId } Write-Host \u0026#34;Found \u0026#34;$ManagedDevice.DeviceName\u0026#34; with ownership \u0026#34;$ManagedDevice.ownerType\u0026#34;\u0026#34; -ForegroundColor Cyan } catch { Write-Host \u0026#34;Unable to find device with name \u0026#34;$Device.DisplayName\u0026#34;\u0026#34; -ForegroundColor Yellow } } Getting the Group # Using the GET /groups resource in Graph and some filtering, we can get the ID of the group provided from the script.\nFunction Get-DeviceGroup() { param ( [string]$GroupName ) $graphApiVersion = \u0026#34;v1.0\u0026#34; $Resource = \u0026#34;dynamic groups\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource`?`$filter=displayName eq \u0026#39;$GroupName\u0026#39;\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Getting the Group Membership # Still using the GET /groups/{id}/members resource in Graph, but this time using the option to list the members of the group.\nFunction Get-DeviceGroupMembers() { param ( [string]$id ) $graphApiVersion = \u0026#34;v1.0\u0026#34; $Resource = \u0026#34;dynamic groups\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$Resource/$id/members\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Running the Script # Putting this all together gives us a way to get the required unique identifier of the Managed Device and change the ownership to corporate, all using a handful of functions.\nRunning the script, after authentication, will give you a prompt for options, as we all like a choice:\nUse a CSV file; where you\u0026rsquo;ll be prompted to provide a path to the CSV file containing device serial numbers An Azure AD group; where you\u0026rsquo;ll be prompted to provide a name of an Azure AD group that contains the devices you know are corporate Panic and exit the script After this, the script will just do it\u0026rsquo;s thing and go and get each device in either the CSV or the group, change the ownership, and then tell you about it:\nPowerShell script updating Device Ownership. You can check the results for yourself in the Microsoft Intune portal:\nA device with updated ownership status in Microsoft Intune. Testing the Script # I haven\u0026rsquo;t put an option to prompt you to continue, and definitely no \u0026lsquo;whatif\u0026rsquo; option, so I\u0026rsquo;d strongly recommend testing this with a small number of devices, whether this be via CSV or an Assigned Azure AD device group instead of a Dynamic one.\nDon\u0026rsquo;t worry though, there is logic in the script to catch errors for the following:\nIf the group can\u0026rsquo;t be found in Azure AD If the group member can\u0026rsquo;t be found in Microsoft Intune If the serial number can\u0026rsquo;t be found in Microsoft Intune If the change to ownership fails If any of the calls to Graph API fail Summary # Before you run this against your environment, just go and check your Tenant customisation settings, mainly around whether iOS/iPadOS and Android devices receive push notifications when the device ownership state changes, you may or may not want to disable this feature.\nRealistically you shouldn\u0026rsquo;t need to use this script regularly, it\u0026rsquo;s really designed to be a one-shot silver bullet approach to resolving this particular issue, you should be using the enterprise enrolment methods for devices within Microsoft Intune, especially for Windows devices.\n","date":"8 August 2022","externalUrl":null,"permalink":"/posts/updating-enrolled-device-ownership/","section":"Posts","summary":"What happens if you\u0026rsquo;ve allowed Windows, iOS, Android, and macOS devices to enrol into Microsoft Microsoft Intune in all kinds of ways, and now you\u0026rsquo;re in a situation where devices that should be marked as corporate are marked as personal or unknown?","title":"Updating Enrolled Device Ownership Status","type":"posts"},{"content":"","date":"28 July 2022","externalUrl":null,"permalink":"/tags/collections/","section":"Tags","summary":"","title":"Collections","type":"tags"},{"content":"You may be using Direct Membership Rules in your Microsoft Configuration Manager environment, but should you really for critical production collections?\nNo is the answer, there I said it. Mainly because they require actual effort and overhead to maintain, and secondly because there have been times where these memberships just plain disappear, for many different reasons, but primarily if the ConfigMgr Client is reinstalled on the device.\nSo what do we do? Aggressive PowerShell scripts obviously.\nThe Approach # We\u0026rsquo;ll need to connect to the Configuration Manager PowerShell module, which is easy enough from the Primary Site server, then carry out the following actions:\nGet the Device Collections with Direct Members Capture the Direct Members Create a new Query Membership Rule with the members Remove the existing Direct Members Logging? So let\u0026rsquo;s get at it\u0026hellip;\nConnecting via PowerShell # From the Configuration Manager server we can leverage the PowerShell Module, import it and then connect to the PSDrive where we get to run all the Configuration Manager commands\nImport-module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + \u0026#39;\\ConfigurationManager.psd1\u0026#39;) $SiteCode = Get-PSDrive -PSProvider CMSITE Set-location $SiteCode\u0026#34;:\u0026#34; Getting the Collections # I thought I\u0026rsquo;d be kind and give a couple of options to the Collection gathering, attack all of the Device Collections or, which is probably more sensible, bring up a list of collections to work with.\nWe\u0026rsquo;re doing this through a selection option at the start of the script and using Get-CMDeviceCollection:\nif ($Choice_Number -eq \u0026#39;1\u0026#39;) { Write-Host \u0026#34;Getting Device Collections with Direct Membership Rules...\u0026#34; -ForegroundColor Yellow $Collections = @(Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like \u0026#39;*SMS_CollectionRuleDirect*\u0026#39; } | Select-Object Name, CollectionID, CollectionRules | Out-GridView -PassThru -Title \u0026#39;Wait for all Collections to load, then select the Device Collections you want to convert. Use The ENTER Key or Mouse \\ OK Button.\u0026#39;) } if ($Choice_Number -eq \u0026#39;2\u0026#39;) { Write-Host \u0026#34;Getting Device Collections with Direct Membership Rules...\u0026#34; -ForegroundColor Yellow $Collections = Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like \u0026#39;*SMS_CollectionRuleDirect*\u0026#39; } | Select-Object Name, CollectionID, CollectionRules } We need to now identify whether these collection have Direct Members, so for each collection we can look at the CollectionRules attribute, and see if it contains SMS_CollectionRuleDirect:\nforeach ($Collection in $Collections) { if ($Collection.CollectionRules -like \u0026#34;*SMS_CollectionRuleDirect*\u0026#34;) { } } Now we know this collection has Direct Members, let\u0026rsquo;s get them using Get-CMDeviceCollectionDirectMembershipRule:\n$DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name Cool, easy part done.\nBuilding the Query # An easy replacement for the Direct Membership Rule is to use a List of Values Query based on System Name, so we\u0026rsquo;re going to use that, we\u0026rsquo;re going to use this as our basis for the new query once we\u0026rsquo;ve captured the Direct Members in a suitable format.\nCCM Client Computer Name # select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (\u0026#34;COMPUTER1\u0026#34;, \u0026#34;COMPUTER2\u0026#34;) AD Client Computer Name # select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\u0026#34;COMPUTER1\u0026#34;, \u0026#34;COMPUTER2\u0026#34;) We also need to get the names of the Direct Members, throw them into an Array as part of the foreach loop, then squish the Array to a String and combine the template query and the members:\n$RuleName = \u0026#34;Direct Membership Replacement Query\u0026#34; $QueryPart = \u0026#34;select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\u0026#34; if ($Collection.CollectionRules -like \u0026#34;*SMS_CollectionRuleDirect*\u0026#34;) { $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name $MembersArray = @() foreach ($DirectMember in $DirectMembers) { $MembersArray += $DirectMember.RuleName } $Members = \u0026#39;\u0026#34;{0}\u0026#34;\u0026#39; -f ($MembersArray -join \u0026#39;\u0026#34;,\u0026#34;\u0026#39;) $QueryExpression = $QueryPart + $Members + \u0026#34;)\u0026#34; } This gives us the complete query string which we can use later on to create the Query Membership Rule.\nUpdating the Rules # Using Add-CMDeviceCollectionQueryMembershipRule we can create the new rule in the Collection using the variables we created earlier:\nAdd-CMDeviceCollectionQueryMembershipRule -CollectionName $Collection.Name -QueryExpression $QueryExpression -RuleName $RuleName And after successfully creating the rule we can use Remove-CMDeviceCollectionDirectMembershipRule to loop through the existing Direct Members and remove them:\nforeach ($DirectMember in $DirectMembers) { Try { Remove-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name -ResourceID $DirectMember.ResourceID -Force } Catch { } } Running the Script # Now we have all the bits we needed in place (cough logging cough), we can launch the script and use the option to select a Collection first as a test before we run it across the entire environment.\n#Load Configuration Manager PowerShell Module Import-Module ($Env:SMS_ADMIN_UI_PATH.Substring(0, $Env:SMS_ADMIN_UI_PATH.Length - 5) + \u0026#39;\\ConfigurationManager.psd1\u0026#39;) #Get SiteCode $SiteCode = Get-PSDrive -PSProvider CMSITE Set-Location $SiteCode\u0026#34;:\u0026#34; Clear-Host $RuleName = \u0026#39;Direct Membership Replacement Query\u0026#39; # CCM Client Name #$QueryPart = \u0026#39;select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client from SMS_R_System inner join SMS_G_System_SYSTEM on SMS_G_System_SYSTEM.ResourceId = SMS_R_System.ResourceId where SMS_G_System_SYSTEM.Name in (\u0026#39; # AD Name $QueryPart = \u0026#39;select SMS_R_System.ResourceId, SMS_R_System.ResourceType, SMS_R_System.Name, SMS_R_System.SMSUniqueIdentifier, SMS_R_System.ResourceDomainORWorkgroup, SMS_R_System.Client from SMS_R_System where SMS_R_System.Name in (\u0026#39; $Merged = New-Object System.Collections.ArrayList Write-Host \u0026#39;********************************************************************************\u0026#39; Write-Host \u0026#39;**** Welcome to the Direct Membership Device Collection Converter Tool ****\u0026#39; -ForegroundColor Green Write-Host \u0026#39;**** This Script will convert Direct Memberships to Query Based Membership ****\u0026#39; -ForegroundColor Cyan Write-Host \u0026#39;*******************************************************************************\u0026#39; Write-Host Write-Host \u0026#39; Please Choose one of the options below: \u0026#39; -ForegroundColor Yellow Write-Host Write-Host \u0026#39; (1) Manually select the Device Collections your want to convert... \u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (2) Run the Script on all Device Collection in your environment... \u0026#39; -ForegroundColor Green Write-Host Write-Host \u0026#39; (E) EXIT SCRIPT \u0026#39; -ForegroundColor Red Write-Host $Choice_Number = \u0026#39;\u0026#39; $Choice_Number = Read-Host -Prompt \u0026#39;Based on which option you want to run, please type 1, 2 or E to exit the test, then click enter \u0026#39; while ( !($Choice_Number -eq \u0026#39;1\u0026#39; -or $Choice_Number -eq \u0026#39;2\u0026#39; -or $Choice_Number -eq \u0026#39;E\u0026#39;)) { $Choice_Number = Read-Host -Prompt \u0026#39;Invalid Option, Based on which option you want to run, please type 1, 2 or E to exit the test, then click enter \u0026#39; } if ($Choice_Number -eq \u0026#39;E\u0026#39;) { Break } if ($Choice_Number -eq \u0026#39;1\u0026#39;) { Write-Host \u0026#34;Getting Device Collections with Direct Membership Rules...\u0026#34; -ForegroundColor Yellow $Collections = @(Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like \u0026#39;*SMS_CollectionRuleDirect*\u0026#39; } | Select-Object Name, CollectionID, CollectionRules | Out-GridView -PassThru -Title \u0026#39;Wait for all Collections to load, then select the Device Collections you want to convert. Use The ENTER Key or Mouse \\ OK Button.\u0026#39;) } if ($Choice_Number -eq \u0026#39;2\u0026#39;) { Write-Host \u0026#34;Getting Device Collections with Direct Membership Rules...\u0026#34; -ForegroundColor Yellow $Collections = Get-CMDeviceCollection | Where-Object { $_.CollectionRules -like \u0026#39;*SMS_CollectionRuleDirect*\u0026#39; } | Select-Object Name, CollectionID, CollectionRules } if (!$Collections) { Write-Host \u0026#39;No Collections selected, please run the script again...\u0026#39; -ForegroundColor Red Break } foreach ($Collection in $Collections) { if ($Collection.CollectionRules -like \u0026#39;*SMS_CollectionRuleDirect*\u0026#39;) { $Output = New-Object -Type PSCustomObject $Output | Add-Member -type NoteProperty -Name ID -Value $Collection.CollectionID $Output | Add-Member -type NoteProperty -Name Collection -Value $Collection.Name Write-Host \u0026#34;The Collection $($Collection.Name) contains Direct Members...\u0026#34; -ForegroundColor Cyan Write-Host $DirectMembers = Get-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name Write-Host \u0026#34;Getting direct members for Collection $($Collection.Name)...\u0026#34; -ForegroundColor Cyan Write-Host $MembersArray = @() foreach ($DirectMember in $DirectMembers) { Write-Host \u0026#34;Direct Member $($DirectMember.RuleName) found.\u0026#34; -ForegroundColor Yellow $MembersArray += $DirectMember.RuleName } $Members = \u0026#39;\u0026#34;{0}\u0026#34;\u0026#39; -f ($MembersArray -join \u0026#39;\u0026#34;,\u0026#34;\u0026#39;) $Output | Add-Member -type NoteProperty -Name Members -Value $Members $QueryExpression = $QueryPart + $Members + \u0026#39;)\u0026#39; Try { Write-Host Write-Host \u0026#34;Adding Query based rule to Collection $($Collection.Name) to replace direct membership...\u0026#34; -ForegroundColor Cyan Write-Host Add-CMDeviceCollectionQueryMembershipRule -CollectionName $Collection.Name -QueryExpression $QueryExpression -RuleName $RuleName Write-Host \u0026#39;Successfully added the query.\u0026#39; -ForegroundColor Green Write-Host $Output | Add-Member -type NoteProperty -Name Success -Value True Write-Host \u0026#39;Removing Direct Membership Rules\u0026#39; -ForegroundColor Cyan Write-Host foreach ($DirectMember in $DirectMembers) { Try { Remove-CMDeviceCollectionDirectMembershipRule -CollectionName $Collection.Name -ResourceID $DirectMember.ResourceID -Force Write-Host \u0026#34;Successfully removed $($Directmember.RuleName).\u0026#34; -ForegroundColor Green Write-Host } Catch { Write-Host \u0026#34;Failed to remove $($Directmember.RuleName).\u0026#34; -ForegroundColor Red Write-Host } } } Catch { Write-Host \u0026#34;Failed to convert Direct Membership to query for Collection $($Collection.Name)\u0026#34; -ForegroundColor Red $Output | Add-Member -type NoteProperty -Name Success -Value False } $Merged.Add($Output) | Out-Null } } Write-Host Write-Host \u0026#39;Results of the Collection Conversion...\u0026#39; -ForegroundColor Green $Merged Let\u0026rsquo;s run it on a test collection we know has direct members:\nA Configuration Manager collection with direct members. Run the script from an Elevated PowerShell prompt on your Primary Site Server:\nSet-CollectionDirectToQueryMembership.ps1 Oh the Choices # Doing so will prompt you with options, oooo exciting, here we\u0026rsquo;ll select Option 1:\nThe PowerShell window with script options. Doing so will open a grid view of the collections in your Configuration Manager environment, this may take a while to load, and you should wait for them to load before selecting and confirming your Collections:\nThe PowerShell script grid view of Configuration Manager collections. Search for the Collection you want to update and select OK:\nThe PowerShell script grid view results of a search for a Configuration Manager collection. Converting the Rules # Now the magic happens, including a nice little output table of the results of the conversion:\nThe PowerShell window with the results of the script. The Results Speak for Themselves # Now the script has completed, we can go and check on the results on the Device Collection itself, look no Direct Members any more:\nA Configuration Manager collection with query based members. With the new Query in place:\nA query rule of a Configuration Manager collection. Summary # With this small but powerful script, you can remove all Direct Membership rules and use the more sustainable (and less likely to cause you problems), Query Rule on either Collections you know have Direct Members, or if you\u0026rsquo;re feeling brave, your entire set of Device Collections.\nThis saves you having to manually create the Rules, or even the collections, which would mean re-deploying configuration, updates, applications etc. to a new Collection.\nWhat a time saver.\n","date":"28 July 2022","externalUrl":null,"permalink":"/posts/configmgr-converting-direct-member-collections/","section":"Posts","summary":"You may be using Direct Membership Rules in your Microsoft Configuration Manager environment, but should you really for critical production collections?","title":"Converting Configuration Manager Direct Membership Collections","type":"posts"},{"content":"","date":"10 July 2022","externalUrl":null,"permalink":"/tags/bios/","section":"Tags","summary":"","title":"BIOS","type":"tags"},{"content":"What if you\u0026rsquo;ve only got Microsoft Intune to configure your Dell BIOS settings and not the glory that is Configuration Manager? How much do you like PowerShell, Win32 Apps and passwords in plain text?\nWell you\u0026rsquo;re in luck, I\u0026rsquo;ve thrown together something that can help you out based on a need to ensure that Secure Boot is configured for Dell laptops when it was discovered via the Windows health attestation report that around 80% of the Windows devices had it turned off.\n(Don\u0026rsquo;t worry, I checked that the devices had GPT partitions before I just launched a PowerShell script at them.)\nDell PowerShell Provider # There are several posts kicking around the internet about using Microsoft Intune to not only change or set Dell BIOS passwords, but also using CSV files to configure BIOS settings using the Dell Command | PowerShell Provider, the below are the ones I\u0026rsquo;ve found and borrowed from:\nsystanddeploy.com ccmexec.com configjon.com These posts detail ways to use the Dell PowerShell Provider to set the BIOS configurations and an Admin BIOS Password on Dell devices, so I\u0026rsquo;m only going to focus on how I\u0026rsquo;ve taken this, run with it, and made it a little easier to handle in Microsoft Intune.\nSetting up the Module # As we\u0026rsquo;re going to be packaging up the PowerShell script as a Win32App, we\u0026rsquo;ll need to ensure that not only is the script available, but also the PowerShell module (and some rogue .dll files too for some reason).\nFrom an elevated PowerShell window run the below command to save the PowerShell module to a new folder:\nSave-Module -Name DellBIOSProvider -Path C:\\Temp\\Set-DellBIOS\\ The version at the time of writing of this module is 2.6.0, which has a reliance on some of the .dll files installed from the Visual C++ Re-distributables:\nDetails of the Dell requirements for their PowerShell module. You can just copy the below required files from a machine with the Visual C++ Redistributables already installed and paste them in the DellBiosProvider\\2.6.0 folder we created saving the PowerShell module, this sounds better than packaging and pushing out more software:\nmsvcp100.dll msvcr100.dll msvcp140.dll vcruntime140.dll vcruntime140_1.dll Installing the Module # This is the bit where we use some of that there logic to check if the module is already installed on a machine, and if so, to bin it off and use the version packaged in the Win32App, then import the module.\n$ScriptPath = (Get-Location).Path if (Test-Path -Path \u0026#34;$env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\u0026#34;) { Write-Output \u0026#34;DellBIOSProvider folder already exists @ $env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider.\u0026#34; Write-Output \u0026#34;Deleting the folder...\u0026#34; Remove-Item -Path \u0026#34;$env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\u0026#34; -Recurse -Force } Write-Output \u0026#34;Copying DellBIOSProvider module to: $env:ProgramFiles\\WindowsPowerShell\\Modules\\DellBIOSProvider\u0026#34; Copy-Item -Path \u0026#34;$ScriptPath\\DellBIOSProvider\\\u0026#34; -Destination \u0026#34;$env:ProgramFiles\\WindowsPowerShell\\Modules\\\u0026#34; -Recurse -Force try { Import-Module \u0026#34;DellBIOSProvider\u0026#34; -Force -Verbose -ErrorAction Stop Write-Output \u0026#34;Importing the Dell BIOS Provider module\u0026#34; } catch { Write-Output \u0026#34;Error importing module: $_\u0026#34; exit 1 } Configuring the BIOS # With the module installed, we\u0026rsquo;d better take a look on a test device what the BIOS settings and values actually are, so after importing the module run the below command to get all the BIOS setting details:\nGet-ChildItem -path DellSmbios:\\ | ForEach-Object { Get-ChildItem -path @(\u0026#34;DellSmbios:\\\u0026#34; + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } Format-List This will dump all the existing BIOS settings, and importantly their supported values, such as:\nAttribute : BootList CurrentValue : LEGACY PossibleValues : {Legacy, Uefi} PSChildName : BootSequence Attribute : SecureBoot CurrentValue : Disabled PossibleValues : {Disabled, Enabled} PSChildName : SecureBoot So now we know what Setting and their support Values are\u0026hellip;\nBIOS Settings # Other scripts use a CSV file that contain the BIOS settings you wish to configure, but this is a little clunky as you\u0026rsquo;d need to update and package the Win32App each time, so let\u0026rsquo;s use PowerShell array variables to get these settings:\n[Parameter(Mandatory=$true,Position=2)][string[]]$Settings=@(), [Parameter(Mandatory=$true,Position=3)][string[]]$Values=@() Now that we have these parameters, we can pass through both the setting and the value to the script:\n./Set-BIOSSettings.ps1 -Settings BootList,SecureBoot -Values Uefi,Enabled With these arrays in place, we need to squish them together into a new array in order to query them later in the script:\n[int]$max = $Settings.count $NewBIOSSettings = for ($i = 0; $i -lt $max; $i++) { [PSCustomObject]@{ Setting = $Settings[$i] Value = $Values[$i] } } We end up with a $NewBIOSSettings array variable containing the settings and their values:\nSetting Value ------- ----- BootList Uefi SecureBoot Enabled Making the Changes # Now we have the settings and values, as well as the PowerShell module, we can loop through each setting and apply it to the device. We\u0026rsquo;ve got a couple of options here, whether the device has a BIOS Admin Password set or otherwise.\n$AdminPassSet = (Get-Item -Path DellSmbios:\\Security\\IsAdminPasswordSet).CurrentValue $BIOSSettings = get-childitem -path DellSmbios:\\ | ForEach-Object { get-childitem -path @(\u0026#34;DellSmbios:\\\u0026#34; + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } foreach ($NewBIOSSetting in $NewBIOSSettings) { $NewItemSetting = $NewBIOSSetting.Setting $NewItemValue = $NewBIOSSetting.Value Write-Output \u0026#34;Changing: $NewItemSetting \u0026gt; $NewItemValue\u0026#34; foreach ($BIOSSetting in $BIOSSettings | Where-Object { $_.attribute -eq $NewItemSetting }) { $SettingAttribute = $BIOSSetting.attribute $SettingCategory = $BIOSSetting.PSChildName If (($AdminPassSet -eq $true)) { Try { Set-Item -Path Dellsmbios:\\$SettingCategory\\$SettingAttribute -Value $NewItemValue -Password $Password Write-Output \u0026#34;New value for $SettingAttribute is $NewItemValue\u0026#34; New-ItemProperty -Path \u0026#34;$DetectionRegPath\u0026#34; -Name \u0026#34;$SettingAttribute\u0026#34; -Value \u0026#34;$NewItemValue\u0026#34; -Force | Out-Null } Catch { Write-Output \u0026#34;Cannot change setting $SettingAttribute (Return code $_)\u0026#34; } } Else { Try { Set-Item -Path Dellsmbios:\\$SettingCategory\\$SettingAttribute -Value $NewItemValue Write-Output \u0026#34;New value for $SettingAttribute is $NewItemValue\u0026#34; New-ItemProperty -Path \u0026#34;$DetectionRegPath\u0026#34; -Name \u0026#34;$SettingAttribute\u0026#34; -Value \u0026#34;$NewItemValue\u0026#34; -Force | Out-Null } Catch { Write-Output\u0026#34;Cannot change setting $Attribute (Return code $_)\u0026#34; } } } } App Deployment # Detection Methods # We could do with a method to detect whether they have been set successfully. We can use the detection method functionality of the Win32App, and in particular the registry detection method, so using the script we can set registry values using PowerShell and query them from Microsoft Intune.\nWe will create a new Registry Key, and then for each BIOS setting we configure, can create new registry values with the name of the setting and the value they have been configured to, i.e. \u0026lsquo;SecureBoot\u0026rsquo; and \u0026lsquo;Enabled\u0026rsquo;.\n$DetectionRegPath = \u0026#34;HKLM:\\SOFTWARE\\IntuneHelper\\DellBIOSProvider\u0026#34; New-ItemProperty -Path \u0026#34;$DetectionRegPath\u0026#34; -Name \u0026#34;$SettingAttribute\u0026#34; -Value \u0026#34;$NewItemValue\u0026#34; -Force | Out-Null App Packaging # Now that we have the whole script, which you can download along with the PowerShell Module and dll files (if you cba to do it yourself), we need to wrap this content up using the Microsoft Win32 Content Prep Tool.\nDownload the tool and dump it somewhere useful on your machine, launch a Command Prompt and in four simple steps you\u0026rsquo;ll have a Win32App ready for Microsoft Intune:\nFrom the path of where the tool exists, run the tool specifying the:\nSource Folder PowerShell script (including extension) Output folder Whether you want to create a catalog (you don\u0026rsquo;t) The Win32App tool wrapping the Dell application. Now that you\u0026rsquo;ve got the Application, time to upload it to Microsoft Intune and configure some settings.\nApp Installation # Navigate to the Windows Apps section of Microsoft Intune and time to create a new app, making sure you select \u0026lsquo;Windows app (Win32)\u0026rsquo; as the App type.\nAfter uploading the .intunewin file make sure to use sysnative in the path of the install command, we also need to pass through the variables for the Settings and Values as well as Password for the BIOS Admin password:\nC:\\Windows\\Sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -noprofile -executionpolicy Bypass -file .\\Set-DellBIOSSettings.ps1 -Password S3CurePW0RD -Settings BootList,SecureBoot -Values Uefi,Enabled Now I know what you\u0026rsquo;re saying, \u0026ldquo;Eurrggh password is in plain text, bad, not secure, naughty\u0026rdquo;, well you\u0026rsquo;re not wrong, but then you really should be using Role-Based Access Control to protect your Microsoft Intune environment, and allowing only privileged users to access it, so maybe it\u0026rsquo;s you that\u0026rsquo;s got the issue this time.\nAlso, I didn\u0026rsquo;t write an uninstall script, so just use the same command line for this, unless you fancy writing something yourself.\nDell Command App installation parameters in Microsoft Intune. App Requirements # Make sure you select the correct architecture for your deployment, this time it\u0026rsquo;s x64 as well as the Minimum Operating System based on the Dell BIOS Provider requirements or your own device estate settings.\nDell Command App requirements in Microsoft Intune. App Detection Methods # As we\u0026rsquo;ve taken all that time to create something to use for a detection method in the PowerShell script itself, we should probably reference it here.\nNow these detections are going to be based on what Settings and Values you\u0026rsquo;re configuring, for this instance it\u0026rsquo;s BootList and SecureBoot, so let\u0026rsquo;s query them using the below settings:\nBootList Key path: HKLM\\SOFTWARE\\IntuneHelper\\DellBIOSProvider Value name: BootList Detection method: String comparison Operator: Equals Value: Uefi Dell Command App detection methods for UEFI in Microsoft Intune. SecureBoot Key path: HKLM\\SOFTWARE\\IntuneHelper\\DellBIOSProvider Value name: SecureBoot Detection method: String comparison Operator: Equals Value: Enabled Dell Command App detection methods for Secure Boot in Microsoft Intune. Complete the wizard as no other settings are required and deploy this App to a test device group.\nApp Monitoring # We were kind enough to add some basic logging using the Transcript function of PowerShell into the script, so on your test device, go have a look at the log located in C:\\Windows\\Temp called Set-DellBIOSSettings.log and check to see if it\u0026rsquo;s run correctly\nLog File # Dell Command log file. It did.\nRegistry Items # Let\u0026rsquo;s check the registry and make sure it\u0026rsquo;s added in the correct values:\nUpdated Registry settings. Yup.\nPowerShell # We can run the same command as we did at the start of this journey to confirm that our settings have applied:\nGet-ChildItem -path DellSmbios:\\ | ForEach-Object { Get-ChildItem -path @(\u0026#34;DellSmbios:\\\u0026#34; + $_.Category) | select-object attribute, currentvalue, possiblevalues, PSChildName } Format-List Attribute : BootList CurrentValue : UEFI BOOT PossibleValues : {Legacy, Uefi} PSChildName : BootSequence Attribute : SecureBoot CurrentValue : Enabled PossibleValues : {Disabled, Enabled} PSChildName : SecureBoot They did.\nSummary # With some confidence, you can now push out this App with your preferred settings to a wider device group, and the benefit is that the App itself is reusable; you just need to specify which settings are to be configured in the Installation command line, and how to detect them in the Detection Method.\nThere may be cleaner ways of doing this, probably using Proactive remediations, but then again, that requires Windows 10/11 Enterprise licensing, and we all haven\u0026rsquo;t got enterprise level money.\n","date":"10 July 2022","externalUrl":null,"permalink":"/posts/dell-bios-settings-intune/","section":"Posts","summary":"What if you\u0026rsquo;ve only got Microsoft Intune to configure your Dell BIOS settings and not the glory that is Configuration Manager? How much do you like PowerShell, Win32 Apps and passwords in plain text?","title":"Configuring Dell BIOS Settings with Microsoft Intune","type":"posts"},{"content":"","date":"10 July 2022","externalUrl":null,"permalink":"/tags/dell/","section":"Tags","summary":"","title":"Dell","type":"tags"},{"content":"","date":"10 July 2022","externalUrl":null,"permalink":"/tags/hardware/","section":"Tags","summary":"","title":"Hardware","type":"tags"},{"content":"Let\u0026rsquo;s talk about Windows 10 and above Operating System Compliance in Microsoft Intune, and specifically how using \u0026lsquo;Minimum OS Version\u0026rsquo; and \u0026lsquo;Maximum OS Version\u0026rsquo; is dumb and you should definitely check yourself if you\u0026rsquo;re using this in your environment.\nCompliance # If you\u0026rsquo;re already using Microsoft Intune compliance policies, good for you, and extra points if you\u0026rsquo;ve integrated these with Conditional Access policies. However, are you using Compliance Policies in the correct way, or even a way that makes sense?\nCompliance Granularity # I\u0026rsquo;ll talk about granularity of compliance settings, and the main reason to split out these Compliance settings into separate policies, is the actions for non-compliance; you see, you only get one set of these per policy.\nSo where you would want to mark a device as non-compliant immediately if there is no Antivirus installed, would you want it to be the same for the supported operating system builds? (Clue here, the answer is no).\nThis is a very real-world configuration, if you\u0026rsquo;re controlling the deferral and deadline settings of Software Updates via Windows Update for Business, it wouldn\u0026rsquo;t be fair and honourable for you to mark a device as non-compliant, and potentially block access to Office 365 authenticated services, when the computer itself hasn\u0026rsquo;t even received the update to be installed.\nOperating System Compliance # So now we know we should be using separate policies per compliance setting, so let\u0026rsquo;s look at Operating System Versions:\nMinimum and maximum operating system compliance policy settings in Microsoft Intune. With this setting you can configure the minimum and maximum operating system version, including build version using the below information to denote the format.\nThe operating system version is defined as major.minor.build.revision Sounds great, if and only if all of your Windows 10 devices are all running the same Feature Update.\nThe Problem # Let\u0026rsquo;s say your estate has the following supported (at time of writing) Windows 10 and later versions:\nWindows 10 20H2 Windows 10 21H1 Windows 10 21H2 Windows 11 21H2 So to cover all of the supported operating systems your minimum operating system compliance setting is going to be 10.0.19042.1766 (June 2022). Great.\nThis however means that any of the newer builds, patched or unpatched, will also be marked as compliant, as you know 10.0.19044.1111 is a bigger number than 10.0.19042.1766. Quick Maths.\nThis is a problem, as do you really want to mark unpatched operating systems as compliant. Again, answer here is no.\nThe Solution # This is where the \u0026lsquo;Valid operating system builds\u0026rsquo; section in the Compliance Policy comes into play, allowing you to split out each build in your End-user computing estate and each to have their own range of minimum and maximum:\nValid operating system builds in a compliance policy settings in Microsoft Intune. So there we have it, a fast turnaround for a real-world problem. Now about updating this monthly\u0026hellip;\nUpdating Compliance # When you update a Compliance Policy, it will trigger the devices the policy is assigned to, to re-evaluate the conditions and follow the actions for non-compliance if necessary. So you should be updating the Operating System Compliance Policy every month, which, although it isn\u0026rsquo;t a painful task, it is a repeatable one.\nNeedless Automation to the Rescue # So what does any good Consultant do in this situation? They write some PowerShell to do the work for them, even if writing the PowerShell script probably took longer than just updating the Compliance Policy.\nI\u0026rsquo;ve already demonstrated my coffee fuelled scripting in previous posts and this one isn\u0026rsquo;t going to be much different.\nFunctions are your Friends # We\u0026rsquo;ll need a few functions for this, some grabbed from the Intune PowerShell Samples GitHub repo, and some thrown together based on the samples.\nWe\u0026rsquo;ll be authenticating to Graph, grabbing the Windows Compliance Policies that have the Valid Operating System Build setting, getting the latest OS Build version from the Microsoft Atom Feeds and then updating the Compliance Policy. This sounded easier in my head if I\u0026rsquo;m honest.\nAuthentication # The move to MSAL based authentication can be found in this post.\nConnect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementManagedDevices.ReadWrite.All,DeviceManagementConfiguration.ReadWrite.All'. Testing JSON # As we need to make sure the JSON we\u0026rsquo;re generating is valid, best we test it before launching it at Graph.\nFunction Test-JSON() { param ( $JSON ) try { $TestJSON = ConvertFrom-Json $JSON -ErrorAction Stop $validJson = $true } catch { $validJson = $false $_.Exception } if (!$validJson) { Write-Host \u0026#34;Provided JSON isn\u0026#39;t in valid JSON format\u0026#34; -f Red break } } Getting Compliance Policies # As we\u0026rsquo;re going to be updating Compliance Policies, we should probably have a method to actually retrieve them using GET /deviceManagement/deviceCompliancePolicies.\nFunction Get-DeviceCompliancePolicy() { $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceManagement/deviceCompliancePolicies\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri-Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Updating Compliance Policies # This one I had to actually sort out myself, this function allows you to push updates to existing Compliance Policies. Details on this method can be found in the Graph API documentation PATCH /deviceManagement/deviceCompliancePolicies/{deviceCompliancePolicyId} documentation.\nFunction Update-DeviceCompliancePolicy() { [cmdletbinding()] param ( $Id, $JSON ) $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceManagement/deviceCompliancePolicies/$id\u0026#34; try { if (!$Id) { write-host \u0026#34;No Compliance Policy Id specified, specify a valid Compliance Policy Id\u0026#34; -f Red break } if ($JSON -eq \u0026#34;\u0026#34; -or $null -eq $JSON) { write-host \u0026#34;No JSON specified, please specify valid JSON for the Compliance Policy...\u0026#34; -f Red } else { Test-JSON -JSON $JSON $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri-Method Patch -Body $JSON -ContentType \u0026#34;application/json\u0026#34; Write-Host Write-Host \u0026#34;Successfully Updated Compliance Policy\u0026#34; -ForegroundColor Green } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Getting Latest Windows Version # This is where I had a lot of issues, mainly down to the [xml] setting when parsing the RSS feed, this is down to how the content is processed when handling it live, instead of outputting it to file.\nEssentially, this function scrapes the Microsoft Atom Feed for Windows 10 and Windows 11 updates, dumps the versions into an array and picks out the most recent build version, avoiding \u0026lsquo;Preview\u0026rsquo; and \u0026lsquo;Out of band\u0026rsquo; updates.\nFunction Get-LatestWindowsUpdatesBuild() { [cmdletbinding()] param ( [ValidateSet(\u0026#39;10\u0026#39;, \u0026#39;11\u0026#39;)] $OS, $Build ) try { if (!$OS) { write-host \u0026#34;No OS specified, specify a valid Operating System number\u0026#34; -f Red break } else { if ($OS -eq \u0026#39;10\u0026#39;) { $uri = \u0026#34;https://support.microsoft.com/en-us/feed/atom/6ae59d69-36fc-8e4d-23dd-631d98bf74a9\u0026#34; } elseif ($OS -eq \u0026#39;11\u0026#39;) { $uri = \u0026#34;https://support.microsoft.com/en-us/feed/atom/4ec863cc-2ecd-e187-6cb3-b50c6545db92\u0026#34; } [xml]$Updates = (Invoke-WebRequest -Uri $uri -UseBasicParsing -ContentType \u0026#34;application/xml\u0026#34;).Content -replace \u0026#34;[^\\x09\\x0A\\x0D\\x20-\\xD7FF\\xE000-\\xFFFD\\x10000-x10FFFF]\u0026#34;, \u0026#34;\u0026#34; $BuildVersions = @() foreach ($Update in $Updates.feed.entry) { if (($update.title.\u0026#39;#text\u0026#39; -like \u0026#34;*$Build*\u0026#34;) -and ($update.title.\u0026#39;#text\u0026#39; -notlike \u0026#34;*Preview*\u0026#34;) -and ($update.title.\u0026#39;#text\u0026#39; -notlike \u0026#34;*Out-of-band*\u0026#34;)) { $BuildVersions += $update.title.\u0026#39;#text\u0026#39; } } write-host write-host \u0026#34;Latest OS Build - $($BuildVersions[0])\u0026#34; -ForegroundColor Cyan $BuildVersions[0].Substring($BuildVersions[0].LastIndexOf(\u0026#34;.\u0026#34;)) -replace \u0026#34;[\u0026#39;)\u0026#39;, \u0026#39;.\u0026#39;]\u0026#34;, \u0026#34;\u0026#34; } } catch { Write-Error $Error[0].ErrorDetails.Message break } } Getting, Setting and Updating # Finally we get to utilising the functions, putting it all together and updating the Compliance Policy with the latest minimum OS build version based on the latest release of each Windows 10 and later build.\nLet\u0026rsquo;s break down each section before I launch the full script at you.\nGetting the Correct Policy # We need to make sure we\u0026rsquo;re pulling through only Windows based Compliance Policies, and only those that have legitimate build version information. We\u0026rsquo;re using the @odata.type and the validOperatingSystemBuildRanges data here.\n$OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#34;windows10CompliancePolicy\u0026#34;) -and ($_.validOperatingSystemBuildRanges) -ne \u0026#34;\u0026#34; } Getting the Build Versions # To update each field in the Compliance Policy, we need to handle each line, in this example we only have the four currently supported versions of Windows 10, but we need the script to cater for all versions. Using this we can get the latest build version for each Windows version.\n$OSBuilds = $OSCompliancePolicy.validOperatingSystemBuildRanges $OSUpdates = @() foreach ($OSBuild in $OSBuilds) { if ($OSBuild.lowestVersion -like \u0026#39;*10.0.1*\u0026#39;) { $WindowsVersion = \u0026#39;10\u0026#39; } elseif ($OSbuild.lowestVersion -like \u0026#39;*10.0.2*\u0026#39;) { $WindowsVersion = \u0026#39;11\u0026#39; } $OSVersion = $OSBuild.lowestVersion.Split(\u0026#39;.\u0026#39;)[2] $BuildVersion = Get-LatestWindowsUpdatesBuild -OS $WindowsVersion -Build $OSVersion $NewOSBuildVersion = \u0026#39;10.0.\u0026#39; + $OSVersion + \u0026#39;.\u0026#39; + $BuildVersion } Building the JSON Payload # Now that we have the required information, we need to build the JSON payload to update the Compliance Policy with, based on the existing data and the new minimum OS build versions.\n$Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.windows10CompliancePolicy\u0026#39; $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $Description foreach ($OSBuild in $OSBuilds) { $OSUpdate = New-Object -TypeName psobject $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $OSBuild.description $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;lowestVersion\u0026#39; -Value $NewOSBuildVersion $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;highestVersion\u0026#39; -Value $OSBuild.highestVersion $OSUpdates += $OSUpdate } $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;validOperatingSystemBuildRanges\u0026#39; -Value @($OSUpdates) $JSON = $Update | ConvertTo-Json -Depth 3 Fusion, Ha # Seeing the whole bunch of bits together looks a little bit like this, and the full script can be found in my GitHub repo.\n$Date = Get-Date $Description = \u0026#34;Updated Operating System Device Compliance Policy on $Date\u0026#34; $Update = New-Object -TypeName psobject $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;@odata.type\u0026#39; -Value \u0026#39;#microsoft.graph.windows10CompliancePolicy\u0026#39; $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $Description $OSCompliancePolicies = Get-DeviceCompliancePolicy | Where-Object { ($_.\u0026#39;@odata.type\u0026#39;).contains(\u0026#34;windows10CompliancePolicy\u0026#34;) -and ($_.validOperatingSystemBuildRanges) -ne \u0026#34;\u0026#34; } foreach ($OSCompliancePolicy in $OSCompliancePolicies) { Write-Host Write-Host \u0026#34;Updating Operating System Device Compliance Policy - $($OSCompliancePolicy.displayname)\u0026#34; -ForegroundColor Green $OSBuilds = $OSCompliancePolicy.validOperatingSystemBuildRanges $OSUpdates = @() foreach ($OSBuild in $OSBuilds) { if ($OSBuild.lowestVersion -like \u0026#39;*10.0.1*\u0026#39;) { $WindowsVersion = \u0026#39;10\u0026#39; } elseif ($OSbuild.lowestVersion -like \u0026#39;*10.0.2*\u0026#39;) { $WindowsVersion = \u0026#39;11\u0026#39; } $OSVersion = $OSBuild.lowestVersion.Split(\u0026#39;.\u0026#39;)[2] $BuildVersion = Get-LatestWindowsUpdatesBuild -OS $WindowsVersion -Build $OSVersion $NewOSBuildVersion = \u0026#39;10.0.\u0026#39; + $OSVersion + \u0026#39;.\u0026#39; + $BuildVersion Write-Host Write-Host \u0026#34;Updating OS Build Minimum version to - $NewOSBuildVersion\u0026#34; -ForegroundColor Green $OSUpdate = New-Object -TypeName psobject $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;description\u0026#39; -Value $OSBuild.description $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;lowestVersion\u0026#39; -Value $NewOSBuildVersion $OSUpdate | Add-Member -MemberType NoteProperty -Name \u0026#39;highestVersion\u0026#39; -Value $OSBuild.highestVersion $OSUpdates += $OSUpdate } # Creating JSON object to pass to Graph $Update | Add-Member -MemberType NoteProperty -Name \u0026#39;validOperatingSystemBuildRanges\u0026#39; -Value @($OSUpdates) $JSON = $Update | ConvertTo-Json -Depth 3 # Updating the compliance policy Update-DeviceCompliancePolicy -Id $OSCompliancePolicy.id -JSON $JSON } The Action Shot # Time to finally run this script and add some level of automation to this laborious task of updating Compliance Policy\u0026hellip;\n.\\Set-WindowsOSCompliance.ps1 Running the script will prompt you to provide a username and connect to Graph, please do this and login:\nAuthentication to Entra ID. Then it does everything for you, and tells you about it:\nPowerShell script updating the compliance operating system builds. Best we check the Compliance Policy to make sure it\u0026rsquo;s done what I asked it to:\nThe updated valid operating system builds in a compliance policy settings in Microsoft Intune. It did, and a cheeky description based on when the policy was last updated.\nSummary # This one was a bit long winded, but it does give you an insight in not only why granular compliance policies are important, but also how to work around limitations within them. The limitations, especially when your organisation is adhering to security frameworks and need specific operating system compliance are something you may have to battle with, or in this instance, just take my example and run.\nLuckily other Operating System compliance such as Android or iOS/iPadOS isn\u0026rsquo;t as complicated to handle, but I might do a write up on that at some point\u0026hellip;maybe a rainy day.\nAlso, if you have the inclination, you could expand upon this script and have it run on a schedule, but you\u0026rsquo;ll have to change the authentication method and associated permissions utilising an App Registration in Azure AD\u0026hellip;sounds thrilling.\n","date":"30 June 2022","externalUrl":null,"permalink":"/posts/operating-system-compliance-updates/","section":"Posts","summary":"Let\u0026rsquo;s talk about Windows 10 and above Operating System Compliance in Microsoft Intune, and specifically how using \u0026lsquo;Minimum OS Version\u0026rsquo; and \u0026lsquo;Maximum OS Version\u0026rsquo; is dumb and you should definitely check yourself if you\u0026rsquo;re using this in your environment.","title":"Windows Operating System Compliance Updates","type":"posts"},{"content":"Now I don\u0026rsquo;t think I promised that I\u0026rsquo;d cover off bulk tagging Autopilot devices in a previous post, but you know, I was running low on things to write about. So here we are.\nAs I like to practice what I preach, I\u0026rsquo;d left myself the task of updating 1000\u0026rsquo;s of Autopilot devices with a new Group Tag after a successful Proof-of-Concept implementation of a suitable convention and syntax. Thanks past me.\nSo what does any good consultant do? Run away? Come up with a janky script that you\u0026rsquo;ll only ever run once, that contains nested \u0026lsquo;foreach\u0026rsquo; loops? Write a perfectly reusable and digestible PowerShell script using Graph API to update existing Autopilot devices\u0026hellip;\nThe Approach # Now I needed an easy way to tag specific devices with Group Tags, and then anything that didn\u0026rsquo;t have a specific Group Tag to get a default one\u0026hellip;so we\u0026rsquo;re working with two distinct use cases here.\nReady, Aim # For the first, we\u0026rsquo;ll start with exporting the Autopilot Devices from the tenant, as this CSV file will contain the Serial Numbers we need further down the line.\nExport of Windows Autopilot devices to csv from Microsoft Intune. Now with the CSV file exported, and looking something like the below:\nSerial number,Manufacturer,Model,Group tag,Profile status,Purchase order,Userless Enrollment Status \u0026#34;0924-3584-5488-9044-8423-3149-46\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;Virtual Machine\u0026#34;,\u0026#34;Entra\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Unknown\u0026#34; \u0026#34;7440-0683\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;Virtual Machine\u0026#34;,\u0026#34;CIS\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Not Allowed\u0026#34; \u0026#34;AAA-0263-9697-7653-AAAA-AAAA-AA\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;Virtual Machine\u0026#34;,\u0026#34;Entra\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Not Allowed\u0026#34; \u0026#34;DNuesTLjtKit\u0026#34;,\u0026#34;QEMU\u0026#34;,\u0026#34;QEMU Virtual Machine\u0026#34;,\u0026#34;CIS\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Not Allowed\u0026#34; \u0026#34;poiuytrewqlkjhgfdsa\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;Virtual Machine\u0026#34;,\u0026#34;CIS\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Not Allowed\u0026#34; \u0026#34;qwertyuiopasdfghjklzxcvbnm\u0026#34;,\u0026#34;Microsoft Corporation\u0026#34;,\u0026#34;Virtual Machine\u0026#34;,\u0026#34;CIS\u0026#34;,\u0026#34;Assigned\u0026#34;,\u0026#34;\u0026#34;,\u0026#34;Not Allowed\u0026#34; Go ahead and laboriously update the CSV file with Group Tags and remove any devices that you want tagging with the default one.\nRepeat Offenders # We need a way to not only set the Group Tag, but fetch the ID of the Autopilot device, and as we\u0026rsquo;re doing this potentially 100\u0026rsquo;s of times, and I did say this was a repeatable and reusable script, we should create a PowerShell function or two.\nHandshake Time # Lets steal the PowerShell Authentication Function from the Intune PowerShell Samples GitHub repo to allow us to connect to Graph.\nConnect to Graph using the latest module and Connect-MgGraph -Scopes 'DeviceManagementManagedDevices.ReadWrite.All'. Autopilot Functions # Now we can have a nice authenticated chat to Graph, we need to talk to the Autopilot section, deviceManagement/windowsAutopilotDeviceIdentities in fact.\nSo let\u0026rsquo;s get all Autopilot devices, as we\u0026rsquo;ll need this to:\nGet all Autopilot devices without a Group Tag set Get the Autopilot device Id for the entries in the CSV file we created Getting Autopilot Devices # Function Get-AutopilotDevices() { $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceManagement/windowsAutopilotDeviceIdentities\u0026#34; try { $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; (Invoke-MgGraphRequest -Uri $uri -Method Get).Value } catch { Write-Error $Error[0].ErrorDetails.Message break } } Update Autopilot Device Attributes # Now we can use the below function to set the Autopilot Group Tag (I should could probably update this to set other device attributes).\nFunction Set-AutopilotDevice() { [CmdletBinding()] param( $Id, $GroupTag ) $graphApiVersion = \u0026#34;Beta\u0026#34; $Resource = \u0026#34;deviceManagement/windowsAutopilotDeviceIdentities/$Id/updateDeviceProperties\u0026#34; try { if (!$id) { write-host \u0026#34;No Autopilot device Id specified, specify a valid Autopilot device Id\u0026#34; -f Red break } if (!$GroupTag) { $GroupTag = Read-host \u0026#34;No Group Tag specified, specify a Group Tag\u0026#34; } $Autopilot = New-Object -TypeName psobject $Autopilot | Add-Member -MemberType NoteProperty -Name \u0026#39;groupTag\u0026#39; -Value $GroupTag $JSON = $Autopilot | ConvertTo-Json -Depth 3 $uri = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($Resource)\u0026#34; Invoke-MgGraphRequest -Uri $uri -Method Post -Body $JSON -ContentType \u0026#34;application/json\u0026#34; write-host \u0026#34;Successfully added \u0026#39;$GroupTag\u0026#39; to device\u0026#34; -ForegroundColor Green } catch { Write-Error $Error[0].ErrorDetails.Message break } } Scary Stuff Lies Ahead # So we now have the functions in order to connect, get and set all the things we need. Here comes the fun part, PowerShell logic driven by four cups of coffee.\nScript Parameters # Before that, some lovely parameters to ensure you can\u0026rsquo;t really mess things up.\nMethod: Set to be either \u0026lsquo;CSV\u0026rsquo; or \u0026lsquo;Online\u0026rsquo;, used for loading that beautiful CSV created earlier, or to just grab all the Autopilot devices in the tenant with a blank Group Tag DefaultGroupTag: The \u0026lsquo;Catch All\u0026rsquo; Group Tag for those devices that don\u0026rsquo;t have one set already The Logic? # Here we have the guts of the script, designed so that you run it through once with the CSV option, then a second time using the Online option. Don\u0026rsquo;t ask me why I did it this way, four coffees remember.\nI was also kind enough to capture any of the devices in the CSV file missing a Group Tag and prompt to enter one in. Very kind.\nif ($method -eq \u0026#39;csv\u0026#39;) { $csvPath = Read-Host \u0026#39;Please provide the path to the csv file containing a list of device serial numbers and new Group Tag e.g. C:\\temp\\devices.csv\u0026#39; if (!(Test-Path \u0026#34;$csvPath\u0026#34;)) { Write-Host \u0026#34;Import Path for csv file doesn\u0026#39;t exist\u0026#34; -ForegroundColor Red Write-Host \u0026#34;Script can\u0026#39;t continue\u0026#34; -ForegroundColor Red Write-Host break } else { $autopilotDevices = Import-Csv -Path $csvPath } } else { Write-Host \u0026#39;Getting all Autopilot devices without a Group Tag\u0026#39; -ForegroundColor Cyan $autopilotDevices = Get-AutopilotDevices | Where-Object { ($null -eq $_.groupTag) -or ($_.groupTag) -eq \u0026#39;\u0026#39; } $groupTag = Read-Host \u0026#34;Please enter the default group tag for devices without a tag:\u0026#34; } # Sets Group Tag foreach ($autopilotDevice in $autopilotDevices) { $id = $autopilotDevice.id if (!$id) { Write-Host \u0026#39;No Autopilot Device Id, getting Id from Graph\u0026#39; -ForegroundColor Cyan $id = (Get-AutopilotDevices | Where-Object { ($_.serialNumber -eq $autopilotDevice.\u0026#39;serial Number\u0026#39;) }).id Write-Host \u0026#34;ID:\u0026#39;$Id\u0026#39; found for device with serial \u0026#39;$($autopilotDevice.\u0026#39;Serial number\u0026#39;)\u0026#39;\u0026#34; -ForegroundColor Green } if ($method -eq \u0026#39;csv\u0026#39;) { $groupTag = $autopilotDevice.\u0026#39;group Tag\u0026#39; if (!$groupTag) { Write-Host \u0026#39;No Autopilot Device Group Tag found in csv\u0026#39; -ForegroundColor Cyan $groupTag = Read-Host \u0026#34;Please enter the group tag for device with serial $($autopilotDevice.\u0026#39;serial Number\u0026#39;) now:\u0026#34; } } try { Set-AutopilotDevice -id $id -groupTag $groupTag Write-Host \u0026#34;Group tag: \u0026#39;$groupTag\u0026#39; set for device with serial $($autopilotDevice.\u0026#39;Serial number\u0026#39;)\u0026#34; -ForegroundColor Green } catch { Write-Host \u0026#34;Group tag: \u0026#39;$groupTag\u0026#39; not set for device with serial $($autopilotDevice.\u0026#39;Serial number\u0026#39;)\u0026#34; -ForegroundColor Red } } Fire # So bring it all together into a mega-script we now have a way to update the Autopilot Group Tags. So let\u0026rsquo;s give it a go.\nThere is no -whatif command, so I\u0026rsquo;d start with the CSV of a couple of test devices. Sniper Time # Running the script with the CSV option:\n.\\Set-AutopilotGroupTag.ps1 -tenantId \u0026#39;bb690aa6-53c6-4d51-affe-ab80c6d710de\u0026#39; -method csv We first have to Authenticate, we\u0026rsquo;re using Device Authentication so following the instructions in the script:\nAuthentication prompt to Graph. Now we need to provide the path to the CSV file:\nPlease provide the path to the CSV file containing a list of device serial numbers and new Group Tag e.g. C:\\temp\\devices.csv: Now the script will run and update all the devices in the CSV file with their corresponding Group Tags:\nThe PowerShell script output after assigning Group Tags. And if we check in Intune:\nThe updated Group Tags on Autopilot devices in Microsoft Intune. Which amazingly, the Group Tag matches the data in the CSV file we created earlier. Too early to call this a win outright, but we\u0026rsquo;re on the way.\nShotgun Approach # We need to now clear up the remaining devices without Group Tags, this one we can\u0026rsquo;t really test, unless you fancy improving the script.\nSimilar setup to the CSV run, but this time the arguments look like the below:\n.\\Set-AutopilotGroupTag.ps1 -tenantId \u0026#39;bb690aa6-53c6-4d51-affe-ab80c6d710de\u0026#39; -Method Online We\u0026rsquo;re already authenticated, so we can skip that bit, and we\u0026rsquo;re not using the CSV option so it will get straight to the good stuff, where you will be prompted to set the default group tag:\nPlease enter the default group tag for devices without a tag: Entra Then the script will go and update Autopilot devices missing the group tag:\nThe PowerShell script output after assigning Group Tags. And if we check in Intune:\nThe updated Group Tags on Autopilot devices in Microsoft Intune. This Group Tag matches the prompted tag we set when running the script. I\u0026rsquo;d call this one a win.\nSummary # There might be easier ways of doing this, or a little less caffeine fuelled at least, but if you want to bulk set Group Tags to your existing Autopilot devices, this does seem like a half decent approach.\nFor new devices, I recommend that you work with your supplier/OEM and get them to tag them as part of the on-boarding.\nAlso, you can run this many times, so if you do want to re-tag devices, you can use the CSV method to do so.\nAlso also, you should look at this post about using dynamic groups to ring fence your newly tagged devices.\n","date":"19 June 2022","externalUrl":null,"permalink":"/posts/windows-autopilot-retrofitting-group-tags/","section":"Posts","summary":"Now that we know how powerful Autopilot Group Tags can be, we should look into how we can retrofit devices with these Group Tags when the OEM or Supplier didn\u0026rsquo;t bother doing their part of the deal.","title":"Retrofitting Windows Autopilot Group Tags","type":"posts"},{"content":"","date":"8 June 2022","externalUrl":null,"permalink":"/tags/device-filters/","section":"Tags","summary":"","title":"Device Filters","type":"tags"},{"content":"Now if you\u0026rsquo;ve ever spoken to me about Microsoft Intune and using Dynamic Groups for management of users and devices, I probably would have talked your ears off about the attribute usage, which attributes are suitable, and that moving away from assigned groups to dynamic is the only way forward for Modern Device Management.\nWhat if I told you, that there\u0026rsquo;s something on par with these holy grail groups, and maybe, just maybe, even better.\nMy Beloved Dynamic Groups # Before we jump into Device Filters, let us talk about Dynamic Groups a little\u0026hellip;\nFirstly, I would highly recommend the use of these groups, especially for grouping devices, whether this be based on enrolment type, ownership, operating system type or version\u0026hellip;and if you\u0026rsquo;ve got something or someone managing your user attributes, that you use them for user groups.\nThe Limitations # This sadly, is how quickly these groups update; Microsoft probably realised that people were using these groups in relation to device management, and also realised that the enumeration of the groups was using precious Compute infrastructure, for free, smh.\nSo Microsoft reduced how often these groups fully updated to once every 24 hours.\nNow this is no good when we want to target settings and restrictions, or even just application deployment to these dynamically populated groups, we end up with delaying installations, configuration settings or even connectivity. Not a fan.\nBring on the Filters # So where Microsoft take away with one hand, they give with the other, and this is the new world of Device Filters.\nAt a high level, what makes filters so much better for use in Microsoft Intune comes down a couple of things:\nThe filter evaluation is done when the device enrols and/or checks in with the Intune service; this means the speed of evaluation is significantly faster than dynamic groups. Filters are entirely reusable meaning we can now create one filter and use it for many areas within Microsoft Intune. Device Filter evaluation workflow. Before a policy is applied to a device, filters dynamically evaluate applicability:\nYou create a filter for any platform based on some device properties.\nYou assign a policy or app to the group. In the assignment, you add the filter in either include or exclude mode. For example, you \u0026ldquo;include\u0026rdquo; personal devices, or you \u0026ldquo;exclude\u0026rdquo; personal devices from the policy.\nThe filter is evaluated when the device enrols or at any other time a policy evaluates.\nYou see the filter results based on the evaluation. For example, the app or policies applies, or it doesn\u0026rsquo;t apply.\nInconsistent Assignments # So we\u0026rsquo;ve talked about the limitations with Dynamic Groups, but we do need to talk about the limitations with Device Filters\u0026hellip; Not all areas of Microsoft Intune support the use of Filters (as of today, though this will hopefully change), meaning that you can\u0026rsquo;t provide a consistent application method of assignments.\nFor example, Autopilot profiles don\u0026rsquo;t support filters, and nor do Endpoint Security Profiles, nor PowerShell scripts, nor MAM policies:\nMissing Filter assignment options in Microsoft Intune. However, a lot of crucial areas do, including Compliance, Configuration and Windows Update for Business profiles:\nFilter assignment options in Microsoft Intune. Groups looking good here.\nFewer Properties # Device Filters have fewer attribute properties to work with compared with Dynamic Groups, so any advanced filtering like with Autopilot Group Tags will still need to be done using Dynamic Groups.\nDevice Filters Device Filter properties in Microsoft Intune. Dynamic Groups Dynamic Security Group properties in Microsoft Entra ID. Win for the Groups.\nFewer Operators # Device Filters do not support advanced logic with the operators such as \u0026lsquo;Match\u0026rsquo;, so turbo advanced filtering such as in Intelligent Phased Windows Update for Business Deployments need to be handled with groups still.\nDevice Filters Device Filter operators in Microsoft Intune. Dynamic Groups Dynamic Security Group operators in Microsoft Entra ID. Another win there, 3-0 to the Groups.\nSummary # Even with these Device Filter limitations (and the 3-0 loss), the benefits of reusability and speed in which they are processed still shine through over Dynamic Groups in many areas of Microsoft Intune, and I strongly recommend moving to using the \u0026lsquo;All Devices\u0026rsquo; and \u0026lsquo;All Users\u0026rsquo; in-built assignments in conjunction with Device Filters, just to make your life that little bit easier when managing devices.\nYou\u0026rsquo;ve come this far, so why not give creating them a shot and create a filter or two?\n","date":"8 June 2022","externalUrl":null,"permalink":"/posts/endpoint-manager-device-filters/","section":"Posts","summary":"Now if you\u0026rsquo;ve ever spoken to me about Microsoft Intune and using Dynamic Groups for management of users and devices, I probably would have talked your ears off about the attribute usage, which attributes are suitable, and that moving away from assigned groups to dynamic is the only way forward for Modern Device Management.","title":"Dynamic Groups vs Device Filters","type":"posts"},{"content":"","date":"21 May 2022","externalUrl":null,"permalink":"/tags/accessibility/","section":"Tags","summary":"","title":"Accessibility","type":"tags"},{"content":"Have you ever wondered how to ensure that a number of languages are available for selection to end users on shared Windows 10 devices? The thought hadn\u0026rsquo;t crossed my mind, but then again, you encounter new use cases and requirements on a weekly basis. This was one of those occasions, needing a Library Kiosk machine to have a set of languages available to users upon login to the machine.\nConfiguration # There are a number of posts out in the wild on how to fully change the Windows languages on a device by device basis, but in this instance we needed to keep the core language as en-GB but allow end users to select their preferred input language within Windows, and ensure that this language list can be modified in the event of new languages being required.\nLet\u0026rsquo;s crack on shall we\u0026hellip;\nWindows User Language List # You may be familiar with the \u0026lsquo;old\u0026rsquo; way of automating the setting user languages in Windows 7, calling control.exe intl.cpl,,/f:\u0026quot;c:\\Unattend.xml\u0026quot; and assigning an xml file with the required user languages, luckily with Windows 10 comes the Set-WinUserLanguageList PowerShell command.\nMicrosoft does a great job of detailing how this command is used, so below is the way I\u0026rsquo;ve created a new list, and appended the required languages using the region tag.\nThis allows for new languages to be added to the script readily.\n# Sets the Windows Languages $LanguageList = New-WinUserLanguageList -Language \u0026#39;en-GB\u0026#39; $Languages = New-Object -TypeName System.Collections.ArrayList $Languages.AddRange(@( \u0026#34;en-US\u0026#34;, \u0026#34;ar-SA\u0026#34;, \u0026#34;zh-HK\u0026#34;, \u0026#34;zh-CN\u0026#34;, \u0026#34;zh-TW\u0026#34;, \u0026#34;el-GR\u0026#34;, \u0026#34;he-IL\u0026#34;, \u0026#34;ja-JP\u0026#34;, \u0026#34;ko-KR\u0026#34;, \u0026#34;zh-Hant-TW\u0026#34;, \u0026#34;jp-JP\u0026#34;, \u0026#34;am-ET\u0026#34;, \u0026#34;Cy-az-AZ\u0026#34;, \u0026#34;Lt-az-AZ\u0026#34;, \u0026#34;fa-IR\u0026#34;, \u0026#34;ka-GE\u0026#34; )) Foreach($Language in $Languages){ $LanguageList.Add($Language) } Try{ Set-WinUserLanguageList -LanguageList $LanguageList -Force } Catch{ Write-Error \u0026#34;Unable to set the language list $($_.Exception.Message)\u0026#34; } Task Scheduling # This script allows the creation and installation of a User Language List, containing the required languages needed for each user who accesses the shared device. This seemed all a bit too perfect for this requirement; updatable list of languages, uses native PowerShell commands, can be deployed via Microsoft Intune. That was until I realised this only works correctly under a user context, and I also need it to run each time a user logs on to the machine.\nSo now we need a way to create a Scheduled Task and have it run the PowerShell script, without the end user seeing it run.\nLuckily, I was using a script to map network drives, generated from here to do something similar, time to not reinvent the wheel and just make use of someone else\u0026rsquo;s hard work.\nLet\u0026rsquo;s break down the sections of the script.\nRunning as SYSTEM # First off the detecting whether the script is being run under a SYSTEM context; this is important, as when deployed via Microsoft Intune the script will be running under this context, at this time we want the script to create the scheduled task, not run the containing PowerShell, in this instance the addition of user languages.\nfunction Test-RunningAsSystem { [CmdletBinding()] param() process { return [bool]($(whoami -user) -match \u0026#34;S-1-5-18\u0026#34;) } } Creating the Task # Now we have determined whether we\u0026rsquo;re running as SYSTEM or not, now time to create the Scheduled Task, and to have the script launched, using a dirty vbs file, to hide the PowerShell windows.\nif (Test-RunningAsSystem) { Start-Transcript -Path $(Join-Path -Path $env:temp -ChildPath \u0026#34;WindowsLanguages-ST.log\u0026#34;) Write-Output \u0026#34;Running as System --\u0026gt; creating scheduled task which will run on user logon\u0026#34; # Get the current script path and content and save it to the client $currentScript = Get-Content -Path $($PSCommandPath) $schtaskScript = $currentScript[(0) .. ($currentScript.IndexOf(\u0026#34;#!SCHTASKCOMESHERE!#\u0026#34;) - 1)] $scriptSavePath = $(Join-Path -Path $env:ProgramData -ChildPath \u0026#34;Intune-Helper\\Windows-Languages\u0026#34;) if (-not (Test-Path $scriptSavePath)) { New-Item -ItemType Directory -Path $scriptSavePath -Force } $scriptSavePathName = \u0026#34;Set-WindowsLanguages.ps1\u0026#34; $scriptPath = $(Join-Path -Path $scriptSavePath -ChildPath $scriptSavePathName) $schtaskScript | Out-File -FilePath $scriptPath -Force # Create dummy vbscript to hide PowerShell Window popping up at logon $vbsDummyScript = \u0026#34; Dim shell,fso,file Set shell=CreateObject(`\u0026#34;WScript.Shell`\u0026#34;) Set fso=CreateObject(`\u0026#34;Scripting.FileSystemObject`\u0026#34;) strPath=WScript.Arguments.Item(0) If fso.FileExists(strPath) Then set file=fso.GetFile(strPath) strCMD=`\u0026#34;powershell -nologo -executionpolicy ByPass -command `\u0026#34; \u0026amp; Chr(34) \u0026amp; `\u0026#34;\u0026amp;{`\u0026#34; \u0026amp;_ file.ShortPath \u0026amp; `\u0026#34;}`\u0026#34; \u0026amp; Chr(34) shell.Run strCMD,0 End If \u0026#34; $scriptSavePathName = \u0026#34;WindowsLanguages-VBSHelper.vbs\u0026#34; $dummyScriptPath = $(Join-Path -Path $scriptSavePath -ChildPath $scriptSavePathName) $vbsDummyScript | Out-File -FilePath $dummyScriptPath -Force $wscriptPath = Join-Path $env:SystemRoot -ChildPath \u0026#34;System32\\wscript.exe\u0026#34; # Register a scheduled task to run for all users and execute the script on logon $schtaskName = \u0026#34;Intune Helper - Windows Languages\u0026#34; $schtaskDescription = \u0026#34;Applies Windows Languages using a PowerShell script.\u0026#34; $trigger = New-ScheduledTaskTrigger -AtLogOn #Execute task in users context $principal = New-ScheduledTaskPrincipal -GroupId \u0026#34;S-1-5-32-545\u0026#34; -Id \u0026#34;Author\u0026#34; #call the vbscript helper and pass the PosH script as argument $action = New-ScheduledTaskAction -Execute $wscriptPath -Argument \u0026#34;`\u0026#34;$dummyScriptPath`\u0026#34; `\u0026#34;$scriptPath`\u0026#34;\u0026#34; $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries $null = Register-ScheduledTask -TaskName $schtaskName -Trigger $trigger -Action $action -Principal $principal -Settings $settings -Description $schtaskDescription -Force Start-ScheduledTask -TaskName $schtaskName Stop-Transcript } Now we\u0026rsquo;ve got the bones of the script, we can put it all together and deploy it using Microsoft Intune. The full script can be found here\nDeployment # Save the above script and create a new PowerShell script deployment in Microsoft Intune using the following configuration settings, then deploy to a test group of devices.\nPlatform script in Microsoft Intune. Now we have a way to deploy additional languages to Windows 10 devices, and have the Keyboard inputs available when the user has logged onto the device. The user just needs to select the language from the notification area.\nLanguage options on a Windows device. Summary # Pretty straight forward right? Setting the language list, letting \u0026lsquo;Windows Features on Demand\u0026rsquo; just download the required files, plus, you can amend the languages within the script and re-deploy, allowing you to add or remove any required languages for your users without having to deal with Language Packs.\n","date":"21 May 2022","externalUrl":null,"permalink":"/posts/windows-autopilot-languages/","section":"Posts","summary":"Have you ever wondered how to ensure that a number of languages are available for selection to end users on shared Windows 10 devices? The thought hadn\u0026rsquo;t crossed my mind, but then again, you encounter new use cases and requirements on a weekly basis. This was one of those occasions.","title":"Configuring Available User Languages on Windows Devices","type":"posts"},{"content":"We have already looked at allowing Android Enterprise enrolment using Mobile Data in a previous post, now it\u0026rsquo;s time to look at some of the other provisioning values that can be used to create a custom enrolment QR Code.\nConfiguration # This time, it\u0026rsquo;s adding in a WiFi profile, to allow the devices to auto-connect as part of the enrolment process\u0026hellip;anything to make life easier for users.\nExtracting the QR Code Data # First off you\u0026rsquo;ll need the QR code being used for your Android Enterprise enrolment, you can find this within the Android section of Microsoft Intune. Save this file to your computer and use an online reader to get the full QR code data:\n{ \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\u0026#34;:\u0026#34;com.google.android.apps.work.clouddpc/.receivers.CloudDeviceAdminReceiver\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\u0026#34;:\u0026#34;I5YvS0O5hXY46mb01BlRjq4oJJGs2kuUcHvVkAPEXlg\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\u0026#34;:\u0026#34;https://play.google.com/managed/downloadManagingApp?identifier=setup\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\u0026#34;:{ \u0026#34;com.google.android.apps.work.clouddpc.EXTRA_ENROLLMENT_TOKEN\u0026#34;:\u0026#34;SELECTED ENROLMENT TOKEN\u0026#34; } } WiFi Settings # We\u0026rsquo;re now going to add in four new lines of data into the existing JSON content from the Android Developer Reference Guide:\nThis is the SSID of the wireless network you want to connect to - \u0026quot;android.app.extra.PROVISIONING_WIFI_SSID\u0026quot;:\u0026quot;WIFI_SSID\u0026quot; This is the password of the wireless network - \u0026quot;android.app.extra.PROVISIONING_WIFI_PASSWORD\u0026quot;:\u0026quot;WIFI_PASSWORD\u0026quot; This is the security type of the network, select either none, WPA, WEP or EAP - \u0026quot;android.app.extra.PROVISIONING_WIFI_SECURITY_TYPE\u0026quot;:\u0026quot;NONE/WPA/WEP/EAP\u0026quot; And finally whether the network is hidden to broadcast, using either true or false - \u0026quot;android.app.extra.PROVISIONING_WIFI_HIDDEN\u0026quot;:true/false Please be aware that these settings are all available in plain text by anyone scanning the QR code, so I would recommend using a guest wireless network if you are going to allow you end users to use a corporate network to go through the enrolment process. Updating the JSON Data # Now that we\u0026rsquo;ve got the required strings ready to be added, we need to update the existing JSON data. The below settings, need to go after the android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\u0026quot; section:\n\u0026#34;android.app.extra.PROVISIONING_WIFI_SSID\u0026#34;:\u0026#34;corp-guest-wifi\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_PASSWORD\u0026#34;:\u0026#34;supersecurepassword\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_SECURITY_TYPE\u0026#34;:\u0026#34;WPA\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_HIDDEN\u0026#34;: false Full JSON Data # So the full JSON string should look like the below, with the SELECTED ENROLMENT TOKEN the correct one from the original QR code:\n{ \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\u0026#34;:\u0026#34;com.google.android.apps.work.clouddpc/.receivers.CloudDeviceAdminReceiver\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\u0026#34;:\u0026#34;https://play.google.com/managed/downloadManagingApp?identifier=setup\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\u0026#34;:\u0026#34;I5YvS0O5hXY46mb01BlRjq4oJJGs2kuUcHvVkAPEXlg\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\u0026#34;:{ \u0026#34;com.google.android.apps.work.clouddpc.EXTRA_ENROLLMENT_TOKEN\u0026#34;:\u0026#34;SELECTED ENROLMENT TOKEN\u0026#34; }, \u0026#34;android.app.extra.PROVISIONING_WIFI_SSID\u0026#34;:\u0026#34;corp-guest-wifi\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_PASSWORD\u0026#34;:\u0026#34;supersecurepassword\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_SECURITY_TYPE\u0026#34;:\u0026#34;WPA\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_WIFI_HIDDEN\u0026#34;: false } Creating a new QR Code # For completions sake, we should validate the JSON formatting using an online tool before we use a QR Code Generator to create our new QR code:\nThe QR Code for Android enrolment. Summary # This new QR Code can then be provided to your users, following successful testing, to allow them to enrol their new Android device in Microsoft Intune when in range of your corporate guest wireless network.\n","date":"11 May 2022","externalUrl":null,"permalink":"/posts/android-enterprise-custom-qr-code/","section":"Posts","summary":"Making your users lives easier with Android Fully Managed Corporate Owned enrolment, this time auto adding a corporate wireless network.","title":"Customising the Android Enterprise Enrolment QR Code","type":"posts"},{"content":"Ever had to add notes to Intune Managed Devices in bulk? Me either, well not until a few weeks ago when I needed an easy way to update the notes field on 100\u0026rsquo;s of devices.\nSo luckily I stumbled upon a post by Paul Wetter about getting and setting notes on devices using Graph API, and specifically the Beta channel of Graph. Luckily, Paul did the ground work and created a couple of functions, which I have happily stolen borrowed, updated and tweaked to allow for updating notes en masse.\nConfiguration # I\u0026rsquo;ve broken down each section of the script for a bit of a walk through, the important thing with all of this is making sure you have the Microsoft Graph Intune PowerShell module installed Install-Module -Name Microsoft.Graph.Intune and you\u0026rsquo;ve connected to MSGraph Connect-MSGraph.\nGetting Device Notes # The Get-IntuneDeviceNotes function leans on the Microsoft.Graph.Intune PowerShell module, to grab the Intune device ID using Get-IntuneManagedDevice, then grabs the device properties filtered to the Device Notes property. This will help us in getting individual device notes, as we kinda don\u0026rsquo;t want to lose any that have already been added.\nFunction Get-IntuneDeviceNotes{ [CmdletBinding()] param ( [Parameter(Mandatory=$true)] [String] $DeviceName ) Try { $DeviceID = (Get-IntuneManagedDevice -filter \u0026#34;deviceName eq \u0026#39;$DeviceName\u0026#39;\u0026#34; -ErrorAction Stop).id } Catch { Write-Error $_.Exception.Message break } $Resource = \u0026#34;deviceManagement/managedDevices(\u0026#39;$deviceId\u0026#39;)\u0026#34; $properties = \u0026#39;notes\u0026#39; $uri = \u0026#34;https://graph.microsoft.com/beta/$($Resource)?select=$properties\u0026#34; Try{ (Invoke-MSGraphRequest -Method GET -Url $uri -ErrorAction Stop).notes } Catch{ Write-Error $_.Exception.Message break } } Setting Device Notes # The Set-IntuneDeviceNotes function also leans on the Microsoft.Graph.Intune PowerShell module, to grab the Intune device ID using Get-IntuneManagedDevice, and posts the formed JSON file to Graph to update the Notes property. Trouble with this, is that it will overwrite any existing notes that exist, so we need a way to sort this out.\nFunction Set-IntuneDeviceNotes{ [CmdletBinding()] param ( [Parameter(Mandatory=$true)] [String] $DeviceName, [Parameter(Mandatory=$false)] [String] $Notes ) Try { $DeviceID = (Get-IntuneManagedDevice -filter \u0026#34;deviceName eq \u0026#39;$DeviceName\u0026#39;\u0026#34; -ErrorAction Stop).id } Catch{ Write-Error $_.Exception.Message break } If (![string]::IsNullOrEmpty($DeviceID)){ $Resource = \u0026#34;deviceManagement/managedDevices(\u0026#39;$DeviceID\u0026#39;)\u0026#34; $GraphApiVersion = \u0026#34;Beta\u0026#34; $URI = \u0026#34;https://graph.microsoft.com/$graphApiVersion/$($resource)\u0026#34; $JSONPayload = @\u0026#34; { notes:\u0026#34;$Notes\u0026#34; } \u0026#34;@ Try{ Write-Verbose \u0026#34;$URI\u0026#34; Write-Verbose \u0026#34;$JSONPayload\u0026#34; Invoke-MSGraphRequest -Method PATCH -Url $uri -Content $JSONPayload -Verbose -ErrorAction Stop } Catch{ Write-Error $_.Exception.Message break } } } Bulk Setting Device Notes # The Set-BulkIntuneDeviceNotes function utilises both of the previous functions; one to get the existing notes and add it to a new array variable, then to update the variable with the new notes in the CSV file that gets imported. There\u0026rsquo;s also some logic around whether there are existing notes using the -match operator, which is fun.\nFunction Set-BulkIntuneDeviceNotes{ [CmdletBinding()] param ( [Parameter(Mandatory=$true)] [String] $DeviceList ) if(Test-Path -Path $DeviceList){ $Devices = Import-csv $DeviceList foreach($Device in $Devices){ # Add Date stamp to the new notes $NewNotes = $Device.Notes $Notes = New-Object -TypeName System.Collections.ArrayList $Notes.AddRange(@( $NewNotes, \u0026#34;`n\u0026#34; # Adds a line break \u0026#34;`n\u0026#34; # Adds a line break )) # Get existing device notes Try{ $OldNotes = Get-IntuneDeviceNotes -DeviceName $Device.Device If($OldNotes -match \u0026#39;\\d\u0026#39; -or $OldNotes -match \u0026#39;\\w\u0026#39;){ Write-Host \u0026#34;Existing notes found on $($Device.Device), adding to Notes variable\u0026#34; -ForegroundColor Cyan $Notes.AddRange(@( $OldNotes )) } else{ } } Catch{ Write-Host \u0026#34;Unable to get device notes, ensure you are connected to MSGraph\u0026#34; -ForegroundColor Red Break } # Add the new notes, included the old ones Try{ Set-IntuneDeviceNotes -DeviceName $Device.Device -Notes $Notes Write-Host \u0026#34;Notes successfully added to $($Device.Device)\u0026#34; -ForegroundColor Green } Catch{ Write-Host \u0026#34;Unable to set device notes, ensure you are connected to MSGraph\u0026#34; -ForegroundColor Red Break } } } else{ Write-Host \u0026#34;Unable to access the provided device list, please check the csv file and re-run the script.\u0026#34; -ForegroundColor red Break } } Running the Script # The only parameter required is a CSV file, which only has two headers, \u0026lsquo;Device\u0026rsquo; and \u0026lsquo;Notes\u0026rsquo;, so feel free to create one yourself, as I don\u0026rsquo;t think you need a template this time. Then just populate the CSV file with the devices and the required notes that need adding.\nSample CSV:\nDevice,Notes\rENB-13F278,Here are the New notes about the device. To run the script, firstly install Microsoft Graph Intune PowerShell module and connect to Graph, then run the three functions, finally run the below updating the DeviceList path to your created CSV file:\nSet-MEMDeviceNotes -DeviceList C:\\temp\\UpdatedDeviceNotes.csv I\u0026rsquo;d test this with a single device in the CSV file first before you do this in bulk, you know, just in case.\nThe full script can be found here\nThe Results # But once run successfully, you\u0026rsquo;ll have devices with updated notes, so from this\u0026hellip; Microsoft Intune device notes. To this\u0026hellip; Microsoft Intune device notes updated. Summary # Yes this was a hacky script, yes I spent more time writing this post about it than putting the script together\u0026hellip;but the script does the job and saves having to manually update the notes field. Plus now you know how to do it, you can put whatever you want either in the csv file, or use something else to populate the field. World and Oyster.\n","date":"5 May 2022","externalUrl":null,"permalink":"/posts/bulk-adding-device-notes/","section":"Posts","summary":"Ever had to add notes to Intune Managed Devices in bulk? Me either, well not until a few weeks ago when I needed an easy way to update the notes field on 100\u0026rsquo;s of devices.","title":"Bulk Adding Device Notes to Enrolled Devices","type":"posts"},{"content":"So you\u0026rsquo;re using Windows Autopilot in some shape or form to deploy Windows 10/11 devices to your users, and you\u0026rsquo;re probably already familiar with the Autopilot dynamic group queries used for targetting these devices, right? Good.\nSo what if you have multiple deployment profiles, or different device use cases with the same profile, or different user personas, or test and pilot deployments, or a range of applications, configurations or scripts that you want to separate out to the devices or users of the devices? You probably do\u0026hellip;what\u0026rsquo;s that you say, you\u0026rsquo;re using static groups to manage these? Let me show you the way forward.\nConfiguration # If you\u0026rsquo;ve got this far, you\u0026rsquo;ll probably know that Windows Autopilot is the modern deployment method for Windows 10/11 devices, allowing an organisation to pre-register corporate-owned devices (using their unique hardware hashes) and link these devices to the Azure AD tenant. Once the device is attached to the tenant, it is considered a trusted device that can be enrolled using Autopilot.\nBelow is an overview of the Windows Autopilot process, the bit we\u0026rsquo;re talking about is the Hardware Vendor adding the Device IDs; this is where the Vendor can also add Group Tags.\nAutopilot Group Tag Assignment process. Group Tags # A hidden gem with Autopilot service, is the Group Tag attribute for Autopilot devices, this tag can be provided during the pre-registration by a supplier or OEM, and can be configured or updated after the device has been imported.\nThis attribute is attached the computer object that exists in Azure AD, sadly not labelled as \u0026ldquo;Group Tag\u0026rdquo;, but as \u0026ldquo;OrderID\u0026rdquo; (this will be important later). As this attribute exists, we can utilise it with Dynamic Device groups\u0026hellip;do you see where this is going?\nNaming Conventions # Now he have this little beaut of a trick, we can start to look at how we use the Group Tag attribute to our advantage, and address some of the potential use cases for grouping Autopilot devices, whether this be based on deployment type, application assignment or just for overall better management of devices.\nI\u0026rsquo;m a big fan of having things named in a readable way, it just makes life a bit more straight forward in Microsoft Intune, and Group Tags are no different.\nSyntax # Your convention may differ from the below, as it will be entirely based on your own requirements, however I\u0026rsquo;ll give you a syntax starter for ten so you have an understanding of your options.\nPosition Value Description 1-2 AJ / HJ The Azure AD Join type - Azure AD or Hybrid Joined 3-4 LT / DT / VM The Device Type - Laptop, Desktop or Virtual Machine 5 U / S / K The Device Use Case - User Assigned, Shared or Kiosk 6-8 STD / ADM The User Type - Standard or Admin 9-11 FIN / HR / PAY The Users Department - Finance, HR or, Payroll etc. 12-13 UK / US / FR The Device Location - United Kingdom, United States, France etc. With this basic syntax in place, we can build out the Group Tag for devices:\nGroup Tag Description AJ-LT-U-STD-PAY-US Azure AD Joined Laptop, assigned to a User, with no Admin rights, in Payroll in the United States HJ-DT-S-ADM-FIN-UK Hybrid Azure AD Joined Desktop, configured as a Shared Device, with Admin rights, in Finance in the United Kingdom Dynamic Groups # Now that we have sorted out the syntax and conventions, it\u0026rsquo;s now time to create some dynamic groups in Azure AD. We\u0026rsquo;re not only going to create specific groups that equal the Group Tag, but groups that match the Group Tag. This allows assignment of Deployment Profiles, Configuration Profiles and Applications to all device types in a dynamic way, alleviating the need to manually manage groups.\nExample Groups # The below dynamic query would contain all Azure AD Joined Autopilot Laptops:\n(device.devicePhysicalIds -any _ ‚ÄìstartsWith \u0026#34;[OrderID]:AJ-LT\u0026#34;) This one contains all the Autopilot Desktops in Finance, whether Hybrid Joined or Azure AD Joined:\n(device.devicePhysicalIds -any (_ -match \u0026#34;^\\[OrderID\\]:.*DT.*FIN.*\u0026#34;)) This this one with all Laptops in France:\n(device.devicePhysicalIds -any (_ -match \u0026#34;^\\[OrderID\\]:.*LT.*FR$\u0026#34;)) And this this one with all Azure AD joined Laptops with Admin users in Payroll in all countries:\n(device.devicePhysicalIds -any (_ -match \u0026#34;^\\[OrderID\\]:AJ-LT.*ADM-PAY.*\u0026#34;)) You get the picture\u0026hellip;the possibilities for both the syntax and the dynamic groups using Regex are pretty much endless, and should be tailored to how you manage devices in Microsoft Intune.\nApplication # With the creation of these groups, you can now assign, well, pretty much anything in Microsoft Intune, to them.\nLets say you want all Laptops to have a BitLocker Endpoint Protection profile, but not Desktops\u0026hellip;you can do this. What about assigning an application to all HR devices that are Hybrid Joined, yup, you can do that too.\nIf you\u0026rsquo;re really all up in there with Microsoft Intune, you\u0026rsquo;re probably using Role Based Access Control (RBAC), these groups also allow for segregated management of devices based on location, department, join type etc. for specific User Roles or permission such as Remote Wipe or Application Deployment\u0026hellip;I know, exciting.\nSummary # What we have here, is a relatively painless way of tagging devices in any way you want to, kind of like creating a classic Organisational Structure but way more interesting and with the ability to do so without being constrained to a flat structure.\nThe next step is to clearly define your naming convention and syntax for the Group Tags, and have fun I guess.\nNow if you\u0026rsquo;re asking how to tag these devices on mass, without having to manually do so, well that\u0026rsquo;s another post.\n","date":"28 April 2022","externalUrl":null,"permalink":"/posts/autopilot-power-of-group-tags/","section":"Posts","summary":"A hidden gem with Autopilot service, is the Group Tag attribute for Autopilot devices, this tag can be provided during the pre-registration by a supplier or OEM, and can be configured or updated after the device has been imported. What can we use it for in Intune?","title":"The Hidden Power of Windows Autopilot Group Tags","type":"posts"},{"content":"If you\u0026rsquo;ve ever had to implement baseline security settings, whether this be Centre for Internet Security (CIS), Cyber Security Essentials (CSE), or National Cyber Security Centre (NCSC), you\u0026rsquo;ll probably have encountered some level of pain when it comes to non-Microsoft devices, as the guidance, is, well, complicated.\nNCSC do provide documented guides for macOS along with a GitHub repo containing a script and a list of recommended security settings, but what do these look like in Microsoft Intune? And what if you need to make changes? What about if you have exceptions?\nCustom Configuration Template # I\u0026rsquo;m not going to detail all of these NCSC settings in this post, otherwise I\u0026rsquo;ll do myself out of a job, but I can help with the security settings don\u0026rsquo;t exist natively within the macOS Device Restriction template.\nAll the below security settings utilise the Custom configuration template for macOS\u0026hellip;straight from the horses mouth:\n\u0026ldquo;The custom configuration template allows IT admins to assign settings that aren\u0026rsquo;t built into Intune yet. For macOS devices, you can import a .mobileconfig file that you created using Profile Manager or a different tool.\u0026rdquo;\nSounds perfect right? Details on how to create these profiles are below, but for now, let\u0026rsquo;s look at the NCSC settings and their associated mobileconfig files.\nAutomatic Updates # Now the NCSC guidelines advise that Operating System and Software updates should be applied automatically, with no deferral of when they are available or installed.\nFrom the NCSC documentation:\nSetting Value Comments Defer macOS Updates No n/a Defer app Updates No n/a This one is pretty definite in what it wants.\nSadly, there isn\u0026rsquo;t an option in Microsoft Intune to enforce this setting, but we can achieve this using a custom profile and generated mobileconfig file.\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;3C307E14-8CDD-4EB8-A696-AC967397CE40\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;0250B0DD-84C3-4DA4-91B3-6FA7824F54CD\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Automatic Software Update Settings\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configures the macOS software update settings to enable all automatic update options.\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadRemovalDisallowed\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadScope\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;System\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;A1936EA9-62CC-407B-94B0-1AD14BD513BE\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.SoftwareUpdate\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.SoftwareUpdate.A1936EA9-62CC-407B-94B0-1AD14BD513BE\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Automatic Software Update Settings\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configures the macOS software update settings to enable all automatic update options.\u0026lt;string/\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;ConfigDataInstall\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;CriticalUpdateInstall\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;AutomaticCheckEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;restrict-software-update-require-admin-to-install\u0026lt;/key\u0026gt; \u0026lt;false/\u0026gt; \u0026lt;key\u0026gt;AutomaticDownload\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;AutomaticallyInstallAppUpdates\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;AutomaticallyInstallMacOSUpdates\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;CatalogURL\u0026lt;/key\u0026gt; \u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;AllowPreReleaseInstallation\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; Fast User Switching and Automatic Logon # Apparently Fast User Switching is a bad thing, as is automatically logging in, so they want this disabled too.\nFrom the NCSC documentation:\nSetting Value Comments Enable Fast User Switching No n/a Disable automatic login Yes n/a I wish they would stick with either \u0026lsquo;Enable\u0026rsquo; or \u0026lsquo;Disable\u0026rsquo;, the mixture is headache inducing. However, mobileconfig file to the rescue.\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;com.apple.loginwindow\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;Forced\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;mcx_preference_settings\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;DisableFDEAutoLogin\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Disable Fast User Switching and Autologon\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;7243A790-723E-4433-ABA4-629C1A99264C\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.ManagedClient.preferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;7243A790-723E-4433-ABA4-629C1A99264C\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Disable Fast User Switching and Autologon\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;AF624C73-095F-4C69-89FB-A0A771D1225E\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadRemovalDisallowed\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadScope\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;System\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;AF624C73-095F-4C69-89FB-A0A771D1225E\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; Hiding System Preferences # This one makes more sense, as you don\u0026rsquo;t want users meddling with certain System Preferences such as, iCloud, Sharing, Startup Disk and Security.\nFrom the NCSC documentation:\nSetting Value Comments Restrict items in System Preferences Yes (disable selected items) iCloud Profiles Security \u0026amp; Privacy Startup Disk Sharing (enables remote management) Siri Xsan - If not in use FibreChannel - if not in use Now you could flat out disable them, but remember, NCSC is a guideline, so we\u0026rsquo;re just going to hide them instead\u0026hellip;\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.systempreferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.systempreferences.12D5D87D-F18F-4807-84A8-1E77FBF0EA4B\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;12D5D87D-F18F-4807-84A8-1E77FBF0EA4B\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.systempreferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Hide System Preferences;iCloud, Security, Startup Disk and Sharing\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;HiddenPreferencePanes\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;string\u0026gt;com.apple.preferences.icloud\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;com.apple.preference.security\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;com.apple.preference.startupdisk\u0026lt;/string\u0026gt; \u0026lt;string\u0026gt;com.apple.preferences.sharing\u0026lt;/string\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Hide System Preferences;iCloud, Security, Startup Disk and Sharing\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Hide System Preferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.systempreferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;BE218051-ED0B-4555-ADFB-86AA3072BB35\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadRemovalDisallowed\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;key\u0026gt;PayloadScope\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;User\u0026lt;/string\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; Time Servers # Not so sure on this one, must be down to ensuring that the system time is correct for validation of certificates\u0026hellip;maybe.\nFrom the NCSC documentation:\nSetting Value Comments Time Server Specify time server by device location Organisations should refer to their MDM documentation for instructions on setting this up See what I mean about it being complicated, thanks NCSC.\nAnyway, here\u0026rsquo;s the mobileconfig file setting the time servers to be time.euro.apple.com if you\u0026rsquo;re in Europe obviously.\n\u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;PayloadContent\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;com.apple.MCX\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;Forced\u0026lt;/key\u0026gt; \u0026lt;array\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;mcx_preference_settings\u0026lt;/key\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;timeServer\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;time.euro.apple.com\u0026lt;/string\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configures Time Servers\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Automatic Time Servers\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;4B63BB1E-0D4D-4DD2-BF93-4AAB46523179\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;com.apple.ManagedClient.preferences\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;4B63BB1E-0D4D-4DD2-BF93-4AAB46523179\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/array\u0026gt; \u0026lt;key\u0026gt;PayloadDescription\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configures Time Servers\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadDisplayName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;NCSC Automatic Time Servers\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;EE4E0945-5074-4EF1-A375-2B9688644D8F\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadOrganization\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;ennbee.uk\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadRemovalDisallowed\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;PayloadScope\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;System\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadType\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;Configuration\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadUUID\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;EE4E0945-5074-4EF1-A375-2B9688644D8F\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;PayloadVersion\u0026lt;/key\u0026gt; \u0026lt;integer\u0026gt;1\u0026lt;/integer\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; Creating Custom Configuration Profiles # Now that we have the required mobileconfig files, and that you\u0026rsquo;ve saved them with that file extension (it\u0026rsquo;s basically glorified XML to be honest), we can look at creating these Custom Configuration Profiles:\nBrowse to the macOS Configuration page and select Create profile: macOS Configuration profiles in Microsoft Intune. Under Profile type select Templates, then select Custom and then select Create: macOS Configuration profile templates in Microsoft Intune. Give the Custom profile a suitable name and select Next: macOS Configuration custom profile naming in Microsoft Intune. Give the Custom configuration profile name a suitable name, ensure the Deployment channel is \u0026lsquo;Device channel\u0026rsquo; and upload the mobileconfig file: macOS Configuration custom profile in Microsoft Intune. Select Next and assign the profile to the required Device Group. Repeat for all the mobileconfig files created.\nSummary # This was a bit of a whirlwind tour of Custom Configuration Profiles for macOS, and there is a huge amount that can be controlled, managed, and dictated using them. If you have a macOS device, you can use Apple Configuration 2 to create these files, if you don\u0026rsquo;t, then have fun with the Apple Developer Device Management Guide, like I did\u0026hellip;\n","date":"21 April 2022","externalUrl":null,"permalink":"/posts/macos-ncsc-settings/","section":"Posts","summary":"If you\u0026rsquo;ve ever had to implement baseline security settings, whether this be Centre for Internet Security, Cyber Essentials, or National Cyber Security Centre, you\u0026rsquo;ll probably have encountered some level of pain when it comes to non-Microsoft devices, as the guidance, is, well, complicated. Here we unpick these settings for macOS devices.","title":"macOS National Cyber Security Centre Security Settings in Intune","type":"posts"},{"content":"With the change to Android 10+ requiring a wireless network to go through the Fully Managed device enrolment, you may be asking, \u0026ldquo;Well what if my users don\u0026rsquo;t have access to a wireless network?\u0026rdquo;, don\u0026rsquo;t fret, with a bit of effort you can regenerate a new QR code that allows the use of Mobile Data.\nConfiguration # The below sections detail the steps to generate a new QR code for enrolment, allowing the use of Mobile Data.\nGet the QR Code Data # Use QR Reader on an existing phone or using an online reader to get the full QR code data:\n{ \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\u0026#34;:\u0026#34;com.google.android.apps.work.clouddpc/.receivers.CloudDeviceAdminReceiver\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\u0026#34;:\u0026#34;I5YvS0O5hXY46mb01BlRjq4oJJGs2kuUcHvVkAPEXlg\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\u0026#34;:\u0026#34;https://play.google.com/managed/downloadManagingApp?identifier=setup\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\u0026#34;:{ \u0026#34;com.google.android.apps.work.clouddpc.EXTRA_ENROLLMENT_TOKEN\u0026#34;:\u0026#34;TOKENVALUE\u0026#34; } } Updating the JSON Content # Add in the below code snippet before the android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE section:\n\u0026#34;android.app.extra.PROVISIONING_USE_MOBILE_DATA\u0026#34;:true, So the full JSON string should look like the below, with the TOKENVALUE obviously the correct one:\n{ \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_COMPONENT_NAME\u0026#34;:\u0026#34;com.google.android.apps.work.clouddpc/.receivers.CloudDeviceAdminReceiver\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_SIGNATURE_CHECKSUM\u0026#34;:\u0026#34;I5YvS0O5hXY46mb01BlRjq4oJJGs2kuUcHvVkAPEXlg\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_DEVICE_ADMIN_PACKAGE_DOWNLOAD_LOCATION\u0026#34;:\u0026#34;https://play.google.com/managed/downloadManagingApp?identifier=setup\u0026#34;, \u0026#34;android.app.extra.PROVISIONING_USE_MOBILE_DATA\u0026#34;:true, \u0026#34;android.app.extra.PROVISIONING_ADMIN_EXTRAS_BUNDLE\u0026#34;:{ \u0026#34;com.google.android.apps.work.clouddpc.EXTRA_ENROLLMENT_TOKEN\u0026#34;:\u0026#34;TOKENVALUE\u0026#34; } } Summary # Copy the string and paste it into an online QR code generator to generate the new QR code. This can then be provided to your users, pending testing, to allow them to enrol their new Android device in Microsoft Intune, whether connected to wireless or mobile data.\n","date":"21 March 2022","externalUrl":null,"permalink":"/posts/android-enterprise-enrolment-mobile-data/","section":"Posts","summary":"What happens when your Android Fully Managed Corporate Owned users get a new Android 11 device and they can\u0026rsquo;t enrol to Intune using mobile data, well there\u0026rsquo;s a fix for that.","title":"Enrolling Android Enterprise devices Using Mobile Data","type":"posts"},{"content":"You\u0026rsquo;ve probably hit the limitation with Windows Autopilot Hybrid Azure AD Join deployments and the device name templates being less than flexible, restricting to only a prefix and, well, that\u0026rsquo;s it.\nYou\u0026rsquo;ve also probably been asked whether you can configure the device name to match an asset tag or another unique bit of information, well this script, adapted from an existing one by Michael Niehaus can help.\nConfiguration # The below sections detail the steps carried out to modify the script to work without the need for an Azure web application, and can be deployed locally to rename devices.\nAdding the Variables # The post linked above details the steps required to ensure that the computer object itself has the ability to initiate the rename, and the below script has been changed to use existing device information, such as serial, instead of a web service:\nOn-premises domain variable Computer name prefix variable Wait time before restart This means that it can be deployed to existing environments without the need to deploy, or pay for, an Azure Web App.\nThe first section details the parameters that can used and updated.\n#Sets the variables for the customer $domain = \u0026#34;onprem.local\u0026#34; #local domain $ComputerPrefix = \u0026#34;PRE-\u0026#34; #Prefix $waittime = \u0026#34;60\u0026#34; #sets the restart wait time in minutes Getting the Device Name # This next section pulls back the serial number and ensures that the computer name is less than 15 characters.\n#Get serial and removes commas $Serial = Get-WmiObject Win32_bios | Select-Object -ExpandProperty SerialNumber $newName = $ComputerPrefix + $Serial $newName = $newName.Replace(\u0026#34; \u0026#34;,\u0026#34;\u0026#34;) #Removes spaces #shortens name if ($newName.Length -ge 15) { $newName = $newName.substring(0, 15) } The Waiting Game # Using New-TimeSpan we can convert the $waittime variable into whatever time format we need, and as we\u0026rsquo;re using the shutdown command, we need seconds:\n$waitinseconds = (New-TimeSpan -Minutes $waittime).Seconds Write-Host \u0026#34;Initiating a restart in $waitime minutes\u0026#34; \u0026amp; shutdown.exe /g /t $waitinseconds /f /c \u0026#34;Restarting the computer in $wait minutes due to a computer name change. Please save your work.\u0026#34; The Whole Thing # The full script can be found here, I would strongly advise testing this prior to pushing it out via Microsoft Intune.\nDeployment # Save the above script and create a new PowerShell script deployment in Microsoft Intune using the following configuration settings, then deploy to a test group of devices:\nPlatform script in Microsoft Intune. Bingo! another battle won.\n","date":"20 March 2022","externalUrl":null,"permalink":"/posts/hybrid-join-computer-rename/","section":"Posts","summary":"You\u0026rsquo;ve probably hit the limitation with Windows Autopilot Hybrid Azure AD Join deployments and the device name templates being less than flexible, restricting to only a prefix and, well, that\u0026rsquo;s it.","title":"Renaming Windows Autopilot Hybrid Joined Devices","type":"posts"},{"content":"You may have enabled and configure BitLocker for silent encryption on your Windows 10 Autopilot joined devices, but have you had the headache of devices that don\u0026rsquo;t have a Windows Recovery Environment (WinRE) configured? Yep? Me too\u0026hellip;\nWhat you\u0026rsquo;ll see in either the BitLocker-API event log, or within the Encryption Readiness reporting in Microsoft Intune the following, glorious error:\nThe OS volume is unprotected | Windows Recovery Environment (WinRE) isn't configured\nConfiguration # So how do we go about enabling WinRE if it exists, setup BitLocker encryption, and grab the BitLocker recovery key and ping it to Azure AD?\nHere\u0026rsquo;s how\u0026hellip;\nUpdating the Script # This Microsoft script has been adapted to check for the WinRE configuration before it continues and attempts to enable BitLocker, the $HotToTrot variable is used to denote whether to continue or not.\nThe below is the added section to check and enable, or attempt to enable, WinRE:\n$HotToTrot =\u0026#34;false\u0026#34; #Checks Windows Recovery Environment and enables if disabled if($WinREStatus -like \u0026#39;*Windows RE status: Enabled*\u0026#39;){ $HotToTrot = \u0026#34;True\u0026#34; Write-Verbose -Message \u0026#34;WinRE Partition Enabled and good to enable BitLocker $HotToTrot\u0026#34; } Else{ Try{ $WinREEnable = reagentc.exe /enable if($WinREEnable -like \u0026#39;*Operation Successful*\u0026#39;){ $HotToTrot = \u0026#34;True\u0026#34; Write-Verbose -Message \u0026#34;WinRE Partition Enabled and good to enable BitLocker, HotToTrot set to $HotToTrot\u0026#34; } Else{ $HotToTrot =\u0026#34;false\u0026#34; Write-Verbose -Message \u0026#34;Unable to enabled WinRE, HotToTrot set to $HotToTrot\u0026#34; } } Catch{ $HotToTrot =\u0026#34;false\u0026#34; Write-Verbose -Message \u0026#34;Unable to enabled WinRE\u0026#34; } } if($HotToTrot -eq \u0026#39;True\u0026#39;) Fixing the Script # The script has logic in place to escrow the recovery key to Azure AD, using either the BackupToAAD-BitLockerKeyProtector commandlet or, if this isn\u0026rsquo;t available, using a call to GraphAPI. The below sections needed to be updated due to where the Azure AD Join information is now stored in the registry:\n# Check if we can use BackupToAAD-BitLockerKeyProtector commandlet if (Get-Command -Name \u0026#34;BackupToAAD-BitLockerKeyProtector\u0026#34; -ErrorAction \u0026#34;SilentlyContinue\u0026#34;) { # BackupToAAD-BitLockerKeyProtector commandlet exists Write-Verbose -Message \u0026#34;Saving Key to AAD using BackupToAAD-BitLockerKeyProtector\u0026#34; $BLV = Get-BitLockerVolume -MountPoint $OSDrive | Select-Object * If ($Null -ne $BLV.KeyProtector) { BackupToAAD-BitLockerKeyProtector -MountPoint $OSDrive -KeyProtectorId $BLV.KeyProtector[1].KeyProtectorId } Else { Write-Error \u0026#34;\u0026#39;Get-BitLockerVolume\u0026#39; failed to retrieve drive encryption details for $OSDrive\u0026#34; } } else { # BackupToAAD-BitLockerKeyProtector commandlet not available, using other mechanism Write-Verbose -Message \u0026#34;BackupToAAD-BitLockerKeyProtector not available\u0026#34; Write-Verbose -Message \u0026#34;Saving Key to AAD using Enterprise Registration API\u0026#34; # Get the AAD Machine Certificate $cert = Get-ChildItem -Path \u0026#34;Cert:\\LocalMachine\\My\\\u0026#34; | Where-Object { $_.Issuer -match \u0026#34;CN=MS-Organization-Access\u0026#34; } # Obtain the AAD Device ID from the certificate $id = $cert.Subject.Replace(\u0026#34;CN=\u0026#34;, \u0026#34;\u0026#34;) # Obtain the Tenant ID from the certificate thumbprint $tenantid = ($cert.Thumbprint).Replace(\u0026#34;-\u0026#34;,\u0026#34;\u0026#34;) # Get the tenant name from the registry $tenant = (Get-ItemProperty -Path \u0026#34;HKLM:\\SYSTEM\\CurrentControlSet\\Control\\CloudDomainJoin\\JoinInfo\\$($tenantid)\u0026#34;).UserEmail.Split(\u0026#39;@\u0026#39;)[1] # Create the URL to post the data to based on the tenant and device information $url = \u0026#34;https://enterpriseregistration.windows.net/manage/$tenant/device/$($id)?api-version=1.0\u0026#34; # Generate the body to send to AAD containing the recovery information Write-Verbose -Message \u0026#34;Saving key protector to AAD for self-service recovery by manually posting it to:\u0026#34; Write-Verbose -Message \u0026#34;`t$url\u0026#34; # Get the BitLocker key information from WMI (Get-BitLockerVolume -MountPoint $OSDrive).KeyProtector | Where-Object { $_.KeyProtectorType -eq \u0026#39;RecoveryPassword\u0026#39; } | ForEach-Object { $key = $_ $body = \u0026#34;{\u0026#34;\u0026#34;key\u0026#34;\u0026#34;:\u0026#34;\u0026#34;$($key.RecoveryPassword)\u0026#34;\u0026#34;,\u0026#34;\u0026#34;kid\u0026#34;\u0026#34;:\u0026#34;\u0026#34;$($key.KeyProtectorId.replace(\u0026#39;{\u0026#39;,\u0026#39;\u0026#39;).Replace(\u0026#39;}\u0026#39;,\u0026#39;\u0026#39;))\u0026#34;\u0026#34;,\u0026#34;\u0026#34;vol\u0026#34;\u0026#34;:\u0026#34;\u0026#34;OSV\u0026#34;\u0026#34;}\u0026#34; Write-Verbose -Message \u0026#34;KeyProtectorId : $($key.KeyProtectorId) key: $($key.RecoveryPassword)\u0026#34; # Post the data to the URL and sign it with the AAD Machine Certificate $req = Invoke-WebRequest -Uri $url -Body $body -UseBasicParsing -Method \u0026#34;Post\u0026#34; -UseDefaultCredentials -Certificate $cert $req.RawContent Write-Verbose -Message \u0026#34; -- Key save web request sent to AAD - Self-Service Recovery should work\u0026#34; } } Putting it All Together # The full script can be found here, I would strongly advise testing this prior to pushing it out via Microsoft Intune.\nScript Deployment # Save the above script and create a new PowerShell script deployment in Microsoft Intune using the following configuration settings, then deploy to a test group of devices.\nBitLocker Platform script in Microsoft Intune. Bingo! One battle won, onto the next.\n","date":"17 March 2022","externalUrl":null,"permalink":"/posts/enable-bitlocker-and-winre/","section":"Posts","summary":"You may have enabled and configure BitLocker for silent encryption on your Windows 10 Autopilot joined devices, but have you had the headache of devices that don\u0026rsquo;t have a Windows Recovery Environment (WinRE) configured? Yep? Me too\u0026hellip;","title":"Enabling BitLocker and WinRE on failed Windows Devices","type":"posts"},{"content":"","date":"17 March 2022","externalUrl":null,"permalink":"/tags/encryption/","section":"Tags","summary":"","title":"Encryption","type":"tags"},{"content":"","externalUrl":null,"permalink":"/tags/apple/","section":"Tags","summary":"","title":"Apple","type":"tags"},{"content":"","externalUrl":null,"permalink":"/tags/cyber-essentials/","section":"Tags","summary":"","title":"Cyber Essentials","type":"tags"},{"content":"As a Technical Consultant, I have developed a specialized expertise in the migration and deployment of Microsoft products. My primary focus is on the Modern Device Management practice, specifically Intune deployments, although I have extensive experience working with a variety of Microsoft products from both on-premises and cloud perspectives.\nIn addition to my technical capabilities, I have also demonstrated strong leadership skills by leading several Change Management projects in conjunction with technical migration initiatives. My passion for exploring new technologies and leveraging them to improve business processes is a driving force behind my work, and I am committed to delivering results that exceed my customers\u0026rsquo; expectations.\nBeyond my professional life, I enjoy exploring new destinations and keeping in shape at the gym.\n","externalUrl":null,"permalink":"/authors/georgeparker/","section":"Authors","summary":"As a Technical Consultant, I have developed a specialized expertise in the migration and deployment of Microsoft products.","title":"George Parker","type":"authors"},{"content":" Disclaimer # The views expressed anywhere on this site are strictly mine and not the opinions and views of my employer or any vendor mentioned. All information is provided \u0026ldquo;as is\u0026rdquo; with no warranties, and should be tested prior to any implementation, and I hold no liability for the outcome of the information, scripts, or other content provided on this site.\nPrivacy # This site collects usage data using Google Analytics 4 using cookies, giving us insight into the number of people that visit our website. All data is anonymised and we do not sell nor share any data with third parties.\nA cookie is a small file, typically of letters and numbers, downloaded on to a device when the user accesses our website. A cookie is stored on your hard drive.\nAbout Cookies # A cookie is a small file of letters and numbers that we store on your browser or the hard drive of your computer if you agree. Cookies contain information that is transferred to your computer\u0026rsquo;s hard drive. Our website uses cookies to distinguish you from other users of our website. This helps us to provide you with a good experience when you browse our website and allows us to improve our website.\nBy continuing to browse the website, you are agreeing to our use of cookies. We may use the following cookies:\nAnalytical/performance cookies. They allow us to recognise and count the number of visitors and to see how visitors move around our website when they are using it. This helps us to improve the way our website works, for example, by ensuring that users are finding what they are looking for easily. Analytics Providers # Please note that we use Google Analytics, which places cookies on your computer, to help the website analyse how visitors use the website. The information generated by the cookie about your use of the website (including a randomisation of your IP address) will be transmitted to and stored by Google for the purpose of evaluating your use of the website, compiling reports on website activity for website operators and providing to us other services relating to website activity and internet usage. You can prevent Google‚Äôs collection and use of data by downloading and installing the browser plug-in available under google.com/dlpage/gaoptout. Please visit google.com/intl/en/policies/privacy/ for further information on how Google uses your data.\nRejecting Cookies # You block cookies by activating the setting on your browser that allows you to refuse the setting of all or some cookies or by choosing to deny Cookies when prompted, then no information will be collected whatsoever.\nImage Attribution # The below are images used across this site:\nLan Cable Vectors by Vecteezy Vector Illustration Vectors by Vecteezy It Equipment Vectors by Vecteezy Computer Security Vectors by Vecteezy Data Vectors by Vecteezy ","externalUrl":null,"permalink":"/information/","section":"MEM v ENNBEE - Battles with Modern Endpoint Management","summary":"Disclaimer # The views expressed anywhere on this site are strictly mine and not the opinions and views of my employer or any vendor mentioned.","title":"Information","type":"page"},{"content":"","externalUrl":null,"permalink":"/tags/jamf/","section":"Tags","summary":"","title":"Jamf","type":"tags"},{"content":"","externalUrl":null,"permalink":"/tags/oemconfig/","section":"Tags","summary":"","title":"OEMConfig","type":"tags"}]